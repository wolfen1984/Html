<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CASTLE OF THE UNDEAD - Level 7: The Crypt</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Green/Black/White theme for crypt */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 80, 40, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 80, 40, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 2px solid #40a080;
            background-color: #000;
            box-shadow: 0 0 20px rgba(64, 160, 128, 0.4);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 80, 40, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #40a080;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #80ffc0;
            text-shadow: 0 0 5px #40ffa0;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #40a080;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 18px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #40a080;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #005500;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-number.current {
            background-color: #40a080;
            color: #fff;
            border-color: #80ffc0;
            box-shadow: 0 0 8px #40ffa0;
            text-shadow: 0 0 2px #000;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #40a080;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #80ffc0;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #40a080;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #80ffc0;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #40a080;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #80ffc0;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #80ffc0;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #40a080;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #40a080;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #80ffc0;
            border-color: #80ffc0;
            box-shadow: 0 0 10px rgba(64, 255, 160, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #40a080;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #80ffc0;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #40a080;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #80ffc0;
            border-color: #80ffc0;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #113322;
            border: 1px solid #40a080;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #80ffc0;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #224433;
            border: 1px solid #80ffc0;
            padding: 10px;
            margin: 10px 0;
            color: #80ffc0;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ff0;
            font-weight: bold;
        }
        
        .item {
            color: #6ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .ghost {
            color: #aaf;
            font-weight: bold;
            text-shadow: 0 0 3px #aaf;
        }
        
        .wolf {
            color: #aaa;
            font-weight: bold;
            text-shadow: 0 0 3px #aaa;
        }
        
        .zombie {
            color: #8f8;
            font-weight: bold;
            text-shadow: 0 0 3px #8f8;
        }
        
        .skeleton {
            color: #ccc;
            font-weight: bold;
            text-shadow: 0 0 3px #ccc;
        }
        
        .cryptguardian {
            color: #f96;
            font-weight: bold;
            text-shadow: 0 0 3px #f96;
        }
        
        /* Next Level Button */
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #40a080;
            padding: 15px 30px;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #40a080;
            color: #fff;
            border-color: #80ffc0;
            box-shadow: 0 0 15px #40ffa0;
        }
        
        /* Crypt Themed Elements */
        .crypt-door {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #113322;
            border: 1px solid #40a080;
            animation: pulse-green 3s infinite;
        }
        
        @keyframes pulse-green {
            0% { border-color: #40a080; }
            50% { border-color: #80ffc0; }
            100% { border-color: #40a080; }
        }
        
        .sarcophagus {
            background-color: #224433;
            border: 1px solid #40a080;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .sarcophagus-option {
            background-color: #335544;
            border: 1px solid #40a080;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sarcophagus-option:hover {
            background-color: #446655;
            border-color: #80ffc0;
        }
        
        .trap-room {
            background-color: #332211;
            border: 1px solid #a08040;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            color: #ffc080;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #40a080;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #40a080;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #80ffc0;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 14px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .next-level-btn {
                font-size: 14px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <div class="header">
            <h1>CASTLE OF THE UNDEAD</h1>
            <h2>LEVEL 7: THE CRYPT</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number completed">2</div>
            <div class="level-number completed">3</div>
            <div class="level-number completed">4</div>
            <div class="level-number completed">5</div>
            <div class="level-number completed">6</div>
            <div class="level-number current">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Level Intro Screen -->
        <div id="screen-intro" class="screen active-screen">
            <h2>THE CRYPT</h2>
            <div class="story-text">
                <p>The heavy stone doors close behind you with a final-sounding thud. You stand in the antechamber of the Vorlak family crypt.</p>
                <p>The air is cold, dry, and smells of dust and decay. Ancient braziers with green flame cast flickering light on stone walls carved with vampire legends. Ahead lies a series of chambers, each containing sarcophagi of vampire lords from centuries past.</p>
                <p>You can hear faint scratching sounds from deeper within, and a low, rhythmic thrumming that seems to pulse through the stone itself. This is where Valerius draws power from his ancestors, and where the path to his throne room begins.</p>
                <p>To reach Level 8 - The Castle's Catacombs, you must navigate the crypt's dangers and find the secret passage that connects the crypt to the castle proper.</p>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="intro-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="intro-stat-health" class="stat-value">0</span>/<span id="intro-stat-maxhealth" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="intro-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="intro-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="startLevel7()">ENTER THE CRYPT</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/8</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>VORLAK FAMILY CRYPT</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Crypt Guardian Screen -->
        <div id="screen-cryptguardian" class="screen">
            <h2>CRYPT GUARDIAN</h2>
            <div class="story-text">
                <div class="crypt-door">
                    <strong>VLADIS, THE CRYPT GUARDIAN</strong><br>
                    <small>Ancient vampire sworn to protect the Vorlak tombs</small>
                </div>
                <p>Before you stands Vladis, an ancient vampire clad in tattered ceremonial armor. His eyes glow with crimson light, and his fangs gleam in the green brazier light.</p>
                <p><span class="cryptguardian">"You should not have come here, mortal,"</span> he hisses. <span class="cryptguardian">"The masters' rest shall not be disturbed. Leave now, or join the other intruders in eternal slumber."</span></p>
                
                <div class="choice-buttons">
                    <button class="choice-btn" onclick="fightCryptGuardian()">FIGHT VLADIS</button>
                    <button class="choice-btn" onclick="talkToCryptGuardian()">TRY TO REASON WITH HIM</button>
                    <button class="choice-btn" onclick="sneakPastCryptGuardian()">ATTEMPT TO SNEAK PAST</button>
                    <button class="choice-btn" onclick="useItemOnGuardian()">USE AN ITEM</button>
                </div>
            </div>
        </div>
        
        <!-- Sarcophagus Selection Screen -->
        <div id="screen-sarcophagi" class="screen">
            <h2>ANCIENT SARCOPHAGI</h2>
            <div class="story-text">
                <p>You enter a chamber with several ornate sarcophagi. Each bears the name and likeness of a Vorlak vampire lord. Strange artifacts rest on top of some.</p>
                <p>Which sarcophagus do you examine?</p>
                
                <div class="sarcophagus">
                    <div class="sarcophagus-option" onclick="selectSarcophagus('ancient')">
                        <strong>Lord Vorlak the First</strong><br>
                        <small>"He who conquered the night." (1321-1399)</small>
                    </div>
                    <div class="sarcophagus-option" onclick="selectSarcophagus('warrior')">
                        <strong>Baron Valerius the Bloody</strong><br>
                        <small>"None escaped his thirst." (1455-1520)</small>
                    </div>
                    <div class="sarcophagus-option" onclick="selectSarcophagus('sorceress')">
                        <strong>Lady Morgana Vorlak</strong><br>
                        <small>"Mistress of dark arts." (1488-1555)</small>
                    </div>
                    <div class="sarcophagus-option" onclick="selectSarcophagus('current')">
                        <strong>Lord Valerius (Empty)</strong><br>
                        <small>"The current master." (Date of birth unknown)</small>
                    </div>
                    <div class="sarcophagus-option" onclick="selectSarcophagus('unknown')">
                        <strong>Unmarked Black Sarcophagus</strong><br>
                        <small>No inscription, radiating cold energy</small>
                    </div>
                </div>
                
                <div id="sarcophagus-feedback" style="margin-top: 15px; padding: 10px; background-color: #113322; border: 1px solid #40a080; display: none;">
                    <p id="sarcophagus-feedback-text"></p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="cancelSarcophagusSelection()">RETURN TO CRYPT</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>LEVEL 7 COMPLETE!</h2>
            <div class="story-text">
                <p>You have navigated the ancient crypt and found the secret passage to the castle catacombs!</p>
                <p>Behind Vladis's throne, a hidden door slides open, revealing a narrow, descending passageway. The air from within is even colder, carrying the scent of damp earth and something older.</p>
                <p>These catacombs connect the crypt to Castle Vorlak proper, and through them you may finally reach Valerius's throne room. But first, you must survive the catacombs themselves.</p>
                <p>All your stats, gold, and inventory will carry over to Level 8.</p>
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="next-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="next-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="next-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background-color: #113322; border: 1px solid #40a080;">
                    <h3 style="color: #80ffc0; margin-top: 0;">INVENTORY CARRYING OVER:</h3>
                    <div id="next-inventory-display"></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">ENTER THE CATACOMBS - LEVEL 8</button>
            </div>
        </div>
        
        <div class="footer">
            CASTLE OF THE UNDEAD - A Retro Vampire Hunt Adventure<br>
            Level 7: The Crypt
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'level':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    break;
                case 'crypt':
                    playBeep(150, 0.5, 'sine');
                    setTimeout(() => playBeep(100, 0.7, 'sine'), 500);
                    break;
                case 'skeleton':
                    playBeep(250, 0.2, 'square');
                    setTimeout(() => playBeep(200, 0.3, 'square'), 200);
                    break;
                case 'vampire':
                    playBeep(350, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(300, 0.2, 'sawtooth'), 300);
                    break;
                case 'trap':
                    playBeep(800, 0.1, 'sine');
                    setTimeout(() => playBeep(600, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(400, 0.2, 'sine'), 200);
                    break;
                case 'secret':
                    playBeep(700, 0.1, 'triangle');
                    setTimeout(() => playBeep(900, 0.1, 'triangle'), 100);
                    setTimeout(() => playBeep(1100, 0.1, 'triangle'), 200);
                    break;
                case 'door':
                    playBeep(100, 0.5, 'sine');
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // Game state object - loaded from Level 6
        const gameState = {
            playerClass: '',
            strength: 0,
            maxHealth: 0,
            health: 0,
            agility: 0,
            gold: 0,
            inventory: [],
            equippedWeapon: 'Rusty Sword',
            equippedArmor: 'Leather Armor',
            currentSection: 1,
            gameComplete: false,
            level: 7,
            // Level 7 specific flags
            metCryptGuardian: false,
            cryptGuardianDefeated: false,
            exploredAntechamber: false,
            exploredMainChamber: false,
            exploredBurialChamber: false,
            exploredTreasureRoom: false,
            foundSecretPassage: false,
            skeletonsDefeated: false,
            avoidedTraps: false,
            examinedSarcophagi: false,
            // Special items
            hasCryptMap: false,
            foundCryptArtifact: false,
            hasVampireDust: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isPack: false,
            packCount: 0
        };
        
        // Random event tracking
        let randomEvents = {
            whisperingVoices: false,
            greenFlares: 0,
            movingShadows: false
        };
        
        // Sarcophagus examination results
        const sarcophagusResults = {
            'ancient': {
                text: "The sarcophagus of Lord Vorlak the First. The stone is ancient but pristine. Inside, you find dust and a single artifact - a ceremonial dagger with a ruby pommel.",
                item: 'Vorlak Ceremonial Dagger',
                gold: 50,
                effect: "strength"
            },
            'warrior': {
                text: "Baron Valerius the Bloody's resting place. The sarcophagus shows battle scars. Within, beside the vampire's dust, lies a well-preserved set of armor.",
                item: 'Vampire Lord Armor',
                gold: 40,
                effect: "armor"
            },
            'sorceress': {
                text: "Lady Morgana's sarcophagus is covered in arcane symbols. Opening it releases a puff of magical energy. Inside, you find a spellbook and components.",
                item: 'Necromantic Tome',
                gold: 35,
                effect: "magic"
            },
            'current': {
                text: "The empty sarcophagus of Lord Valerius. It's prepared for his eventual return. The interior is lined with black velvet. You find a hidden compartment containing documents.",
                item: 'Valerius Family Documents',
                gold: 25,
                effect: "knowledge"
            },
            'unknown': {
                text: "The unmarked black sarcophagus is freezing to the touch. When opened, it contains only a pile of ancient ash that swirls unnaturally. A single ring rests atop the ashes.",
                item: 'Ring of the Forgotten',
                gold: 60,
                effect: "mystery"
            }
        };
        
        // Game story sections for Level 7
        const storySections = {
            1: {
                text: "You stand in the crypt antechamber. Green-flame braziers cast flickering light on carved walls depicting vampire conquests. Three passages lead deeper: left, right, and straight ahead. The air hums with ancient power.",
                choices: [
                    {text: "Take the left passage", nextSection: 2, skillCheck: false},
                    {text: "Take the right passage", nextSection: 3, skillCheck: false},
                    {text: "Go straight ahead", nextSection: 4, skillCheck: false},
                    {text: "Examine the wall carvings", nextSection: 5, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredAntechamber = true;
                    playSound('crypt');
                    // Random crypt whispers
                    if (Math.random() > 0.7) {
                        randomEvents.whisperingVoices = true;
                        return "<br><span class='ghost'>Ancient whispers seem to echo from the stone itself...</span>";
                    }
                    return "";
                }
            },
            2: {
                text: "The left passage descends into a burial chamber. Rows of stone sarcophagi line the walls, each bearing the Vorlak crest. The air is still and heavy with dust.",
                choices: [
                    {text: "Examine the sarcophagi", nextSection: 6, skillCheck: false},
                    {text: "Search for hidden items", nextSection: 7, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Continue deeper", nextSection: 8, skillCheck: false},
                    {text: "Return to antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredBurialChamber = true;
                    playSound('door');
                    return "";
                }
            },
            3: {
                text: "The right passage leads to a chamber filled with treasure - gold coins, jewels, and artifacts piled haphazardly. But the floor looks suspiciously clean...",
                choices: [
                    {text: "Search the treasure", nextSection: 9, skillCheck: false},
                    {text: "Examine the floor for traps", nextSection: 10, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Take a few items quickly", nextSection: 11, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Return to antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredTreasureRoom = true;
                    playSound('item');
                    return "The treasure glitters enticingly in the green brazier light.";
                }
            },
            4: {
                text: "The central passage opens into the main crypt chamber. A massive black sarcophagus dominates the center of the room. Standing before it is a figure in ancient armor - the Crypt Guardian!",
                choices: [
                    {text: "Approach the Crypt Guardian", nextSection: 12, skillCheck: false},
                    {text: "Examine the room's perimeter", nextSection: 13, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Look for alternative paths", nextSection: 14, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Retreat to antechamber", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.exploredMainChamber = true;
                    playSound('vampire');
                    return "The guardian hasn't noticed you yet. His attention seems focused on the central sarcophagus.";
                }
            },
            5: {
                text: "The wall carvings tell the history of the Vorlak vampires: their rise to power, great battles, and dark rituals. One panel shows a secret passage behind a waterfall of blood...",
                choices: [
                    {text: "Study the secret passage carving", nextSection: 15, skillCheck: false},
                    {text: "Examine the battle scenes", nextSection: 16, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    playSound('secret');
                    return "The carvings might hold clues to navigating the crypt.";
                }
            },
            6: {
                text: "You approach the sarcophagi. They're arranged by age, with the oldest against the far wall. Each has a nameplate and some have small offerings or artifacts placed atop them.",
                choices: [
                    {text: "Examine the oldest sarcophagus", nextSection: 17, skillCheck: false},
                    {text: "Look for recent disturbances", nextSection: 18, skillCheck: false},
                    {text: "Search for hidden mechanisms", nextSection: 19, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to burial chamber entrance", nextSection: 2, skillCheck: false}
                ]
            },
            7: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(5, 10);
                        gameState.gold += goldFound;
                        addToInventory('Burial Chamber Key');
                        updateStatsDisplay();
                        playSound('item');
                        return "You find a hidden niche containing <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Burial Chamber Key</span>!";
                    } else {
                        playSound('trap');
                        // Trigger skeletons!
                        combatState.active = true;
                        combatState.enemyName = "Crypt Skeletons";
                        combatState.enemyHealth = 75;
                        combatState.enemyCurrentHealth = 75;
                        combatState.enemyStrength = 14;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 8;
                        combatState.nextSection = 21;
                        combatState.round = 1;
                        combatState.isPack = true;
                        combatState.packCount = 4;
                        
                        return "You trigger a hidden mechanism! Four skeletons rise from hidden compartments in the walls!<br><br><span class='skeleton'>Crypt Skeletons (4)</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            8: {
                text: "Beyond the burial chamber, the passage continues downward. The walls are moist here, and you can hear dripping water. A faint draft suggests another chamber ahead.",
                choices: [
                    {text: "Follow the passage", nextSection: 22, skillCheck: false},
                    {text: "Listen for sounds ahead", nextSection: 23, skillCheck: false},
                    {text: "Return to burial chamber", nextSection: 2, skillCheck: false}
                ]
            },
            9: {
                text: "You begin searching through the treasure. Gold coins, silver chalices, jeweled daggers... but as you move, you hear a faint clicking sound beneath your feet.",
                choices: [
                    {text: "Continue searching carefully", nextSection: 24, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Grab what you can and run", nextSection: 25, skillCheck: false},
                    {text: "Freeze and assess the trap", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    playSound('trap');
                    return "<div class='trap-room'>TRAP DETECTED! The floor is pressure-sensitive!</div>";
                }
            },
            10: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.avoidedTraps = true;
                        playSound('success');
                        return "You identify the trap pattern! Stepping only on the darker stones avoids triggering anything.";
                    } else {
                        const damage = rollDice(3, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You miss a subtle pressure plate! Darts shoot from the walls, dealing " + damage + " damage!";
                    }
                }
            },
            11: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(8, 10);
                        gameState.gold += goldFound;
                        updateStatsDisplay();
                        playSound('item');
                        return "You grab a handful of treasure and retreat safely! You gain <span class='gold'>" + goldFound + " Gold</span>!";
                    } else {
                        playSound('trap');
                        // Trigger trap
                        const damage = rollDice(2, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        return "You trigger a trap! A swinging blade hits you for " + damage + " damage!";
                    }
                }
            },
            12: {
                text: "You approach the Crypt Guardian. He turns slowly, his crimson eyes fixing on you. <span class='cryptguardian'>'Mortal fool,'</span> he hisses. <span class='cryptguardian'>'You trespass where only the dead should walk.'</span>",
                choices: [
                    {text: "Prepare for battle", nextSection: 29, skillCheck: false},
                    {text: "Try to reason with him", nextSection: 30, skillCheck: false},
                    {text: "Look for an alternative", nextSection: 31, skillCheck: false}
                ],
                action: function() {
                    gameState.metCryptGuardian = true;
                    playSound('vampire');
                    return "";
                }
            },
            13: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('secret');
                        return "You notice a hidden alcove behind a tapestry! It might provide cover or an alternative route.";
                    } else {
                        playSound('failure');
                        return "The guardian notices your movement! He turns toward you, his stance becoming aggressive.";
                    }
                }
            },
            14: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You spot a ventilation shaft high on the wall! It might bypass the guardian completely.";
                    } else {
                        playSound('failure');
                        return "You find no alternative paths. The guardian blocks the only obvious exit.";
                    }
                }
            },
            15: {
                text: "The carving shows a vampire lord opening a secret passage behind a stone altar during a blood ritual. The altar is depicted with three skulls facing different directions.",
                choices: [
                    {text: "Memorize the carving details", nextSection: 34, skillCheck: false},
                    {text: "Return to other carvings", nextSection: 16, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    gameState.foundSecretPassage = true;
                    return "You might be able to use this information if you find a similar altar.";
                }
            },
            16: {
                text: "The battle scenes show the Vorlak vampires defeating armies of humans, werewolves, and rival vampire clans. Their tactics and weaknesses might be revealed in these depictions.",
                choices: [
                    {text: "Study the vampire weaknesses", nextSection: 35, skillCheck: false},
                    {text: "Examine the secret passage carving", nextSection: 15, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ]
            },
            17: {
                text: "The oldest sarcophagus bears the name 'Vorlak the Founder'. The stone is worn but the carvings remain clear. It shows a vampire rising from a coffin under a blood moon.",
                choices: [
                    {text: "Try to open it", nextSection: 36, skillCheck: true, checkType: 'strength', difficulty: 18},
                    {text: "Examine the artifacts on top", nextSection: 37, skillCheck: false},
                    {text: "Leave it undisturbed", nextSection: 6, skillCheck: false}
                ]
            },
            18: {
                text: "You notice one sarcophagus has fresh scratch marks around the lid, as if opened recently. The nameplate reads 'Lady Isabella Vorlak' with a death date of just five years ago.",
                choices: [
                    {text: "Open Lady Isabella's sarcophagus", nextSection: 38, skillCheck: false},
                    {text: "Check for recent offerings", nextSection: 39, skillCheck: false},
                    {text: "Return to other sarcophagi", nextSection: 6, skillCheck: false}
                ]
            },
            19: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 40, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('secret');
                        return "You find a hidden lever behind one sarcophagus! It might open a secret compartment.";
                    } else {
                        playSound('skeleton');
                        // Single skeleton
                        combatState.active = true;
                        combatState.enemyName = "Guardian Skeleton";
                        combatState.enemyHealth = 40;
                        combatState.enemyCurrentHealth = 40;
                        combatState.enemyStrength = 12;
                        combatState.enemyDamageDice = 2;
                        combatState.enemyDamageSides = 6;
                        combatState.nextSection = 41;
                        combatState.round = 1;
                        combatState.isPack = false;
                        
                        return "You disturb a hidden guardian! A single skeleton rises to attack!<br><br><span class='skeleton'>Guardian Skeleton</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                    }
                }
            },
            20: {
                text: "After your discovery, you continue exploring the burial chamber.",
                choices: [
                    {text: "Examine the sarcophagi", nextSection: 6, skillCheck: false},
                    {text: "Continue deeper", nextSection: 8, skillCheck: false}
                ]
            },
            21: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 42, skillCheck: false}
                ]
            },
            22: {
                text: "The passage ends at a stone door carved with three skulls facing different directions - just like in the wall carving! This must be the secret passage.",
                choices: [
                    {text: "Examine the skull door", nextSection: 43, skillCheck: false},
                    {text: "Try to open it", nextSection: 44, skillCheck: false},
                    {text: "Return to burial chamber", nextSection: 2, skillCheck: false}
                ]
            },
            23: {
                text: "You listen carefully. Beyond the dripping water, you can hear faint scratching sounds... and what might be whispering. The air grows colder.",
                choices: [
                    {text: "Proceed cautiously", nextSection: 45, skillCheck: false},
                    {text: "Return and take another path", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    playSound('crypt');
                    return "The whispers seem to be coming from beyond the stone door...";
                }
            },
            24: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(10, 10);
                        gameState.gold += goldFound;
                        addToInventory('Jeweled Chalice');
                        updateStatsDisplay();
                        playSound('item');
                        return "You carefully avoid the traps and gather treasure! You gain <span class='gold'>" + goldFound + " Gold</span> and a <span class='item'>Jeweled Chalice</span>!";
                    } else {
                        const damage = rollDice(4, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You trigger a poison gas trap! Coughing and choking, you take " + damage + " damage and retreat empty-handed!";
                    }
                }
            },
            25: {
                text: "You grab a handful of treasure and sprint for the exit!",
                choices: [
                    {text: "Continue", nextSection: 47, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(6, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    
                    // 50% chance of triggering trap anyway
                    if (Math.random() > 0.5) {
                        const damage = rollDice(2, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You trigger a tripwire! Falling, you take " + damage + " damage but manage to escape with <span class='gold'>" + goldFound + " Gold</span>.";
                    } else {
                        return "You escape just as traps activate behind you! You gained <span class='gold'>" + goldFound + " Gold</span>!";
                    }
                }
            },
            26: {
                text: "You freeze, examining the floor. The stones are arranged in a pattern - light and dark. The dark stones seem safe, while the light ones look slightly raised.",
                choices: [
                    {text: "Step only on dark stones", nextSection: 48, skillCheck: false},
                    {text: "Try to disable the trap", nextSection: 49, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Retreat from the room", nextSection: 3, skillCheck: false}
                ]
            },
            27: {
                text: "Having identified the trap pattern, you can now search the treasure room safely.",
                choices: [
                    {text: "Search the treasure carefully", nextSection: 50, skillCheck: false},
                    {text: "Look for the most valuable items", nextSection: 51, skillCheck: false},
                    {text: "Leave the room", nextSection: 3, skillCheck: false}
                ]
            },
            28: {
                text: "After your encounter with the trap, you reconsider the treasure room.",
                choices: [
                    {text: "Search more carefully", nextSection: 9, skillCheck: false},
                    {text: "Examine the floor for traps", nextSection: 10, skillCheck: false},
                    {text: "Leave and try another path", nextSection: 1, skillCheck: false}
                ]
            },
            29: {
                text: "You ready your weapon. The Crypt Guardian smiles, showing his fangs. <span class='cryptguardian'>'So be it. Your blood will feed the masters.'</span>",
                choices: [
                    {text: "Engage in combat", nextSection: 52, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Crypt Guardian Vladis";
                    combatState.enemyHealth = 120;
                    combatState.enemyCurrentHealth = 120;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 53;
                    combatState.round = 1;
                    combatState.isPack = false;
                    
                    playSound('vampire');
                    return "<span class='cryptguardian'>Crypt Guardian Vladis</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            30: {
                text: "<span class='cryptguardian'>'You wish to parley?'</span> the guardian says, tilting his head. <span class='cryptguardian'>'Few mortals show such courage. Speak your purpose.'</span>",
                choices: [
                    {text: "Explain you seek Valerius", nextSection: 54, skillCheck: false},
                    {text: "Say you're lost and mean no harm", nextSection: 55, skillCheck: false},
                    {text: "Ask about the secret passage", nextSection: 56, skillCheck: false},
                    {text: "Attack while he's distracted", nextSection: 29, skillCheck: false}
                ]
            },
            31: {
                text: "While the guardian watches you, you look for another way past. There's a ventilation shaft high on the wall, and the tapestry might hide something...",
                choices: [
                    {text: "Try to reach the ventilation shaft", nextSection: 57, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Examine the tapestry", nextSection: 58, skillCheck: false},
                    {text: "Return to facing the guardian", nextSection: 12, skillCheck: false}
                ]
            },
            32: {
                text: "You've found a hidden alcove behind a tapestry. It contains old burial tools and what might be a secret switch.",
                choices: [
                    {text: "Pull the secret switch", nextSection: 59, skillCheck: false},
                    {text: "Examine the tools", nextSection: 60, skillCheck: false},
                    {text: "Return to the main chamber", nextSection: 4, skillCheck: false}
                ]
            },
            33: {
                text: "The ventilation shaft is too high to reach without climbing. You'd need something to stand on, or exceptional jumping ability.",
                choices: [
                    {text: "Try to climb the wall", nextSection: 61, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Look for something to stand on", nextSection: 62, skillCheck: false},
                    {text: "Abandon this approach", nextSection: 4, skillCheck: false}
                ]
            },
            34: {
                text: "You've memorized the secret passage carving. If you find an altar with three skulls, you'll know what to do.",
                choices: [
                    {text: "Examine battle scenes", nextSection: 16, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ]
            },
            35: {
                text: "The carvings show vampires being repelled by garlic, running water, and holy symbols. Sunlight turns them to ash. Stake through the heart is the surest kill.",
                choices: [
                    {text: "Return to secret passage carving", nextSection: 15, skillCheck: false},
                    {text: "Return to exploring", nextSection: 1, skillCheck: false}
                ],
                action: function() {
                    return "This knowledge might help you against vampire foes.";
                }
            },
            // Continuing with more sections...
            36: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 63, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        const goldFound = rollDice(6, 10);
                        gameState.gold += goldFound;
                        gameState.hasVampireDust = true;
                        addToInventory('Ancient Vampire Dust');
                        updateStatsDisplay();
                        playSound('item');
                        return "You force open the ancient sarcophagus! Inside, you find <span class='gold'>" + goldFound + " Gold</span> and a pouch of <span class='item'>Ancient Vampire Dust</span>.";
                    } else {
                        playSound('failure');
                        return "The lid won't budge. It's sealed with ancient magic.";
                    }
                }
            },
            37: {
                text: "On top of the sarcophagus rests a tarnished silver bowl, a withered rose, and a scroll case.",
                choices: [
                    {text: "Examine the scroll case", nextSection: 64, skillCheck: false},
                    {text: "Take the silver bowl", nextSection: 65, skillCheck: false},
                    {text: "Return to examining sarcophagi", nextSection: 6, skillCheck: false}
                ]
            },
            38: {
                text: "You open Lady Isabella's sarcophagus. Inside lies a vampire in a state of torpor, not quite dead but not awake either. She wears valuable jewelry.",
                choices: [
                    {text: "Take the jewelry", nextSection: 66, skillCheck: false},
                    {text: "Close the sarcophagus quietly", nextSection: 67, skillCheck: false},
                    {text: "Stake her through the heart", nextSection: 68, skillCheck: false}
                ]
            },
            39: {
                text: "Recent offerings include fresh flowers (impossible in a crypt), a silver goblet with traces of red liquid, and a book with a velvet bookmark.",
                choices: [
                    {text: "Examine the book", nextSection: 69, skillCheck: false},
                    {text: "Take the silver goblet", nextSection: 70, skillCheck: false},
                    {text: "Return to sarcophagi", nextSection: 6, skillCheck: false}
                ]
            },
            40: {
                text: "After finding the hidden lever, you wonder what it does.",
                choices: [
                    {text: "Pull the lever", nextSection: 71, skillCheck: false},
                    {text: "Leave it alone", nextSection: 6, skillCheck: false}
                ]
            },
            41: {
                text: "With the skeleton defeated, you can continue your search.",
                choices: [
                    {text: "Examine sarcophagi", nextSection: 6, skillCheck: false},
                    {text: "Continue deeper", nextSection: 8, skillCheck: false}
                ],
                action: function() {
                    gameState.skeletonsDefeated = true;
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('item');
                    return "The skeleton crumbles to dust, leaving behind <span class='gold'>" + goldFound + " Gold</span>.";
                }
            },
            42: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 72, skillCheck: false}
                ]
            },
            43: {
                text: "The stone door has three skull carvings that can be rotated. They currently face left, right, and up. The carving showed them all facing inward toward each other.",
                choices: [
                    {text: "Rotate the skulls to match the carving", nextSection: 73, skillCheck: false},
                    {text: "Try forcing the door open", nextSection: 74, skillCheck: true, checkType: 'strength', difficulty: 20},
                    {text: "Look for another mechanism", nextSection: 75, skillCheck: false}
                ]
            },
            44: {
                text: "The door is sealed tight. It won't budge without solving the puzzle or using immense force.",
                choices: [
                    {text: "Examine the skull mechanism", nextSection: 43, skillCheck: false},
                    {text: "Return to the passage", nextSection: 22, skillCheck: false}
                ]
            },
            45: {
                text: "You proceed through the stone door (assuming you opened it). Beyond lies a narrow tunnel that seems to descend toward the castle foundations.",
                choices: [
                    {text: "Follow the tunnel", nextSection: 76, skillCheck: false},
                    {text: "Listen again", nextSection: 23, skillCheck: false}
                ]
            },
            // Add combat sections and continue the story...
            // For brevity, I'll jump to key sections
            
            52: {
                text: "",
                choices: [
                    {text: "Continue the fight!", nextSection: 77, skillCheck: false}
                ]
            },
            53: {
                text: "With Vladis defeated, the way forward is clear. Behind his throne, you find the entrance to the secret passage leading to the catacombs!",
                choices: [],
                action: function() {
                    gameState.cryptGuardianDefeated = true;
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 8;
                    saveGame();
                    
                    return "Vladis crumbles to dust, leaving behind his armor and a key. The secret passage to the catacombs is now accessible!";
                }
            },
            76: {
                text: "You follow the tunnel as it descends deeper underground. The air grows colder and damper. You've found the entrance to the catacombs!",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-strength').textContent = gameState.strength;
                    document.getElementById('next-stat-health').textContent = gameState.health;
                    document.getElementById('next-stat-agility').textContent = gameState.agility;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    
                    // Display inventory that will carry over
                    const inventoryDisplay = document.getElementById('next-inventory-display');
                    inventoryDisplay.innerHTML = '';
                    
                    // Show equipped items
                    const equippedDiv = document.createElement('div');
                    equippedDiv.innerHTML = `<strong>Equipped:</strong> ${gameState.equippedWeapon}, ${gameState.equippedArmor}`;
                    inventoryDisplay.appendChild(equippedDiv);
                    
                    // Show other inventory
                    if (gameState.inventory.length > 0) {
                        const invDiv = document.createElement('div');
                        invDiv.innerHTML = `<strong>Inventory:</strong> ${gameState.inventory.join(', ')}`;
                        inventoryDisplay.appendChild(invDiv);
                    }
                    
                    playSound('level');
                    
                    // Save completed level state
                    gameState.level = 8;
                    saveGame();
                    
                    return "You've found the secret passage to the castle catacombs!";
                }
            }
        };
        
        // Initialize game for Level 7
        function initGame() {
            // Load game state from Level 6
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 7 (coming from Level 6)
                if (savedState.level === 7) {
                    Object.assign(gameState, savedState);
                    
                    // Update intro screen with loaded stats
                    document.getElementById('intro-stat-strength').textContent = gameState.strength;
                    document.getElementById('intro-stat-health').textContent = gameState.health;
                    document.getElementById('intro-stat-maxhealth').textContent = gameState.maxHealth;
                    document.getElementById('intro-stat-agility').textContent = gameState.agility;
                    document.getElementById('intro-stat-gold').textContent = gameState.gold;
                    
                    showScreen('screen-intro');
                    return;
                } else if (savedState.level === 6) {
                    // If coming directly from Level 6 without completing it
                    alert("You must complete Level 6 first!");
                    window.location.href = 'l6.html';
                    return;
                }
            } else {
                // No saved game found
                alert("No saved game found. Starting from Level 1.");
                window.location.href = 'l1.html';
                return;
            }
        }
        
        function startLevel7() {
            playSound('click');
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/8`;
        }
        
        // Sarcophagus selection functions
        function selectSarcophagus(sarcophagusType) {
            playSound('item');
            const result = sarcophagusResults[sarcophagusType];
            
            // Add gold if any
            if (result.gold) {
                gameState.gold += result.gold;
                updateStatsDisplay();
            }
            
            // Add item if any
            if (result.item) {
                addToInventory(result.item);
                gameState.foundCryptArtifact = true;
            }
            
            // Show feedback
            document.getElementById('sarcophagus-feedback-text').innerHTML = result.text + 
                (result.gold ? `<br><br>You find <span class='gold'>${result.gold} Gold</span>` : '') +
                (result.item ? ` and a <span class='item'>${result.item}</span>.` : '.');
            document.getElementById('sarcophagus-feedback').style.display = 'block';
            
            // Apply special effect
            if (result.effect === "strength") {
                gameState.strength += 2;
                updateStatsDisplay();
                document.getElementById('sarcophagus-feedback-text').innerHTML += `<br>Your Strength increases by 2!`;
            } else if (result.effect === "armor") {
                gameState.equippedArmor = result.item;
                updateInventoryDisplay();
                document.getElementById('sarcophagus-feedback-text').innerHTML += `<br>You equip the ${result.item}!`;
            }
        }
        
        function cancelSarcophagusSelection() {
            playSound('click');
            showScreen('screen-game');
            loadSection(6); // Return to sarcophagus examination
        }
        
        // Crypt Guardian screen functions
        function fightCryptGuardian() {
            playSound('click');
            showScreen('screen-game');
            loadSection(29);
        }
        
        function talkToCryptGuardian() {
            playSound('click');
            showScreen('screen-game');
            loadSection(30);
        }
        
        function sneakPastCryptGuardian() {
            playSound('click');
            showScreen('screen-game');
            loadSection(31);
        }
        
        function useItemOnGuardian() {
            playSound('click');
            let itemText = "<div class='dice-roll'><strong>Select an item to use on the Crypt Guardian:</strong><br>";
            
            // Filter for items that might affect a vampire
            const effectiveItems = gameState.inventory.filter(item => 
                item.includes('Holy') || item.includes('Silver') || item.includes('Garlic') || 
                item === 'Ancient Vampire Dust' || item === 'Vorlak Ceremonial Dagger');
            
            if (effectiveItems.length > 0) {
                effectiveItems.forEach(item => {
                    itemText += `<button onclick="useItemAgainstGuardian('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            } else {
                itemText += "<br>You have no items that would affect a vampire.";
            }
            
            itemText += `<br><br><button onclick="showScreen('screen-cryptguardian')" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML = itemText;
            showScreen('screen-game');
        }
        
        function useItemAgainstGuardian(item) {
            playSound('item');
            let result = "";
            
            if (item.includes('Holy')) {
                result = "The holy item burns Vladis! He recoils in pain, giving you an opening!";
                gameState.cryptGuardianDefeated = true;
                showScreen('screen-game');
                loadSection(53);
            } else if (item.includes('Silver')) {
                result = "The silver weapon hurts Vladis more than normal! He seems weakened.";
                combatState.enemyStrength -= 3;
                combatState.enemyHealth -= 20;
                combatState.enemyCurrentHealth -= 20;
                showScreen('screen-game');
                loadSection(29);
            } else if (item === 'Ancient Vampire Dust') {
                result = "The ancient vampire dust disrupts Vladis's connection to the crypt! He becomes disoriented.";
                combatState.enemyStrength -= 5;
                showScreen('screen-game');
                loadSection(29);
            } else if (item === 'Vorlak Ceremonial Dagger') {
                result = "Vladis recognizes the Vorlak dagger! <span class='cryptguardian'>'The master's own blade... you are either very brave or very foolish.'</span> He seems momentarily off-balance.";
                combatState.enemyStrength -= 2;
                showScreen('screen-game');
                loadSection(29);
            } else {
                result = "The item has no effect on Vladis.";
                showScreen('screen-cryptguardian');
            }
            
            document.getElementById('story-text').innerHTML = `<div class="dice-roll">${result}</div>`;
            removeFromInventory(item);
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Healing Potion' || item === 'Mountain Potion' || item === 'Ancient Vampire Wine') {
                const healAmount = item === 'Mountain Potion' ? rollDice(3, 6) + 10 : 
                                 item === 'Ancient Vampire Wine' ? rollDice(2, 8) + 5 : rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>${item}</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item.includes('Holy')) {
                message = "The <span class='item'>" + item + "</span> glows with holy energy. It could harm undead or vampire creatures.";
            } else if (item.includes('Silver')) {
                message = "The <span class='item'>" + item + "</span> is made of silver, effective against werewolves and some undead.";
            } else if (item === 'Ancient Vampire Dust') {
                message = "The <span class='item'>Ancient Vampire Dust</span> might disrupt vampire magic or be used in rituals.";
            } else if (item === 'Vorlak Ceremonial Dagger') {
                gameState.equippedWeapon = item;
                updateInventoryDisplay();
                message = `You equip the <span class='item'>${item}</span>. It's finely crafted and might have special properties against vampires.`;
            } else if (item === 'Vampire Lord Armor') {
                gameState.equippedArmor = item;
                updateInventoryDisplay();
                message = "You equip the <span class='item'>Vampire Lord Armor</span>. It offers excellent protection.";
            } else if (item === 'Crypt Interior Map') {
                message = "The <span class='item'>Crypt Interior Map</span> shows the layout of the crypt's chambers.";
                gameState.hasCryptMap = true;
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0 && 
                gameState.equippedWeapon === 'Rusty Sword' && 
                gameState.equippedArmor === 'Leather Armor') {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check for random green flare (crypt ambiance)
            if (Math.random() < 0.2 && (sectionId === 1 || sectionId === 2 || sectionId === 3 || sectionId === 4)) {
                randomEvents.greenFlares++;
                playSound('crypt');
                storyText += "<br><span class='ghost'>The green flames in the braziers flare suddenly, casting dancing shadows.</span>";
            }
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 42 || sectionId === 52 || sectionId === 72 || sectionId === 77);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended
                    let goldReward = 0;
                    
                    if (combatState.enemyName.includes("Skeletons")) {
                        goldReward = Math.floor(Math.random() * 50) + 25;
                        gameState.skeletonsDefeated = true;
                    } else if (combatState.enemyName.includes("Crypt Guardian")) {
                        goldReward = Math.floor(Math.random() * 100) + 50;
                        gameState.cryptGuardianDefeated = true;
                    }
                    
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    
                    if (goldReward > 0) {
                        storyText += `<br>You find <span class="gold">${goldReward} Gold</span> on the remains.`;
                    }
                    
                    if (combatState.enemyName.includes("Crypt Guardian")) {
                        storyText += `<br>Behind where Vladis stood, a hidden door slides open, revealing the passage to the catacombs!`;
                    }
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        if (combatState.nextSection === 53) {
                            // Special case for crypt guardian defeat
                            loadSection(53);
                        } else {
                            loadSection(combatState.nextSection);
                        }
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                // Filter choices based on requirements
                const availableChoices = section.choices.filter(choice => {
                    if (!choice.requirement) return true;
                    if (typeof choice.requirement === 'function') {
                        return choice.requirement();
                    }
                    return gameState.inventory.includes(choice.requirement) || 
                           gameState.equippedWeapon === choice.requirement ||
                           gameState.equippedArmor === choice.requirement;
                });
                
                // If no choices available (and not a special section), provide a default
                if (availableChoices.length === 0 && section.choices.length > 0) {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = "Continue exploring the crypt";
                    button.onclick = function() {
                        loadSection(1); // Go back to start
                    };
                    choiceButtons.appendChild(button);
                } else {
                    availableChoices.forEach(choice => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn';
                        button.textContent = choice.text;
                        button.onclick = function() {
                            if (choice.skillCheck) {
                                performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                            } else {
                                loadSection(choice.nextSection);
                            }
                        };
                        choiceButtons.appendChild(button);
                    });
                }
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Special weapon bonuses
                if (weaponType.includes('Silver') || weaponType.includes('Holy')) {
                    // Silver/holy weapons deal extra damage to undead/vampires
                    damage = rollDice(2, 8) + 4;
                    if (combatState.enemyName.includes('Vampire') || combatState.enemyName.includes('Skeleton')) {
                        damage += 5; // Extra vs undead
                        resultText += `<span class="item">Your weapon is especially effective!</span><br>`;
                    }
                } else if (weaponType === 'Vorlak Ceremonial Dagger') {
                    damage = rollDice(3, 6) + 3; // Powerful against vampires
                    if (combatState.enemyName.includes('Vampire')) {
                        damage += 4;
                        resultText += `<span class="item">The Vorlak dagger pulses with dark energy!</span><br>`;
                    }
                } else if (weaponType === 'Glowing Crystal Sword') {
                    damage = rollDice(3, 6); // Powerful weapon
                } else {
                    damage = rollDice(2, 6);
                }
                
                // Item bonuses
                if (gameState.hasHolyWater && combatState.enemyName.includes('Vampire')) {
                    damage += 4;
                    resultText += `<span class="item">Holy water burns the vampire!</span><br>`;
                }
                
                if (gameState.hasVampireDust && combatState.enemyName.includes('Vampire')) {
                    damage += 3;
                    resultText += `<span class="item">Ancient vampire dust disrupts his powers!</span><br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
                if (combatState.enemyCurrentHealth <= 0) {
                    combatState.active = false;
                    resultText += `</div>`;
                    return resultText;
                }
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Vampire life drain
                if (combatState.enemyName.includes('Vampire')) {
                    enemyDamage += 3; // Vampire bite
                    resultText += `<span class="vampire">The vampire's bite drains your life force!</span><br>`;
                }
                
                // Skeleton pack attack
                if (combatState.isPack && combatState.enemyName.includes('Skeleton')) {
                    enemyDamage += Math.floor(combatState.packCount * 0.5);
                    if (combatState.packCount > 1) {
                        resultText += `The skeletons attack from all sides!<br>`;
                    }
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
                // Check if player died
                if (gameState.health <= 0) {
                    combatState.active = false;
                    resultText += `<br><span class="game-over">You have been defeated! Game Over.</span>`;
                    resultText += `</div>`;
                    
                    setTimeout(() => {
                        localStorage.removeItem('castleUndeadGameState');
                        window.location.href = 'l1.html';
                    }, 3000);
                    
                    return resultText;
                }
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect in crypt
                const goodEffects = [
                    "You dodge a falling stone trap!",
                    "You move silently past a sleeping vampire.",
                    "You climb a wall to avoid a pressure plate.",
                    "You slip through a narrow crack in the wall."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip over a loose stone and take 3 damage!",
                    "You knock over a brazier, alerting nearby creatures.",
                    "You get your foot stuck in a crevice.",
                    "You trigger a dart trap, taking 4 damage!"
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    const damage = effect.includes("3") ? 3 : 4;
                    gameState.health -= damage;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('castleUndeadGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 7 (this page)
                if (savedState.level === 7) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    showScreen('screen-game');
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 7.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 8 with updated level
            gameState.level = 8;
            localStorage.setItem('castleUndeadGameState', JSON.stringify(gameState));
            // Redirect to level 8 (The Castle's Catacombs)
            window.location.href = 'l8.html';
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
