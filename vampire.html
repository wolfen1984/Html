<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRACULA'S CURSE</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.3;
        }
        
        body {
            background-color: #000;
            color: #ff0000;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #game-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 5px;
            gap: 5px;
        }
        
        /* Header Bar */
        #header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            border-bottom: 1px solid #ff0000;
            padding-bottom: 5px;
        }
        
        .stat-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .stat {
            display: flex;
        }
        
        /* Main Content Area */
        #content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        #scene-description {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ff0000;
            padding: 8px;
            min-height: 120px;
        }
        
        #combat-log {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ff0000;
            padding: 8px;
            min-height: 60px;
            display: none;
        }
        
        /* Action Buttons */
        #action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        #footer-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 5px;
        }
        
        button {
            background-color: #000;
            color: #ff0000;
            border: 1px solid #ff0000;
            padding: 8px 4px;
            cursor: pointer;
            text-align: center;
        }
        
        button:active {
            background-color: #ff0000;
            color: #000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Character Select Screen */
        #character-selection {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 5px;
        }
        
        .character-select {
            border: 1px solid #ff0000;
            padding: 8px;
        }
        
        .character-select:active {
            background-color: #ff0000;
            color: #000;
        }
        
        /* Modals */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 10px;
            display: none;
            z-index: 100;
            overflow-y: auto;
        }
        
        .modal-content {
            border: 1px solid #ff0000;
            padding: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Inventory Items */
        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed #ff0000;
        }
        
        /* Combat UI */
        #enemy-display {
            border: 1px solid #ff0000;
            padding: 8px;
            margin-bottom: 5px;
        }
        
        .health-bar {
            height: 8px;
            background-color: #300;
            margin-top: 3px;
        }
        
        .health-fill {
            height: 100%;
            background-color: #f00;
        }
        
        /* Player Health Bar */
        #player-health-bar {
            height: 8px;
            background-color: #300;
            margin-top: 3px;
        }
        
        #player-health-fill {
            height: 100%;
            background-color: #f00;
            width: 100%;
        }
        
        /* Utility Classes */
        .text-center {
            text-align: center;
        }
        
        .mt-1 {
            margin-top: 5px;
        }
        
        .mb-1 {
            margin-bottom: 5px;
        }
        
        /* Animation Classes */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.4s ease-in-out;
        }
        
        @keyframes flash-red {
            0%, 100% { background-color: #000; }
            50% { background-color: #f00; }
        }
        
        .flash-red {
            animation: flash-red 0.3s ease-in-out;
        }
        
        /* Character Stats Modal */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        
        /* Quests Modal */
        .quest-item {
            padding: 5px 0;
            border-bottom: 1px dashed #ff0000;
        }
        
        .quest-title {
            font-weight: bold;
        }
        
        .quest-completed {
            color: #0f0;
        }
        
        /* Map Modal */
        #map-display {
            font-family: monospace;
            white-space: pre;
            line-height: 1;
            font-size: 12px;
        }
        
        /* Settings Modal */
        #settings-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* New Game+ Button */
        #new-game-plus {
            background-color: #300;
            border-color: #f00;
            margin-top: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #ff0000;
            font-size: 16px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        /* Merchant Modal */
        .merchant-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #ff0000;
        }
        
        .merchant-price {
            color: #ff0;
        }

        /* New Styles */
        .blood-drip {
            position: relative;
            text-shadow: 0 0 5px #f00;
        }
        
        .blood-drip::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 50%;
            width: 2px;
            height: 15px;
            background: linear-gradient(to bottom, #f00, transparent);
            animation: drip 3s infinite;
        }
        
        @keyframes drip {
            0%, 100% { height: 0; opacity: 0; }
            50% { height: 15px; opacity: 1; }
        }
        
        .candle-flicker {
            animation: flicker 5s infinite alternate;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 0.8; }
            25%, 75% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .sanity-meter {
            height: 8px;
            background-color: #030;
            margin-top: 3px;
        }
        
        .sanity-fill {
            height: 100%;
            background-color: #0f0;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #300;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Combat effects */
        @keyframes blood-splatter {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .blood-splatter {
            position: absolute;
            width: 100px;
            height: 100px;
            background-image: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,0,0,0) 70%);
            animation: blood-splatter 0.5s ease-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Character Selection Screen -->
        <div id="character-selection">
            <h1 class="text-center blood-drip">DRACULA'S CURSE</h1>
            <p>The year is 1897. The vampire Count Dracula has taken residence in his decaying castle above the village of Bistritz.</p>
            <p class="text-center">CHOOSE YOUR HUNTER:</p>
            
            <div class="character-select" id="select-jonathan">
                <h2>JONATHAN HARKER</h2>
                <p><strong>Class:</strong> Diplomat</p>
                <p><strong>Skills:</strong> Silver Strike (2x damage with silver weapons)</p>
                <p><strong>HP:</strong> 90 | <strong>SANITY:</strong> 110 | <strong>DMG:</strong> 7-12</p>
            </div>
            
            <div class="character-select" id="select-vanhelsing">
                <h2>VAN HELSING</h2>
                <p><strong>Class:</strong> Professor</p>
                <p><strong>Skills:</strong> Holy Water (double effectiveness)</p>
                <p><strong>HP:</strong> 100 | <strong>SANITY:</strong> 90 | <strong>DMG:</strong> 5-15</p>
            </div>
            
            <div class="character-select" id="select-mina">
                <h2>MINA MURRAY</h2>
                <p><strong>Class:</strong> Occultist</p>
                <p><strong>Skills:</strong> Hypnosis (chance to stun enemies)</p>
                <p><strong>HP:</strong> 80 | <strong>SANITY:</strong> 120 | <strong>DMG:</strong> 4-10</p>
            </div>
            
            <button id="settings-button" style="margin-top: 10px;">SETTINGS</button>
        </div>
        
        <!-- Main Game UI (Hidden Initially) -->
        <div id="main-game" style="display: none; height: 100%;">
            <!-- Header Stats -->
            <div id="header">
                <div class="stat-group">
                    <div class="stat">HP: <span id="current-hp">100</span>/<span id="max-hp">100</span></div>
                    <div class="stat">SANITY: <span id="current-sanity">100</span>/<span id="max-sanity">100</span></div>
                    <div class="health-bar">
                        <div id="player-health-fill" class="health-fill" style="width: 100%;"></div>
                    </div>
                    <div class="sanity-meter">
                        <div id="player-sanity-fill" class="sanity-fill" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="stat-group">
                    <div class="stat">LVL: <span id="player-level">1</span></div>
                    <div class="stat">DAY: <span id="day-count">1</span></div>
                </div>
                <div class="stat-group">
                    <div class="stat">XP: <span id="current-xp">0</span>/<span id="next-level-xp">100</span></div>
                    <div class="stat">GOLD: <span id="player-gold">50</span></div>
                    <div class="stat">TIME: <span id="game-time">NIGHT</span></div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div id="content-area">
                <div id="scene-description" class="candle-flicker">
                    <p>You stand in the dimly lit tavern at the foot of the Carpathian Mountains. The villagers whisper of horrors in the castle above.</p>
                    <p>The barkeep eyes you warily. "You're not going up there, are you?" A merchant sits in the corner.</p>
                </div>
                
                <div id="combat-log"></div>
                
                <!-- Dynamic Action Buttons -->
                <div id="action-buttons">
                    <button id="talk-barkeep">TALK</button>
                    <button id="leave-tavern">LEAVE</button>
                    <button id="visit-merchant">MERCHANT</button>
                    <button id="rest">REST</button>
                </div>
                
                <!-- Current Weapon -->
                <div class="item-row">
                    <span>WEAPON:</span>
                    <span id="equipped-weapon-name">FISTS</span> (<span id="equipped-weapon-dmg">2</span> DMG)
                </div>
                
                <!-- Footer Buttons -->
                <div id="footer-buttons">
                    <button id="inventory-button">INV</button>
                    <button id="quests-button">QUESTS</button>
                    <button id="character-button">STATS</button>
                    <button id="map-button">MAP</button>
                    <button id="game-settings-button" style="grid-column: span 4;">SETTINGS</button>
                </div>
            </div>
        </div>
        
        <!-- Inventory Modal -->
        <div id="inventory-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>INVENTORY</h2>
                    <button id="close-inventory" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <h3>WEAPONS</h3>
                    <div id="weapons-list">
                        <div class="item-row" data-id="fists" data-dmg="2">
                            <span>FISTS (2 DMG)</span>
                            <button class="equip-button">EQUIP</button>
                        </div>
                    </div>
                    
                    <h3 class="mt-1">ITEMS</h3>
                    <div id="items-list">
                        <div class="item-row" data-id="health-potion" data-heal="20">
                            <span>HEALTH POTION (+20 HP)</span>
                            <button class="use-button">USE</button>
                        </div>
                    </div>
                    
                    <h3 class="mt-1">QUEST ITEMS</h3>
                    <div id="quest-items-list">
                        <!-- Quest items will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Character Stats Modal -->
        <div id="character-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="character-name">CHARACTER</h2>
                    <button id="close-character" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <div class="stat-row">
                        <span>CLASS:</span>
                        <span id="character-class">DIPLOMAT</span>
                    </div>
                    <div class="stat-row">
                        <span>LEVEL:</span>
                        <span id="character-level">1</span>
                    </div>
                    <div class="stat-row">
                        <span>NEXT LEVEL:</span>
                        <span id="character-next-level">100 XP</span>
                    </div>
                    
                    <h3 class="mt-1">ATTRIBUTES</h3>
                    <div class="stat-row">
                        <span>STRENGTH:</span>
                        <span id="character-strength">7</span>
                    </div>
                    <div class="stat-row">
                        <span>AGILITY:</span>
                        <span id="character-agility">6</span>
                    </div>
                    <div class="stat-row">
                        <span>INTELLIGENCE:</span>
                        <span id="character-intelligence">5</span>
                    </div>
                    <div class="stat-row">
                        <span>FAITH:</span>
                        <span id="character-faith">4</span>
                    </div>
                    
                    <h3 class="mt-1">SKILLS</h3>
                    <div id="character-skills">
                        <p>SILVER STRIKE</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quests Modal -->
        <div id="quests-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>QUESTS</h2>
                    <button id="close-quests" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <div id="active-quests">
                        <div class="quest-item">
                            <div class="quest-title">SLAY DRACULA</div>
                            <div class="quest-description">Defeat Count Dracula to lift the curse.</div>
                            <div class="quest-status">(Active)</div>
                        </div>
                    </div>
                    
                    <h3 class="mt-1">COMPLETED</h3>
                    <div id="completed-quests">
                        <!-- Completed quests will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Modal -->
        <div id="map-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>MAP</h2>
                    <button id="close-map" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <div id="map-display">
                        [MAP WILL APPEAR HERE]
                    </div>
                    <div id="map-legend" class="mt-1">
                        <p>X - Your location</p>
                        <p>■ - Visited location</p>
                        <p>□ - Unvisited location</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>SETTINGS</h2>
                    <button id="close-settings" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <div id="settings-content">
                        <div class="setting-option">
                            <span>Text Speed:</span>
                            <select id="text-speed">
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium</option>
                                <option value="slow">Slow</option>
                            </select>
                        </div>
                        <div class="setting-option">
                            <span>Combat Animations:</span>
                            <input type="checkbox" id="combat-animations" checked>
                        </div>
                        <div class="setting-option">
                            <span>Sound Effects:</span>
                            <input type="checkbox" id="sound-effects" checked>
                        </div>
                        <div class="setting-option">
                            <span>Music:</span>
                            <input type="checkbox" id="music" checked>
                        </div>
                        <button id="save-settings">SAVE SETTINGS</button>
                        <button id="reset-game">RESET GAME</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Combat Modal -->
        <div id="combat-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="combat-title">COMBAT</h2>
                </div>
                <div class="modal-body">
                    <div id="enemy-display">
                        <h3 id="enemy-name">VAMPIRE SPAWN</h3>
                        <div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
                        <div class="health-bar">
                            <div class="health-fill" id="enemy-hp-bar" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div id="player-display">
                        <h3 id="player-name">JONATHAN HARKER</h3>
                        <div>HP: <span id="player-hp-combat">100</span>/<span id="player-max-hp-combat">100</span></div>
                        <div class="health-bar">
                            <div id="player-hp-bar" class="health-fill" style="width: 100%;"></div>
                        </div>
                        <div>SANITY: <span id="player-sanity-combat">100</span>/<span id="player-max-sanity-combat">100</span></div>
                        <div class="sanity-meter">
                            <div id="player-sanity-bar" class="sanity-fill" style="width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div id="combat-log-modal" style="min-height: 80px;">
                        <p>A VAMPIRE SPAWN HISSES AT YOU!</p>
                    </div>
                    
                    <div id="combat-actions" class="mt-1">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <button id="attack-button">ATTACK</button>
                            <button id="special-button">SPECIAL</button>
                            <button id="use-item-button">ITEM</button>
                            <button id="flee-button">FLEE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Over Modal -->
        <div id="game-over-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="text-center">GAME OVER</h2>
                </div>
                <div class="modal-body text-center">
                    <p id="game-over-text">You have been defeated!</p>
                    <button id="try-again-button">TRY AGAIN</button>
                    <button id="main-menu-button">MAIN MENU</button>
                </div>
            </div>
        </div>
        
        <!-- Victory Modal -->
        <div id="victory-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="text-center">VICTORY!</h2>
                </div>
                <div class="modal-body text-center">
                    <p>You have defeated Dracula and lifted the curse!</p>
                    <p>Final Stats:</p>
                    <p>Level: <span id="victory-level">1</span></p>
                    <p>Gold: <span id="victory-gold">0</span></p>
                    <p>Enemies Defeated: <span id="victory-enemies">0</span></p>
                    <button id="new-game-button">NEW GAME</button>
                    <button id="new-game-plus-button">NEW GAME+</button>
                </div>
            </div>
        </div>
        
        <!-- Merchant Modal -->
        <div id="merchant-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>MERCHANT</h2>
                    <button id="close-merchant" class="close-modal">X</button>
                </div>
                <div class="modal-body">
                    <div id="merchant-gold">GOLD: <span id="merchant-gold-amount">0</span></div>
                    
                    <h3 class="mt-1">BUY ITEMS</h3>
                    <div id="merchant-buy-list">
                        <div class="merchant-item" data-id="health-potion" data-price="15">
                            <span class="tooltip">HEALTH POTION (+20 HP)<span class="tooltiptext">Restores 20 HP. Essential for survival.</span></span>
                            <span class="merchant-price">15 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="holy-water" data-price="25">
                            <span class="tooltip">HOLY WATER (15 DMG vs vampires)<span class="tooltiptext">Deals 15 damage. Effective against undead.</span></span>
                            <span class="merchant-price">25 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="garlic" data-price="10">
                            <span class="tooltip">GARLIC (5 DMG, repels vampires)<span class="tooltiptext">Deals 5 damage. Repels vampires temporarily.</span></span>
                            <span class="merchant-price">10 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="silver-dagger" data-price="50">
                            <span class="tooltip">SILVER DAGGER (8 DMG, effective vs werewolves)<span class="tooltiptext">Deals 8 damage. Effective against werewolves.</span></span>
                            <span class="merchant-price">50 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="crossbow" data-price="75">
                            <span class="tooltip">CROSSBOW (10 DMG, silver-tipped arrows)<span class="tooltiptext">Deals 10 damage. Comes with 10 silver-tipped arrows.</span></span>
                            <span class="merchant-price">75 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="winchester" data-price="100">
                            <span class="tooltip">WINCHESTER RIFLE (15 DMG, powerful)<span class="tooltiptext">Deals 15 damage. Comes with 6 bullets.</span></span>
                            <span class="merchant-price">100 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="flintlock" data-price="60">
                            <span class="tooltip">FLINTLOCK PISTOL (12 DMG, one-shot)<span class="tooltiptext">Deals 12 damage. Single shot before reload.</span></span>
                            <span class="merchant-price">60 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="lantern" data-price="20">
                            <span class="tooltip">LANTERN (lights dark areas)<span class="tooltiptext">Illuminates dark areas. Weakens shadow creatures.</span></span>
                            <span class="merchant-price">20 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="silver-cross" data-price="30">
                            <span class="tooltip">SILVER CROSS (repels vampires)<span class="tooltiptext">Protects against vampire attacks. Reduces sanity loss.</span></span>
                            <span class="merchant-price">30 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="bible" data-price="25">
                            <span class="tooltip">HOLY BIBLE (weakens undead)<span class="tooltiptext">Weakens undead creatures. Boosts holy attacks.</span></span>
                            <span class="merchant-price">25 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                        <div class="merchant-item" data-id="sanity-potion" data-price="20">
                            <span class="tooltip">ELIXIR OF CLARITY (+30 SANITY)<span class="tooltiptext">Restores 30 sanity. Prevents madness.</span></span>
                            <span class="merchant-price">20 GOLD</span>
                            <button class="buy-button">BUY</button>
                        </div>
                    </div>
                    
                    <h3 class="mt-1">SELL ITEMS</h3>
                    <div id="merchant-sell-list">
                        <!-- Player's sellable items will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== GAME STATE ========== //
        const gameState = {
            player: null,
            characters: {
                jonathan: {
                    name: "JONATHAN HARKER",
                    class: "DIPLOMAT",
                    hp: 90,
                    maxHp: 90,
                    sanity: 110,
                    maxSanity: 110,
                    strength: 7,
                    agility: 6,
                    intelligence: 5,
                    faith: 4,
                    skills: ["SILVER STRIKE"],
                    inventory: ["silver-dagger"]
                },
                vanhelsing: {
                    name: "VAN HELSING",
                    class: "PROFESSOR",
                    hp: 100,
                    maxHp: 100,
                    sanity: 90,
                    maxSanity: 90,
                    strength: 5,
                    agility: 4,
                    intelligence: 8,
                    faith: 7,
                    skills: ["HOLY WATER"],
                    inventory: ["holy-water", "garlic"]
                },
                mina: {
                    name: "MINA MURRAY",
                    class: "OCCULTIST",
                    hp: 80,
                    maxHp: 80,
                    sanity: 120,
                    maxSanity: 120,
                    strength: 4,
                    agility: 7,
                    intelligence: 7,
                    faith: 6,
                    skills: ["HYPNOSIS"],
                    inventory: ["occult-tome"]
                }
            },
            currentEnemy: null,
            inCombat: false,
            location: "tavern",
            time: "night",
            dayCount: 1,
            enemiesDefeated: 0,
            hasReceivedStake: false,
            quests: {
                active: [
                    {
                        id: "slay-dracula",
                        title: "SLAY DRACULA",
                        description: "Defeat Count Dracula to lift the curse.",
                        completed: false
                    },
                    {
                        id: "find-stake",
                        title: "FIND A STAKE",
                        description: "Obtain a wooden stake to fight vampires.",
                        completed: false
                    }
                ],
                completed: []
            },
            inventory: {
                weapons: [
                    { id: "fists", name: "FISTS", damage: 2 },
                    { id: "silver-dagger", name: "SILVER DAGGER", damage: 8, special: "silver" },
                    { id: "wooden-stake", name: "WOODEN STAKE", damage: 12, special: "stake" },
                    { id: "crossbow", name: "CROSSBOW", damage: 10, special: "silver", ammo: 10 },
                    { id: "winchester", name: "WINCHESTER RIFLE", damage: 15, special: "firearm", ammo: 6 },
                    { id: "flintlock", name: "FLINTLOCK PISTOL", damage: 12, special: "firearm", ammo: 1 },
                    { id: "torch", name: "TORCH", damage: 3, special: "light" }
                ],
                items: [
                    { id: "health-potion", name: "HEALTH POTION", heal: 20, quantity: 3 },
                    { id: "holy-water", name: "HOLY WATER", damage: 15, quantity: 2, special: "holy" },
                    { id: "garlic", name: "GARLIC", damage: 5, quantity: 3, special: "repel" },
                    { id: "rope", name: "ROPE", quantity: 1, usable: true },
                    { id: "lantern", name: "LANTERN", quantity: 0, usable: true, special: "light" },
                    { id: "silver-cross", name: "SILVER CROSS", quantity: 0, special: "holy" },
                    { id: "bible", name: "HOLY BIBLE", quantity: 0, special: "holy" },
                    { id: "sanity-potion", name: "ELIXIR OF CLARITY", sanity: 30, quantity: 0 },
                    { id: "occult-tome", name: "OCCULT TOME", quantity: 1, special: "knowledge" }
                ],
                questItems: []
            },
            enemies: {
                "vampire-spawn": {
                    name: "VAMPIRE SPAWN",
                    hp: 30,
                    maxHp: 30,
                    damage: 6,
                    xp: 25,
                    gold: 15,
                    weakness: ["stake", "holy"],
                    nightBonus: true
                },
                "brides": {
                    name: "DRACULA'S BRIDES",
                    hp: 50,
                    maxHp: 50,
                    damage: 9,
                    xp: 40,
                    gold: 30,
                    special: "charm",
                    weakness: ["holy", "silver"],
                    nightBonus: true
                },
                "werewolf": {
                    name: "WEREWOLF",
                    hp: 70,
                    maxHp: 70,
                    damage: 12,
                    xp: 60,
                    gold: 45,
                    weakness: ["silver"],
                    nightBonus: true
                },
                "ghoul": {
                    name: "GHOUL",
                    hp: 40,
                    maxHp: 40,
                    damage: 8,
                    xp: 35,
                    gold: 20,
                    weakness: ["holy"],
                    nightBonus: true
                },
                "shadow": {
                    name: "SHADOW",
                    hp: 25,
                    maxHp: 25,
                    damage: 5,
                    xp: 20,
                    gold: 10,
                    special: "fear",
                    weakness: ["light"],
                    nightBonus: true
                },
                "dracula": {
                    name: "COUNT DRACULA",
                    hp: 150,
                    maxHp: 150,
                    damage: 15,
                    xp: 200,
                    gold: 100,
                    special: "transform",
                    weakness: ["stake", "holy"],
                    nightBonus: false
                }
            },
            locations: {
                "tavern": {
                    name: "VILLAGE TAVERN",
                    description: "A dimly lit tavern where villagers gather. A merchant sits in the corner.",
                    visited: true,
                    connections: ["mountain-path"]
                },
                "mountain-path": {
                    name: "MOUNTAIN PATH",
                    description: "A treacherous path leading up to the castle.",
                    visited: false,
                    connections: ["tavern", "castle-gates"]
                },
                "castle-gates": {
                    name: "CASTLE GATES",
                    description: "The massive entrance to Dracula's castle.",
                    visited: false,
                    connections: ["mountain-path", "castle-courtyard"]
                },
                "castle-courtyard": {
                    name: "CASTLE COURTYARD",
                    description: "A decaying courtyard filled with ominous statues.",
                    visited: false,
                    connections: ["castle-gates", "castle-hall"]
                },
                "castle-hall": {
                    name: "GREAT HALL",
                    description: "The main hall of the castle, with a grand staircase.",
                    visited: false,
                    connections: ["castle-courtyard", "throne-room"]
                },
                "throne-room": {
                    name: "THRONE ROOM",
                    description: "Where Dracula awaits, seated upon his dark throne.",
                    visited: false,
                    connections: ["castle-hall"]
                }
            },
            settings: {
                textSpeed: "medium",
                combatAnimations: true,
                soundEffects: true,
                music: true
            },
            newGamePlus: false,
            merchantItems: [
                { id: "health-potion", name: "HEALTH POTION", price: 15, heal: 20 },
                { id: "holy-water", name: "HOLY WATER", price: 25, damage: 15, special: "holy" },
                { id: "garlic", name: "GARLIC", price: 10, damage: 5, special: "repel" },
                { id: "silver-dagger", name: "SILVER DAGGER", price: 50, damage: 8, special: "silver" },
                { id: "crossbow", name: "CROSSBOW", price: 75, damage: 10, special: "silver", ammo: 10 },
                { id: "winchester", name: "WINCHESTER RIFLE", price: 100, damage: 15, special: "firearm", ammo: 6 },
                { id: "flintlock", name: "FLINTLOCK PISTOL", price: 60, damage: 12, special: "firearm", ammo: 1 },
                { id: "lantern", name: "LANTERN", price: 20, usable: true, special: "light" },
                { id: "silver-cross", name: "SILVER CROSS", price: 30, special: "holy" },
                { id: "bible", name: "HOLY BIBLE", price: 25, special: "holy" },
                { id: "sanity-potion", name: "ELIXIR OF CLARITY", price: 20, sanity: 30 },
                { id: "torch", name: "TORCH", price: 15, damage: 3, special: "light" }
            ]
        };

        // ========== INITIALIZE GAME ========== //
        document.addEventListener('DOMContentLoaded', function() {
            // Character selection
            document.getElementById('select-jonathan').addEventListener('click', () => startGame('jonathan'));
            document.getElementById('select-vanhelsing').addEventListener('click', () => startGame('vanhelsing'));
            document.getElementById('select-mina').addEventListener('click', () => startGame('mina'));
            document.getElementById('settings-button').addEventListener('click', openSettings);
            
            // Main menu settings
            document.getElementById('close-settings').addEventListener('click', hideAllModals);
        });

        function startGame(character, isNewGamePlus = false) {
            gameState.player = JSON.parse(JSON.stringify(gameState.characters[character]));
            
            // Apply New Game+ bonuses if applicable
            if (isNewGamePlus) {
                gameState.player.maxHp += 20;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.maxSanity += 20;
                gameState.player.sanity = gameState.player.maxSanity;
                gameState.player.strength += 2;
                gameState.player.agility += 2;
                gameState.player.intelligence += 2;
                gameState.player.faith += 2;
                gameState.newGamePlus = true;
            } else {
                gameState.newGamePlus = false;
            }
            
            // Initialize additional player properties
            gameState.player.level = 1;
            gameState.player.xp = 0;
            gameState.player.nextLevelXp = 100;
            gameState.player.gold = 50;
            gameState.player.equippedWeapon = "fists";
            if (character === "jonathan") gameState.player.equippedWeapon = "silver-dagger";
            if (character === "vanhelsing") gameState.player.equippedWeapon = "holy-water";
            
            // Reset game state
            gameState.enemiesDefeated = 0;
            gameState.dayCount = 1;
            gameState.location = "tavern";
            gameState.time = "night";
            gameState.quests.active.forEach(q => q.completed = false);
            gameState.quests.completed = [];
            gameState.hasReceivedStake = false;
            
            // Show main game UI
            document.getElementById('character-selection').style.display = 'none';
            document.getElementById('main-game').style.display = 'flex';
            
            // Update UI
            updateUI();
            bindActionButtons();
            
            // Initialize starting inventory
            initializeStartingInventory(character);
            
            // Show welcome message
            addToScene(`You awaken in the tavern as ${gameState.player.name}, ready to face the horrors ahead.`);
        }

        function initializeStartingInventory(character) {
            // Clear inventory except for fists
            gameState.inventory.weapons = gameState.inventory.weapons.filter(w => w.id === "fists");
            
            // Add character-specific items
            if (character === "jonathan") {
                addItemToInventory("silver-dagger");
            } else if (character === "vanhelsing") {
                addItemToInventory("holy-water");
                addItemToInventory("garlic");
            } else if (character === "mina") {
                addItemToInventory("occult-tome");
            }
            
            // Always add some health potions
            addItemToInventory("health-potion", 3);
        }

        function addItemToInventory(itemId, quantity = 1) {
            const itemTemplate = getItemTemplate(itemId);
            if (!itemTemplate) return;
            
            if (itemTemplate.damage) {
                // It's a weapon
                const exists = gameState.inventory.weapons.some(w => w.id === itemId);
                if (!exists) {
                    gameState.inventory.weapons.push({...itemTemplate});
                }
            } else {
                // It's an item
                const existingItem = gameState.inventory.items.find(i => i.id === itemId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    gameState.inventory.items.push({...itemTemplate, quantity});
                }
            }
        }

        function getItemTemplate(itemId) {
            // Check weapons
            const weaponTemplate = gameState.inventory.weapons.find(w => w.id === itemId);
            if (weaponTemplate) return {...weaponTemplate};
            
            // Check items
            const itemTemplate = gameState.inventory.items.find(i => i.id === itemId);
            if (itemTemplate) return {...itemTemplate};
            
            // Check merchant items
            const merchantTemplate = gameState.merchantItems.find(i => i.id === itemId);
            if (merchantTemplate) {
                const template = {...merchantTemplate};
                delete template.price;
                return template;
            }
            
            return null;
        }

        // ========== GAME FUNCTIONS ========== //
        function updateUI() {
            if (!gameState.player) return;
            
            // Update stats
            document.getElementById('current-hp').textContent = gameState.player.hp;
            document.getElementById('max-hp').textContent = gameState.player.maxHp;
            document.getElementById('current-sanity').textContent = gameState.player.sanity;
            document.getElementById('max-sanity').textContent = gameState.player.maxSanity;
            document.getElementById('player-level').textContent = gameState.player.level || 1;
            document.getElementById('day-count').textContent = gameState.dayCount || 1;
            document.getElementById('current-xp').textContent = gameState.player.xp || 0;
            document.getElementById('next-level-xp').textContent = gameState.player.nextLevelXp || 100;
            document.getElementById('player-gold').textContent = gameState.player.gold || 50;
            
            // Update time display with icon
            const timeElement = document.getElementById('game-time');
            timeElement.textContent = gameState.time.toUpperCase();
            timeElement.style.color = gameState.time === "night" ? "#f00" : "#ff0";
            timeElement.innerHTML = (gameState.time === "night" ? "☽ " : "☀ ") + timeElement.textContent;
            
            // Update health bars
            const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
            document.getElementById('player-health-fill').style.width = `${Math.max(0, playerHpPercent)}%`;
            
            // Update sanity bar
            const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
            document.getElementById('player-sanity-fill').style.width = `${Math.max(0, sanityPercent)}%`;
            
            // Update equipped weapon
            const weapon = gameState.inventory.weapons.find(w => w.id === gameState.player.equippedWeapon) || 
                         { name: "FISTS", damage: 2 };
            document.getElementById('equipped-weapon-name').textContent = weapon.name;
            document.getElementById('equipped-weapon-dmg').textContent = weapon.damage;
        }

        function bindActionButtons() {
            // Tavern actions
            document.getElementById('talk-barkeep').addEventListener('click', talkToBarkeep);
            document.getElementById('leave-tavern').addEventListener('click', leaveTavern);
            document.getElementById('visit-merchant').addEventListener('click', openMerchant);
            document.getElementById('rest').addEventListener('click', rest);
            
            // Modal buttons
            document.getElementById('inventory-button').addEventListener('click', openInventory);
            document.getElementById('character-button').addEventListener('click', openCharacter);
            document.getElementById('quests-button').addEventListener('click', openQuests);
            document.getElementById('map-button').addEventListener('click', openMap);
            document.getElementById('game-settings-button').addEventListener('click', openSettings);
            
            // Combat buttons
            document.getElementById('attack-button').addEventListener('click', playerAttack);
            document.getElementById('special-button').addEventListener('click', specialAttack);
            document.getElementById('use-item-button').addEventListener('click', useItemInCombat);
            document.getElementById('flee-button').addEventListener('click', attemptFlee);
            
            // Close buttons
            document.getElementById('close-inventory').addEventListener('click', hideAllModals);
            document.getElementById('close-character').addEventListener('click', hideAllModals);
            document.getElementById('close-quests').addEventListener('click', hideAllModals);
            document.getElementById('close-map').addEventListener('click', hideAllModals);
            document.getElementById('close-settings').addEventListener('click', hideAllModals);
            document.getElementById('close-merchant').addEventListener('click', hideAllModals);
            
            // Settings buttons
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('reset-game').addEventListener('click', resetGame);
            
            // Merchant buttons
            document.querySelectorAll('.buy-button').forEach(button => {
                button.addEventListener('click', buyItem);
            });
            
            // Game over buttons
            document.getElementById('try-again-button').addEventListener('click', tryAgain);
            document.getElementById('main-menu-button').addEventListener('click', returnToMainMenu);
            
            // Victory buttons
            document.getElementById('new-game-button').addEventListener('click', () => {
                hideAllModals();
                document.getElementById('main-game').style.display = 'none';
                document.getElementById('character-selection').style.display = 'flex';
            });
            
            document.getElementById('new-game-plus-button').addEventListener('click', () => {
                hideAllModals();
                const character = gameState.player.name.toLowerCase().includes("harker") ? "jonathan" : 
                                gameState.player.name.toLowerCase().includes("helsing") ? "vanhelsing" : "mina";
                startGame(character, true);
            });
        }

        // ========== LOCATION FUNCTIONS ========== //
        function talkToBarkeep() {
            const hasStake = gameState.inventory.weapons.some(w => w.id === "wooden-stake");
            
            if (!hasStake && !gameState.hasReceivedStake) {
                addToScene(`"You're mad to go up there," the barkeep says, wiping a glass.`);
                addToScene(`"But if you're set on it... Take this." He slides a WOODEN STAKE across the counter.`);
                addToScene(`<strong>Obtained WOODEN STAKE!</strong>`);
                
                // Add stake to inventory
                addItemToInventory("wooden-stake");
                gameState.hasReceivedStake = true;
                
                // Complete find stake quest if active
                completeQuest("find-stake");
            } else {
                addToScene(`"You still here? Don't say I didn't warn you about that castle," the barkeep mutters.`);
                addToScene(`"If you need supplies, talk to the merchant in the corner."`);
            }
        }

        function openMerchant() {
            // Update merchant gold display
            document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;
            
            // Update sell list
            const sellList = document.getElementById('merchant-sell-list');
            sellList.innerHTML = '';
            
            // Add weapons to sell (except fists)
            gameState.inventory.weapons.forEach(weapon => {
                if (weapon.id !== 'fists') {
                    const sellPrice = Math.floor((weapon.damage * 3) * (weapon.ammo ? 0.8 : 1)); // Base price on damage
                    const itemElement = document.createElement('div');
                    itemElement.className = 'merchant-item';
                    itemElement.dataset.id = weapon.id;
                    itemElement.dataset.price = sellPrice;
                    itemElement.innerHTML = `
                        <span class="tooltip">${weapon.name} (${weapon.damage} DMG${weapon.ammo ? `, ${weapon.ammo} shots` : ''})<span class="tooltiptext">${getItemDescription(weapon)}</span></span>
                        <span class="merchant-price">${sellPrice} GOLD</span>
                        <button class="sell-button">SELL</button>
                    `;
                    sellList.appendChild(itemElement);
                }
            });
            
            // Add items to sell
            gameState.inventory.items.forEach(item => {
                // Don't show items with 0 quantity
                if (item.quantity > 0) {
                    const sellPrice = Math.floor((item.heal || item.damage || 5) * 2); // Base price on effect
                    const itemElement = document.createElement('div');
                    itemElement.className = 'merchant-item';
                    itemElement.dataset.id = item.id;
                    itemElement.dataset.price = sellPrice;
                    itemElement.innerHTML = `
                        <span class="tooltip">${item.name} x${item.quantity}<span class="tooltiptext">${getItemDescription(item)}</span></span>
                        <span class="merchant-price">${sellPrice} GOLD</span>
                        <button class="sell-button">SELL</button>
                    `;
                    sellList.appendChild(itemElement);
                }
            });
            
            // Add event listeners to sell buttons
            document.querySelectorAll('.sell-button').forEach(button => {
                button.addEventListener('click', sellItem);
            });
            
            showModal(document.getElementById('merchant-modal'));
        }

        function getItemDescription(item) {
            let desc = '';
            if (item.heal) desc += `Restores ${item.heal} HP. `;
            if (item.damage) desc += `Deals ${item.damage} damage. `;
            if (item.sanity) desc += `Restores ${item.sanity} sanity. `;
            if (item.special === "holy") desc += `Effective against undead. `;
            if (item.special === "light") desc += `Illuminates dark areas. `;
            if (item.special === "silver") desc += `Effective against werewolves. `;
            if (item.special === "stake") desc += `Effective against vampires. `;
            if (item.special === "repel") desc += `Repels vampires. `;
            if (item.special === "knowledge") desc += `Grants occult knowledge. `;
            if (item.ammo) desc += `Comes with ${item.ammo} shots. `;
            return desc.trim();
        }

        function buyItem() {
            const itemId = this.parentElement.dataset.id;
            const price = parseInt(this.parentElement.dataset.price);
            
            if (gameState.player.gold >= price) {
                gameState.player.gold -= price;
                
                // Find the item template from merchant items
                const merchantItem = gameState.merchantItems.find(item => item.id === itemId);
                if (!merchantItem) return;
                
                // Create a copy of the item without the price property
                const itemToAdd = {...merchantItem};
                delete itemToAdd.price;
                
                // Add to inventory
                if (itemToAdd.damage) {
                    // It's a weapon
                    const exists = gameState.inventory.weapons.some(w => w.id === itemId);
                    if (!exists) {
                        gameState.inventory.weapons.push(itemToAdd);
                    }
                } else {
                    // It's an item
                    const existingItem = gameState.inventory.items.find(i => i.id === itemId);
                    if (existingItem) {
                        existingItem.quantity = (existingItem.quantity || 0) + 1;
                    } else {
                        gameState.inventory.items.push({...itemToAdd, quantity: 1});
                    }
                }
                
                updateUI();
                
                // Update merchant gold display
                document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;
                
                // Show message
                addToScene(`You bought a ${merchantItem.name} for ${price} gold.`);
                
                // Update inventory display if open
                if (document.getElementById('inventory-modal').style.display === 'block') {
                    openInventory();
                }
            } else {
                addToScene("Not enough gold!");
            }
        }

        function sellItem() {
            const itemId = this.parentElement.dataset.id;
            const price = parseInt(this.parentElement.dataset.price);
            
            // Check if it's a weapon
            const weaponIndex = gameState.inventory.weapons.findIndex(w => w.id === itemId);
            if (weaponIndex !== -1) {
                // Don't sell equipped weapon
                if (gameState.player.equippedWeapon === itemId) {
                    addToScene(`You can't sell your equipped weapon!`);
                    return;
                }
                
                gameState.inventory.weapons.splice(weaponIndex, 1);
                gameState.player.gold += price;
                updateUI();
                document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;
                
                const item = getItemTemplate(itemId);
                addToScene(`You sold your ${item.name} for ${price} gold.`);
                
                // Update sell list
                openMerchant();
                return;
            }
            
            // Check if it's an item
            const item = gameState.inventory.items.find(i => i.id === itemId);
            if (item) {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    gameState.inventory.items = gameState.inventory.items.filter(i => i.id !== itemId);
                }
                
                gameState.player.gold += price;
                updateUI();
                document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;
                addToScene(`You sold a ${item.name} for ${price} gold.`);
                
                // Update sell list
                openMerchant();
            }
        }

        function leaveTavern() {
            moveToLocation("mountain-path");
            
            // Random encounter chance
            if (Math.random() < 0.6) {
                setTimeout(() => {
                    const enemyTypes = ["vampire-spawn", "ghoul", "shadow"];
                    const weights = [0.5, 0.3, 0.2]; // Higher chance for weaker enemies
                    let random = Math.random();
                    let enemyType;
                    
                    if (random < weights[0]) {
                        enemyType = enemyTypes[0];
                    } else if (random < weights[0] + weights[1]) {
                        enemyType = enemyTypes[1];
                    } else {
                        enemyType = enemyTypes[2];
                    }
                    
                    startCombat(enemyType);
                }, 1000);
            }
        }

        function moveToLocation(locationId) {
            const location = gameState.locations[locationId];
            if (!location) return;
            
            gameState.location = locationId;
            location.visited = true;
            
            // Update scene description
            clearScene();
            addToScene(location.description);
            
            // Update action buttons based on location
            updateLocationActions(locationId);
            
            // Update map display
            updateMap();
        }

        function updateLocationActions(locationId) {
            const actions = document.getElementById('action-buttons');
            
            switch(locationId) {
                case "tavern":
                    actions.innerHTML = `
                        <button id="talk-barkeep">TALK</button>
                        <button id="leave-tavern">LEAVE</button>
                        <button id="visit-merchant">MERCHANT</button>
                        <button id="rest">REST</button>
                    `;
                    // Rebind buttons
                    document.getElementById('talk-barkeep').addEventListener('click', talkToBarkeep);
                    document.getElementById('leave-tavern').addEventListener('click', leaveTavern);
                    document.getElementById('visit-merchant').addEventListener('click', openMerchant);
                    document.getElementById('rest').addEventListener('click', rest);
                    break;
                    
                case "mountain-path":
                    actions.innerHTML = `
                        <button id="continue-climb">CONTINUE</button>
                        <button id="search-path">SEARCH</button>
                        <button id="return-tavern">RETURN</button>
                    `;
                    // Rebind buttons
                    document.getElementById('continue-climb').addEventListener('click', () => moveToLocation("castle-gates"));
                    document.getElementById('search-path').addEventListener('click', searchPath);
                    document.getElementById('return-tavern').addEventListener('click', () => moveToLocation("tavern"));
                    break;
                    
                case "castle-gates":
                    actions.innerHTML = `
                        <button id="enter-courtyard">ENTER</button>
                        <button id="search-gates">SEARCH</button>
                        <button id="leave-castle">LEAVE</button>
                    `;
                    // Rebind buttons
                    document.getElementById('enter-courtyard').addEventListener('click', () => moveToLocation("castle-courtyard"));
                    document.getElementById('search-gates').addEventListener('click', searchCastle);
                    document.getElementById('leave-castle').addEventListener('click', () => moveToLocation("mountain-path"));
                    break;
                    
                case "castle-courtyard":
                    actions.innerHTML = `
                        <button id="enter-hall">ENTER HALL</button>
                        <button id="search-courtyard">SEARCH</button>
                        <button id="retreat-gates">RETREAT</button>
                    `;
                    // Rebind buttons
                    document.getElementById('enter-hall').addEventListener('click', () => moveToLocation("castle-hall"));
                    document.getElementById('search-courtyard').addEventListener('click', searchCastle);
                    document.getElementById('retreat-gates').addEventListener('click', () => moveToLocation("castle-gates"));
                    break;
                    
                case "castle-hall":
                    actions.innerHTML = `
                        <button id="enter-throne">CONFRONT</button>
                        <button id="search-hall">SEARCH</button>
                        <button id="retreat-courtyard">RETREAT</button>
                    `;
                    // Rebind buttons
                    document.getElementById('enter-throne').addEventListener('click', () => moveToLocation("throne-room"));
                    document.getElementById('search-hall').addEventListener('click', searchCastle);
                    document.getElementById('retreat-courtyard').addEventListener('click', () => moveToLocation("castle-courtyard"));
                    break;
                    
                case "throne-room":
                    actions.innerHTML = `
                        <button id="fight-dracula">FIGHT</button>
                        <button id="search-throne">SEARCH</button>
                        <button id="flee-throne">FLEE</button>
                    `;
                    // Rebind buttons
                    document.getElementById('fight-dracula').addEventListener('click', confrontDracula);
                    document.getElementById('search-throne').addEventListener('click', searchCastle);
                    document.getElementById('flee-throne').addEventListener('click', () => moveToLocation("castle-hall"));
                    break;
            }
        }

        function confrontDracula() {
            startCombat("dracula");
        }

        // ========== COMBAT FUNCTIONS ========== //
        function startCombat(enemyType) {
            gameState.inCombat = true;
            gameState.currentEnemy = JSON.parse(JSON.stringify(gameState.enemies[enemyType]));
            
            // Apply night bonus if applicable
            if (gameState.currentEnemy.nightBonus && gameState.time === "night") {
                gameState.currentEnemy.damage = Math.floor(gameState.currentEnemy.damage * 1.2);
                gameState.currentEnemy.hp = Math.floor(gameState.currentEnemy.hp * 1.2);
                gameState.currentEnemy.maxHp = gameState.currentEnemy.hp;
            }
            
            // Update combat UI
            document.getElementById('combat-title').textContent = `COMBAT: ${gameState.currentEnemy.name}`;
            document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
            document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
            document.getElementById('enemy-max-hp').textContent = gameState.currentEnemy.maxHp;
            document.getElementById('enemy-hp-bar').style.width = '100%';
            
            // Update player stats in combat modal
            document.getElementById('player-name').textContent = gameState.player.name;
            document.getElementById('player-hp-combat').textContent = gameState.player.hp;
            document.getElementById('player-max-hp-combat').textContent = gameState.player.maxHp;
            document.getElementById('player-hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            document.getElementById('player-sanity-combat').textContent = gameState.player.sanity;
            document.getElementById('player-max-sanity-combat').textContent = gameState.player.maxSanity;
            document.getElementById('player-sanity-bar').style.width = `${(gameState.player.sanity / gameState.player.maxSanity) * 100}%`;
            
            // Set combat log
            const combatLog = document.getElementById('combat-log-modal');
            combatLog.innerHTML = `<p>A ${gameState.currentEnemy.name} ATTACKS!</p>`;
            
            // Show combat modal
            showModal(document.getElementById('combat-modal'));
        }

        function playerAttack() {
            if (!gameState.inCombat) return;
            
            const combatLog = document.getElementById('combat-log-modal');
            const weapon = gameState.inventory.weapons.find(w => w.id === gameState.player.equippedWeapon) || 
                         { name: "FISTS", damage: 2 };
            
            // Check for ammo if it's a ranged weapon
            if (weapon.ammo !== undefined) {
                if (weapon.ammo <= 0) {
                    combatLog.innerHTML += `<p>OUT OF AMMO FOR ${weapon.name}!</p>`;
                    scrollCombatLog();
                    return;
                }
                weapon.ammo--;
            }
            
            // Calculate base damage
            let damage = weapon.damage + Math.floor(gameState.player.strength / 2);
            
            // Add random variation
            damage = Math.floor(damage * (0.8 + Math.random() * 0.4));
            
            // Check for weapon special effects
            if (weapon.special && gameState.currentEnemy.weakness.includes(weapon.special)) {
                damage = Math.floor(damage * 1.5);
                combatLog.innerHTML += `<p>${weapon.name} IS EFFECTIVE!</p>`;
            }
            
            // Apply damage
            gameState.currentEnemy.hp -= damage;
            
            // Update UI
            const hpPercent = (gameState.currentEnemy.hp / gameState.currentEnemy.maxHp) * 100;
            document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
            document.getElementById('enemy-hp-bar').style.width = `${Math.max(0, hpPercent)}%`;
            
            // Add combat animation if enabled
            if (gameState.settings.combatAnimations) {
                document.getElementById('enemy-display').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('enemy-display').classList.remove('shake');
                }, 400);
            }
            
            combatLog.innerHTML += `<p>YOU HIT FOR ${damage} DAMAGE!${weapon.ammo !== undefined ? ` (${weapon.ammo} shots left)` : ''}</p>`;
            scrollCombatLog();
            
            // Check if enemy is defeated
            if (gameState.currentEnemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy counterattack
            setTimeout(() => {
                enemyAttack();
            }, 1000);
        }

        function enemyAttack() {
            if (!gameState.inCombat) return;
            
            const combatLog = document.getElementById('combat-log-modal');
            const enemy = gameState.currentEnemy;
            
            // Check if enemy is charmed (Mina's ability)
            if (enemy.charmed) {
                combatLog.innerHTML += `<p>${enemy.name} IS STILL DAZED BY HYPNOSIS!</p>`;
                enemy.charmed = false;
                scrollCombatLog();
                return;
            }
            
            // Calculate damage
            let damage = enemy.damage;
            
            // Add random variation
            damage = Math.floor(damage * (0.8 + Math.random() * 0.4));
            
            // Apply special attacks
            if (enemy.special === "charm" && Math.random() < 0.3) {
                combatLog.innerHTML += `<p>${enemy.name} CHARMS YOU! YOU CAN'T ATTACK NEXT TURN!</p>`;
                scrollCombatLog();
                return;
            } else if (enemy.special === "transform" && enemy.hp < enemy.maxHp / 2) {
                if (!enemy.transformed) {
                    enemy.transformed = true;
                    enemy.damage += 5;
                    combatLog.innerHTML += `<p>${enemy.name} TRANSFORMS! ATTACK INCREASED!</p>`;
                    scrollCombatLog();
                }
            } else if (enemy.special === "fear") {
                const sanityLoss = Math.floor(Math.random() * 10) + 5;
                gameState.player.sanity = Math.max(0, gameState.player.sanity - sanityLoss);
                combatLog.innerHTML += `<p>The SHADOW'S presence chills your soul! -${sanityLoss} SANITY</p>`;
                updateUI();
                
                if (gameState.player.sanity <= 0) {
                    combatLog.innerHTML += `<p>YOU LOSE YOUR MIND!</p>`;
                    playerDefeated();
                    return;
                }
            }
            
            // Apply damage
            gameState.player.hp -= damage;
            updateUI();
            
            // Update player health bar in combat modal
            document.getElementById('player-hp-combat').textContent = gameState.player.hp;
            document.getElementById('player-hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
            
            // Add combat animation if enabled
            if (gameState.settings.combatAnimations) {
                document.getElementById('player-display').classList.add('flash-red');
                setTimeout(() => {
                    document.getElementById('player-display').classList.remove('flash-red');
                }, 300);
            }
            
            combatLog.innerHTML += `<p>${enemy.name} HITS YOU FOR ${damage} DAMAGE!</p>`;
            scrollCombatLog();
            
            // Check if player is defeated
            if (gameState.player.hp <= 0) {
                playerDefeated();
            }
        }

        function enemyDefeated() {
            const combatLog = document.getElementById('combat-log-modal');
            const enemy = gameState.currentEnemy;
            
            // Award XP and gold
            gameState.player.xp += enemy.xp;
            gameState.player.gold += enemy.gold;
            gameState.enemiesDefeated++;
            
            combatLog.innerHTML += `
                <p>${enemy.name} DEFEATED!</p>
                <p>+${enemy.xp} XP | +${enemy.gold} GOLD</p>
            `;
            scrollCombatLog();
            
            // Check for level up
            checkLevelUp();
            
            // End combat after delay
            setTimeout(() => {
                hideAllModals();
                gameState.inCombat = false;
                
                // If Dracula was defeated, end game
                if (enemy.name === "COUNT DRACULA") {
                    completeQuest("slay-dracula");
                    endGame(true);
                }
            }, 1500);
        }

        function checkLevelUp() {
            if (gameState.player.xp >= gameState.player.nextLevelXp) {
                gameState.player.level++;
                gameState.player.xp -= gameState.player.nextLevelXp;
                gameState.player.nextLevelXp = Math.floor(gameState.player.nextLevelXp * 1.5);
                
                // Increase stats
                gameState.player.maxHp += 10;
                gameState.player.hp = gameState.player.maxHp;
                gameState.player.maxSanity += 5;
                gameState.player.sanity = gameState.player.maxSanity;
                gameState.player.strength += 1;
                gameState.player.agility += 1;
                gameState.player.intelligence += 1;
                gameState.player.faith += 1;
                
                // Update UI
                updateUI();
                
                // Show level up message
                addToScene(`You leveled up to level ${gameState.player.level}! Your abilities improve.`);
            }
        }

        function playerDefeated() {
            const combatLog = document.getElementById('combat-log-modal');
            
            combatLog.innerHTML += `
                <p>YOU HAVE BEEN DEFEATED!</p>
            `;
            scrollCombatLog();
            
            // Show game over modal
            setTimeout(() => {
                hideAllModals();
                document.getElementById('game-over-text').textContent = 
                    `You were defeated by ${gameState.currentEnemy.name}!`;
                showModal(document.getElementById('game-over-modal'));
            }, 1500);
        }

        function tryAgain() {
            hideAllModals();
            gameState.inCombat = false;
            
            // Penalty for defeat
            gameState.player.hp = Math.floor(gameState.player.maxHp / 2);
            gameState.player.sanity = Math.floor(gameState.player.maxSanity / 2);
            gameState.player.gold = Math.max(0, gameState.player.gold - 20);
            
            // Return to tavern
            moveToLocation("tavern");
            addToScene("You wake up in the tavern, your wounds bandaged.");
            addToScene(`The barkeep shakes his head. "Told you not to go up there..."`);
            
            updateUI();
        }

        function returnToMainMenu() {
            hideAllModals();
            document.getElementById('main-game').style.display = 'none';
            document.getElementById('character-selection').style.display = 'flex';
        }

        // ========== QUEST FUNCTIONS ========== //
        function completeQuest(questId) {
            const questIndex = gameState.quests.active.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.quests.active[questIndex];
            quest.completed = true;
            gameState.quests.active.splice(questIndex, 1);
            gameState.quests.completed.push(quest);
            
            // Show completion message
            addToScene(`<strong>Quest Completed: ${quest.title}</strong>`);
            
            // Update quests UI
            updateQuestsUI();
        }

        function updateQuestsUI() {
            const activeQuestsDiv = document.getElementById('active-quests');
            const completedQuestsDiv = document.getElementById('completed-quests');
            
            // Clear existing quests
            activeQuestsDiv.innerHTML = '';
            completedQuestsDiv.innerHTML = '';
            
            // Add active quests
            gameState.quests.active.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = 'quest-item';
                questElement.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-status">(Active)</div>
                `;
                activeQuestsDiv.appendChild(questElement);
            });
            
            // Add completed quests
            gameState.quests.completed.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = 'quest-item quest-completed';
                questElement.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-status">(Completed)</div>
                `;
                completedQuestsDiv.appendChild(questElement);
            });
        }

        // ========== INVENTORY FUNCTIONS ========== //
        function openInventory() {
            const weaponsList = document.getElementById('weapons-list');
            const itemsList = document.getElementById('items-list');
            const questItemsList = document.getElementById('quest-items-list');
            
            // Clear existing items
            weaponsList.innerHTML = '';
            itemsList.innerHTML = '';
            questItemsList.innerHTML = '';
            
            // Add fists (always available)
            weaponsList.innerHTML = `
                <div class="item-row" data-id="fists" data-dmg="2">
                    <span>FISTS (2 DMG)</span>
                    <button class="equip-button">EQUIP</button>
                </div>
            `;
            
            // Add other weapons
            gameState.inventory.weapons.forEach(weapon => {
                if (weapon.id !== 'fists') {
                    weaponsList.innerHTML += `
                        <div class="item-row" data-id="${weapon.id}">
                            <span>${weapon.name} (${weapon.damage} DMG${weapon.special ? `, ${weapon.special.toUpperCase()}` : ''}${weapon.ammo !== undefined ? `, ${weapon.ammo} shots` : ''})</span>
                            <button class="equip-button">EQUIP</button>
                        </div>
                    `;
                }
            });
            
            // Add items
            gameState.inventory.items.forEach(item => {
                itemsList.innerHTML += `
                    <div class="item-row" data-id="${item.id}">
                        <span>${item.name}${item.heal ? ` (+${item.heal} HP)` : ''}${item.sanity ? ` (+${item.sanity} SAN)` : ''}${item.damage ? ` (${item.damage} DMG)` : ''}${item.special ? ` (${item.special.toUpperCase()})` : ''} x${item.quantity}</span>
                        <button class="use-button">USE</button>
                    </div>
                `;
            });
            
            // Add quest items
            gameState.inventory.questItems.forEach(item => {
                questItemsList.innerHTML += `
                    <div class="item-row" data-id="${item.id}">
                        <span>${item.name}</span>
                    </div>
                `;
            });
            
            // Add event listeners
            document.querySelectorAll('.equip-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const weaponId = this.parentElement.dataset.id;
                    gameState.player.equippedWeapon = weaponId;
                    updateUI();
                    hideAllModals();
                });
            });
            
            document.querySelectorAll('.use-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.parentElement.dataset.id;
                    useItem(itemId);
                });
            });
            
            showModal(document.getElementById('inventory-modal'));
        }

        function useItem(itemId) {
            const item = gameState.inventory.items.find(i => i.id === itemId);
            if (!item) return;
            
            if (item.heal) {
                // Healing item
                const healAmount = Math.min(item.heal, gameState.player.maxHp - gameState.player.hp);
                gameState.player.hp += healAmount;
                item.quantity--;
                
                if (item.quantity <= 0) {
                    gameState.inventory.items = gameState.inventory.items.filter(i => i.id !== itemId);
                }
                
                updateUI();
                addToScene(`You used a ${item.name} and recovered ${healAmount} HP.`);
                hideAllModals();
            } 
            else if (item.sanity) {
                // Sanity restoration item
                const sanityAmount = Math.min(item.sanity, gameState.player.maxSanity - gameState.player.sanity);
                gameState.player.sanity += sanityAmount;
                item.quantity--;
                
                if (item.quantity <= 0) {
                    gameState.inventory.items = gameState.inventory.items.filter(i => i.id !== itemId);
                }
                
                updateUI();
                addToScene(`You used a ${item.name} and recovered ${sanityAmount} sanity.`);
                hideAllModals();
            }
            else if (item.usable) {
                // Other usable item
                addToScene(`You used the ${item.name}.`);
                item.quantity--;
                
                if (item.quantity <= 0) {
                    gameState.inventory.items = gameState.inventory.items.filter(i => i.id !== itemId);
                }
                
                // Special effects for new items
                if (item.special === "light") {
                    addToScene("The lantern illuminates the dark area around you.");
                } else if (item.special === "holy") {
                    addToScene("The holy item glows with divine energy.");
                }
                
                hideAllModals();
            }
        }

        // ========== CHARACTER FUNCTIONS ========== //
        function openCharacter() {
            if (!gameState.player) return;
            
            document.getElementById('character-name').textContent = gameState.player.name;
            document.getElementById('character-class').textContent = gameState.player.class;
            document.getElementById('character-level').textContent = gameState.player.level;
            document.getElementById('character-next-level').textContent = `${gameState.player.nextLevelXp - gameState.player.xp} XP needed`;
            
            document.getElementById('character-strength').textContent = gameState.player.strength;
            document.getElementById('character-agility').textContent = gameState.player.agility;
            document.getElementById('character-intelligence').textContent = gameState.player.intelligence;
            document.getElementById('character-faith').textContent = gameState.player.faith;
            
            const skillsDiv = document.getElementById('character-skills');
            skillsDiv.innerHTML = '';
            gameState.player.skills.forEach(skill => {
                skillsDiv.innerHTML += `<p>${skill}</p>`;
            });
            
            showModal(document.getElementById('character-modal'));
        }

        function openQuests() {
            updateQuestsUI();
            showModal(document.getElementById('quests-modal'));
        }

        // ========== MAP FUNCTIONS ========== //
        function openMap() {
            updateMap();
            showModal(document.getElementById('map-modal'));
        }

        function updateMap() {
            const mapDisplay = document.getElementById('map-display');
            let mapText = '';
            
            // Simple ASCII map based on locations
            mapText += `\n          [CASTLE]\n`;
            mapText += `            ^\n`;
            mapText += `            |\n`;
            mapText += `[TAVERN] -- PATH -- GATES -- COURTYARD -- HALL -- THRONE\n`;
            
            // Mark current location
            const locationName = gameState.locations[gameState.location].name.split(' ')[0];
            mapText = mapText.replace(locationName, `X`);
            
            mapDisplay.textContent = mapText;
        }

        // ========== SETTINGS FUNCTIONS ========== //
        function openSettings() {
            // Load current settings
            document.getElementById('text-speed').value = gameState.settings.textSpeed;
            document.getElementById('combat-animations').checked = gameState.settings.combatAnimations;
            document.getElementById('sound-effects').checked = gameState.settings.soundEffects;
            document.getElementById('music').checked = gameState.settings.music;
            
            showModal(document.getElementById('settings-modal'));
        }

        function saveSettings() {
            // Save settings
            gameState.settings.textSpeed = document.getElementById('text-speed').value;
            gameState.settings.combatAnimations = document.getElementById('combat-animations').checked;
            gameState.settings.soundEffects = document.getElementById('sound-effects').checked;
            gameState.settings.music = document.getElementById('music').checked;
            
            hideAllModals();
            addToScene("Settings saved.");
        }

        function resetGame() {
            if (confirm("Are you sure you want to reset the game? All progress will be lost.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // ========== UTILITY FUNCTIONS ========== //
        function showModal(modal) {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            modal.style.display = 'block';
        }

        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        function endGame(victory) {
            if (victory) {
                document.getElementById('victory-level').textContent = gameState.player.level;
                document.getElementById('victory-gold').textContent = gameState.player.gold;
                document.getElementById('victory-enemies').textContent = gameState.enemiesDefeated;
                
                // Show New Game+ button if not already in NG+
                document.getElementById('new-game-plus-button').style.display = 
                    gameState.newGamePlus ? 'none' : 'block';
                
                showModal(document.getElementById('victory-modal'));
            } else {
                showModal(document.getElementById('game-over-modal'));
            }
        }

        function addToScene(text) {
            const scene = document.getElementById('scene-description');
            const p = document.createElement('p');
            p.innerHTML = text;
            scene.appendChild(p);
            scene.scrollTop = scene.scrollHeight;
        }

        function clearScene() {
            document.getElementById('scene-description').innerHTML = '';
        }

        function scrollCombatLog() {
            const log = document.getElementById('combat-log-modal');
            log.scrollTop = log.scrollHeight;
        }

        function searchPath() {
            const foundGold = Math.floor(Math.random() * 20) + 5;
            gameState.player.gold += foundGold;
            updateUI();
            addToScene(`You find ${foundGold} gold along the path!`);
        }

        function searchCastle() {
            if (Math.random() < 0.7) {
                const enemyTypes = ["vampire-spawn", "brides", "werewolf", "ghoul", "shadow"];
                const weights = [0.4, 0.2, 0.2, 0.1, 0.1]; // Higher chance for weaker enemies
                let random = Math.random();
                let enemyType;
                
                if (random < weights[0]) {
                    enemyType = enemyTypes[0];
                } else if (random < weights[0] + weights[1]) {
                    enemyType = enemyTypes[1];
                } else if (random < weights[0] + weights[1] + weights[2]) {
                    enemyType = enemyTypes[2];
                } else if (random < weights[0] + weights[1] + weights[2] + weights[3]) {
                    enemyType = enemyTypes[3];
                } else {
                    enemyType = enemyTypes[4];
                }
                
                startCombat(enemyType);
            } else {
                const possibleItems = [
                    {id: "health-potion", chance: 0.6},
                    {id: "holy-water", chance: 0.3},
                    {id: "garlic", chance: 0.5},
                    {id: "rope", chance: 0.2},
                    {id: "silver-cross", chance: 0.1},
                    {id: "bible", chance: 0.1},
                    {id: "sanity-potion", chance: 0.2},
                    {id: "torch", chance: 0.3}
                ];
                
                const foundItems = possibleItems.filter(item => Math.random() < item.chance);
                
                if (foundItems.length > 0) {
                    const item = foundItems[Math.floor(Math.random() * foundItems.length)];
                    addItemToInventory(item.id);
                    addToScene(`You find a ${getItemTemplate(item.id).name}!`);
                } else {
                    addToScene("You search but find nothing of value.");
                }
            }
        }

        function rest() {
            if (gameState.time === "night") {
                gameState.time = "day";
                gameState.dayCount++;
                addToScene("You rest until morning. Enemies are weaker during the day.");
            } else {
                gameState.time = "night";
                addToScene("You rest until nightfall. Enemies are stronger at night.");
            }
            
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.sanity = Math.min(gameState.player.maxSanity, gameState.player.sanity + 30);
            updateUI();
            addToScene("You feel fully rested.");
        }

        function useItemInCombat() {
            openInventory();
        }

        function specialAttack() {
            if (!gameState.inCombat) return;
            
            const combatLog = document.getElementById('combat-log-modal');
            
            // Check character class for special ability
            if (gameState.player.class === "DIPLOMAT") {
                // Jonathan's Silver Strike
                const silverDagger = gameState.inventory.weapons.find(w => w.id === "silver-dagger");
                if (silverDagger) {
                    let damage = silverDagger.damage * 2;
                    if (gameState.currentEnemy.weakness.includes("silver")) {
                        damage = Math.floor(damage * 1.5);
                        combatLog.innerHTML += `<p>SILVER STRIKE IS SUPER EFFECTIVE!</p>`;
                    }
                    
                    gameState.currentEnemy.hp -= damage;
                    
                    // Update UI
                    const hpPercent = (gameState.currentEnemy.hp / gameState.currentEnemy.maxHp) * 100;
                    document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
                    document.getElementById('enemy-hp-bar').style.width = `${Math.max(0, hpPercent)}%`;
                    
                    combatLog.innerHTML += `<p>SILVER STRIKE HITS FOR ${damage} DAMAGE!</p>`;
                }
            } 
            else if (gameState.player.class === "PROFESSOR") {
                // Van Helsing's Holy Water
                const holyWater = gameState.inventory.items.find(i => i.id === "holy-water");
                if (holyWater && holyWater.quantity > 0) {
                    holyWater.quantity--;
                    let damage = holyWater.damage;
                    
                    if (gameState.currentEnemy.weakness.includes("holy")) {
                        damage = Math.floor(damage * 2);
                        combatLog.innerHTML += `<p>HOLY WATER BURNS THE ENEMY!</p>`;
                    }
                    
                    gameState.currentEnemy.hp -= damage;
                    
                    // Update UI
                    const hpPercent = (gameState.currentEnemy.hp / gameState.currentEnemy.maxHp) * 100;
                    document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
                    document.getElementById('enemy-hp-bar').style.width = `${Math.max(0, hpPercent)}%`;
                    
                    combatLog.innerHTML += `<p>HOLY WATER DOES ${damage} DAMAGE!</p>`;
                } else {
                    combatLog.innerHTML += `<p>NO HOLY WATER LEFT!</p>`;
                }
            }
            else if (gameState.player.class === "OCCULTIST") {
                // Mina's Hypnosis
                if (Math.random() < 0.6) {
                    combatLog.innerHTML += `<p>YOU HYPNOTIZE THE ENEMY! THEY MISS THEIR NEXT ATTACK!</p>`;
                    gameState.currentEnemy.charmed = true;
                    scrollCombatLog();
                    return;
                } else {
                    combatLog.innerHTML += `<p>HYPNOSIS FAILED!</p>`;
                }
            }
            
            // Check if enemy is defeated
            if (gameState.currentEnemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy counterattack
            setTimeout(() => {
                enemyAttack();
            }, 800);
        }

        function attemptFlee() {
            if (!gameState.inCombat) return;
            
            const combatLog = document.getElementById('combat-log-modal');
            const fleeChance = 0.6 + (gameState.player.agility / 20);
            
            if (Math.random() < fleeChance) {
                combatLog.innerHTML += `<p>YOU SUCCESSFULLY FLEE!</p>`;
                setTimeout(() => {
                    hideAllModals();
                    gameState.inCombat = false;
                    document.getElementById('scene-description').style.display = 'block';
                    document.getElementById('combat-log').style.display = 'none';
                }, 1000);
            } else {
                combatLog.innerHTML += `<p>YOU FAIL TO FLEE!</p>`;
                enemyAttack();
            }
        }
    </script>
</body>
</html>
