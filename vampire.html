<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DRACULA'S CURSE</title>
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
touch-action: manipulation;
font-family: 'Arial', monospace;
font-size: 10px;
line-height: 1.3;
}

html, body {
background-color: #000 !important;
height: 100%;
margin: 0;
padding: 5;
overflow: hidden;
}

body {
background-color: #000 !important;
color: red;
height: 100vh;
overflow: hidden;
position: relative;
display: flex;
flex-direction: column;
padding: 100px;
}

#game-container {
flex: 1;
display: flex;
flex-direction: column;
gap: 10px;
width: 100%;
max-width: 100%;
padding: 5px;
background-color: #000 !important;
}

/* Stats Bar */
#stats-bar {
display: flex;
flex-direction: column;
align-items: top;
gap: 1px;
margin-bottom: 0px;
}

.stat-row {
display: flex;
justify-content: center;
gap: 80px;
width: 100%;
}

.stat-group {
display: flex;
flex-direction: column;
align-items: center;
min-width: 100px;
}

/* Main Content Area */
#content-area {
flex: 1;
display: flex;
flex-direction: column;
max-width: 600px;
width: 100%;
margin: 0 auto;
gap: 1px;
}

#dungeon-level {
text-align: center;
font-weight: bold;
margin-bottom: 3px;
}

#scene-description {
flex: 1;
overflow-y: auto;
border: 1px solid #ff0000;
padding: 5px;
min-height: 150px;
}

#combat-log {
flex: 1;
overflow-y: auto;
border: 1px solid #ff0000;
padding: 8px;
min-height: 60px;
display: none;
}

/* Action Buttons */
#action-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 5px;
margin-bottom: 5px;
}

#footer-buttons {
display: grid;
grid-template-columns: 1fr 1fr 1fr 1fr;
gap: 5px;
}

button {
background-color: #000;
color: #ff0000;
border: 1px solid #ff0000;
padding: 10px 4px;
cursor: pointer;
text-align: center;
transition: all 0.2s;
}

button:active {
background-color: #ff0000;
color: #000;
}

button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

button:hover:not(:disabled) {
background-color: #300;
}

/* Health and Sanity Bars */
.health-bar {
height: 5px;
background-color: #300;
width: 100%;
position: relative;
overflow: hidden;
}

.health-fill {
height: 100%;
background-color: #f00;
width: 100%;
transition: width 0.3s ease;
}

.sanity-meter {
height: 5px;
background-color: #030;
width: 100%;
position: relative;
overflow: hidden;
}

.sanity-fill {
height: 100%;
background-color: #0f0;
width: 100%;
transition: width 0.3s ease;
}

/* Progress Bar */
.progress-container {
width: 100%;
background-color: #300;
margin: 3px 0;
position: relative;
overflow: hidden;
}

.progress-bar {
height: 5px;
background-color: #f00;
width: 0%;
transition: width 0.3s ease;
}

/* Character Select Screen */
#character-selection {
display: flex;
flex-direction: column;
gap: 8px;
padding: 5px;
}

.character-select {
border: 1px solid #ff0000;
padding: 8px;
cursor: pointer;
transition: all 0.2s;
}

.character-select:hover {
background-color: #300;
}

.character-select:active {
background-color: #ff0000;
color: #000;
}

/* Modals */
.modal {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: rgba(0, 0, 0, 0.9);
padding: 10px;
display: none;
z-index: 100;
overflow-y: auto;
}

.modal-content {
border: 1px solid #ff0000;
padding: 8px;
height: 100%;
display: flex;
flex-direction: column;
}

.modal-header {
display: flex;
justify-content: space-between;
margin-bottom: 8px;
border-bottom: 1px solid #ff0000;
padding-bottom: 5px;
}

.modal-body {
flex: 1;
overflow-y: auto;
}

/* Inventory Items */
.item-row {
display: flex;
justify-content: space-between;
padding: 4px 0;
border-bottom: 1px dashed #ff0000;
align-items: center;
}

/* Combat UI */
#enemy-display {
border: 1px solid #ff0000;
padding: 8px;
margin-bottom: 5px;
position: relative;
}

/* Animation Classes */
@keyframes shake {
0%, 100% { transform: translateX(0); }
20%, 60% { transform: translateX(-5px); }
40%, 80% { transform: translateX(5px); }
}

.shake {
animation: shake 0.4s ease-in-out;
}

@keyframes flash-red {
0%, 100% { background-color: #000; }
50% { background-color: #f00; }
}

.flash-red {
animation: flash-red 0.3s ease-in-out;
}

@keyframes pulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

.pulse {
animation: pulse 0.3s ease-in-out;
}

/* Character Stats Modal */
.stat-row {
display: flex;
justify-content: space-between;
padding: 3px 0;
}

/* Quests Modal */
.quest-item {
padding: 5px 0;
border-bottom: 1px dashed #ff0000;
}

.quest-title {
font-weight: bold;
}

.quest-completed {
color: #0f0;
}

/* Map Modal */
#map-display {
font-family: monospace;
white-space: pre;
line-height: 1;
font-size: 12px;
}

/* Settings Modal */
#settings-content {
display: flex;
flex-direction: column;
gap: 10px;
}

.setting-option {
display: flex;
justify-content: space-between;
align-items: center;
}

/* New Game+ Button */
#new-game-plus {
background-color: #300;
border-color: #f00;
margin-top: 10px;
}

.close-modal {
background: none;
border: none;
color: #ff0000;
font-size: 16px;
cursor: pointer;
padding: 0 5px;
transition: all 0.2s;
}

.close-modal:hover {
transform: scale(1.2);
}

/* Merchant Modal */
.merchant-item {
display: flex;
justify-content: space-between;
padding: 5px 0;
border-bottom: 1px dashed #ff0000;
align-items: center;
}

.merchant-price {
color: #ff0;
}

/* New Styles */
.blood-drip {
position: relative;
text-shadow: 0 0 5px #f00;
}

.blood-drip::after {
content: "";
position: absolute;
bottom: -5px;
left: 50%;
width: 2px;
height: 15px;
background: linear-gradient(to bottom, #f00, transparent);
animation: drip 3s infinite;
}

@keyframes drip {
0%, 100% { height: 0; opacity: 0; }
50% { height: 15px; opacity: 1; }
}

.candle-flicker {
animation: flicker 5s infinite alternate;
}

@keyframes flicker {
0%, 100% { opacity: 0.8; }
25%, 75% { opacity: 1; }
50% { opacity: 0.6; }
}

.tooltip {
position: relative;
display: inline-block;
}

.tooltip .tooltiptext {
visibility: hidden;
width: 200px;
background-color: #300;
color: #fff;
text-align: center;
border-radius: 6px;
padding: 5px;
position: absolute;
z-index: 1;
bottom: 125%;
left: 50%;
transform: translateX(-50%);
opacity: 0;
transition: opacity 0.3s;
border: 1px solid #f00;
}

.tooltip:hover .tooltiptext {
visibility: visible;
opacity: 1;
}

.text-center {
text-align: center;
}

.mt-1 {
margin-top: 10px;
}

.level-up {
color: #ff0;
font-weight: bold;
}

/* Critical hit animation */
@keyframes critical {
0%, 100% { color: red; text-shadow: 0 0 5px red; }
50% { color: yellow; text-shadow: 0 0 10px yellow; }
}

.critical {
animation: critical 0.5s ease-in-out;
}

/* Mobile Portrait Specific Styles */
@media (orientation: portrait) {
#game-container {
padding: 2px;
gap: 5px;
}

#stats-bar {
flex-direction: row;
flex-wrap: wrap;
justify-content: space-between;
gap: 5px;
margin-bottom: 5px;
}

.stat-row {
flex-direction: column;
gap: 5px;
width: auto;
}

.stat-group {
min-width: 45%;
margin-bottom: 5px;
}

#action-buttons, #footer-buttons {
grid-template-columns: repeat(2, 1fr);
}

button {
padding: 8px 2px;
font-size: 12px;
}

#scene-description {
min-height: 25vh;
max-height: 35vh;
}

.health-bar, .sanity-meter {
height: 4px;
}
}

/* ========== MOBILE PORTRAIT STYLES ========== */
/* Mobile Portrait Specific Styles */
@media (orientation: portrait) {
  body {
    padding: 5px;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  #game-container {
    padding: 2px;
    gap: 5px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #stats-bar {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 5px;
    margin-bottom: 5px;
  }

  .stat-row {
    flex-direction: row;
    gap: 10px;
    width: 100%;
  }

  .stat-group {
    min-width: 48%;
    margin-bottom: 5px;
    flex: 1;
  }

  #content-area {
    max-width: 100%;
    padding: 2px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #action-buttons, #footer-buttons {
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 5px;
  }

  button {
    padding: 8px 2px;
    font-size: 12px;
    min-height: 40px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #scene-description {
    min-height: 30vh;
    max-height: 40vh;
    font-size: 12px;
    padding: 5px;
    flex: 1;
  }

  .health-bar, .sanity-meter {
    height: 4px;
  }

  /* Modal adjustments */
  .modal {
    padding: 5px;
    position: fixed;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .modal-content {
    padding: 5px;
    min-height: 100%;
    box-sizing: border-box;
  }

  .item-row {
    font-size: 11px;
    padding: 3px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 5px;
  }

  .item-row span {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .item-row button {
    flex-shrink: 0;
    width: auto;
    padding: 3px 6px;
  }

  /* Combat modal adjustments */
  #combat-modal .modal-body {
    padding: 5px;
  }

  #enemy-display, #player-display {
    padding: 5px;
    margin-bottom: 3px;
  }

  #combat-log-modal {
    min-height: 60px;
    max-height: 20vh;
    font-size: 11px;
    overflow-y: auto;
  }

  /* Character selection screen */
  #character-selection {
    padding: 5px;
  }

  .character-select {
    padding: 6px;
    margin-bottom: 5px;
  }

  .character-select h2 {
    font-size: 14px;
  }

  .character-select p {
    font-size: 11px;
  }

  /* Text sizes */
  #dungeon-level {
    font-size: 12px;
  }
  
  .stat {
    font-size: 11px;
  }
  
  .modal-header h2 {
    font-size: 14px;
  }
  
  .quest-title {
    font-size: 12px;
  }
  
  .quest-description {
    font-size: 11px;
  }
}

@media (max-height: 700px) {
  #scene-description {
    min-height: 25vh;
    max-height: 30vh;
  }

  button {
    min-height: 35px;
    font-size: 11px;
  }
}

/* Button press effect for mobile */
.button-press {
  transform: scale(0.95);
  transition: transform 0.1s;
}

.health-bar, .sanity-meter {
height: 3px;
}
}

/* Save/Load buttons */
#save-load-buttons {
display: flex;
gap: 5px;
margin-top: 10px;
}

/* Vampire eyes animation */
.vampire-eyes {
position: absolute;
width: 20px;
height: 10px;
background: red;
border-radius: 50%;
box-shadow: 0 0 10px red;
animation: eyes-glow 2s infinite alternate;
}

@keyframes eyes-glow {
0% { opacity: 0.5; }
100% { opacity: 1; }
}

/* Blood splatter effect */
.blood-splatter {
position: absolute;
width: 100%;
height: 100%;
background-image: radial-gradient(circle, transparent 0%, rgba(255,0,0,0.1) 20%, transparent 40%);
background-size: 200% 200%;
background-position: center;
opacity: 0;
pointer-events: none;
}

/* Damage numbers */
.damage-number {
position: absolute;
color: red;
font-weight: bold;
font-size: 14px;
animation: float-up 1s ease-out forwards;
pointer-events: none;
}

@keyframes float-up {
0% { transform: translateY(0); opacity: 1; }
100% { transform: translateY(-50px); opacity: 0; }
}

/* Night sky background */
.night-sky {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(to bottom, #000000 0%, #1a1a2e 100%);
z-index: -2;
}

/* Stars */
.stars {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-image:
radial-gradient(1px 1px at 20px 30px, white, rgba(0,0,0,0)),
radial-gradient(1px 1px at 40px 70px, white, rgba(0,0,0,0)),
radial-gradient(1px 1px at 80px 40px, white, rgba(0,0,0,0)),
radial-gradient(1px 1px at 120px 80px, white, rgba(0,0,0,0)),
radial-gradient(1px 1px at 160px 20px, white, rgba(0,0,0,0)),
radial-gradient(1px 1px at 200px 60px, white, rgba(0,0,0,0));
background-repeat: repeat;
z-index: -1;
animation: twinkle 5s infinite alternate;
}

@keyframes twinkle {
0% { opacity: 0.5; }
100% { opacity: 1; }
}

/* Moon */
.moon {
position: fixed;
top: 20px;
right: 20px;
width: 40px;
height: 40px;
background: #f5f5f5;
border-radius: 50%;
box-shadow: 0 0 20px #f5f5f5;
z-index: -1;
}

/* Castle silhouette */
.castle-silhouette {
position: fixed;
bottom: 0;
left: 0;
width: 100%;
height: 100px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 10"><path d="M0,10 L10,5 L20,8 L30,2 L40,7 L50,0 L60,6 L70,3 L80,9 L90,1 L100,10 Z" fill="black"/></svg>');
background-repeat: repeat-x;
background-position: bottom;
z-index: -1;
}

/* Combat buttons */
.combat-button {
position: relative;
overflow: hidden;
}

.combat-button::after {
content: "";
position: absolute;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background: rgba(255,0,0,0.1);
transform: rotate(45deg);
opacity: 0;
transition: all 0.3s;
}

.combat-button:active::after {
opacity: 1;
top: 0;
left: 0;
width: 100%;
height: 100%;
}

/* New: Vampire bat animation */
.vampire-bat {
position: absolute;
width: 30px;
height: 20px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 20"><path d="M15,0 C20,5 25,5 30,0 C25,10 30,15 15,20 C0,15 5,10 0,0 C5,5 10,5 15,0 Z" fill="%23300"/></svg>');
background-repeat: no-repeat;
animation: fly 15s linear infinite;
opacity: 0.6;
z-index: -1;
}

@keyframes fly {
0% { transform: translate(-50px, 50px) scale(0.5); opacity: 0; }
10% { opacity: 0.6; }
90% { opacity: 0.6; }
100% { transform: translate(calc(100vw + 50px), calc(100vh - 50px)) scale(1.2); opacity: 0; }
}

/* New: Blood rain effect */
.blood-rain {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
z-index: -1;
}

.blood-drop {
position: absolute;
width: 2px;
height: 15px;
background: linear-gradient(to bottom, rgba(255,0,0,0.8), transparent);
animation: rain linear infinite;
}

@keyframes rain {
0% { transform: translateY(-100px); opacity: 1; }
100% { transform: translateY(100vh); opacity: 0; }
}

/* New: Fog effect */
.fog {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%);
pointer-events: none;
z-index: -1;
animation: fog-move 60s linear infinite;
}

@keyframes fog-move {
0% { background-position: 0 0; }
100% { background-position: 1000px 0; }
}

/* New: Typewriter effect */
.typewriter {
overflow: hidden;
border-right: 2px solid red;
white-space: nowrap;
animation: blink-caret 0.75s step-end infinite;
}

@keyframes blink-caret {
from, to { border-color: transparent }
50% { border-color: red; }
}

/* New: Dracula portrait */
.dracula-portrait {
width: 100px;
height: 150px;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 150"><path d="M50,20 C70,20 80,40 80,60 C80,80 70,100 50,100 C30,100 20,80 20,60 C20,40 30,20 50,20 Z M30,110 L70,110 L70,140 L30,140 Z" fill="%23300"/><circle cx="40" cy="50" r="5" fill="red"/><circle cx="60" cy="50" r="5" fill="red"/><path d="M40,70 Q50,80 60,70" stroke="red" fill="transparent" stroke-width="2"/></svg>');
background-repeat: no-repeat;
margin: 0 auto;
animation: pulse 2s infinite alternate;
}

/* New: Inventory item hover effect */
.item-row:hover {
background-color: rgba(255,0,0,0.1);
}

/* New: Button press effect */
.button-press {
transform: scale(0.95);
}

/* New: Dark mode toggle */
.dark-mode-toggle {
position: fixed;
bottom: 10px;
right: 10px;
z-index: 1000;
}

/* New: Difficulty selector */
.difficulty-selector {
margin: 10px 0;
padding: 5px;
background: #000;
color: red;
border: 1px solid red;
}
</style>
</head>
<body>
<div class="night-sky"></div>
<div class="stars"></div>
<div class="moon"></div>
<div class="castle-silhouette"></div>
<div class="fog"></div>
<div class="blood-rain" id="blood-rain"></div>

<!-- Add vampire bats -->
<div class="vampire-bat" style="top: 10%; left: 5%; animation-delay: 0s;"></div>
<div class="vampire-bat" style="top: 30%; left: 15%; animation-delay: 3s;"></div>
<div class="vampire-bat" style="top: 60%; left: 25%; animation-delay: 6s;"></div>
<div class="vampire-bat" style="top: 20%; left: 35%; animation-delay: 9s;"></div>
<div class="vampire-bat" style="top: 50%; left: 45%; animation-delay: 12s;"></div>

<div id="game-container">
<!-- Character Selection Screen -->
<div id="character-selection">
<h1 class="text-center blood-drip">DRACULA'S CURSE</h1>
<p>The year is 1897. The vampire Count Dracula has taken residence in his decaying castle above the village of Bistritz.</p>
<p class="text-center">CHOOSE YOUR HUNTER:</p>

<div class="character-select" id="select-jonathan">
<h2>JONATHAN HARKER</h2>
<p><strong>Class:</strong> Diplomat</p>
<p><strong>Skills:</strong> Silver Strike (2x damage with silver weapons)</p>
<p><strong>HP:</strong> 90 | <strong>SANITY:</strong> 110 | <strong>DMG:</strong> 7-12</p>
</div>

<div class="character-select" id="select-vanhelsing">
<h2>VAN HELSING</h2>
<p><strong>Class:</strong> Professor</p>
<p><strong>Skills:</strong> Holy Water (double effectiveness), Vampire Knowledge (25% less sanity loss)</p>
<p><strong>HP:</strong> 100 | <strong>SANITY:</strong> 90 | <strong>DMG:</strong> 5-15</p>
</div>

<div class="character-select" id="select-mina">
<h2>MINA MURRAY</h2>
<p><strong>Class:</strong> Occultist</p>
<p><strong>Skills:</strong> Hypnosis (chance to stun enemies), Sixth Sense (higher chance to find items)</p>
<p><strong>HP:</strong> 80 | <strong>SANITY:</strong> 120 | <strong>DMG:</strong> 4-10</p>
</div>

<div id="difficulty-selector" class="mt-1">
<label for="difficulty">DIFFICULTY:</label>
<select id="difficulty" class="difficulty-selector">
<option value="easy">Easy</option>
<option value="normal" selected>Normal</option>
<option value="hard">Hard</option>
<option value="nightmare">Nightmare</option>
</select>
</div>

<div id="save-load-buttons">
<button id="load-button">LOAD GAME</button>
<button id="settings-button">SETTINGS</button>
</div>
</div>

<!-- Main Game UI -->
<div id="main-game" style="display: none; height: 100%;">
<!-- Centered Content Area -->
<div id="content-area">
<!-- Stats Bar - Now first item inside content area -->
<div id="stats-bar">
<!-- HP/SAN Row -->
<div class="stat-row">
<div class="stat-group">
<div class="stat">HP: <span id="current-hp">100</span>/<span id="max-hp">100</span></div>
<div class="health-bar">
<div id="player-health-fill" class="health-fill" style="width: 80%;"></div>
</div>
</div>
<div class="stat-group">
<div class="stat">SAN: <span id="current-sanity">100</span>/<span id="max-sanity">100</span></div>
<div class="sanity-meter">
<div id="player-sanity-fill" class="sanity-fill" style="width: 80%;"></div>
</div>
</div>
</div>

<!-- Level and Gold Row - Moved below -->
<div class="stat-row">
<div class="stat-group">
<div class="stat">LVL: <span id="player-level">1</span></div>
</div>
<div class="stat-group">
<div class="stat">GOLD: <span id="player-gold">50</span></div>
</div>
<div class="stat-group">
<div class="stat">DAY: <span id="game-day">1</span></div>
</div>
</div>
</div>

<!-- Main Content Area - Centered -->
<div id="content-area">
<div id="dungeon-level">TAVERN</div>
<div class="progress-container">
<div id="level-progress" class="progress-bar"></div>
</div>

<div id="scene-description" class="candle-flicker">
<p>You stand in the dimly lit tavern at the foot of the Carpathian Mountains. The villagers whisper of horrors in the castle above.</p>
<p>The barkeep eyes you warily. "You're not going up there, are you?" A merchant sits in the corner.</p>
</div>

<div id="combat-log"></div>

<!-- Dynamic Action Buttons - Centered -->
<div id="action-buttons">
<button id="explore-button">EXPLORE</button>
<button id="tavern-action">TALK</button>
<button id="merchant-button">MERCHANT</button>
<button id="rest-button">REST</button>
</div>

<!-- Current Weapon Display -->
<div class="item-row">
<span>WEAPON:</span>
<span id="equipped-weapon-name">FISTS</span> (<span id="equipped-weapon-dmg">2</span> DMG)
</div>

<!-- Footer Buttons -->
<div id="footer-buttons">
<button id="inventory-button">INV</button>
<button id="quests-button">QUESTS</button>
<button id="character-button">STATS</button>
<button id="map-button">MAP</button>
</div>
</div>
</div>

<!-- Inventory Modal -->
<div id="inventory-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>INVENTORY</h2>
<button id="close-inventory" class="close-modal">X</button>
</div>
<div class="modal-body">
<h3>WEAPONS</h3>
<div id="weapons-list">
<div class="item-row" data-id="fists" data-dmg="2">
<span>FISTS (2 DMG)</span>
<button class="equip-button">EQUIP</button>
</div>
</div>

<h3 class="mt-1">ITEMS</h3>
<div id="items-list">
<div class="item-row" data-id="health-potion" data-heal="20">
<span>HEALTH POTION (+20 HP)</span>
<button class="use-button">USE</button>
</div>
</div>

<h3 class="mt-1">QUEST ITEMS</h3>
<div id="quest-items-list">
<!-- Quest items will appear here -->
</div>

<h3 class="mt-1">ACHIEVEMENTS</h3>
<div id="achievements-list">
<!-- Achievements will appear here -->
</div>
</div>
</div>
</div>

<!-- Character Stats Modal -->
<div id="character-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="character-name">CHARACTER</h2>
<button id="close-character" class="close-modal">X</button>
</div>
<div class="modal-body">
<div class="stat-row">
<span>CLASS:</span>
<span id="character-class">DIPLOMAT</span>
</div>
<div class="stat-row">
<span>LEVEL:</span>
<span id="character-level">1</span>
</div>
<div class="stat-row">
<span>NEXT LEVEL:</span>
<span id="character-next-level">100 XP</span>
</div>

<h3 class="mt-1">ATTRIBUTES</h3>
<div class="stat-row">
<span>STRENGTH:</span>
<span id="character-strength">7</span>
</div>
<div class="stat-row">
<span>AGILITY:</span>
<span id="character-agility">6</span>
</div>
<div class="stat-row">
<span>INTELLIGENCE:</span>
<span id="character-intelligence">5</span>
</div>
<div class="stat-row">
<span>FAITH:</span>
<span id="character-faith">4</span>
</div>

<h3 class="mt-1">SKILLS</h3>
<div id="character-skills">
<p>SILVER STRIKE</p>
</div>

<h3 class="mt-1">PERKS</h3>
<div id="character-perks">
<!-- Perks will appear here -->
</div>
</div>
</div>
</div>

<!-- Quests Modal -->
<div id="quests-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>QUESTS</h2>
<button id="close-quests" class="close-modal">X</button>
</div>
<div class="modal-body">
<div id="active-quests">
<div class="quest-item">
<div class="quest-title">SLAY DRACULA</div>
<div class="quest-description">Defeat Count Dracula to lift the curse.</div>
<div class="quest-status">(Active)</div>
</div>
<div class="quest-item">
<div class="quest-title">FIND A STAKE</div>
<div class="quest-description">Obtain a wooden stake to fight vampires.</div>
<div class="quest-status">(Active)</div>
</div>
</div>

<h3 class="mt-1">COMPLETED</h3>
<div id="completed-quests">
<!-- Completed quests will appear here -->
</div>
</div>
</div>
</div>

<!-- Map Modal -->
<div id="map-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>MAP</h2>
<button id="close-map" class="close-modal">X</button>
</div>
<div class="modal-body">
<div id="map-display">
[MAP WILL APPEAR HERE]
</div>
<div id="map-legend" class="mt-1">
<p>X - Your location</p>
<p>■ - Visited location</p>
<p>□ - Unvisited location</p>
</div>
</div>
</div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>SETTINGS</h2>
<button id="close-settings" class="close-modal">X</button>
</div>
<div class="modal-body">
<div id="settings-content">
<div class="setting-option">
<span>Text Speed:</span>
<select id="text-speed">
<option value="fast">Fast</option>
<option value="medium" selected>Medium</option>
<option value="slow">Slow</option>
</select>
</div>
<div class="setting-option">
<span>Combat Animations:</span>
<input type="checkbox" id="combat-animations" checked>
</div>
<div class="setting-option">
<span>Sound Effects:</span>
<input type="checkbox" id="sound-effects" checked>
</div>
<div class="setting-option">
<span>Music:</span>
<input type="checkbox" id="music" checked>
</div>
<div class="setting-option">
<span>Blood Effects:</span>
<input type="checkbox" id="blood-effects" checked>
</div>
<button id="save-settings">SAVE SETTINGS</button>
<button id="save-game">SAVE GAME</button>
<button id="reset-game">RESET GAME</button>
</div>
</div>
</div>
</div>

<!-- Combat Modal -->
<div id="combat-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="combat-title">COMBAT</h2>
</div>
<div class="modal-body">
<div id="enemy-display">
<h3 id="enemy-name">VAMPIRE SPAWN</h3>
<div>HP: <span id="enemy-hp">30</span>/<span id="enemy-max-hp">30</span></div>
<div class="health-bar">
<div class="health-fill" id="enemy-hp-bar" style="width: 100%;"></div>
</div>
<div class="vampire-eyes" style="top: 10px; left: 120px;"></div>
<div class="vampire-eyes" style="top: 10px; left: 140px;"></div>
</div>

<div id="player-display">
<h3 id="player-name">JONATHAN HARKER</h3>
<div>HP: <span id="player-hp-combat">100</span>/<span id="player-max-hp-combat">100</span></div>
<div class="health-bar">
<div id="player-hp-bar" class="health-fill" style="width: 100%;"></div>
</div>
<div>SANITY: <span id="player-sanity-combat">100</span>/<span id="player-max-sanity-combat">100</span></div>
<div class="sanity-meter">
<div id="player-sanity-bar" class="sanity-fill" style="width: 100%;"></div>
</div>
</div>

<div id="combat-log-modal" style="min-height: 80px;">
<p>A VAMPIRE SPAWN HISSES AT YOU!</p>
</div>

<div id="combat-actions" class="mt-1">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
<button id="attack-button" class="combat-button">ATTACK</button>
<button id="special-button" class="combat-button">SPECIAL</button>
<button id="use-item-button" class="combat-button">ITEM</button>
<button id="flee-button" class="combat-button">FLEE</button>
</div>
</div>
</div>
</div>
</div>

<!-- Game Over Modal -->
<div id="game-over-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 class="text-center">GAME OVER</h2>
</div>
<div class="modal-body text-center">
<p id="game-over-text">You have been defeated!</p>
<div class="dracula-portrait"></div>
<p>Dracula laughs as your life fades away...</p>
<button id="try-again-button">TRY AGAIN</button>
<button id="main-menu-button">MAIN MENU</button>
</div>
</div>
</div>

<!-- Victory Modal -->
<div id="victory-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 class="text-center">VICTORY!</h2>
</div>
<div class="modal-body text-center">
<p>You have defeated Dracula and lifted the curse!</p>
<div class="dracula-portrait" style="filter: brightness(0.5);"></div>
<p>Final Stats:</p>
<p>Level: <span id="victory-level">1</span></p>
<p>Gold: <span id="victory-gold">0</span></p>
<p>Enemies Defeated: <span id="victory-enemies">0</span></p>
<p>Days Survived: <span id="victory-days">1</span></p>
<p>Achievements: <span id="victory-achievements">0</span>/10</p>
<button id="new-game-button">NEW GAME</button>
<button id="new-game-plus-button">NEW GAME+</button>
</div>
</div>
</div>

<!-- Merchant Modal -->
<div id="merchant-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>MERCHANT</h2>
<button id="close-merchant" class="close-modal">X</button>
</div>
<div class="modal-body">
<div id="merchant-gold">GOLD: <span id="merchant-gold-amount">0</span></div>

<h3 class="mt-1">BUY ITEMS</h3>
<div id="merchant-buy-list">
<div class="merchant-item" data-id="health-potion" data-price="15">
<span class="tooltip">HEALTH POTION (+20 HP)<span class="tooltiptext">Restores 20 HP. Essential for survival.</span></span>
<span class="merchant-price">15 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="holy-water" data-price="25">
<span class="tooltip">HOLY WATER (15 DMG vs vampires)<span class="tooltiptext">Deals 15 damage. Effective against undead.</span></span>
<span class="merchant-price">25 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="garlic" data-price="10">
<span class="tooltip">GARLIC (5 DMG, repels vampires)<span class="tooltiptext">Deals 5 damage. Repels vampires temporarily.</span></span>
<span class="merchant-price">10 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="silver-dagger" data-price="50">
<span class="tooltip">SILVER DAGGER (8 DMG, effective vs werewolves)<span class="tooltiptext">Deals 8 damage. Effective against werewolves.</span></span>
<span class="merchant-price">50 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="crossbow" data-price="75">
<span class="tooltip">CROSSBOW (10 DMG, silver-tipped arrows)<span class="tooltiptext">Deals 10 damage. Comes with 10 silver-tipped arrows.</span></span>
<span class="merchant-price">75 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="winchester" data-price="100">
<span class="tooltip">WINCHESTER RIFLE (15 DMG, powerful)<span class="tooltiptext">Deals 15 damage. Comes with 6 bullets.</span></span>
<span class="merchant-price">100 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="flintlock" data-price="60">
<span class="tooltip">FLINTLOCK PISTOL (12 DMG, one-shot)<span class="tooltiptext">Deals 12 damage. Single shot before reload.</span></span>
<span class="merchant-price">60 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="lantern" data-price="20">
<span class="tooltip">LANTERN (lights dark areas)<span class="tooltiptext">Illuminates dark areas. Weakens shadow creatures.</span></span>
<span class="merchant-price">20 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="silver-cross" data-price="30">
<span class="tooltip">SILVER CROSS (repels vampires)<span class="tooltiptext">Protects against vampire attacks. Reduces sanity loss.</span></span>
<span class="merchant-price">30 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="bible" data-price="25">
<span class="tooltip">HOLY BIBLE (weakens undead)<span class="tooltiptext">Weakens undead creatures. Boosts holy attacks.</span></span>
<span class="merchant-price">25 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="sanity-potion" data-price="20">
<span class="tooltip">ELIXIR OF CLARITY (+30 SANITY)<span class="tooltiptext">Restores 30 sanity. Prevents madness.</span></span>
<span class="merchant-price">20 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="bullets" data-price="10">
<span class="tooltip">BULLETS (6 pack)<span class="tooltiptext">Ammunition for firearms. 6 bullets.</span></span>
<span class="merchant-price">10 GOLD</span>
<button class="buy-button">BUY</button>
</div>
<div class="merchant-item" data-id="silver-arrows" data-price="15">
<span class="tooltip">SILVER ARROWS (5 pack)<span class="tooltiptext">Ammunition for crossbows. 5 silver arrows.</span></span>
<span class="merchant-price">15 GOLD</span>
<button class="buy-button">BUY</button>
</div>
</div>

<h3 class="mt-1">SELL ITEMS</h3>
<div id="merchant-sell-list">
<!-- Player's sellable items will appear here -->
</div>
</div>
</div>
</div>

<!-- Blood splatter effect (hidden by default) -->
<div id="blood-splatter" class="blood-splatter"></div>

<script>
// Mobile touch event handlers
document.addEventListener('DOMContentLoaded', function() {
  // Prevent zooming on double-tap
  document.addEventListener('dblclick', function(e) {
    e.preventDefault();
  }, { passive: false });

  // Better touch feedback for buttons
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('touchstart', function() {
      this.classList.add('button-press');
    });
    
    button.addEventListener('touchend', function() {
      this.classList.remove('button-press');
    });
  });
  
  // Your existing DOMContentLoaded code continues here...
  // (keep all your existing game initialization code)
});
// ========== GAME STATE ========== //
const gameState = {
player: null,
characters: {
jonathan: {
name: "JONATHAN HARKER",
class: "DIPLOMAT",
hp: 90,
maxHp: 90,
sanity: 110,
maxSanity: 110,
strength: 7,
agility: 6,
intelligence: 5,
faith: 4,
skills: ["SILVER STRIKE"],
perks: ["Silver Affinity: +10% damage with silver weapons"],
inventory: ["silver-dagger"]
},
vanhelsing: {
name: "VAN HELSING",
class: "PROFESSOR",
hp: 100,
maxHp: 100,
sanity: 90,
maxSanity: 90,
strength: 5,
agility: 4,
intelligence: 8,
faith: 7,
skills: ["HOLY WATER", "VAMPIRE KNOWLEDGE"],
perks: ["Undead Expert: 25% less sanity loss from undead"],
inventory: ["holy-water", "garlic"]
},
mina: {
name: "MINA MURRAY",
class: "OCCULTIST",
hp: 80,
maxHp: 80,
sanity: 120,
maxSanity: 120,
strength: 4,
agility: 7,
intelligence: 7,
faith: 6,
skills: ["HYPNOSIS", "SIXTH SENSE"],
perks: ["Occult Insight: 30% better chance to find items"],
inventory: ["occult-tome"]
}
},
currentEnemy: null,
inCombat: false,
location: "tavern",
enemiesDefeated: 0,
hasReceivedStake: false,
currentLevel: 0,
levelProgress: 0,
gameDay: 1,
difficulty: "normal",
levels: [
{
name: "TAVERN",
description: "You stand in the dimly lit tavern at the foot of the Carpathian Mountains. The villagers whisper of horrors in the castle above.",
enemies: ["vampire-spawn", "ghoul"],
xpRequired: 0
},
{
name: "FOREST",
description: "The dark forest is filled with eerie sounds. The path to the mountains is treacherous.",
enemies: ["vampire-spawn", "ghoul", "shadow"],
xpRequired: 100
},
{
name: "MOUNTAIN PASS",
description: "The steep mountain path winds upward. The air grows colder as you approach the castle.",
enemies: ["vampire-spawn", "brides", "werewolf"],
xpRequired: 250
},
{
name: "DRACULA'S CASTLE",
description: "You stand before Dracula's castle. The massive gates loom before you.",
enemies: ["brides", "werewolf", "dracula"],
xpRequired: 500
},
{
name: "THRONE ROOM",
description: "The final confrontation. Count Dracula awaits in his throne room.",
enemies: ["dracula"],
xpRequired: 750
}
],
quests: {
active: [
{
id: "slay-dracula",
title: "SLAY DRACULA",
description: "Defeat Count Dracula to lift the curse.",
completed: false
},
{
id: "find-stake",
title: "FIND A STAKE",
description: "Obtain a wooden stake to fight vampires.",
completed: false
}
],
completed: []
},
inventory: {
weapons: [
{ id: "fists", name: "FISTS", damage: 2 },
{ id: "silver-dagger", name: "SILVER DAGGER", damage: 8, special: "silver" },
{ id: "wooden-stake", name: "WOODEN STAKE", damage: 12, special: "stake" },
{ id: "crossbow", name: "CROSSBOW", damage: 10, special: "silver", ammo: 10 },
{ id: "winchester", name: "WINCHESTER RIFLE", damage: 15, special: "firearm", ammo: 6 },
{ id: "flintlock", name: "FLINTLOCK PISTOL", damage: 12, special: "firearm", ammo: 1 },
{ id: "torch", name: "TORCH", damage: 3, special: "light" }
],
items: [
{ id: "health-potion", name: "HEALTH POTION", heal: 20, quantity: 3 },
{ id: "holy-water", name: "HOLY WATER", damage: 15, quantity: 2, special: "holy" },
{ id: "garlic", name: "GARLIC", damage: 5, quantity: 3, special: "repel" },
{ id: "rope", name: "ROPE", quantity: 1, usable: true },
{ id: "lantern", name: "LANTERN", quantity: 0, usable: true, special: "light" },
{ id: "silver-cross", name: "SILVER CROSS", quantity: 0, special: "holy" },
{ id: "bible", name: "HOLY BIBLE", quantity: 0, special: "holy" },
{ id: "sanity-potion", name: "ELIXIR OF CLARITY", sanity: 30, quantity: 0 },
{ id: "occult-tome", name: "OCCULT TOME", quantity: 1, special: "knowledge" },
{ id: "bullets", name: "BULLETS", quantity: 0, ammoType: "firearm", ammoAmount: 6 },
{ id: "silver-arrows", name: "SILVER ARROWS", quantity: 0, ammoType: "silver", ammoAmount: 5 }
],
questItems: []
},
achievements: {
"first-blood": { name: "First Blood", description: "Defeat your first enemy", earned: false },
"stake-master": { name: "Stake Master", description: "Defeat 10 vampires with a wooden stake", earned: false, progress: 0 },
"silver-slayer": { name: "Silver Slayer", description: "Defeat 20 enemies with silver weapons", earned: false, progress: 0 },
"holy-warrior": { name: "Holy Warrior", description: "Defeat 15 enemies with holy items", earned: false, progress: 0 },
"explorer": { name: "Explorer", description: "Visit all locations", earned: false },
"merchant": { name: "Merchant", description: "Buy and sell 20 items", earned: false, progress: 0 },
"survivor": { name: "Survivor", description: "Survive 10 days", earned: false },
"nightmare": { name: "Nightmare", description: "Complete the game on Nightmare difficulty", earned: false },
"collector": { name: "Collector", description: "Collect all weapons", earned: false },
"dracula-slayer": { name: "Dracula Slayer", description: "Defeat Count Dracula", earned: false }
},
enemies: {
"vampire-spawn": {
name: "VAMPIRE SPAWN",
hp: 30,
maxHp: 30,
damage: 6,
xp: 25,
gold: 15,
weakness: ["stake", "holy"],
nightBonus: true
},
"brides": {
name: "DRACULA'S BRIDES",
hp: 50,
maxHp: 50,
damage: 9,
xp: 40,
gold: 30,
special: "charm",
weakness: ["holy", "silver"],
nightBonus: true
},
"werewolf": {
name: "WEREWOLF",
hp: 70,
maxHp: 70,
damage: 12,
xp: 60,
gold: 45,
weakness: ["silver"],
nightBonus: true
},
"ghoul": {
name: "GHOUL",
hp: 40,
maxHp: 40,
damage: 8,
xp: 35,
gold: 20,
weakness: ["holy"],
nightBonus: true
},
"shadow": {
name: "SHADOW",
hp: 25,
maxHp: 25,
damage: 5,
xp: 20,
gold: 10,
special: "fear",
weakness: ["light"],
nightBonus: true
},
"dracula": {
name: "COUNT DRACULA",
hp: 150,
maxHp: 150,
damage: 15,
xp: 200,
gold: 100,
special: "transform",
weakness: ["stake", "holy"],
nightBonus: false
}
},
settings: {
textSpeed: "medium",
combatAnimations: true,
soundEffects: true,
music: true,
bloodEffects: true
},
newGamePlus: false,
merchantItems: [
{ id: "health-potion", name: "HEALTH POTION", price: 15, heal: 20 },
{ id: "holy-water", name: "HOLY WATER", price: 25, damage: 15, special: "holy" },
{ id: "garlic", name: "GARLIC", price: 10, damage: 5, special: "repel" },
{ id: "silver-dagger", name: "SILVER DAGGER", price: 50, damage: 8, special: "silver" },
{ id: "crossbow", name: "CROSSBOW", price: 75, damage: 10, special: "silver", ammo: 10 },
{ id: "winchester", name: "WINCHESTER RIFLE", price: 100, damage: 15, special: "firearm", ammo: 6 },
{ id: "flintlock", name: "FLINTLOCK PISTOL", price: 60, damage: 12, special: "firearm", ammo: 1 },
{ id: "lantern", name: "LANTERN", price: 20, usable: true, special: "light" },
{ id: "silver-cross", name: "SILVER CROSS", price: 30, special: "holy" },
{ id: "bible", name: "HOLY BIBLE", price: 25, special: "holy" },
{ id: "sanity-potion", name: "ELIXIR OF CLARITY", price: 20, sanity: 30 },
{ id: "torch", name: "TORCH", price: 15, damage: 3, special: "light" },
{ id: "bullets", name: "BULLETS", price: 10, ammoType: "firearm", ammoAmount: 6 },
{ id: "silver-arrows", name: "SILVER ARROWS", price: 15, ammoType: "silver", ammoAmount: 5 }
]
};

// ========== INITIALIZE GAME ========== //
document.addEventListener('DOMContentLoaded', function() {
// Character selection
document.getElementById('select-jonathan').addEventListener('click', () => startGame('jonathan'));
document.getElementById('select-vanhelsing').addEventListener('click', () => startGame('vanhelsing'));
document.getElementById('select-mina').addEventListener('click', () => startGame('mina'));
document.getElementById('settings-button').addEventListener('click', openSettings);
document.getElementById('load-button').addEventListener('click', loadGame);

// Set difficulty
document.getElementById('difficulty').addEventListener('change', function() {
gameState.difficulty = this.value;
});

// Create blood rain effect
createBloodRain();

// Check for saved game
if (localStorage.getItem('draculasCurseSave')) {
document.getElementById('load-button').style.display = 'block';
} else {
document.getElementById('load-button').style.display = 'none';
}
});

function createBloodRain() {
const bloodRain = document.getElementById('blood-rain');
bloodRain.innerHTML = '';
for (let i = 0; i < 50; i++) {
const drop = document.createElement('div');
drop.className = 'blood-drop';
drop.style.left = `${Math.random() * 100}%`;
drop.style.animationDuration = `${Math.random() * 2 + 1}s`;
drop.style.animationDelay = `${Math.random() * 5}s`;
bloodRain.appendChild(drop);
}
}

function startGame(character, isNewGamePlus = false) {
gameState.player = JSON.parse(JSON.stringify(gameState.characters[character]));
gameState.difficulty = document.getElementById('difficulty').value;

// Apply difficulty modifiers
applyDifficultyModifiers();

// Apply New Game+ bonuses if applicable
if (isNewGamePlus) {
gameState.player.maxHp += 20;
gameState.player.hp = gameState.player.maxHp;
gameState.player.maxSanity += 20;
gameState.player.sanity = gameState.player.maxSanity;
gameState.player.strength += 2;
gameState.player.agility += 2;
gameState.player.intelligence += 2;
gameState.player.faith += 2;
gameState.newGamePlus = true;
} else {
gameState.newGamePlus = false;
}

// Initialize additional player properties
gameState.player.level = 1;
gameState.player.xp = 0;
gameState.player.nextLevelXp = 100;
gameState.player.gold = 50;
gameState.player.equippedWeapon = "fists";
if (character === "jonathan") gameState.player.equippedWeapon = "silver-dagger";
if (character === "vanhelsing") gameState.player.equippedWeapon = "holy-water";

// Reset game state
gameState.enemiesDefeated = 0;
gameState.currentLevel = 0;
gameState.levelProgress = 0;
gameState.gameDay = 1;
gameState.quests.active.forEach(q => q.completed = false);
gameState.quests.completed = [];
gameState.hasReceivedStake = false;

// Reset achievements progress (but keep earned ones)
for (const key in gameState.achievements) {
if (!gameState.achievements[key].earned) {
if (gameState.achievements[key].progress !== undefined) {
gameState.achievements[key].progress = 0;
}
}
}

// Show main game UI
document.getElementById('character-selection').style.display = 'none';
document.getElementById('main-game').style.display = 'flex';

// Update UI
updateUI();
bindActionButtons();

// Initialize starting inventory
initializeStartingInventory(character);

// Show welcome message
addToScene(`You awaken in the tavern as ${gameState.player.name}, ready to face the horrors ahead.`);
updateDungeonLevel();

// Start day/night cycle
startDayNightCycle();
}

function applyDifficultyModifiers() {
switch(gameState.difficulty) {
case "easy":
// Easier enemies, more rewards
for (const key in gameState.enemies) {
gameState.enemies[key].hp = Math.floor(gameState.enemies[key].hp * 0.8);
gameState.enemies[key].damage = Math.floor(gameState.enemies[key].damage * 0.8);
gameState.enemies[key].xp = Math.floor(gameState.enemies[key].xp * 1.2);
gameState.enemies[key].gold = Math.floor(gameState.enemies[key].gold * 1.2);
}
break;
case "hard":
// Tougher enemies, fewer rewards
for (const key in gameState.enemies) {
gameState.enemies[key].hp = Math.floor(gameState.enemies[key].hp * 1.3);
gameState.enemies[key].damage = Math.floor(gameState.enemies[key].damage * 1.3);
gameState.enemies[key].xp = Math.floor(gameState.enemies[key].xp * 0.8);
gameState.enemies[key].gold = Math.floor(gameState.enemies[key].gold * 0.8);
}
break;
case "nightmare":
// Very tough enemies, minimal rewards
for (const key in gameState.enemies) {
gameState.enemies[key].hp = Math.floor(gameState.enemies[key].hp * 1.8);
gameState.enemies[key].damage = Math.floor(gameState.enemies[key].damage * 1.5);
gameState.enemies[key].xp = Math.floor(gameState.enemies[key].xp * 0.5);
gameState.enemies[key].gold = Math.floor(gameState.enemies[key].gold * 0.5);
}
break;
// Normal difficulty uses default values
}
}

function startDayNightCycle() {
// Every 5 minutes = 1 day in game time
setInterval(() => {
gameState.gameDay++;
document.getElementById('game-day').textContent = gameState.gameDay;
addToScene(`The sun sets... Day ${gameState.gameDay} begins.`);

// Check for survivor achievement
if (gameState.gameDay >= 10 && !gameState.achievements.survivor.earned) {
unlockAchievement("survivor");
}

// Enemies get stronger at night
for (const key in gameState.enemies) {
if (gameState.enemies[key].nightBonus) {
gameState.enemies[key].damage = Math.floor(gameState.enemies[key].damage * 1.1);
}
}
}, 300000); // 5 minutes = 300,000ms
}

function initializeStartingInventory(character) {
// Clear inventory except for fists
gameState.inventory.weapons = gameState.inventory.weapons.filter(w => w.id === "fists");

// Add character-specific items
if (character === "jonathan") {
addItemToInventory("silver-dagger");
} else if (character === "vanhelsing") {
addItemToInventory("holy-water");
addItemToInventory("garlic");
} else if (character === "mina") {
addItemToInventory("occult-tome");
}

// Always add some health potions
addItemToInventory("health-potion", 3);
}

function addItemToInventory(itemId, quantity = 1) {
const itemTemplate = getItemTemplate(itemId);
if (!itemTemplate) return;

if (itemTemplate.damage) {
// It's a weapon
const exists = gameState.inventory.weapons.some(w => w.id === itemId);
if (!exists) {
gameState.inventory.weapons.push({...itemTemplate});
}
} else {
// It's an item
const existingItem = gameState.inventory.items.find(i => i.id === itemId);
if (existingItem) {
existingItem.quantity += quantity;
} else {
gameState.inventory.items.push({...itemTemplate, quantity});
}
}
}

function getItemTemplate(itemId) {
// Check weapons
const weaponTemplate = gameState.inventory.weapons.find(w => w.id === itemId);
if (weaponTemplate) return {...weaponTemplate};

// Check items
const itemTemplate = gameState.inventory.items.find(i => i.id === itemId);
if (itemTemplate) return {...itemTemplate};

// Check merchant items
const merchantTemplate = gameState.merchantItems.find(i => i.id === itemId);
if (merchantTemplate) {
const template = {...merchantTemplate};
delete template.price;
return template;
}

return null;
}

// ========== SAVE/LOAD FUNCTIONS ========== //
function saveGame() {
const saveData = {
player: gameState.player,
currentEnemy: gameState.currentEnemy,
inCombat: gameState.inCombat,
location: gameState.location,
enemiesDefeated: gameState.enemiesDefeated,
hasReceivedStake: gameState.hasReceivedStake,
currentLevel: gameState.currentLevel,
levelProgress: gameState.levelProgress,
gameDay: gameState.gameDay,
difficulty: gameState.difficulty,
quests: gameState.quests,
inventory: gameState.inventory,
achievements: gameState.achievements,
settings: gameState.settings,
newGamePlus: gameState.newGamePlus,
timestamp: new Date().toISOString()
};

localStorage.setItem('draculasCurseSave', JSON.stringify(saveData));
addToScene("Game saved successfully.");
}

function loadGame() {
const saveData = localStorage.getItem('draculasCurseSave');
if (!saveData) {
alert("No saved game found!");
return;
}

try {
const savedGame = JSON.parse(saveData);
Object.assign(gameState, savedGame);

// Show main game UI
document.getElementById('character-selection').style.display = 'none';
document.getElementById('main-game').style.display = 'flex';

// Update UI
updateUI();
bindActionButtons();

addToScene(`Game loaded. Welcome back, ${gameState.player.name}!`);
updateDungeonLevel();

// Start day/night cycle if not already running
startDayNightCycle();
} catch (e) {
alert("Failed to load game: " + e.message);
}
}

// ========== GAME FUNCTIONS ========== //
function updateUI() {
if (!gameState.player) return;

// Update stats
document.getElementById('current-hp').textContent = gameState.player.hp;
document.getElementById('max-hp').textContent = gameState.player.maxHp;
document.getElementById('current-sanity').textContent = gameState.player.sanity;
document.getElementById('max-sanity').textContent = gameState.player.maxSanity;
document.getElementById('player-level').textContent = gameState.player.level || 1;
document.getElementById('player-gold').textContent = gameState.player.gold || 50;
document.getElementById('game-day').textContent = gameState.gameDay || 1;

// Update health bars
const playerHpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
document.getElementById('player-health-fill').style.width = `${Math.max(0, playerHpPercent)}%`;

// Update sanity bar
const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
document.getElementById('player-sanity-fill').style.width = `${Math.max(0, sanityPercent)}%`;

// Update equipped weapon
const weapon = gameState.inventory.weapons.find(w => w.id === gameState.player.equippedWeapon) ||
{ name: "FISTS", damage: 2 };
document.getElementById('equipped-weapon-name').textContent = weapon.name;
document.getElementById('equipped-weapon-dmg').textContent = weapon.damage;

// Update level progress
const levelProgress = (gameState.player.xp / gameState.player.nextLevelXp) * 100;
document.getElementById('level-progress').style.width = `${Math.min(100, levelProgress)}%`;
}

function updateDungeonLevel() {
const level = gameState.levels[gameState.currentLevel];
document.getElementById('dungeon-level').textContent = level.name;

// Update action buttons based on level
updateLocationActions();
}

function bindActionButtons() {
// Main action buttons
document.getElementById('explore-button').addEventListener('click', explore);
document.getElementById('merchant-button').addEventListener('click', openMerchant);
document.getElementById('rest-button').addEventListener('click', rest);
document.getElementById('tavern-action').addEventListener('click', talkToBarkeep);

// Modal buttons
document.getElementById('inventory-button').addEventListener('click', openInventory);
document.getElementById('character-button').addEventListener('click', openCharacter);
document.getElementById('quests-button').addEventListener('click', openQuests);
document.getElementById('map-button').addEventListener('click', openMap);

// Combat buttons
document.getElementById('attack-button').addEventListener('click', playerAttack);
document.getElementById('special-button').addEventListener('click', specialAttack);
document.getElementById('use-item-button').addEventListener('click', useItemInCombat);
document.getElementById('flee-button').addEventListener('click', attemptFlee);

// Close buttons
document.getElementById('close-inventory').addEventListener('click', function() {
hideAllModals();
if (gameState.inCombat) {
showModal(document.getElementById('combat-modal'));
}
});
document.getElementById('close-character').addEventListener('click', hideAllModals);
document.getElementById('close-quests').addEventListener('click', hideAllModals);
document.getElementById('close-map').addEventListener('click', hideAllModals);
document.getElementById('close-settings').addEventListener('click', hideAllModals);
document.getElementById('close-merchant').addEventListener('click', hideAllModals);

// Settings buttons
document.getElementById('save-settings').addEventListener('click', saveSettings);
document.getElementById('save-game').addEventListener('click', saveGame);
document.getElementById('reset-game').addEventListener('click', resetGame);

// Merchant buttons
document.querySelectorAll('.buy-button').forEach(button => {
button.addEventListener('click', buyItem);
});

// Game over buttons
document.getElementById('try-again-button').addEventListener('click', tryAgain);
document.getElementById('main-menu-button').addEventListener('click', returnToMainMenu);

// Victory buttons
document.getElementById('new-game-button').addEventListener('click', () => {
hideAllModals();
document.getElementById('main-game').style.display = 'none';
document.getElementById('character-selection').style.display = 'flex';
});

document.getElementById('new-game-plus-button').addEventListener('click', () => {
hideAllModals();
const character = gameState.player.name.toLowerCase().includes("harker") ? "jonathan" :
gameState.player.name.toLowerCase().includes("helsing") ? "vanhelsing" : "mina";
startGame(character, true);
});
}

function updateLocationActions() {
const level = gameState.levels[gameState.currentLevel];
const actions = document.getElementById('action-buttons');

if (gameState.currentLevel === 0) {
// Tavern actions
actions.innerHTML = `
<button id="explore-button">LEAVE</button>
<button id="tavern-action">TALK</button>
<button id="merchant-button">MERCHANT</button>
<button id="rest-button">REST</button>
`;
// Rebind buttons
document.getElementById('explore-button').addEventListener('click', leaveTavern);
document.getElementById('tavern-action').addEventListener('click', talkToBarkeep);
document.getElementById('merchant-button').addEventListener('click', openMerchant);
document.getElementById('rest-button').addEventListener('click', rest);
} else {
// Dungeon actions
actions.innerHTML = `
<button id="explore-button">EXPLORE</button>
<button id="tavern-action">RETURN</button>
<button id="merchant-button" disabled>MERCHANT</button>
<button id="rest-button">REST</button>
`;
// Rebind buttons
document.getElementById('explore-button').addEventListener('click', explore);
document.getElementById('tavern-action').addEventListener('click', returnToTavern);
document.getElementById('rest-button').addEventListener('click', rest);
}
}

// ========== LOCATION FUNCTIONS ========== //
function talkToBarkeep() {
const hasStake = gameState.inventory.weapons.some(w => w.id === "wooden-stake");

if (!hasStake && !gameState.hasReceivedStake) {
addToScene(`"You're mad to go up there," the barkeep says, wiping a glass.`);
addToScene(`"But if you're set on it... Take this." He slides a WOODEN STAKE across the counter.`);
addToScene(`<strong>Obtained WOODEN STAKE!</strong>`);

// Add stake to inventory
addItemToInventory("wooden-stake");
gameState.hasReceivedStake = true;

// Complete find stake quest if active
completeQuest("find-stake");
} else {
const randomDialogue = [
`"You still here? Don't say I didn't warn you about that castle," the barkeep mutters.`,
`"The nights grow longer. Dracula's power increases," the barkeep whispers fearfully.`,
`"The merchant has good wares, but don't trust him too much," the barkeep advises.`,
`"They say Dracula can control the very weather itself," the barkeep says, glancing at the storm outside.`
][Math.floor(Math.random() * 4)];
addToScene(randomDialogue);
}
}

function openMerchant() {
// Update merchant gold display
document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;

// Update sell list
const sellList = document.getElementById('merchant-sell-list');
sellList.innerHTML = '';

// Add weapons to sell (except fists)
gameState.inventory.weapons.forEach(weapon => {
if (weapon.id !== 'fists') {
const sellPrice = Math.floor((weapon.damage * 3) * (weapon.ammo ? 0.8 : 1)); // Base price on damage
const itemElement = document.createElement('div');
itemElement.className = 'merchant-item';
itemElement.dataset.id = weapon.id;
itemElement.dataset.price = sellPrice;
itemElement.innerHTML = `
<span class="tooltip">${weapon.name} (${weapon.damage} DMG${weapon.ammo ? `, ${weapon.ammo} shots` : ''})<span class="tooltiptext">${getItemDescription(weapon)}</span></span>
<span class="merchant-price">${sellPrice} GOLD</span>
<button class="sell-button">SELL</button>
`;
sellList.appendChild(itemElement);
}
});

// Add items to sell
gameState.inventory.items.forEach(item => {
// Don't show items with 0 quantity
if (item.quantity > 0) {
const sellPrice = Math.floor((item.heal || item.damage || 5) * 2); // Base price on effect
const itemElement = document.createElement('div');
itemElement.className = 'merchant-item';
itemElement.dataset.id = item.id;
itemElement.dataset.price = sellPrice;
itemElement.innerHTML = `
<span class="tooltip">${item.name} x${item.quantity}<span class="tooltiptext">${getItemDescription(item)}</span></span>
<span class="merchant-price">${sellPrice} GOLD</span>
<button class="sell-button">SELL</button>
`;
sellList.appendChild(itemElement);
}
});

// Add event listeners to sell buttons
document.querySelectorAll('.sell-button').forEach(button => {
button.addEventListener('click', sellItem);
});

showModal(document.getElementById('merchant-modal'));
}

function getItemDescription(item) {
let desc = '';
if (item.heal) desc += `Restores ${item.heal} HP. `;
if (item.damage) desc += `Deals ${item.damage} damage. `;
if (item.sanity) desc += `Restores ${item.sanity} sanity. `;
if (item.special === "holy") desc += `Effective against undead. `;
if (item.special === "light") desc += `Illuminates dark areas. `;
if (item.special === "silver") desc += `Effective against werewolves. `;
if (item.special === "stake") desc += `Effective against vampires. `;
if (item.special === "repel") desc += `Repels vampires. `;
if (item.special === "knowledge") desc += `Grants occult knowledge. `;
if (item.ammo) desc += `Comes with ${item.ammo} shots. `;
if (item.ammoType) desc += `Ammunition for ${item.ammoType === "firearm" ? "firearms" : "crossbows"}. `;
return desc.trim();
}

function buyItem() {
const itemId = this.parentElement.dataset.id;
const price = parseInt(this.parentElement.dataset.price);

if (gameState.player.gold >= price) {
gameState.player.gold -= price;

// Find the item template from merchant items
const merchantItem = gameState.merchantItems.find(item => item.id === itemId);
if (!merchantItem) return;

// Create a copy of the item without the price property
const itemToAdd = {...merchantItem};
delete itemToAdd.price;

// Add to inventory
if (itemToAdd.damage) {
// It's a weapon
const exists = gameState.inventory.weapons.some(w => w.id === itemId);
if (!exists) {
gameState.inventory.weapons.push(itemToAdd);
}
} else {
// It's an item
const existingItem = gameState.inventory.items.find(i => i.id === itemId);
if (existingItem) {
existingItem.quantity = (existingItem.quantity || 0) + 1;
} else {
gameState.inventory.items.push({...itemToAdd, quantity: 1});
}
}

updateUI();

// Update merchant gold display
document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;

// Show message
addToScene(`You bought a ${merchantItem.name} for ${price} gold.`);

// Update inventory display if open
if (document.getElementById('inventory-modal').style.display === 'block') {
openInventory();
}

// If buying ammo, try to auto-load it into weapons
if (itemId === "bullets" || itemId === "silver-arrows") {
autoLoadAmmo(itemId);
}

// Update merchant achievement
updateAchievementProgress("merchant", 1);
} else {
addToScene("Not enough gold!");
}
}

function autoLoadAmmo(ammoId) {
const ammoItem = gameState.inventory.items.find(i => i.id === ammoId);
if (!ammoItem) return;

// Find weapons that use this ammo type
const weaponType = ammoId === "bullets" ? "firearm" : "silver";
const weapons = gameState.inventory.weapons.filter(w => w.special === weaponType);

if (weapons.length === 0) return;

// Try to load ammo into each weapon
weapons.forEach(weapon => {
if (weapon.ammo === undefined) return;

const maxAmmo = weapon.id === "flintlock" ? 1 :
weapon.id === "winchester" ? 6 :
weapon.id === "crossbow" ? 10 : 0;

if (weapon.ammo < maxAmmo && ammoItem.quantity > 0) {
const needed = maxAmmo - weapon.ammo;
const canAdd = Math.min(needed, ammoItem.ammoAmount);

weapon.ammo += canAdd;
ammoItem.quantity--;

addToScene(`Loaded ${canAdd} ${ammoId === "bullets" ? "bullets" : "arrows"} into ${weapon.name}.`);
}
});
}

function sellItem() {
const itemId = this.parentElement.dataset.id;
const price = parseInt(this.parentElement.dataset.price);

// Check if it's a weapon
const weaponIndex = gameState.inventory.weapons.findIndex(w => w.id === itemId);
if (weaponIndex !== -1) {
// Don't sell equipped weapon
if (gameState.player.equippedWeapon === itemId) {
addToScene(`You can't sell your equipped weapon!`);
return;
}

gameState.inventory.weapons.splice(weaponIndex, 1);
gameState.player.gold += price;
updateUI();
document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;

const item = getItemTemplate(itemId);
addToScene(`You sold your ${item.name} for ${price} gold.`);

// Update sell list
openMerchant();

// Update merchant achievement
updateAchievementProgress("merchant", 1);
return;
}

// Check if it's an item
const item = gameState.inventory.items.find(i => i.id === itemId);
if (item) {
if (item.quantity > 1) {
item.quantity--;
} else {
gameState.inventory.items = gameState.inventory.items.filter(i => i.id !== itemId);
}

gameState.player.gold += price;
updateUI();
document.getElementById('merchant-gold-amount').textContent = gameState.player.gold;
addToScene(`You sold a ${item.name} for ${price} gold.`);

// Update sell list
openMerchant();

// Update merchant achievement
updateAchievementProgress("merchant", 1);
}
}

function leaveTavern() {
gameState.currentLevel = 1;
updateDungeonLevel();
clearScene();
addToScene(gameState.levels[1].description);
updateLocationActions();

// Random encounter chance
if (Math.random() < 0.6) {
setTimeout(() => {
startRandomEncounter();
}, 1000);
}
}

function returnToTavern() {
gameState.currentLevel = 0;
updateDungeonLevel();
clearScene();
addToScene(gameState.levels[0].description);
updateLocationActions();
}

function explore() {
const level = gameState.levels[gameState.currentLevel];
clearScene();
addToScene(`You explore the ${level.name.toLowerCase()}...`);

// Chance of combat, finding item, or nothing
let roll = Math.random();
let itemFindBonus = 0;

// Mina's Sixth Sense ability increases item find chance
if (gameState.player.skills.includes("SIXTH SENSE")) {
itemFindBonus = 0.15;
}

if (roll < 0.7) {
// Combat encounter
setTimeout(() => {
startRandomEncounter();
}, 1000);
} else if (roll < 0.9 + itemFindBonus) {
// Find item
setTimeout(() => {
findItem();
}, 1000);
} else {
// Nothing happens
setTimeout(() => {
addToScene("You find nothing of interest.");
}, 1000);
}
}

function startRandomEncounter() {
const level = gameState.levels[gameState.currentLevel];
const enemyTypes = level.enemies;

// Weight enemies based on level progression
let weights = [];
if (gameState.currentLevel === 1) {
weights = [0.5, 0.3, 0.2]; // Forest enemies
} else if (gameState.currentLevel === 2) {
weights = [0.3, 0.4, 0.3]; // Mountain enemies
} else {
weights = [0.2, 0.3, 0.5]; // Castle enemies (more dangerous)
}

let random = Math.random();
let enemyType;

if (random < weights[0]) {
enemyType = enemyTypes[0];
} else if (random < weights[0] + weights[1]) {
enemyType = enemyTypes[1];
} else {
enemyType = enemyTypes[2];
}

startCombat(enemyType);
}

function findItem() {
const possibleItems = [
{id: "health-potion", chance: 0.6},
{id: "holy-water", chance: 0.3},
{id: "garlic", chance: 0.5},
{id: "rope", chance: 0.2},
{id: "silver-cross", chance: 0.1},
{id: "bible", chance: 0.1},
{id: "sanity-potion", chance: 0.2},
{id: "torch", chance: 0.3},
{id: "bullets", chance: 0.4},
{id: "silver-arrows", chance: 0.3}
];

const foundItems = possibleItems.filter(item => Math.random() < item.chance);

if (foundItems.length > 0) {
const item = foundItems[Math.floor(Math.random() * foundItems.length)];
addItemToInventory(item.id);
addToScene(`You find a ${getItemTemplate(item.id).name}!`);

// Special item discovery messages
if (item.id === "silver-cross") {
addToScene("The cross feels warm in your hand, pulsing with holy energy.");
} else if (item.id === "bible") {
addToScene("The ancient text contains passages that might weaken undead creatures.");
}
} else {
addToScene("You search but find nothing of value.");
}
}

// ========== COMBAT FUNCTIONS ========== //
function startCombat(enemyType) {
gameState.inCombat = true;
gameState.currentEnemy = JSON.parse(JSON.stringify(gameState.enemies[enemyType]));

// Update combat UI
document.getElementById('combat-title').textContent = `COMBAT: ${gameState.currentEnemy.name}`;
document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
document.getElementById('enemy-max-hp').textContent = gameState.currentEnemy.maxHp;
document.getElementById('enemy-hp-bar').style.width = '100%';

// Update player stats in combat modal
document.getElementById('player-name').textContent = gameState.player.name;
document.getElementById('player-hp-combat').textContent = gameState.player.hp;
document.getElementById('player-max-hp-combat').textContent = gameState.player.maxHp;
document.getElementById('player-hp-bar').style.width = `${(gameState.player.hp / gameState.player.maxHp) * 100}%`;
document.getElementById('player-sanity-combat').textContent = gameState.player.sanity;
document.getElementById('player-max-sanity-combat').textContent = gameState.player.maxSanity;
document.getElementById('player-sanity-bar').style.width = `${(gameState.player.sanity / gameState.player.maxSanity) * 100}%`;

// Set combat log
const combatLog = document.getElementById('combat-log-modal');
combatLog.innerHTML = `<p>A ${gameState.currentEnemy.name} ATTACKS!</p>`;

// Special enemy intro messages
if (enemyType === "dracula") {
combatLog.innerHTML += `<p>"I AM DRACULA! YOU DARE CHALLENGE ME IN MY OWN DOMAIN?"</p>`;
} else if (enemyType === "brides") {
combatLog.innerHTML += `<p>The brides circle you with unnatural speed, their eyes glowing red.</p>`;
} else if (enemyType === "werewolf") {
combatLog.innerHTML 
