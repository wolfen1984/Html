<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle of the Undead - Level 1</title>
    <!-- Changed to a more authentic DOS font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Enhanced 80s DOS style */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace; /* Changed to authentic DOS terminal font */
            background-color: #000;
            color: #0f0;
            line-height: 1.2;
            height: 100vh;
            overflow: hidden;
            padding: 8px;
            position: relative;
            font-size: 18px;
            letter-spacing: 0.5px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        }
        
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .active {
            display: flex;
        }
        
        /* Loading Screen */
        #loading-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .loading-text {
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #0f0;
            animation: blink 1.5s infinite;
        }
        
        .floppy-disk {
            font-size: 60px;
            margin-bottom: 30px;
            animation: spin 2s linear infinite;
        }
        
        .progress-bar {
            width: 80%;
            height: 20px;
            border: 2px solid #0f0;
            margin-top: 20px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: #0f0;
            transition: width 0.5s ease;
        }
        
        /* Intro Screen */
        #intro-screen {
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .scrolling-intro {
            height: 80%;
            width: 90%;
            overflow-y: hidden;
            position: relative;
        }
        
        .intro-text {
            position: absolute;
            bottom: 0;
            width: 100%;
            animation: scroll-up 45s linear forwards;
            text-align: center;
            font-size: 18px;
            line-height: 1.4;
        }
        
        /* Game Screen */
        #game-screen {
            height: 100%;
        }
        
        .game-header {
            padding: 8px 5px;
            border-bottom: 1px solid #0f0;
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            background-color: #000;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            padding: 5px 8px;
        }
        
        .game-title {
            color: #0f0;
            font-weight: normal;
            text-transform: uppercase;
        }
        
        .game-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 18px;
            height: 60%;
            scroll-behavior: smooth;
            background-color: #000;
            border: 1px solid #0f0;
            margin-bottom: 5px;
            font-weight: normal;
        }
        
        .game-content p {
            margin-bottom: 8px;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            line-height: 1.3;
        }
        
        .input-line {
            display: flex;
            margin-top: 5px;
            align-items: center;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 5px;
        }
        
        .prompt {
            margin-right: 8px;
            color: #0f0;
            font-weight: bold;
        }
        
        .game-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 18px;
            outline: none;
            caret-color: #0f0;
            caret-shape: block;
            font-weight: normal;
        }
        
        .game-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            padding: 10px 0;
            border-top: 1px dashed #333;
            height: 30%;
            overflow-y: auto;
        }
        
        .game-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 5px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0;
            text-align: center;
            font-weight: normal;
        }
        
        .game-btn:hover, .game-btn:active {
            background-color: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        
        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #333;
        }
        
        .combat-btn {
            color: #f00;
            border-color: #f00;
        }
        
        .combat-btn:hover, .combat-btn:active {
            background-color: #f00;
            color: #000;
            box-shadow: 0 0 10px #f00;
        }
        
        /* Sound Controls */
        .sound-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            gap: 5px;
        }
        
        .sound-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 8px;
            font-family: 'VT323', monospace;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Lock Puzzle */
        .lock-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 20px;
        }
        
        .lock-display {
            font-size: 28px;
            letter-spacing: 10px;
            margin: 20px 0;
            color: #0f0;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 5px #0f0;
        }
        
        .lock-ring {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
        }
        
        .lock-digit {
            font-size: 32px;
            margin: 0 20px;
            color: #0f0;
            min-width: 50px;
            text-align: center;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 5px #0f0;
        }
        
        .lock-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Inventory */
        .inventory-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 20px;
        }
        
        .inventory-title {
            font-size: 28px;
            color: #0f0;
            margin-bottom: 20px;
            text-decoration: underline;
            font-family: 'VT323', monospace;
            text-shadow: 0 0 5px #0f0;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            max-width: 90%;
            margin-bottom: 30px;
        }
        
        .inventory-item {
            border: 1px solid #0f0;
            padding: 10px;
            min-width: 120px;
            text-align: center;
            background-color: #000;
            font-family: 'VT323', monospace;
        }
        
        /* Combat Screen */
        .combat-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 2px solid #f00;
            padding: 20px;
        }
        
        .combat-log {
            height: 60%;
            width: 90%;
            overflow-y: auto;
            border: 1px solid #f00;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #000;
            font-family: 'VT323', monospace;
        }
        
        /* Animations */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes scroll-up {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            body {
                font-size: 16px;
                padding: 5px;
            }
            
            .game-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
            
            .game-btn {
                padding: 8px 3px;
                font-size: 14px;
            }
            
            .lock-digit {
                font-size: 24px;
                margin: 0 10px;
            }
            
            .sound-controls {
                bottom: 5px;
                right: 5px;
            }
            
            .game-content {
                font-size: 16px;
                padding: 8px;
            }
            
            .game-input {
                font-size: 16px;
            }
        }
        
        /* Enhanced CRT effect */
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }
        
        /* Scanline effect */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.95; }
            10% { opacity: 0.97; }
            15% { opacity: 0.94; }
            20% { opacity: 0.99; }
            100% { opacity: 0.97; }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #0f0;
        }
        
        /* DOS-style cursor blink */
        @keyframes blink-cursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .game-input::placeholder {
            animation: blink-cursor 1s infinite;
            color: #0a0;
        }
        
        /* Status display enhancement */
        .game-header div {
            background-color: #000;
            padding: 2px 8px;
            border: 1px solid #0f0;
        }
        
        /* DOS-style text selection */
        ::selection {
            background-color: #0f0;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div class="floppy-disk">ðŸ’¾</div>
        <div class="loading-text">LOADING CASTLE OF THE UNDEAD...</div>
        <div>Inserting floppy disk... Reading track 0...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>
    
    <!-- Intro Screen -->
    <div id="intro-screen" class="screen">
        <div class="scrolling-intro">
            <div class="intro-text">
                <h1>CASTLE OF THE UNDEAD</h1>
                <br><br>
                <p>*** A Text Adventure ***</p>
                <br><br>
                <p>Copyright (c) 1985 Dark Arts Software</p>
                <p>All rights reserved</p>
                <br><br>
                <p>Version 1.0</p>
                <br><br>
                <p>You stand before the ominous Castle of the Undead,</p>
                <p>a place shunned by villagers for generations.</p>
                <p>Legend says the castle holds untold treasures,</p>
                <p>but is guarded by creatures of the night.</p>
                <br>
                <p>The once-grand gates are now weathered and locked.</p>
                <p>To enter, you must solve the ancient puzzle.</p>
                <br>
                <p>Beware the skeleton guard who never sleeps,</p>
                <p>and the gargoyles whose stone eyes see all.</p>
                <br><br>
                <p>Commands: LOOK, EXAMINE, TALK, USE, TAKE, FIGHT</p>
                <p>INVENTORY to view items, HELP for assistance.</p>
                <br><br><br>
                <p>Press BEGIN to start your adventure...</p>
            </div>
        </div>
        <button id="begin-btn" class="game-btn" style="margin-top: 20px; width: 80%;">BEGIN ADVENTURE</button>
    </div>
    
    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div class="game-title">CASTLE OF THE UNDEAD - LEVEL 1</div>
            <div>HEALTH: <span id="health">100</span> | GOLD: <span id="gold">0</span></div>
        </div>
        
        <div class="game-content" id="game-text">
            <p>Initializing game environment...</p>
            <p>> CASTLE OF THE UNDEAD loaded successfully.</p>
        </div>
        
        <div class="game-buttons" id="action-buttons">
            <!-- Buttons will be generated by JavaScript -->
        </div>
        
        <div class="input-line">
            <span class="prompt">&gt;</span>
            <input type="text" class="game-input" id="command-input" placeholder="Type command or use buttons..." autocomplete="off">
        </div>
    </div>
    
    <!-- Lock Puzzle Interface -->
    <div id="lock-container" class="lock-container">
        <h2>ANCIENT IRON LOCK</h2>
        <p>The lock has four rotating rings with numbers 0-9.</p>
        <p>Find the correct combination to unlock the gate.</p>
        
        <div class="lock-display" id="lock-display">0 0 0 0</div>
        
        <div class="lock-ring">
            <button class="game-btn lock-up" data-ring="0">â†‘</button>
            <div class="lock-digit" id="digit-0">0</div>
            <button class="game-btn lock-down" data-ring="0">â†“</button>
        </div>
        
        <div class="lock-ring">
            <button class="game-btn lock-up" data-ring="1">â†‘</button>
            <div class="lock-digit" id="digit-1">0</div>
            <button class="game-btn lock-down" data-ring="1">â†“</button>
        </div>
        
        <div class="lock-ring">
            <button class="game-btn lock-up" data-ring="2">â†‘</button>
            <div class="lock-digit" id="digit-2">0</div>
            <button class="game-btn lock-down" data-ring="2">â†“</button>
        </div>
        
        <div class="lock-ring">
            <button class="game-btn lock-up" data-ring="3">â†‘</button>
            <div class="lock-digit" id="digit-3">0</div>
            <button class="game-btn lock-down" data-ring="3">â†“</button>
        </div>
        
        <div class="lock-controls">
            <button class="game-btn" id="try-lock">TRY COMBINATION</button>
            <button class="game-btn" id="exit-lock">EXIT</button>
        </div>
        
        <p id="lock-message" style="margin-top: 20px; color: #ff0;"></p>
    </div>
    
    <!-- Inventory Interface -->
    <div id="inventory-container" class="inventory-container">
        <div class="inventory-title">INVENTORY</div>
        <div class="inventory-items" id="inventory-items">
            <!-- Items will be added here -->
        </div>
        <button class="game-btn" id="exit-inventory">CLOSE INVENTORY</button>
    </div>
    
    <!-- Combat Interface -->
    <div id="combat-container" class="combat-container">
        <h2 style="color: #f00;">COMBAT</h2>
        <div class="combat-log" id="combat-log">
            <!-- Combat messages will appear here -->
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%;">
            <button class="game-btn combat-btn" id="attack-btn">ATTACK</button>
            <button class="game-btn combat-btn" id="defend-btn">DEFEND</button>
            <button class="game-btn combat-btn" id="use-item-btn">USE ITEM</button>
            <button class="game-btn combat-btn" id="flee-btn">FLEE</button>
        </div>
    </div>
    
    <!-- Sound Controls -->
    <div class="sound-controls">
        <button class="sound-btn" id="toggle-sound">ðŸ”Š ON</button>
        <button class="sound-btn" id="toggle-music">ðŸŽµ ON</button>
    </div>
    
    <script>
        // ==============================================
        // GAME STATE SAVING AND LOADING
        // ==============================================
        
        // Function to save game state to localStorage
        function saveGameState() {
            const saveData = {
                health: gameState.health,
                gold: gameState.gold,
                inventory: gameState.inventory,
                gameProgress: gameState.gameProgress,
                currentLevel: 2, // Player is progressing to level 2
                lockSolved: gameState.gameProgress.lockSolved,
                skeletonDefeated: gameState.gameProgress.skeletonDefeated,
                enteredCastle: gameState.gameProgress.enteredCastle
            };
            
            localStorage.setItem('castleOfTheUndead_save', JSON.stringify(saveData));
            console.log('Game state saved:', saveData);
        }
        
        // Function to load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('castleOfTheUndead_save');
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    
                    // Only load stats if they exist
                    if (saveData.health !== undefined) gameState.health = saveData.health;
                    if (saveData.gold !== undefined) gameState.gold = saveData.gold;
                    if (saveData.inventory !== undefined) gameState.inventory = saveData.inventory;
                    
                    // Merge game progress
                    if (saveData.gameProgress) {
                        gameState.gameProgress = {
                            ...gameState.gameProgress,
                            ...saveData.gameProgress
                        };
                    }
                    
                    // If player already entered castle, redirect to level 2
                    if (saveData.enteredCastle) {
                        addGameText("> Loading Level 2...");
                        setTimeout(() => {
                            window.location.href = 'level2.html';
                        }, 1000);
                    }
                    
                    console.log('Game state loaded:', saveData);
                    return true;
                } catch (error) {
                    console.error('Error loading game state:', error);
                }
            }
            return false;
        }
        
        // Function to advance to level 2
        function advanceToLevel2() {
            // Prevent multiple clicks
            if (gameState.gameProgress.enteredCastle) return;
            
            // Mark as entered castle
            gameState.gameProgress.enteredCastle = true;
            
            // Save current game state
            saveGameState();
            
            // Show transition message
            addGameText("The gates swing open with a mighty groan!");
            addGameText("You step through into the dark courtyard of the castle...");
            addGameText("> LEVEL 1 COMPLETE!");
            addGameText("> Progress saved. Loading Level 2...");
            
            // Play victory sound
            AudioManager.playSound('level_complete');
            
            // Disable all buttons during transition
            disableAllButtons();
            
            // Redirect to level2.html after a delay
            setTimeout(() => {
                window.location.href = 'level2.html';
            }, 3000);
        }
        
        // Function to disable all buttons during transition
        function disableAllButtons() {
            const buttons = document.querySelectorAll('.game-btn');
            buttons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });
            commandInput.disabled = true;
        }
        
        // ==============================================
        // AUDIO MANAGER
        // ==============================================
        
        const AudioManager = {
            audioContext: null,
            soundEnabled: true,
            musicEnabled: true,
            backgroundSource: null,
            
            init: function() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio context created successfully");
                } catch (error) {
                    console.error("Web Audio API is not supported:", error);
                }
            },
            
            playSound: function(type, options = {}) {
                if (!this.audioContext || !this.soundEnabled) return null;
                
                try {
                    switch(type) {
                        case 'button':
                            return this.playBeep(800, 0.1, 0.2);
                        case 'notification':
                            return this.playBeep(1200, 0.15, 0.3);
                        case 'combat_hit':
                            return this.playNoise(0.2, 0.5);
                        case 'combat_miss':
                            return this.playBeep(300, 0.1, 0.1);
                        case 'item_pickup':
                            return this.playBeepSequence([1000, 1200], 0.1);
                        case 'lock_click':
                            return this.playBeep(600, 0.05, 0.1);
                        case 'lock_success':
                            return this.playBeepSequence([800, 1000, 1200], 0.1);
                        case 'lock_fail':
                            return this.playBeep(400, 0.2, 0.1);
                        case 'floppy_load':
                            return this.playFloppySound();
                        case 'typewriter':
                            return this.playTypewriter();
                        case 'background':
                            if (this.musicEnabled) {
                                this.playBackgroundSound();
                            }
                            break;
                        case 'level_complete':
                            return this.playLevelComplete();
                    }
                } catch (error) {
                    console.error("Error playing sound:", error);
                }
                return null;
            },
            
            playBeep: function(frequency, duration, volume = 0.5) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
                
                return oscillator;
            },
            
            playBeepSequence: function(frequencies, duration) {
                let time = this.audioContext.currentTime;
                
                frequencies.forEach((freq, index) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'triangle';
                    
                    gainNode.gain.setValueAtTime(0, time);
                    gainNode.gain.linearRampToValueAtTime(0.3, time + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
                    
                    oscillator.start(time);
                    oscillator.stop(time + duration);
                    
                    time += duration * 1.5;
                });
            },
            
            playLevelComplete: function() {
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                let time = this.audioContext.currentTime;
                
                frequencies.forEach((freq, index) => {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, time);
                    gainNode.gain.linearRampToValueAtTime(0.3, time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.3);
                    
                    oscillator.start(time);
                    oscillator.stop(time + 0.3);
                    
                    time += 0.15;
                });
            },
            
            playNoise: function(duration, volume = 0.3) {
                const bufferSize = this.audioContext.sampleRate * duration;
                const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                
                const source = this.audioContext.createBufferSource();
                const gainNode = this.audioContext.createGain();
                
                source.buffer = buffer;
                source.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                source.start();
                return source;
            },
            
            playFloppySound: function() {
                let time = this.audioContext.currentTime;
                
                const motorUp = this.audioContext.createOscillator();
                const motorGain = this.audioContext.createGain();
                motorUp.connect(motorGain);
                motorGain.connect(this.audioContext.destination);
                motorUp.frequency.value = 50;
                motorUp.type = 'sawtooth';
                motorGain.gain.setValueAtTime(0, time);
                motorGain.gain.linearRampToValueAtTime(0.2, time + 0.3);
                motorUp.start(time);
                motorUp.stop(time + 0.3);
                
                time += 0.3;
                
                for (let i = 0; i < 5; i++) {
                    const seek = this.audioContext.createOscillator();
                    const seekGain = this.audioContext.createGain();
                    seek.connect(seekGain);
                    seekGain.connect(this.audioContext.destination);
                    seek.frequency.value = 800 + Math.random() * 400;
                    seek.type = 'square';
                    seekGain.gain.setValueAtTime(0.1, time);
                    seekGain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                    seek.start(time);
                    seek.stop(time + 0.05);
                    
                    time += 0.1 + Math.random() * 0.2;
                }
                
                for (let i = 0; i < 8; i++) {
                    const data = this.audioContext.createOscillator();
                    const dataGain = this.audioContext.createGain();
                    data.connect(dataGain);
                    dataGain.connect(this.audioContext.destination);
                    data.frequency.value = 1200 + Math.random() * 600;
                    data.type = 'sine';
                    dataGain.gain.setValueAtTime(0.05, time);
                    dataGain.gain.exponentialRampToValueAtTime(0.001, time + 0.02);
                    data.start(time);
                    data.stop(time + 0.02);
                    
                    time += 0.03;
                }
                
                time += 0.2;
                const click = this.audioContext.createOscillator();
                const clickGain = this.audioContext.createGain();
                click.connect(clickGain);
                clickGain.connect(this.audioContext.destination);
                click.frequency.value = 200;
                click.type = 'sine';
                clickGain.gain.setValueAtTime(0.2, time);
                clickGain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                click.start(time);
                click.stop(time + 0.1);
            },
            
            playTypewriter: function() {
                const time = this.audioContext.currentTime;
                const osc = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                osc.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                osc.frequency.value = 100 + Math.random() * 50;
                osc.type = 'square';
                
                gainNode.gain.setValueAtTime(0, time);
                gainNode.gain.linearRampToValueAtTime(0.05, time + 0.001);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
                
                osc.start(time);
                osc.stop(time + 0.03);
                
                return osc;
            },
            
            playBackgroundSound: function() {
                if (this.backgroundSource) {
                    this.backgroundSource.stop();
                }
                
                const bufferSize = this.audioContext.sampleRate * 2;
                const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    data[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = data[i];
                    data[i] *= 3.5;
                }
                
                this.backgroundSource = this.audioContext.createBufferSource();
                const gainNode = this.audioContext.createGain();
                
                this.backgroundSource.buffer = buffer;
                this.backgroundSource.loop = true;
                this.backgroundSource.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                gainNode.gain.value = 0.03;
                
                this.backgroundSource.start();
            },
            
            stopBackgroundSound: function() {
                if (this.backgroundSource) {
                    this.backgroundSource.stop();
                    this.backgroundSource = null;
                }
            },
            
            toggleSound: function() {
                this.soundEnabled = !this.soundEnabled;
                return this.soundEnabled;
            },
            
            toggleMusic: function() {
                this.musicEnabled = !this.musicEnabled;
                if (this.musicEnabled) {
                    this.playBackgroundSound();
                } else {
                    this.stopBackgroundSound();
                }
                return this.musicEnabled;
            }
        };
        
        // ==============================================
        // GAME STATE
        // ==============================================
        
        const gameState = {
            location: 'castle_gates',
            health: 100,
            gold: 0,
            inventory: [],
            gameProgress: {
                talkedToSkeleton: false,
                examinedChest: false,
                examinedEngravings: false,
                examinedGargoyles: false,
                lockSolved: false,
                skeletonDefeated: false,
                enteredCastle: false
            },
            lockCombination: [3, 7, 1, 9],
            currentLock: [0, 0, 0, 0],
            inCombat: false,
            combatEnemy: null,
            enemyHealth: 0
        };
        
        // ==============================================
        // GAME DATA
        // ==============================================
        
        const locations = {
            castle_gates: {
                name: "Outside Castle Gates",
                description: "You stand before the massive, weathered gates of the Castle of the Undead. The air is cold and still. To the north, the gates are sealed shut by a large iron lock with four rotating rings. A skeletal guard leans against the wall, its empty eye sockets fixed on you. Two stone gargoyle statues flank the gates, their expressions frozen in menacing snarls. To the east, there's an old broken chest. Strange engravings are visible on the castle wall.",
                items: ["rusty_key"],
                npcs: ["skeleton_guard"],
                objects: ["castle_gates", "engravings", "broken_chest", "gargoyle_statues"]
            }
        };
        
        const npcs = {
            skeleton_guard: {
                name: "Skeleton Guard",
                description: "A bony sentry clad in tattered armor. It clutches a rusty sword but doesn't seem immediately hostile.",
                dialogue: {
                    default: "The skeleton rattles: 'None shall pass! The gate is sealed by the ancient lock. Only those who know the combination may enter.'",
                    afterTalk: "The skeleton taps its bony fingers: 'The numbers... they are hidden in plain sight. Look to the guardians and the broken vessel.'",
                    afterClues: "The skeleton's jaw clatters: 'You have found the clues! Now solve the riddle of the lock.'",
                    afterDefeat: "The defeated skeleton lies in a pile of bones. You notice a small key among the remains."
                },
                combat: {
                    health: 40,
                    attack: 8,
                    defense: 3
                }
            }
        };
        
        const objects = {
            castle_gates: {
                name: "Castle Gates",
                description: "Massive oak doors reinforced with iron bands. They're secured by a large, intricate lock with four rotating rings, each bearing numbers 0-9.",
                examine: "The lock appears ancient but well-maintained. The rings turn smoothly. You'll need to find the correct 4-number combination to open it."
            },
            engravings: {
                name: "Engravings on Wall",
                description: "Faded symbols carved into the stone wall beside the gates.",
                examine: "You carefully examine the engravings. They depict four symbols: a moon (crescent), a sword, a crown, and a serpent. Below each symbol is a number: 3, 7, 1, 9. This might be important!"
            },
            broken_chest: {
                name: "Broken Chest",
                description: "A weather-beaten chest with a broken lid, lying on its side.",
                examine: "Inside the broken chest, you find a rusty key and a torn piece of parchment. The parchment reads: 'The guardians see all: first and last. The broken vessel holds the middle truth.'"
            },
            gargoyle_statues: {
                name: "Gargoyle Statues",
                description: "Two grotesque stone gargoyles perched on either side of the gates.",
                examine: "The left gargoyle holds a tablet with the Roman numeral VII (7). The right gargoyle has IX (9) carved into its base. Their stone eyes seem to follow your movements."
            }
        };
        
        const items = {
            rusty_key: {
                name: "Rusty Key",
                description: "An old iron key, covered in rust. It might open something.",
                usable: true
            },
            health_potion: {
                name: "Health Potion",
                description: "A small vial of red liquid. Restores 30 health.",
                usable: true
            }
        };
        
        // ==============================================
        // DOM ELEMENTS
        // ==============================================
        
        const loadingScreen = document.getElementById('loading-screen');
        const introScreen = document.getElementById('intro-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameText = document.getElementById('game-text');
        const actionButtons = document.getElementById('action-buttons');
        const commandInput = document.getElementById('command-input');
        const beginBtn = document.getElementById('begin-btn');
        const lockContainer = document.getElementById('lock-container');
        const inventoryContainer = document.getElementById('inventory-container');
        const combatContainer = document.getElementById('combat-container');
        const progressFill = document.getElementById('progress-fill');
        const toggleSoundBtn = document.getElementById('toggle-sound');
        const toggleMusicBtn = document.getElementById('toggle-music');
        
        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        // Sound-enabled button click handler
        function createSoundButton(text, action, className = '') {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = `game-btn ${className}`;
            button.addEventListener('click', function(e) {
                AudioManager.playSound('button');
                if (action) action();
            });
            return button;
        }
        
        // Add text to game display
        function addGameText(text) {
            const p = document.createElement('p');
            p.textContent = text;
            gameText.appendChild(p);
            gameText.scrollTop = gameText.scrollHeight;
            
            // Play notification sound for important messages
            if (text.includes("You take") || text.includes("Found") || text.includes("SUCCESS") || text.includes("defeated") || text.includes("LEVEL")) {
                AudioManager.playSound('notification');
            }
        }
        
        // Update stats display
        function updateStats() {
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('gold').textContent = gameState.gold;
        }
        
        // ==============================================
        // GAME INITIALIZATION
        // ==============================================
        
        function init() {
            // Load saved game state
            loadGameState();
            
            // Initialize audio manager
            AudioManager.init();
            
            // Play floppy loading sound during loading
            setTimeout(() => {
                AudioManager.playSound('floppy_load');
            }, 300);
            
            // Simulate loading
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(loadingInterval);
                    
                    setTimeout(() => {
                        loadingScreen.classList.remove('active');
                        introScreen.classList.add('active');
                    }, 500);
                }
                progressFill.style.width = `${progress}%`;
            }, 200);
            
            // Begin button
            beginBtn.addEventListener('click', function() {
                AudioManager.playSound('button');
                startGame();
            });
            
            // Command input
            commandInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    AudioManager.playSound('typewriter');
                    processCommand(commandInput.value);
                    commandInput.value = '';
                }
            });
            
            // Sound control buttons
            toggleSoundBtn.addEventListener('click', function() {
                const enabled = AudioManager.toggleSound();
                this.textContent = enabled ? 'ðŸ”Š ON' : 'ðŸ”‡ OFF';
                AudioManager.playSound('button');
            });
            
            toggleMusicBtn.addEventListener('click', function() {
                const enabled = AudioManager.toggleMusic();
                this.textContent = enabled ? 'ðŸŽµ ON' : 'ðŸŽµ OFF';
                AudioManager.playSound('button');
            });
            
            // Lock puzzle controls
            document.querySelectorAll('.lock-up, .lock-down').forEach(btn => {
                btn.addEventListener('click', function() {
                    AudioManager.playSound('lock_click');
                    const ring = parseInt(this.getAttribute('data-ring'));
                    const isUp = this.classList.contains('lock-up');
                    adjustLock(ring, isUp);
                });
            });
            
            document.getElementById('try-lock').addEventListener('click', function() {
                AudioManager.playSound('button');
                tryLockCombination();
            });
            
            document.getElementById('exit-lock').addEventListener('click', function() {
                AudioManager.playSound('button');
                lockContainer.style.display = 'none';
                gameScreen.style.display = 'flex';
            });
            
            // Inventory controls
            document.getElementById('exit-inventory').addEventListener('click', function() {
                AudioManager.playSound('button');
                inventoryContainer.style.display = 'none';
                gameScreen.style.display = 'flex';
            });
            
            // Combat controls
            document.getElementById('attack-btn').addEventListener('click', function() {
                AudioManager.playSound('button');
                combatAction('attack');
            });
            
            document.getElementById('defend-btn').addEventListener('click', function() {
                AudioManager.playSound('button');
                combatAction('defend');
            });
            
            document.getElementById('use-item-btn').addEventListener('click', function() {
                AudioManager.playSound('button');
                combatAction('use_item');
            });
            
            document.getElementById('flee-btn').addEventListener('click', function() {
                AudioManager.playSound('button');
                combatAction('flee');
            });
            
            // Update health and gold display
            updateStats();
        }
        
        // ==============================================
        // GAME FLOW FUNCTIONS
        // ==============================================
        
        function startGame() {
            introScreen.classList.remove('active');
            gameScreen.classList.add('active');
            
            // Start background ambiance
            AudioManager.playSound('background');
            
            addGameText("> CASTLE OF THE UNDEAD initialized.");
            addGameText("> System time: 1985-10-31 18:30");
            addGameText("> Memory: 64KB OK");
            addGameText("> Level 1: Castle Gates");
            addGameText("");
            
            setTimeout(() => {
                describeLocation();
            }, 500);
        }
        
        function describeLocation() {
            const location = locations[gameState.location];
            addGameText(`** ${location.name} **`);
            addGameText(location.description);
            updateActionButtons();
        }
        
        function updateActionButtons() {
            actionButtons.innerHTML = '';
            
            // If player has entered castle, show only continue button
            if (gameState.gameProgress.enteredCastle) {
                actionButtons.appendChild(createSoundButton('CONTINUE TO LEVEL 2', () => {
                    advanceToLevel2();
                }));
                return;
            }
            
            if (gameState.inCombat) {
                actionButtons.appendChild(createSoundButton('ATTACK', () => combatAction('attack'), 'combat-btn'));
                actionButtons.appendChild(createSoundButton('DEFEND', () => combatAction('defend'), 'combat-btn'));
                actionButtons.appendChild(createSoundButton('USE ITEM', () => combatAction('use_item'), 'combat-btn'));
                actionButtons.appendChild(createSoundButton('FLEE', () => combatAction('flee'), 'combat-btn'));
                return;
            }
            
            const location = locations[gameState.location];
            
            // Always show these buttons
            actionButtons.appendChild(createSoundButton('LOOK', () => {
                addGameText(location.description);
            }));
            
            actionButtons.appendChild(createSoundButton('INVENTORY', showInventory));
            
            // Show NPC buttons if NPCs exist and not defeated
            if (location.npcs && location.npcs.length > 0) {
                location.npcs.forEach(npcId => {
                    const npc = npcs[npcId];
                    if (npcId === 'skeleton_guard' && !gameState.gameProgress.skeletonDefeated) {
                        actionButtons.appendChild(createSoundButton(`TALK to ${npc.name}`, () => talkToNPC(npcId)));
                        actionButtons.appendChild(createSoundButton(`FIGHT ${npc.name}`, () => startCombat(npcId)));
                    }
                });
            }
            
            // Show object examination buttons
            if (location.objects && location.objects.length > 0) {
                location.objects.forEach(objId => {
                    const obj = objects[objId];
                    actionButtons.appendChild(createSoundButton(`EXAMINE ${obj.name}`, () => examineObject(objId)));
                });
            }
            
            // Show item pickup button if items exist
            if (location.items && location.items.length > 0 && !gameState.inventory.includes(location.items[0])) {
                actionButtons.appendChild(createSoundButton(`TAKE ${items[location.items[0]].name}`, () => takeItem(location.items[0])));
            }
            
            // CHECK GATES button - behavior changes based on lock status
            const checkGatesAction = () => {
                if (gameState.gameProgress.lockSolved) {
                    addGameText("The gates are now unlocked! You can enter the castle.");
                    // Auto-add ENTER CASTLE button
                    if (!document.querySelector('#enter-castle-btn')) {
                        const enterBtn = createSoundButton('ENTER CASTLE', () => {
                            addGameText("You push the heavy gates open...");
                            advanceToLevel2();
                        });
                        enterBtn.id = 'enter-castle-btn';
                        actionButtons.appendChild(enterBtn);
                    }
                } else {
                    addGameText("The gates are locked by the ancient iron lock. You need to solve the combination.");
                    showLockPuzzle();
                }
            };
            
            actionButtons.appendChild(createSoundButton('CHECK GATES', checkGatesAction));
            
            // Show ENTER CASTLE button if lock is already solved
            if (gameState.gameProgress.lockSolved && !gameState.gameProgress.enteredCastle) {
                const enterBtn = createSoundButton('ENTER CASTLE', () => {
                    addGameText("You push the heavy gates open...");
                    advanceToLevel2();
                });
                enterBtn.id = 'enter-castle-btn';
                actionButtons.appendChild(enterBtn);
            }
            
            actionButtons.appendChild(createSoundButton('HELP', () => {
                addGameText("Available commands: LOOK, EXAMINE [object], TALK [NPC], TAKE [item], USE [item], INVENTORY, FIGHT [enemy], ENTER CASTLE.");
                addGameText("Solve puzzles to progress. Find the lock combination to enter the castle.");
            }));
        }
        
        // ==============================================
        // COMMAND PROCESSING
        // ==============================================
        
        function processCommand(command) {
            if (!command.trim()) return;
            
            addGameText(`> ${command}`);
            command = command.toLowerCase().trim();
            
            if (gameState.inCombat) {
                processCombatCommand(command);
                return;
            }
            
            const parts = command.split(' ');
            const action = parts[0];
            const target = parts.slice(1).join(' ');
            
            switch(action) {
                case 'look':
                    addGameText(locations[gameState.location].description);
                    break;
                    
                case 'examine':
                    if (target) {
                        examineCommand(target);
                    } else {
                        addGameText("Examine what?");
                    }
                    break;
                    
                case 'talk':
                    if (target.includes('skeleton')) {
                        talkToNPC('skeleton_guard');
                    } else {
                        addGameText("There's no one by that name here.");
                    }
                    break;
                    
                case 'take':
                    if (target.includes('key')) {
                        takeItem('rusty_key');
                    } else {
                        addGameText("You can't take that.");
                    }
                    break;
                    
                case 'use':
                    if (target.includes('key')) {
                        if (gameState.inventory.includes('rusty_key')) {
                            addGameText("You try the rusty key on the lock, but it doesn't fit. This key must be for something else.");
                        } else {
                            addGameText("You don't have that item.");
                        }
                    } else if (target.includes('potion')) {
                        useItem('health_potion');
                    } else {
                        addGameText("Use what?");
                    }
                    break;
                    
                case 'inventory':
                    showInventory();
                    break;
                    
                case 'fight':
                    if (target.includes('skeleton')) {
                        startCombat('skeleton_guard');
                    } else {
                        addGameText("You can't fight that.");
                    }
                    break;
                    
                case 'enter':
                case 'open':
                case 'go':
                    if (target.includes('gate') || target.includes('castle') || target.includes('north')) {
                        if (gameState.gameProgress.lockSolved) {
                            addGameText("You push the heavy gates open...");
                            advanceToLevel2();
                        } else {
                            addGameText("The gates are locked. You need to solve the combination first.");
                        }
                    }
                    break;
                    
                case 'help':
                    addGameText("Commands: LOOK, EXAMINE [object], TALK [NPC], TAKE [item], USE [item], INVENTORY, FIGHT [enemy], ENTER CASTLE.");
                    addGameText("Solve puzzles to progress. Find the lock combination to enter the castle.");
                    break;
                    
                case 'save':
                    saveGameState();
                    addGameText("Game progress saved!");
                    break;
                    
                default:
                    addGameText("I don't understand that command. Type HELP for assistance.");
            }
            
            updateActionButtons();
        }
        
        function examineCommand(target) {
            const location = locations[gameState.location];
            
            if (target.includes('engrav')) {
                examineObject('engravings');
            } else if (target.includes('chest')) {
                examineObject('broken_chest');
            } else if (target.includes('gargoyle') || target.includes('statue')) {
                examineObject('gargoyle_statues');
            } else if (target.includes('gate') || target.includes('lock')) {
                examineObject('castle_gates');
            } else if (target.includes('skeleton')) {
                addGameText(npcs['skeleton_guard'].description);
            } else {
                addGameText("You don't see that here.");
            }
        }
        
        // ==============================================
        // GAME OBJECT INTERACTIONS
        // ==============================================
        
        function examineObject(objId) {
            const obj = objects[objId];
            addGameText(`You examine the ${obj.name.toLowerCase()}:`);
            addGameText(obj.examine);
            
            // Update game progress
            if (objId === 'engravings') gameState.gameProgress.examinedEngravings = true;
            if (objId === 'broken_chest') gameState.gameProgress.examinedChest = true;
            if (objId === 'gargoyle_statues') gameState.gameProgress.examinedGargoyles = true;
            
            // Give combination hint if all clues found
            if (gameState.gameProgress.examinedEngravings && 
                gameState.gameProgress.examinedChest && 
                gameState.gameProgress.examinedGargoyles) {
                addGameText("You've found all the clues! The lock combination must be 3, 7, 1, 9.");
                AudioManager.playSound('notification');
            }
            
            updateActionButtons();
        }
        
        function talkToNPC(npcId) {
            const npc = npcs[npcId];
            
            if (!gameState.gameProgress.talkedToSkeleton) {
                addGameText(npc.dialogue.default);
                gameState.gameProgress.talkedToSkeleton = true;
            } else if (gameState.gameProgress.examinedEngravings && 
                      gameState.gameProgress.examinedChest && 
                      gameState.gameProgress.examinedGargoyles) {
                addGameText(npc.dialogue.afterClues);
            } else {
                addGameText(npc.dialogue.afterTalk);
            }
            
            AudioManager.playSound('notification');
            updateActionButtons();
        }
        
        function takeItem(itemId) {
            const location = locations[gameState.location];
            
            if (location.items && location.items.includes(itemId) && !gameState.inventory.includes(itemId)) {
                gameState.inventory.push(itemId);
                addGameText(`You take the ${items[itemId].name}.`);
                AudioManager.playSound('item_pickup');
                
                // Remove from location
                location.items = [];
                updateActionButtons();
            } else {
                addGameText("You can't take that.");
            }
        }
        
        function useItem(itemId) {
            if (gameState.inventory.includes(itemId)) {
                if (itemId === 'health_potion') {
                    gameState.health = Math.min(100, gameState.health + 30);
                    addGameText("You drink the health potion. You feel rejuvenated! Health +30");
                    AudioManager.playSound('notification');
                    removeFromInventory(itemId);
                    updateStats();
                }
            } else {
                addGameText("You don't have that item.");
            }
        }
        
        function showInventory() {
            inventoryContainer.style.display = 'flex';
            gameScreen.style.display = 'none';
            
            const inventoryItems = document.getElementById('inventory-items');
            inventoryItems.innerHTML = '';
            
            if (gameState.inventory.length === 0) {
                inventoryItems.innerHTML = '<p>Your inventory is empty.</p>';
            } else {
                gameState.inventory.forEach(itemId => {
                    const item = items[itemId];
                    const div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.innerHTML = `<strong>${item.name}</strong><br>${item.description}`;
                    if (item.usable) {
                        const useBtn = document.createElement('button');
                        useBtn.className = 'game-btn';
                        useBtn.textContent = 'USE';
                        useBtn.style.marginTop = '5px';
                        useBtn.addEventListener('click', () => {
                            AudioManager.playSound('button');
                            useItem(itemId);
                            inventoryContainer.style.display = 'none';
                            gameScreen.style.display = 'flex';
                        });
                        div.appendChild(useBtn);
                    }
                    inventoryItems.appendChild(div);
                });
            }
        }
        
        function removeFromInventory(itemId) {
            const index = gameState.inventory.indexOf(itemId);
            if (index > -1) {
                gameState.inventory.splice(index, 1);
            }
        }
        
        // ==============================================
        // LOCK PUZZLE FUNCTIONS
        // ==============================================
        
        function showLockPuzzle() {
            lockContainer.style.display = 'flex';
            gameScreen.style.display = 'none';
            
            // Reset lock display
            gameState.currentLock = [0, 0, 0, 0];
            updateLockDisplay();
            document.getElementById('lock-message').textContent = '';
        }
        
        function adjustLock(ring, isUp) {
            if (isUp) {
                gameState.currentLock[ring] = (gameState.currentLock[ring] + 1) % 10;
            } else {
                gameState.currentLock[ring] = (gameState.currentLock[ring] - 1 + 10) % 10;
            }
            updateLockDisplay();
        }
        
        function updateLockDisplay() {
            for (let i = 0; i < 4; i++) {
                document.getElementById(`digit-${i}`).textContent = gameState.currentLock[i];
            }
            document.getElementById('lock-display').textContent = 
                `${gameState.currentLock[0]} ${gameState.currentLock[1]} ${gameState.currentLock[2]} ${gameState.currentLock[3]}`;
        }
        
        function tryLockCombination() {
            const lockMsg = document.getElementById('lock-message');
            
            let correct = true;
            for (let i = 0; i < 4; i++) {
                if (gameState.currentLock[i] !== gameState.lockCombination[i]) {
                    correct = false;
                    break;
                }
            }
            
            if (correct) {
                lockMsg.textContent = "SUCCESS! The lock clicks open. The gates are now unlocked!";
                lockMsg.style.color = '#0f0';
                gameState.gameProgress.lockSolved = true;
                AudioManager.playSound('lock_success');
                
                setTimeout(() => {
                    lockContainer.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    addGameText("*** LOCK SOLVED! ***");
                    addGameText("The ancient iron lock clicks open with a satisfying clunk.");
                    addGameText("The massive castle gates are now unlocked!");
                    addGameText("Type 'ENTER CASTLE' or click the 'ENTER CASTLE' button to proceed to Level 2.");
                    
                    // Update buttons to include ENTER CASTLE option
                    updateActionButtons();
                }, 2000);
            } else {
                lockMsg.textContent = "The lock doesn't budge. Try another combination.";
                lockMsg.style.color = '#f00';
                AudioManager.playSound('lock_fail');
            }
        }
        
        // ==============================================
        // COMBAT FUNCTIONS
        // ==============================================
        
        function startCombat(enemyId) {
            gameState.inCombat = true;
            gameState.combatEnemy = enemyId;
            gameState.enemyHealth = npcs[enemyId].combat.health;
            
            combatContainer.style.display = 'flex';
            gameScreen.style.display = 'none';
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML = '';
            
            addCombatText(`COMBAT STARTED: You face the ${npcs[enemyId].name}!`);
            addCombatText(`Your Health: ${gameState.health} | Enemy Health: ${gameState.enemyHealth}`);
            addCombatText("Choose your action: ATTACK, DEFEND, USE ITEM, or FLEE");
        }
        
        function combatAction(action) {
            const enemy = npcs[gameState.combatEnemy];
            const combatLog = document.getElementById('combat-log');
            
            switch(action) {
                case 'attack':
                    // Player attack
                    const playerDamage = Math.max(1, Math.floor(Math.random() * 15) + 5 - enemy.combat.defense);
                    gameState.enemyHealth -= playerDamage;
                    addCombatText(`You strike the ${enemy.name} for ${playerDamage} damage!`);
                    AudioManager.playSound('combat_hit');
                    
                    // Check if enemy defeated
                    if (gameState.enemyHealth <= 0) {
                        endCombat(true);
                        return;
                    }
                    
                    // Enemy attack
                    const enemyDamage = Math.max(1, Math.floor(Math.random() * enemy.combat.attack) + 3);
                    gameState.health -= enemyDamage;
                    addCombatText(`The ${enemy.name} attacks you for ${enemyDamage} damage!`);
                    AudioManager.playSound('combat_hit');
                    
                    // Check if player defeated
                    if (gameState.health <= 0) {
                        endCombat(false);
                        return;
                    }
                    
                    addCombatText(`Your Health: ${gameState.health} | Enemy Health: ${gameState.enemyHealth}`);
                    break;
                    
                case 'defend':
                    // Player defends (reduced damage)
                    addCombatText("You raise your guard, preparing to defend.");
                    
                    // Enemy attack with reduced damage
                    const reducedDamage = Math.max(1, Math.floor(Math.random() * enemy.combat.attack));
                    gameState.health -= reducedDamage;
                    addCombatText(`The ${enemy.name} attacks you for ${reducedDamage} damage (reduced by defense)!`);
                    
                    // Check if player defeated
                    if (gameState.health <= 0) {
                        endCombat(false);
                        return;
                    }
                    
                    addCombatText(`Your Health: ${gameState.health} | Enemy Health: ${gameState.enemyHealth}`);
                    break;
                    
                case 'use_item':
                    addCombatText("You open your inventory during combat...");
                    showInventory();
                    break;
                    
                case 'flee':
                    addCombatText("You attempt to flee from combat!");
                    AudioManager.playSound('notification');
                    if (Math.random() > 0.5) {
                        addCombatText("You successfully escape!");
                        endCombat(false, true);
                    } else {
                        addCombatText("You fail to escape!");
                        AudioManager.playSound('combat_miss');
                        
                        // Enemy attack
                        const fleeDamage = Math.max(1, Math.floor(Math.random() * enemy.combat.attack) + 2);
                        gameState.health -= fleeDamage;
                        addCombatText(`The ${enemy.name} attacks you as you flee for ${fleeDamage} damage!`);
                        
                        // Check if player defeated
                        if (gameState.health <= 0) {
                            endCombat(false);
                            return;
                        }
                        
                        addCombatText(`Your Health: ${gameState.health} | Enemy Health: ${gameState.enemyHealth}`);
                    }
                    break;
            }
            
            updateStats();
        }
        
        function addCombatText(text) {
            const combatLog = document.getElementById('combat-log');
            const p = document.createElement('p');
            p.textContent = text;
            combatLog.appendChild(p);
            combatLog.scrollTop = combatLog.scrollHeight;
        }
        
        function processCombatCommand(command) {
            const parts = command.split(' ');
            const action = parts[0];
            
            switch(action) {
                case 'attack':
                    combatAction('attack');
                    break;
                case 'defend':
                    combatAction('defend');
                    break;
                case 'use':
                    combatAction('use_item');
                    break;
                case 'flee':
                    combatAction('flee');
                    break;
                default:
                    addCombatText("Invalid combat command. Use: attack, defend, use, flee");
            }
        }
        
        function endCombat(playerWon, fled = false) {
            const enemy = npcs[gameState.combatEnemy];
            
            if (playerWon) {
                addCombatText(`You defeated the ${enemy.name}!`);
                addCombatText("The skeleton collapses into a pile of bones. You find 25 gold and a health potion!");
                AudioManager.playSound('notification');
                
                gameState.gold += 25;
                gameState.inventory.push('health_potion');
                gameState.gameProgress.skeletonDefeated = true;
                
                setTimeout(() => {
                    combatContainer.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    gameState.inCombat = false;
                    
                    addGameText(`You defeated the ${enemy.name}! Found 25 gold and a health potion.`);
                    updateActionButtons();
                    updateStats();
                }, 3000);
            } else if (fled) {
                addCombatText("You fled from combat!");
                
                setTimeout(() => {
                    combatContainer.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    gameState.inCombat = false;
                    updateActionButtons();
                }, 2000);
            } else {
                addCombatText("You have been defeated...");
                addCombatText("GAME OVER");
                AudioManager.playSound('lock_fail');
                
                setTimeout(() => {
                    combatContainer.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    gameState.inCombat = false;
                    
                    addGameText("*** GAME OVER ***");
                    addGameText("You were defeated by the skeleton guard.");
                    addGameText("Type 'restart' to try again or reload the page.");
                    
                    // Add restart option
                    const restartBtn = createSoundButton('RESTART GAME', () => {
                        location.reload();
                    }, 'combat-btn');
                    actionButtons.innerHTML = '';
                    actionButtons.appendChild(restartBtn);
                }, 3000);
            }
        }
        
        // ==============================================
        // INITIALIZE GAME
        // ==============================================
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
