<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fighting Fantasy: The Island of the Undead - Level 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #e0e0c0;
            line-height: 1.4;
            padding: 0;
            overflow-x: hidden;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e0e0c0" width="100" height="100"/></svg>');
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        #main-menu {
            display: flex;
        }

        .active {
            display: flex !important;
        }

        .header {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0c0;
            margin-bottom: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;
            margin: 0;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            background-color: #0f0f0f;
        }

        .compact-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            justify-content: flex-start;
        }

        .footer {
            padding: 8px;
            border-top: 1px solid #e0e0c0;
            margin-top: 0;
            flex-shrink: 0;
            flex-grow: 0;
            background-color: #1a1a1a;
        }

        button {
            background-color: #1a1a1a;
            color: #e0e0c0;
            border: 1px solid #e0e0c0;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            width: 100%;
            min-height: 50px;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        button:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            border: 1px solid #e0e0c0;
            padding: 8px;
            background-color: #1a1a1a;
        }

        .stat-box {
            text-align: center;
            padding: 5px;
            min-width: 80px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffffa0;
        }

        .battle-area {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .combatant {
            text-align: center;
            width: 48%;
            min-width: 150px;
            margin-bottom: 10px;
            border: 1px solid #e0e0c0;
            padding: 10px;
            background-color: #1a1a1a;
        }

        .combatant-ascii {
            font-size: 12px;
            line-height: 1;
            margin: 5px 0;
            white-space: pre;
        }

        .health-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background-color: #a05050;
        }

        .story-text {
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .choice-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .choice-btn {
            text-align: left;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #e0e0c0;
            color: #e0e0c0;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .choice-btn:active {
            background-color: #3a3a1a;
            color: #ffffa0;
        }

        .dice-roll {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #e0e0c0;
            background-color: #1a1a1a;
        }

        .dice-result {
            font-size: 24px;
            font-weight: bold;
            color: #ffffa0;
            margin: 5px 0;
        }

        .combat-log {
            height: 120px;
            overflow-y: auto;
            border: 1px solid #e0e0c0;
            padding: 8px;
            margin-top: 10px;
            font-size: 13px;
            flex-shrink: 0;
            background-color: #1a1a1a;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
            margin-top: 10px;
        }

        .item {
            width: 48%;
            margin-bottom: 5px;
            border: 1px solid #e0e0c0;
            padding: 8px;
            min-width: 140px;
            background-color: #1a1a1a;
        }

        .item-special {
            border-color: #ffffa0;
            background-color: #2a2a1a;
        }

        .item-equipped {
            border-color: #a0ffa0;
            background-color: #1a2a1a;
        }

        .luck-test {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ffffa0;
            background-color: #2a2a1a;
        }

        .luck-result {
            font-weight: bold;
            margin: 5px 0;
            color: #ffffa0;
        }

        .success {
            color: #a0ffa0;
        }

        .failure {
            color: #ffa0a0;
        }

        .scrollable-container {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .game-over {
            text-align: center;
            padding: 20px;
        }

        .game-over-message {
            font-size: 18px;
            margin: 15px 0;
            color: #ffffa0;
        }

        .victory-message {
            color: #a0ffa0;
        }

        .defeat-message {
            color: #ffa0a0;
        }

        /* Popup Notification Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-box {
            background-color: #1a1a1a;
            border: 2px solid #e0e0c0;
            padding: 20px;
            max-width: 90%;
            width: 400px;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 255, 160, 0.3);
        }

        .popup-title {
            color: #ffffa0;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0c0;
            padding-bottom: 5px;
        }

        .popup-message {
            margin: 15px 0;
            line-height: 1.5;
        }

        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .popup-btn {
            flex: 1;
            padding: 10px;
            min-height: auto;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff5050;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .critical-hit {
            color: #ffffa0;
            font-weight: bold;
            animation: pulse 0.5s infinite;
        }

        .monster-name {
            color: #ffa0a0;
            font-weight: bold;
        }

        .market-item {
            border: 1px solid #e0e0c0;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }

        .item-action-btn {
            flex: 1;
            padding: 6px;
            font-size: 12px;
        }

        @media (max-height: 700px) {
            .header {
                padding: 5px;
            }
            
            .header pre {
                font-size: 10px;
                line-height: 1;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .content {
                padding: 8px;
            }
            
            button {
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }
            
            .footer {
                padding: 5px;
            }
            
            .popup-box {
                padding: 15px;
            }
        }

        @media (max-height: 500px) {
            .header pre {
                display: none;
            }
            
            .header {
                padding: 3px;
            }
            
            .content {
                padding: 5px;
            }
            
            button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <div class="header">
                <pre>
  _____ _    _ _____ _______ ______  _______ ______  
 |  ___| |  | |_   _|__   __|  ____|/ /_   _|  ____| 
 | |__ | |  | | | |    | |  | |__   ' /  | | | |__    
 |  __|| |  | | | |    | |  |  __|  <   | | |  __|   
 | |   | |__| |_| |_   | |  | |    . \ _| |_| |____  
 |_|    \____/|_____|  |_|  |_|    |\_|_____|______| 
                </pre>
                <h2>THE ISLAND OF THE UNDEAD - LEVEL 1</h2>
            </div>
            <div class="content">
                <div class="compact-list">
                    <button id="new-game">START NEW CAMPAIGN</button>
                    <button id="continue-game">CONTINUE CAMPAIGN</button>
                    <button id="select-level">SELECT LEVEL</button>
                    <button id="campaign-progress">CAMPAIGN PROGRESS</button>
                    <button id="rules-btn">HOW TO PLAY</button>
                    
                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-box">
                            <div>Current Level</div>
                            <div class="stat-value" id="menu-current-level">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Character</div>
                            <div class="stat-value" id="menu-character-level">-</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="menu-gold">-</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #a0a0a0;">
                        A Fighting Fantasy Campaign Adventure
                    </div>
                </div>
            </div>
            <div class="footer">
                <p>Enter if you dare... if you can survive!</p>
            </div>
        </div>

        <!-- Level Select Screen -->
        <div id="level-select-screen" class="screen">
            <div class="header">
                <h2>SELECT LEVEL</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <h3>Campaign Progress</h3>
                    <p>Choose a level to play. Levels are unlocked as you complete them.</p>
                    <div id="level-buttons" class="choice-list">
                        <!-- Level buttons will be generated here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-level-select">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Campaign Progress Screen -->
        <div id="progress-screen" class="screen">
            <div class="header">
                <h2>CAMPAIGN PROGRESS</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="progress-content">
                        <!-- Progress will be shown here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-progress">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Story Screen -->
        <div id="story-screen" class="screen">
            <div class="header">
                <h2 id="story-title">THE ISLAND OF THE UNDEAD</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Level: <span id="header-level">1</span></div>
                    <div>Skill: <span id="header-skill">0</span></div>
                    <div>Stamina: <span id="header-stamina">0</span>/<span id="header-max-stamina">0</span></div>
                    <div>Luck: <span id="header-luck">0</span></div>
                    <div>Gold: <span id="header-gold">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text" id="story-text">
                        <!-- Story text will appear here -->
                    </div>
                    <div class="choice-list" id="choice-list">
                        <!-- Choice buttons will appear here -->
                    </div>
                    <div id="dice-roll-section" style="display: none;">
                        <div class="dice-roll">
                            <div>Rolling 2 dice...</div>
                            <div class="dice-result" id="dice-result">?</div>
                            <div id="dice-total"></div>
                        </div>
                        <button id="continue-after-roll">CONTINUE</button>
                    </div>
                    <div id="luck-test-section" style="display: none;">
                        <div class="luck-test">
                            <h3>Test Your Luck</h3>
                            <div>Roll 2 dice. If the total is less than or equal to your Luck, you are lucky!</div>
                            <div class="dice-result" id="luck-dice-result">?</div>
                            <div class="luck-result" id="luck-result"></div>
                            <div>Your Luck will decrease by 1 after this test.</div>
                        </div>
                        <button id="continue-after-luck">CONTINUE</button>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="inventory-btn">INVENTORY</button>
                <button id="market-btn">SUPPLIES</button>
                <button id="save-game">SAVE GAME</button>
            </div>
        </div>

        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <div class="header">
                <h2>COMBAT</h2>
                <div class="stats" style="margin: 5px 0 0 0; padding: 4px; font-size: 12px;">
                    <div>Level: <span id="combat-level">1</span></div>
                    <div>Skill: <span id="combat-skill">0</span></div>
                    <div>Stamina: <span id="combat-stamina">0</span>/<span id="combat-max-stamina">0</span></div>
                    <div>Luck: <span id="combat-luck">0</span></div>
                </div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="battle-area">
                        <div class="combatant">
                            <h3>YOU</h3>
                            <div class="combatant-ascii">
    /\
   /  \
  /    \
 /______\
   |  |
   |  |
  /    \
                            </div>
                            <div>Skill: <span id="player-combat-skill">0</span></div>
                            <div>Stamina: <span id="player-combat-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                        <div class="combatant">
                            <h3 id="enemy-name">ENEMY</h3>
                            <div class="combatant-ascii" id="enemy-ascii">
     /\
    /**\
   /****\
  /______\
   |    |
   |    |
  /      \
                            </div>
                            <div>Skill: <span id="enemy-skill">0</span></div>
                            <div>Stamina: <span id="enemy-stamina">0</span></div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="combat-log" id="combat-log">
                        <!-- Combat log will appear here -->
                    </div>
                    <div class="dice-roll" id="combat-dice-roll" style="display: none;">
                        <h4>Combat Round</h4>
                        <div>Your Attack Strength: <span id="player-attack">0</span></div>
                        <div>Enemy Attack Strength: <span id="enemy-attack">0</span></div>
                        <div id="combat-result"></div>
                    </div>
                    <button id="attack-btn" style="margin-top: 10px;">ATTACK</button>
                    <button id="use-luck-combat" style="display: none;">TEST YOUR LUCK</button>
                    <button id="flee-combat" style="background-color: #3a1a1a;">FLEE</button>
                    <button id="victory-continue" style="display: none; background-color: #1a3a1a;">CONTINUE YOUR QUEST</button>
                </div>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <div class="header">
                <h2>INVENTORY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="stats">
                        <div class="stat-box">
                            <div>Level</div>
                            <div class="stat-value" id="inv-level">1</div>
                        </div>
                        <div class="stat-box">
                            <div>Skill</div>
                            <div class="stat-value" id="inv-skill">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Stamina</div>
                            <div class="stat-value" id="inv-stamina">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Luck</div>
                            <div class="stat-value" id="inv-luck">0</div>
                        </div>
                        <div class="stat-box">
                            <div>Gold</div>
                            <div class="stat-value" id="inv-gold">0</div>
                        </div>
                    </div>
                    
                    <h3>Provisions: <span id="provisions-count">0</span></h3>
                    <button id="eat-provision" style="margin-bottom: 10px;">EAT PROVISION (Restore 4 Stamina)</button>
                    
                    <h3>Equipped Items:</h3>
                    <div id="equipped-items">
                        <!-- Equipped items will appear here -->
                    </div>
                    
                    <h3>Backpack:</h3>
                    <div id="inventory-list">
                        <!-- Inventory items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-inventory">BACK TO STORY</button>
            </div>
        </div>

        <!-- Market Screen -->
        <div id="market-screen" class="screen">
            <div class="header">
                <h2>EXPEDITION SUPPLIES</h2>
                <div>Your Gold: <span id="market-gold">0</span></div>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div id="market-items">
                        <!-- Market items will appear here -->
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-market">BACK TO STORY</button>
            </div>
        </div>

        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <div class="header">
                <h2>HOW TO PLAY</h2>
            </div>
            <div class="content">
                <div class="scrollable-container">
                    <div class="story-text">
                        <h3>Fighting Fantasy Game System</h3>
                        <p>In this adventure, you control the action by making choices and rolling dice.</p>
                        
                        <h4>Your Attributes:</h4>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><strong>SKILL</strong>: Your fighting ability. Determines how good you are in combat.</li>
                            <li><strong>STAMINA</strong>: Your health. If it reaches zero, you die.</li>
                            <li><strong>LUCK</strong>: Your good fortune. Test your Luck to change your fate.</li>
                        </ul>
                        
                        <h4>Combat:</h4>
                        <p>When you enter combat, you and your enemy roll 2 dice and add your Skill scores.</p>
                        <p>The higher score wins and inflicts 2 damage on the loser.</p>
                        <p>If scores are equal, you both miss.</p>
                        
                        <h4>Testing Your Luck:</h4>
                        <p>You may Test Your Luck in certain situations. Roll 2 dice:</p>
                        <ul style="margin-left: 20px;">
                            <li>If the total is LESS than or equal to your current Luck: You are Lucky!</li>
                            <li>If the total is GREATER than your current Luck: You are Unlucky!</li>
                        </ul>
                        <p>Each time you Test Your Luck, your Luck score decreases by 1.</p>
                        
                        <h4>Provisions:</h4>
                        <p>You begin with 10 Provisions. Each Provision restores 4 Stamina when eaten.</p>
                        <p>You can eat Provisions during your adventure (except during combat).</p>

                        <h4>Equipment:</h4>
                        <p>You can find and purchase weapons, armor, and magical items.</p>
                        <p>Weapons increase your Skill in combat.</p>
                        <p>Armor increases your maximum Stamina.</p>
                        <p>Magical items provide special abilities.</p>
                        
                        <h4>Campaign System:</h4>
                        <p>This is a 5-level campaign. Your character, inventory, and gold carry over between levels.</p>
                        <p>Complete each level to unlock the next one. Save your game frequently!</p>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="back-from-rules">BACK TO MAIN MENU</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <div class="header">
                <h2>YOUR QUEST IS OVER</h2>
            </div>
            <div class="content">
                <div class="game-over">
                    <pre>
   _____                         ____
  / ____|                       / __ \
 | |  __  __ _ _ __ ___   ___  | |  | |_   _____ _ __
 | | |_ |/ _` | '_ ` _ \ / _ \ | |  | \ \ / / _ \ '__|
 | |__| | (_| | | | | | |  __/ | |__| |\ V /  __/ |
  \_____|\__,_|_| |_| |_|\___|  \____/  \_/ \___|_|
                    </pre>
                    <div class="game-over-message" id="game-over-message">
                        You have failed in your quest.
                    </div>
                    <div style="margin: 20px 0;">
                        <div>Level: <span id="game-over-level">1</span></div>
                        <div>Location: <span id="game-over-location">Unknown</span></div>
                        <div>Paragraph: <span id="game-over-paragraph">0</span></div>
                    </div>
                </div>
            </div>
            <div class="footer">
                <button id="restart-after-game-over">TRY AGAIN</button>
                <button id="next-level-btn" style="background-color: #1a3a1a; display: none;">NEXT LEVEL →</button>
                <button id="main-menu-after-game-over">MAIN MENU</button>
            </div>
        </div>

        <!-- Popup Notification Container -->
        <div id="popup-container" style="display: none;"></div>
    </div>

    <script>
    // ============== POPUP NOTIFICATION SYSTEM ==============
    const notificationSystem = {
        queue: [],
        isShowing: false,
        
        show: function(title, message, options = {}) {
            const notification = { title, message, options };
            this.queue.push(notification);
            this.processQueue();
        },
        
        processQueue: function() {
            if (this.isShowing || this.queue.length === 0) return;
            
            this.isShowing = true;
            const notification = this.queue.shift();
            this.displayPopup(notification);
        },
        
        displayPopup: function(notification) {
            const popupContainer = document.getElementById('popup-container');
            const popupId = 'popup-' + Date.now();
            
            const buttonsHTML = notification.options.buttons ? 
    notification.options.buttons.map(btn => {
        let action = btn.action;
        // If action is a string (like "initializeNewGameForLevel(1)"), wrap it in a function
        if (typeof action === 'string') {
            action = `() => { ${action}; notificationSystem.closePopup('${popupId}'); }`;
        } else if (typeof action === 'function') {
            // If it's already a function, wrap it to close popup
            const originalAction = action;
            action = `() => { originalAction(); notificationSystem.closePopup('${popupId}'); }`;
        }
        return `<button class="popup-btn" onclick="${action}">${btn.text}</button>`;
    }).join('') :
    '<button class="popup-btn" onclick="notificationSystem.closePopup(\'' + popupId + '\')">OK</button>';
            
            const popupHTML = `
                <div class="popup-overlay" id="${popupId}">
                    <div class="popup-box">
                        <h3 class="popup-title">${notification.title}</h3>
                        <div class="popup-message">${notification.message}</div>
                        <div class="popup-buttons">
                            ${buttonsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            popupContainer.innerHTML += popupHTML;
            popupContainer.style.display = 'block';
            
            const popupElement = document.getElementById(popupId);
            popupElement.style.display = 'flex';
            
            // Auto-close if timeout is set
            if (notification.options.timeout) {
                setTimeout(() => {
                    this.closePopup(popupId);
                }, notification.options.timeout);
            }
        },
        
        closePopup: function(popupId) {
            const popupElement = document.getElementById(popupId);
            if (popupElement) {
                popupElement.style.display = 'none';
                popupElement.remove();
            }
            
            this.isShowing = false;
            
            // Check if there are more notifications
            if (this.queue.length > 0) {
                setTimeout(() => this.processQueue(), 300);
            } else {
                document.getElementById('popup-container').style.display = 'none';
            }
        },
        
        // Specialized notification methods
        showReward: function(reward) {
            let message = "You received a reward:\n";
            if (reward.gold) message += `• ${reward.gold} Gold\n`;
            if (reward.stamina) message += `• ${reward.stamina} Stamina\n`;
            if (reward.skill) message += `• ${reward.skill} Skill\n`;
            if (reward.luck) message += `• ${reward.luck} Luck\n`;
            if (reward.inventory) {
                reward.inventory.forEach(item => {
                    message += `• ${item.name}\n`;
                });
            }
            this.show("Reward Received", message);
        },
        
        showCombatResult: function(result, damage) {
            this.show("Combat Result", `${result}\n${damage ? `You took ${damage} damage.` : ''}`);
        },
        
        showDiceRoll: function(result, total) {
            this.show("Dice Roll", `You rolled: ${result}\nTotal: ${total}`);
        },
        
        showLuckTest: function(result, isLucky) {
            this.show("Test Your Luck", `You rolled: ${result}\nResult: ${isLucky ? "LUCKY!" : "UNLUCKY!"}`);
        }
    };

    // ============== FIGHTING FANTASY GAME STATE ==============
    const gameState = {
        currentLevel: 1,
        completedLevels: [1],
        player: {
            baseSkill: 0,
            skill: 0,
            baseStamina: 0,
            stamina: 0,
            maxStamina: 0,
            baseLuck: 0,
            luck: 0,
            gold: 0,
            provisions: 0,
            inventory: [],
            equipped: {
                weapon: null,
                armor: null,
                accessory: null
            }
        },
        currentParagraph: 1,
        currentEnemy: null,
        combatRound: 0,
        currentCombatVictoryParagraph: null,
        lastLuckTest: null,
        marketItems: [
            {
                id: "silver_sword",
                name: "Silver Sword",
                type: "weapon",
                cost: 40,
                skillBonus: 2,
                description: "A silver-plated sword effective against undead. Increases Skill by 2."
            },
            {
                id: "holy_water",
                name: "Holy Water",
                type: "consumable",
                cost: 25,
                effect: "holy",
                value: 3,
                description: "Can be used once in combat to inflict 3 damage to an undead enemy."
            },
            {
                id: "chainmail",
                name: "Chainmail Armor",
                type: "armor",
                cost: 35,
                staminaBonus: 8,
                description: "Heavy chainmail armor that increases your maximum Stamina by 8."
            },
            {
                id: "wooden_stake",
                name: "Wooden Stake",
                type: "weapon",
                cost: 15,
                skillBonus: 1,
                description: "A sharp wooden stake for piercing undead hearts. Increases Skill by 1."
            },
            {
                id: "holy_symbol",
                name: "Holy Symbol",
                type: "accessory",
                cost: 30,
                luckBonus: 2,
                description: "A blessed symbol that increases your Luck by 2."
            },
            {
                id: "healing_potion",
                name: "Healing Draught",
                type: "consumable",
                cost: 20,
                effect: "heal",
                value: 10,
                description: "Restores 10 Stamina when used."
            },
            {
                id: "provisions",
                name: "Provisions",
                type: "consumable",
                cost: 4,
                effect: "provision",
                value: 1,
                description: "A day's worth of food. Restores 4 Stamina when eaten."
            }
        ],
        story: {
            1: {
                title: "The Cursed Island",
                text: "Your ship approaches the fog-shrouded Isle of Graves. According to legend, a necromancer has raised the dead here, creating an army of undead horrors. Your expedition's goal: find the source of the curse and destroy it before it spreads to the mainland. As your rowboat touches the black sand beach, you see the skeletal remains of previous explorers. The air smells of decay and sea salt. Where will you begin?",
                choices: [
                    { text: "Explore the beach and caves to the east", next: 2 },
                    { text: "Head inland toward the ancient temple ruins", next: 3 },
                    { text: "Follow a trail north along the cliffs", next: 4 }
                ]
            },
            2: {
                title: "The Black Sand Beach",
                text: "The beach is littered with shipwreck debris and bones. To your left, sea caves yawn darkly. To your right, the cliffs rise steeply. You notice strange footprints in the sand - human-shaped but dragging, as if the walker had trouble lifting their feet.",
                choices: [
                    { text: "Investigate the sea caves", next: 5 },
                    { text: "Examine the shipwreck debris", next: 6 },
                    { text: "Return to the landing point", next: 1 }
                ]
            },
            3: {
                title: "Temple Approach",
                text: "You climb a mossy stone staircase toward crumbling temple ruins. Strange chanting echoes from within. The architecture suggests an ancient death cult once worshipped here. Moss-covered statues of skeletal figures line the path.",
                choices: [
                    { text: "Enter the main temple cautiously", next: 7 },
                    { text: "Search the surrounding graveyard", next: 8 },
                    { text: "Return to the beach", next: 1 }
                ]
            },
            4: {
                title: "Cliffside Trail",
                text: "The trail winds along steep cliffs overlooking the crashing sea. Fog obscures your view ahead. You hear moaning from somewhere below the cliffs. Looking down, you see figures moving in the mist - shambling, unsteady movements.",
                choices: [
                    { text: "Continue along the cliff trail", next: 9 },
                    { text: "Climb down to investigate the figures", next: 10 },
                    { text: "Return to the beach", next: 1 }
                ]
            },
            5: {
                title: "Sea Caves",
                text: "Inside the cave, the air is damp and cold. Bioluminescent fungi provide eerie blue light. You hear scraping sounds from deeper within. Something is moving in the darkness ahead!",
                combat: {
                    enemy: "zombie",
                    skill: 6,
                    stamina: 7,
                    ascii: `     ___
    |   |
    |   |
    |   |
   /| |\\
  / |_| \\
 /_______\\
    | |`,
                    victory: 11,
                    defeat: 100
                }
            },
            6: {
                title: "Shipwreck Debris",
                text: "Among the broken timbers and torn sails, you find a waterlogged chest. It's locked, but the wood is rotten. You could probably break it open.",
                choices: [
                    { text: "Break open the chest", next: 12 },
                    { text: "Leave it and continue exploring", next: 2 }
                ]
            },
            7: {
                title: "Temple Interior",
                text: "The temple interior is vast and shadowy. Braziers filled with green flame illuminate faded murals depicting necromantic rituals. At the far end, an altar stained with dark substances stands beneath a statue of a robed figure holding a skull. You're not alone here...",
                combat: {
                    enemy: "skeleton",
                    skill: 7,
                    stamina: 6,
                    ascii: `     ___
    /   \\
   | () |
    \\___/
     /|
    / |
   /  |`,
                    victory: 13,
                    defeat: 100
                }
            },
            8: {
                title: "Ancient Graveyard",
                text: "The graveyard is overgrown with thorny vines. Many graves have been disturbed, their occupants missing. One mausoleum door stands slightly ajar. From within, you hear scratching sounds.",
                choices: [
                    { text: "Enter the mausoleum", next: 14 },
                    { text: "Search the graves for useful items", next: 15 },
                    { text: "Leave the graveyard", next: 3 }
                ]
            },
            9: {
                title: "Foggy Cliffs",
                text: "The fog grows thicker as you proceed. Suddenly, a figure emerges from the mist - a sailor with bloated, waterlogged skin and empty eye sockets! It shambles toward you, arms outstretched.",
                combat: {
                    enemy: "drowned_one",
                    skill: 8,
                    stamina: 9,
                    ascii: `    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    | |
   /   \\`,
                    victory: 16,
                    defeat: 100
                }
            },
            10: {
                title: "Below the Cliffs",
                text: "You carefully climb down to a narrow ledge. Below, the sea crashes against rocks. On the ledge, three zombies are feasting on what appears to be a recent shipwreck victim. They haven't noticed you yet.",
                choices: [
                    { text: "Attack the zombies", next: 17 },
                    { text: "Try to sneak past them", next: 18 },
                    { text: "Climb back up quickly", next: 4 }
                ]
            },
            11: {
                title: "Cave Exploration",
                text: "The zombie collapses into a pile of rotting flesh. Further in the cave, you discover a natural spring of fresh water - a rare find on this cursed island. Resting here, you also find a silver dagger wedged in a crack in the wall.",
                reward: {
                    stamina: 4,
                    inventory: [{
                        id: "silver_dagger",
                        name: "Silver Dagger",
                        type: "weapon",
                        skillBonus: 1,
                        description: "A silver dagger effective against undead. Increases Skill by 1."
                    }]
                },
                choices: [
                    { text: "Continue deeper into the caves", next: 19 },
                    { text: "Return to the beach", next: 2 }
                ]
            },
            12: {
                title: "The Waterlogged Chest",
                text: "You break the chest open. Inside, you find 25 gold coins and a journal. The journal's last entry reads: 'The necromancer's tower lies at the island's heart. He conducts his rituals at midnight. Only silver or fire can truly destroy his creations. May the gods help whoever finds this message.'",
                reward: {
                    gold: 25
                },
                choices: [
                    { text: "Take the gold and continue", next: 2 }
                ]
            },
            13: {
                title: "Temple Treasure",
                text: "The skeleton crumbles to dust. Behind the altar, you find a hidden compartment containing a silver holy symbol and 15 gold coins. The holy symbol feels warm to the touch.",
                reward: {
                    gold: 15,
                    inventory: [{
                        id: "silver_holy_symbol",
                        name: "Silver Holy Symbol",
                        type: "accessory",
                        luckBonus: 1,
                        description: "A blessed silver symbol that increases your Luck by 1."
                    }]
                },
                choices: [
                    { text: "Leave the temple", next: 3 },
                    { text: "Search for more secrets", next: 20 }
                ]
            },
            14: {
                title: "Inside the Mausoleum",
                text: "The air inside is thick with dust and decay. In the center of the chamber lies a stone sarcophagus. The lid has been pushed aside. Inside, a skeletal figure rises slowly, clutching a rusted sword!",
                combat: {
                    enemy: "skeleton_warrior",
                    skill: 9,
                    stamina: 10,
                    ascii: `     ___
    /   \\
   |()()|
    \\___/
     /|\\
    / | \\
   /  |  \\
      |
     / \\
    /   \\`,
                    victory: 21,
                    defeat: 100
                }
            },
            15: {
                title: "Searching the Graves",
                text: "You carefully search the disturbed graves. Most contain only bones and tattered cloth, but in one you find a leather pouch containing 10 gold coins and a small, unbroken vial of holy water.",
                reward: {
                    gold: 10,
                    inventory: [{
                        id: "holy_water_found",
                        name: "Holy Water (Found)",
                        type: "consumable",
                        effect: "holy",
                        value: 2,
                        description: "A vial of blessed water that damages undead creatures."
                    }]
                },
                choices: [
                    { text: "Continue searching", next: 22 },
                    { text: "Leave the graveyard", next: 8 }
                ]
            },
            16: {
                title: "Cliff Path Continues",
                text: "The drowned sailor sinks back into the sea mist. Continuing along the cliff path, you find a small cave hidden behind a waterfall. Inside, there's a dry area with some old supplies left by previous explorers.",
                reward: {
                    provisions: 2,
                    gold: 5
                },
                choices: [
                    { text: "Take the supplies and continue", next: 23 },
                    { text: "Rest here for a while", next: 24 }
                ]
            },
            17: {
                title: "Ambushing the Zombies",
                text: "You launch a surprise attack on the zombies! Your first strike takes one down, but the other two turn to face you, moaning hungrily.",
                combat: {
                    enemy: "zombies",
                    skill: 7,
                    stamina: 12,
                    ascii: `     ___     ___     ___
    |   |   |   |   |   |
    |   |   |   |   |   |
    |   |   |   |   |   |
   /| |\\   /| |\\   /| |\\
  / |_| \\ / |_| \\ / |_| \\
 /_______\\/_______\\/_______\\
    | |       | |       | |`,
                    victory: 25,
                    defeat: 100
                }
            },
            18: {
                title: "Sneaking Past",
                text: "You try to quietly sneak past the feasting zombies. As you creep by, one of them looks up! Test your Luck to see if it notices you.",
                testLuck: {
                    lucky: 26,
                    unlucky: 17
                }
            },
            19: {
                title: "Deeper into the Caves",
                text: "The cave narrows to a tunnel that slopes upward. After climbing for what seems like hours, you emerge in a hidden valley. In the center stands a black stone tower - the necromancer's lair!",
                choices: [
                    { text: "Approach the tower cautiously", next: 27 },
                    { text: "Look for another entrance", next: 28 },
                    { text: "Return to the beach to report", next: 2 }
                ]
            },
            20: {
                title: "Temple Secret Chamber",
                text: "After searching the temple walls, you find a hidden switch. A section of wall slides open, revealing a small chamber containing ancient scrolls and a potion.",
                reward: {
                    inventory: [
                        {
                            id: "potion_of_skill",
                            name: "Potion of Skill",
                            type: "consumable",
                            effect: "skill",
                            value: 2,
                            description: "Increases your Skill by 2 for the next combat."
                        }
                    ]
                },
                choices: [
                    { text: "Take the items and leave", next: 3 }
                ]
            },
            21: {
                title: "Mausoleum Treasure",
                text: "The skeleton warrior collapses. In the sarcophagus, you find a silver-inlaid sword and a leather-bound book of protective prayers.",
                reward: {
                    inventory: [
                        {
                            id: "silver_inlaid_sword",
                            name: "Silver-inlaid Sword",
                            type: "weapon",
                            skillBonus: 2,
                            description: "An ancient sword with silver inlay. Increases Skill by 2."
                        }
                    ]
                },
                choices: [
                    { text: "Take the sword and leave", next: 8 }
                ]
            },
            22: {
                title: "More Grave Searching",
                text: "You find another grave that hasn't been completely looted. Inside is a skeleton wearing a ring that glows faintly.",
                reward: {
                    inventory: [{
                        id: "glowing_ring",
                        name: "Glowing Ring",
                        type: "accessory",
                        luckBonus: 2,
                        description: "A magical ring that glows faintly. Increases Luck by 2."
                    }]
                },
                choices: [
                    { text: "Take the ring and leave", next: 8 }
                ]
            },
            23: {
                title: "Continuing the Path",
                text: "Refreshed by your find, you continue along the cliff path. It leads to a rope bridge spanning a deep chasm. The bridge looks old and unstable.",
                choices: [
                    { text: "Cross the bridge carefully", next: 29 },
                    { text: "Look for another way across", next: 30 }
                ]
            },
            24: {
                title: "Resting in the Cave",
                text: "You rest in the dry cave, eating a provision and regaining your strength. The sound of the waterfall is calming.",
                reward: {
                    stamina: 4
                },
                choices: [
                    { text: "Continue along the path", next: 23 }
                ]
            },
            25: {
                title: "Victory on the Ledge",
                text: "The last zombie tumbles off the ledge into the sea below. Searching the area, you find the shipwreck victim's pack containing some gold and a map of the island.",
                reward: {
                    gold: 20,
                    inventory: [{
                        id: "island_map",
                        name: "Island Map",
                        type: "special",
                        description: "A crude map showing the island's main locations."
                    }]
                },
                choices: [
                    { text: "Follow the ledge further", next: 31 },
                    { text: "Climb back up", next: 4 }
                ]
            },
            26: {
                title: "Successfully Sneaked",
                text: "The zombie returns to its meal without noticing you. You successfully sneak past and continue along the ledge.",
                choices: [
                    { text: "Continue along the ledge", next: 31 }
                ]
            },
            27: {
                title: "Necromancer's Tower",
                text: "You approach the black stone tower. The door is massive and iron-banded. Strange symbols glow faintly on its surface. Two skeletal guards stand motionless on either side.",
                choices: [
                    { text: "Try to open the door", next: 32 },
                    { text: "Attack the skeletal guards", next: 33 },
                    { text: "Look for another entrance", next: 28 }
                ]
            },
            28: {
                title: "Searching for Another Entrance",
                text: "You circle the tower, looking for another way in. You find a window about 20 feet up, and a drainage grate at ground level.",
                choices: [
                    { text: "Try to climb to the window", next: 34 },
                    { text: "Investigate the drainage grate", next: 35 },
                    { text: "Return to the front door", next: 27 }
                ]
            },
            29: {
                title: "Crossing the Bridge",
                text: "You step onto the rope bridge. It sways dangerously. Halfway across, several planks give way! Test your Luck to avoid falling.",
                testLuck: {
                    lucky: 36,
                    unlucky: 37
                }
            },
            30: {
                title: "Finding Another Way",
                text: "You search along the chasm edge and find a narrow stone path that winds down into the darkness below.",
                choices: [
                    { text: "Take the stone path", next: 38 },
                    { text: "Return to try the bridge", next: 29 }
                ]
            },
            31: {
                title: "Ledge Exploration",
                text: "The ledge continues around a bend. Ahead, you see a cave opening that seems to lead back into the cliffs.",
                choices: [
                    { text: "Enter the cave", next: 39 },
                    { text: "Continue along the ledge", next: 40 }
                ]
            },
            32: {
                title: "Tower Door",
                text: "As you touch the door, the skeletal guards spring to life! Their eye sockets glow with green fire as they advance.",
                combat: {
                    enemy: "skeleton_warrior",
                    skill: 10,
                    stamina: 12,
                    ascii: `     ___     ___
    /   \\   /   \\
   |()()| |()()|
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\
      |       |
     / \\     / \\
    /   \\   /   \\`,
                    victory: 41,
                    defeat: 100
                }
            },
            33: {
                title: "Attacking the Guards",
                text: "You launch a surprise attack on the skeletal guards!",
                combat: {
                    enemy: "skeleton_warrior",
                    skill: 9,
                    stamina: 10,
                    ascii: `     ___     ___
    /   \\   /   \\
   |()()| |()()|
    \\___/   \\___/
     /|\\     /|\\
    / | \\   / | \\
   /  |  \\ /  |  \\
      |       |
     / \\     / \\
    /   \\   /   \\`,
                    victory: 41,
                    defeat: 100
                }
            },
            34: {
                title: "Climbing to the Window",
                text: "You attempt to climb the rough stone walls. The tower stones provide some handholds. Test your Skill to climb successfully.",
                skillTest: {
                    success: 42,
                    failure: 43
                }
            },
            35: {
                title: "Drainage Grate",
                text: "The iron grate is rusted but still strong. You might be able to force it open with enough strength.",
                choices: [
                    { text: "Try to force the grate open", next: 44 },
                    { text: "Look for tools to help", next: 45 }
                ]
            },
            36: {
                title: "Bridge Success",
                text: "You manage to grab a rope and swing to safety as the planks fall away. You reach the other side, heart pounding.",
                choices: [
                    { text: "Continue along the path", next: 46 }
                ]
            },
            37: {
                title: "Bridge Failure",
                text: "You fall through the broken planks! You grab onto a rope, dangling over the chasm. Test your Skill to climb back up.",
                skillTest: {
                    success: 36,
                    failure: 47
                }
            },
            38: {
                title: "Stone Path Descent",
                text: "The stone path winds down into darkness. The air grows cold and damp. You hear dripping water echoing from below.",
                choices: [
                    { text: "Continue descending", next: 48 },
                    { text: "Return to the top", next: 23 }
                ]
            },
            39: {
                title: "Cave Entrance",
                text: "The cave leads into a natural tunnel. The air smells of salt and decay. Strange glowing moss provides faint illumination.",
                choices: [
                    { text: "Follow the tunnel", next: 49 },
                    { text: "Turn back", next: 31 }
                ]
            },
            40: {
                title: "Ledge Continues",
                text: "The ledge becomes narrower. Suddenly, you see movement ahead - shadowy figures detach from the cliff face!",
                combat: {
                    enemy: "shadow_stalker",
                    skill: 11,
                    stamina: 14,
                    ascii: `    
    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    / \\
   /   \\`,
                    victory: 50,
                    defeat: 100
                }
            },
            41: {
                title: "Guards Defeated",
                text: "The skeletal guards collapse into piles of bones. The tower door creaks open slightly. From within, you hear chanting.",
                choices: [
                    { text: "Enter the tower", next: 51 }
                ]
            },
            42: {
                title: "Through the Window",
                text: "You pull yourself through the window into a dark room filled with alchemical equipment. Bottles bubble and steam rises from crucibles.",
                choices: [
                    { text: "Search the room", next: 52 },
                    { text: "Find the door out", next: 53 }
                ]
            },
            43: {
                title: "Failed Climb",
                text: "You slip and fall, landing hard on the ground below. You take 2 Stamina damage.",
                damage: 2,
                choices: [
                    { text: "Try the drainage grate instead", next: 35 },
                    { text: "Approach the front door", next: 27 }
                ]
            },
            44: {
                title: "Forcing the Grate",
                text: "You strain against the rusted grate. With a loud screech, it comes free! The opening leads into a dark, damp tunnel.",
                choices: [
                    { text: "Crawl through the tunnel", next: 54 }
                ]
            },
            45: {
                title: "Looking for Tools",
                text: "You search the area and find a heavy stone that could be used as a hammer. Returning to the grate, you smash at the rusted hinges.",
                choices: [
                    { text: "Smash the hinges", next: 44 }
                ]
            },
            46: {
                title: "Beyond the Chasm",
                text: "The path leads through a misty forest. Strange, twisted trees loom out of the fog. You hear whispering from all around.",
                choices: [
                    { text: "Continue through the forest", next: 55 },
                    { text: "Try to find another path", next: 56 }
                ]
            },
            47: {
                title: "Falling",
                text: "You lose your grip and fall into the darkness below...",
                gameOver: true
            },
            48: {
                title: "Underground Cavern",
                text: "The path opens into a vast underground cavern. A subterranean river flows through it, and strange mushrooms glow with eerie light.",
                choices: [
                    { text: "Follow the river upstream", next: 57 },
                    { text: "Follow the river downstream", next: 58 },
                    { text: "Explore the cavern", next: 59 }
                ]
            },
            49: {
                title: "Tunnel Network",
                text: "The tunnel branches in three directions. All look equally dark and foreboding.",
                choices: [
                    { text: "Take the left tunnel", next: 60 },
                    { text: "Take the center tunnel", next: 61 },
                    { text: "Take the right tunnel", next: 62 }
                ]
            },
            50: {
                title: "Shadow Stalker Defeated",
                text: "The shadowy creature dissipates like smoke. Where it stood, you find a black crystal that pulses with dark energy.",
                reward: {
                    inventory: [{
                        id: "shadow_crystal",
                        name: "Shadow Crystal",
                        type: "special",
                        description: "A crystal that absorbs light. It feels cold to the touch."
                    }]
                },
                choices: [
                    { text: "Continue along the ledge", next: 63 }
                ]
            },
            51: {
                title: "Tower Interior",
                text: "You enter a circular chamber. Stairs spiral upward, and a door leads deeper into the tower. The chanting grows louder from above.",
                choices: [
                    { text: "Climb the stairs", next: 64 },
                    { text: "Explore the lower level", next: 65 }
                ]
            },
            52: {
                title: "Alchemical Laboratory",
                text: "Among the bubbling potions, you find a healing draught and a strange silver powder that glows faintly.",
                reward: {
                    inventory: [
                        {
                            id: "healing_draught",
                            name: "Healing Draught",
                            type: "consumable",
                            effect: "heal",
                            value: 8,
                            description: "Restores 8 Stamina."
                        },
                        {
                            id: "silver_powder",
                            name: "Silver Powder",
                            type: "consumable",
                            effect: "holy",
                            value: 4,
                            description: "Can be thrown at undead to cause damage."
                        }
                    ]
                },
                choices: [
                    { text: "Leave the laboratory", next: 53 }
                ]
            },
            53: {
                title: "Leaving the Laboratory",
                text: "You find a door leading out of the laboratory. It opens into a corridor with doors on either side.",
                choices: [
                    { text: "Take the left door", next: 66 },
                    { text: "Take the right door", next: 67 },
                    { text: "Continue down the corridor", next: 68 }
                ]
            },
            54: {
                title: "Drainage Tunnel",
                text: "You crawl through the narrow, wet tunnel. It emerges into a cellar filled with barrels and crates.",
                choices: [
                    { text: "Search the cellar", next: 69 },
                    { text: "Find a way out", next: 70 }
                ]
            },
            55: {
                title: "Misty Forest",
                text: "The whispering grows louder. Shapes move between the trees. Suddenly, ghostly figures materialize around you!",
                combat: {
                    enemy: "swamp_wraiths",
                    skill: 9,
                    stamina: 16,
                    ascii: `    
    .-.     .-.
   (   )   (   )
    | |     | |
   |   |   |   |
  |     | |     |
   \\___/   \\___/
    | |     | |
   /   \\   /   \\`,
                    victory: 71,
                    defeat: 100
                }
            },
            56: {
                title: "Alternative Path",
                text: "You try to circle around the forest, but find yourself at the edge of a murky swamp. Strange bubbles rise from the dark water.",
                choices: [
                    { text: "Try to cross the swamp", next: 72 },
                    { text: "Go back to the forest", next: 55 }
                ]
            },
            57: {
                title: "Upstream",
                text: "Following the river upstream, you come to a waterfall. Behind it, you see a hidden chamber with a glowing crystal formation.",
                reward: {
                    inventory: [{
                        id: "glowing_crystal",
                        name: "Glowing Crystal",
                        type: "special",
                        description: "A crystal that emits soft light. Could be valuable."
                    }]
                },
                choices: [
                    { text: "Return to the cavern", next: 48 }
                ]
            },
            58: {
                title: "Downstream",
                text: "The river leads to a pool where blind fish swim. On the bank, you find the remains of an explorer with a journal.",
                reward: {
                    gold: 15,
                    inventory: [{
                        id: "explorers_journal",
                        name: "Explorer's Journal",
                        type: "special",
                        description: "Contains notes about the island's dangers."
                    }]
                },
                choices: [
                    { text: "Return to the cavern", next: 48 }
                ]
            },
            59: {
                title: "Cavern Exploration",
                text: "You find a nest of giant cave insects! They skitter toward you, mandibles clicking.",
                combat: {
                    enemy: "cave_insects",
                    skill: 8,
                    stamina: 10,
                    ascii: `    
     /\\
    /  \\
   /    \\
  /______\\
   |    |
   |    |
  /|    |\\
 / |    | \\`,
                    victory: 73,
                    defeat: 100
                }
            },
            60: {
                title: "Left Tunnel",
                text: "This tunnel slopes downward. The air grows warmer. You emerge in a geothermal chamber with hot springs.",
                reward: {
                    stamina: 6
                },
                choices: [
                    { text: "Rest here", next: 74 },
                    { text: "Return to the junction", next: 49 }
                ]
            },
            61: {
                title: "Center Tunnel",
                text: "The tunnel is straight and true. You find an ancient stone door covered in carvings of stars and moons.",
                choices: [
                    { text: "Try to open the door", next: 75 },
                    { text: "Return to the junction", next: 49 }
                ]
            },
            62: {
                title: "Right Tunnel",
                text: "This tunnel is blocked by a cave-in. You can hear scratching sounds from the other side.",
                choices: [
                    { text: "Try to clear the rubble", next: 76 },
                    { text: "Return to the junction", next: 49 }
                ]
            },
            63: {
                title: "Ledge's End",
                text: "The ledge ends at a stone door carved with skulls. The door is slightly ajar, and green light spills out.",
                choices: [
                    { text: "Enter through the door", next: 77 }
                ]
            },
            64: {
                title: "Ascending the Tower",
                text: "You climb the spiral staircase. The chanting grows clearer. You recognize words of dark power. At the top, a door stands before you.",
                choices: [
                    { text: "Listen at the door", next: 78 },
                    { text: "Burst into the room", next: 79 }
                ]
            },
            65: {
                title: "Lower Level",
                text: "The lower level contains storerooms and a library. Many books are bound in what looks like human skin.",
                choices: [
                    { text: "Search the library", next: 80 },
                    { text: "Return to the main chamber", next: 51 }
                ]
            },
            66: {
                title: "Left Door",
                text: "This room contains sleeping quarters. Several beds are neatly made, but covered in dust. Under one bed, you find a hidden chest.",
                reward: {
                    gold: 30,
                    inventory: [{
                        id: "enchanted_gloves",
                        name: "Enchanted Gloves",
                        type: "accessory",
                        skillBonus: 1,
                        description: "Gloves that improve your grip. Increases Skill by 1."
                    }]
                },
                choices: [
                    { text: "Return to the corridor", next: 53 }
                ]
            },
            67: {
                title: "Right Door",
                text: "This room is a torture chamber. Rusty instruments hang on the walls. In one corner, a skeleton in chains rattles to life!",
                combat: {
                    enemy: "skeleton",
                    skill: 8,
                    stamina: 8,
                    ascii: `     ___
    /   \\
   | () |
    \\___/
     /|\\
    / | \\
   /  |  \\`,
                    victory: 81,
                    defeat: 100
                }
            },
            68: {
                title: "Corridor End",
                text: "The corridor ends at a heavy door. From beyond, you hear the sound of grinding stone and chanting.",
                choices: [
                    { text: "Open the door", next: 82 }
                ]
            },
            69: {
                title: "Cellar Search",
                text: "Among the barrels, you find one marked with a holy symbol. It contains preserved food and a silver-coated mace.",
                reward: {
                    provisions: 3,
                    inventory: [{
                        id: "silver_mace",
                        name: "Silver Mace",
                        type: "weapon",
                        skillBonus: 2,
                        description: "A heavy mace with a silver head. Very effective against undead."
                    }]
                },
                choices: [
                    { text: "Find a way out", next: 70 }
                ]
            },
            70: {
                title: "Leaving the Cellar",
                text: "You find stairs leading up to a wooden door. It opens into the tower's main chamber.",
                choices: [
                    { text: "Enter the main chamber", next: 51 }
                ]
            },
            71: {
                title: "Wraiths Defeated",
                text: "The wraiths fade away with mournful cries. The forest grows quiet. Ahead, you see the black tower through the trees.",
                choices: [
                    { text: "Approach the tower", next: 27 }
                ]
            },
            72: {
                title: "Swamp Crossing",
                text: "As you try to cross the swamp, hands reach up from the mud and grab you! The swamp is filled with undead!",
                combat: {
                    enemy: "zombies",
                    skill: 8,
                    stamina: 14,
                    ascii: `     ___     ___     ___
    |   |   |   |   |   |
    |   |   |   |   |   |
    |   |   |   |   |   |
   /| |\\   /| |\\   /| |\\
  / |_| \\ / |_| \\ / |_| \\
 /_______\\/_______\\/_______\\
    | |       | |       | |`,
                    victory: 83,
                    defeat: 100
                }
            },
            73: {
                title: "Insects Defeated",
                text: "The last insect scuttles away. In their nest, you find shiny stones and a skeletal hand clutching a ruby.",
                reward: {
                    gold: 40,
                    inventory: [{
                        id: "ruby",
                        name: "Ruby",
                        type: "special",
                        description: "A large, valuable ruby."
                    }]
                },
                choices: [
                    { text: "Return to the cavern", next: 48 }
                ]
            },
            74: {
                title: "Resting at the Hot Springs",
                text: "The warm water soothes your aches and pains. You feel refreshed and ready to continue.",
                reward: {
                    stamina: 8
                },
                choices: [
                    { text: "Return to the junction", next: 49 }
                ]
            },
            75: {
                title: "Stone Door",
                text: "The door opens to reveal a circular chamber with a stone altar. On the altar lies a glowing sword!",
                reward: {
                    inventory: [{
                        id: "glowing_sword",
                        name: "Glowing Sword",
                        type: "weapon",
                        skillBonus: 3,
                        description: "A sword that glows with magical light. Increases Skill by 3."
                    }]
                },
                choices: [
                    { text: "Take the sword and leave", next: 49 }
                ]
            },
            76: {
                title: "Clearing Rubble",
                text: "As you move stones, the tunnel collapses further! You barely escape being buried.",
                damage: 3,
                choices: [
                    { text: "Return to the junction", next: 49 }
                ]
            },
            77: {
                title: "Secret Entrance",
                text: "You enter a corridor that leads upward. After many turns, you emerge in the tower's upper levels. You can hear chanting from nearby.",
                choices: [
                    { text: "Follow the sound", next: 84 }
                ]
            },
            78: {
                title: "Listening at the Door",
                text: "You hear the necromancer chanting. He's performing a ritual! You have the element of surprise.",
                choices: [
                    { text: "Kick the door open and attack", next: 85 },
                    { text: "Wait for the right moment", next: 86 }
                ]
            },
            79: {
                title: "Bursting In",
                text: "You burst into the ritual chamber! The necromancer Malakar turns, surprise on his face.",
                combat: {
                    enemy: "malakar",
                    skill: 12,
                    stamina: 20,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 106,
                    defeat: 100
                }
            },
            80: {
                title: "Library Search",
                text: "Among the gruesome books, you find one that isn't bound in skin. It contains protective spells against undead.",
                reward: {
                    inventory: [{
                        id: "book_of_protection",
                        name: "Book of Protection",
                        type: "special",
                        description: "Contains spells that could be useful against undead."
                    }]
                },
                choices: [
                    { text: "Take the book and leave", next: 51 }
                ]
            },
            81: {
                title: "Torture Chamber Cleared",
                text: "The tortured skeleton finds peace. Searching the room, you find keys and a healing potion in a cabinet.",
                reward: {
                    inventory: [
                        {
                            id: "tower_keys",
                            name: "Tower Keys",
                            type: "special",
                            description: "A ring of keys that might unlock doors in the tower."
                        },
                        {
                            id: "healing_potion_found",
                            name: "Healing Potion",
                            type: "consumable",
                            effect: "heal",
                            value: 6,
                            description: "Restores 6 Stamina."
                        }
                    ]
                },
                choices: [
                    { text: "Return to the corridor", next: 53 }
                ]
            },
            82: {
                title: "Ritual Preparation Room",
                text: "This room contains ritual implements and several zombies being prepared for animation!",
                combat: {
                    enemy: "zombies",
                    skill: 7,
                    stamina: 15,
                    ascii: `     ___     ___     ___
    |   |   |   |   |   |
    |   |   |   |   |   |
    |   |   |   |   |   |
   /| |\\   /| |\\   /| |\\
  / |_| \\ / |_| \\ / |_| \\
 /_______\\/_______\\/_______\\
    | |       | |       | |`,
                    victory: 87,
                    defeat: 100
                }
            },
            83: {
                title: "Swamp Crossed",
                text: "The swamp zombies sink back into the mud. You reach solid ground on the other side, right before the tower.",
                choices: [
                    { text: "Approach the tower", next: 27 }
                ]
            },
            84: {
                title: "Upper Corridor",
                text: "The corridor leads to a door. Through it, you can hear the necromancer's voice.",
                choices: [
                    { text: "Open the door quietly", next: 88 },
                    { text: "Prepare for battle", next: 89 }
                ]
            },
            85: {
                title: "Surprise Attack",
                text: "You surprise Malakar! He's caught off guard, giving you an advantage.",
                combat: {
                    enemy: "malakar",
                    skill: 10,
                    stamina: 18,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 106,
                    defeat: 100
                }
            },
            86: {
                title: "Waiting",
                text: "You wait for the perfect moment. The ritual reaches its climax - now is your chance!",
                choices: [
                    { text: "Attack now!", next: 85 }
                ]
            },
            87: {
                title: "Preparation Room Cleared",
                text: "The zombies are destroyed. In the room, you find vials of potions and some gold.",
                reward: {
                    gold: 25,
                    inventory: [
                        {
                            id: "strength_potion",
                            name: "Potion of Strength",
                            type: "consumable",
                            effect: "skill",
                            value: 3,
                            description: "Increases Skill by 3 for the next combat."
                        }
                    ]
                },
                choices: [
                    { text: "Continue exploring", next: 90 }
                ]
            },
            88: {
                title: "Quiet Entrance",
                text: "You slip into the room unnoticed. Malakar has his back to you, focused on his ritual.",
                choices: [
                    { text: "Attack from behind", next: 91 },
                    { text: "Call out to him", next: 92 }
                ]
            },
            89: {
                title: "Preparing for Battle",
                text: "You drink any potions you have and check your equipment. Ready for the final battle.",
                choices: [
                    { text: "Enter the chamber", next: 79 }
                ]
            },
            90: {
                title: "Tower Exploration",
                text: "You find stairs leading up. The chanting is coming from above.",
                choices: [
                    { text: "Climb the stairs", next: 64 }
                ]
            },
            91: {
                title: "Backstab",
                text: "You strike Malakar from behind! He screams in pain and turns to face you, wounded.",
                reward: {
                    damageBonus: 4
                },
                choices: [
                    { text: "Continue the fight", next: 93 }
                ]
            },
            92: {
                title: "Confrontation",
                text: "Malakar turns slowly. 'Ah, another fool come to stop me. You'll join my army soon enough.'",
                combat: {
                    enemy: "malakar",
                    skill: 14,
                    stamina: 25,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 106,
                    defeat: 100
                }
            },
            93: {
                title: "Wounded Malakar",
                text: "Malakar is wounded but still dangerous. Dark energy crackles around him.",
                combat: {
                    enemy: "malakar",
                    skill: 12,
                    stamina: 16,
                    ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`,
                    victory: 106,
                    defeat: 100
                }
            },
            106: {
                title: "VICTORY!",
                text: "Malakar falls to his knees as you strike the final blow. 'No... my great work... undone...' he gasps before collapsing. The black crystal shatters, releasing a wave of pure energy. All around the island, the undead creatures collapse, returning to true death. The curse is broken! You've saved the island and prevented the spread of Malakar's evil to the mainland. As dawn breaks, you see a ship approaching - your rescue has arrived. You return home a hero, having cleansed the Island of the Undead.",
                victory: true
            },
            100: {
                title: "Game Over",
                text: "Your adventure has come to a premature end. The undead of the island have claimed another victim. The curse continues to spread...",
                gameOver: true
            }
        },
        enemies: {
            zombie: {
                name: "Zombie",
                skill: 6,
                stamina: 7,
                ascii: `     ___
    |   |
    |   |
    |   |
   /| |\\
  / |_| \\
 /_______\\
    | |`
            },
            skeleton: {
                name: "Skeleton",
                skill: 7,
                stamina: 6,
                ascii: `     ___
    /   \\
   | () |
    \\___/
     /|
    / |
   /  |`
            },
            drowned_one: {
                name: "Drowned Sailor",
                skill: 8,
                stamina: 9,
                ascii: `    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    | |
   /   \\`
            },
            zombies: {
                name: "Zombie Pack",
                skill: 7,
                stamina: 12,
                ascii: `     ___     ___     ___
    |   |   |   |   |   |
    |   |   |   |   |   |
    |   |   |   |   |   |
   /| |\\   /| |\\   /| |\\
  / |_| \\ / |_| \\ / |_| \\
 /_______\\/_______\\/_______\\
    | |       | |       | |`
            },
            skeleton_warrior: {
                name: "Skeleton Warrior",
                skill: 10,
                stamina: 12,
                ascii: `     ___
    /   \\
   |()()|
    \\___/
     /|\\
    / | \\
   /  |  \\
      |
     / \\
    /   \\`
            },
            shadow_stalker: {
                name: "Shadow Stalker",
                skill: 11,
                stamina: 14,
                ascii: `    
    .-.
   (   )
    | |
   |   |
  |     |
   \\___/
    / \\
   /   \\`
            },
            swamp_wraiths: {
                name: "Swamp Wraiths",
                skill: 9,
                stamina: 16,
                ascii: `    
    .-.     .-.
   (   )   (   )
    | |     | |
   |   |   |   |
  |     | |     |
   \\___/   \\___/
    | |     | |
   /   \\   /   \\`
            },
            cave_insects: {
                name: "Cave Insects",
                skill: 8,
                stamina: 10,
                ascii: `    
     /\\
    /  \\
   /    \\
  /______\\
   |    |
   |    |
  /|    |\\
 / |    | \\`
            },
            malakar: {
                name: "Malakar the Necromancer",
                skill: 14,
                stamina: 25,
                ascii: `     /\\
    /  \\
   / /\\ \\
  / ____ \\
 /_/    \\_\\
    |  |
    |  |
   /    \\`
            }
        }
    };

    // ============== DICE FUNCTIONS ==============
   function rollDice(numDice = 2) {
    let total = 0;
    let rolls = [];
    for (let i = 0; i < numDice; i++) {
        const roll = Math.floor(Math.random() * 6) + 1;
        rolls.push(roll);
        total += roll;
    }
    
    // Show notification for dice roll (auto-closing)
    showDiceRollPopup(rolls.join(" + "), total);
    
    return total;
}
        
        // Show notification for dice roll
        notificationSystem.showDiceRoll(rolls.join(" + "), total);
        
        return total;
    }

function showDiceRollPopup(result, total) {
    const popupId = 'popup-' + Date.now();
    notificationSystem.show("Dice Roll", `You rolled: ${result}\nTotal: ${total}`, {
        timeout: 2000  // Auto-close after 2 seconds
    });
}

    function rollSkillDice(skill) {
        const diceRoll = rollDice(2);
        return diceRoll + skill;
    }

    function testLuck() {
        const luckRoll = rollDice(2);
        const isLucky = luckRoll <= gameState.player.luck;
        
        // Decrease luck after test
        gameState.player.luck = Math.max(0, gameState.player.luck - 1);
        
        // Show notification
        notificationSystem.showLuckTest(luckRoll, isLucky);
        
        return {
            roll: luckRoll,
            lucky: isLucky
        };
    }

    // ============== EQUIPMENT SYSTEM ==============
    function equipItem(item) {
        // Unequip any item of the same type first
        if (item.type === "weapon") {
            if (gameState.player.equipped.weapon) {
                unequipItem(gameState.player.equipped.weapon);
            }
            gameState.player.equipped.weapon = item;
            gameState.player.skill = gameState.player.baseSkill + (item.skillBonus || 0);
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Skill increased by ${item.skillBonus || 0}.`);
        } else if (item.type === "armor") {
            if (gameState.player.equipped.armor) {
                unequipItem(gameState.player.equipped.armor);
            }
            gameState.player.equipped.armor = item;
            const oldMaxStamina = gameState.player.maxStamina;
            gameState.player.maxStamina = gameState.player.baseStamina + (item.staminaBonus || 0);
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Maximum Stamina increased by ${item.staminaBonus || 0}.`);
        } else if (item.type === "accessory") {
            if (gameState.player.equipped.accessory) {
                unequipItem(gameState.player.equipped.accessory);
            }
            gameState.player.equipped.accessory = item;
            gameState.player.luck = gameState.player.baseLuck + (item.luckBonus || 0);
            notificationSystem.show("Item Equipped", `You equipped ${item.name}. Luck increased by ${item.luckBonus || 0}.`);
        }
        
        // Remove item from inventory if it's now equipped
        const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
        if (itemIndex !== -1) {
            gameState.player.inventory.splice(itemIndex, 1);
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function unequipItem(item) {
        if (item.type === "weapon") {
            gameState.player.skill = gameState.player.baseSkill;
            gameState.player.equipped.weapon = null;
        } else if (item.type === "armor") {
            gameState.player.maxStamina = gameState.player.baseStamina;
            // Adjust current stamina if it exceeds the new max
            if (gameState.player.stamina > gameState.player.maxStamina) {
                gameState.player.stamina = gameState.player.maxStamina;
            }
            gameState.player.equipped.armor = null;
        } else if (item.type === "accessory") {
            gameState.player.luck = gameState.player.baseLuck;
            gameState.player.equipped.accessory = null;
        }
        
        // Add item back to inventory
        gameState.player.inventory.push(item);
        notificationSystem.show("Item Unequipped", `You unequipped ${item.name}.`);
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    function useConsumable(item) {
        if (item.effect === "heal") {
            const healAmount = Math.min(item.value, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            notificationSystem.show("Item Used", `You used ${item.name} and restored ${healAmount} Stamina!`);
        } else if (item.effect === "holy") {
            // Holy water can be used in combat against undead
            if (gameState.currentEnemy) {
                gameState.currentEnemy.currentStamina -= item.value;
                notificationSystem.show("Item Used", `You used Holy Water on ${gameState.currentEnemy.name} for ${item.value} damage!`);
                
                // Check if enemy is defeated
                if (gameState.currentEnemy.currentStamina <= 0) {
                    notificationSystem.show("Victory!", `The ${gameState.currentEnemy.name} is defeated!`);
                    document.getElementById('attack-btn').style.display = 'none';
                    document.getElementById('flee-combat').style.display = 'none';
                    document.getElementById('victory-continue').style.display = 'block';
                }
                
                // Update combat display
                document.getElementById('enemy-stamina').textContent = Math.max(0, gameState.currentEnemy.currentStamina);
                const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
                document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
                
                // Remove the item from inventory
                const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
                
                showScreen('combat-screen');
                return;
            } else {
                notificationSystem.show("Item Used", `You have holy water, but there's no undead to use it on right now.`);
            }
        } else if (item.effect === "skill") {
            // Temporary skill boost for next combat
            notificationSystem.show("Item Used", `You drank ${item.name}. Your Skill is increased by ${item.value} for the next combat.`);
            // This would need to be tracked separately for next combat
        } else if (item.effect === "provision") {
            gameState.player.provisions += item.value;
            notificationSystem.show("Item Bought", `You bought ${item.value} provision(s)!`);
        }
        
        // Remove the item from inventory if it's a single-use consumable
        if (item.effect !== "provision") {
            const itemIndex = gameState.player.inventory.findIndex(i => i.id === item.id);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
        }
        
        updateHeaderStats();
        updateInventoryScreen();
    }

    // ============== COMBAT SYSTEM ==============
    function startCombat(enemyKey, victoryParagraph) {
        gameState.currentEnemy = {
            ...gameState.enemies[enemyKey],
            currentStamina: gameState.enemies[enemyKey].stamina
        };
        
        gameState.combatRound = 0;
        gameState.currentCombatVictoryParagraph = victoryParagraph;
        
        document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
        document.getElementById('enemy-ascii').textContent = gameState.currentEnemy.ascii;
        document.getElementById('enemy-skill').textContent = gameState.currentEnemy.skill;
        document.getElementById('enemy-stamina').textContent = gameState.currentEnemy.currentStamina;
        document.getElementById('player-combat-skill').textContent = gameState.player.skill;
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        
        document.getElementById('player-health-fill').style.width = '100%';
        document.getElementById('enemy-health-fill').style.width = '100%';
        
        document.getElementById('combat-log').innerHTML = `<div>Combat begins! You face a ${gameState.currentEnemy.name}.</div>`;
        
        // Show/hide appropriate buttons
        document.getElementById('attack-btn').style.display = 'block';
        document.getElementById('flee-combat').style.display = 'block';
        document.getElementById('victory-continue').style.display = 'none';
        document.getElementById('use-luck-combat').style.display = 'none';
        
        notificationSystem.show("Combat Started", `You encounter a ${gameState.currentEnemy.name}! Prepare for battle!`);
        
        showScreen('combat-screen');
    }

    function combatRound() {
        gameState.combatRound++;
        
        const playerAttack = rollSkillDice(gameState.player.skill);
        const enemyAttack = rollSkillDice(gameState.currentEnemy.skill);
        
        document.getElementById('combat-dice-roll').style.display = 'block';
        document.getElementById('player-attack').textContent = playerAttack;
        document.getElementById('enemy-attack').textContent = enemyAttack;
        
        let logMessage = '';
        let damage = 0;
        
        if (playerAttack > enemyAttack) {
            // Player hits enemy
            damage = 2;
            gameState.currentEnemy.currentStamina -= damage;
            logMessage = `You hit the ${gameState.currentEnemy.name} for ${damage} damage!`;
            
            if (gameState.currentEnemy.currentStamina <= 0) {
                logMessage += ` The ${gameState.currentEnemy.name} is defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                document.getElementById('flee-combat').style.display = 'none';
                document.getElementById('victory-continue').style.display = 'block';
                notificationSystem.showCombatResult("You defeated the enemy!", "");
            }
        } else if (enemyAttack > playerAttack) {
            // Enemy hits player
            damage = 2;
            gameState.player.stamina -= damage;
            logMessage = `The ${gameState.currentEnemy.name} hits you for ${damage} damage!`;
            
            if (gameState.player.stamina <= 0) {
                logMessage += ` You have been defeated!`;
                document.getElementById('attack-btn').style.display = 'none';
                setTimeout(() => endCombat(false), 1500);
                notificationSystem.showCombatResult("You were defeated!", `You took ${damage} damage.`);
            } else {
                notificationSystem.showCombatResult("Enemy hits you!", `You took ${damage} damage.`);
            }
        } else {
            // Tie
            logMessage = `You both miss each other!`;
            notificationSystem.showCombatResult("Draw!", "Both attacks miss.");
        }
        
        // Update displays
        document.getElementById('player-combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('enemy-stamina').textContent = Math.max(0, gameState.currentEnemy.currentStamina);
        
        const playerHealthPercent = (gameState.player.stamina / gameState.player.maxStamina) * 100;
        const enemyHealthPercent = (gameState.currentEnemy.currentStamina / gameState.currentEnemy.stamina) * 100;
        
        document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
        document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        
        document.getElementById('combat-result').textContent = logMessage;
        
        // Add to combat log
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<strong>Round ${gameState.combatRound}:</strong> ${logMessage}`;
        document.getElementById('combat-log').appendChild(logEntry);
        document.getElementById('combat-log').scrollTop = document.getElementById('combat-log').scrollHeight;
        
        updateHeaderStats();
    }

    function endCombat(victory) {
        if (victory) {
            // Find the victory paragraph from the current story paragraph
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1); // Default to beginning if no victory paragraph specified
            }
        } else {
            showGameOver(`You were defeated by the ${gameState.currentEnemy.name}.`);
        }
    }

    // ============== CAMPAIGN SAVE/LOAD SYSTEM ==============
    function saveGame() {
        const saveData = {
            player: gameState.player,
            currentParagraph: gameState.currentParagraph,
            currentLevel: gameState.currentLevel,
            completedLevels: gameState.completedLevels
        };
        localStorage.setItem('ffCampaignSave', JSON.stringify(saveData));
        notificationSystem.show("Game Saved", "Your progress has been saved successfully!", { timeout: 2000 });
    }

    function loadGame() {
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                
                // Check if player is trying to access a level they shouldn't
                if (saved.currentLevel > 1 && !saved.completedLevels.includes(saved.currentLevel - 1)) {
                    notificationSystem.show("Cannot Load", `You must complete Level ${saved.currentLevel - 1} first!`);
                    return false;
                }
                
                gameState.player = saved.player;
                gameState.currentParagraph = saved.currentParagraph;
                gameState.currentLevel = saved.currentLevel;
                gameState.completedLevels = saved.completedLevels;
                
                // Update level display
                document.getElementById('header-level').textContent = gameState.currentLevel;
                document.getElementById('combat-level').textContent = gameState.currentLevel;
                document.getElementById('inv-level').textContent = gameState.currentLevel;
                document.getElementById('game-over-level').textContent = gameState.currentLevel;
                
                updateHeaderStats();
                showParagraph(gameState.currentParagraph);
                updateMainMenuStats();
                
                notificationSystem.show("Game Loaded", "Your saved game has been loaded successfully!");
                return true;
            } catch (e) {
                console.error("Failed to load saved game:", e);
                notificationSystem.show("Load Failed", "Failed to load saved game. Starting new campaign.");
                return false;
            }
        } else {
            notificationSystem.show("No Save Found", "No saved game found. Start a new campaign.");
            return false;
        }
    }

    function initializeNewGameForLevel(level) {
        // Roll initial stats (as in Fighting Fantasy books)
        gameState.player.baseSkill = rollDice(1) + 6; // 7-12
        gameState.player.baseStamina = rollDice(2) + 12; // 14-24
        gameState.player.baseLuck = rollDice(1) + 6; // 7-12
        
        gameState.player.skill = gameState.player.baseSkill;
        gameState.player.stamina = gameState.player.baseStamina;
        gameState.player.maxStamina = gameState.player.baseStamina;
        gameState.player.luck = gameState.player.baseLuck;
        
        // Different starting gold/provisions per level
        const levelStartingStats = {
            1: { gold: 30, provisions: 8 },
            2: { gold: 40, provisions: 10 },
            3: { gold: 50, provisions: 12 },
            4: { gold: 60, provisions: 14 },
            5: { gold: 70, provisions: 16 }
        };
        
        const stats = levelStartingStats[level] || levelStartingStats[1];
        gameState.player.gold = stats.gold;
        gameState.player.provisions = stats.provisions;
        gameState.player.inventory = [];
        gameState.player.equipped = {
            weapon: null,
            armor: null,
            accessory: null
        };
        
        gameState.currentParagraph = 1;
        gameState.currentLevel = level;
        gameState.completedLevels = [level];
        
        // Save immediately
        saveGame();
        
        updateHeaderStats();
        updateMainMenuStats();
        showParagraph(1);
        
        notificationSystem.show("New Game Started", "A new campaign has begun! Good luck on your adventure!");
    }

    function goToNextLevel() {
        // Unlock next level
        const nextLevel = gameState.currentLevel + 1;
        if (!gameState.completedLevels.includes(nextLevel)) {
            gameState.completedLevels.push(nextLevel);
        }
        
        // Save current state
        saveGame();
        
        // Redirect to next level HTML file
        if (nextLevel <= 5) {
            notificationSystem.show("Level Complete!", `Congratulations! Level ${gameState.currentLevel} complete! Moving to Level ${nextLevel}.`);
            // In a real implementation, this would redirect to level2.html, etc.
            // For now, we'll just show a message
            setTimeout(() => {
                alert(`In the full game, this would redirect to Level ${nextLevel}. For this demo, you can continue playing Level 1.`);
                showScreen('main-menu');
            }, 2000);
        } else {
            notificationSystem.show("Campaign Complete!", "Congratulations! You've completed the entire campaign!");
            showScreen('main-menu');
        }
    }

    function loadLevel(level) {
        // Check if level is unlocked
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            const saved = JSON.parse(saveData);
            if (!saved.completedLevels.includes(level) && level > 1) {
                notificationSystem.show("Level Locked", `Level ${level} is locked. Complete Level ${level - 1} first!`);
                return;
            }
        } else if (level > 1) {
            notificationSystem.show("Level Locked", `Level ${level} is locked. Start a new campaign first!`);
            return;
        }
        
        // Save current state with new level
        if (saveData) {
            const saved = JSON.parse(saveData);
            saved.currentLevel = level;
            saved.currentParagraph = 1; // Start at beginning of level
            localStorage.setItem('ffCampaignSave', JSON.stringify(saved));
        }
        
        // For this demo, we only have Level 1
        if (level === 1) {
            showScreen('main-menu');
            notificationSystem.show("Level Selected", "Starting Level 1: Island of the Undead");
        } else {
            notificationSystem.show("Level Not Available", `Level ${level} is not available in this demo. Only Level 1 is implemented.`);
        }
    }

    // ============== LEVEL MANAGEMENT ==============
    function showLevelSelect() {
        const levelButtons = document.getElementById('level-buttons');
        levelButtons.innerHTML = '';
        
        // Create buttons for each level
        for (let i = 1; i <= 5; i++) {
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `LEVEL ${i}: ${getLevelName(i)}`;
            
            // Check if level is unlocked
            const saveData = localStorage.getItem('ffCampaignSave');
            let isUnlocked = i === 1; // Level 1 is always unlocked
            
            if (saveData) {
                const saved = JSON.parse(saveData);
                if (saved.completedLevels && saved.completedLevels.includes(i)) {
                    isUnlocked = true;
                } else if (i > 1) {
                    // Check if previous level is completed
                    if (saved.completedLevels && saved.completedLevels.includes(i-1)) {
                        isUnlocked = true;
                    }
                }
            }
            
            if (isUnlocked) {
                button.onclick = () => loadLevel(i);
            } else {
                button.disabled = true;
                button.textContent += ' (LOCKED)';
            }
            
            levelButtons.appendChild(button);
        }
        
        showScreen('level-select-screen');
    }

    function getLevelName(level) {
        const levelNames = {
            1: "Island of the Undead",
            2: "City of Shadows",
            3: "Mountain of Doom",
            4: "Caverns of Chaos",
            5: "Final Battle"
        };
        return levelNames[level] || `Level ${level}`;
    }

    function showCampaignProgress() {
        const saveData = localStorage.getItem('ffCampaignSave');
        let progressHtml = "<h3>CAMPAIGN PROGRESS</h3>";
        
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                const currentLevel = saved.currentLevel || 1;
                const completedLevels = saved.completedLevels || [1];
                const characterLevel = Math.floor(saved.player.skill/3 + saved.player.maxStamina/20 + saved.player.luck/6);
                
                progressHtml += `<p><strong>Current Level:</strong> ${currentLevel} - ${getLevelName(currentLevel)}</p>`;
                progressHtml += `<p><strong>Character Level:</strong> ${characterLevel}</p>`;
                progressHtml += `<p><strong>Gold:</strong> ${saved.player.gold}</p>`;
                progressHtml += `<p><strong>Skill:</strong> ${saved.player.skill}</p>`;
                progressHtml += `<p><strong>Stamina:</strong> ${saved.player.stamina}/${saved.player.maxStamina}</p>`;
                progressHtml += `<p><strong>Luck:</strong> ${saved.player.luck}</p>`;
                
                progressHtml += `<h4>Completed Levels:</h4>`;
                for (let i = 1; i <= 5; i++) {
                    const isCompleted = completedLevels.includes(i);
                    progressHtml += `<p>${isCompleted ? '✅' : '🔒'} Level ${i}: ${getLevelName(i)} ${isCompleted ? '(COMPLETED)' : '(LOCKED)'}</p>`;
                }
            } catch (e) {
                progressHtml += "<p>Error reading save data. Start a new campaign.</p>";
            }
        } else {
            progressHtml += "<p>No campaign progress yet. Start a new game!</p>";
        }
        
        document.getElementById('progress-content').innerHTML = progressHtml;
        showScreen('progress-screen');
    }

    function updateMainMenuStats() {
        const saveData = localStorage.getItem('ffCampaignSave');
        if (saveData) {
            try {
                const saved = JSON.parse(saveData);
                document.getElementById('menu-current-level').textContent = saved.currentLevel || 1;
                document.getElementById('menu-character-level').textContent = Math.floor(saved.player.skill/3 + saved.player.maxStamina/20 + saved.player.luck/6);
                document.getElementById('menu-gold').textContent = saved.player.gold;
            } catch (e) {
                // If error, show defaults
                document.getElementById('menu-current-level').textContent = '-';
                document.getElementById('menu-character-level').textContent = '-';
                document.getElementById('menu-gold').textContent = '-';
            }
        } else {
            document.getElementById('menu-current-level').textContent = '-';
            document.getElementById('menu-character-level').textContent = '-';
            document.getElementById('menu-gold').textContent = '-';
        }
    }

    // ============== STORY SYSTEM ==============
    function showParagraph(paragraphId) {
        gameState.currentParagraph = paragraphId;
        const paragraph = gameState.story[paragraphId];
        
        if (!paragraph) {
            showGameOver("Your adventure has reached an unknown path.");
            return;
        }
        
        if (paragraph.gameOver) {
            showGameOver(paragraph.text);
            return;
        }
        
        if (paragraph.victory) {
            showVictory();
            return;
        }
        
        document.getElementById('story-title').textContent = paragraph.title;
        document.getElementById('story-text').textContent = paragraph.text;
        
        // Clear previous choices
        const choiceList = document.getElementById('choice-list');
        choiceList.innerHTML = '';
        
        // Hide dice and luck sections
        document.getElementById('dice-roll-section').style.display = 'none';
        document.getElementById('luck-test-section').style.display = 'none';
        
        // Make sure choice list is visible
        choiceList.style.display = 'block';
        
        // Apply damage if any
        if (paragraph.damage) {
            gameState.player.stamina = Math.max(0, gameState.player.stamina - paragraph.damage);
            notificationSystem.show("Damage Taken", `You took ${paragraph.damage} damage!`);
            updateHeaderStats();
            
            if (gameState.player.stamina <= 0) {
                showGameOver("You have succumbed to your injuries.");
                return;
            }
        }
        
        // Add new choices
        if (paragraph.choices && paragraph.choices.length > 0) {
            paragraph.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                
                // Handle dynamic next values
                let nextValue = choice.next;
                if (typeof nextValue === 'function') {
                    nextValue = nextValue();
                }
                
                button.textContent = choice.text;
                
                if (choice.cost && choice.cost > gameState.player.gold) {
                    button.disabled = true;
                    button.textContent += ` (Need ${choice.cost} Gold)`;
                }
                
                button.addEventListener('click', () => {
                    handleChoice(choice);
                });
                
                choiceList.appendChild(button);
            });
        } else if (paragraph.combat) {
            // If paragraph leads directly to combat
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = `Fight the ${paragraph.combat.enemy}`;
            button.addEventListener('click', () => {
                startCombat(paragraph.combat.enemy, paragraph.combat.victory);
            });
            choiceList.appendChild(button);
        } else if (paragraph.testLuck) {
            // If paragraph requires a luck test
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = "Test Your Luck";
            button.addEventListener('click', () => {
                const luckResult = testLuck();
                if (luckResult.lucky) {
                    showParagraph(paragraph.testLuck.lucky);
                } else {
                    showParagraph(paragraph.testLuck.unlucky);
                }
            });
            choiceList.appendChild(button);
        } else if (paragraph.skillTest) {
            // If paragraph requires a skill test
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = "Test Your Skill";
            button.addEventListener('click', () => {
                const skillTest = rollSkillDice(gameState.player.skill);
                const target = 12; // Typical target number
                if (skillTest >= target) {
                    showParagraph(paragraph.skillTest.success);
                } else {
                    showParagraph(paragraph.skillTest.failure);
                }
            });
            choiceList.appendChild(button);
        }
        
        // Apply rewards if any
        if (paragraph.reward) {
            if (typeof paragraph.reward === 'function') {
                const reward = paragraph.reward();
                applyReward(reward);
            } else {
                applyReward(paragraph.reward);
            }
        }
        
        // Apply damage bonus if any (for backstabs, etc.)
        if (paragraph.damageBonus) {
            // This would need to be implemented in combat
            notificationSystem.show("Advantage Gained", `You have a damage advantage of +${paragraph.damageBonus} for the next combat!`);
        }
        
        updateHeaderStats();
        showScreen('story-screen');
    }

    function applyReward(reward) {
        if (reward.gold) {
            gameState.player.gold += reward.gold;
            if (reward.gold > 0) {
                notificationSystem.showReward({ gold: reward.gold });
            } else if (reward.gold < 0) {
                notificationSystem.show("Gold Lost", `You lost ${Math.abs(reward.gold)} gold!`);
            }
        }
        if (reward.inventory) {
            gameState.player.inventory.push(...reward.inventory);
            notificationSystem.showReward({ inventory: reward.inventory });
        }
        if (reward.skill) {
            gameState.player.skill += reward.skill;
            gameState.player.baseSkill += reward.skill;
            notificationSystem.showReward({ skill: reward.skill });
        }
        if (reward.maxStamina) {
            gameState.player.maxStamina += reward.maxStamina;
            gameState.player.baseStamina += reward.maxStamina;
            notificationSystem.showReward({ maxStamina: reward.maxStamina });
        }
        if (reward.stamina) {
            gameState.player.stamina = Math.min(gameState.player.maxStamina, gameState.player.stamina + reward.stamina);
            notificationSystem.showReward({ stamina: reward.stamina });
        }
        if (reward.provisions) {
            gameState.player.provisions += reward.provisions;
            notificationSystem.showReward({ provisions: reward.provisions });
        }
        
        updateHeaderStats();
        updateMainMenuStats();
    }

    function handleChoice(choice) {
        if (choice.cost && choice.cost > 0) {
            if (gameState.player.gold < choice.cost) {
                notificationSystem.show("Not Enough Gold", `You need ${choice.cost} Gold for this choice!`);
                return;
            }
            gameState.player.gold -= choice.cost;
        }
        
        if (choice.test === "luck") {
            // Show luck test interface
            document.getElementById('luck-test-section').style.display = 'block';
            document.getElementById('choice-list').style.display = 'none';
            
            const luckResult = testLuck();
            document.getElementById('luck-dice-result').textContent = luckResult.roll;
            
            if (luckResult.lucky) {
                document.getElementById('luck-result').textContent = "You are Lucky!";
                document.getElementById('luck-result').className = "luck-result success";
            } else {
                document.getElementById('luck-result').textContent = "You are Unlucky!";
                document.getElementById('luck-result').className = "luck-result failure";
            }
            
            // Store the luck test result
            gameState.lastLuckTest = luckResult;
            
            updateHeaderStats();
            updateMainMenuStats();
        } else if (choice.combat) {
            startCombat(choice.combat, choice.next);
        } else {
            // Handle dynamic next values
            let nextValue = choice.next;
            if (typeof nextValue === 'function') {
                nextValue = nextValue();
            }
            showParagraph(nextValue);
        }
    }

    // ============== MARKET SYSTEM ==============
    function updateMarketScreen() {
        const marketItems = document.getElementById('market-items');
        marketItems.innerHTML = '';
        
        gameState.marketItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'market-item';
            
            const itemInfo = document.createElement('div');
            itemInfo.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.description}</p>
                <p><strong>Cost: ${item.cost} Gold</strong></p>
            `;
            
            const buyButton = document.createElement('button');
            buyButton.className = 'item-action-btn';
            buyButton.textContent = 'Buy';
            buyButton.onclick = () => buyItem(item);
            buyButton.disabled = gameState.player.gold < item.cost;
            
            itemElement.appendChild(itemInfo);
            itemElement.appendChild(buyButton);
            marketItems.appendChild(itemElement);
        });
        
        document.getElementById('market-gold').textContent = gameState.player.gold;
    }

    function buyItem(item) {
        if (gameState.player.gold < item.cost) {
            notificationSystem.show("Not Enough Gold", "You don't have enough gold!");
            return;
        }
        
        gameState.player.gold -= item.cost;
        
        if (item.type === "consumable" && item.effect === "provision") {
            gameState.player.provisions += item.value;
            notificationSystem.show("Item Purchased", `You bought ${item.value} provision(s) for ${item.cost} gold.`);
        } else {
            // Create a copy of the item to add to inventory
            const itemCopy = {...item};
            gameState.player.inventory.push(itemCopy);
            notificationSystem.show("Item Purchased", `You bought ${item.name} for ${item.cost} gold.`);
        }
        
        updateMarketScreen();
        updateHeaderStats();
        updateInventoryScreen();
        updateMainMenuStats();
    }

    // ============== UI MANAGEMENT ==============
    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenName).classList.add('active');
    }

    function updateHeaderStats() {
        document.getElementById('header-level').textContent = gameState.currentLevel;
        document.getElementById('header-skill').textContent = gameState.player.skill;
        document.getElementById('header-stamina').textContent = gameState.player.stamina;
        document.getElementById('header-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('header-luck').textContent = gameState.player.luck;
        document.getElementById('header-gold').textContent = gameState.player.gold;
        
        document.getElementById('combat-level').textContent = gameState.currentLevel;
        document.getElementById('combat-skill').textContent = gameState.player.skill;
        document.getElementById('combat-stamina').textContent = gameState.player.stamina;
        document.getElementById('combat-max-stamina').textContent = gameState.player.maxStamina;
        document.getElementById('combat-luck').textContent = gameState.player.luck;
        
        document.getElementById('inv-level').textContent = gameState.currentLevel;
        document.getElementById('inv-skill').textContent = gameState.player.skill;
        document.getElementById('inv-stamina').textContent = gameState.player.stamina;
        document.getElementById('inv-luck').textContent = gameState.player.luck;
        document.getElementById('inv-gold').textContent = gameState.player.gold;
        document.getElementById('provisions-count').textContent = gameState.player.provisions;
    }

    function updateInventoryScreen() {
        const equippedItems = document.getElementById('equipped-items');
        equippedItems.innerHTML = '';
        
        // Show equipped items
        Object.keys(gameState.player.equipped).forEach(slot => {
            const item = gameState.player.equipped[slot];
            if (item) {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-equipped';
                
                let itemText = `${slot.charAt(0).toUpperCase() + slot.slice(1)}: ${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                const unequipButton = document.createElement('button');
                unequipButton.className = 'item-action-btn';
                unequipButton.textContent = 'Unequip';
                unequipButton.onclick = () => unequipItem(item);
                actionsElement.appendChild(unequipButton);
                
                itemElement.appendChild(actionsElement);
                equippedItems.appendChild(itemElement);
            }
        });
        
        const inventoryList = document.getElementById('inventory-list');
        inventoryList.innerHTML = '';
        
        if (gameState.player.inventory.length === 0) {
            inventoryList.innerHTML = '<div style="text-align: center; padding: 10px; color: #a0a0a0;">Your backpack is empty</div>';
        } else {
            gameState.player.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item item-special';
                
                let itemText = `${item.name}`;
                if (item.skillBonus) itemText += ` (+${item.skillBonus} Skill)`;
                if (item.staminaBonus) itemText += ` (+${item.staminaBonus} Stamina)`;
                if (item.luckBonus) itemText += ` (+${item.luckBonus} Luck)`;
                if (item.effect === "heal") itemText += ` (Heals ${item.value} Stamina)`;
                if (item.effect === "holy") itemText += ` (Damages undead: ${item.value})`;
                if (item.effect === "skill") itemText += ` (+${item.value} Skill for next combat)`;
                
                const textElement = document.createElement('div');
                textElement.textContent = itemText;
                itemElement.appendChild(textElement);
                
                const actionsElement = document.createElement('div');
                actionsElement.className = 'item-actions';
                
                if (item.type === "weapon" || item.type === "armor" || item.type === "accessory") {
                    const equipButton = document.createElement('button');
                    equipButton.className = 'item-action-btn';
                    equipButton.textContent = 'Equip';
                    equipButton.onclick = () => equipItem(item);
                    actionsElement.appendChild(equipButton);
                }
                
                if (item.type === "consumable") {
                    const useButton = document.createElement('button');
                    useButton.className = 'item-action-btn';
                    useButton.textContent = 'Use';
                    useButton.onclick = () => useConsumable(item);
                    actionsElement.appendChild(useButton);
                }
                
                itemElement.appendChild(actionsElement);
                inventoryList.appendChild(itemElement);
            });
        }
    }

    function showGameOver(message) {
        document.getElementById('game-over-message').textContent = message;
        document.getElementById('game-over-level').textContent = gameState.currentLevel;
        document.getElementById('game-over-location').textContent = gameState.story[gameState.currentParagraph]?.title || "Unknown";
        document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
        
        // Hide next level button on game over
        document.getElementById('next-level-btn').style.display = 'none';
        
        showScreen('game-over-screen');
    }

    function showVictory() {
    // Unlock next level
    const nextLevel = gameState.currentLevel + 1;
    if (!gameState.completedLevels.includes(nextLevel) && nextLevel <= 5) {
        gameState.completedLevels.push(nextLevel);
        saveGame(); // Save with unlocked level
    }
    
    // Check if this is the final level
    const isFinalLevel = gameState.currentLevel >= 5;
    
    document.getElementById('game-over-message').innerHTML = `
        <h3>${isFinalLevel ? 'CONGRATULATIONS!' : 'LEVEL COMPLETE!'}</h3>
        <p>${isFinalLevel ? 
            'You have completed the entire campaign! You are a true hero.' : 
            'You have defeated Malakar and broken the curse! Ready for the next challenge?'}</p>
    `;
    document.getElementById('game-over-message').className = "game-over-message victory-message";
    document.getElementById('game-over-level').textContent = gameState.currentLevel;
    document.getElementById('game-over-location').textContent = `LEVEL ${gameState.currentLevel} COMPLETE`;
    document.getElementById('game-over-paragraph').textContent = gameState.currentParagraph;
    
    // Show/hide appropriate buttons
    document.getElementById('restart-after-game-over').textContent = isFinalLevel ? "PLAY AGAIN" : "RETRY LEVEL";
    
    if (!isFinalLevel) {
        document.getElementById('next-level-btn').style.display = 'block';
        
        // Set different button text and action for Level 1 vs other levels
        if (gameState.currentLevel === 1) {
            document.getElementById('next-level-btn').textContent = 'NEXT LEVEL → CITY OF SHADOWS';
            // Override the existing onclick from initialization
            document.getElementById('next-level-btn').onclick = function() {
                // Save current state
                saveGame();
                // Redirect to Level 2 with parameter
                window.location.href = 'level2.html?fromLevel1=true';
            };
        } else {
            document.getElementById('next-level-btn').textContent = `NEXT LEVEL → (Level ${nextLevel})`;
            // For other levels, use the existing goToNextLevel function
            document.getElementById('next-level-btn').onclick = goToNextLevel;
        }
    } else {
        document.getElementById('next-level-btn').style.display = 'none';
    }
    
    showScreen('game-over-screen');
    updateMainMenuStats();
}

    function eatProvision() {
        if (gameState.player.provisions > 0) {
            const healAmount = Math.min(4, gameState.player.maxStamina - gameState.player.stamina);
            gameState.player.stamina += healAmount;
            gameState.player.provisions--;
            updateHeaderStats();
            updateInventoryScreen();
            updateMainMenuStats();
            notificationSystem.show("Provision Eaten", `You eat a provision and restore ${healAmount} Stamina.`);
        } else {
            notificationSystem.show("No Provisions", "You have no provisions left!");
        }
    }

    // ============== INITIALIZATION ==============
    document.addEventListener('DOMContentLoaded', function() {
        // Update main menu stats
        updateMainMenuStats();
        
        // Main menu buttons
        document.getElementById('new-game').addEventListener('click', () => {
            notificationSystem.show("Start New Game", "Are you sure you want to start a new campaign? This will overwrite any existing save.", {
                buttons: [
                    { text: "Yes, Start New", action: "initializeNewGameForLevel(1)" },
                    { text: "Cancel", action: "notificationSystem.closePopup('popup-' + Date.now())" }
                ]
            });
        });
        
        document.getElementById('continue-game').addEventListener('click', () => {
            if (!loadGame()) {
                // If no save exists, start new game
                notificationSystem.show("No Save Found", "No saved game found. Start a new campaign?", {
                    buttons: [
                        { text: "Start New", action: "initializeNewGameForLevel(1)" },
                        { text: "Cancel", action: "notificationSystem.closePopup('popup-' + Date.now())" }
                    ]
                });
            }
        });
        
        document.getElementById('select-level').addEventListener('click', showLevelSelect);
        document.getElementById('campaign-progress').addEventListener('click', showCampaignProgress);
        document.getElementById('rules-btn').addEventListener('click', () => showScreen('rules-screen'));
        
        // Story screen buttons
        document.getElementById('inventory-btn').addEventListener('click', () => {
            updateInventoryScreen();
            showScreen('inventory-screen');
        });
        document.getElementById('market-btn').addEventListener('click', () => {
            updateMarketScreen();
            showScreen('market-screen');
        });
        document.getElementById('save-game').addEventListener('click', saveGame);
        
        // Inventory screen buttons
        document.getElementById('back-from-inventory').addEventListener('click', () => showScreen('story-screen'));
        document.getElementById('eat-provision').addEventListener('click', eatProvision);
        
        // Market screen buttons
        document.getElementById('back-from-market').addEventListener('click', () => showScreen('story-screen'));
        
        // Level select screen buttons
        document.getElementById('back-from-level-select').addEventListener('click', () => showScreen('main-menu'));
        
        // Progress screen buttons
        document.getElementById('back-from-progress').addEventListener('click', () => showScreen('main-menu'));
        
        // Rules screen buttons
        document.getElementById('back-from-rules').addEventListener('click', () => showScreen('main-menu'));
        
        // Combat screen buttons
        document.getElementById('attack-btn').addEventListener('click', combatRound);
        document.getElementById('flee-combat').addEventListener('click', () => {
            notificationSystem.show("Attempting to Flee", "You try to flee from combat...", { timeout: 1000 });
            setTimeout(() => {
                if (Math.random() < 0.5) {
                    // Successful flee
                    document.getElementById('combat-log').innerHTML += '<div>You successfully flee from combat!</div>';
                    notificationSystem.show("Flee Successful", "You successfully flee from combat!");
                    setTimeout(() => showParagraph(1), 1500);
                } else {
                    // Failed flee - enemy gets a free attack
                    document.getElementById('combat-log').innerHTML += '<div>You fail to flee! The enemy attacks!</div>';
                    gameState.player.stamina -= 2;
                    updateHeaderStats();
                    updateMainMenuStats();
                    
                    if (gameState.player.stamina <= 0) {
                        document.getElementById('combat-log').innerHTML += '<div>You have been defeated!</div>';
                        notificationSystem.show("Flee Failed", "You failed to flee and were defeated!");
                        setTimeout(() => endCombat(false), 1500);
                    } else {
                        notificationSystem.show("Flee Failed", "You failed to flee and took 2 damage!");
                    }
                }
            }, 1000);
        });
        
        // Victory continue button
        document.getElementById('victory-continue').addEventListener('click', () => {
            if (gameState.currentCombatVictoryParagraph) {
                showParagraph(gameState.currentCombatVictoryParagraph);
            } else {
                showParagraph(1);
            }
        });
        
        // Next level button - Reset onclick in case it was modified
document.getElementById('next-level-btn').onclick = goToNextLevel;
        
        // Luck test buttons
        document.getElementById('continue-after-luck').addEventListener('click', () => {
            document.getElementById('luck-test-section').style.display = 'none';
            document.getElementById('choice-list').style.display = 'block';
        });
        
        // Game over buttons
        document.getElementById('restart-after-game-over').addEventListener('click', () => {
            initializeNewGameForLevel(gameState.currentLevel);
        });
        
        document.getElementById('main-menu-after-game-over').addEventListener('click', () => {
            showScreen('main-menu');
            updateMainMenuStats();
        });
        
        // Test the notification system
        setTimeout(() => {
            // Show a welcome notification after a short delay
            notificationSystem.show("Welcome!", "Welcome to Fighting Fantasy: The Island of the Undead! Your adventure begins now...", { timeout: 3000 });
        }, 1000);
    });
    </script>
</body>
</html>
