<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>House of Hell - Level 1: The Entrance Hall</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }
        
        /* Container */
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 10px;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed #0f0;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2rem;
            color: #ff3030;
            text-shadow: 0 0 5px #ff0000;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #0f0;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #ff0;
            font-size: 1rem;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 5px 10px;
            border-radius: 10px;
            z-index: 4;
        }
        
        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #111;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
            padding: 3px;
            border: 1px solid #333;
            border-radius: 3px;
            position: relative;
            cursor: help;
        }
        
        .stat-item:hover {
            border-color: #0f0;
            background-color: #222;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .stat-value {
            font-size: 1.3rem;
            color: #ff0;
            font-weight: bold;
        }
        
        .stat-max {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid #0f0;
            background-color: #111;
            margin-bottom: 15px;
            font-size: 1.2rem;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #0f0 #000;
        }
        
        .content::-webkit-scrollbar {
            width: 10px;
        }
        
        .content::-webkit-scrollbar-track {
            background: #000;
        }
        
        .content::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 0;
        }
        
        /* Choices */
        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .choice-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .choice-btn i {
            font-size: 1.1rem;
        }
        
        .choice-btn:active, .choice-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-2px);
        }
        
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px dashed #0f0;
        }
        
        .control-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .control-btn:active, .control-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-text {
            color: #0f0;
            font-size: 1.5rem;
            margin-bottom: 20px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .loading-bar {
            width: 80%;
            height: 20px;
            border: 1px solid #0f0;
            padding: 2px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background-color: #0f0;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        .footer {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            padding-top: 10px;
            border-top: 1px dashed #333;
        }
        
        /* Visual Effects */
        .screen-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 10s linear infinite;
            z-index: 2;
        }
        
        @keyframes scanline {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .crt-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(0, 255, 0, 0.03) 50%,
                rgba(0, 0, 0, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 3;
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            font-size: 1.2rem;
            border-radius: 50%;
        }
        
        /* Page Navigation */
        .page-nav {
            position: absolute;
            top: 15px;
            left: 70px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-nav:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Responsive */
        @media (max-height: 700px) {
            h1 { font-size: 1.7rem; }
            .subtitle { font-size: 1rem; }
            .content { font-size: 1.1rem; }
            .choice-btn { padding: 10px 12px; font-size: 1.1rem; }
        }
        
        @media (max-width: 400px) {
            .container { padding: 8px; }
            h1 { font-size: 1.5rem; }
            .choice-btn { padding: 8px 10px; font-size: 1rem; }
            .page-nav { left: 60px; padding: 5px 10px; }
        }
        
        /* Death Message */
        .death-message {
            color: #ff3030;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 10px;
            border: 1px solid #ff3030;
            margin: 10px 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced Inventory Panel */
        .inventory-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .inventory-header {
            padding: 15px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-title {
            color: #ff0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        
        .inventory-close {
            background: none;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inventory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .inventory-item-card {
            background-color: #111;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .inventory-item-card:hover {
            transform: translateY(-5px);
            border-color: #0f0;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        .inventory-item-card.item-equipped {
            border-color: #ff0;
            background-color: #222;
        }
        
        .item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #0f0;
        }
        
        .item-name {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .item-type {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }
        
        .item-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #0f0;
            color: #000;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .item-details {
            background-color: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .item-description {
            color: #ccc;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-action-btn {
            flex: 1;
            padding: 8px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .item-action-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .inventory-footer {
            padding: 15px;
            background-color: #000;
            border-top: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-stats {
            color: #0f0;
            font-size: 1rem;
        }
        
        .inventory-empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* Inventory Button */
        .inventory-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .inventory-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff3030;
            color: #000;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Combat Panel */
        .combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #ff3030;
            padding: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .combat-title {
            color: #ff3030;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff0000;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #ff0000; }
            50% { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff3030; }
        }
        
        .combatants {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .combatant {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .combatant.enemy {
            border-color: #ff3030;
        }
        
        .combatant-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ff0;
        }
        
        .combatant.enemy .combatant-name {
            color: #ff3030;
        }
        
        .combatant-stats {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .health-bar-container {
            margin: 10px 0;
        }
        
        .health-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .health-bar {
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .health-fill {
            height: 100%;
            background-color: #0f0;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .health-fill.enemy {
            background-color: #ff3030;
        }
        
        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .combat-log {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dotted #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .player-log {
            color: #0f0;
            border-left: 3px solid #0f0;
            padding-left: 10px;
        }
        
        .enemy-log {
            color: #ff3030;
            border-left: 3px solid #ff3030;
            padding-left: 10px;
        }
        
        .event-log {
            color: #ff0;
            border-left: 3px solid #ff0;
            padding-left: 10px;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .combat-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            border-radius: 5px;
        }
        
        .combat-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .combat-btn.attack {
            border-color: #ff3030;
            color: #ff3030;
        }
        
        .combat-btn.attack:hover {
            background-color: #ff3030;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 48, 48, 0.3);
        }
        
        .combat-btn.flee {
            border-color: #ff8000;
            color: #ff8000;
        }
        
        .combat-btn.flee:hover {
            background-color: #ff8000;
            color: #000;
        }
        
        /* Dialog Panel */
        .dialog-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 20;
            width: 90%;
            max-width: 400px;
        }
        
        .dialog-title {
            color: #0f0;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        .dialog-text {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialog-option {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .dialog-option:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 1px solid #0f0;
            padding: 15px 20px;
            z-index: 30;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #0f0;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .loading-tip {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* Stat tooltip */
        .stat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            margin-bottom: 5px;
        }
        
        .stat-item:hover .stat-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000;
            z-index: 100;
        }
        
        .damage-number.player {
            color: #ff3030;
        }
        
        .damage-number.enemy {
            color: #0f0;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Item tooltip */
        .item-tooltip {
            position: absolute;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            max-width: 200px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .inventory-item-card:hover .item-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Level Complete Screen */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 60;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .level-complete h2 {
            color: #ff0;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            animation: glow 2s infinite;
        }
        
        .level-complete p {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 600px;
        }
        
        .level-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .level-stat {
            text-align: center;
        }
        
        .level-stat-value {
            font-size: 2rem;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .level-stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .level-complete-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-complete-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .level-complete-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .level-complete-btn.next {
            background-color: #000;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-complete-btn.next:hover {
            background-color: #ff0;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 255, 0, 0.3);
        }
        
        /* Level 1 specific: mansion entrance theme */
        .mansion-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(50, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(30, 0, 30, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Inventory Button */
        .inventory-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .inventory-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff3030;
            color: #000;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="screen-border"></div>
    <div class="scanline"></div>
    <div class="crt-effect"></div>
    <div class="mansion-effect"></div>
    
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-text">HOUSE OF HELL</div>
        <div class="loading-text">LEVEL 1 - THE ENTRANCE HALL</div>
        <div class="loading-text">LOADING ADVENTURE...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingStatus">Initializing your journey...</div>
        <div class="loading-tip">Welcome, brave soul. Your journey into the House of Hell begins here.</div>
    </div>
    
    <!-- Main Game Container -->
    <div class="container hidden" id="gameContainer">
        <!-- Top Controls -->
        <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>
        <button class="inventory-toggle" id="inventoryToggle" title="Inventory">
            <i class="fas fa-backpack"></i>
            <span class="inventory-badge" id="inventoryBadge">0</span>
        </button>
        
        <!-- Page Navigation -->
        <button class="page-nav" id="pageNav" title="Select Level">
            <i class="fas fa-map"></i> Level 1
        </button>
        
        <!-- Enhanced Inventory Panel -->
        <div class="inventory-panel hidden" id="inventoryPanel">
            <div class="inventory-header">
                <div class="inventory-title">INVENTORY - LEVEL 1</div>
                <button class="inventory-close" id="inventoryClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inventory-content" id="inventoryContent">
                <!-- Items will be added here -->
            </div>
            <div class="inventory-footer">
                <div class="inventory-stats">
                    <span id="inventoryWeight">Weight: 0/10</span> | 
                    <span id="inventoryGold">Gold: 0</span> | 
                    <span id="inventoryCount">Items: 0</span>
                </div>
                <button class="item-action-btn" id="organizeInventory">
                    <i class="fas fa-sort-alpha-down"></i> Organize
                </button>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div>
                <h1>HOUSE OF HELL</h1>
                <div class="subtitle">Level 1 - The Entrance Hall</div>
            </div>
            <div class="level-indicator">Level 1</div>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">FEAR</div>
                <div class="stat-value" id="fearValue">0</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Fear level. If it reaches 20, you go mad!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">STAMINA</div>
                <div class="stat-value" id="staminaValue">20</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Your health. If it reaches 0, you die!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">SKILL</div>
                <div class="stat-value" id="skillValue">7</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your fighting ability. Higher is better!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">LUCK</div>
                <div class="stat-value" id="luckValue">12</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your luck. Test it in dangerous situations!</div>
            </div>
        </div>
        
        <!-- Story Text -->
        <div class="content" id="storyText">
            <!-- Story text will appear here -->
        </div>
        
        <!-- Choices -->
        <div class="choices" id="choicesContainer">
            <!-- Choice buttons will appear here -->
        </div>
        
        <!-- Bottom Controls -->
        <div class="controls">
            <button class="control-btn" id="restartBtn">
                <i class="fas fa-redo"></i> RESTART
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i> SAVE
            </button>
            <button class="control-btn" id="loadBtn">
                <i class="fas fa-folder-open"></i> LOAD
            </button>
            <button class="control-btn" id="hintBtn">
                <i class="fas fa-lightbulb"></i> HINT
            </button>
        </div>
        
        <div class="footer">
            Based on the gamebook by Steve Jackson & Ian Livingstone | Enhanced Edition | Level 1 of 4
        </div>
        
        <!-- Enhanced Combat Panel -->
        <div class="combat-panel hidden" id="combatPanel">
            <div class="combat-title">COMBAT</div>
            <div class="combatants">
                <div class="combatant player">
                    <div class="combatant-name" id="playerCombatName">YOU</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="playerCombatSkill">7</span></div>
                        <div>STAMINA: <span id="playerCombatStamina">20</span></div>
                        <div>LUCK: <span id="playerCombatLuck">12</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="playerHealthText">20/20</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill" id="playerHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="combatant enemy">
                    <div class="combatant-name" id="enemyCombatName">ENEMY</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="enemyCombatSkill">6</span></div>
                        <div>STAMINA: <span id="enemyCombatStamina">10</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="enemyHealthText">10/10</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill enemy" id="enemyHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="combat-log" id="combatLog"></div>
            <div class="combat-actions" id="combatActions">
                <button class="combat-btn attack" id="combatAttack">
                    <i class="fas fa-fist-raised"></i> ATTACK
                </button>
                <button class="combat-btn" id="combatUseItem">
                    <i class="fas fa-box-open"></i> USE ITEM
                </button>
                <button class="combat-btn" id="combatLuck">
                    <i class="fas fa-dice"></i> TEST LUCK
                </button>
                <button class="combat-btn flee" id="combatFlee">
                    <i class="fas fa-running"></i> FLEE
                </button>
            </div>
        </div>
        
        <!-- Dialog Panel -->
        <div class="dialog-panel hidden" id="dialogPanel">
            <div class="dialog-title" id="dialogTitle">DIALOG</div>
            <div class="dialog-text" id="dialogText"></div>
            <div class="dialog-options" id="dialogOptions"></div>
        </div>
        
        <!-- Notification -->
        <div class="notification hidden" id="notification">
            <button class="notification-close" id="notificationClose">&times;</button>
            <div id="notificationText"></div>
        </div>
        
        <!-- Level Complete Screen -->
        <div class="level-complete hidden" id="levelComplete">
            <h2>LEVEL 1 COMPLETE!</h2>
            <p>You have survived the entrance hall of the House of Hell. But your journey has only just begun...</p>
            
            <div class="level-stats">
                <div class="level-stat">
                    <div class="level-stat-value" id="completeFear">0</div>
                    <div class="level-stat-label">Fear</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeStamina">20</div>
                    <div class="level-stat-label">Stamina</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeItems">0</div>
                    <div class="level-stat-label">Items</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeGold">0</div>
                    <div class="level-stat-label">Gold</div>
                </div>
            </div>
            
            <p>Your progress has been saved. Continue to the next level or stay and explore more.</p>
            
            <div class="level-complete-buttons">
                <button class="level-complete-btn" id="continueExploring">
                    <i class="fas fa-search"></i> Keep Exploring
                </button>
                <button class="level-complete-btn next" id="nextLevelBtn">
                    <i class="fas fa-arrow-right"></i> Next Level
                </button>
            </div>
        </div>
    </div>

<script>
// ============================================
// SOUND MANAGER
// ============================================

class SoundManager {
    constructor() {
        this.sounds = {};
        this.enabled = true;
        this.context = null;
        this.initialized = false;
        this.masterVolume = 0.7;
        
        // Sound definitions
        this.soundDefs = {
            'click': { type: 'synth', frequency: 800, duration: 0.1, volume: 0.3 },
            'hover': { type: 'synth', frequency: 600, duration: 0.05, volume: 0.2 },
            'combat_attack': { type: 'synth', frequency: 1200, duration: 0.2, volume: 0.5 },
            'combat_hit': { type: 'synth', frequency: 300, duration: 0.1, volume: 0.6 },
            'combat_miss': { type: 'synth', frequency: 200, duration: 0.1, volume: 0.4 },
            'combat_critical': { type: 'synth', frequency: 1500, duration: 0.3, volume: 0.7 },
            'item_pickup': { type: 'synth', frequency: 1000, duration: 0.2, volume: 0.4 },
            'item_use': { type: 'synth', frequency: 1200, duration: 0.3, volume: 0.5 },
            'heal': { type: 'synth', frequency: 800, duration: 0.5, volume: 0.5 },
            'damage': { type: 'synth', frequency: 400, duration: 0.2, volume: 0.6 },
            'death': { type: 'synth', frequency: 200, duration: 1.0, volume: 0.8 },
            'victory': { type: 'synth', frequency: 1500, duration: 0.5, volume: 0.6 },
            'fear': { type: 'synth', frequency: 500, duration: 0.3, volume: 0.5 },
            'menu_open': { type: 'synth', frequency: 700, duration: 0.2, volume: 0.4 },
            'menu_close': { type: 'synth', frequency: 600, duration: 0.2, volume: 0.4 },
            'level_complete': { type: 'synth', frequency: 1200, duration: 0.8, volume: 0.7 },
            'door_creak': { type: 'synth', frequency: 150, duration: 0.5, volume: 0.3 }
        };
    }
    
    init() {
        if (this.initialized) return;
        
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.context = new AudioContext();
            this.initialized = true;
            console.log("SoundManager initialized");
        } catch (e) {
            console.error("Web Audio API not supported:", e);
            this.enabled = false;
        }
    }
    
    play(soundName) {
        if (!this.enabled || !this.initialized || !this.context) return;
        
        const sound = this.soundDefs[soundName];
        if (!sound) return;
        
        if (sound.type === 'synth') {
            this.playSynth(sound.frequency, sound.duration, sound.volume);
        }
    }
    
    playSynth(frequency, duration, volume = 0.5) {
        const oscillator = this.context.createOscillator();
        const gainNode = this.context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.context.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.value = volume * this.masterVolume;
        
        const now = this.context.currentTime;
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    playAttackSound(damage, isCritical = false) {
        if (isCritical) {
            this.play('combat_critical');
        } else if (damage > 0) {
            this.play('combat_hit');
        } else {
            this.play('combat_miss');
        }
    }
    
    toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
    
    setVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
    }
}

// ============================================
// GAME DATA & MULTI-PAGE SYSTEM
// ============================================

// Game state with level tracking - LEVEL 1 SPECIFIC
const gameState = {
    currentLevel: 1, // CHANGED TO 1 FOR LEVEL 1
    currentSection: 1,
    fear: 0,
    stamina: 20,
    skill: 7,
    luck: 12,
    inventory: [],
    equippedWeapon: null,
    gold: 0,
    soundEnabled: true,
    inCombat: false,
    inDialog: false,
    combatData: null,
    npcData: null,
    inventoryOpen: false,
    visitedSections: [],
    levelsCompleted: []
};

// Item database - LEVEL 1 ITEMS
const items = {
    "Silver Key": {
        name: "Silver Key",
        description: "A finely crafted silver key that might unlock certain doors in the mansion.",
        type: "key",
        weight: 0.1,
        usable: false,
        icon: "fa-key"
    },
    "Crucifix": {
        name: "Crucifix",
        description: "A religious symbol that can ward off evil spirits. Particularly effective against undead.",
        type: "tool",
        weight: 0.5,
        usable: true,
        vsUndeadDamage: 6,
        icon: "fa-cross"
    },
    "Iron Dagger": {
        name: "Iron Dagger",
        description: "A sharp iron dagger for combat. Better than nothing in a fight.",
        type: "weapon",
        weight: 1,
        usable: true,
        damage: 3,
        icon: "fa-dagger"
    },
    "Torch": {
        name: "Torch",
        description: "Provides light in dark places. May reveal hidden passages.",
        type: "tool",
        weight: 1.5,
        usable: true,
        icon: "fa-fire"
    },
    "Butcher's Knife": {
        name: "Butcher's Knife",
        description: "A large, sharp kitchen knife. Deals significant damage but is unwieldy.",
        type: "weapon",
        weight: 1.2,
        usable: true,
        damage: 4,
        icon: "fa-knife-kitchen"
    },
    "Healing Potion": {
        name: "Healing Potion",
        description: "Restores 5 STAMINA when consumed. Has a faint herbal aroma.",
        type: "consumable",
        weight: 0.5,
        usable: true,
        staminaRestore: 5,
        icon: "fa-flask"
    },
    "Lucky Charm": {
        name: "Lucky Charm",
        description: "A small charm that makes you feel luckier. Grants +1 to LUCK tests.",
        type: "trinket",
        weight: 0.2,
        usable: false,
        luckBonus: 1,
        icon: "fa-clover"
    },
    // LEVEL 1 SPECIFIC ITEMS
    "Brass Key": {
        name: "Brass Key",
        description: "A tarnished brass key. Looks like it might fit a front door.",
        type: "key",
        weight: 0.2,
        usable: false,
        icon: "fa-key"
    },
    "Candle": {
        name: "Candle",
        description: "A simple wax candle. Provides dim light in dark areas.",
        type: "tool",
        weight: 0.3,
        usable: true,
        icon: "fa-candle-holder"
    },
    "Letter Opener": {
        name: "Letter Opener",
        description: "A sharp, decorative blade for opening letters. Could work as a small weapon.",
        type: "weapon",
        weight: 0.2,
        usable: true,
        damage: 2,
        icon: "fa-file-alt"
    },
    "Whiskey Flask": {
        name: "Whiskey Flask",
        description: "A silver flask half-full of whiskey. Might calm your nerves or be used as a bribe.",
        type: "consumable",
        weight: 0.3,
        usable: true,
        fearReduce: 1,
        icon: "fa-wine-bottle"
    }
};

// Enemy database - LEVEL 1 ENEMIES (easier than Level 2)
const enemies = {
    "Cultist": {
        name: "Cultist",
        skill: 6,
        stamina: 8,
        damage: 2,
        fear: 1,
        gold: 5,
        description: "A robed figure chanting dark rituals.",
        icon: "fa-user-ninja"
    },
    "Ghost": {
        name: "Ghost",
        skill: 7,
        stamina: 10,
        damage: 3,
        fear: 3,
        gold: 0,
        weakTo: "holy",
        description: "A spectral apparition with chilling touch.",
        icon: "fa-ghost"
    },
    "Giant Rat": {
        name: "Giant Rat",
        skill: 5,
        stamina: 6,
        damage: 1,
        fear: 0,
        gold: 2,
        description: "A massive rodent with sharp teeth.",
        icon: "fa-paw"
    },
    "Zombie": {
        name: "Zombie",
        skill: 4,
        stamina: 12,
        damage: 2,
        fear: 2,
        gold: 0,
        description: "A slow-moving but resilient undead creature.",
        icon: "fa-skull"
    },
    // LEVEL 1 SPECIFIC ENEMIES
    "Mad Servant": {
        name: "Mad Servant",
        skill: 5,
        stamina: 7,
        damage: 1,
        fear: 1,
        gold: 3,
        description: "A deranged former servant of the house.",
        icon: "fa-user"
    },
    "Possessed Cat": {
        name: "Possessed Cat",
        skill: 4,
        stamina: 4,
        damage: 1,
        fear: 0,
        gold: 0,
        description: "A house cat with glowing red eyes.",
        icon: "fa-cat"
    },
    "Shadow Creature": {
        name: "Shadow Creature",
        skill: 6,
        stamina: 8,
        damage: 2,
        fear: 2,
        gold: 0,
        weakTo: "light",
        description: "A formless being of pure darkness.",
        icon: "fa-moon"
    }
};

// Story sections for Level 1 - THE ENTRANCE HALL
const storySections = {
    1: {
        text: "Your car broke down on a lonely road during a thunderstorm. Through the rain, you see a looming mansion - the only shelter for miles. The front door creaks open as you approach, as if inviting you in. You step into a grand entrance hall with a sweeping staircase. The door slams shut behind you.",
        choices: [
            { text: "Call out for the owner", next: 2, effect: { fear: 1 }, icon: "fa-volume-up", sound: "click" },
            { text: "Explore the entrance hall", next: 3, icon: "fa-search", sound: "click" },
            { text: "Try to open the front door", next: 4, icon: "fa-door-open", sound: "door_creak" }
        ]
    },
    2: {
        text: "Your voice echoes through the empty hall. No one answers, but you hear faint whispering coming from upstairs. The chandelier above you sways slightly, though there's no wind.",
        choices: [
            { text: "Investigate the whispering", next: 5, icon: "fa-ear-deaf", sound: "click" },
            { text: "Ignore it and explore the ground floor", next: 6, icon: "fa-door-closed", sound: "click" },
            { text: "Check the door again", next: 4, icon: "fa-door-closed", sound: "door_creak" }
        ]
    },
    3: {
        text: "The entrance hall is lined with portraits of stern-looking ancestors. Their eyes seem to follow you. You notice a brass key on a small table, and a door to the left leading to a dining room.",
        choices: [
            { text: "Take the brass key", action: "addItem", item: "Brass Key", icon: "fa-key", sound: "item_pickup" },
            { text: "Enter the dining room", next: 7, icon: "fa-utensils", sound: "click" },
            { text: "Examine the portraits", next: 8, icon: "fa-portrait", sound: "click" }
        ]
    },
    4: {
        text: "The front door won't budge - it's locked from the outside. As you rattle the handle, you hear laughter from somewhere in the house. You're trapped.",
        choices: [
            { text: "Search for another exit", next: 9, icon: "fa-search", sound: "click" },
            { text: "Break a window", next: 10, icon: "fa-window-maximize", sound: "click" },
            { text: "Accept you're trapped and explore", next: 3, icon: "fa-door-closed", sound: "click" }
        ]
    },
    5: {
        text: "You climb the staircase, following the whispering sound. At the top, you see a long hallway with several doors. The whispering seems to come from behind the third door on the left.",
        choices: [
            { text: "Open the third door", next: 11, icon: "fa-door-open", sound: "door_creak" },
            { text: "Check the first door", next: 12, icon: "fa-door-closed", sound: "click" },
            { text: "Go back downstairs", next: 2, icon: "fa-arrow-down", sound: "click" }
        ]
    },
    6: {
        text: "You ignore the whispering and explore the ground floor. There are three doors leading from the entrance hall: one to a dining room, one to a library, and one to a sitting room.",
        choices: [
            { text: "Enter the dining room", next: 7, icon: "fa-utensils", sound: "click" },
            { text: "Enter the library", next: 13, icon: "fa-book", sound: "click" },
            { text: "Enter the sitting room", next: 14, icon: "fa-couch", sound: "click" }
        ]
    },
    7: {
        text: "The dining room is enormous, with a table set for twelve. The food on the plates looks fresh, but there's no one here. A candelabra with three candles burns brightly on the table.",
        choices: [
            { text: "Take a candle", action: "addItem", item: "Candle", icon: "fa-candle-holder", sound: "item_pickup" },
            { text: "Examine the food", next: 15, icon: "fa-utensils", sound: "click" },
            { text: "Check the sideboard", next: 16, icon: "fa-search", sound: "click" },
            { text: "Leave the dining room", next: 6, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    8: {
        text: "The portraits are of the Hellings family, dating back centuries. In one, a man with cruel eyes seems to stare directly at you. As you look closer, you notice his eyes in the painting are following you!",
        choices: [
            { text: "Turn away quickly", next: 3, effect: { fear: 2 }, icon: "fa-running", sound: "fear" },
            { text: "Examine the portrait more closely", next: 17, icon: "fa-eye", sound: "click" }
        ]
    },
    9: {
        text: "You search for another exit and find a servants' door near the back of the hall. It's unlocked and leads to a dark kitchen. You hear rattling from inside.",
        choices: [
            { text: "Enter the kitchen", next: 18, icon: "fa-utensils", sound: "click" },
            { text: "Look for a window instead", next: 10, icon: "fa-window-maximize", sound: "click" },
            { text: "Go back to the main hall", next: 3, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    10: {
        text: "You try to break a stained glass window, but it's reinforced. As you strike it, a shard of glass cuts your hand. Suddenly, a shadow moves across the room behind you!",
        choices: [
            { text: "Turn to face the shadow", next: 19, icon: "fa-user-shield", sound: "click" },
            { text: "Run to another room", next: 6, effect: { stamina: -1 }, icon: "fa-running", sound: "damage" }
        ]
    },
    11: {
        text: "You open the third door to find a bedroom. Inside, an old woman in a rocking chair turns to face you. Her eyes are completely white. 'They're waiting for you downstairs,' she whispers.",
        choices: [
            { text: "Ask who is waiting", next: 20, icon: "fa-comment", sound: "click" },
            { text: "Back away slowly", next: 5, icon: "fa-walking", sound: "click" },
            { text: "Attack the old woman", action: "startCombat", enemy: "Mad Servant", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    12: {
        text: "The first door opens to reveal a study. Books line the walls, and a fire burns in the fireplace despite no one being here. On the desk, you see a silver letter opener and a half-empty whiskey flask.",
        choices: [
            { text: "Take the letter opener", action: "addItem", item: "Letter Opener", icon: "fa-file-alt", sound: "item_pickup" },
            { text: "Take the whiskey flask", action: "addItem", item: "Whiskey Flask", icon: "fa-wine-bottle", sound: "item_pickup" },
            { text: "Search the desk", next: 21, icon: "fa-search", sound: "click" },
            { text: "Leave the study", next: 5, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    13: {
        text: "The library smells of old paper and dust. Thousands of books fill floor-to-ceiling shelves. One book lies open on a reading stand - it appears to be a journal. A shadow moves between the bookshelves.",
        choices: [
            { text: "Read the journal", next: 22, icon: "fa-book-open", sound: "click" },
            { text: "Investigate the shadow", next: 23, icon: "fa-search", sound: "click" },
            { text: "Search for useful items", next: 24, icon: "fa-search", sound: "click" },
            { text: "Leave the library", next: 6, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    14: {
        text: "The sitting room is cozy but oddly preserved, as if frozen in time. A grandfather clock ticks loudly in the corner, showing the wrong time. A black cat watches you from the mantelpiece, its eyes glowing faintly red.",
        choices: [
            { text: "Approach the cat", next: 25, icon: "fa-cat", sound: "click" },
            { text: "Check the clock", next: 26, icon: "fa-clock", sound: "click" },
            { text: "Search the room", next: 27, icon: "fa-search", sound: "click" }
        ]
    },
    15: {
        text: "The food looks delicious - roast chicken, vegetables, fresh bread. But when you touch it, it crumbles to dust in your hand. The entire feast is an illusion!",
        choices: [
            { text: "Back away in horror", next: 7, effect: { fear: 1 }, icon: "fa-running", sound: "fear" },
            { text: "Check the rest of the room", next: 16, icon: "fa-search", sound: "click" }
        ]
    },
    16: {
        text: "The sideboard contains silver cutlery and several bottles of wine. One drawer is locked. You also notice a small door behind a curtain - likely a pantry.",
        choices: [
            { text: "Try to open the locked drawer", next: 28, icon: "fa-lock", sound: "click" },
            { text: "Enter the pantry", next: 29, icon: "fa-door-open", sound: "door_creak" },
            { text: "Take a bottle of wine", action: "addItem", item: "Wine Bottle", icon: "fa-wine-bottle", sound: "item_pickup" },
            { text: "Return to the hall", next: 6, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    17: {
        text: "As you stare at the portrait, the man's painted mouth seems to curl into a smile. His eyes glow with a malevolent light. You feel a cold chill run down your spine.",
        choices: [
            { text: "Look away immediately", next: 3, effect: { fear: 3 }, icon: "fa-eye-slash", sound: "fear" },
            { text: "Ask the portrait who he is", next: 30, icon: "fa-comment", sound: "click" }
        ]
    },
    18: {
        text: "The kitchen is dark and smells of rotting meat. Something moves in the shadows near the stove. As your eyes adjust, you see it's a giant rat gnawing on something unidentifiable.",
        choices: [
            { text: "Attack the rat", action: "startCombat", enemy: "Giant Rat", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to scare it away", next: 31, icon: "fa-volume-up", sound: "click" },
            { text: "Search the kitchen quickly", next: 32, icon: "fa-search", sound: "click" }
        ]
    },
    19: {
        text: "You turn to face the shadow, but it has vanished. In its place, you see a silver key on the floor where the shadow was. The air grows cold around you.",
        choices: [
            { text: "Take the silver key", action: "addItem", item: "Silver Key", icon: "fa-key", sound: "item_pickup" },
            { text: "Get away from there", next: 6, effect: { fear: 2 }, icon: "fa-running", sound: "fear" }
        ]
    },
    20: {
        text: "'The masters of the house,' the old woman replies. 'They hunger for new souls. You should leave while you can.' She points a bony finger toward the door. 'Try the cellar door in the kitchen. It may still be unlocked.'",
        choices: [
            { text: "Ask about the cellar", next: 33, icon: "fa-question", sound: "click" },
            { text: "Thank her and leave", next: 5, icon: "fa-arrow-left", sound: "click" },
            { text: "Attack her anyway", action: "startCombat", enemy: "Mad Servant", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    21: {
        text: "The desk contains papers detailing strange rituals and lists of names with dates going back centuries. One name is circled in red: yours. Today's date is written beside it.",
        choices: [
            { text: "Take the papers", action: "addItem", item: "Torch", icon: "fa-scroll", sound: "item_pickup" },
            { text: "Destroy the papers", next: 34, icon: "fa-fire", sound: "click" },
            { text: "Leave them", next: 12, effect: { fear: 2 }, icon: "fa-arrow-left", sound: "fear" }
        ]
    },
    22: {
        text: "The journal entry reads: 'The ritual is nearly complete. Five more souls and the gate will open. The newcomers always go to the entrance hall first. Such predictable creatures.' The entry is dated today.",
        choices: [
            { text: "Search for more information", next: 35, icon: "fa-search", sound: "click" },
            { text: "Look for a weapon", next: 24, icon: "fa-search", sound: "click" },
            { text: "Leave the library", next: 13, effect: { fear: 2 }, icon: "fa-arrow-left", sound: "fear" }
        ]
    },
    23: {
        text: "You move between the bookshelves toward the shadow. As you round a corner, you come face-to-face with a pale, robed figure holding a knife. 'Another soul for the masters,' it whispers.",
        choices: [
            { text: "Fight the cultist", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to reason with it", next: 36, icon: "fa-comment", sound: "click" },
            { text: "Run back to the hall", next: 6, icon: "fa-running", sound: "click" }
        ]
    },
    24: {
        text: "You search the library and find a heavy book titled 'Exorcism and Purification.' Inside is a silver crucifix tucked between the pages.",
        choices: [
            { text: "Take the crucifix", action: "addItem", item: "Crucifix", icon: "fa-cross", sound: "item_pickup" },
            { text: "Keep searching", next: 37, icon: "fa-search", sound: "click" },
            { text: "Leave the library", next: 13, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    25: {
        text: "As you approach, the cat hisses, its back arching. Its eyes glow brighter, and it begins to grow in size, transforming into something monstrous!",
        choices: [
            { text: "Fight the possessed cat", action: "startCombat", enemy: "Possessed Cat", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to calm it", next: 38, icon: "fa-dove", sound: "click" },
            { text: "Run from the room", next: 6, icon: "fa-running", sound: "click" }
        ]
    },
    26: {
        text: "The grandfather clock shows 3:00 AM, but you know it's not that late. As you watch, the hands suddenly spin backward, then forward, then stop at midnight. A chill fills the room.",
        choices: [
            { text: "Touch the clock", next: 39, icon: "fa-hand-paper", sound: "click" },
            { text: "Back away", next: 14, effect: { fear: 1 }, icon: "fa-walking", sound: "fear" }
        ]
    },
    27: {
        text: "You search the sitting room and find a small box on a side table. It contains a healing potion and 15 gold coins. Behind a painting, you discover a hidden switch.",
        choices: [
            { text: "Take the potion", action: "addItem", item: "Healing Potion", icon: "fa-flask", sound: "item_pickup" },
            { text: "Take the gold", action: "addGold", amount: 15, icon: "fa-coins", sound: "item_pickup" },
            { text: "Press the hidden switch", next: 40, icon: "fa-toggle-on", sound: "click" },
            { text: "Take everything", action: "addMultiple", actions: ["addItem:Healing Potion", "addGold:15"], icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    28: {
        text: "The drawer is locked tight. It won't budge. However, you notice the keyhole is silver-colored - maybe a silver key would work?",
        choices: [
            { text: "Try your silver key", next: 41, requireItem: "Silver Key", icon: "fa-key", sound: "click" },
            { text: "Force it open", next: 42, icon: "fa-hammer", sound: "click" },
            { text: "Leave it", next: 16, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    29: {
        text: "The pantry is small and dark. Shelves hold preserved foods, most rotten. In the corner, you see a trapdoor in the floor. It leads down into darkness.",
        choices: [
            { text: "Open the trapdoor", next: 43, icon: "fa-door-open", sound: "door_creak" },
            { text: "Search the shelves", next: 44, icon: "fa-search", sound: "click" },
            { text: "Leave the pantry", next: 16, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    30: {
        text: "The painted man's lips move, but no sound comes out. Instead, words form in your mind: 'I am the first master. You will join us soon.' The portrait's eyes flash red.",
        choices: [
            { text: "Destroy the portrait", next: 45, icon: "fa-ban", sound: "click" },
            { text: "Flee the room", next: 3, effect: { fear: 4 }, icon: "fa-running", sound: "fear" }
        ]
    },
    31: {
        text: "You shout and stomp your feet. The giant rat squeals and scurries away through a hole in the wall. The kitchen is now clear to search.",
        choices: [
            { text: "Search the kitchen", next: 32, icon: "fa-search", sound: "click" },
            { text: "Follow the rat", next: 46, icon: "fa-paw", sound: "click" },
            { text: "Leave the kitchen", next: 9, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    32: {
        text: "You find a butcher's knife on a cutting board, still sharp. There's also a loaf of moldy bread and some herbs that might have medicinal properties.",
        choices: [
            { text: "Take the butcher's knife", action: "addItem", item: "Butcher's Knife", icon: "fa-knife-kitchen", sound: "item_pickup" },
            { text: "Take the bread", action: "addItem", item: "Moldy Bread", icon: "fa-bread-slice", sound: "item_pickup" },
            { text: "Take the herbs", action: "addItem", item: "Healing Potion", icon: "fa-leaf", sound: "item_pickup" },
            { text: "Take everything", action: "addMultiple", items: ["Butcher's Knife", "Moldy Bread", "Healing Potion"], icon: "fa-box-open", sound: "item_pickup" }
        ]
    },
    33: {
        text: "'The cellar is where they perform the rituals,' the old woman says. 'But it's also where they keep the artifacts that maintain this place. Destroy them, and you might escape.' She coughs violently. 'Now leave me.'",
        choices: [
            { text: "Ask about artifacts", next: 47, icon: "fa-question", sound: "click" },
            { text: "Thank her and go", next: 5, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    34: {
        text: "You tear the papers and throw them into the fireplace. They burn with a green flame and a terrible shriek echoes through the house. The old woman upstairs screams in agony.",
        choices: [
            { text: "Investigate the scream", next: 48, icon: "fa-ear-deaf", sound: "click" },
            { text: "Search the study more", next: 21, icon: "fa-search", sound: "click" }
        ]
    },
    35: {
        text: "You find more journal entries describing a 'gate' that needs seven souls to open. Six have already been taken. You are to be the seventh. The gate is in the cellar.",
        choices: [
            { text: "Continue searching", next: 49, icon: "fa-search", sound: "click" },
            { text: "Find the cellar", next: 43, icon: "fa-arrow-down", sound: "click" }
        ]
    },
    36: {
        text: "'I mean no harm,' you say. The cultist pauses, its head tilting. 'The masters demand a soul,' it replies. 'But perhaps... you could take my place?' It lowers the knife slightly.",
        choices: [
            { text: "Agree to take its place", next: 50, effect: { fear: 5 }, icon: "fa-handshake", sound: "click" },
            { text: "Attack while distracted", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Run", next: 6, icon: "fa-running", sound: "click" }
        ]
    },
    37: {
        text: "Further searching reveals nothing else of value. However, you do find a map of the house hidden inside another book. It shows the cellar entrance in the kitchen pantry.",
        choices: [
            { text: "Take the map", action: "addItem", item: "Torch", icon: "fa-map", sound: "item_pickup" },
            { text: "Go to the kitchen", next: 18, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    38: {
        text: "You speak softly to the cat, holding out a hand. It stops hissing and shrinks back to normal size. It purrs and rubs against your leg, then leads you to a hidden panel in the wall.",
        choices: [
            { text: "Open the panel", next: 51, icon: "fa-door-open", sound: "click" },
            { text: "Follow the cat", next: 52, icon: "fa-cat", sound: "click" }
        ]
    },
    39: {
        text: "As you touch the clock, the room spins. When your vision clears, you're no longer in the sitting room. You're in a dark, cold place - the cellar.",
        choices: [
            { text: "Explore the cellar", action: "completeLevel", icon: "fa-search", sound: "level_complete" }
        ]
    },
    40: {
        text: "You press the switch. With a grinding sound, a section of the wall slides open, revealing a secret passage. It leads downward into darkness.",
        choices: [
            { text: "Enter the passage", action: "completeLevel", icon: "fa-arrow-down", sound: "level_complete" },
            { text: "Close it and leave", next: 14, icon: "fa-times", sound: "click" }
        ]
    },
    41: {
        text: "The silver key fits perfectly. The drawer opens to reveal a small, ornate box. Inside is a lucky charm - a four-leaf clover encased in glass.",
        choices: [
            { text: "Take the lucky charm", action: "addItem", item: "Lucky Charm", icon: "fa-clover", sound: "item_pickup" },
            { text: "Leave it", next: 16, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    42: {
        text: "You force the drawer open with a loud crack. Inside is nothing but dust and a dead spider. The noise has attracted attention - you hear footsteps approaching!",
        choices: [
            { text: "Hide", next: 53, icon: "fa-eye-slash", sound: "click" },
            { text: "Prepare to fight", action: "startCombat", enemy: "Cultist", icon: "fa-fist-raised", sound: "combat_attack" }
        ]
    },
    43: {
        text: "You open the trapdoor. A ladder leads down into pitch blackness. A cold, damp smell rises from below. This must be the cellar.",
        choices: [
            { text: "Descend into the cellar", action: "completeLevel", icon: "fa-arrow-down", sound: "level_complete" },
            { text: "Close it and reconsider", next: 29, icon: "fa-times", sound: "click" }
        ]
    }
};

// ============================================
// GAME FUNCTIONS - UPDATED FOR LEVEL 1
// ============================================

// DOM elements
const loadingScreen = document.getElementById('loading');
const gameContainer = document.getElementById('gameContainer');
const storyText = document.getElementById('storyText');
const choicesContainer = document.getElementById('choicesContainer');
const fearValue = document.getElementById('fearValue');
const staminaValue = document.getElementById('staminaValue');
const skillValue = document.getElementById('skillValue');
const luckValue = document.getElementById('luckValue');
const inventoryToggle = document.getElementById('inventoryToggle');
const inventoryPanel = document.getElementById('inventoryPanel');
const inventoryContent = document.getElementById('inventoryContent');
const inventoryWeight = document.getElementById('inventoryWeight');
const inventoryGold = document.getElementById('inventoryGold');
const inventoryCount = document.getElementById('inventoryCount');
const inventoryBadge = document.getElementById('inventoryBadge');
const inventoryClose = document.getElementById('inventoryClose');
const combatPanel = document.getElementById('combatPanel');
const playerCombatStamina = document.getElementById('playerCombatStamina');
const playerHealthBar = document.getElementById('playerHealthBar');
const playerHealthText = document.getElementById('playerHealthText');
const enemyCombatName = document.getElementById('enemyCombatName');
const enemyCombatSkill = document.getElementById('enemyCombatSkill');
const enemyCombatStamina = document.getElementById('enemyCombatStamina');
const enemyHealthBar = document.getElementById('enemyHealthBar');
const enemyHealthText = document.getElementById('enemyHealthText');
const combatLog = document.getElementById('combatLog');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');
const notificationClose = document.getElementById('notificationClose');
const levelComplete = document.getElementById('levelComplete');
const pageNav = document.getElementById('pageNav');
const completeFear = document.getElementById('completeFear');
const completeStamina = document.getElementById('completeStamina');
const completeItems = document.getElementById('completeItems');
const completeGold = document.getElementById('completeGold');
const nextLevelBtn = document.getElementById('nextLevelBtn');
const continueExploring = document.getElementById('continueExploring');

// Sound manager instance
const soundManager = new SoundManager();

// Initialize game
function initGame() {
    console.log("Initializing Level 1...");
    
    // Check for saved game state
    loadGameState();
    
    // Initialize sound manager on first user interaction
    document.addEventListener('click', () => {
        if (!soundManager.initialized) {
            soundManager.init();
        }
    }, { once: true });
    
    simulateLoading();
    setupEventListeners();
}

// Simulate loading
function simulateLoading() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        document.getElementById('loadingProgress').style.width = `${progress}%`;
        
        if (progress <= 30) {
            document.getElementById('loadingStatus').textContent = "Initializing House of Hell...";
        } else if (progress <= 60) {
            document.getElementById('loadingStatus').textContent = "Loading Level 1: The Entrance Hall...";
        } else if (progress <= 90) {
            document.getElementById('loadingStatus').textContent = "Preparing your journey...";
        } else {
            document.getElementById('loadingStatus').textContent = "Entering the mansion...";
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(startGame, 500);
        }
    }, 50);
}

// Start game
function startGame() {
    loadingScreen.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    loadSection(gameState.currentSection);
    updateInventoryDisplay();
    showNotification(`Welcome to Level ${gameState.currentLevel}`, "The House of Hell awaits. Your journey begins here.", "info");
    soundManager.play('menu_open');
}

// Setup event listeners
function setupEventListeners() {
    // Inventory toggle
    inventoryToggle.addEventListener('click', () => {
        gameState.inventoryOpen = !gameState.inventoryOpen;
        inventoryPanel.classList.toggle('hidden');
        soundManager.play(gameState.inventoryOpen ? 'menu_open' : 'menu_close');
        
        if (gameState.inventoryOpen) {
            updateInventoryDisplay();
        }
    });
    
    inventoryClose.addEventListener('click', () => {
        gameState.inventoryOpen = false;
        inventoryPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Control buttons
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('saveBtn').addEventListener('click', saveGame);
    document.getElementById('loadBtn').addEventListener('click', loadGame);
    document.getElementById('hintBtn').addEventListener('click', showHint);
    
    // Sound toggle
    document.getElementById('soundToggle').addEventListener('click', () => {
        gameState.soundEnabled = soundManager.toggle();
        const soundToggle = document.getElementById('soundToggle');
        soundToggle.textContent = gameState.soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
        soundToggle.title = gameState.soundEnabled ? "Sound On" : "Sound Off";
        soundManager.play('click');
    });
    
    // Combat buttons
    document.getElementById('combatAttack').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('combat_attack');
            performAttack();
        }
    });
    
    document.getElementById('combatUseItem').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            showCombatItems();
        }
    });
    
    document.getElementById('combatLuck').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            testLuckInCombat();
        }
    });
    
    document.getElementById('combatFlee').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            tryFlee();
        }
    });
    
    // Notification close
    notificationClose.addEventListener('click', () => {
        notification.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Organize inventory button
    document.getElementById('organizeInventory').addEventListener('click', () => {
        organizeInventory();
        soundManager.play('click');
    });
    
    // Page navigation
    pageNav.addEventListener('click', () => {
        showLevelSelector();
        soundManager.play('menu_open');
    });
    
    // Level complete buttons
    nextLevelBtn.addEventListener('click', goToNextLevel);
    continueExploring.addEventListener('click', () => {
        levelComplete.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Add hover sounds to all buttons
    document.addEventListener('mouseover', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.disabled && gameState.soundEnabled) {
            soundManager.play('hover');
        }
    }, true);
}

// ============================================
// MULTI-PAGE SYSTEM FUNCTIONS
// ============================================

// Save game state to localStorage
function saveGameState() {
    try {
        const saveData = {
            currentLevel: gameState.currentLevel,
            currentSection: gameState.currentSection,
            fear: gameState.fear,
            stamina: gameState.stamina,
            skill: gameState.skill,
            luck: gameState.luck,
            inventory: gameState.inventory,
            equippedWeapon: gameState.equippedWeapon,
            gold: gameState.gold,
            soundEnabled: gameState.soundEnabled,
            visitedSections: gameState.visitedSections,
            levelsCompleted: gameState.levelsCompleted
        };
        
        localStorage.setItem('houseOfHellSave', JSON.stringify(saveData));
        console.log("Game state saved to localStorage");
        return true;
    } catch (e) {
        console.error("Failed to save game state:", e);
        return false;
    }
}

// Load game state from localStorage
function loadGameState() {
    try {
        const saved = localStorage.getItem('houseOfHellSave');
        if (saved) {
            const saveData = JSON.parse(saved);
            
            // Load the saved state
            Object.assign(gameState, saveData);
            
            // Ensure we're on the right level
            gameState.currentLevel = 1;
            
            console.log("Game state loaded from localStorage for Level 1");
            return true;
        }
    } catch (e) {
        console.error("Failed to load game state:", e);
    }
    return false;
}

// Complete current level
function completeLevel() {
    soundManager.play('level_complete');
    
    // Add this level to completed levels if not already
    if (!gameState.levelsCompleted.includes(gameState.currentLevel)) {
        gameState.levelsCompleted.push(gameState.currentLevel);
    }
    
    // Save game state
    saveGameState();
    
    // Update level complete screen stats
    completeFear.textContent = gameState.fear;
    completeStamina.textContent = gameState.stamina;
    completeItems.textContent = gameState.inventory.reduce((total, item) => total + (item.quantity || 1), 0);
    completeGold.textContent = gameState.gold;
    
    // Show level complete screen
    levelComplete.classList.remove('hidden');
}

// Go to next level
function goToNextLevel() {
    const nextLevel = gameState.currentLevel + 1;
    
    // Save current state before navigating
    saveGameState();
    
    // Navigate to next level page
    soundManager.play('menu_open');
    setTimeout(() => {
        window.location.href = `level${nextLevel}.html`;
    }, 500);
}

// Show level selector - UPDATED FIX
function showLevelSelector() {
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogText = document.getElementById('dialogText');
    const dialogOptions = document.getElementById('dialogOptions');
    const dialogPanel = document.getElementById('dialogPanel');
    
    dialogTitle.textContent = "SELECT LEVEL";
    dialogText.textContent = "Choose which level to play. Your current progress will be saved.";
    
    dialogOptions.innerHTML = '';
    
    // Create level buttons (for up to 4 levels)
    for (let i = 1; i <= 4; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = 'dialog-option';
        levelBtn.innerHTML = `<i class="fas fa-map"></i> Level ${i} ${gameState.levelsCompleted.includes(i) ? '(Completed)' : ''}`;
        
        // FIXED LOGIC: Allow navigation to Level 2 from Level 1
        // Only disable if: 
        // 1. Level is more than 1 ahead of current level AND previous level not completed
        // OR
        // 2. Level doesn't exist yet (but we're only creating up to 4)
        let disabled = false;
        let tooltip = "";
        
        if (i > gameState.currentLevel + 1 && !gameState.levelsCompleted.includes(i-1)) {
            disabled = true;
            tooltip = "Complete previous level first";
        } else if (i > gameState.currentLevel && i > 1 && !gameState.levelsCompleted.includes(i-1)) {
            // For Level 2 when on Level 1: allow if Level 1 is in progress
            // Only disable if explicitly prevented by design
            // For now, we'll allow it
            disabled = false;
        }
        
        if (disabled) {
            levelBtn.disabled = true;
            if (tooltip) levelBtn.title = tooltip;
        }
        
        // Always attach event listener
        levelBtn.addEventListener('click', () => {
            if (levelBtn.disabled) {
                soundManager.play('combat_miss');
                showNotification("Level Locked", tooltip || "You cannot access this level yet", "info");
                return;
            }
            
            soundManager.play('click');
            if (i !== gameState.currentLevel) {
                // Save current game
                saveGameState();
                
                // Navigate to selected level
                setTimeout(() => {
                    if (i === 1) {
                        window.location.href = 'level1.html';
                    } else if (i === 2) {
                        window.location.href = 'level2.html';
                    } else if (i === 3) {
                        window.location.href = 'level3.html';
                    } else if (i === 4) {
                        window.location.href = 'level4.html';
                    }
                }, 300);
            }
            dialogPanel.classList.add('hidden');
        });
        
        dialogOptions.appendChild(levelBtn);
    }
    
    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'dialog-option';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
    cancelBtn.addEventListener('click', () => {
        dialogPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    dialogOptions.appendChild(cancelBtn);
    
    dialogPanel.classList.remove('hidden');
}

// ============================================
// GAME CORE FUNCTIONS
// ============================================

// Show notification
function showNotification(title, message, type = "info") {
    notificationText.innerHTML = `<strong>${title}</strong><br>${message}`;
    notification.classList.remove('hidden');
    
    // Play appropriate sound
    if (gameState.soundEnabled) {
        if (type === "item") soundManager.play('item_pickup');
        else if (type === "heal") soundManager.play('heal');
        else if (type === "damage") soundManager.play('damage');
        else if (type === "fear") soundManager.play('fear');
        else if (type === "death") soundManager.play('death');
        else if (type === "victory") soundManager.play('victory');
        else if (type === "level_complete") soundManager.play('level_complete');
        else soundManager.play('click');
    }
    
    setTimeout(() => {
        if (!notification.classList.contains('hidden')) {
            notification.classList.add('hidden');
        }
    }, 3000);
}

// Add item to inventory
function addItem(itemName) {
    const item = items[itemName];
    if (!item) {
        console.error("Item not found:", itemName);
        return false;
    }
    
    // Check weight limit
    const currentWeight = gameState.inventory.reduce((sum, invItem) => {
        const itemData = items[invItem.name];
        return sum + (itemData?.weight || 0) * (invItem.quantity || 1);
    }, 0);
    
    if (currentWeight + item.weight > 10) {
        showNotification("Inventory Full", `Cannot carry ${itemName}. Too heavy!`, "info");
        return false;
    }
    
    // Add item
    const existingItem = gameState.inventory.find(invItem => invItem.name === itemName);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        gameState.inventory.push({
            name: itemName,
            quantity: 1,
            equipped: false
        });
    }
    
    updateInventoryDisplay();
    showNotification("Item Found", `You found: ${itemName}`, "item");
    
    // Auto-save after getting item
    saveGameState();
    
    return true;
}

// Add gold
function addGold(amount) {
    gameState.gold += amount;
    showNotification("Gold Found", `You found ${amount} gold coins!`, "item");
    updateInventoryDisplay();
    saveGameState();
}

// Update inventory display
function updateInventoryDisplay() {
    inventoryContent.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        inventoryContent.innerHTML = `
            <div class="inventory-empty">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px; color: #666;"></i>
                <div>Your inventory is empty</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">Explore the mansion to find items!</div>
            </div>
        `;
    } else {
        const grid = document.createElement('div');
        grid.className = 'inventory-grid';
        
        let totalWeight = 0;
        let totalItems = 0;
        
        // Sort items by type and name
        const sortedInventory = [...gameState.inventory].sort((a, b) => {
            const itemA = items[a.name];
            const itemB = items[b.name];
            
            // Weapons first, then tools, then consumables, then keys
            const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
            const orderA = typeOrder[itemA.type] || 5;
            const orderB = typeOrder[itemB.type] || 5;
            
            if (orderA !== orderB) return orderA - orderB;
            return a.name.localeCompare(b.name);
        });
        
        sortedInventory.forEach(invItem => {
            const item = items[invItem.name];
            if (!item) return;
            
            totalWeight += item.weight * (invItem.quantity || 1);
            totalItems += invItem.quantity || 1;
            
            const itemCard = document.createElement('div');
            itemCard.className = 'inventory-item-card';
            if (invItem.equipped) {
                itemCard.classList.add('item-equipped');
            }
            
            itemCard.innerHTML = `
                <div class="item-icon">
                    <i class="fas ${item.icon}"></i>
                </div>
                <div class="item-name">${invItem.name}</div>
                <div class="item-type">${item.type.toUpperCase()}</div>
                ${(invItem.quantity || 1) > 1 ? `<div class="item-quantity">${invItem.quantity}</div>` : ''}
                <div class="item-tooltip">${item.description}</div>
            `;
            
            // Add click handler
            itemCard.addEventListener('click', () => showItemDetails(invItem.name));
            
            grid.appendChild(itemCard);
        });
        
        inventoryContent.appendChild(grid);
        
        // Add item details section
        const detailsSection = document.createElement('div');
        detailsSection.className = 'item-details';
        detailsSection.id = 'itemDetails';
        detailsSection.innerHTML = `
            <div style="color: #999; text-align: center;">Click on an item for details</div>
        `;
        inventoryContent.appendChild(detailsSection);
    }
    
    // Update inventory stats
    inventoryWeight.textContent = `Weight: ${totalWeight.toFixed(1)}/10`;
    inventoryGold.textContent = `Gold: ${gameState.gold}`;
    inventoryCount.textContent = `Items: ${totalItems}`;
    
    // Update inventory badge
    inventoryBadge.textContent = totalItems;
    inventoryBadge.style.display = totalItems > 0 ? 'flex' : 'none';
}

// Show item details
function showItemDetails(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    const invItem = gameState.inventory.find(i => i.name === itemName);
    if (!invItem) return;
    
    const detailsSection = document.getElementById('itemDetails');
    detailsSection.innerHTML = `
        <div style="color: #ff0; font-size: 1.2rem; margin-bottom: 10px;">
            <i class="fas ${item.icon}"></i> ${itemName}
        </div>
        <div class="item-description">${item.description}</div>
        <div style="margin-top: 10px; color: #ccc;">
            <div>Type: ${item.type.toUpperCase()}</div>
            <div>Weight: ${item.weight}</div>
            ${item.damage ? `<div>Damage: ${item.damage}</div>` : ''}
            ${item.staminaRestore ? `<div>Heals: ${item.staminaRestore} STAMINA</div>` : ''}
        </div>
        <div class="item-actions">
            ${item.usable ? `<button class="item-action-btn" onclick="useItem('${itemName}')">Use</button>` : ''}
            ${item.type === 'weapon' ? `<button class="item-action-btn" onclick="equipItem('${itemName}')">${invItem.equipped ? 'Unequip' : 'Equip'}</button>` : ''}
            <button class="item-action-btn" onclick="dropItem('${itemName}')">Drop</button>
        </div>
    `;
    
    soundManager.play('click');
}

// Use item
function useItem(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    if (itemName === "Healing Potion") {
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        removeItem(itemName);
        updateStats();
        showNotification("Healing Potion", "You restore 5 STAMINA", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Moldy Bread") {
        gameState.stamina = Math.min(20, gameState.stamina + 2);
        removeItem(itemName);
        updateStats();
        showNotification("Moldy Bread", "You restore 2 STAMINA (it was better than nothing)", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Whiskey Flask") {
        gameState.fear = Math.max(0, gameState.fear - 1);
        removeItem(itemName);
        updateStats();
        showNotification("Whiskey Flask", "You take a swig. Your nerves steady slightly. (-1 fear)", "heal");
        soundManager.play('heal');
        saveGameState();
    } else if (itemName === "Wine Bottle") {
        showNotification("Wine Bottle", "You could drink this, but it might not be wise. Or use it as a weapon.", "info");
    } else if (itemName === "Candle") {
        showNotification("Candle", "The candle provides a small circle of light. It might reveal hidden things.", "info");
    } else {
        showNotification(itemName, item.description, "info");
    }
    
    updateInventoryDisplay();
}

// Equip item
function equipItem(itemName) {
    if (items[itemName].type !== 'weapon') return;
    
    // Unequip current weapon
    gameState.inventory.forEach(invItem => {
        if (invItem.equipped) invItem.equipped = false;
    });
    
    // Equip new weapon
    const invItem = gameState.inventory.find(i => i.name === itemName);
    invItem.equipped = !invItem.equipped;
    
    if (invItem.equipped) {
        showNotification("Item Equipped", `${itemName} is now equipped`, "info");
        gameState.equippedWeapon = itemName;
    } else {
        showNotification("Item Unequipped", `${itemName} is no longer equipped`, "info");
        gameState.equippedWeapon = null;
    }
    
    updateInventoryDisplay();
    soundManager.play('item_use');
    saveGameState();
}

// Drop item
function dropItem(itemName) {
    if (confirm(`Are you sure you want to drop ${itemName}?`)) {
        removeItem(itemName);
        showNotification("Item Dropped", `You dropped ${itemName}`, "info");
        updateInventoryDisplay();
        soundManager.play('click');
        saveGameState();
    }
}

// Organize inventory
function organizeInventory() {
    // Sort inventory alphabetically
    gameState.inventory.sort((a, b) => a.name.localeCompare(b.name));
    
    // Group by type
    const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
    gameState.inventory.sort((a, b) => {
        const itemA = items[a.name];
        const itemB = items[b.name];
        const orderA = typeOrder[itemA.type] || 5;
        const orderB = typeOrder[itemB.type] || 5;
        return orderA - orderB;
    });
    
    updateInventoryDisplay();
    showNotification("Inventory Organized", "Items have been sorted by type and name", "info");
}

// Remove item
function removeItem(itemName) {
    const index = gameState.inventory.findIndex(item => item.name === itemName);
    if (index !== -1) {
        if (gameState.inventory[index].quantity > 1) {
            gameState.inventory[index].quantity--;
        } else {
            // If unequipping weapon, clear equipped weapon
            if (gameState.inventory[index].equipped) {
                gameState.equippedWeapon = null;
            }
            gameState.inventory.splice(index, 1);
        }
        return true;
    }
    return false;
}

// Update stats display
function updateStats() {
    fearValue.textContent = gameState.fear;
    staminaValue.textContent = gameState.stamina;
    skillValue.textContent = gameState.skill;
    luckValue.textContent = gameState.luck;
    
    // Color coding
    fearValue.style.color = gameState.fear > 15 ? '#ff3030' : 
                           gameState.fear > 10 ? '#ff8000' : '#ff0';
    
    staminaValue.style.color = gameState.stamina > 15 ? '#0f0' : 
                              gameState.stamina > 10 ? '#ff0' : 
                              gameState.stamina > 5 ? '#ff8000' : '#ff3030';
}

// Apply effect
function applyEffect(effect) {
    if (effect.fear) {
        gameState.fear = Math.max(0, Math.min(20, gameState.fear + effect.fear));
        if (effect.fear > 0) {
            showNotification("Fear", `Your fear increases by ${effect.fear}`, "fear");
            soundManager.play('fear');
        }
    }
    
    if (effect.stamina) {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.max(0, Math.min(20, gameState.stamina + effect.stamina));
        const change = gameState.stamina - oldStamina;
        
        if (change < 0) {
            showNotification("Damage", `You lose ${-change} STAMINA`, "damage");
            soundManager.play('damage');
        } else if (change > 0) {
            showNotification("Healed", `You restore ${change} STAMINA`, "heal");
            soundManager.play('heal');
        }
    }
    
    if (effect.skill) {
        gameState.skill = Math.max(0, Math.min(12, gameState.skill + effect.skill));
        if (effect.skill < 0) {
            showNotification("Skill Reduced", `Your skill decreases by ${-effect.skill}`, "damage");
        }
    }
    
    if (effect.luck) {
        gameState.luck = Math.max(0, Math.min(12, gameState.luck + effect.luck));
        if (effect.luck < 0) {
            showNotification("Luck Reduced", `Your luck decreases by ${-effect.luck}`, "damage");
        }
    }
    
    updateStats();
    
    // Check for death
    if (gameState.stamina <= 0) {
        showNotification("Game Over", "You have died!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">YOU HAVE DIED<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    if (gameState.fear >= 20) {
        showNotification("Game Over", "Driven mad by fear!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">DRIVEN MAD BY FEAR<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    return false;
}

// Load section
function loadSection(sectionId) {
    if (gameState.inCombat || gameState.inDialog) return;
    
    gameState.currentSection = sectionId;
    const section = storySections[sectionId];
    
    if (!section) {
        storyText.innerHTML = "<p>End of Level 1... for now.</p>";
        choicesContainer.innerHTML = "";
        return;
    }
    
    // Apply section effect if any
    if (section.effect) {
        if (applyEffect(section.effect)) return; // Return if player died
    }
    
    // Display story text
    storyText.innerHTML = `<p>${section.text}</p>`;
    storyText.scrollTop = 0;
    
    // Clear and create choices
    choicesContainer.innerHTML = "";
    
    section.choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-btn';
        
        // Check requirements
        let disabled = false;
        if (choice.requireItem) {
            const hasItem = gameState.inventory.some(item => item.name === choice.requireItem);
            if (!hasItem) {
                disabled = true;
                button.title = `Requires: ${choice.requireItem}`;
            }
        }
        
        button.disabled = disabled;
        button.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
        
        if (!disabled) {
            button.addEventListener('click', () => {
                if (choice.sound && gameState.soundEnabled) {
                    soundManager.play(choice.sound);
                }
                handleChoice(choice);
            });
        }
        
        choicesContainer.appendChild(button);
    });
    
    // Update stats
    updateStats();
    
    // Mark as visited
    if (!gameState.visitedSections.includes(sectionId)) {
        gameState.visitedSections.push(sectionId);
    }
}

// Handle choice
function handleChoice(choice) {
    console.log("Handling choice:", choice);
    
    if (choice.action === "addItem") {
        if (addItem(choice.item)) {
            // Stay in current section after taking item
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addMultiple") {
        if (choice.items) {
            // For array of items
            choice.items.forEach(item => addItem(item));
            loadSection(gameState.currentSection);
        } else if (choice.actions) {
            // For array of actions
            choice.actions.forEach(actionStr => {
                const [action, param] = actionStr.split(':');
                if (action === "addItem") {
                    addItem(param);
                } else if (action === "addGold") {
                    addGold(parseInt(param));
                }
            });
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addGold") {
        addGold(choice.amount);
        loadSection(gameState.currentSection);
    } else if (choice.action === "startCombat") {
        startCombat(choice.enemy);
    } else if (choice.action === "completeLevel") {
        completeLevel();
    } else if (choice.next) {
        if (choice.effect) {
            applyEffect(choice.effect);
        }
        loadSection(choice.next);
    }
}

// Start combat
function startCombat(enemyName) {
    const enemy = enemies[enemyName];
    if (!enemy) return;
    
    gameState.inCombat = true;
    gameState.combatData = {
        enemy: enemy,
        enemyStamina: enemy.stamina,
        enemyMaxStamina: enemy.stamina,
        round: 1,
        playerMaxStamina: gameState.stamina
    };
    
    // Update UI
    enemyCombatName.textContent = enemy.name;
    enemyCombatSkill.textContent = enemy.skill;
    enemyCombatStamina.textContent = enemy.stamina;
    enemyHealthText.textContent = `${enemy.stamina}/${enemy.stamina}`;
    
    playerCombatStamina.textContent = gameState.stamina;
    playerHealthText.textContent = `${gameState.stamina}/20`;
    
    // Update health bars
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    combatLog.innerHTML = '';
    addCombatLog(`A ${enemy.name} attacks!`, "event");
    
    // Show combat panel
    combatPanel.classList.remove('hidden');
    soundManager.play('combat_attack');
}

// Perform attack
function performAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Player attacks
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    
    let damage = 0;
    let isCritical = false;
    
    if (playerRoll > enemyRoll) {
        // Player hits
        damage = 2; // Base damage
        
        // Add weapon damage if equipped
        if (gameState.equippedWeapon) {
            const weapon = items[gameState.equippedWeapon];
            damage = weapon.damage;
        }
        
        // Bonus for holy weapons vs undead
        if (enemy.weakTo === "holy" && gameState.equippedWeapon === "Crucifix") {
            damage = items["Crucifix"].vsUndeadDamage;
            addCombatLog("The crucifix glows with holy power!", "player");
        }
        
        // Critical hit chance (roll of 12)
        const attackRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        if (attackRoll === 12) {
            damage *= 2;
            isCritical = true;
            addCombatLog("CRITICAL HIT!", "player");
        }
        
        gameState.combatData.enemyStamina -= damage;
        addCombatLog(`You hit the ${enemy.name} for ${damage} damage!`, "player");
        
        // Show damage number
        showDamageNumber(enemy.name, damage, false);
        
    } else if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else {
        // Tie
        addCombatLog("Your attacks clash with no effect!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, isCritical);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    if (!checkCombatEnd()) {
        // Enemy attacks next round if combat continues
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 1000);
    }
}

// Enemy attack
function enemyAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Enemy attacks
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    
    let damage = 0;
    
    if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else if (playerRoll > enemyRoll) {
        // Player parries
        addCombatLog(`You parry the ${enemy.name}'s attack!`, "player");
    } else {
        // Tie
        addCombatLog("You both hesitate, waiting for an opening!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, false);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    checkCombatEnd();
}

// Update combat UI
function updateCombatUI() {
    playerCombatStamina.textContent = gameState.stamina;
    enemyCombatStamina.textContent = gameState.combatData.enemyStamina;
    
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = (gameState.combatData.enemyStamina / gameState.combatData.enemyMaxStamina) * 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    playerHealthText.textContent = `${gameState.stamina}/20`;
    enemyHealthText.textContent = `${gameState.combatData.enemyStamina}/${gameState.combatData.enemyMaxStamina}`;
    
    updateStats();
}

// Show damage number
function showDamageNumber(target, damage, isPlayer) {
    const damageNumber = document.createElement('div');
    damageNumber.className = `damage-number ${isPlayer ? 'player' : 'enemy'}`;
    damageNumber.textContent = `-${damage}`;
    damageNumber.style.left = `${50 + (Math.random() * 20 - 10)}%`;
    damageNumber.style.top = `${30 + (Math.random() * 20)}%`;
    
    document.body.appendChild(damageNumber);
    
    setTimeout(() => {
        damageNumber.remove();
    }, 1000);
}

// Add combat log entry
function addCombatLog(message, type) {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}-log`;
    entry.textContent = `[Round ${gameState.combatData.round}] ${message}`;
    combatLog.appendChild(entry);
    combatLog.scrollTop = combatLog.scrollHeight;
    gameState.combatData.round++;
}

// Show combat items
function showCombatItems() {
    const itemsSection = document.createElement('div');
    itemsSection.innerHTML = `
        <div style="color: #ff0; margin-bottom: 10px;">Select an item to use:</div>
    `;
    
    const combatItems = gameState.inventory.filter(invItem => {
        const item = items[invItem.name];
        return item && (item.name === "Healing Potion" || item.name === "Crucifix" || item.name === "Moldy Bread" || item.name === "Whiskey Flask");
    });
    
    if (combatItems.length === 0) {
        itemsSection.innerHTML += `
            <div style="color: #666; padding: 10px; text-align: center;">
                No usable items in combat
            </div>
        `;
    } else {
        combatItems.forEach(invItem => {
            const button = document.createElement('button');
            button.className = 'combat-btn';
            button.style.margin = '5px';
            button.textContent = `${invItem.name} (${invItem.quantity})`;
            button.addEventListener('click', () => useItemInCombat(invItem.name));
            itemsSection.appendChild(button);
        });
    }
    
    const backButton = document.createElement('button');
    backButton.className = 'combat-btn';
    backButton.style.margin = '5px';
    backButton.textContent = 'Back';
    backButton.addEventListener('click', () => {
        combatLog.innerHTML = '';
        addCombatLog("You prepare your next move...", "event");
    });
    itemsSection.appendChild(backButton);
    
    combatLog.innerHTML = '';
    combatLog.appendChild(itemsSection);
}

// Use item in combat
function useItemInCombat(itemName) {
    if (itemName === "Healing Potion") {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        const healed = gameState.stamina - oldStamina;
        
        removeItem(itemName);
        addCombatLog(`You drink a healing potion! (+${healed} stamina)`, "player");
        soundManager.play('heal');
        
        // Enemy attacks while you use item
        setTimeout(() => {
            if (gameState.inCombat) {
                addCombatLog("The enemy attacks while you're distracted!", "event");
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Moldy Bread") {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.min(20, gameState.stamina + 2);
        const healed = gameState.stamina - oldStamina;
        
        removeItem(itemName);
        addCombatLog(`You eat moldy bread! (+${healed} stamina)`, "player");
        soundManager.play('heal');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Whiskey Flask") {
        gameState.fear = Math.max(0, gameState.fear - 1);
        removeItem(itemName);
        addCombatLog("You take a swig of whiskey! (-1 fear)", "player");
        soundManager.play('heal');
        
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Crucifix") {
        const enemy = gameState.combatData.enemy;
        if (enemy.weakTo === "holy") {
            gameState.combatData.enemyStamina -= 4;
            addCombatLog("The crucifix glows with holy power! The enemy recoils in pain! (-4 damage)", "player");
            showDamageNumber(enemy.name, 4, false);
            soundManager.play('combat_hit');
            
            // Enemy attacks
            setTimeout(() => {
                if (gameState.inCombat) {
                    enemyAttack();
                }
            }, 500);
        } else {
            addCombatLog("The crucifix has no effect on this enemy.", "event");
            soundManager.play('combat_miss');
        }
    }
    
    updateCombatUI();
    checkCombatEnd();
}

// Test luck in combat
function testLuckInCombat() {
    if (gameState.luck <= 0) {
        addCombatLog("You have no luck left to test!", "event");
        return;
    }
    
    gameState.luck--;
    updateStats();
    
    const luckRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
    const success = luckRoll <= gameState.luck + 1;
    
    if (success) {
        addCombatLog("You feel lucky! The enemy hesitates.", "player");
        // Skip enemy's next attack
    } else {
        addCombatLog("Your luck fails you! The enemy presses the attack.", "enemy");
        // Enemy gets a free attack
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
    }
    
    soundManager.play(success ? 'combat_critical' : 'combat_miss');
}

// Try to flee
function tryFlee() {
    const fleeChance = 0.4 + (gameState.luck / 20);
    if (Math.random() < fleeChance) {
        addCombatLog("You successfully flee from combat!", "player");
        endCombat(false);
        soundManager.play('victory');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
        }, 1000);
    } else {
        addCombatLog("You fail to escape!", "event");
        enemyAttack();
        updateCombatUI();
        checkCombatEnd();
    }
}

// Check combat end
function checkCombatEnd() {
    if (gameState.stamina <= 0) {
        addCombatLog("You have been defeated!", "event");
        endCombat(false);
        soundManager.play('death');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            storyText.innerHTML += '<div class="death-message">DEFEATED IN COMBAT<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1500);
        return true;
    }
    
    if (gameState.combatData.enemyStamina <= 0) {
        const enemy = gameState.combatData.enemy;
        addCombatLog(`You defeated the ${enemy.name}!`, "event");
        
        // Add gold
        if (enemy.gold > 0) {
            gameState.gold += enemy.gold;
            addCombatLog(`Found ${enemy.gold} gold!`, "event");
        }
        
        endCombat(true);
        soundManager.play('victory');
        
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            loadSection(gameState.currentSection + 1);
            saveGameState(); // Auto-save after combat
        }, 2000);
        return true;
    }
    
    return false;
}

// End combat
function endCombat(victory) {
    gameState.inCombat = false;
    gameState.combatData = null;
}

// Save game
function saveGame() {
    if (saveGameState()) {
        showNotification("Game Saved", "Progress saved successfully.", "info");
        soundManager.play('click');
    } else {
        showNotification("Save Failed", "Could not save game.", "info");
    }
}

// Load game
function loadGame() {
    if (loadGameState()) {
        loadSection(gameState.currentSection);
        updateInventoryDisplay();
        updateStats();
        showNotification("Game Loaded", "Saved game loaded.", "info");
        soundManager.play('menu_open');
    } else {
        showNotification("No Save", "No saved game found.", "info");
    }
}

// Show hint
function showHint() {
    const hints = [
        "The front door is locked. You'll need to find another way out.",
        "Keys can unlock doors or containers.",
        "Some items can be used as weapons in combat.",
        "Explore every room - you might find useful items.",
        "Pay attention to the story - it might give you clues.",
        "Combat is risky. Sometimes it's better to avoid fights.",
        "Check your inventory regularly for usable items.",
        "Fear can be as dangerous as physical damage.",
        "The cellar seems to be important..."
    ];
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    showNotification("Hint", randomHint, "info");
}

// Restart game
function restartGame() {
    if (confirm("Are you sure you want to restart Level 1? All progress for this level will be lost.")) {
        // Reset game state for this level only
        gameState.currentSection = 1;
        gameState.fear = 0;
        gameState.stamina = 20;
        gameState.skill = 7;
        gameState.luck = 12;
        gameState.inCombat = false;
        gameState.inDialog = false;
        gameState.combatData = null;
        gameState.npcData = null;
        gameState.inventoryOpen = false;
        gameState.visitedSections = [];
        gameState.inventory = [];
        gameState.equippedWeapon = null;
        gameState.gold = 0;
        
        // Close panels
        combatPanel.classList.add('hidden');
        inventoryPanel.classList.add('hidden');
        levelComplete.classList.add('hidden');
        
        // Clear localStorage for this level only
        localStorage.removeItem('houseOfHellSave');
        
        // Reload first section
        loadSection(1);
        updateInventoryDisplay();
        updateStats();
        
        showNotification("Level 1 Restarted", "Your journey begins anew.", "info");
        soundManager.play('menu_open');
    }
}

// Start the game
window.addEventListener('DOMContentLoaded', initGame);

// Auto-save when leaving the page
window.addEventListener('beforeunload', () => {
    saveGameState();
});
</script>
</body>
</html>
