<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DreadWood: Mountains of Doom</title>
    <style>
        /* Retro 80s computer game style */
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a2a;
            color: #33ff33;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            border: 2px solid #33ff33;
            background-color: #000;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #33ff33;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #ff33ff;
            text-shadow: 0 0 5px #ff33ff;
            font-size: 28px;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        h2 {
            color: #33ccff;
            border-bottom: 1px solid #33ccff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .active-screen {
            display: block;
        }
        
        .stats-bar {
            background-color: #111133;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-value {
            color: #ffff33;
            font-weight: bold;
        }
        
        .inventory {
            background-color: #111122;
            border: 1px solid #ff33ff;
            padding: 10px;
            margin: 15px 0;
            min-height: 60px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222244;
            border: 1px solid #33ccff;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        
        .story-text {
            background-color: #111111;
            border: 1px solid #33ff33;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222244;
            color: #33ff33;
            border: 2px solid #33ff33;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333366;
            color: #ffff33;
            border-color: #ffff33;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #330033;
            color: #ff33ff;
            border: 2px solid #ff33ff;
            padding: 10px 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #550055;
            color: #ff99ff;
        }
        
        .dice-roll {
            background-color: #223322;
            border: 1px solid #33ff33;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #ffff33;
        }
        
        .game-over {
            color: #ff3333;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #ff3333;
        }
        
        .success {
            color: #33ff33;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3333;
            font-weight: bold;
        }
        
        .enemy {
            color: #ff9933;
            font-weight: bold;
        }
        
        .next-level {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
        }
        
        .next-level-btn {
            background-color: #003333;
            color: #33ff99;
            border: 2px solid #33ff99;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .next-level-btn:hover, .next-level-btn:active {
            background-color: #005555;
            color: #99ffcc;
        }
        
        .retro-notice {
            text-align: center;
            color: #888888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333333;
            padding-top: 10px;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DREADWOOD</h1>
            <h2>MOUNTAINS OF DOOM</h2>
            <div class="retro-notice">A Retro Gamebook Adventure - Android Portrait Mode</div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="screen-creation" class="screen active-screen">
            <h2>CHOOSE YOUR PATH</h2>
            <div class="story-text">
                <p>Welcome to DREADWOOD, adventurer! The shadow of the Dark Lord falls across the land. Your quest begins in the treacherous MOUNTAINS OF DOOM.</p>
                <p>First, you must choose your class. Each has unique strengths:</p>
                <p><span class="enemy">WARRIOR</span>: +2 Skill, +4 Stamina, +0 Luck</p>
                <p><span class="enemy">ROGUE</span>: +3 Skill, +2 Stamina, +1 Luck</p>
                <p><span class="enemy">MAGE</span>: +1 Skill, +2 Stamina, +3 Luck</p>
                <p>Then roll dice for your attributes. Skill determines combat prowess, Stamina your health, and Luck can help in desperate situations.</p>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="selectClass('warrior')">BECOME A WARRIOR</button>
                <button class="choice-btn" onclick="selectClass('rogue')">BECOME A ROGUE</button>
                <button class="choice-btn" onclick="selectClass('mage')">BECOME A MAGE</button>
            </div>
            
            <div id="dice-roll-section" style="display: none;">
                <h2>ROLL YOUR STATS</h2>
                <div class="story-text">
                    <p>You have chosen to be a <span id="selected-class"></span>.</p>
                    <p>Roll 2 dice for each attribute:</p>
                    <p><strong>Skill:</strong> 2 dice + class bonus</p>
                    <p><strong>Stamina:</strong> 2 dice + class bonus</p>
                    <p><strong>Luck:</strong> 2 dice + class bonus</p>
                    <div id="dice-results"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="rollCharacterStats()">ROLL DICE</button>
                    <button class="action-btn" onclick="confirmStats()" id="confirm-btn" disabled>BEGIN ADVENTURE</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen">
            <div class="stats-bar">
                <div class="stat-item">SKILL: <span id="stat-skill" class="stat-value">0</span></div>
                <div class="stat-item">STAMINA: <span id="stat-stamina" class="stat-value">0</span>/<span id="stat-maxstamina" class="stat-value">0</span></div>
                <div class="stat-item">LUCK: <span id="stat-luck" class="stat-value">0</span></div>
                <div class="stat-item">GOLD: <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <h2>INVENTORY</h2>
            <div class="inventory" id="inventory">
                <span class="inventory-item" id="inv-weapon">Dagger (1d6)</span>
                <span class="inventory-item" id="inv-armor">Leather Armor (1 DEF)</span>
            </div>
            
            <h2>THE ADVENTURE</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useLuck()">TEST LUCK</button>
                <button class="action-btn" onclick="checkInventory()">INVENTORY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
            </div>
        </div>
        
        <!-- Next Level Screen -->
        <div id="screen-next" class="screen">
            <h2>VICTORY!</h2>
            <div class="story-text">
                <p>You have survived the MOUNTAINS OF DOOM!</p>
                <p>With the mountain pass behind you, you look down into the valley below. There lies the CITY OF SHADOWS, your next destination.</p>
                <p>Your journey continues... All your stats, gold, and inventory will carry over to the next chapter.</p>
                <div class="stats-bar">
                    <div class="stat-item">SKILL: <span id="next-stat-skill" class="stat-value">0</span></div>
                    <div class="stat-item">STAMINA: <span id="next-stat-stamina" class="stat-value">0</span></div>
                    <div class="stat-item">LUCK: <span id="next-stat-luck" class="stat-value">0</span></div>
                    <div class="stat-item">GOLD: <span id="next-stat-gold" class="stat-value">0</span></div>
                </div>
            </div>
            
            <div class="next-level">
                <button class="next-level-btn" onclick="goToNextLevel()">CONTINUE TO CITY OF SHADOWS</button>
            </div>
        </div>
        
        <div class="retro-notice">
            DREADWOOD - A Retro Gamebook Adventure<br>
            Level 1: Mountains of Doom
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            playerClass: '',
            skill: 0,
            maxStamina: 0,
            stamina: 0,
            luck: 0,
            gold: 0,
            inventory: [],
            weapons: [{name: 'Dagger', damage: '1d6'}],
            armor: [{name: 'Leather Armor', defense: 1}],
            currentWeaponIndex: 0,
            currentArmorIndex: 0,
            currentSection: 1,
            gameComplete: false
        };
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyStamina: 0,
            enemyCurrentStamina: 0,
            enemySkill: 0,
            nextSection: 0,
            round: 1
        };
        
        // Game story sections for Level 1
        const storySections = {
            1: {
                text: "You stand at the entrance to the Mountains of Doom. The wind howls through jagged peaks. Before you, two paths diverge: one climbs steeply up the mountain, the other descends into a dark ravine. Which path will you take?",
                choices: [
                    {text: "Take the mountain path upwards", nextSection: 2, skillCheck: false},
                    {text: "Descend into the dark ravine", nextSection: 3, skillCheck: false},
                    {text: "Search the area for supplies", nextSection: 4, skillCheck: false}
                ]
            },
            2: {
                text: "You climb the steep mountain path. The air grows thin and cold. Suddenly, you spot a creature with glowing red eyes blocking the path ahead. It's a MOUNTAIN GREMLIN! It snarls and prepares to attack.",
                choices: [
                    {text: "Fight the Gremlin", nextSection: 5, skillCheck: false},
                    {text: "Try to sneak past it", nextSection: 6, skillCheck: true, checkType: 'skill', difficulty: 10},
                    {text: "Use a Luck point to distract it", nextSection: 7, skillCheck: false}
                ]
            },
            3: {
                text: "You descend into the dark ravine. The sunlight barely reaches here. You find an abandoned campsite with a chest. The chest is locked with a strange mechanism.",
                choices: [
                    {text: "Try to pick the lock", nextSection: 8, skillCheck: true, checkType: 'skill', difficulty: 12},
                    {text: "Break the lock with force", nextSection: 9, skillCheck: false},
                    {text: "Leave it and continue", nextSection: 10, skillCheck: false}
                ]
            },
            4: {
                text: "You search the area carefully and find a hidden cache of supplies! You discover 10 Gold coins and a Healing Potion that restores 4 Stamina.",
                choices: [
                    {text: "Take the supplies and continue up the mountain", nextSection: 2, skillCheck: false},
                    {text: "Take the supplies and descend into the ravine", nextSection: 3, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 10;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 4);
                    updateStatsDisplay();
                    gameState.inventory.push('Healing Potion');
                    updateInventoryDisplay();
                    return "You found 10 Gold and a Healing Potion! Your Stamina is restored by 4 points.";
                }
            },
            5: {
                text: "You draw your weapon and face the Gremlin. Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 501, skillCheck: false}
                ]
            },
            501: {
                text: "You face the Mountain Gremlin! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 502, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Mountain Gremlin
                    combatState.active = true;
                    combatState.enemyName = "Mountain Gremlin";
                    combatState.enemyStamina = 8;
                    combatState.enemyCurrentStamina = 8;
                    combatState.enemySkill = 5;
                    combatState.nextSection = 11;
                    combatState.round = 1;
                    
                    return "Mountain Gremlin: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            6: {
                text: "You attempt to sneak past the Gremlin...",
                choices: [
                    {text: "Continue", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    // Skill check was already performed, result is in checkResult
                    if (window.checkResult) {
                        return "You successfully sneak past the Gremlin without being noticed!";
                    } else {
                        return "The Gremlin spots you! It attacks with surprise!";
                    }
                }
            },
            7: {
                text: "You use your Luck to create a distraction...",
                choices: [
                    {text: "Continue", nextSection: 13, skillCheck: false}
                ],
                action: function() {
                    gameState.luck -= 1;
                    updateStatsDisplay();
                    return "You throw a rock to distract the Gremlin. It works! While it investigates the noise, you slip past safely. You lose 1 Luck point.";
                }
            },
            8: {
                text: "You attempt to pick the lock...",
                choices: [
                    {text: "Continue", nextSection: 14, skillCheck: false}
                ],
                action: function() {
                    // Skill check was already performed, result is in checkResult
                    if (window.checkResult) {
                        gameState.gold += 15;
                        gameState.weapons.push({name: 'Short Sword', damage: '2d4'});
                        gameState.currentWeaponIndex = gameState.weapons.length - 1;
                        updateStatsDisplay();
                        updateEquipmentDisplay();
                        return "You successfully pick the lock! Inside you find a Short Sword (2d4 damage) and 15 Gold!";
                    } else {
                        return "The lock proves too difficult. You break your lockpick and must leave the chest behind.";
                    }
                }
            },
            9: {
                text: "You try to break the lock with a heavy rock...",
                choices: [
                    {text: "Continue", nextSection: 15, skillCheck: false}
                ],
                action: function() {
                    const damage = rollDiceHelper(1, 3);
                    gameState.stamina -= damage;
                    updateStatsDisplay();
                    
                    if (gameState.stamina <= 0) {
                        return "The chest explodes in your face! You take " + damage + " damage and fall unconscious. When you wake, the chest is gone. You lose " + damage + " Stamina.";
                    } else {
                        gameState.gold += 20;
                        return "You smash the lock open but take " + damage + " damage from flying splinters. Inside you find 20 Gold! You lose " + damage + " Stamina.";
                    }
                }
            },
            10: {
                text: "You leave the chest and continue through the ravine. You emerge on the other side of the mountains safely. You've completed the Mountains of Doom!",
                choices: [
                    {text: "Continue to next level", nextSection: 100, skillCheck: false}
                ]
            },
            11: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 16, skillCheck: false}
                ]
            },
            12: {
                text: "You successfully sneak past the Gremlin and continue up the mountain path. At the summit, you find an ancient temple with a treasure chest.",
                choices: [
                    {text: "Open the chest", nextSection: 17, skillCheck: false},
                    {text: "Leave the temple and continue", nextSection: 10, skillCheck: false}
                ]
            },
            13: {
                text: "You distract the Gremlin and continue up the path. You find a hidden cave with a mysterious old hermit inside.",
                choices: [
                    {text: "Talk to the hermit", nextSection: 18, skillCheck: false},
                    {text: "Attack the hermit", nextSection: 19, skillCheck: false},
                    {text: "Leave quietly", nextSection: 10, skillCheck: false}
                ]
            },
            14: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue through the ravine", nextSection: 10, skillCheck: false}
                ]
            },
            15: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Continue through the ravine", nextSection: 10, skillCheck: false}
                ]
            },
            16: {
                text: "After the battle, you continue up the mountain. You find a hidden path that leads to a dragon's lair!",
                choices: [
                    {text: "Enter the dragon's lair", nextSection: 20, skillCheck: false},
                    {text: "Take the safe path around", nextSection: 10, skillCheck: false}
                ]
            },
            17: {
                text: "You open the chest and find a magical amulet! It glows with a soft blue light. You also find 30 Gold.",
                choices: [
                    {text: "Take the treasure and continue", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 30;
                    updateStatsDisplay();
                    gameState.inventory.push('Magical Amulet');
                    updateInventoryDisplay();
                    return "You acquire a Magical Amulet and 30 Gold!";
                }
            },
            18: {
                text: "The hermit greets you warmly. 'Traveler, I can bless your journey for a small donation of 5 Gold.'",
                choices: [
                    {text: "Pay 5 Gold for the blessing", nextSection: 21, skillCheck: false},
                    {text: "Refuse and leave", nextSection: 10, skillCheck: false}
                ]
            },
            19: {
                text: "You attack the helpless hermit! Prepare for combat.",
                choices: [
                    {text: "Begin the battle!", nextSection: 1901, skillCheck: false}
                ]
            },
            1901: {
                text: "You face the Defenseless Hermit! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 1902, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Defenseless Hermit
                    combatState.active = true;
                    combatState.enemyName = "Defenseless Hermit";
                    combatState.enemyStamina = 4;
                    combatState.enemyCurrentStamina = 4;
                    combatState.enemySkill = 2;
                    combatState.nextSection = 22;
                    combatState.round = 1;
                    
                    return "Defenseless Hermit: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            20: {
                text: "You enter the dragon's lair! The beast is sleeping on a pile of treasure. You see a magnificent sword among the gold.",
                choices: [
                    {text: "Try to steal the sword", nextSection: 23, skillCheck: true, checkType: 'skill', difficulty: 14},
                    {text: "Attack the dragon", nextSection: 24, skillCheck: false},
                    {text: "Leave quietly", nextSection: 10, skillCheck: false}
                ]
            },
            21: {
                text: "The hermit blesses you. You feel stronger and luckier!",
                choices: [
                    {text: "Continue your journey", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    if (gameState.gold >= 5) {
                        gameState.gold -= 5;
                        gameState.skill += 1;
                        gameState.luck += 1;
                        updateStatsDisplay();
                        return "The hermit's blessing increases your Skill by 1 and Luck by 1!";
                    } else {
                        return "You don't have enough gold. The hermit shoos you away.";
                    }
                }
            },
            22: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 25, skillCheck: false}
                ]
            },
            23: {
                text: "You attempt to steal the sword while the dragon sleeps...",
                choices: [
                    {text: "Continue", nextSection: 26, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        gameState.weapons.push({name: 'Dragon Slayer Sword', damage: '3d6'});
                        gameState.currentWeaponIndex = gameState.weapons.length - 1;
                        updateEquipmentDisplay();
                        return "You successfully steal the Dragon Slayer Sword (3d6 damage) without waking the dragon!";
                    } else {
                        return "You accidentally wake the dragon! It roars in anger and attacks!";
                    }
                }
            },
            24: {
                text: "You attack the sleeping dragon! Prepare for combat!",
                choices: [
                    {text: "Begin the battle!", nextSection: 2401, skillCheck: false}
                ]
            },
            2401: {
                text: "You face the Ancient Dragon! Roll for the first attack!",
                choices: [
                    {text: "Attack!", nextSection: 2402, skillCheck: false}
                ],
                action: function() {
                    // Initialize combat for Ancient Dragon
                    combatState.active = true;
                    combatState.enemyName = "Ancient Dragon";
                    combatState.enemyStamina = 20;
                    combatState.enemyCurrentStamina = 20;
                    combatState.enemySkill = 12;
                    combatState.nextSection = 27;
                    combatState.round = 1;
                    
                    return "Ancient Dragon: Stamina " + combatState.enemyCurrentStamina + ", Skill " + combatState.enemySkill;
                }
            },
            25: {
                text: "You killed the defenseless hermit. You find 5 Gold on his body, but you feel a curse upon you.",
                choices: [
                    {text: "Continue your journey", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 5;
                    gameState.luck -= 2;
                    updateStatsDisplay();
                    return "You gain 5 Gold but lose 2 Luck points from the evil deed.";
                }
            },
            26: {
                text: "", // Will be filled by action
                choices: [
                    {text: "Escape with your treasure", nextSection: 10, skillCheck: false}
                ]
            },
            27: {
                text: "", // Will be filled by combat results
                choices: [
                    {text: "Continue", nextSection: 28, skillCheck: false}
                ]
            },
            28: {
                text: "Against all odds, you defeated the dragon! You claim its entire treasure hoard: 100 Gold and the Dragon Slayer Sword!",
                choices: [
                    {text: "Take the treasure and leave", nextSection: 10, skillCheck: false}
                ],
                action: function() {
                    gameState.gold += 100;
                    gameState.weapons.push({name: 'Dragon Slayer Sword', damage: '3d6'});
                    gameState.currentWeaponIndex = gameState.weapons.length - 1;
                    updateStatsDisplay();
                    updateEquipmentDisplay();
                    return "You claim 100 Gold and the mighty Dragon Slayer Sword!";
                }
            },
            // Combat sections
            502: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 503, skillCheck: false}
                ]
            },
            503: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 502, skillCheck: false}
                ]
            },
            1902: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1903, skillCheck: false}
                ]
            },
            1903: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 1902, skillCheck: false}
                ]
            },
            2402: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2403, skillCheck: false}
                ]
            },
            2403: {
                text: "", // Will be filled by combat round
                choices: [
                    {text: "Continue the fight!", nextSection: 2402, skillCheck: false}
                ]
            },
            100: {
                text: "Congratulations! You have survived the Mountains of Doom. You can now continue your journey to the City of Shadows.",
                choices: [],
                action: function() {
                    gameState.gameComplete = true;
                    showScreen('screen-next');
                    document.getElementById('next-stat-skill').textContent = gameState.skill;
                    document.getElementById('next-stat-stamina').textContent = gameState.stamina;
                    document.getElementById('next-stat-luck').textContent = gameState.luck;
                    document.getElementById('next-stat-gold').textContent = gameState.gold;
                    return "";
                }
            }
        };
        
        // Initialize game
        function initGame() {
            // Check for saved game
            const savedGame = localStorage.getItem('dreadwoodGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                Object.assign(gameState, savedState);
                
                // Ensure indices exist
                if (gameState.currentWeaponIndex === undefined) {
                    gameState.currentWeaponIndex = gameState.weapons.length - 1;
                }
                if (gameState.currentArmorIndex === undefined) {
                    gameState.currentArmorIndex = gameState.armor.length - 1;
                }
                
                updateStatsDisplay();
                updateInventoryDisplay();
                showScreen('screen-game');
                loadSection(gameState.currentSection);
            } else {
                showScreen('screen-creation');
            }
        }
        
        // Show specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
        }
        
        // Select character class
        function selectClass(className) {
            gameState.playerClass = className;
            document.getElementById('selected-class').textContent = className.toUpperCase();
            document.getElementById('dice-roll-section').style.display = 'block';
        }
        
        // Roll dice for character stats
        function rollCharacterStats() {
            const skillRoll = rollDiceHelper(2, 6);
            const staminaRoll = rollDiceHelper(2, 6);
            const luckRoll = rollDiceHelper(2, 6);
            
            // Apply class bonuses
            let skillBonus = 0, staminaBonus = 0, luckBonus = 0;
            
            switch(gameState.playerClass) {
                case 'warrior':
                    skillBonus = 2;
                    staminaBonus = 4;
                    luckBonus = 0;
                    break;
                case 'rogue':
                    skillBonus = 3;
                    staminaBonus = 2;
                    luckBonus = 1;
                    break;
                case 'mage':
                    skillBonus = 1;
                    staminaBonus = 2;
                    luckBonus = 3;
                    break;
            }
            
            gameState.skill = skillRoll + skillBonus;
            gameState.maxStamina = staminaRoll + staminaBonus;
            gameState.stamina = gameState.maxStamina;
            gameState.luck = luckRoll + luckBonus;
            gameState.gold = 5; // Starting gold
            
            document.getElementById('dice-results').innerHTML = `
                <div class="dice-roll">Skill Roll: ${skillRoll} + ${skillBonus} = <span class="stat-value">${gameState.skill}</span></div>
                <div class="dice-roll">Stamina Roll: ${staminaRoll} + ${staminaBonus} = <span class="stat-value">${gameState.maxStamina}</span></div>
                <div class="dice-roll">Luck Roll: ${luckRoll} + ${luckBonus} = <span class="stat-value">${gameState.luck}</span></div>
            `;
            
            document.getElementById('confirm-btn').disabled = false;
        }
        
        // Confirm stats and start game
        function confirmStats() {
            updateStatsDisplay();
            updateInventoryDisplay();
            showScreen('screen-game');
            loadSection(1);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-skill').textContent = gameState.skill;
            document.getElementById('stat-stamina').textContent = gameState.stamina;
            document.getElementById('stat-maxstamina').textContent = gameState.maxStamina;
            document.getElementById('stat-luck').textContent = gameState.luck;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Update equipment display
        function updateEquipmentDisplay() {
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                document.getElementById('inv-weapon').textContent = `${weapon.name} (${weapon.damage})`;
            }
            if (gameState.armor && gameState.armor.length > 0 && gameState.currentArmorIndex >= 0) {
                const armor = gameState.armor[gameState.currentArmorIndex];
                document.getElementById('inv-armor').textContent = `${armor.name} (${armor.defense} DEF)`;
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            updateEquipmentDisplay();
            const inventoryDiv = document.getElementById('inventory');
            
            // Clear only the extra items, keep weapon and armor
            const weaponElement = document.getElementById('inv-weapon');
            const armorElement = document.getElementById('inv-armor');
            
            // Remove all extra inventory items
            const extraItems = inventoryDiv.querySelectorAll('.inventory-item:not(#inv-weapon):not(#inv-armor)');
            extraItems.forEach(item => item.remove());
            
            // Add gold
            const goldSpan = document.createElement('span');
            goldSpan.className = 'inventory-item';
            goldSpan.textContent = `${gameState.gold} Gold`;
            inventoryDiv.appendChild(goldSpan);
            
            // Add other inventory items
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    // Don't show items that are currently equipped weapons/armor
                    const isCurrentWeapon = gameState.weapons[gameState.currentWeaponIndex] && 
                        gameState.weapons[gameState.currentWeaponIndex].name === item;
                    const isCurrentArmor = gameState.armor[gameState.currentArmorIndex] && 
                        gameState.armor[gameState.currentArmorIndex].name === item;
                    
                    if (!isCurrentWeapon && !isCurrentArmor) {
                        const itemSpan = document.createElement('span');
                        itemSpan.className = 'inventory-item';
                        itemSpan.textContent = item;
                        inventoryDiv.appendChild(itemSpan);
                    }
                });
            }
        }
        
        // Load story section
        function loadSection(sectionId) {
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Check if this is a combat round section
            const isCombatRound = (sectionId === 502 || sectionId === 503 || 
                                 sectionId === 1902 || sectionId === 1903 ||
                                 sectionId === 2402 || sectionId === 2403);
            
            if (isCombatRound && combatState.active) {
                // Execute combat round
                const combatResult = executeCombatRound();
                storyText = combatResult;
                
                // Check if combat is over
                if (!combatState.active) {
                    // Combat ended, show victory and continue to next section
                    const goldReward = Math.floor(Math.random() * 20) + 5;
                    gameState.gold += goldReward;
                    updateStatsDisplay();
                    
                    storyText += `<br><span class="success">You defeated the ${combatState.enemyName}!</span>`;
                    storyText += `<br>You find ${goldReward} Gold on the body.`;
                    
                    // Clear choice buttons - combat is over
                    document.getElementById('choice-buttons').innerHTML = '';
                    
                    // Auto-continue to next section after combat
                    setTimeout(() => {
                        loadSection(combatState.nextSection);
                    }, 2000);
                }
            }
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p>";
            
            // Only show choice buttons if not in an ended combat
            if (!isCombatRound || combatState.active) {
                const choiceButtons = document.getElementById('choice-buttons');
                choiceButtons.innerHTML = '';
                
                section.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
       // Execute one round of combat
function executeCombatRound() {
    combatState.round++;
    
    // Roll dice for both combatants
    const playerRoll = rollDiceHelper(2, 6);
    const enemyRoll = rollDiceHelper(2, 6);
    
    // Add skill to dice rolls
    const playerTotal = playerRoll + gameState.skill;
    const enemyTotal = enemyRoll + combatState.enemySkill;
    
    let resultText = `<span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
    resultText += `Your Stamina: ${gameState.stamina}, Enemy Stamina: ${combatState.enemyCurrentStamina}<br>`;
    resultText += `You roll ${playerRoll} + Skill ${gameState.skill} = <strong>${playerTotal}</strong><br>`;
    resultText += `Enemy rolls ${enemyRoll} + Skill ${combatState.enemySkill} = <strong>${enemyTotal}</strong><br>`;
    
    if (playerTotal > enemyTotal) {
        // Player hits enemy
        let damage = 0;
        if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
            const weapon = gameState.weapons[gameState.currentWeaponIndex];
            if (weapon.damage === '1d6') damage = rollDiceHelper(1, 6);
            else if (weapon.damage === '2d4') damage = rollDiceHelper(2, 4);
            else if (weapon.damage === '3d6') damage = rollDiceHelper(3, 6);
            else damage = rollDiceHelper(1, 6); // Default fallback
        } else {
            damage = rollDiceHelper(1, 6);
        }
        
        combatState.enemyCurrentStamina -= damage;
        resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
        
        if (combatState.enemyCurrentStamina <= 0) {
            combatState.active = false;
            return resultText;
        }
        
    } else if (playerTotal < enemyTotal) {
        // Enemy hits player
        const enemyDamage = rollDiceHelper(1, 6); // Enemy always uses 1d6 damage
        gameState.stamina -= enemyDamage;
        resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
        
        // Check if player died
        if (gameState.stamina <= 0) {
            combatState.active = false;
            resultText += `<br><span class="game-over">You have been defeated by the ${combatState.enemyName}! Game Over.</span>`;
            setTimeout(() => {
                localStorage.removeItem('dreadwoodGameState');
                location.reload();
            }, 3000);
        }
    } else {
        // Tie - no damage dealt
        resultText += "The attacks are evenly matched! No damage dealt this round.";
    }
    
    updateStatsDisplay();
    
    return resultText;
}
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            const diceRoll = rollDiceHelper(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Luck
        function useLuck() {
            if (gameState.luck <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Luck left!</div>`;
                return;
            }
            
            const diceRoll = rollDiceHelper(2, 6);
            const success = diceRoll <= gameState.luck;
            
            gameState.luck -= 1;
            updateStatsDisplay();
            
            let resultText = `You test your Luck... Roll: ${diceRoll}, Luck: ${gameState.luck + 1}. `;
            resultText += success ? 
                `<span class="success">Lucky!</span> Something good happens.` : 
                `<span class="damage">Unlucky!</span> Something bad happens.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            // Apply Luck effect
            if (success) {
                // Good effect
                const goodEffects = [
                    "You find 5 Gold on the ground!",
                    "You feel a surge of energy! Restore 3 Stamina.",
                    "You spot a hidden path that might be useful."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("Gold")) {
                    gameState.gold += 5;
                } else if (effect.includes("Stamina")) {
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + 3);
                }
            } else {
                // Bad effect
                const badEffects = [
                    "You trip and take 2 damage!",
                    "You drop 3 Gold!",
                    "You feel weaker. Lose 1 Skill until next rest."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.stamina -= 2;
                } else if (effect.includes("Gold")) {
                    gameState.gold = Math.max(0, gameState.gold - 3);
                } else if (effect.includes("Skill")) {
                    gameState.skill = Math.max(1, gameState.skill - 1);
                }
            }
            
            updateStatsDisplay();
            updateInventoryDisplay();
        }
        
        // Check inventory
        function checkInventory() {
            let inventoryText = "<h3>Your Inventory:</h3>";
            
            // Show current equipped weapon
            if (gameState.weapons && gameState.weapons.length > 0 && gameState.currentWeaponIndex >= 0) {
                const weapon = gameState.weapons[gameState.currentWeaponIndex];
                inventoryText += `<p><strong>Equipped Weapon:</strong> ${weapon.name} (${weapon.damage} damage)</p>`;
            }
            
            // Show all available weapons
            inventoryText += "<p><strong>Available Weapons:</strong><br>";
            gameState.weapons.forEach((weapon, index) => {
                const isEquipped = index === gameState.currentWeaponIndex;
                inventoryText += `${isEquipped ? "â†’ " : ""}${weapon.name} (${weapon.damage})`;
                if (!isEquipped) {
                    inventoryText += ` <button onclick="equipWeapon(${index})" style="font-size:10px; padding:2px 5px;">Equip</button>`;
                }
                inventoryText += "<br>";
            });
            inventoryText += "</p>";
            
            inventoryText += `<p><strong>Armor:</strong> ${gameState.armor[0].name} (${gameState.armor[0].defense} DEF)</p>`;
            inventoryText += `<p><strong>Gold:</strong> ${gameState.gold}</p>`;
            
            // Show other items WITH USE BUTTONS
            if (gameState.inventory && gameState.inventory.length > 0) {
                inventoryText += `<p><strong>Usable Items:</strong><br>`;
                const usableItems = gameState.inventory.filter(item => {
                    const isWeapon = gameState.weapons.some(w => w.name === item);
                    const isArmor = gameState.armor.some(a => a.name === item);
                    return !isWeapon && !isArmor;
                });
                
                if (usableItems.length > 0) {
                    usableItems.forEach(item => {
                        inventoryText += `${item} `;
                        
                        // Add use button based on item type
                        if (item === "Healing Potion") {
                            inventoryText += `<button onclick="useHealingPotion()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else if (item === "Magical Amulet") {
                            inventoryText += `<button onclick="useMagicalAmulet()" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        } else {
                            inventoryText += `<button onclick="useGenericItem('${item}')" style="font-size:10px; padding:2px 5px;">Use</button>`;
                        }
                        
                        inventoryText += `<br>`;
                    });
                } else {
                    inventoryText += "None";
                }
                inventoryText += `</p>`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${inventoryText}</div>`;
        }
        
        // Use item function
        function useItem() {
            // Filter to get only usable items (not equipped weapons/armor)
            const usableItems = gameState.inventory.filter(item => {
                const isWeapon = gameState.weapons.some(w => w.name === item);
                const isArmor = gameState.armor.some(a => a.name === item);
                return !isWeapon && !isArmor;
            });
            
            if (usableItems.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory!</div>`;
                return;
            }
            
            let itemText = "<h3>Select an item to use:</h3>";
            
            usableItems.forEach((item, index) => {
                itemText += `<p>${item} `;
                
                // Add use button with appropriate effect
                if (item === "Healing Potion") {
                    itemText += `<button onclick="useHealingPotion()" style="font-size:12px; padding:3px 8px;">Drink (Restore Stamina)</button>`;
                } else if (item === "Magical Amulet") {
                    itemText += `<button onclick="useMagicalAmulet()" style="font-size:12px; padding:3px 8px;">Activate (Boost Stats)</button>`;
                } else {
                    // Generic use button for other items
                    itemText += `<button onclick="useGenericItem('${item}')" style="font-size:12px; padding:3px 8px;">Use</button>`;
                }
                
                itemText += `</p>`;
            });
            
            itemText += `<p><button onclick="cancelItemUse()" style="font-size:12px; padding:3px 8px; margin-top:10px;">Cancel</button></p>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${itemText}</div>`;
        }
        
        // Use Healing Potion
        function useHealingPotion() {
            // Find and remove the potion from inventory
            const potionIndex = gameState.inventory.indexOf("Healing Potion");
            if (potionIndex !== -1) {
                gameState.inventory.splice(potionIndex, 1);
                
                // Restore stamina
                const healAmount = 6; // Healing potion restores 6 stamina
                const oldStamina = gameState.stamina;
                gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                const actualHeal = gameState.stamina - oldStamina;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You drink the Healing Potion and restore ${actualHeal} Stamina!</span></div>`;
            }
        }
        
        // Use Magical Amulet
        function useMagicalAmulet() {
            // Find and remove the amulet from inventory
            const amuletIndex = gameState.inventory.indexOf("Magical Amulet");
            if (amuletIndex !== -1) {
                gameState.inventory.splice(amuletIndex, 1);
                
                // Boost stats
                gameState.luck += 2;
                gameState.skill += 1;
                
                updateInventoryDisplay();
                updateStatsDisplay();
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">You activate the Magical Amulet! Your Luck increases by 2 and Skill by 1!</span></div>`;
            }
        }
        
        // Use Generic Item
        function useGenericItem(itemName) {
            // Generic item use function
            const itemIndex = gameState.inventory.indexOf(itemName);
            if (itemIndex !== -1) {
                gameState.inventory.splice(itemIndex, 1);
                updateInventoryDisplay();
                
                // Determine effect based on item name
                let effectText = "";
                if (itemName.includes("Potion") || itemName.includes("Elixir")) {
                    // Generic potion effect
                    const healAmount = rollDiceHelper(1, 4) + 2;
                    const oldStamina = gameState.stamina;
                    gameState.stamina = Math.min(gameState.maxStamina, gameState.stamina + healAmount);
                    const actualHeal = gameState.stamina - oldStamina;
                    effectText = `You use the ${itemName} and restore ${actualHeal} Stamina!`;
                    updateStatsDisplay();
                } else if (itemName.includes("Scroll") || itemName.includes("Rune")) {
                    // Magical item effect
                    gameState.luck += 1;
                    effectText = `You use the ${itemName} and feel luckier! Luck +1`;
                    updateStatsDisplay();
                } else {
                    // Default effect
                    effectText = `You use the ${itemName}.`;
                }
                
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll"><span class="success">${effectText}</span></div>`;
            }
        }
        
        // Cancel item use
        function cancelItemUse() {
            document.getElementById('story-text').innerHTML += 
                `<div class="dice-roll">You decide not to use an item.</div>`;
        }
        
        // Equip weapon function
        function equipWeapon(index) {
            if (index >= 0 && index < gameState.weapons.length) {
                gameState.currentWeaponIndex = index;
                updateEquipmentDisplay();
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">Equipped ${gameState.weapons[index].name}!</div>`;
                saveGame();
            }
        }
        
        // Save game
        function saveGame() {
            // Ensure indices are valid before saving
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">Game saved!</div>`;
        }
        
        // Go to next level
        function goToNextLevel() {
            // Ensure indices are valid
            if (gameState.currentWeaponIndex >= gameState.weapons.length) {
                gameState.currentWeaponIndex = gameState.weapons.length - 1;
            }
            if (gameState.currentArmorIndex >= gameState.armor.length) {
                gameState.currentArmorIndex = gameState.armor.length - 1;
            }
            
            // Save game state for level 2
            localStorage.setItem('dreadwoodGameState', JSON.stringify(gameState));
            // Redirect to level 2
            window.location.href = 'level2.html';
        }
        
        // Utility function to roll dice
        function rollDiceHelper(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
    </script>
</body>
</html>
