<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>House of Hell - Level 1</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #0f0;
            line-height: 1.4;
            padding: 10px;
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }
        
        /* Container */
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            padding: 10px;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px dashed #0f0;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 2rem;
            color: #ff3030;
            text-shadow: 0 0 5px #ff0000;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #0f0;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .level-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #ff0;
            font-size: 1rem;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 5px 10px;
            border-radius: 10px;
            z-index: 4;
        }
        
        /* Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #111;
            border: 1px solid #0f0;
            border-radius: 5px;
        }
        
        .stat-item {
            text-align: center;
            padding: 3px;
            border: 1px solid #333;
            border-radius: 3px;
            position: relative;
            cursor: help;
        }
        
        .stat-item:hover {
            border-color: #0f0;
            background-color: #222;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .stat-value {
            font-size: 1.3rem;
            color: #ff0;
            font-weight: bold;
        }
        
        .stat-max {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            border: 1px solid #0f0;
            background-color: #111;
            margin-bottom: 15px;
            font-size: 1.2rem;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #0f0 #000;
        }
        
        .content::-webkit-scrollbar {
            width: 10px;
        }
        
        .content::-webkit-scrollbar-track {
            background: #000;
        }
        
        .content::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 0;
        }
        
        /* Choices */
        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .choice-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .choice-btn i {
            font-size: 1.1rem;
        }
        
        .choice-btn:active, .choice-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-2px);
        }
        
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px dashed #0f0;
        }
        
        .control-btn {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .control-btn:active, .control-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-text {
            color: #0f0;
            font-size: 1.5rem;
            margin-bottom: 20px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .loading-bar {
            width: 80%;
            height: 20px;
            border: 1px solid #0f0;
            padding: 2px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            height: 100%;
            background-color: #0f0;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Utility */
        .hidden {
            display: none !important;
        }
        
        .footer {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            padding-top: 10px;
            border-top: 1px dashed #333;
        }
        
        /* Visual Effects */
        .screen-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            animation: scanline 10s linear infinite;
            z-index: 2;
        }
        
        @keyframes scanline {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .crt-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(0, 255, 0, 0.03) 50%,
                rgba(0, 0, 0, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 3;
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            font-size: 1.2rem;
            border-radius: 50%;
        }
        
        /* Page Navigation */
        .page-nav {
            position: absolute;
            top: 15px;
            left: 70px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-nav:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Responsive */
        @media (max-height: 700px) {
            h1 { font-size: 1.7rem; }
            .subtitle { font-size: 1rem; }
            .content { font-size: 1.1rem; }
            .choice-btn { padding: 10px 12px; font-size: 1.1rem; }
        }
        
        @media (max-width: 400px) {
            .container { padding: 8px; }
            h1 { font-size: 1.5rem; }
            .choice-btn { padding: 8px 10px; font-size: 1rem; }
            .page-nav { left: 60px; padding: 5px 10px; }
        }
        
        /* Death Message */
        .death-message {
            color: #ff3030;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 10px;
            border: 1px solid #ff3030;
            margin: 10px 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced Inventory Panel */
        .inventory-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .inventory-header {
            padding: 15px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-title {
            color: #ff0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        
        .inventory-close {
            background: none;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inventory-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .inventory-item-card {
            background-color: #111;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .inventory-item-card:hover {
            transform: translateY(-5px);
            border-color: #0f0;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        .inventory-item-card.item-equipped {
            border-color: #ff0;
            background-color: #222;
        }
        
        .item-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #0f0;
        }
        
        .item-name {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .item-type {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }
        
        .item-quantity {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #0f0;
            color: #000;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .item-details {
            background-color: #000;
            border: 1px solid #0f0;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }
        
        .item-description {
            color: #ccc;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-action-btn {
            flex: 1;
            padding: 8px;
            background-color: #000;
            border: 1px solid #0f0;
            color: #0f0;
            cursor: pointer;
            font-family: 'VT323', monospace;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .item-action-btn:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .inventory-footer {
            padding: 15px;
            background-color: #000;
            border-top: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-stats {
            color: #0f0;
            font-size: 1rem;
        }
        
        .inventory-empty {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* Inventory Button */
        .inventory-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 5;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .inventory-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .inventory-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff3030;
            color: #000;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Combat Panel */
        .combat-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #ff3030;
            padding: 20px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }
        
        .combat-title {
            color: #ff3030;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff0000;
            animation: glow 2s infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #ff0000; }
            50% { text-shadow: 0 0 20px #ff0000, 0 0 30px #ff3030; }
        }
        
        .combatants {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .combatant {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #0f0;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .combatant.enemy {
            border-color: #ff3030;
        }
        
        .combatant-name {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ff0;
        }
        
        .combatant.enemy .combatant-name {
            color: #ff3030;
        }
        
        .combatant-stats {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .health-bar-container {
            margin: 10px 0;
        }
        
        .health-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .health-bar {
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .health-fill {
            height: 100%;
            background-color: #0f0;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .health-fill.enemy {
            background-color: #ff3030;
        }
        
        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .combat-log {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dotted #333;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .player-log {
            color: #0f0;
            border-left: 3px solid #0f0;
            padding-left: 10px;
        }
        
        .enemy-log {
            color: #ff3030;
            border-left: 3px solid #ff3030;
            padding-left: 10px;
        }
        
        .event-log {
            color: #ff0;
            border-left: 3px solid #ff0;
            padding-left: 10px;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .combat-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            border-radius: 5px;
        }
        
        .combat-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .combat-btn.attack {
            border-color: #ff3030;
            color: #ff3030;
        }
        
        .combat-btn.attack:hover {
            background-color: #ff3030;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 48, 48, 0.3);
        }
        
        .combat-btn.flee {
            border-color: #ff8000;
            color: #ff8000;
        }
        
        .combat-btn.flee:hover {
            background-color: #ff8000;
            color: #000;
        }
        
        /* Dialog Panel */
        .dialog-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 20;
            width: 90%;
            max-width: 400px;
        }
        
        .dialog-title {
            color: #0f0;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        .dialog-text {
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialog-option {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .dialog-option:hover {
            background-color: #0f0;
            color: #000;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 1px solid #0f0;
            padding: 15px 20px;
            z-index: 30;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.2);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #0f0;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .loading-tip {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* Stat tooltip */
        .stat-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            margin-bottom: 5px;
        }
        
        .stat-item:hover .stat-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Damage numbers */
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            text-shadow: 0 0 5px #000;
            z-index: 100;
        }
        
        .damage-number.player {
            color: #ff3030;
        }
        
        .damage-number.enemy {
            color: #0f0;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        /* Item tooltip */
        .item-tooltip {
            position: absolute;
            background-color: #000;
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 0.9rem;
            max-width: 200px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .inventory-item-card:hover .item-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Level Complete Screen */
        .level-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 60;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .level-complete h2 {
            color: #ff0;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            animation: glow 2s infinite;
        }
        
        .level-complete p {
            font-size: 1.5rem;
            margin-bottom: 30px;
            max-width: 600px;
        }
        
        .level-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .level-stat {
            text-align: center;
        }
        
        .level-stat-value {
            font-size: 2rem;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .level-stat-label {
            font-size: 1rem;
            color: #aaa;
        }
        
        .level-complete-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-complete-btn {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            font-family: 'VT323', monospace;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .level-complete-btn:hover {
            background-color: #0f0;
            color: #000;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        
        .level-complete-btn.next {
            background-color: #000;
            color: #ff0;
            border-color: #ff0;
        }
        
        .level-complete-btn.next:hover {
            background-color: #ff0;
            color: #000;
            box-shadow: 0 5px 15px rgba(255, 255, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="screen-border"></div>
    <div class="scanline"></div>
    <div class="crt-effect"></div>
    
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-text">HOUSE OF HELL</div>
        <div class="loading-text">LEVEL 1 - THE ENTRANCE</div>
        <div class="loading-text">LOADING ADVENTURE...</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingStatus">Initializing game data...</div>
        <div class="loading-tip">Your progress is automatically saved between levels</div>
    </div>
    
    <!-- Main Game Container -->
    <div class="container hidden" id="gameContainer">
        <!-- Top Controls -->
        <button class="sound-toggle" id="soundToggle">ðŸ”Š</button>
        <button class="inventory-toggle" id="inventoryToggle" title="Inventory">
            <i class="fas fa-backpack"></i>
            <span class="inventory-badge" id="inventoryBadge">0</span>
        </button>
        
        <!-- Page Navigation -->
        <button class="page-nav" id="pageNav" title="Select Level">
            <i class="fas fa-map"></i> Level 1
        </button>
        
        <!-- Enhanced Inventory Panel -->
        <div class="inventory-panel hidden" id="inventoryPanel">
            <div class="inventory-header">
                <div class="inventory-title">INVENTORY - LEVEL 1</div>
                <button class="inventory-close" id="inventoryClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inventory-content" id="inventoryContent">
                <!-- Items will be added here -->
            </div>
            <div class="inventory-footer">
                <div class="inventory-stats">
                    <span id="inventoryWeight">Weight: 0/10</span> | 
                    <span id="inventoryGold">Gold: 0</span> | 
                    <span id="inventoryCount">Items: 0</span>
                </div>
                <button class="item-action-btn" id="organizeInventory">
                    <i class="fas fa-sort-alpha-down"></i> Organize
                </button>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div>
                <h1>HOUSE OF HELL</h1>
                <div class="subtitle">Level 1 - The Entrance</div>
            </div>
            <div class="level-indicator">Level 1</div>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-label">FEAR</div>
                <div class="stat-value" id="fearValue">0</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Fear level. If it reaches 20, you go mad!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">STAMINA</div>
                <div class="stat-value" id="staminaValue">20</div>
                <div class="stat-max">/20</div>
                <div class="stat-tooltip">Your health. If it reaches 0, you die!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">SKILL</div>
                <div class="stat-value" id="skillValue">7</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your fighting ability. Higher is better!</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">LUCK</div>
                <div class="stat-value" id="luckValue">12</div>
                <div class="stat-max">/12</div>
                <div class="stat-tooltip">Your luck. Test it in dangerous situations!</div>
            </div>
        </div>
        
        <!-- Story Text -->
        <div class="content" id="storyText">
            <!-- Story text will appear here -->
        </div>
        
        <!-- Choices -->
        <div class="choices" id="choicesContainer">
            <!-- Choice buttons will appear here -->
        </div>
        
        <!-- Bottom Controls -->
        <div class="controls">
            <button class="control-btn" id="restartBtn">
                <i class="fas fa-redo"></i> RESTART
            </button>
            <button class="control-btn" id="saveBtn">
                <i class="fas fa-save"></i> SAVE
            </button>
            <button class="control-btn" id="loadBtn">
                <i class="fas fa-folder-open"></i> LOAD
            </button>
            <button class="control-btn" id="hintBtn">
                <i class="fas fa-lightbulb"></i> HINT
            </button>
        </div>
        
        <div class="footer">
            Based on the gamebook by Steve Jackson & Ian Livingstone | Enhanced Edition | Level 1 of 4
        </div>
        
        <!-- Enhanced Combat Panel -->
        <div class="combat-panel hidden" id="combatPanel">
            <div class="combat-title">COMBAT</div>
            <div class="combatants">
                <div class="combatant player">
                    <div class="combatant-name" id="playerCombatName">YOU</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="playerCombatSkill">7</span></div>
                        <div>STAMINA: <span id="playerCombatStamina">20</span></div>
                        <div>LUCK: <span id="playerCombatLuck">12</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="playerHealthText">20/20</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill" id="playerHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="combatant enemy">
                    <div class="combatant-name" id="enemyCombatName">ENEMY</div>
                    <div class="combatant-stats">
                        <div>SKILL: <span id="enemyCombatSkill">6</span></div>
                        <div>STAMINA: <span id="enemyCombatStamina">10</span></div>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-label">
                            <span>HEALTH</span>
                            <span id="enemyHealthText">10/10</span>
                        </div>
                        <div class="health-bar">
                            <div class="health-fill enemy" id="enemyHealthBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="combat-log" id="combatLog"></div>
            <div class="combat-actions" id="combatActions">
                <button class="combat-btn attack" id="combatAttack">
                    <i class="fas fa-fist-raised"></i> ATTACK
                </button>
                <button class="combat-btn" id="combatUseItem">
                    <i class="fas fa-box-open"></i> USE ITEM
                </button>
                <button class="combat-btn" id="combatLuck">
                    <i class="fas fa-dice"></i> TEST LUCK
                </button>
                <button class="combat-btn flee" id="combatFlee">
                    <i class="fas fa-running"></i> FLEE
                </button>
            </div>
        </div>
        
        <!-- Dialog Panel -->
        <div class="dialog-panel hidden" id="dialogPanel">
            <div class="dialog-title" id="dialogTitle">DIALOG</div>
            <div class="dialog-text" id="dialogText"></div>
            <div class="dialog-options" id="dialogOptions"></div>
        </div>
        
        <!-- Notification -->
        <div class="notification hidden" id="notification">
            <button class="notification-close" id="notificationClose">&times;</button>
            <div id="notificationText"></div>
        </div>
        
        <!-- Level Complete Screen -->
        <div class="level-complete hidden" id="levelComplete">
            <h2>LEVEL 1 COMPLETE!</h2>
            <p>You have survived the entrance hall of the House of Hell. But the true horror awaits deeper within...</p>
            
            <div class="level-stats">
                <div class="level-stat">
                    <div class="level-stat-value" id="completeFear">0</div>
                    <div class="level-stat-label">Fear</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeStamina">20</div>
                    <div class="level-stat-label">Stamina</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeItems">0</div>
                    <div class="level-stat-label">Items</div>
                </div>
                <div class="level-stat">
                    <div class="level-stat-value" id="completeGold">0</div>
                    <div class="level-stat-label">Gold</div>
                </div>
            </div>
            
            <p>Your progress has been saved. Continue to the next level or stay and explore more.</p>
            
            <div class="level-complete-buttons">
                <button class="level-complete-btn" id="continueExploring">
                    <i class="fas fa-search"></i> Keep Exploring
                </button>
                <button class="level-complete-btn next" id="nextLevelBtn">
                    <i class="fas fa-arrow-right"></i> Next Level
                </button>
            </div>
        </div>
    </div>

<script>
// ============================================
// SOUND MANAGER
// ============================================

class SoundManager {
    constructor() {
        this.sounds = {};
        this.enabled = true;
        this.context = null;
        this.initialized = false;
        this.masterVolume = 0.7;
        
        // Sound definitions
        this.soundDefs = {
            'click': { type: 'synth', frequency: 800, duration: 0.1, volume: 0.3 },
            'hover': { type: 'synth', frequency: 600, duration: 0.05, volume: 0.2 },
            'combat_attack': { type: 'synth', frequency: 1200, duration: 0.2, volume: 0.5 },
            'combat_hit': { type: 'synth', frequency: 300, duration: 0.1, volume: 0.6 },
            'combat_miss': { type: 'synth', frequency: 200, duration: 0.1, volume: 0.4 },
            'combat_critical': { type: 'synth', frequency: 1500, duration: 0.3, volume: 0.7 },
            'item_pickup': { type: 'synth', frequency: 1000, duration: 0.2, volume: 0.4 },
            'item_use': { type: 'synth', frequency: 1200, duration: 0.3, volume: 0.5 },
            'heal': { type: 'synth', frequency: 800, duration: 0.5, volume: 0.5 },
            'damage': { type: 'synth', frequency: 400, duration: 0.2, volume: 0.6 },
            'death': { type: 'synth', frequency: 200, duration: 1.0, volume: 0.8 },
            'victory': { type: 'synth', frequency: 1500, duration: 0.5, volume: 0.6 },
            'fear': { type: 'synth', frequency: 500, duration: 0.3, volume: 0.5 },
            'menu_open': { type: 'synth', frequency: 700, duration: 0.2, volume: 0.4 },
            'menu_close': { type: 'synth', frequency: 600, duration: 0.2, volume: 0.4 },
            'level_complete': { type: 'synth', frequency: 1200, duration: 0.8, volume: 0.7 }
        };
    }
    
    init() {
        if (this.initialized) return;
        
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.context = new AudioContext();
            this.initialized = true;
            console.log("SoundManager initialized");
        } catch (e) {
            console.error("Web Audio API not supported:", e);
            this.enabled = false;
        }
    }
    
    play(soundName) {
        if (!this.enabled || !this.initialized || !this.context) return;
        
        const sound = this.soundDefs[soundName];
        if (!sound) return;
        
        if (sound.type === 'synth') {
            this.playSynth(sound.frequency, sound.duration, sound.volume);
        }
    }
    
    playSynth(frequency, duration, volume = 0.5) {
        const oscillator = this.context.createOscillator();
        const gainNode = this.context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.context.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.value = volume * this.masterVolume;
        
        const now = this.context.currentTime;
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    playAttackSound(damage, isCritical = false) {
        if (isCritical) {
            this.play('combat_critical');
        } else if (damage > 0) {
            this.play('combat_hit');
        } else {
            this.play('combat_miss');
        }
    }
    
    toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
    }
    
    setVolume(volume) {
        this.masterVolume = Math.max(0, Math.min(1, volume));
    }
}

// ============================================
// GAME DATA & MULTI-PAGE SYSTEM
// ============================================

// Game state with level tracking
const gameState = {
    currentLevel: 1,
    currentSection: 1,
    fear: 0,
    stamina: 20,
    skill: 7,
    luck: 12,
    inventory: [],
    equippedWeapon: null,
    gold: 0,
    soundEnabled: true,
    inCombat: false,
    inDialog: false,
    combatData: null,
    npcData: null,
    inventoryOpen: false,
    visitedSections: [],
    levelsCompleted: []
};

// Item database
const items = {
    "Silver Key": {
        name: "Silver Key",
        description: "A finely crafted silver key that might unlock certain doors in the mansion.",
        type: "key",
        weight: 0.1,
        usable: false,
        icon: "fa-key"
    },
    "Crucifix": {
        name: "Crucifix",
        description: "A religious symbol that can ward off evil spirits. Particularly effective against undead.",
        type: "tool",
        weight: 0.5,
        usable: true,
        vsUndeadDamage: 6,
        icon: "fa-cross"
    },
    "Iron Dagger": {
        name: "Iron Dagger",
        description: "A sharp iron dagger for combat. Better than nothing in a fight.",
        type: "weapon",
        weight: 1,
        usable: true,
        damage: 3,
        icon: "fa-dagger"
    },
    "Torch": {
        name: "Torch",
        description: "Provides light in dark places. May reveal hidden passages.",
        type: "tool",
        weight: 1.5,
        usable: true,
        icon: "fa-fire"
    },
    "Butcher's Knife": {
        name: "Butcher's Knife",
        description: "A large, sharp kitchen knife. Deals significant damage but is unwieldy.",
        type: "weapon",
        weight: 1.2,
        usable: true,
        damage: 4,
        icon: "fa-knife-kitchen"
    },
    "Healing Potion": {
        name: "Healing Potion",
        description: "Restores 5 STAMINA when consumed. Has a faint herbal aroma.",
        type: "consumable",
        weight: 0.5,
        usable: true,
        staminaRestore: 5,
        icon: "fa-flask"
    },
    "Lucky Charm": {
        name: "Lucky Charm",
        description: "A small charm that makes you feel luckier. Grants +1 to LUCK tests.",
        type: "trinket",
        weight: 0.2,
        usable: false,
        luckBonus: 1,
        icon: "fa-clover"
    }
};

// Enemy database
const enemies = {
    "Cultist": {
        name: "Cultist",
        skill: 6,
        stamina: 8,
        damage: 2,
        fear: 1,
        gold: 5,
        description: "A robed figure chanting dark rituals.",
        icon: "fa-user-ninja"
    },
    "Ghost": {
        name: "Ghost",
        skill: 7,
        stamina: 10,
        damage: 3,
        fear: 3,
        gold: 0,
        weakTo: "holy",
        description: "A spectral apparition with chilling touch.",
        icon: "fa-ghost"
    },
    "Giant Rat": {
        name: "Giant Rat",
        skill: 5,
        stamina: 6,
        damage: 1,
        fear: 0,
        gold: 2,
        description: "A massive rodent with sharp teeth.",
        icon: "fa-paw"
    },
    "Zombie": {
        name: "Zombie",
        skill: 4,
        stamina: 12,
        damage: 2,
        fear: 2,
        gold: 0,
        description: "A slow-moving but resilient undead creature.",
        icon: "fa-skull"
    }
};

// Story sections for Level 1
const storySections = {
    1: {
        text: "You are lost on a lonely road at night during a violent storm. Your car has broken down. Through the driving rain you see a mansion on a hill. With no other shelter in sight, you decide to seek help at the HOUSE OF HELL. The massive oak door creaks open as you enter the dark hallway...",
        choices: [
            { text: "Go left into the library", next: 2, icon: "fa-arrow-left", sound: "click" },
            { text: "Go right into the dining room", next: 3, icon: "fa-arrow-right", sound: "click" },
            { text: "Go upstairs", next: 4, icon: "fa-arrow-up", sound: "click" }
        ]
    },
    2: {
        text: "The library is filled with ancient books. A fire crackles in the hearth. On a desk, you find a leather-bound journal and a crucifix. The room smells of old paper and dust.",
        choices: [
            { text: "Search the bookshelves", next: 5, icon: "fa-search", sound: "click" },
            { text: "Take the crucifix", action: "addItem", item: "Crucifix", icon: "fa-cross", sound: "item_pickup" },
            { text: "Leave and go to the dining room", next: 3, icon: "fa-arrow-right", sound: "click" }
        ]
    },
    3: {
        text: "The dining room is eerily empty except for a long table set for a macabre feast. The food looks fresh but there's no one here. You notice a silver key on the table.",
        choices: [
            { text: "Take the silver key", action: "addItem", item: "Silver Key", icon: "fa-key", sound: "item_pickup" },
            { text: "Investigate the kitchen", next: 6, icon: "fa-arrow-right", sound: "click" },
            { text: "Return to the hallway", next: 1, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    4: {
        text: "You ascend the grand staircase. The upper hallway is dark and cold. You hear faint whispers from behind a door at the end of the hall. Shadows seem to move at the edge of your vision.",
        choices: [
            { text: "Approach the whispering door", next: 7, icon: "fa-door-open", sound: "click" },
            { text: "Check the other rooms", next: 8, icon: "fa-search", sound: "click" },
            { text: "Go back downstairs", next: 1, icon: "fa-arrow-down", sound: "click" }
        ]
    },
    5: {
        text: "Behind a bookshelf you find a hidden compartment containing an iron dagger and a torch. The dagger looks well-used but sharp.",
        choices: [
            { text: "Take the iron dagger", action: "addItem", item: "Iron Dagger", icon: "fa-dagger", sound: "item_pickup" },
            { text: "Take the torch", action: "addItem", item: "Torch", icon: "fa-fire", sound: "item_pickup" },
            { text: "Take both items", action: "addMultiple", items: ["Iron Dagger", "Torch"], icon: "fa-box-open", sound: "item_pickup" },
            { text: "Return to the library", next: 2, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    6: {
        text: "The kitchen is dark and smells of decay. Strange shadows move in the corners. A large butcher's knife lies on the counter. Suddenly, a giant rat attacks!",
        choices: [
            { text: "Take the butcher's knife", action: "addItem", item: "Butcher's Knife", icon: "fa-knife-kitchen", sound: "item_pickup" },
            { text: "Fight the giant rat", action: "startCombat", enemy: "Giant Rat", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Run back to the dining room", next: 3, icon: "fa-running", sound: "click" }
        ]
    },
    7: {
        text: "You open the door to find a ghostly figure floating in the center of the room! It reaches for you with icy hands. The temperature drops dramatically.",
        choices: [
            { text: "Use crucifix (if you have it)", action: "startCombat", enemy: "Ghost", requireItem: "Crucifix", icon: "fa-cross", sound: "combat_attack" },
            { text: "Fight the ghost", action: "startCombat", enemy: "Ghost", icon: "fa-fist-raised", sound: "combat_attack" },
            { text: "Try to run away", next: 4, effect: { fear: 2, stamina: -2 }, icon: "fa-running", sound: "damage" }
        ]
    },
    8: {
        text: "You check the other rooms and find a bedroom. Under the bed, you discover a healing potion. The room feels strangely peaceful compared to the rest of the house.",
        choices: [
            { text: "Take the healing potion", action: "addItem", item: "Healing Potion", icon: "fa-flask", sound: "item_pickup" },
            { text: "Return to the hallway", next: 4, icon: "fa-arrow-left", sound: "click" }
        ]
    },
    9: {
        text: "You feel a strange energy in the air. The house seems to shift around you. You've explored enough of this floor to sense there's something more to this place. A hidden door creaks open revealing a staircase going down into darkness. This is the end of Level 1.",
        choices: [
            { text: "Continue to Level 2", action: "completeLevel", icon: "fa-arrow-down", sound: "level_complete" },
            { text: "Keep exploring Level 1", next: 1, icon: "fa-search", sound: "click" }
        ]
    }
};

// ============================================
// GAME FUNCTIONS - UPDATED FOR MULTI-PAGE
// ============================================

// DOM elements
const loadingScreen = document.getElementById('loading');
const gameContainer = document.getElementById('gameContainer');
const storyText = document.getElementById('storyText');
const choicesContainer = document.getElementById('choicesContainer');
const fearValue = document.getElementById('fearValue');
const staminaValue = document.getElementById('staminaValue');
const skillValue = document.getElementById('skillValue');
const luckValue = document.getElementById('luckValue');
const inventoryToggle = document.getElementById('inventoryToggle');
const inventoryPanel = document.getElementById('inventoryPanel');
const inventoryContent = document.getElementById('inventoryContent');
const inventoryWeight = document.getElementById('inventoryWeight');
const inventoryGold = document.getElementById('inventoryGold');
const inventoryCount = document.getElementById('inventoryCount');
const inventoryBadge = document.getElementById('inventoryBadge');
const inventoryClose = document.getElementById('inventoryClose');
const combatPanel = document.getElementById('combatPanel');
const playerCombatStamina = document.getElementById('playerCombatStamina');
const playerHealthBar = document.getElementById('playerHealthBar');
const playerHealthText = document.getElementById('playerHealthText');
const enemyCombatName = document.getElementById('enemyCombatName');
const enemyCombatSkill = document.getElementById('enemyCombatSkill');
const enemyCombatStamina = document.getElementById('enemyCombatStamina');
const enemyHealthBar = document.getElementById('enemyHealthBar');
const enemyHealthText = document.getElementById('enemyHealthText');
const combatLog = document.getElementById('combatLog');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');
const notificationClose = document.getElementById('notificationClose');
const levelComplete = document.getElementById('levelComplete');
const pageNav = document.getElementById('pageNav');
const completeFear = document.getElementById('completeFear');
const completeStamina = document.getElementById('completeStamina');
const completeItems = document.getElementById('completeItems');
const completeGold = document.getElementById('completeGold');
const nextLevelBtn = document.getElementById('nextLevelBtn');
const continueExploring = document.getElementById('continueExploring');

// Sound manager instance
const soundManager = new SoundManager();

// Initialize game - UPDATED VERSION
function initGame() {
    console.log("Initializing Level 1...");
    
    // First try to load saved game state
    if (!loadGameState()) {
        // If no save exists, start fresh with default Level 1 state
        gameState.currentLevel = 1;
        gameState.currentSection = 1;
        gameState.fear = 0;
        gameState.stamina = 20;
        gameState.skill = 7;
        gameState.luck = 12;
        gameState.inventory = [];
        gameState.equippedWeapon = null;
        gameState.gold = 0;
        gameState.visitedSections = [];
        gameState.levelsCompleted = [];
        
        // Save initial state
        saveGameState();
    }
    
    // Initialize sound manager on first user interaction
    document.addEventListener('click', () => {
        if (!soundManager.initialized) {
            soundManager.init();
        }
    }, { once: true });
    
    simulateLoading();
    setupEventListeners();
}
// Simulate loading
function simulateLoading() {
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        document.getElementById('loadingProgress').style.width = `${progress}%`;
        
        if (progress <= 30) {
            document.getElementById('loadingStatus').textContent = "Loading story data...";
        } else if (progress <= 60) {
            document.getElementById('loadingStatus').textContent = "Initializing game systems...";
        } else if (progress <= 90) {
            document.getElementById('loadingStatus').textContent = "Preparing adventure...";
        } else {
            document.getElementById('loadingStatus').textContent = "Ready!";
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(startGame, 500);
        }
    }, 50);
}

// Start game
function startGame() {
    loadingScreen.classList.add('hidden');
    gameContainer.classList.remove('hidden');
    loadSection(gameState.currentSection);
    updateInventoryDisplay();
    showNotification(`Welcome to Level ${gameState.currentLevel}`, "Your nightmare continues...", "info");
    soundManager.play('menu_open');
}

// Setup event listeners
function setupEventListeners() {
    // Inventory toggle
    inventoryToggle.addEventListener('click', () => {
        gameState.inventoryOpen = !gameState.inventoryOpen;
        inventoryPanel.classList.toggle('hidden');
        soundManager.play(gameState.inventoryOpen ? 'menu_open' : 'menu_close');
        
        if (gameState.inventoryOpen) {
            updateInventoryDisplay();
        }
    });
    
    inventoryClose.addEventListener('click', () => {
        gameState.inventoryOpen = false;
        inventoryPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Control buttons
    document.getElementById('restartBtn').addEventListener('click', restartGame);
    document.getElementById('saveBtn').addEventListener('click', saveGame);
    document.getElementById('loadBtn').addEventListener('click', loadGame);
    document.getElementById('hintBtn').addEventListener('click', showHint);
    
    // Sound toggle
    document.getElementById('soundToggle').addEventListener('click', () => {
        gameState.soundEnabled = soundManager.toggle();
        const soundToggle = document.getElementById('soundToggle');
        soundToggle.textContent = gameState.soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
        soundToggle.title = gameState.soundEnabled ? "Sound On" : "Sound Off";
        soundManager.play('click');
    });
    
    // Combat buttons
    document.getElementById('combatAttack').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('combat_attack');
            performAttack();
        }
    });
    
    document.getElementById('combatUseItem').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            showCombatItems();
        }
    });
    
    document.getElementById('combatLuck').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            testLuckInCombat();
        }
    });
    
    document.getElementById('combatFlee').addEventListener('click', () => {
        if (gameState.inCombat) {
            soundManager.play('click');
            tryFlee();
        }
    });
    
    // Notification close
    notificationClose.addEventListener('click', () => {
        notification.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Organize inventory button
    document.getElementById('organizeInventory').addEventListener('click', () => {
        organizeInventory();
        soundManager.play('click');
    });
    
    // Page navigation
    pageNav.addEventListener('click', () => {
        showLevelSelector();
        soundManager.play('menu_open');
    });
    
    // Level complete buttons
    nextLevelBtn.addEventListener('click', goToNextLevel);
    continueExploring.addEventListener('click', () => {
        levelComplete.classList.add('hidden');
        soundManager.play('menu_close');
    });
    
    // Add hover sounds to all buttons
    document.addEventListener('mouseover', (e) => {
        if (e.target.tagName === 'BUTTON' && !e.target.disabled && gameState.soundEnabled) {
            soundManager.play('hover');
        }
    }, true);
}

// ============================================
// MULTI-PAGE SYSTEM FUNCTIONS
// ============================================

// Save game state to localStorage - ENSURE THIS WORKS
function saveGameState() {
    try {
        const saveData = {
            currentLevel: gameState.currentLevel,
            currentSection: gameState.currentSection,
            fear: gameState.fear,
            stamina: gameState.stamina,
            skill: gameState.skill,
            luck: gameState.luck,
            inventory: gameState.inventory,
            equippedWeapon: gameState.equippedWeapon,
            gold: gameState.gold,
            soundEnabled: gameState.soundEnabled,
            visitedSections: gameState.visitedSections,
            levelsCompleted: gameState.levelsCompleted
        };
        
        localStorage.setItem('houseOfHellSave', JSON.stringify(saveData));
        console.log("Game state saved to localStorage for Level", gameState.currentLevel);
        return true;
    } catch (e) {
        console.error("Failed to save game state:", e);
        showNotification("Save Error", "Could not save game progress", "info");
        return false;
    }
}

// Load game state from localStorage - FIXED VERSION
function loadGameState() {
    try {
        const saved = localStorage.getItem('houseOfHellSave');
        if (saved) {
            const saveData = JSON.parse(saved);
            
            // REMOVE the level check - always load saved state
            Object.assign(gameState, saveData);
            
            // Ensure we're on the right level for this page
            gameState.currentLevel = 1;
            
            console.log("Game state loaded from localStorage");
            return true;
        }
    } catch (e) {
        console.error("Failed to load game state:", e);
    }
    return false;
}

// Complete current level
function completeLevel() {
    soundManager.play('level_complete');
    
    // Add this level to completed levels if not already
    if (!gameState.levelsCompleted.includes(gameState.currentLevel)) {
        gameState.levelsCompleted.push(gameState.currentLevel);
    }
    
    // Save game state
    saveGameState();
    
    // Update level complete screen stats
    completeFear.textContent = gameState.fear;
    completeStamina.textContent = gameState.stamina;
    completeItems.textContent = gameState.inventory.reduce((total, item) => total + (item.quantity || 1), 0);
    completeGold.textContent = gameState.gold;
    
    // Show level complete screen
    levelComplete.classList.remove('hidden');
}

// Go to next level - UPDATED VERSION
function goToNextLevel() {
    const nextLevel = gameState.currentLevel + 1;
    
    // Make sure Level 1 is marked as completed
    if (!gameState.levelsCompleted.includes(1)) {
        gameState.levelsCompleted.push(1);
    }
    
    // Save current state before navigating
    saveGameState();
    
    // Navigate to next level page
    soundManager.play('menu_open');
    showNotification("Progress Saved", `Moving to Level ${nextLevel}...`, "info");
    
    setTimeout(() => {
        window.location.href = `level${nextLevel}.html`;
    }, 1000);
}

// Show level selector - IMPROVED VERSION
function showLevelSelector() {
    const dialogTitle = document.getElementById('dialogTitle');
    const dialogText = document.getElementById('dialogText');
    const dialogOptions = document.getElementById('dialogOptions');
    const dialogPanel = document.getElementById('dialogPanel');
    
    dialogTitle.textContent = "SELECT LEVEL";
    dialogText.textContent = "Choose which level to play. Your current progress will be saved.";
    
    dialogOptions.innerHTML = '';
    
    // Load the latest saved state first to check progress
    const saved = localStorage.getItem('houseOfHellSave');
    let savedLevelsCompleted = [];
    if (saved) {
        try {
            const saveData = JSON.parse(saved);
            savedLevelsCompleted = saveData.levelsCompleted || [];
        } catch (e) {
            console.error("Error reading save data:", e);
        }
    }
    
    // Create level buttons (for up to 4 levels)
    for (let i = 1; i <= 4; i++) {
        const levelBtn = document.createElement('button');
        levelBtn.className = 'dialog-option';
        
        // Check if level is unlocked
        const isUnlocked = i === 1 || savedLevelsCompleted.includes(i-1);
        
        if (isUnlocked) {
            levelBtn.innerHTML = `<i class="fas fa-map"></i> Level ${i} ${savedLevelsCompleted.includes(i) ? '(Completed)' : ''}`;
            levelBtn.disabled = false;
        } else {
            levelBtn.innerHTML = `<i class="fas fa-map"></i> Level ${i} (Locked)`;
            levelBtn.disabled = true;
            levelBtn.title = "Complete previous level first";
        }
        
        if (!levelBtn.disabled) {
            levelBtn.addEventListener('click', () => {
                soundManager.play('click');
                if (i !== 1) { // If not current level
                    // Save current game state
                    saveGameState();
                    
                    // Navigate to selected level
                    setTimeout(() => {
                        window.location.href = `level${i}.html`;
                    }, 300);
                } else {
                    // If clicking current level, just close dialog
                    showNotification("Already Here", "You are already on Level 1", "info");
                }
                dialogPanel.classList.add('hidden');
            });
        }
        
        dialogOptions.appendChild(levelBtn);
    }
    
    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'dialog-option';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
    cancelBtn.addEventListener('click', () => {
        dialogPanel.classList.add('hidden');
        soundManager.play('menu_close');
    });
    dialogOptions.appendChild(cancelBtn);
    
    dialogPanel.classList.remove('hidden');
}

// ============================================
// GAME CORE FUNCTIONS
// ============================================

// Show notification
function showNotification(title, message, type = "info") {
    notificationText.innerHTML = `<strong>${title}</strong><br>${message}`;
    notification.classList.remove('hidden');
    
    // Play appropriate sound
    if (gameState.soundEnabled) {
        if (type === "item") soundManager.play('item_pickup');
        else if (type === "heal") soundManager.play('heal');
        else if (type === "damage") soundManager.play('damage');
        else if (type === "fear") soundManager.play('fear');
        else if (type === "death") soundManager.play('death');
        else if (type === "victory") soundManager.play('victory');
        else if (type === "level_complete") soundManager.play('level_complete');
        else soundManager.play('click');
    }
    
    setTimeout(() => {
        if (!notification.classList.contains('hidden')) {
            notification.classList.add('hidden');
        }
    }, 3000);
}

// Add item to inventory
function addItem(itemName) {
    const item = items[itemName];
    if (!item) {
        console.error("Item not found:", itemName);
        return false;
    }
    
    // Check weight limit
    const currentWeight = gameState.inventory.reduce((sum, invItem) => {
        const itemData = items[invItem.name];
        return sum + (itemData?.weight || 0) * (invItem.quantity || 1);
    }, 0);
    
    if (currentWeight + item.weight > 10) {
        showNotification("Inventory Full", `Cannot carry ${itemName}. Too heavy!`, "info");
        return false;
    }
    
    // Add item
    const existingItem = gameState.inventory.find(invItem => invItem.name === itemName);
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        gameState.inventory.push({
            name: itemName,
            quantity: 1,
            equipped: false
        });
    }
    
    updateInventoryDisplay();
    showNotification("Item Found", `You found: ${itemName}`, "item");
    
    // Auto-save after getting item
    saveGameState();
    
    return true;
}

// Update inventory display
function updateInventoryDisplay() {
    inventoryContent.innerHTML = '';
    
    if (gameState.inventory.length === 0) {
        inventoryContent.innerHTML = `
            <div class="inventory-empty">
                <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px; color: #666;"></i>
                <div>Your inventory is empty</div>
                <div style="font-size: 0.9rem; margin-top: 10px;">Explore the mansion to find items!</div>
            </div>
        `;
    } else {
        const grid = document.createElement('div');
        grid.className = 'inventory-grid';
        
        let totalWeight = 0;
        let totalItems = 0;
        
        // Sort items by type and name
        const sortedInventory = [...gameState.inventory].sort((a, b) => {
            const itemA = items[a.name];
            const itemB = items[b.name];
            
            // Weapons first, then tools, then consumables, then keys
            const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
            const orderA = typeOrder[itemA.type] || 5;
            const orderB = typeOrder[itemB.type] || 5;
            
            if (orderA !== orderB) return orderA - orderB;
            return a.name.localeCompare(b.name);
        });
        
        sortedInventory.forEach(invItem => {
            const item = items[invItem.name];
            if (!item) return;
            
            totalWeight += item.weight * (invItem.quantity || 1);
            totalItems += invItem.quantity || 1;
            
            const itemCard = document.createElement('div');
            itemCard.className = 'inventory-item-card';
            if (invItem.equipped) {
                itemCard.classList.add('item-equipped');
            }
            
            itemCard.innerHTML = `
                <div class="item-icon">
                    <i class="fas ${item.icon}"></i>
                </div>
                <div class="item-name">${invItem.name}</div>
                <div class="item-type">${item.type.toUpperCase()}</div>
                ${(invItem.quantity || 1) > 1 ? `<div class="item-quantity">${invItem.quantity}</div>` : ''}
                <div class="item-tooltip">${item.description}</div>
            `;
            
            // Add click handler
            itemCard.addEventListener('click', () => showItemDetails(invItem.name));
            
            grid.appendChild(itemCard);
        });
        
        inventoryContent.appendChild(grid);
        
        // Add item details section
        const detailsSection = document.createElement('div');
        detailsSection.className = 'item-details';
        detailsSection.id = 'itemDetails';
        detailsSection.innerHTML = `
            <div style="color: #999; text-align: center;">Click on an item for details</div>
        `;
        inventoryContent.appendChild(detailsSection);
    }
    
    // Update inventory stats
    inventoryWeight.textContent = `Weight: ${totalWeight.toFixed(1)}/10`;
    inventoryGold.textContent = `Gold: ${gameState.gold}`;
    inventoryCount.textContent = `Items: ${totalItems}`;
    
    // Update inventory badge
    inventoryBadge.textContent = totalItems;
    inventoryBadge.style.display = totalItems > 0 ? 'flex' : 'none';
}

// Show item details
function showItemDetails(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    const invItem = gameState.inventory.find(i => i.name === itemName);
    if (!invItem) return;
    
    const detailsSection = document.getElementById('itemDetails');
    detailsSection.innerHTML = `
        <div style="color: #ff0; font-size: 1.2rem; margin-bottom: 10px;">
            <i class="fas ${item.icon}"></i> ${itemName}
        </div>
        <div class="item-description">${item.description}</div>
        <div style="margin-top: 10px; color: #ccc;">
            <div>Type: ${item.type.toUpperCase()}</div>
            <div>Weight: ${item.weight}</div>
            ${item.damage ? `<div>Damage: ${item.damage}</div>` : ''}
            ${item.staminaRestore ? `<div>Heals: ${item.staminaRestore} STAMINA</div>` : ''}
        </div>
        <div class="item-actions">
            ${item.usable ? `<button class="item-action-btn" onclick="useItem('${itemName}')">Use</button>` : ''}
            ${item.type === 'weapon' ? `<button class="item-action-btn" onclick="equipItem('${itemName}')">${invItem.equipped ? 'Unequip' : 'Equip'}</button>` : ''}
            <button class="item-action-btn" onclick="dropItem('${itemName}')">Drop</button>
        </div>
    `;
    
    soundManager.play('click');
}

// Use item
function useItem(itemName) {
    const item = items[itemName];
    if (!item) return;
    
    if (itemName === "Healing Potion") {
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        removeItem(itemName);
        updateStats();
        showNotification("Healing Potion", "You restore 5 STAMINA", "heal");
        soundManager.play('heal');
        saveGameState(); // Auto-save after using item
    } else {
        showNotification(itemName, item.description, "info");
    }
    
    updateInventoryDisplay();
}

// Equip item
function equipItem(itemName) {
    if (items[itemName].type !== 'weapon') return;
    
    // Unequip current weapon
    gameState.inventory.forEach(invItem => {
        if (invItem.equipped) invItem.equipped = false;
    });
    
    // Equip new weapon
    const invItem = gameState.inventory.find(i => i.name === itemName);
    invItem.equipped = !invItem.equipped;
    
    if (invItem.equipped) {
        showNotification("Item Equipped", `${itemName} is now equipped`, "info");
        gameState.equippedWeapon = itemName;
    } else {
        showNotification("Item Unequipped", `${itemName} is no longer equipped`, "info");
        gameState.equippedWeapon = null;
    }
    
    updateInventoryDisplay();
    soundManager.play('item_use');
    saveGameState(); // Auto-save after equipping
}

// Drop item
function dropItem(itemName) {
    if (confirm(`Are you sure you want to drop ${itemName}?`)) {
        removeItem(itemName);
        showNotification("Item Dropped", `You dropped ${itemName}`, "info");
        updateInventoryDisplay();
        soundManager.play('click');
        saveGameState(); // Auto-save after dropping
    }
}

// Organize inventory
function organizeInventory() {
    // Sort inventory alphabetically
    gameState.inventory.sort((a, b) => a.name.localeCompare(b.name));
    
    // Group by type
    const typeOrder = { weapon: 0, tool: 1, consumable: 2, key: 3, trinket: 4 };
    gameState.inventory.sort((a, b) => {
        const itemA = items[a.name];
        const itemB = items[b.name];
        const orderA = typeOrder[itemA.type] || 5;
        const orderB = typeOrder[itemB.type] || 5;
        return orderA - orderB;
    });
    
    updateInventoryDisplay();
    showNotification("Inventory Organized", "Items have been sorted by type and name", "info");
}

// Remove item
function removeItem(itemName) {
    const index = gameState.inventory.findIndex(item => item.name === itemName);
    if (index !== -1) {
        if (gameState.inventory[index].quantity > 1) {
            gameState.inventory[index].quantity--;
        } else {
            // If unequipping weapon, clear equipped weapon
            if (gameState.inventory[index].equipped) {
                gameState.equippedWeapon = null;
            }
            gameState.inventory.splice(index, 1);
        }
        return true;
    }
    return false;
}

// Update stats display
function updateStats() {
    fearValue.textContent = gameState.fear;
    staminaValue.textContent = gameState.stamina;
    skillValue.textContent = gameState.skill;
    luckValue.textContent = gameState.luck;
    
    // Color coding
    fearValue.style.color = gameState.fear > 15 ? '#ff3030' : 
                           gameState.fear > 10 ? '#ff8000' : '#ff0';
    
    staminaValue.style.color = gameState.stamina > 15 ? '#0f0' : 
                              gameState.stamina > 10 ? '#ff0' : 
                              gameState.stamina > 5 ? '#ff8000' : '#ff3030';
}

// Apply effect
function applyEffect(effect) {
    if (effect.fear) {
        gameState.fear = Math.max(0, Math.min(20, gameState.fear + effect.fear));
        if (effect.fear > 0) {
            showNotification("Fear", `Your fear increases by ${effect.fear}`, "fear");
            soundManager.play('fear');
        }
    }
    
    if (effect.stamina) {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.max(0, Math.min(20, gameState.stamina + effect.stamina));
        const change = gameState.stamina - oldStamina;
        
        if (change < 0) {
            showNotification("Damage", `You lose ${-change} STAMINA`, "damage");
            soundManager.play('damage');
        } else if (change > 0) {
            showNotification("Healed", `You restore ${change} STAMINA`, "heal");
            soundManager.play('heal');
        }
    }
    
    updateStats();
    
    // Check for death
    if (gameState.stamina <= 0) {
        showNotification("Game Over", "You have died!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">YOU HAVE DIED<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    if (gameState.fear >= 20) {
        showNotification("Game Over", "Driven mad by fear!", "death");
        soundManager.play('death');
        setTimeout(() => {
            storyText.innerHTML += '<div class="death-message">DRIVEN MAD BY FEAR<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1000);
        return true;
    }
    
    return false;
}

// Load section
function loadSection(sectionId) {
    if (gameState.inCombat || gameState.inDialog) return;
    
    gameState.currentSection = sectionId;
    const section = storySections[sectionId];
    
    if (!section) {
        storyText.innerHTML = "<p>End of the adventure... for now.</p>";
        choicesContainer.innerHTML = "";
        return;
    }
    
    // Apply section effect if any
    if (section.effect) {
        if (applyEffect(section.effect)) return; // Return if player died
    }
    
    // Display story text
    storyText.innerHTML = `<p>${section.text}</p>`;
    storyText.scrollTop = 0;
    
    // Clear and create choices
    choicesContainer.innerHTML = "";
    
    section.choices.forEach(choice => {
        const button = document.createElement('button');
        button.className = 'choice-btn';
        
        // Check requirements
        let disabled = false;
        if (choice.requireItem) {
            const hasItem = gameState.inventory.some(item => item.name === choice.requireItem);
            if (!hasItem) {
                disabled = true;
                button.title = `Requires: ${choice.requireItem}`;
            }
        }
        
        button.disabled = disabled;
        button.innerHTML = `<i class="fas ${choice.icon}"></i> ${choice.text}`;
        
        if (!disabled) {
            button.addEventListener('click', () => {
                if (choice.sound && gameState.soundEnabled) {
                    soundManager.play(choice.sound);
                }
                handleChoice(choice);
            });
        }
        
        choicesContainer.appendChild(button);
    });
    
    // Update stats
    updateStats();
    
    // Mark as visited
    if (!gameState.visitedSections.includes(sectionId)) {
        gameState.visitedSections.push(sectionId);
    }
}

// Handle choice
function handleChoice(choice) {
    console.log("Handling choice:", choice);
    
    if (choice.action === "addItem") {
        if (addItem(choice.item)) {
            // Stay in current section after taking item
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "addMultiple") {
        if (addMultipleItems(choice.items)) {
            loadSection(gameState.currentSection);
        }
    } else if (choice.action === "startCombat") {
        startCombat(choice.enemy);
    } else if (choice.action === "completeLevel") {
        completeLevel();
    } else if (choice.next) {
        if (choice.effect) {
            applyEffect(choice.effect);
        }
        loadSection(choice.next);
    }
}

// Add multiple items
function addMultipleItems(itemNames) {
    itemNames.forEach(itemName => addItem(itemName));
    showNotification("Items Found", `You found: ${itemNames.join(", ")}`, "item");
}

// Start combat
function startCombat(enemyName) {
    const enemy = enemies[enemyName];
    if (!enemy) return;
    
    gameState.inCombat = true;
    gameState.combatData = {
        enemy: enemy,
        enemyStamina: enemy.stamina,
        enemyMaxStamina: enemy.stamina,
        round: 1,
        playerMaxStamina: gameState.stamina
    };
    
    // Update UI
    enemyCombatName.textContent = enemy.name;
    enemyCombatSkill.textContent = enemy.skill;
    enemyCombatStamina.textContent = enemy.stamina;
    enemyHealthText.textContent = `${enemy.stamina}/${enemy.stamina}`;
    
    playerCombatStamina.textContent = gameState.stamina;
    playerHealthText.textContent = `${gameState.stamina}/20`;
    
    // Update health bars
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    combatLog.innerHTML = '';
    addCombatLog(`A ${enemy.name} attacks!`, "event");
    
    // Show combat panel
    combatPanel.classList.remove('hidden');
    soundManager.play('combat_attack');
}

// Perform attack
function performAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Player attacks
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    
    let damage = 0;
    let isCritical = false;
    
    if (playerRoll > enemyRoll) {
        // Player hits
        damage = 2; // Base damage
        
        // Add weapon damage if equipped
        if (gameState.equippedWeapon) {
            const weapon = items[gameState.equippedWeapon];
            damage = weapon.damage;
        }
        
        // Bonus for holy weapons vs undead
        if (enemy.weakTo === "holy" && gameState.equippedWeapon === "Crucifix") {
            damage = items["Crucifix"].vsUndeadDamage;
            addCombatLog("The crucifix glows with holy power!", "player");
        }
        
        // Critical hit chance (roll of 12)
        const attackRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
        if (attackRoll === 12) {
            damage *= 2;
            isCritical = true;
            addCombatLog("CRITICAL HIT!", "player");
        }
        
        gameState.combatData.enemyStamina -= damage;
        addCombatLog(`You hit the ${enemy.name} for ${damage} damage!`, "player");
        
        // Show damage number
        showDamageNumber(enemy.name, damage, false);
        
    } else if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else {
        // Tie
        addCombatLog("Your attacks clash with no effect!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, isCritical);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    if (!checkCombatEnd()) {
        // Enemy attacks next round if combat continues
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 1000);
    }
}

// Enemy attack
function enemyAttack() {
    if (!gameState.inCombat || !gameState.combatData) return;
    
    const enemy = gameState.combatData.enemy;
    const playerSkill = gameState.skill;
    
    // Enemy attacks
    const enemyRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + enemy.skill;
    const playerRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2 + playerSkill;
    
    let damage = 0;
    
    if (enemyRoll > playerRoll) {
        // Enemy hits
        damage = enemy.damage;
        gameState.stamina -= damage;
        addCombatLog(`The ${enemy.name} hits you for ${damage} damage!`, "enemy");
        
        // Show damage number
        showDamageNumber("YOU", damage, true);
        
        // Add fear
        if (enemy.fear > 0) {
            gameState.fear += enemy.fear;
            addCombatLog(`The ${enemy.name} terrifies you! (+${enemy.fear} fear)`, "enemy");
        }
    } else if (playerRoll > enemyRoll) {
        // Player parries
        addCombatLog(`You parry the ${enemy.name}'s attack!`, "player");
    } else {
        // Tie
        addCombatLog("You both hesitate, waiting for an opening!", "event");
    }
    
    // Play attack sound
    soundManager.playAttackSound(damage, false);
    
    // Update UI
    updateCombatUI();
    
    // Check combat end
    checkCombatEnd();
}

// Update combat UI
function updateCombatUI() {
    playerCombatStamina.textContent = gameState.stamina;
    enemyCombatStamina.textContent = gameState.combatData.enemyStamina;
    
    const playerHealthPercent = (gameState.stamina / 20) * 100;
    const enemyHealthPercent = (gameState.combatData.enemyStamina / gameState.combatData.enemyMaxStamina) * 100;
    
    playerHealthBar.style.width = `${playerHealthPercent}%`;
    enemyHealthBar.style.width = `${enemyHealthPercent}%`;
    
    playerHealthText.textContent = `${gameState.stamina}/20`;
    enemyHealthText.textContent = `${gameState.combatData.enemyStamina}/${gameState.combatData.enemyMaxStamina}`;
    
    updateStats();
}

// Show damage number
function showDamageNumber(target, damage, isPlayer) {
    const damageNumber = document.createElement('div');
    damageNumber.className = `damage-number ${isPlayer ? 'player' : 'enemy'}`;
    damageNumber.textContent = `-${damage}`;
    damageNumber.style.left = `${50 + (Math.random() * 20 - 10)}%`;
    damageNumber.style.top = `${30 + (Math.random() * 20)}%`;
    
    document.body.appendChild(damageNumber);
    
    setTimeout(() => {
        damageNumber.remove();
    }, 1000);
}

// Add combat log entry
function addCombatLog(message, type) {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}-log`;
    entry.textContent = `[Round ${gameState.combatData.round}] ${message}`;
    combatLog.appendChild(entry);
    combatLog.scrollTop = combatLog.scrollHeight;
    gameState.combatData.round++;
}

// Show combat items
function showCombatItems() {
    const itemsSection = document.createElement('div');
    itemsSection.innerHTML = `
        <div style="color: #ff0; margin-bottom: 10px;">Select an item to use:</div>
    `;
    
    const combatItems = gameState.inventory.filter(invItem => {
        const item = items[invItem.name];
        return item && (item.name === "Healing Potion" || item.name === "Crucifix");
    });
    
    if (combatItems.length === 0) {
        itemsSection.innerHTML += `
            <div style="color: #666; padding: 10px; text-align: center;">
                No usable items in combat
            </div>
        `;
    } else {
        combatItems.forEach(invItem => {
            const button = document.createElement('button');
            button.className = 'combat-btn';
            button.style.margin = '5px';
            button.textContent = `${invItem.name} (${invItem.quantity})`;
            button.addEventListener('click', () => useItemInCombat(invItem.name));
            itemsSection.appendChild(button);
        });
    }
    
    const backButton = document.createElement('button');
    backButton.className = 'combat-btn';
    backButton.style.margin = '5px';
    backButton.textContent = 'Back';
    backButton.addEventListener('click', () => {
        combatLog.innerHTML = '';
        addCombatLog("You prepare your next move...", "event");
    });
    itemsSection.appendChild(backButton);
    
    combatLog.innerHTML = '';
    combatLog.appendChild(itemsSection);
}

// Use item in combat
function useItemInCombat(itemName) {
    if (itemName === "Healing Potion") {
        const oldStamina = gameState.stamina;
        gameState.stamina = Math.min(20, gameState.stamina + 5);
        const healed = gameState.stamina - oldStamina;
        
        removeItem(itemName);
        addCombatLog(`You drink a healing potion! (+${healed} stamina)`, "player");
        soundManager.play('heal');
        
        // Enemy attacks while you use item
        setTimeout(() => {
            if (gameState.inCombat) {
                addCombatLog("The enemy attacks while you're distracted!", "event");
                enemyAttack();
            }
        }, 500);
        
    } else if (itemName === "Crucifix") {
        const enemy = gameState.combatData.enemy;
        if (enemy.weakTo === "holy") {
            gameState.combatData.enemyStamina -= 4;
            addCombatLog("The crucifix glows with holy power! The enemy recoils in pain! (-4 damage)", "player");
            showDamageNumber(enemy.name, 4, false);
            soundManager.play('combat_hit');
            
            // Enemy attacks
            setTimeout(() => {
                if (gameState.inCombat) {
                    enemyAttack();
                }
            }, 500);
        } else {
            addCombatLog("The crucifix has no effect on this enemy.", "event");
            soundManager.play('combat_miss');
        }
    }
    
    updateCombatUI();
    checkCombatEnd();
}

// Test luck in combat
function testLuckInCombat() {
    if (gameState.luck <= 0) {
        addCombatLog("You have no luck left to test!", "event");
        return;
    }
    
    gameState.luck--;
    updateStats();
    
    const luckRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
    const success = luckRoll <= gameState.luck + 1;
    
    if (success) {
        addCombatLog("You feel lucky! The enemy hesitates.", "player");
        // Skip enemy's next attack
    } else {
        addCombatLog("Your luck fails you! The enemy presses the attack.", "enemy");
        // Enemy gets a free attack
        setTimeout(() => {
            if (gameState.inCombat) {
                enemyAttack();
            }
        }, 500);
    }
    
    soundManager.play(success ? 'combat_critical' : 'combat_miss');
}

// Try to flee
function tryFlee() {
    const fleeChance = 0.4 + (gameState.luck / 20);
    if (Math.random() < fleeChance) {
        addCombatLog("You successfully flee from combat!", "player");
        endCombat(false);
        soundManager.play('victory');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
        }, 1000);
    } else {
        addCombatLog("You fail to escape!", "event");
        enemyAttack();
        updateCombatUI();
        checkCombatEnd();
    }
}

// Check combat end
function checkCombatEnd() {
    if (gameState.stamina <= 0) {
        addCombatLog("You have been defeated!", "event");
        endCombat(false);
        soundManager.play('death');
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            storyText.innerHTML += '<div class="death-message">DEFEATED IN COMBAT<br>GAME OVER</div>';
            choicesContainer.innerHTML = '';
        }, 1500);
        return true;
    }
    
    if (gameState.combatData.enemyStamina <= 0) {
        const enemy = gameState.combatData.enemy;
        addCombatLog(`You defeated the ${enemy.name}!`, "event");
        
        // Add gold
        if (enemy.gold > 0) {
            gameState.gold += enemy.gold;
            addCombatLog(`Found ${enemy.gold} gold!`, "event");
        }
        
        endCombat(true);
        soundManager.play('victory');
        
        setTimeout(() => {
            combatPanel.classList.add('hidden');
            loadSection(gameState.currentSection + 1);
            saveGameState(); // Auto-save after combat
        }, 2000);
        return true;
    }
    
    return false;
}

// End combat
function endCombat(victory) {
    gameState.inCombat = false;
    gameState.combatData = null;
}

// Save game
function saveGame() {
    if (saveGameState()) {
        showNotification("Game Saved", "Progress saved successfully.", "info");
        soundManager.play('click');
    } else {
        showNotification("Save Failed", "Could not save game.", "info");
    }
}

// Load game
function loadGame() {
    if (loadGameState()) {
        loadSection(gameState.currentSection);
        updateInventoryDisplay();
        updateStats();
        showNotification("Game Loaded", "Saved game loaded.", "info");
        soundManager.play('menu_open');
    } else {
        showNotification("No Save", "No saved game found.", "info");
    }
}

// Show hint
function showHint() {
    const hints = [
        "Explore all rooms to find useful items.",
        "Some enemies have weaknesses - use the right items.",
        "Keep your fear under control.",
        "Save your game often.",
        "Combat is risky - sometimes running is better.",
        "Equip weapons for better damage in combat.",
        "Use healing potions when your stamina is low.",
        "Test your luck carefully - it doesn't always regenerate.",
        "Complete the level to unlock the next area."
    ];
    const randomHint = hints[Math.floor(Math.random() * hints.length)];
    showNotification("Hint", randomHint, "info");
}

// Initialize game - UPDATED VERSION
function initGame() {
    console.log("Initializing Level 1...");
    
    // First try to load saved game state
    if (!loadGameState()) {
        // If no save exists, start fresh with default Level 1 state
        gameState.currentLevel = 1;
        gameState.currentSection = 1;
        gameState.fear = 0;
        gameState.stamina = 20;
        gameState.skill = 7;
        gameState.luck = 12;
        gameState.inventory = [];
        gameState.equippedWeapon = null;
        gameState.gold = 0;
        gameState.visitedSections = [];
        gameState.levelsCompleted = [];
        
        // Save initial state
        saveGameState();
    }
    
    // Initialize sound manager on first user interaction
    document.addEventListener('click', () => {
        if (!soundManager.initialized) {
            soundManager.init();
        }
    }, { once: true });
    
    simulateLoading();
    setupEventListeners();
}

// Start the game
window.addEventListener('DOMContentLoaded', initGame);

// Auto-save when leaving the page
window.addEventListener('beforeunload', () => {
    saveGameState();
});
</script>
</body>
</html>
