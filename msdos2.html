<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASTLE.EXE - Castle of the Undead</title>
    <style>
        /* ====== 80s DOS STYLES ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'MS Sans Serif', 'Terminal', monospace;
        }

        body {
            background: #000;
            color: #C0C0C0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: #000080;
            border: 3px double #C0C0C0;
            margin: 4px;
        }

        /* ====== HEADER ====== */
        .dos-header {
            border-bottom: 2px solid #C0C0C0;
            padding: 4px 8px;
            margin-bottom: 8px;
            background: #0000AA;
            color: #FFFF55;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .header-subtitle {
            font-size: 12px;
            color: #C0C0C0;
        }

        .header-time {
            font-size: 12px;
            color: #55FF55;
        }

        /* ====== MAIN CONTAINER ====== */
        .dos-container {
            display: flex;
            flex: 1;
            gap: 8px;
            min-height: 0;
        }

        /* ====== GAME OUTPUT WINDOW ====== */
        .game-output {
            flex: 3;
            background: #000;
            border: 2px solid #C0C0C0;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            max-height: 50vh;
        }

        .output-header {
            background: #0000AA;
            color: #FFFF55;
            padding: 2px 4px;
            margin: -8px -8px 8px -8px;
            border-bottom: 1px solid #C0C0C0;
            font-size: 14px;
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.4;
            font-size: 14px;
        }

        /* ====== STATUS PANEL ====== */
        .status-panel {
            flex: 1;
            background: #000;
            border: 2px solid #C0C0C0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
        }

        .status-header {
            background: #0000AA;
            color: #FFFF55;
            padding: 2px 4px;
            margin: -8px -8px 8px -8px;
            border-bottom: 1px solid #C0C0C0;
            font-size: 14px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            border-bottom: 1px dotted #555;
            padding-bottom: 2px;
        }

        .stat-label {
            color: #55FF55;
        }

        .stat-value {
            color: #FFFF55;
            font-weight: bold;
        }

        .health-bar, .mana-bar {
            height: 12px;
            background: #550000;
            border: 1px inset #C0C0C0;
            margin-top: 2px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: #FF0000;
            width: 100%;
        }

        .mana-fill {
            height: 100%;
            background: #0000FF;
            width: 50%;
        }

        /* ====== GAME CONTROLS ====== */
        .game-controls {
            margin-top: 8px;
            border-top: 2px solid #C0C0C0;
            padding-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 40vh;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            flex: 2;
        }

        /* ====== DOS BUTTONS ====== */
        .dos-btn {
            background: #C0C0C0;
            border: 2px outset #C0C0C0;
            color: #000;
            padding: 6px 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            font-weight: bold;
        }

        .dos-btn:active {
            border: 2px inset #C0C0C0;
        }

        .dos-btn:hover {
            background: #D0D0D0;
        }

        .dos-btn:disabled {
            color: #808080;
            cursor: not-allowed;
            background: #A0A0A0;
        }

        .btn-move {
            background: #0000AA;
            color: #FFFFFF;
            border-color: #0000FF;
        }

        .btn-action {
            background: #00AA00;
            color: #FFFFFF;
            border-color: #00FF00;
        }

        .btn-combat {
            background: #AA0000;
            color: #FFFFFF;
            border-color: #FF0000;
        }

        .btn-magic {
            background: #AA00AA;
            color: #FFFFFF;
            border-color: #FF00FF;
        }

        /* ====== INVENTORY & OBJECTS ====== */
        .inventory-window {
            background: #000;
            border: 2px inset #C0C0C0;
            padding: 6px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            border-bottom: 1px dotted #555;
        }

        .object-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .object-btn {
            background: #005500;
            color: #55FF55;
            border: 1px outset #00AA00;
            padding: 3px 6px;
            font-size: 11px;
            cursor: pointer;
        }

        /* ====== SPECIAL INTERFACES ====== */
        .combat-interface, .dialogue-box, .shop-interface, .spell-interface {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 4px double #C0C0C0;
            padding: 16px;
            z-index: 1000;
            min-width: 400px;
            display: none;
        }

        .interface-header {
            background: #AA0000;
            color: #FFFF55;
            padding: 4px;
            margin: -16px -16px 16px -16px;
            text-align: center;
            font-weight: bold;
        }

        .dialogue-header {
            background: #0000AA;
        }

        .shop-header {
            background: #AA5500;
        }

        .spell-header {
            background: #AA00AA;
        }

        /* ====== CLASS SELECTION ====== */
        .class-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0000AA;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .class-title {
            color: #FFFF00;
            font-size: 32px;
            text-shadow: 0 0 10px #FF0000;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .class-options {
            display: flex;
            gap: 20px;
        }

        .class-option {
            background: #000;
            border: 4px double #C0C0C0;
            padding: 20px;
            width: 200px;
            cursor: pointer;
            text-align: center;
        }

        .class-option:hover {
            border-color: #FFFF00;
            background: #000055;
        }

        .class-name {
            color: #FF5555;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .class-desc {
            color: #AAAAAA;
            font-size: 12px;
        }

        /* ====== MESSAGE COLORS ====== */
        .msg-system { color: #C0C0C0; }
        .msg-combat { color: #FF5555; }
        .msg-loot { color: #FFFF55; }
        .msg-npc { color: #55FFFF; }
        .msg-quest { color: #55FF55; }
        .msg-danger { color: #FF0000; font-weight: bold; }
        .msg-success { color: #00FF00; }
        .msg-magic { color: #FF55FF; }
        .msg-explore { color: #AAAAAA; }

        /* ====== SCROLLBAR ====== */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
            border: 1px inset #C0C0C0;
        }

        ::-webkit-scrollbar-thumb {
            background: #555555;
            border: 1px outset #555555;
        }

        /* ====== PROMPT ====== */
        .prompt {
            color: #FFFF00;
            font-weight: bold;
            margin-top: 4px;
        }

        .prompt::after {
            content: "_";
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Class Selection Screen -->
    <div id="classSelection" class="class-selection">
        <div class="class-title">CASTLE OF THE UNDEAD</div>
        <div class="class-options">
            <div class="class-option" onclick="startGame('gravekeeper')">
                <div class="class-name">GRAVEKEEPER</div>
                <div class="class-desc">Master of burial rites<br>Can turn undead<br>+20 Health</div>
            </div>
            <div class="class-option" onclick="startGame('bloodmage')">
                <div class="class-name">BLOOD MAGE</div>
                <div class="class-desc">Uses life force for magic<br>Can drain enemies<br>+30 Mana</div>
            </div>
            <div class="class-option" onclick="startGame('exorcist')">
                <div class="class-name">EXORCIST</div>
                <div class="class-desc">Wields holy power<br>Strong vs spirits<br>+5 Damage vs undead</div>
            </div>
        </div>
        <div style="color: #5555FF; text-align: center; max-width: 600px; margin-top: 20px;">
            > The Castle of the Undead awaits... Choose your path.<br>
            > [Use mouse or arrow keys + ENTER to select]
        </div>
    </div>

    <!-- Main Game Interface -->
    <div id="gameInterface" style="display: none; flex: 1; flex-direction: column;">
        <!-- DOS Header -->
        <div class="dos-header">
            <div class="header-title">CASTLE.EXE</div>
            <div class="header-subtitle">Necropolis Edition v2.0</div>
            <div class="header-time" id="gameTime">23:59:45</div>
        </div>

        <!-- Main Content Area -->
        <div class="dos-container">
            <!-- Game Output Window -->
            <div class="game-output">
                <div class="output-header">> GAME OUTPUT</div>
                <div id="outputWindow" class="output-content">
                    <div class="msg-system">> CASTLE OF THE UNDEAD initialized...</div>
                    <div class="msg-system">> Booting Necropolis Edition v2.0...</div>
                    <div class="msg-system">> Graphics: CGA compatible</div>
                    <div class="msg-system">> Memory: 640KB OK</div>
                    <div class="msg-system">> Loading game data...</div>
                    <div class="msg-success">> READY</div>
                    <div class="msg-system">> Choose your class to begin.</div>
                </div>
                <div class="prompt" id="gamePrompt">></div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="status-header">> STATUS</div>
                <div class="stat-row">
                    <span class="stat-label">HEALTH:</span>
                    <span id="health" class="stat-value">100/100</span>
                </div>
                <div class="health-bar">
                    <div id="healthBar" class="health-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">MANA:</span>
                    <span id="mana" class="stat-value">50/50</span>
                </div>
                <div class="mana-bar">
                    <div id="manaBar" class="mana-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">GOLD:</span>
                    <span id="gold" class="stat-value">100</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">LEVEL:</span>
                    <span id="level" class="stat-value">1</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">EXP:</span>
                    <span id="exp" class="stat-value">0/100</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">LOCATION:</span>
                    <span id="location" class="stat-value">ENTRANCE</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">WEAPON:</span>
                    <span id="weapon" class="stat-value">DAGGER</span>
                </div>
                
                <div class="stat-row">
                    <span class="stat-label">ARMOR:</span>
                    <span id="armor" class="stat-value">LEATHER</span>
                </div>
            </div>
        </div>

        <!-- Game Controls -->
        <div class="game-controls">
            <!-- Main Action Buttons -->
            <div class="controls-grid">
                <button class="dos-btn btn-move" onclick="move('north')">NORTH</button>
                <button class="dos-btn btn-move" onclick="move('south')">SOUTH</button>
                <button class="dos-btn btn-move" onclick="move('east')">EAST</button>
                <button class="dos-btn btn-move" onclick="move('west')">WEST</button>
                
                <button class="dos-btn btn-action" onclick="look()">LOOK</button>
                <button class="dos-btn btn-action" onclick="search()">SEARCH</button>
                <button class="dos-btn btn-action" onclick="takeAll()">TAKE ALL</button>
                <button class="dos-btn btn-action" onclick="examine()">EXAMINE</button>
                
                <button class="dos-btn btn-combat" onclick="attack()">ATTACK</button>
                <button class="dos-btn btn-magic" onclick="showSpellList()">CAST</button>
                <button class="dos-btn btn-action" onclick="useItem()">USE ITEM</button>
                <button class="dos-btn btn-action" onclick="flee()">FLEE</button>
                
                <button class="dos-btn" onclick="talk()">TALK</button>
                <button class="dos-btn" onclick="showInventory()">INVENTORY</button>
                <button class="dos-btn" onclick="saveGame()">SAVE</button>
                <button class="dos-btn" onclick="loadGame()">LOAD</button>
            </div>

            <!-- Inventory Display -->
            <div style="display: flex; gap: 8px; flex: 1;">
                <div style="flex: 2;">
                    <div style="color: #55FF55; font-size: 12px;">> INVENTORY:</div>
                    <div id="inventoryDisplay" class="inventory-window">
                        <!-- Inventory populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Room Objects -->
                <div style="flex: 3;">
                    <div style="color: #55FF55; font-size: 12px;">> OBJECTS IN ROOM:</div>
                    <div id="roomObjects" class="object-list">
                        <!-- Objects populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Combat Interface -->
    <div id="combatInterface" class="combat-interface">
        <div class="interface-header">> COMBAT MODE</div>
        <div id="enemyDisplay" style="margin-bottom: 16px;">
            <div style="color: #FF5555; font-size: 16px;" id="enemyName">SPECTRAL LIBRARIAN</div>
            <div style="background: #550000; border: 1px inset #C0C0C0; height: 12px; margin: 8px 0;">
                <div id="enemyHealthBar" style="background: #FF0000; height: 100%; width: 100%;"></div>
            </div>
            <div id="enemyStats" style="font-size: 12px; color: #FFAAAA;"></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <button class="dos-btn btn-combat" onclick="playerAttack()">ATTACK</button>
            <button class="dos-btn btn-magic" onclick="showCombatSpells()">CAST SPELL</button>
            <button class="dos-btn btn-action" onclick="showCombatItems()">USE ITEM</button>
            <button class="dos-btn" onclick="playerFlee()">FLEE</button>
        </div>
    </div>

    <!-- Dialogue Interface -->
    <div id="dialogueBox" class="dialogue-box">
        <div class="interface-header dialogue-header">> DIALOGUE</div>
        <div id="npcName" style="color: #55FFFF; margin-bottom: 8px;">GHOSTLY BUTLER</div>
        <div id="dialogueText" style="margin-bottom: 16px;">The master is expecting you... in the crypt.</div>
        <div id="dialogueOptions">
            <!-- Options populated by JavaScript -->
        </div>
    </div>

    <!-- Shop Interface -->
    <div id="shopInterface" class="shop-interface">
        <div class="interface-header shop-header">> SHOP</div>
        <div style="color: #FFFF55; margin-bottom: 8px;">Your Gold: <span id="shopGold">100</span></div>
        <div id="shopItems" style="margin-bottom: 16px;">
            <!-- Shop items populated by JavaScript -->
        </div>
        <button class="dos-btn" onclick="hideShop()">LEAVE SHOP</button>
    </div>

    <!-- Spell Interface -->
    <div id="spellInterface" class="spell-interface">
        <div class="interface-header spell-header">> SPELLBOOK</div>
        <div style="color: #FF55FF; margin-bottom: 8px;">Mana: <span id="spellMana">50/50</span></div>
        <div id="spellList" style="margin-bottom: 16px;">
            <!-- Spells populated by JavaScript -->
        </div>
        <button class="dos-btn" onclick="hideSpells()">CLOSE</button>
    </div>

    <script>
        // ====== ENHANCED GAME DATA ======
        const gameData = {
            player: {
                class: null,
                health: 100,
                maxHealth: 100,
                mana: 50,
                maxMana: 50,
                gold: 100,
                level: 1,
                experience: 0,
                inventory: ['torch', 'health_potion', 'rusty_key', 'holy_symbol'],
                equipped: {
                    weapon: 'rusty_dagger',
                    armor: 'leather_armor'
                },
                skills: [],
                location: 'entrance_hall',
                quests: []
            },
            
            classes: {
                gravekeeper: {
                    health: 120,
                    mana: 40,
                    skills: ['turn_undead', 'consecrate', 'grave_whisper'],
                    description: 'Keeper of burial rites with power over the dead'
                },
                bloodmage: {
                    health: 80,
                    mana: 80,
                    skills: ['blood_drain', 'hemorrhage', 'life_siphon'],
                    description: 'Mage who uses life force for dark magic'
                },
                exorcist: {
                    health: 90,
                    mana: 60,
                    skills: ['holy_smite', 'banish', 'purify'],
                    description: 'Wielder of holy power against spirits'
                }
            },
            
            rooms: {
                entrance_hall: {
                    name: 'ENTRANCE HALL',
                    description: 'A grand hall with tattered banners. The air is cold and smells of decay. A massive stone door to the north leads to the Great Hall.',
                    objects: ['stone_door', 'tattered_banner', 'wall_sconce'],
                    exits: { north: 'great_hall', east: 'armory', west: 'courtyard' },
                    npc: null,
                    enemy: null,
                    items: ['rusty_key', 'torch'],
                    visited: false,
                    dark: false
                },
                
                great_hall: {
                    name: 'GREAT HALL',
                    description: 'A vast hall with a long banquet table. Dust covers everything. An eerie silence hangs in the air.',
                    objects: ['banquet_table', 'silver_goblet', 'chandelier', 'tapestry'],
                    exits: { south: 'entrance_hall', west: 'library', east: 'kitchen', north: 'throne_room' },
                    npc: 'ghostly_butler',
                    enemy: null,
                    items: ['silver_coin', 'candle'],
                    visited: false,
                    dark: false
                },
                
                library: {
                    name: 'FORGOTTEN LIBRARY',
                    description: 'Books line the walls, most rotten to pulp. Something moves in the shadows between the bookshelves.',
                    objects: ['ancient_tome', 'writing_desk', 'bookshelf', 'reading_chair'],
                    exits: { east: 'great_hall', north: 'secret_passage', south: 'study', west: 'archive' },
                    npc: null,
                    enemy: 'spectral_librarian',
                    items: ['library_key', 'spell_scroll', 'dusty_book'],
                    visited: false,
                    dark: true
                },
                
                armory: {
                    name: 'ARMORY',
                    description: 'Weapon racks line the walls. Most weapons are rusted or broken. Shields with faded crests hang from hooks.',
                    objects: ['weapon_rack', 'armor_stand', 'chest', 'shield_wall'],
                    exits: { west: 'entrance_hall', north: 'barracks', east: 'training_grounds', south: 'storage_room' },
                    npc: null,
                    enemy: 'armored_skeleton',
                    items: ['iron_sword', 'steel_shield', 'leather_gauntlets'],
                    visited: false,
                    dark: false
                },
                
                kitchen: {
                    name: 'KITCHEN',
                    description: 'A large kitchen with rusted pots hanging from hooks. A massive oven dominates one wall. The smell of rot is overwhelming.',
                    objects: ['iron_oven', 'butcher_table', 'pot_rack', 'pantry'],
                    exits: { west: 'great_hall', north: 'dining_room', south: 'cellar', east: 'pantry_room' },
                    npc: 'cook_ghost',
                    enemy: null,
                    items: ['kitchen_knife', 'salt_pouch', 'rotten_meat'],
                    visited: false,
                    dark: true
                },

                wine_cellar: {
    name: 'WINE CELLAR',
    description: 'A vast wine cellar with rows of dusty bottles. The air smells of aged wine and damp stone.',
    objects: ['wine_rack', 'tasting_table', 'cork_screw', 'cobweb_corner'],
    exits: { west: 'dining_room', south: 'secret_passage', north: 'storage_room' },
    npc: null,
    enemy: 'wine_cellar_ghost',
    items: ['aged_wine', 'crystal_decanter', 'dusty_bottle'],
    visited: false,
    dark: true
},
                
                courtyard: {
                    name: 'COURTYARD',
                    description: 'An overgrown courtyard with a dry fountain. Statues of forgotten nobles peer through the mist.',
                    objects: ['dry_fountain', 'stone_statue', 'overgrown_path', 'iron_gate'],
                    exits: { east: 'entrance_hall', north: 'garden', south: 'gatehouse', west: 'stable' },
                    npc: null,
                    enemy: 'courtyard_zombie',
                    items: ['stone_shard', 'iron_key', 'herbs'],
                    visited: false,
                    dark: false
                },
                
                barracks: {
                    name: 'BARRACKS',
                    description: 'Rows of empty beds line this room. Rusted armor sits on stands, as if waiting for soldiers who never returned.',
                    objects: ['bunk_bed', 'footlocker', 'armor_stand', 'training_dummy'],
                    exits: { south: 'armory', east: 'captain_quarters', west: 'latrine' },
                    npc: null,
                    enemy: 'skeleton_soldier',
                    items: ['steel_helmet', 'chainmail', 'military_orders'],
                    visited: false,
                    dark: true
                },
                
                throne_room: {
                    name: 'THRONE ROOM',
                    description: 'A magnificent hall with a bone-white throne at its center. Tattered banners hang from the ceiling.',
                    objects: ['bone_throne', 'royal_banner', 'brazier', 'crown_stand'],
                    exits: { south: 'great_hall', west: 'royal_chambers', east: 'antechamber', north: 'crypt_entrance' },
                    npc: null,
                    enemy: 'throne_guardian',
                    items: ['royal_seal', 'gold_crown', 'ancient_scepter'],
                    visited: false,
                    dark: false
                },
                
                // NEW ROOMS TO FIX THE CONNECTIVITY ISSUES
                study: {
                    name: 'STUDY',
                    description: 'A small study with a writing desk covered in dust. Ancient maps and scrolls are scattered about.',
                    objects: ['writing_desk', 'ancient_map', 'inkwell', 'quill'],
                    exits: { north: 'library', east: 'private_chamber' },
                    npc: null,
                    enemy: null,
                    items: ['ink_bottle', 'parchment', 'sealing_wax'],
                    visited: false,
                    dark: false
                },
                
                archive: {
                    name: 'ARCHIVE',
                    description: 'Rows of shelves filled with scrolls and ledgers. The air is thick with the smell of old paper.',
                    objects: ['scroll_shelf', 'ledger_table', 'sorting_desk'],
                    exits: { east: 'library' },
                    npc: null,
                    enemy: 'archive_wight',
                    items: ['ancient_ledger', 'sealed_scroll', 'archive_key'],
                    visited: false,
                    dark: true
                },
                
                training_grounds: {
                    name: 'TRAINING GROUNDS',
                    description: 'An open area with practice dummies and weapon racks. The ground is worn from centuries of training.',
                    objects: ['practice_dummy', 'weapon_rack', 'target_range', 'armor_stand'],
                    exits: { west: 'armory', north: 'sparring_ring' },
                    npc: null,
                    enemy: 'training_skeleton',
                    items: ['wooden_sword', 'practice_shield', 'training_manual'],
                    visited: false,
                    dark: false
                },
                
                storage_room: {
                    name: 'STORAGE ROOM',
                    description: 'A cluttered room filled with barrels, crates, and discarded equipment.',
                    objects: ['wooden_barrel', 'storage_crate', 'tool_rack', 'broken_cart'],
                    exits: { north: 'armory' },
                    npc: null,
                    enemy: null,
                    items: ['repair_tools', 'spare_parts', 'oil_flask'],
                    visited: false,
                    dark: true
                },
                
                dining_room: {
                    name: 'DINING ROOM',
                    description: 'A formal dining room with a long table set for a feast. The food has long since rotted away.',
                    objects: ['dining_table', 'silver_setting', 'candelabra', 'sideboard'],
                    exits: { south: 'kitchen', east: 'wine_cellar' },
                    npc: null,
                    enemy: 'banquet_ghost',
                    items: ['silver_fork', 'crystal_goblet', 'linen_napkin'],
                    visited: false,
                    dark: false
                },
                
                cellar: {
                    name: 'CELLAR',
                    description: 'A cold, damp cellar filled with wine barrels and storage crates. Water drips from the ceiling.',
                    objects: ['wine_barrel', 'storage_crate', 'root_cellar', 'cobweb_corner'],
                    exits: { north: 'kitchen', east: 'secret_tunnel' },
                    npc: null,
                    enemy: 'cellar_rat_swarm',
                    items: ['aged_wine', 'salt_block', 'dried_herbs'],
                    visited: false,
                    dark: true
                },
                
                pantry_room: {
                    name: 'PANTRY',
                    description: 'Shelves line the walls, holding jars of preserves and sacks of flour that have turned to dust.',
                    objects: ['food_shelf', 'spice_rack', 'flour_sack', 'preserve_jar'],
                    exits: { west: 'kitchen' },
                    npc: null,
                    enemy: null,
                    items: ['spice_pouch', 'honey_jar', 'salt_bag'],
                    visited: false,
                    dark: true
                },
                
                garden: {
                    name: 'GARDEN',
                    description: 'An overgrown garden with dead plants and thorny vines. A stone bench sits beneath a dead tree.',
                    objects: ['stone_bench', 'dead_tree', 'overgrown_path', 'garden_statue'],
                    exits: { south: 'courtyard', east: 'greenhouse' },
                    npc: null,
                    enemy: 'garden_wraith',
                    items: ['herb_bundle', 'rare_flower', 'garden_shears'],
                    visited: false,
                    dark: false
                },
                
                gatehouse: {
                    name: 'GATEHOUSE',
                    description: 'The castle\'s main gatehouse. The portcullis is raised, and guard rooms line the walls.',
                    objects: ['portcullis', 'guard_post', 'gate_mechanism', 'arrow_slit'],
                    exits: { north: 'courtyard', east: 'guard_room' },
                    npc: null,
                    enemy: 'gate_guard_skeleton',
                    items: ['gate_key', 'guard_helmet', 'horn'],
                    visited: false,
                    dark: false
                }
            },
            
            objects: {
                stone_door: {
                    name: 'Stone Door',
                    description: 'A massive stone door carved with skull motifs. It appears to be locked.',
                    actions: ['examine', 'push', 'pick_lock'],
                    state: 'locked',
                    requiredKey: 'rusty_key'
                },
                tattered_banner: {
                    name: 'Tattered Banner',
                    description: 'A faded banner depicting a family crest. Might be valuable.',
                    actions: ['examine', 'take', 'burn'],
                    state: 'hanging',
                    takeable: true,
                    value: 50
                },
                ancient_tome: {
                    name: 'Ancient Tome',
                    description: 'A leather-bound book with silver clasps. It radiates magical energy.',
                    actions: ['examine', 'read', 'take'],
                    state: 'closed',
                    takeable: true,
                    value: 200
                },
                weapon_rack: {
                    name: 'Weapon Rack',
                    description: 'Holds various rusted weapons. One sword looks salvageable.',
                    actions: ['examine', 'search', 'take_sword'],
                    state: 'full',
                    hiddenItem: 'iron_sword'
                },
                banquet_table: {
                    name: 'Banquet Table',
                    description: 'A long table set for a feast that never happened. Silverware is tarnished.',
                    actions: ['examine', 'search', 'take_silverware'],
                    state: 'set',
                    hiddenItem: 'silver_goblet'
                },
                iron_oven: {
                    name: 'Iron Oven',
                    description: 'A massive oven, cold for centuries. Something might be inside.',
                    actions: ['examine', 'open', 'search'],
                    state: 'closed',
                    hiddenItem: 'charred_bone'
                },
                dry_fountain: {
                    name: 'Dry Fountain',
                    description: 'A marble fountain that hasn\'t held water in centuries. Coins glint at the bottom.',
                    actions: ['examine', 'search', 'take_coins'],
                    state: 'dry',
                    hiddenItem: 'fountain_coins'
                }
            },
            
            items: {
                torch: {
                    name: 'Torch',
                    type: 'tool',
                    description: 'Provides light in dark places.',
                    value: 10,
                    effect: 'light_area',
                    consumable: false
                },
                health_potion: {
                    name: 'Health Potion',
                    type: 'consumable',
                    description: 'Restores 30 health.',
                    value: 25,
                    effect: { health: 30 },
                    consumable: true
                },
                rusty_key: {
                    name: 'Rusty Key',
                    type: 'key',
                    description: 'An old, rusted key. Might open the stone door.',
                    value: 5,
                    effect: 'unlock_door',
                    consumable: true
                },
                iron_sword: {
                    name: 'Iron Sword',
                    type: 'weapon',
                    description: 'A basic iron sword. Better than a dagger.',
                    value: 50,
                    effect: { damage: 8 },
                    consumable: false
                },
                steel_shield: {
                    name: 'Steel Shield',
                    type: 'armor',
                    description: 'A sturdy steel shield. Provides defense.',
                    value: 75,
                    effect: { defense: 5 },
                    consumable: false
                },
                mana_potion: {
                    name: 'Mana Potion',
                    type: 'consumable',
                    description: 'Restores 20 mana.',
                    value: 30,
                    effect: { mana: 20 },
                    consumable: true
                },
                holy_symbol: {
                    name: 'Holy Symbol',
                    type: 'tool',
                    description: 'A blessed symbol. Useful against undead.',
                    value: 100,
                    effect: 'fear_undead',
                    consumable: false
                },
                library_key: {
                    name: 'Library Key',
                    type: 'key',
                    description: 'A brass key with book engravings. Unlocks library doors.',
                    value: 20,
                    effect: 'unlock_library',
                    consumable: true
                },
                kitchen_knife: {
                    name: 'Kitchen Knife',
                    type: 'weapon',
                    description: 'A sharp kitchen knife. Better than nothing.',
                    value: 15,
                    effect: { damage: 6 },
                    consumable: false
                },
                herbs: {
                    name: 'Herbs',
                    type: 'consumable',
                    description: 'Mystical herbs with healing properties.',
                    value: 20,
                    effect: { health: 15, mana: 10 },
                    consumable: true
                }
            },
            
            npcs: {
                ghostly_butler: {
                    name: 'Ghostly Butler',
                    description: 'A transparent figure in formal attire. He floats slightly above the ground.',
                    dialogue: {
                        greet: 'The master is expecting you... in the crypt.',
                        trade: 'I have items for sale, for the right price.',
                        quest: 'Find the family crest in the armory. I will reward you.',
                        info: 'The library holds ancient secrets, but beware the librarian.',
                        farewell: 'Watch your step... the castle is restless tonight.'
                    },
                    shop: ['silver_dagger', 'holy_water', 'ghostly_key', 'health_potion', 'mana_potion'],
                    quest: 'find_crest',
                    questComplete: false,
                    reward: { gold: 200, item: 'silver_amulet' }
                },
                cook_ghost: {
                    name: 'Ghostly Cook',
                    description: 'A plump ghost in a chef\'s hat, forever preparing meals.',
                    dialogue: {
                        greet: 'No fresh meat in centuries... only rats and memories.',
                        trade: 'I\'ve some kitchen tools you might find useful.',
                        quest: 'Bring me herbs from the courtyard for a special stew.',
                        info: 'The cellar below holds the master\'s wine... and other things.',
                        farewell: 'Mind the oven, it still hungers.'
                    },
                    shop: ['kitchen_knife', 'iron_pot', 'spice_pouch'],
                    quest: 'gather_herbs',
                    questComplete: false,
                    reward: { gold: 100, item: 'hearty_stew' }
                }
            },
            
            enemies: {
                spectral_librarian: {
                    name: 'Spectral Librarian',
                    health: 60,
                    maxHealth: 60,
                    damage: 8,
                    defense: 2,
                    loot: ['ancient_tome', 'ghost_dust', 'silver_coin', 'spell_scroll'],
                    weak_to: ['holy', 'silver'],
                    strong_against: ['physical'],
                    experience: 75,
                    description: 'A ghostly figure clutching a glowing book. Its whispers chill the air.'
                },
                armored_skeleton: {
                    name: 'Armored Skeleton',
                    health: 40,
                    maxHealth: 40,
                    damage: 6,
                    defense: 4,
                    loot: ['iron_sword', 'bone_fragments', 'rusty_armor'],
                    weak_to: ['blunt', 'holy'],
                    strong_against: ['slashing'],
                    experience: 50,
                    description: 'A skeleton clad in rusted armor, wielding a notched sword.'
                },
                courtyard_zombie: {
                    name: 'Courtyard Zombie',
                    health: 30,
                    maxHealth: 30,
                    damage: 5,
                    defense: 1,
                    loot: ['rotten_flesh', 'iron_key', 'muddy_boots'],
                    weak_to: ['fire', 'holy'],
                    strong_against: ['poison'],
                    experience: 35,
                    description: 'A shambling corpse covered in moss and grave dirt.'
                },
                skeleton_soldier: {
                    name: 'Skeleton Soldier',
                    health: 45,
                    maxHealth: 45,
                    damage: 7,
                    defense: 3,
                    loot: ['steel_helmet', 'military_orders', 'bone_fragments'],
                    weak_to: ['blunt'],
                    strong_against: ['piercing'],
                    experience: 60,
                    description: 'A disciplined skeleton in military formation, shield raised.'
                },
                throne_guardian: {
                    name: 'Throne Guardian',
                    health: 100,
                    maxHealth: 100,
                    damage: 12,
                    defense: 6,
                    loot: ['royal_seal', 'gold_crown', 'guardian_sigil'],
                    weak_to: ['holy', 'magic'],
                    strong_against: ['physical'],
                    experience: 150,
                    description: 'A massive spectral knight guarding the bone throne.'
                },
                // NEW ENEMIES
                archive_wight: {
                    name: 'Archive Wight',
                    health: 50,
                    maxHealth: 50,
                    damage: 7,
                    defense: 3,
                    loot: ['ancient_ledger', 'dusty_scroll', 'ink_bottle'],
                    weak_to: ['fire'],
                    strong_against: ['cold'],
                    experience: 65,
                    description: 'A spectral librarian that has absorbed too much forbidden knowledge.'
                },
                training_skeleton: {
                    name: 'Training Skeleton',
                    health: 35,
                    maxHealth: 35,
                    damage: 5,
                    defense: 2,
                    loot: ['wooden_sword', 'practice_shield', 'bone_chips'],
                    weak_to: ['blunt'],
                    strong_against: ['slashing'],
                    experience: 40,
                    description: 'A skeleton eternally practicing combat moves with wooden weapons.'
                },
                banquet_ghost: {
                    name: 'Banquet Ghost',
                    health: 55,
                    maxHealth: 55,
                    damage: 6,
                    defense: 1,
                    loot: ['silver_fork', 'crystal_shard', 'ghostly_wine'],
                    weak_to: ['holy'],
                    strong_against: ['physical'],
                    experience: 70,
                    description: 'A ghostly noble eternally waiting for a feast that never comes.'
                },
                cellar_rat_swarm: {
                    name: 'Cellar Rat Swarm',
                    health: 25,
                    maxHealth: 25,
                    damage: 4,
                    defense: 0,
                    loot: ['rat_tail', 'cheese_wedge', 'small_bone'],
                    weak_to: ['fire', 'area'],
                    strong_against: ['single_target'],
                    experience: 30,
                    description: 'A swarm of giant, aggressive rats that have made the cellar their home.'
                },
                garden_wraith: {
                    name: 'Garden Wraith',
                    health: 65,
                    maxHealth: 65,
                    damage: 8,
                    defense: 2,
                    loot: ['herb_bundle', 'wraith_essence', 'thorn_vine'],
                    weak_to: ['holy', 'silver'],
                    strong_against: ['nature'],
                    experience: 80,
                    description: 'A ghostly gardener forever tending to dead plants.'
                },
                gate_guard_skeleton: {
                    name: 'Gate Guard Skeleton',
                    health: 40,
                    maxHealth: 40,
                    damage: 6,
                    defense: 4,
                    loot: ['gate_key', 'rusty_spear', 'guard_badge'],
                    weak_to: ['blunt'],
                    strong_against: ['piercing'],
                    experience: 55,
                    description: 'A skeleton still standing guard at its post centuries later.'
                }
            },
            
            spells: {
                turn_undead: {
                    name: 'Turn Undead',
                    cost: 15,
                    damage: 25,
                    effect: 'fear_undead',
                    description: 'Channel holy energy to repel undead creatures.',
                    class: 'gravekeeper'
                },
                holy_smite: {
                    name: 'Holy Smite',
                    cost: 20,
                    damage: 30,
                    effect: 'holy_damage',
                    description: 'Strike with divine light, especially effective against evil.',
                    class: 'exorcist'
                },
                blood_drain: {
                    name: 'Blood Drain',
                    cost: 10,
                    damage: 15,
                    effect: 'drain_health',
                    description: 'Steal life force from your enemy to heal yourself.',
                    class: 'bloodmage'
                },
                consecrate: {
                    name: 'Consecrate',
                    cost: 25,
                    damage: 0,
                    effect: 'holy_ground',
                    description: 'Bless the area, preventing undead from approaching.',
                    class: 'gravekeeper'
                },
                banish: {
                    name: 'Banish',
                    cost: 30,
                    damage: 40,
                    effect: 'banish_spirit',
                    description: 'Forcefully send a spirit back to the afterlife.',
                    class: 'exorcist'
                },
                hemorrhage: {
                    name: 'Hemorrhage',
                    cost: 18,
                    damage: 22,
                    effect: 'bleeding',
                    description: 'Cause internal bleeding that continues to damage the enemy.',
                    class: 'bloodmage'
                },
                grave_whisper: {
                    name: 'Grave Whisper',
                    cost: 12,
                    damage: 0,
                    effect: 'reveal_secrets',
                    description: 'Listen to the whispers of the dead to find hidden things.',
                    class: 'gravekeeper'
                }
            }
        };

        // ====== GAME STATE ======
        let gameState = JSON.parse(JSON.stringify(gameData));
        let currentEnemy = null;
        let currentNpc = null;
        let gameActive = false;
        let inCombat = false;

        // ====== UI FUNCTIONS ======
        function output(message, type = 'system') {
            const outputWindow = document.getElementById('outputWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `msg-${type}`;
            messageDiv.textContent = `> ${message}`;
            outputWindow.appendChild(messageDiv);
            outputWindow.scrollTop = outputWindow.scrollHeight;
            
            // Update prompt
            document.getElementById('gamePrompt').scrollIntoView();
        }

        function updateUI() {
            // Update status bars
            const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
            const manaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            
            document.getElementById('health').textContent = 
                `${gameState.player.health}/${gameState.player.maxHealth}`;
            document.getElementById('healthBar').style.width = `${healthPercent}%`;
            
            document.getElementById('mana').textContent = 
                `${gameState.player.mana}/${gameState.player.maxMana}`;
            document.getElementById('manaBar').style.width = `${manaPercent}%`;
            
            document.getElementById('gold').textContent = gameState.player.gold;
            document.getElementById('level').textContent = gameState.player.level;
            document.getElementById('exp').textContent = `${gameState.player.experience}/${gameState.player.level * 100}`;
            
            // Update location
            const room = gameState.rooms[gameState.player.location];
            document.getElementById('location').textContent = room.name;
            
            // Update equipment
            document.getElementById('weapon').textContent = 
                gameState.items[gameState.player.equipped.weapon]?.name?.toUpperCase() || 'DAGGER';
            document.getElementById('armor').textContent = 
                gameState.items[gameState.player.equipped.armor]?.name?.toUpperCase() || 'LEATHER';
            
            updateInventory();
            updateRoomObjects();
        }

        function updateInventory() {
            const inventoryDisplay = document.getElementById('inventoryDisplay');
            inventoryDisplay.innerHTML = '';
            
            if (gameState.player.inventory.length === 0) {
                inventoryDisplay.innerHTML = '<div style="color: #555;">> EMPTY</div>';
                return;
            }
            
            gameState.player.inventory.forEach(itemId => {
                const item = gameState.items[itemId];
                if (!item) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                
                let useText = 'USE';
                if (item.type === 'weapon') useText = 'EQUIP';
                if (item.type === 'key') useText = 'USE';
                if (item.type === 'consumable') useText = item.name.includes('Potion') ? 'DRINK' : 'USE';
                
                itemDiv.innerHTML = `
                    <span>${item.name.toUpperCase()}</span>
                    <button class="object-btn" onclick="useInventoryItem('${itemId}')">${useText}</button>
                `;
                inventoryDisplay.appendChild(itemDiv);
            });
        }

        function updateRoomObjects() {
            const roomObjectsDiv = document.getElementById('roomObjects');
            roomObjectsDiv.innerHTML = '';
            
            const room = gameState.rooms[gameState.player.location];
            
            // Add room items first
            if (room.items && room.items.length > 0) {
                room.items.forEach(itemId => {
                    const item = gameState.items[itemId];
                    if (!item) return;
                    
                    const button = document.createElement('button');
                    button.className = 'object-btn';
                    button.textContent = item.name.toUpperCase();
                    button.onclick = () => takeSpecificItem(itemId);
                    roomObjectsDiv.appendChild(button);
                });
            }
            
            // Add interactive objects
            room.objects.forEach(objectId => {
                const obj = gameState.objects[objectId];
                if (!obj) return;
                
                const button = document.createElement('button');
                button.className = 'object-btn';
                button.textContent = obj.name.toUpperCase();
                button.onclick = () => interactWithObject(objectId);
                roomObjectsDiv.appendChild(button);
            });
            
            if (roomObjectsDiv.children.length === 0) {
                roomObjectsDiv.innerHTML = '<div style="color: #555;">> NO OBJECTS</div>';
            }
        }

        // ====== GAME FUNCTIONS ======
        function startGame(className) {
            gameState.player.class = className;
            const classData = gameState.classes[className];
            
            // Apply class bonuses
            gameState.player.maxHealth = classData.health;
            gameState.player.health = classData.health;
            gameState.player.maxMana = classData.mana;
            gameState.player.mana = classData.mana;
            gameState.player.skills = [...classData.skills];
            
            // Hide class selection, show game
            document.getElementById('classSelection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'flex';
            
            output(`CLASS SELECTED: ${className.toUpperCase()}`, 'success');
            output(classData.description, 'system');
            output('You stand before the Castle of the Undead. The gates creak open...', 'danger');
            output('Type HELP for commands or use the buttons.', 'system');
            
            look();
            updateUI();
            gameActive = true;
            
            // Start game clock
            updateGameTime();
            setInterval(updateGameTime, 1000);
        }

        function updateGameTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('gameTime').textContent = timeString;
        }

        function move(direction) {
            if (!gameActive || inCombat) {
                output('You cannot move while in combat!', 'danger');
                return;
            }
            
            const room = gameState.rooms[gameState.player.location];
            
            if (!room.exits[direction]) {
                output(`You cannot go ${direction.toUpperCase()} from here.`, 'system');
                
                // Suggest available exits
                const availableExits = Object.keys(room.exits);
                if (availableExits.length > 0) {
                    output(`Available exits: ${availableExits.map(d => d.toUpperCase()).join(', ')}`, 'system');
                }
                return;
            }
            
            const newLocation = room.exits[direction];
            
            // Check if door is locked
            if (direction === 'north' && room.name === 'ENTRANCE HALL') {
                const stoneDoor = gameState.objects.stone_door;
                if (stoneDoor && stoneDoor.state === 'locked') {
                    output('The stone door to the north is locked!', 'danger');
                    output('You need a key to unlock it.', 'system');
                    return;
                }
            }
            
            gameState.player.location = newLocation;
            
            output(`You move ${direction.toUpperCase()}.`, 'system');
            
            // Check if room is dark
            const newRoom = gameState.rooms[newLocation];
            if (newRoom.dark && !gameState.player.inventory.includes('torch')) {
                output('It is too dark to see! You need a light source.', 'danger');
                output('You stumble in the darkness...', 'system');
                return;
            }
            
            // Check if room is visited for the first time
            if (!newRoom.visited) {
                newRoom.visited = true;
                output(`*** NEW AREA DISCOVERED: ${newRoom.name} ***`, 'success');
            }
            
            look();
            updateUI();
        }

        function look() {
            const room = gameState.rooms[gameState.player.location];
            
            output(`=== ${room.name} ===`, 'system');
            output(room.description, 'system');
            
            // Check for NPC
            if (room.npc && !gameState.npcs[room.npc]?.questComplete) {
                const npc = gameState.npcs[room.npc];
                output(`${npc.name} is here.`, 'npc');
                output(npc.description, 'npc');
            }
            
            // Check for enemy
            if (room.enemy && !room.enemy.defeated) {
                const enemy = gameState.enemies[room.enemy];
                output(`A ${enemy.name} blocks your path!`, 'danger');
                output(enemy.description, 'danger');
                startCombat(room.enemy);
            }
            
            // List items
            if (room.items && room.items.length > 0) {
                output(`You see: ${room.items.map(id => gameState.items[id]?.name || id).join(', ')}`, 'loot');
            }
            
            // List exits
            const exitDirections = Object.keys(room.exits);
            if (exitDirections.length > 0) {
                output(`Exits: ${exitDirections.map(d => d.toUpperCase()).join(', ')}`, 'system');
            } else {
                output('There are no obvious exits.', 'system');
            }
            
            // Check for darkness
            if (room.dark && gameState.player.inventory.includes('torch')) {
                output('Your torch illuminates the room.', 'explore');
            }
        }

        function search() {
            const room = gameState.rooms[gameState.player.location];
            let foundSomething = false;
            
            output('You search the area carefully...', 'system');
            
            // Search objects for hidden items
            room.objects.forEach(objectId => {
                const obj = gameState.objects[objectId];
                if (obj.hiddenItem && !room.items.includes(obj.hiddenItem)) {
                    room.items.push(obj.hiddenItem);
                    const itemName = gameState.items[obj.hiddenItem]?.name || obj.hiddenItem;
                    output(`You find ${itemName} hidden in the ${obj.name.toLowerCase()}!`, 'loot');
                    foundSomething = true;
                    delete obj.hiddenItem;
                }
            });
            
            // Search room for hidden exits (with skill check)
            if (gameState.player.class === 'gravekeeper' && Math.random() > 0.5 && !room.exits.hidden) {
                room.exits.hidden = 'secret_chamber';
                output('Your knowledge of burial sites reveals a hidden passage!', 'success');
                foundSomething = true;
            }
            
            // Search for secret items
            if (Math.random() > 0.7 && room.items.length < 3) {
                const secretItems = ['gold_coin', 'silver_ring', 'old_bone'];
                const newItem = secretItems[Math.floor(Math.random() * secretItems.length)];
                if (!room.items.includes(newItem)) {
                    room.items.push(newItem);
                    output(`You find a ${newItem.replace('_', ' ')}!`, 'loot');
                    foundSomething = true;
                }
            }
            
            if (!foundSomething) {
                output('You search thoroughly but find nothing of value.', 'system');
            }
            
            updateUI();
        }

        function takeSpecificItem(itemId) {
            const room = gameState.rooms[gameState.player.location];
            
            if (!room.items.includes(itemId)) {
                output('That item is not here.', 'system');
                return;
            }
            
            const item = gameState.items[itemId];
            if (!item) {
                output('You cannot take that.', 'system');
                return;
            }
            
            // Remove from room, add to inventory
            const index = room.items.indexOf(itemId);
            if (index > -1) {
                room.items.splice(index, 1);
                gameState.player.inventory.push(itemId);
                output(`You take the ${item.name}.`, 'success');
            }
            
            updateUI();
        }

        function takeAll() {
            const room = gameState.rooms[gameState.player.location];
            
            if (room.items.length === 0) {
                output('There is nothing to take.', 'system');
                return;
            }
            
            const itemsTaken = [];
            room.items.forEach(itemId => {
                gameState.player.inventory.push(itemId);
                const itemName = gameState.items[itemId]?.name || itemId;
                itemsTaken.push(itemName);
            });
            
            room.items = [];
            output(`You take: ${itemsTaken.join(', ')}`, 'success');
            updateUI();
        }

        function interactWithObject(objectId) {
            const room = gameState.rooms[gameState.player.location];
            const obj = gameState.objects[objectId];
            
            if (!obj || !room.objects.includes(objectId)) {
                output('That object is not here.', 'system');
                return;
            }
            
            output(`=== ${obj.name.toUpperCase()} ===`, 'system');
            output(obj.description, 'system');
            
            // Handle specific object interactions
            if (obj.name === 'Stone Door') {
                if (obj.state === 'locked') {
                    if (gameState.player.inventory.includes('rusty_key')) {
                        output('You use the rusty key to unlock the door.', 'success');
                        obj.state = 'unlocked';
                        output('The stone door is now unlocked! You can go NORTH to the Great Hall.', 'success');
                    } else {
                        output('The door is locked. You need a key.', 'system');
                    }
                } else {
                    output('The door is unlocked. You can pass through to the NORTH.', 'system');
                }
            }
            
            if (obj.name === 'Weapon Rack') {
                if (obj.hiddenItem && !gameState.player.inventory.includes(obj.hiddenItem)) {
                    output('You find a usable sword on the rack!', 'loot');
                    if (confirm('Take the sword?')) {
                        gameState.player.inventory.push(obj.hiddenItem);
                        output(`You take the ${gameState.items[obj.hiddenItem].name}.`, 'success');
                        delete obj.hiddenItem;
                    }
                } else {
                    output('The weapons here are too rusted to use.', 'system');
                }
            }
            
            if (obj.name === 'Ancient Tome') {
                output('The tome contains ancient knowledge...', 'magic');
                if (gameState.player.class === 'bloodmage' || gameState.player.class === 'exorcist') {
                    output('You learn a new spell from the tome!', 'magic');
                    if (!gameState.player.skills.includes('arcane_knowledge')) {
                        gameState.player.skills.push('arcane_knowledge');
                    }
                }
            }
            
            if (obj.name === 'Dry Fountain') {
                if (obj.hiddenItem && !gameState.player.inventory.includes(obj.hiddenItem)) {
                    output('You find coins at the bottom of the fountain!', 'loot');
                    const goldAmount = Math.floor(Math.random() * 50) + 25;
                    gameState.player.gold += goldAmount;
                    output(`You find ${goldAmount} gold coins!`, 'loot');
                    delete obj.hiddenItem;
                }
            }
            
            updateUI();
        }

        function useInventoryItem(itemId) {
            const item = gameState.items[itemId];
            
            if (!item) {
                output('You do not have that item.', 'system');
                return;
            }
            
            output(`Using ${item.name}...`, 'system');
            
            switch(item.type) {
                case 'consumable':
                    if (item.effect.health) {
                        const oldHealth = gameState.player.health;
                        gameState.player.health = Math.min(
                            gameState.player.maxHealth,
                            gameState.player.health + item.effect.health
                        );
                        const healed = gameState.player.health - oldHealth;
                        output(`You restore ${healed} health.`, 'success');
                    }
                    if (item.effect.mana) {
                        const oldMana = gameState.player.mana;
                        gameState.player.mana = Math.min(
                            gameState.player.maxMana,
                            gameState.player.mana + item.effect.mana
                        );
                        const restored = gameState.player.mana - oldMana;
                        output(`You restore ${restored} mana.`, 'success');
                    }
                    
                    // Remove from inventory if consumable
                    if (item.consumable) {
                        const index = gameState.player.inventory.indexOf(itemId);
                        if (index > -1) {
                            gameState.player.inventory.splice(index, 1);
                        }
                    }
                    break;
                    
                case 'weapon':
                    gameState.player.equipped.weapon = itemId;
                    output(`You equip the ${item.name}.`, 'success');
                    break;
                    
                case 'armor':
                    gameState.player.equipped.armor = itemId;
                    output(`You equip the ${item.name}.`, 'success');
                    break;
                    
                case 'key':
                    output(`This key might unlock something nearby.`, 'system');
                    // Check if there's a locked door in the room
                    const room = gameState.rooms[gameState.player.location];
                    const lockedObject = room.objects.find(objId => {
                        const obj = gameState.objects[objId];
                        return obj && obj.state === 'locked' && obj.requiredKey === itemId;
                    });
                    
                    if (lockedObject) {
                        output(`The key fits!`, 'success');
                        gameState.objects[lockedObject].state = 'unlocked';
                        // Remove key after use if it's consumable
                        if (item.consumable) {
                            const index = gameState.player.inventory.indexOf(itemId);
                            if (index > -1) {
                                gameState.player.inventory.splice(index, 1);
                            }
                        }
                    }
                    break;
                    
                case 'tool':
                    if (itemId === 'torch') {
                        const room = gameState.rooms[gameState.player.location];
                        if (room.dark) {
                            output('Your torch illuminates the dark room.', 'system');
                        } else {
                            output('You light your torch.', 'system');
                        }
                    }
                    if (itemId === 'holy_symbol') {
                        output('The holy symbol glows with divine light.', 'magic');
                        if (currentEnemy && currentEnemy.weak_to.includes('holy')) {
                            output('The enemy recoils from the holy symbol!', 'success');
                        }
                    }
                    output(`You use the ${item.name}.`, 'system');
                    break;
                    
                default:
                    output(`You use the ${item.name}.`, 'system');
            }
            
            updateUI();
        }

        function examine() {
            const room = gameState.rooms[gameState.player.location];
            output(`=== EXAMINING ${room.name} ===`, 'system');
            output(room.description, 'system');
            
            // Extra examination details
            if (room.npc) {
                const npc = gameState.npcs[room.npc];
                output(`${npc.name} is here: ${npc.description}`, 'npc');
            }
            
            if (room.objects.length > 0) {
                output('Notable features:', 'system');
                room.objects.forEach(objId => {
                    const obj = gameState.objects[objId];
                    if (obj) {
                        output(`- ${obj.name}: ${obj.description}`, 'explore');
                    }
                });
            }
            
            // Class-specific examination
            if (gameState.player.class === 'gravekeeper') {
                output('You sense restless spirits in this place...', 'magic');
                if (room.enemy) {
                    output('There is an undead presence nearby!', 'danger');
                }
            }
            if (gameState.player.class === 'exorcist') {
                output('The air feels heavy with spiritual energy.', 'magic');
            }
            if (gameState.player.class === 'bloodmage') {
                output('You can feel the life force that once filled this place.', 'magic');
            }
        }

        function talk() {
            const room = gameState.rooms[gameState.player.location];
            
            if (!room.npc) {
                output('There is no one here to talk to.', 'system');
                return;
            }
            
            currentNpc = gameState.npcs[room.npc];
            const dialogueBox = document.getElementById('dialogueBox');
            
            // Show dialogue box
            dialogueBox.style.display = 'block';
            document.getElementById('npcName').textContent = currentNpc.name;
            document.getElementById('dialogueText').textContent = currentNpc.dialogue.greet;
            
            // Create dialogue options
            const optionsDiv = document.getElementById('dialogueOptions');
            optionsDiv.innerHTML = '';
            
            // Greeting option
            const greetOption = document.createElement('button');
            greetOption.className = 'dos-btn';
            greetOption.textContent = 'GREET';
            greetOption.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.greet;
            };
            optionsDiv.appendChild(greetOption);
            
            // Trade option - FIXED: Now properly shows shop
            const tradeOption = document.createElement('button');
            tradeOption.className = 'dos-btn';
            tradeOption.textContent = 'ASK ABOUT TRADE';
            tradeOption.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.trade;
                showShop(currentNpc.shop);
            };
            optionsDiv.appendChild(tradeOption);
            
            // Quest option
            if (!currentNpc.questComplete) {
                const questOption = document.createElement('button');
                questOption.className = 'dos-btn';
                questOption.textContent = 'ASK ABOUT QUESTS';
                questOption.onclick = () => {
                    document.getElementById('dialogueText').textContent = currentNpc.dialogue.quest;
                    if (!gameState.player.quests.includes(currentNpc.quest)) {
                        gameState.player.quests.push(currentNpc.quest);
                        output(`QUEST ACCEPTED: ${currentNpc.quest.replace('_', ' ').toUpperCase()}`, 'quest');
                    }
                };
                optionsDiv.appendChild(questOption);
            }
            
            // Info option
            const infoOption = document.createElement('button');
            infoOption.className = 'dos-btn';
            infoOption.textContent = 'ASK FOR INFORMATION';
            infoOption.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.info;
            };
            optionsDiv.appendChild(infoOption);
            
            // Farewell option
            const farewellOption = document.createElement('button');
            farewellOption.className = 'dos-btn';
            farewellOption.textContent = 'SAY GOODBYE';
            farewellOption.onclick = () => {
                document.getElementById('dialogueText').textContent = currentNpc.dialogue.farewell;
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                }, 1500);
            };
            optionsDiv.appendChild(farewellOption);
        }

        function showShop(items) {
            const shopInterface = document.getElementById('shopInterface');
            const shopItemsDiv = document.getElementById('shopItems');
            const shopGold = document.getElementById('shopGold');
            
            shopInterface.style.display = 'block';
            shopGold.textContent = gameState.player.gold;
            shopItemsDiv.innerHTML = '';
            
            items.forEach(itemId => {
                const item = gameState.items[itemId];
                if (!item) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.justifyContent = 'space-between';
                itemDiv.style.alignItems = 'center';
                itemDiv.style.marginBottom = '4px';
                itemDiv.style.padding = '4px';
                itemDiv.style.background = '#111';
                itemDiv.style.border = '1px solid #333';
                
                itemDiv.innerHTML = `
                    <div style="flex: 2;">
                        <div style="color: #FFFF55;">${item.name.toUpperCase()}</div>
                        <div style="font-size: 10px; color: #AAAAAA;">${item.description}</div>
                    </div>
                    <div style="color: #FFFF55; margin: 0 8px;">${item.value} GOLD</div>
                    <button class="object-btn" onclick="buyItem('${itemId}')">BUY</button>
                `;
                
                shopItemsDiv.appendChild(itemDiv);
            });
            
            if (items.length === 0) {
                shopItemsDiv.innerHTML = '<div style="color: #555; text-align: center;">No items for sale.</div>';
            }
        }

        function hideShop() {
            document.getElementById('shopInterface').style.display = 'none';
        }

        function buyItem(itemId) {
            const item = gameState.items[itemId];
            
            if (!item) {
                output('Item not available.', 'system');
                return;
            }
            
            if (gameState.player.gold < item.value) {
                output(`Not enough gold! You need ${item.value} but only have ${gameState.player.gold}.`, 'system');
                return;
            }
            
            gameState.player.gold -= item.value;
            gameState.player.inventory.push(itemId);
            
            output(`You buy ${item.name} for ${item.value} gold.`, 'success');
            
            // Update shop display
            document.getElementById('shopGold').textContent = gameState.player.gold;
            updateUI();
        }

        function showSpellList() {
            if (inCombat) {
                showCombatSpells();
                return;
            }
            
            const spellInterface = document.getElementById('spellInterface');
            const spellListDiv = document.getElementById('spellList');
            const spellMana = document.getElementById('spellMana');
            
            spellInterface.style.display = 'block';
            spellMana.textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            spellListDiv.innerHTML = '';
            
            if (gameState.player.skills.length === 0) {
                spellListDiv.innerHTML = '<div style="color: #555; text-align: center;">No spells known.</div>';
                return;
            }
            
            gameState.player.skills.forEach(spellId => {
                const spell = gameState.spells[spellId];
                if (!spell) return;
                
                const spellDiv = document.createElement('div');
                spellDiv.style.display = 'flex';
                spellDiv.style.justifyContent = 'space-between';
                spellDiv.style.alignItems = 'center';
                spellDiv.style.marginBottom = '4px';
                spellDiv.style.padding = '4px';
                spellDiv.style.background = '#111';
                spellDiv.style.border = '1px solid #333';
                
                const canCast = gameState.player.mana >= spell.cost;
                
                spellDiv.innerHTML = `
                    <div style="flex: 2;">
                        <div style="color: ${canCast ? '#FF55FF' : '#555'};">
                            ${spell.name.toUpperCase()}
                        </div>
                        <div style="font-size: 10px; color: #AAAAAA;">${spell.description}</div>
                    </div>
                    <div style="color: ${canCast ? '#55FFFF' : '#555'}; margin: 0 8px;">
                        ${spell.cost} MP
                    </div>
                    <button class="object-btn" onclick="castSpell('${spellId}')" ${!canCast ? 'disabled' : ''}>
                        CAST
                    </button>
                `;
                
                spellListDiv.appendChild(spellDiv);
            });
        }

        function showCombatSpells() {
            const spellInterface = document.getElementById('spellInterface');
            const spellListDiv = document.getElementById('spellList');
            const spellMana = document.getElementById('spellMana');
            
            spellInterface.style.display = 'block';
            spellMana.textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            spellListDiv.innerHTML = '';
            
            if (gameState.player.skills.length === 0) {
                spellListDiv.innerHTML = '<div style="color: #555; text-align: center;">No combat spells known.</div>';
                return;
            }
            
            gameState.player.skills.forEach(spellId => {
                const spell = gameState.spells[spellId];
                if (!spell || spell.damage <= 0) return;
                
                const spellDiv = document.createElement('div');
                spellDiv.style.display = 'flex';
                spellDiv.style.justifyContent = 'space-between';
                spellDiv.style.alignItems = 'center';
                spellDiv.style.marginBottom = '4px';
                spellDiv.style.padding = '4px';
                spellDiv.style.background = '#111';
                spellDiv.style.border = '1px solid #333';
                
                const canCast = gameState.player.mana >= spell.cost;
                
                spellDiv.innerHTML = `
                    <div style="flex: 2;">
                        <div style="color: ${canCast ? '#FF55FF' : '#555'};">
                            ${spell.name.toUpperCase()}
                        </div>
                        <div style="font-size: 10px; color: #AAAAAA;">Damage: ${spell.damage}</div>
                    </div>
                    <div style="color: ${canCast ? '#55FFFF' : '#555'}; margin: 0 8px;">
                        ${spell.cost} MP
                    </div>
                    <button class="object-btn" onclick="castCombatSpell('${spellId}')" ${!canCast ? 'disabled' : ''}>
                        CAST
                    </button>
                `;
                
                spellListDiv.appendChild(spellDiv);
            });
            
            if (spellListDiv.children.length === 0) {
                spellListDiv.innerHTML = '<div style="color: #555; text-align: center;">No combat spells available.</div>';
            }
        }

        function hideSpells() {
            document.getElementById('spellInterface').style.display = 'none';
        }

        function castSpell(spellId) {
            const spell = gameState.spells[spellId];
            if (!spell) return;
            
            if (gameState.player.mana < spell.cost) {
                output(`Not enough mana! Need ${spell.cost}, have ${gameState.player.mana}.`, 'system');
                return;
            }
            
            gameState.player.mana -= spell.cost;
            
            // Spell effects
            switch(spellId) {
                case 'grave_whisper':
                    output('You listen to the whispers of the dead...', 'magic');
                    search(); // Grave whisper acts like search
                    break;
                case 'consecrate':
                    output('You consecrate the ground around you.', 'magic');
                    output('Undead will avoid this area temporarily.', 'success');
                    // Mark room as consecrated
                    const room = gameState.rooms[gameState.player.location];
                    room.consecrated = true;
                    if (room.enemy && gameState.enemies[room.enemy].weak_to.includes('holy')) {
                        output('The undead presence here recoils from the holy ground!', 'success');
                        delete room.enemy;
                    }
                    break;
                default:
                    output(`You cast ${spell.name}.`, 'magic');
            }
            
            hideSpells();
            updateUI();
        }

        // ====== COMBAT SYSTEM ======
        function startCombat(enemyId) {
            currentEnemy = { 
                ...gameState.enemies[enemyId], 
                id: enemyId,
                originalHealth: gameState.enemies[enemyId].health
            };
            gameActive = false;
            inCombat = true;
            
            const combatInterface = document.getElementById('combatInterface');
            combatInterface.style.display = 'block';
            
            document.getElementById('enemyName').textContent = currentEnemy.name;
            updateEnemyHealth();
            
            output(`COMBAT STARTED! You face a ${currentEnemy.name}!`, 'danger');
        }

        function updateEnemyHealth() {
            const healthBar = document.getElementById('enemyHealthBar');
            const percent = Math.max(0, (currentEnemy.health / currentEnemy.maxHealth) * 100);
            healthBar.style.width = `${percent}%`;
            
            // Update enemy stats display
            document.getElementById('enemyStats').textContent = 
                `HP: ${currentEnemy.health}/${currentEnemy.maxHealth} | ATK: ${currentEnemy.damage} | DEF: ${currentEnemy.defense}`;
        }

        function playerAttack() {
            if (!currentEnemy) return;
            
            // Calculate damage
            const weapon = gameState.items[gameState.player.equipped.weapon];
            const baseDamage = weapon?.effect?.damage || 5;
            const armor = gameState.items[gameState.player.equipped.armor];
            const defenseBonus = armor?.effect?.defense || 0;
            
            let damage = baseDamage + Math.floor(Math.random() * 6);
            damage = Math.max(1, damage - currentEnemy.defense + defenseBonus);
            
            // Class bonuses
            if (gameState.player.class === 'exorcist' && currentEnemy.weak_to.includes('holy')) {
                damage += 5;
                output('Your exorcist powers are especially effective!', 'magic');
            }
            if (gameState.player.class === 'gravekeeper' && currentEnemy.name.includes('Skeleton') || currentEnemy.name.includes('Zombie')) {
                damage += 3;
                output('Your gravekeeper knowledge helps you target weak spots!', 'magic');
            }
            
            currentEnemy.health -= damage;
            output(`You attack for ${damage} damage!`, 'combat');
            
            if (currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy counterattack
            enemyTurn();
        }

        function castCombatSpell(spellId) {
            if (!currentEnemy) return;
            
            const spell = gameState.spells[spellId];
            if (!spell) return;
            
            if (gameState.player.mana < spell.cost) {
                output(`Not enough mana! Need ${spell.cost}, have ${gameState.player.mana}.`, 'system');
                return;
            }
            
            gameState.player.mana -= spell.cost;
            let damage = spell.damage + Math.floor(Math.random() * 10);
            
            // Check for weaknesses
            if (spell.effect === 'holy_damage' && currentEnemy.weak_to.includes('holy')) {
                damage *= 1.5;
                output('The enemy is weak to holy damage!', 'magic');
            }
            if (spell.effect === 'fear_undead' && currentEnemy.weak_to.includes('holy')) {
                damage *= 1.3;
                output('The undead creature fears your power!', 'magic');
            }
            
            currentEnemy.health -= damage;
            output(`You cast ${spell.name} for ${Math.floor(damage)} damage!`, 'magic');
            
            // Special effects
            if (spell.effect === 'drain_health') {
                const healAmount = Math.floor(damage / 2);
                gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + healAmount);
                output(`You drain ${healAmount} health from the enemy!`, 'success');
            }
            
            if (spell.effect === 'bleeding') {
                output('The enemy begins to bleed profusely!', 'combat');
                // Bleeding effect would be tracked here
            }
            
            if (currentEnemy.health <= 0) {
                hideSpells();
                endCombat(true);
                return;
            }
            
            hideSpells();
            enemyTurn();
            updateUI();
        }

        function showCombatItems() {
            output('Select an item from your inventory to use in combat.', 'system');
            // This would ideally open an inventory interface for combat
        }

        function enemyTurn() {
            if (!currentEnemy) return;
            
            let damage = currentEnemy.damage + Math.floor(Math.random() * 4);
            
            // Check player defense
            const armor = gameState.items[gameState.player.equipped.armor];
            const defenseBonus = armor?.effect?.defense || 0;
            damage = Math.max(1, damage - defenseBonus);
            
            // Check for class defense bonuses
            if (gameState.player.class === 'exorcist' && currentEnemy.weak_to.includes('holy')) {
                damage = Math.max(1, damage - 2);
                output('Your holy aura protects you!', 'magic');
            }
            
            gameState.player.health -= damage;
            
            output(`${currentEnemy.name} attacks you for ${damage} damage!`, 'danger');
            updateEnemyHealth();
            
            if (gameState.player.health <= 0) {
                gameOver();
                return;
            }
            
            updateUI();
        }

        function endCombat(victorious) {
            const combatInterface = document.getElementById('combatInterface');
            combatInterface.style.display = 'none';
            
            if (victorious) {
                output(`You defeated the ${currentEnemy.name}!`, 'success');
                
                // Give loot
                if (currentEnemy.loot) {
                    currentEnemy.loot.forEach(itemId => {
                        if (Math.random() > 0.3) { // 70% chance for each loot item
                            gameState.player.inventory.push(itemId);
                            const itemName = gameState.items[itemId]?.name || itemId;
                            output(`You find: ${itemName}`, 'loot');
                        }
                    });
                }
                
                // Give gold
                const goldGained = Math.floor(Math.random() * 50) + 25;
                gameState.player.gold += goldGained;
                output(`You find ${goldGained} gold.`, 'loot');
                
                // Give experience
                gameState.player.experience += currentEnemy.experience;
                output(`Gained ${currentEnemy.experience} experience.`, 'success');
                checkLevelUp();
                
                // Mark enemy as defeated
                const room = gameState.rooms[gameState.player.location];
                delete room.enemy;
            } else {
                output('You fled from combat!', 'system');
            }
            
            currentEnemy = null;
            gameActive = true;
            inCombat = false;
            updateUI();
        }

        function gameOver() {
            output('=== YOU HAVE BEEN DEFEATED ===', 'danger');
            output('GAME OVER', 'danger');
            output('Press F5 to restart', 'system');
            
            gameActive = false;
            inCombat = false;
            
            // Hide combat interface
            document.getElementById('combatInterface').style.display = 'none';
        }

        function checkLevelUp() {
            const neededExp = gameState.player.level * 100;
            
            if (gameState.player.experience >= neededExp) {
                gameState.player.level++;
                gameState.player.experience -= neededExp;
                
                gameState.player.maxHealth += 20;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.maxMana += 10;
                gameState.player.mana = gameState.player.maxMana;
                
                output(`=== LEVEL UP! You are now level ${gameState.player.level}! ===`, 'success');
                output(`Health: +20, Mana: +10`, 'success');
                
                // Learn new spells at certain levels
                if (gameState.player.level === 2) {
                    const classSpells = {
                        gravekeeper: 'consecrate',
                        bloodmage: 'hemorrhage',
                        exorcist: 'banish'
                    };
                    const newSpell = classSpells[gameState.player.class];
                    if (newSpell && !gameState.player.skills.includes(newSpell)) {
                        gameState.player.skills.push(newSpell);
                        output(`You learned a new spell: ${gameState.spells[newSpell].name}!`, 'magic');
                    }
                }
                if (gameState.player.level === 3) {
                    const classSpells = {
                        gravekeeper: 'grave_whisper',
                        bloodmage: 'life_siphon',
                        exorcist: 'purify'
                    };
                    const newSpell = classSpells[gameState.player.class];
                    if (newSpell && !gameState.player.skills.includes(newSpell)) {
                        gameState.player.skills.push(newSpell);
                        output(`You mastered a new spell: ${gameState.spells[newSpell].name}!`, 'magic');
                    }
                }
                
                updateUI();
            }
        }

        function flee() {
            if (!currentEnemy) {
                output('You are not in combat.', 'system');
                return;
            }
            
            if (Math.random() > 0.4) { // 60% chance to flee
                output('You successfully flee from combat!', 'system');
                endCombat(false);
                
                // Move player back one room if possible
                const directions = ['north', 'south', 'east', 'west'];
                const room = gameState.rooms[gameState.player.location];
                for (let dir of directions) {
                    if (room.exits[dir]) {
                        gameState.player.location = room.exits[dir];
                        output(`You flee ${dir.toUpperCase()}!`, 'system');
                        look();
                        break;
                    }
                }
            } else {
                output('You fail to flee!', 'danger');
                enemyTurn();
            }
        }

        // ====== SYSTEM FUNCTIONS ======
        function saveGame() {
            const saveData = {
                player: gameState.player,
                rooms: gameState.rooms,
                npcs: gameState.npcs,
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            localStorage.setItem('castleSave', JSON.stringify(saveData));
            output('Game saved successfully!', 'success');
        }

        function loadGame() {
            const saveData = localStorage.getItem('castleSave');
            if (!saveData) {
                output('No save game found.', 'system');
                return;
            }
            
            try {
                const save = JSON.parse(saveData);
                gameState.player = save.player;
                gameState.rooms = save.rooms;
                gameState.npcs = save.npcs || gameState.npcs;
                
                // Hide class selection, show game
                document.getElementById('classSelection').style.display = 'none';
                document.getElementById('gameInterface').style.display = 'flex';
                
                output('Game loaded successfully!', 'success');
                look();
                updateUI();
                gameActive = true;
                
                // Start game clock
                updateGameTime();
                setInterval(updateGameTime, 1000);
            } catch (e) {
                output('Error loading save game.', 'danger');
                console.error(e);
            }
        }

        function showInventory() {
            output('=== INVENTORY ===', 'system');
            
            if (gameState.player.inventory.length === 0) {
                output('Your inventory is empty.', 'system');
                return;
            }
            
            gameState.player.inventory.forEach(itemId => {
                const item = gameState.items[itemId];
                if (item) {
                    output(`${item.name} - ${item.description} (Value: ${item.value} gold)`, 'system');
                }
            });
            
            output(`Gold: ${gameState.player.gold}`, 'loot');
            output(`Weapon: ${gameState.items[gameState.player.equipped.weapon]?.name || 'None'}`, 'system');
            output(`Armor: ${gameState.items[gameState.player.equipped.armor]?.name || 'None'}`, 'system');
        }

        function help() {
            output('=== CASTLE OF THE UNDEAD - COMMANDS ===', 'system');
            output('MOVEMENT: north, south, east, west (or use arrow keys/WASD)', 'system');
            output('ACTIONS: look, search, examine, take, use, talk', 'system');
            output('COMBAT: attack, cast, flee, use item', 'system');
            output('SYSTEM: inventory, save, load, help', 'system');
            output('KEYBOARD SHORTCUTS:', 'system');
            output('  Arrow Keys/WASD/HJKL - Move', 'system');
            output('  Space/Enter - Look at room', 'system');
            output('  E - Examine', 'system');
            output('  F - Search', 'system');
            output('  T - Take all', 'system');
            output('  I - Inventory', 'system');
            output('  Y - Talk to NPC', 'system');
            output('  1-4 - Combat actions', 'system');
            output('  ? or H - Help', 'system');
            output('  O - Save game', 'system');
            output('  P - Load game', 'system');
            output('  ESC - Close menus/flee combat', 'system');
        }

        // ====== KEYBOARD CONTROLS ======
        document.addEventListener('keydown', (e) => {
            // Class selection
            if (document.getElementById('classSelection').style.display !== 'none') {
                switch(e.key) {
                    case '1':
                    case 'Digit1':
                        startGame('gravekeeper');
                        break;
                    case '2':
                    case 'Digit2':
                        startGame('bloodmage');
                        break;
                    case '3':
                    case 'Digit3':
                        startGame('exorcist');
                        break;
                    case 'Enter':
                        // Default to gravekeeper on Enter
                        startGame('gravekeeper');
                        break;
                }
                return;
            }
            
            if (!gameActive) return;
            
            switch(e.key.toUpperCase()) {
                case 'ARROWUP':
                case 'W':
                case 'K':
                    move('north');
                    e.preventDefault();
                    break;
                case 'ARROWDOWN':
                case 'S':
                case 'J':
                    move('south');
                    e.preventDefault();
                    break;
                case 'ARROWRIGHT':
                case 'D':
                case 'L':
                    move('east');
                    e.preventDefault();
                    break;
                case 'ARROWLEFT':
                case 'A':
                case 'H':
                    move('west');
                    e.preventDefault();
                    break;
                case ' ':
                case 'ENTER':
                    look();
                    e.preventDefault();
                    break;
                case 'E':
                    examine();
                    break;
                case 'F':
                    search();
                    break;
                case 'T':
                    takeAll();
                    break;
                case 'I':
                    showInventory();
                    break;
                case 'Y':
                    talk();
                    break;
                case '1':
                    if (currentEnemy) playerAttack();
                    break;
                case '2':
                    if (currentEnemy) showCombatSpells();
                    else showSpellList();
                    break;
                case '3':
                    if (currentEnemy) showCombatItems();
                    else output('Select an item from inventory to use.', 'system');
                    break;
                case '4':
                    if (currentEnemy) playerFlee();
                    else output('You are not in combat.', 'system');
                    break;
                case 'ESCAPE':
                    if (currentEnemy) endCombat(false);
                    hideShop();
                    hideSpells();
                    document.getElementById('dialogueBox').style.display = 'none';
                    document.getElementById('combatInterface').style.display = 'none';
                    break;
                case '?':
                case 'H':
                    help();
                    break;
                case 'O':
                    saveGame();
                    break;
                case 'P':
                    loadGame();
                    break;
            }
        });

        // Alias functions for button compatibility
        window.playerFlee = flee;
        window.playerAttack = playerAttack;
        window.castSpell = showSpellList;
        window.attack = playerAttack;
        window.useItem = () => {
            output('Select an item from your inventory.', 'system');
        };

        // Initialize
        window.onload = function() {
            output('Castle of the Undead - NECROPOLIS EDITION v2.0', 'danger');
            output('A text adventure game by Dark Arts Software', 'system');
            output('=============================================', 'system');
            output('Press 1, 2, 3 or click to select class...', 'system');
            
            // Auto-select first class option on Enter
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && document.getElementById('classSelection').style.display !== 'none') {
                    startGame('gravekeeper');
                }
            });
        };
    </script>
</body>
</html>
