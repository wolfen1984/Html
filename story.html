<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Story Mode - RPG</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23003300" width="100" height="100"/><path fill="%23005500" d="M0 0h100v100H0z"/></svg>');
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        #output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            line-height: 1.5;
            scroll-behavior: smooth;
        }
        
        #output::-webkit-scrollbar {
            width: 5px;
        }
        
        #output::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 10px;
        }
        
        #player-stats {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }
        
        #player-stats h3 {
            font-size: 12px;
            margin-bottom: 10px;
            color: #0f0;
            text-align: center;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        #player-stats p {
            margin: 5px 0;
        }
        
        #player-stats h4 {
            margin-top: 10px;
            font-size: 10px;
            color: #0f0;
        }
        
        #player-stats ul {
            margin-left: 15px;
            font-size: 10px;
        }
        
        #player-stats li {
            margin: 3px 0;
            word-break: break-word;
        }
        
        .gold {
            color: #fc0;
            text-shadow: 0 0 3px #fa0;
        }
        
        .npc-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .npc {
            width: 120px;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .npc:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 10px #0f0;
            background-color: rgba(0, 50, 0, 0.7);
        }
        
        .npc-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .npc-name {
            font-size: 12px;
            margin-bottom: 5px;
            color: #0f0;
        }
        
        .npc-desc {
            font-size: 9px;
            color: #aaa;
        }
        
        .castle-section {
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .castle-title {
            font-size: 14px;
            color: #0f0;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #0f0;
        }
        
        .upgrade {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .upgrade-info {
            flex: 1;
            text-align: left;
        }
        
        .upgrade-name {
            font-size: 12px;
            color: #0f0;
        }
        
        .upgrade-desc {
            font-size: 9px;
            color: #aaa;
        }
        
        .upgrade-cost {
            font-size: 11px;
            color: #fc0;
            margin-left: 10px;
        }
        
        .upgrade-btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .upgrade-btn:hover {
            background: #0f0;
            color: #000;
        }
        
        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #return-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 15px;
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 100;
        }
        
        #return-btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .shop-item {
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            background-color: rgba(0, 50, 0, 0.5);
            transform: translateY(-3px);
        }
        
        .item-name {
            font-size: 11px;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .item-desc {
            font-size: 9px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .item-cost {
            font-size: 10px;
            color: #fc0;
        }
        
        .dialog-box {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f0;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
        
        .dialog-text {
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .dialog-option {
            padding: 8px;
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .dialog-option:hover {
            background: #0f0;
            color: #000;
        }
        
        .close-dialog {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: #f00;
            font-size: 16px;
            cursor: pointer;
        }
        
        @media (max-width: 480px) {
            .npc {
                width: 100px;
            }
            
            .shop-items {
                grid-template-columns: 1fr;
            }
            
            #player-stats {
                top: 60px;
                right: 10px;
                max-width: 150px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Story Mode</h1>
        <div id="header-stats">
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
        </div>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div id="output">
                <p>Welcome to the village! Here you can interact with NPCs, buy items, and upgrade your castle.</p>
                <p>Your progress from battle mode has been loaded.</p>
            </div>
            
            <div class="castle-section">
                <div class="castle-title">YOUR CASTLE</div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Wall Defense</div>
                        <div class="upgrade-desc">Increases defense bonus in battles</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">100</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('defense')">Upgrade</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Training Grounds</div>
                        <div class="upgrade-desc">Gain more XP from battles</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">150</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('training')">Upgrade</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Treasure Vault</div>
                        <div class="upgrade-desc">Earn more gold from battles</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">200</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('vault')">Upgrade</button>
                </div>
            </div>
            
            <div class="npc-container">
                <div class="npc" onclick="interactWithNPC('blacksmith')">
                    <div class="npc-icon">⚔️</div>
                    <div class="npc-name">Blacksmith</div>
                    <div class="npc-desc">Weapons & Armor</div>
                </div>
                <div class="npc" onclick="interactWithNPC('alchemist')">
                    <div class="npc-icon">🧪</div>
                    <div class="npc-name">Alchemist</div>
                    <div class="npc-desc">Potions & Scrolls</div>
                </div>
                <div class="npc" onclick="interactWithNPC('merchant')">
                    <div class="npc-icon">🛒</div>
                    <div class="npc-name">Merchant</div>
                    <div class="npc-desc">Items & Materials</div>
                </div>
                <div class="npc" onclick="interactWithNPC('elder')">
                    <div class="npc-icon">🧙</div>
                    <div class="npc-name">Village Elder</div>
                    <div class="npc-desc">Quests & Advice</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="player-stats">
        <h3>Player Stats</h3>
        <p>Gold: <span id="stats-gold" class="gold">0</span></p>
        <p>Equipped Weapon: <span id="stats-weapon">None</span></p>
        <p>Equipped Armor: <span id="stats-armor">None</span></p>
        <h4>Inventory (<span id="stats-inv-count">0</span> items)</h4>
        <ul id="stats-inventory"></ul>
    </div>
    
    <button id="return-btn" onclick="returnToBattle()">Return to Battle</button>
    
    <div id="dialog-box" class="dialog-box">
        <button class="close-dialog" onclick="closeDialog()">×</button>
        <div id="dialog-text" class="dialog-text"></div>
        <div id="dialog-options" class="dialog-options"></div>
    </div>

    
                name: "Merchant",
                icon: "🛒",
                greeting: "Welcome, welcome! I have various goods for sale. Anything catch your eye?",
                items: [
                    { id: 9, name: "Adventurer's Pack", type: "kit", value: 100, description: "Contains useful supplies" },
                    { id: 10, name: "Ring of Protection", type: "ring", defense: 3, value: 80, description: "+3 defense" },
                    { id: 11, name: "Amulet of Health", type: "amulet", maxHealth: 20, value: 120, description: "+20 max health" },
                    { id: 12, name: "Magic Map", type: "item", value: 60, description: "Reveals hidden paths" }
                ]
            },
            elder: {
                name: "Village Elder",
                icon: "🧙",
                greeting: "Greetings, brave one. Our village is grateful for your protection. How can I assist you today?",
                services: [
                    { id: "heal", name: "Heal Wounds", cost: 0, description: "Restore your health completely" },
                    { id: "advice", name: "Seek Advice", cost: 0, description: "Get guidance for your journey" },
                    { id: "quest", name: "Request Quest", cost: 0, description: "Take on a new challenge" }
                ]
            }
        };
        
        // DOM elements
        const outputEl = document.getElementById('output');
        const headerGold = document.getElementById('header-gold');
        const statsGold = document.getElementById('stats-gold');
        const statsWeapon = document.getElementById('stats-weapon');
        const statsArmor = document.getElementById('stats-armor');
        const statsInvCount = document.getElementById('stats-inv-count');
        const statsInventory = document.getElementById('stats-inventory');
        const dialogBox = document.getElementById('dialog-box');
        const dialogText = document.getElementById('dialog-text');
        const dialogOptions = document.getElementById('dialog-options');
        
        // Initialize the page
        window.addEventListener('load', () => {
            loadPlayerState();
            updateUI();
            printMessage("You arrive at the village. The townsfolk greet you warmly.");
        });
        
        // Load player state from localStorage
        function loadPlayerState() {
            const savedState = localStorage.getItem('playerState');
            if (savedState) {
                const state = JSON.parse(savedState);
                playerState.gold = state.gold;
                playerState.inventory = state.inventory;
                playerState.equipped = state.equipped;
                
                // Load castle upgrades if they exist
                if (state.castle) {
                    playerState.castle = state.castle;
                }
            }
        }
        
        // Save player state to localStorage
        function savePlayerState() {
            localStorage.setItem('playerState', JSON.stringify(playerState));
        }
        
        // Update the UI with current player state
        function updateUI() {
            headerGold.textContent = playerState.gold;
            statsGold.textContent = playerState.gold;
            statsWeapon.textContent = playerState.equipped.weapon ? playerState.equipped.weapon.name : "None";
            statsArmor.textContent = playerState.equipped.armor ? playerState.equipped.armor.name : "None";
            statsInvCount.textContent = playerState.inventory.length;
            
            // Update inventory list
            statsInventory.innerHTML = '';
            playerState.inventory.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name;
                statsInventory.appendChild(li);
            });
            
            // Update upgrade buttons based on affordability
            updateUpgradeButtons();
        }
        
        // Print a message to the output area
        function printMessage(text, className = "") {
            const p = document.createElement('p');
            if (className) p.className = className;
            p.textContent = text;
            outputEl.appendChild(p);
            outputEl.scrollTop = outputEl.scrollHeight;
        }
        
        // Interact with an NPC
        function interactWithNPC(npcId) {
            const npc = npcs[npcId];
            dialogText.textContent = npc.greeting;
            dialogOptions.innerHTML = '';
            
            if (npcId === 'elder') {
                // Elder has services instead of items
                npc.services.forEach(service => {
                    const button = document.createElement('button');
                    button.className = 'dialog-option';
                    button.textContent = `${service.name} - ${service.description}`;
                    button.onclick = () => handleElderService(service.id);
                    dialogOptions.appendChild(button);
                });
            } else {
                // Other NPCs have items for sale
                npc.items.forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'dialog-option';
                    button.textContent = `${item.name} - ${item.description} (${item.value} gold)`;
                    button.onclick = () => buyItem(item);
                    dialogOptions.appendChild(button);
                });
            }
            
            // Add a cancel button
            const cancelButton = document.createElement('button');
            cancelButton.className = 'dialog-option';
            cancelButton.textContent = "Maybe later";
            cancelButton.onclick = closeDialog;
            dialogOptions.appendChild(cancelButton);
            
            dialogBox.style.display = 'block';
        }
        
        // Handle elder services
        function handleElderService(serviceId) {
            switch(serviceId) {
                case 'heal':
                    printMessage("The elder channels healing energy. Your wounds are completely healed!");
                    closeDialog();
                    break;
                case 'advice':
                    printMessage("The elder advises: 'Focus on upgrading your castle defenses before venturing too deep into the dungeon.'");
                    closeDialog();
                    break;
                case 'quest':
                    printMessage("The elder says: 'I have no new quests for you at the moment. Check back after your next adventure.'");
                    closeDialog();
                    break;
<script>
    // Player state
    const playerState = {
        gold: 0,
        inventory: [],
        equipped: {
            weapon: null,
            armor: null,
            ring: null,
            amulet: null
        },
        castle: {
            defense: 0,
            training: 0,
            vault: 0
        }
    };
    
    // NPC data
    const npcs = {
        blacksmith: {
            name: "Blacksmith",
            icon: "⚔️",
            greeting: "Hail, warrior! Fine weapons and armor for sale. What can I interest you in today?",
            items: [
                { id: 1, name: "Iron Sword", type: "weapon", attack: 8, value: 50, description: "A reliable iron sword" },
                { id: 2, name: "Steel Armor", type: "armor", defense: 6, value: 70, description: "Strong steel plate armor" },
                { id: 3, name: "Mithril Blade", type: "weapon", attack: 15, value: 150, description: "An enchanted mithril blade" },
                { id: 4, name: "Dragon Scale Mail", type: "armor", defense: 12, value: 200, description: "Armor made from dragon scales" }
            ]
        },
        alchemist: {
            name: "Alchemist",
            icon: "🧪",
            greeting: "Greetings, traveler! Potions and scrolls for all your adventuring needs.",
            items: [
                { id: 5, name: "Health Potion", type: "potion", health: 30, value: 20, description: "Restores 30 health" },
                { id: 6, name: "Mana Potion", type: "potion", mana: 20, value: 20, description: "Restores 20 mana" },
                { id: 7, name: "Scroll of Fireball", type: "scroll", damage: 40, value: 50, description: "Deals 40 fire damage" },
                { id: 8, name: "Elixir of Strength", type: "potion", attack: 5, duration: 3, value: 60, description: "+5 attack for 3 turns" }
            ]
        },
        merchant: {
            name: "Merchant",
            icon: "🛒",
            greeting: "Welcome, welcome! I have various goods for sale. Anything catch your eye?",
            items: [
                { id: 9, name: "Adventurer's Pack", type: "kit", value: 100, description: "Contains useful supplies" },
                { id: 10, name: "Ring of Protection", type: "ring", defense: 3, value: 80, description: "+3 defense" },
                { id: 11, name: "Amulet of Health", type: "amulet", maxHealth: 20, value: 120, description: "+20 max health" },
                { id: 12, name: "Magic Map", type: "item", value: 60, description: "Reveals hidden paths" }
            ]
        },
        elder: {
            name: "Village Elder",
            icon: "🧙",
            greeting: "Greetings, brave one. Our village is grateful for your protection. How can I assist you today?",
            services: [
                { id: "heal", name: "Heal Wounds", cost: 0, description: "Restore your health completely" },
                { id: "advice", name: "Seek Advice", cost: 0, description: "Get guidance for your journey" },
                { id: "quest", name: "Request Quest", cost: 0, description: "Take on a new challenge" }
            ]
        }
    };
    
    // DOM elements
    const outputEl = document.getElementById('output');
    const headerGold = document.getElementById('header-gold');
    const statsGold = document.getElementById('stats-gold');
    const statsWeapon = document.getElementById('stats-weapon');
    const statsArmor = document.getElementById('stats-armor');
    const statsInvCount = document.getElementById('stats-inv-count');
    const statsInventory = document.getElementById('stats-inventory');
    const dialogBox = document.getElementById('dialog-box');
    const dialogText = document.getElementById('dialog-text');
    const dialogOptions = document.getElementById('dialog-options');
    
    // Initialize the page
    window.addEventListener('load', () => {
        loadPlayerState();
        updateUI();
        printMessage("You arrive at the village. The townsfolk greet you warmly.");
    });
    
    // Load player state from localStorage
    function loadPlayerState() {
        // First try to load from battle state
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                playerState.gold = state.player.gold;
                playerState.inventory = state.player.inventory;
                playerState.equipped = state.player.equipped;
                
                // Load castle upgrades if they exist in localStorage
                const savedPlayerState = localStorage.getItem('playerState');
                if (savedPlayerState) {
                    const storyState = JSON.parse(savedPlayerState);
                    playerState.castle = storyState.castle;
                }
            } catch (e) {
                console.error("Error loading battle state:", e);
            }
        }
    }
    
    // Save player state to localStorage
    function savePlayerState() {
        localStorage.setItem('playerState', JSON.stringify(playerState));
    }
    
    // Update the UI with current player state
    function updateUI() {
        headerGold.textContent = playerState.gold;
        statsGold.textContent = playerState.gold;
        statsWeapon.textContent = playerState.equipped.weapon ? playerState.equipped.weapon.name : "None";
        statsArmor.textContent = playerState.equipped.armor ? playerState.equipped.armor.name : "None";
        statsInvCount.textContent = playerState.inventory.length;
        
        // Update inventory list
        statsInventory.innerHTML = '';
        playerState.inventory.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item.name;
            statsInventory.appendChild(li);
        });
        
        // Update upgrade buttons based on affordability
        updateUpgradeButtons();
    }
    
    // Print a message to the output area
    function printMessage(text, className = "") {
        const p = document.createElement('p');
        if (className) p.className = className;
        p.textContent = text;
        outputEl.appendChild(p);
        outputEl.scrollTop = outputEl.scrollHeight;
    }
    
    // Interact with an NPC
    function interactWithNPC(npcId) {
        const npc = npcs[npcId];
        dialogText.textContent = npc.greeting;
        dialogOptions.innerHTML = '';
        
        if (npcId === 'elder') {
            // Elder has services instead of items
            npc.services.forEach(service => {
                const button = document.createElement('button');
                button.className = 'dialog-option';
                button.textContent = `${service.name} - ${service.description}`;
                button.onclick = () => handleElderService(service.id);
                dialogOptions.appendChild(button);
            });
        } else {
            // Other NPCs have items for sale
            npc.items.forEach(item => {
                const button = document.createElement('button');
                button.className = 'dialog-option';
                button.textContent = `${item.name} - ${item.description} (${item.value} gold)`;
                button.onclick = () => buyItem(item);
                dialogOptions.appendChild(button);
            });
        }
        
        // Add a cancel button
        const cancelButton = document.createElement('button');
        cancelButton.className = 'dialog-option';
        cancelButton.textContent = "Maybe later";
        cancelButton.onclick = closeDialog;
        dialogOptions.appendChild(cancelButton);
        
        dialogBox.style.display = 'block';
    }
    
    // Handle elder services
    function handleElderService(serviceId) {
        switch(serviceId) {
            case 'heal':
                printMessage("The elder channels healing energy. Your wounds are completely healed!");
                closeDialog();
                break;
            case 'advice':
                printMessage("The elder advises: 'Focus on upgrading your castle defenses before venturing too deep into the dungeon.'");
                closeDialog();
                break;
            case 'quest':
                printMessage("The elder says: 'I have no new quests for you at the moment. Check back after your next adventure.'");
                closeDialog();
                break;
        }
    }
    
    // Buy an item from an NPC
    function buyItem(item) {
        if (playerState.gold >= item.value) {
            playerState.gold -= item.value;
            playerState.inventory.push(item);
            printMessage(`You bought ${item.name} for ${item.value} gold.`, "success");
            savePlayerState();
            updateUI();
            closeDialog();
        } else {
            printMessage("You don't have enough gold for that!", "error");
            closeDialog();
        }
    }
    
    // Upgrade the castle
    function upgradeCastle(type) {
        let cost = 0;
        let currentLevel = 0;
        
        switch(type) {
            case 'defense':
                currentLevel = playerState.castle.defense;
                cost = 100 + (currentLevel * 50);
                break;
            case 'training':
                currentLevel = playerState.castle.training;
                cost = 150 + (currentLevel * 75);
                break;
            case 'vault':
                currentLevel = playerState.castle.vault;
                cost = 200 + (currentLevel * 100);
                break;
        }
        
        if (playerState.gold >= cost) {
            playerState.gold -= cost;
            playerState.castle[type]++;
            
            printMessage(`You upgraded your castle's ${type} to level ${playerState.castle[type]} for ${cost} gold.`, "success");
            savePlayerState();
            updateUI();
        } else {
            printMessage(`You need ${cost} gold to upgrade that!`, "error");
        }
    }
    
    // Update upgrade buttons based on affordability
    function updateUpgradeButtons() {
        const defenseCost = 100 + (playerState.castle.defense * 50);
        const trainingCost = 150 + (playerState.castle.training * 75);
        const vaultCost = 200 + (playerState.castle.vault * 100);
        
        document.querySelectorAll('.upgrade-btn')[0].innerHTML = 
            playerState.gold >= defenseCost ? "Upgrade" : "Too Expensive";
        document.querySelectorAll('.upgrade-btn')[0].disabled = 
            playerState.gold < defenseCost;
            
        document.querySelectorAll('.upgrade-cost')[0].innerHTML = 
            `Cost: <span class="gold">${defenseCost}</span> gold`;
            
        document.querySelectorAll('.upgrade-btn')[1].innerHTML = 
            playerState.gold >= trainingCost ? "Upgrade" : "Too Expensive";
        document.querySelectorAll('.upgrade-btn')[1].disabled = 
            playerState.gold < trainingCost;
            
        document.querySelectorAll('.upgrade-cost')[1].innerHTML = 
            `Cost: <span class="gold">${trainingCost}</span> gold`;
            
        document.querySelectorAll('.upgrade-btn')[2].innerHTML = 
            playerState.gold >= vaultCost ? "Upgrade" : "Too Expensive";
        document.querySelectorAll('.upgrade-btn')[2].disabled = 
            playerState.gold < vaultCost;
            
        document.querySelectorAll('.upgrade-cost')[2].innerHTML = 
            `Cost: <span class="gold">${vaultCost}</span> gold`;
    }
    
    // Close the dialog box
    function closeDialog() {
        dialogBox.style.display = 'none';
    }
    
    // Return to battle mode
    function returnToBattle() {
        // Save the current player state
        savePlayerState();
        
        // Also update the battle state with any changes
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                state.player.gold = playerState.gold;
                state.player.inventory = playerState.inventory;
                state.player.equipped = playerState.equipped;
                localStorage.setItem('sanctuaryRPG_save', JSON.stringify(state));
            } catch (e) {
                console.error("Error updating battle state:", e);
            }
        }
        
        window.location.href = 'battle.html';
    }
</script>
</body>
</html>
