<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle Crafting - Build & Upgrade</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
            flex-wrap: wrap;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            margin-right: auto;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
            margin: 0 10px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #btn-back, #btn-quests {
            background: #300;
            color: #f88;
            border: 2px solid #f88;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
        }

        #btn-back:hover, #btn-back:active, #btn-quests:hover, #btn-quests:active {
            background: #f88;
            color: #300;
            box-shadow: 0 0 10px #f88;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        /* Castle visualization */
        #castle-visualization {
            height: 150px;
            background-color: #222;
            border: 2px solid #0f0;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        
        .castle-part {
            position: absolute;
            bottom: 0;
            transition: all 0.5s ease;
        }
        
        #castle-foundation {
            width: 80%;
            height: 30px;
            background-color: #753;
            border: 2px solid #642;
            z-index: 1;
        }
        
        #castle-walls {
            width: 70%;
            height: 70px;
            background-color: #999;
            border: 2px solid #777;
            z-index: 2;
            display: none;
        }
        
        #castle-towers {
            width: 60%;
            height: 100px;
            background-color: #888;
            border: 2px solid #666;
            z-index: 3;
            display: none;
        }
        
        #castle-keep {
            width: 50%;
            height: 120px;
            background-color: #aaa;
            border: 2px solid #888;
            z-index: 4;
            display: none;
        }
        
        /* Tab navigation */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #0f0;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 2px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            background-color: #000;
            color: #0f0;
            font-size: 10px;
        }
        
        .tab.active {
            background-color: #0f0;
            color: #000;
            border-color: #0f0;
        }
        
        .tab-content {
            display: none;
            padding: 10px;
            overflow-y: auto;
            height: calc(100% - 50px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Building styles */
        .building {
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .building-title {
            color: #af0;
            font-size: 12px;
        }
        
        .building-level {
            font-size: 10px;
            color: #fc0;
            background: #300;
            padding: 3px 6px;
            border-radius: 10px;
        }
        
        .building-description {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
        }
        
        .building-stats {
            font-size: 10px;
            color: #5cf;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        .building-cost {
            font-size: 10px;
            color: #f55;
            margin-bottom: 10px;
        }
        
        .building-button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 10px;
            width: 100%;
        }
        
        .building-button:hover {
            background: #0f0;
            color: #000;
        }
        
        .building-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            color: #f55;
            border-color: #f55;
        }
        
        /* Empty state message */
        .empty-state {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            #header h1 {
                font-size: 12px;
            }
            
            .header-stat {
                font-size: 9px;
            }
            
            .tab {
                padding: 6px 8px;
                font-size: 9px;
            }
            
            .building-title {
                font-size: 11px;
            }
            
            #castle-visualization {
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Castle Crafting - Build & Upgrade</h1>
        <div id="header-stats">
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
            <div class="header-stat">Materials: <span id="header-materials">0</span></div>
        </div>
        <button id="btn-back">Back to Castle</button>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <!-- Castle Visualization -->
            <div id="castle-visualization">
                <div id="castle-foundation" class="castle-part"></div>
                <div id="castle-walls" class="castle-part"></div>
                <div id="castle-towers" class="castle-part"></div>
                <div id="castle-keep" class="castle-part"></div>
            </div>
            
            <div class="tab-container">
                <div class="tab active" data-tab="structures">Structures</div>
                <div class="tab" data-tab="defenses">Defenses</div>
                <div class="tab" data-tab="resources">Resources</div>
                <div class="tab" data-tab="upgrades">Upgrades</div>
            </div>
            
            <!-- Structures Tab -->
            <div class="tab-content active" id="structures-tab">
                <!-- Structures will be dynamically added here -->
            </div>
            
            <!-- Defenses Tab -->
            <div class="tab-content" id="defenses-tab">
                <!-- Defenses will be dynamically added here -->
            </div>
            
            <!-- Resources Tab -->
            <div class="tab-content" id="resources-tab">
                <!-- Resources will be dynamically added here -->
            </div>
            
            <!-- Upgrades Tab -->
            <div class="tab-content" id="upgrades-tab">
                <!-- Upgrades will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Main game state key
        const MAIN_GAME_SAVE_KEY = 'castleCrafting_save';
        
        // Castle crafting state
        const castleState = {
            gold: 0,
            materials: 0,
            structures: {
                foundation: { level: 0, maxLevel: 1 },
                walls: { level: 0, maxLevel: 5 },
                towers: { level: 0, maxLevel: 4 },
                keep: { level: 0, maxLevel: 3 },
                barracks: { level: 0, maxLevel: 3 },
                forge: { level: 0, maxLevel: 3 }
            },
            defenses: {
                archerTowers: { level: 0, maxLevel: 4 },
                gatehouse: { level: 0, maxLevel: 3 },
                moat: { level: 0, maxLevel: 2 },
                ballistae: { level: 0, maxLevel: 3 }
            },
            resources: {
                goldMine: { level: 0, maxLevel: 5 },
                quarry: { level: 0, maxLevel: 5 },
                farm: { level: 0, maxLevel: 4 },
                market: { level: 0, maxLevel: 3 }
            },
            upgrades: {
                workerEfficiency: { level: 0, maxLevel: 5 },
                constructionSpeed: { level: 0, maxLevel: 5 },
                resourceProduction: { level: 0, maxLevel: 5 }
            },
            lastUpdate: Date.now()
        };

        // Building definitions with costs and benefits
        const buildingDefinitions = {
            // Structures
            foundation: {
                name: "Foundation",
                description: "The base of your castle. Required before building anything else.",
                costs: [{ level: 1, gold: 100, materials: 200 }],
                benefits: "Unlocks other structures"
            },
            walls: {
                name: "Walls",
                description: "Protective walls around your castle.",
                costs: [
                    { level: 1, gold: 150, materials: 300 },
                    { level: 2, gold: 300, materials: 600 },
                    { level: 3, gold: 600, materials: 1200 },
                    { level: 4, gold: 1200, materials: 2400 },
                    { level: 5, gold: 2400, materials: 4800 }
                ],
                benefits: "Increases castle defense and prestige"
            },
            towers: {
                name: "Guard Towers",
                description: "Towers for lookouts and archers.",
                costs: [
                    { level: 1, gold: 200, materials: 400 },
                    { level: 2, gold: 400, materials: 800 },
                    { level: 3, gold: 800, materials: 1600 },
                    { level: 4, gold: 1600, materials: 3200 }
                ],
                benefits: "Improves defense and provides vantage points"
            },
            keep: {
                name: "Main Keep",
                description: "The central stronghold of your castle.",
                costs: [
                    { level: 1, gold: 500, materials: 1000 },
                    { level: 2, gold: 1000, materials: 2000 },
                    { level: 3, gold: 2000, materials: 4000 }
                ],
                benefits: "Increases prestige and provides living quarters"
            },
            barracks: {
                name: "Barracks",
                description: "Housing for your soldiers and guards.",
                costs: [
                    { level: 1, gold: 300, materials: 400 },
                    { level: 2, gold: 600, materials: 800 },
                    { level: 3, gold: 1200, materials: 1600 }
                ],
                benefits: "Allows training of more advanced units"
            },
            forge: {
                name: "Blacksmith Forge",
                description: "Craft weapons and armor for your troops.",
                costs: [
                    { level: 1, gold: 250, materials: 500 },
                    { level: 2, gold: 500, materials: 1000 },
                    { level: 3, gold: 1000, materials: 2000 }
                ],
                benefits: "Improves equipment quality and production speed"
            },
            
            // Defenses
            archerTowers: {
                name: "Archer Towers",
                description: "Specialized towers for archers with improved range.",
                costs: [
                    { level: 1, gold: 200, materials: 300 },
                    { level: 2, gold: 400, materials: 600 },
                    { level: 3, gold: 800, materials: 1200 },
                    { level: 4, gold: 1600, materials: 2400 }
                ],
                benefits: "Greatly improves ranged defense capabilities"
            },
            gatehouse: {
                name: "Reinforced Gatehouse",
                description: "Strengthen the main entrance to your castle.",
                costs: [
                    { level: 1, gold: 300, materials: 400 },
                    { level: 2, gold: 600, materials: 800 },
                    { level: 3, gold: 1200, materials: 1600 }
                ],
                benefits: "Makes your castle entrance more secure"
            },
            moat: {
                name: "Moat",
                description: "A water-filled ditch surrounding your castle walls.",
                costs: [
                    { level: 1, gold: 500, materials: 1000 },
                    { level: 2, gold: 1000, materials: 2000 }
                ],
                benefits: "Provides excellent defense against siege equipment"
            },
            ballistae: {
                name: "Ballistae",
                description: "Large crossbows for defending against sieges.",
                costs: [
                    { level: 1, gold: 400, materials: 600 },
                    { level: 2, gold: 800, materials: 1200 },
                    { level: 3, gold: 1600, materials: 2400 }
                ],
                benefits: "Effective against siege equipment and large targets"
            },
            
            // Resources
            goldMine: {
                name: "Gold Mine",
                description: "Produces gold over time.",
                costs: [
                    { level: 1, gold: 200, materials: 100 },
                    { level: 2, gold: 400, materials: 200 },
                    { level: 3, gold: 800, materials: 400 },
                    { level: 4, gold: 1600, materials: 800 },
                    { level: 5, gold: 3200, materials: 1600 }
                ],
                benefits: "Generates gold automatically"
            },
            quarry: {
                name: "Stone Quarry",
                description: "Produces building materials over time.",
                costs: [
                    { level: 1, gold: 100, materials: 200 },
                    { level: 2, gold: 200, materials: 400 },
                    { level: 3, gold: 400, materials: 800 },
                    { level: 4, gold: 800, materials: 1600 },
                    { level: 5, gold: 1600, materials: 3200 }
                ],
                benefits: "Generates materials automatically"
            },
            farm: {
                name: "Farm",
                description: "Produces food for your population.",
                costs: [
                    { level: 1, gold: 150, materials: 100 },
                    { level: 2, gold: 300, materials: 200 },
                    { level: 3, gold: 600, materials: 400 },
                    { level: 4, gold: 1200, materials: 800 }
                ],
                benefits: "Supports larger population and armies"
            },
            market: {
                name: "Marketplace",
                description: "Generates tax income and allows trading.",
                costs: [
                    { level: 1, gold: 300, materials: 150 },
                    { level: 2, gold: 600, materials: 300 },
                    { level: 3, gold: 1200, materials: 600 }
                ],
                benefits: "Increases gold income from taxes and trade"
            },
            
            // Upgrades
            workerEfficiency: {
                name: "Worker Efficiency",
                description: "Improves the efficiency of your workers.",
                costs: [
                    { level: 1, gold: 200, materials: 100 },
                    { level: 2, gold: 400, materials: 200 },
                    { level: 3, gold: 800, materials: 400 },
                    { level: 4, gold: 1600, materials: 800 },
                    { level: 5, gold: 3200, materials: 1600 }
                ],
                benefits: "Reduces construction time and cost"
            },
            constructionSpeed: {
                name: "Construction Speed",
                description: "Increases how quickly buildings are constructed.",
                costs: [
                    { level: 1, gold: 150, materials: 150 },
                    { level: 2, gold: 300, materials: 300 },
                    { level: 3, gold: 600, materials: 600 },
                    { level: 4, gold: 1200, materials: 1200 },
                    { level: 5, gold: 2400, materials: 2400 }
                ],
                benefits: "Buildings complete faster"
            },
            resourceProduction: {
                name: "Resource Production",
                description: "Increases output from resource buildings.",
                costs: [
                    { level: 1, gold: 250, materials: 100 },
                    { level: 2, gold: 500, materials: 200 },
                    { level: 3, gold: 1000, materials: 400 },
                    { level: 4, gold: 2000, materials: 800 },
                    { level: 5, gold: 4000, materials: 1600 }
                ],
                benefits: "Resource buildings produce more"
            }
        };

        // DOM Elements
        const headerGold = document.getElementById('header-gold');
        const headerMaterials = document.getElementById('header-materials');
        const btnBack = document.getElementById('btn-back');
        const btnQuests = document.getElementById('btn-quests');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const toastEl = document.getElementById('toast');
        const castleFoundation = document.getElementById('castle-foundation');
        const castleWalls = document.getElementById('castle-walls');
        const castleTowers = document.getElementById('castle-towers');
        const castleKeep = document.getElementById('castle-keep');

        // Initialize the page
        window.addEventListener('load', () => {
            // Load game state from localStorage
            loadGameState();
            
            // Update UI with loaded data
            updateUI();
            updateCastleVisualization();
            
            // Set up tab navigation
            setupTabs();
            
            // Render all tabs
            renderStructures();
            renderDefenses();
            renderResources();
            renderUpgrades();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up button actions
            btnBack.addEventListener('click', goBackToCastle);
            btnQuests.addEventListener('click', goToQuests);
            
            // Start resource production timer
            startResourceTimer();
            
            // Save game state when page is about to be unloaded
            window.addEventListener('beforeunload', saveGameState);
        });

        // Function to load gold from main game save
        function loadGoldFromMainGame() {
            try {
                const mainSaveData = localStorage.getItem('sanctuaryRPG_save');
                if (mainSaveData) {
                    const mainState = JSON.parse(mainSaveData);
                    
                    // Update gold from main game
                    if (mainState.player && mainState.player.gold !== undefined) {
                        castleState.gold = mainState.player.gold;
                        updateUI();
                    }
                }
            } catch (e) {
                console.error("Failed to load gold from main game:", e);
            }
        }

        // Function to load materials from main game save
        function loadMaterialsFromMainGame() {
            try {
                const mainSaveData = localStorage.getItem('sanctuaryRPG_save');
                if (mainSaveData) {
                    const mainState = JSON.parse(mainSaveData);
                    
                    // Update materials from main game
                    if (mainState.player && mainState.player.materials !== undefined) {
                        castleState.materials = mainState.player.materials;
                        updateUI();
                    }
                }
            } catch (e) {
                console.error("Failed to load materials from main game:", e);
            }
        }

        function loadGameState() {
            try {
                // First try to load from main game save
                const mainSaveData = localStorage.getItem(MAIN_GAME_SAVE_KEY);
                if (mainSaveData) {
                    const mainState = JSON.parse(mainSaveData);
                    
                    // Load gold and materials from main game
                    if (mainState.gold !== undefined) castleState.gold = mainState.gold;
                    if (mainState.materials !== undefined) castleState.materials = mainState.materials;
                }
                
                // Then load castle-specific data
                const castleSaveData = localStorage.getItem('castleCrafting_save');
                if (castleSaveData) {
                    const loadedState = JSON.parse(castleSaveData);
                    
                    // Load structures
                    if (loadedState.structures) castleState.structures = loadedState.structures;
                    if (loadedState.defenses) castleState.defenses = loadedState.defenses;
                    if (loadedState.resources) castleState.resources = loadedState.resources;
                    if (loadedState.upgrades) castleState.upgrades = loadedState.upgrades;
                    if (loadedState.lastUpdate) castleState.lastUpdate = loadedState.lastUpdate;
                    
                    // Load materials from castle save if not loaded from main game
                    if (loadedState.materials !== undefined && castleState.materials === 0) {
                        castleState.materials = loadedState.materials;
                    }
                }
                
                // Load from main game
                loadGoldFromMainGame();
                loadMaterialsFromMainGame();
            } catch (e) {
                console.error("Failed to load game state:", e);
            }
        }

        function saveGameState() {
            try {
                const saveData = {
                    gold: castleState.gold,
                    materials: castleState.materials,
                    structures: castleState.structures,
                    defenses: castleState.defenses,
                    resources: castleState.resources,
                    upgrades: castleState.upgrades,
                    lastUpdate: Date.now()
                };
                
                localStorage.setItem('castleCrafting_save', JSON.stringify(saveData));
                
                // Also update the main game state with current gold and materials
                const mainSaveData = localStorage.getItem('sanctuaryRPG_save');
                let mainState = {};
                
                if (mainSaveData) {
                    mainState = JSON.parse(mainSaveData);
                }
                
                // Update gold and materials in main game state
                if (mainState.player) {
                    mainState.player.gold = castleState.gold;
                    mainState.player.materials = castleState.materials;
                } else {
                    // If player object doesn't exist in main state, create it
                    mainState.player = { 
                        gold: castleState.gold, 
                        materials: castleState.materials 
                    };
                }
                
                // Save the main game state
                localStorage.setItem('sanctuaryRPG_save', JSON.stringify(mainState));
            } catch (e) {
                console.error("Failed to save game state:", e);
            }
        }

        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        function setupEventListeners() {
            // Any additional event listeners can be set up here
        }

        function renderStructures() {
            const container = document.getElementById('structures-tab');
            container.innerHTML = '';
            
            Object.keys(castleState.structures).forEach(structureId => {
                const structure = castleState.structures[structureId];
                const definition = buildingDefinitions[structureId];
                const nextLevel = structure.level + 1;
                
                const canAfford = nextLevel <= definition.costs.length && 
                                 castleState.gold >= definition.costs[nextLevel-1].gold && 
                                 castleState.materials >= definition.costs[nextLevel-1].materials;
                
                const structureElement = document.createElement('div');
                structureElement.className = 'building';
                structureElement.innerHTML = `
                    <div class="building-header">
                        <div class="building-title">${definition.name}</div>
                        <div class="building-level">Level ${structure.level}/${structure.maxLevel}</div>
                    </div>
                    <div class="building-description">${definition.description}</div>
                    <div class="building-stats">
                        <div>Benefit: ${definition.benefits}</div>
                    </div>
                    ${nextLevel <= structure.maxLevel ? 
                        `<div class="building-cost">Upgrade Cost: ${definition.costs[nextLevel-1].gold} Gold, ${definition.costs[nextLevel-1].materials} Materials</div>
                         <button class="building-button" data-building="${structureId}" ${canAfford ? '' : 'disabled'}>
                            Upgrade to Level ${nextLevel}
                         </button>` :
                        `<div class="building-cost">Fully upgraded</div>
                         <button class="building-button" disabled>Fully Upgraded</button>`
                    }
                `;
                container.appendChild(structureElement);
                
                // Add event listener to the button if not disabled
                if (nextLevel <= structure.maxLevel && canAfford) {
                    const button = structureElement.querySelector('.building-button');
                    button.addEventListener('click', () => {
                        upgradeBuilding('structures', structureId);
                    });
                }
            });
        }

        function renderDefenses() {
            const container = document.getElementById('defenses-tab');
            container.innerHTML = '';
            
            Object.keys(castleState.defenses).forEach(defenseId => {
                const defense = castleState.defenses[defenseId];
                const definition = buildingDefinitions[defenseId];
                const nextLevel = defense.level + 1;
                
                const canAfford = nextLevel <= definition.costs.length && 
                                 castleState.gold >= definition.costs[nextLevel-1].gold && 
                                 castleState.materials >= definition.costs[nextLevel-1].materials;
                
                const defenseElement = document.createElement('div');
                defenseElement.className = 'building';
                defenseElement.innerHTML = `
                    <div class="building-header">
                        <div class="building-title">${definition.name}</div>
                        <div class="building-level">Level ${defense.level}/${defense.maxLevel}</div>
                    </div>
                    <div class="building-description">${definition.description}</div>
                    <div class="building-stats">
                        <div>Benefit: ${definition.benefits}</div>
                    </div>
                    ${nextLevel <= defense.maxLevel ? 
                        `<div class="building-cost">Upgrade Cost: ${definition.costs[nextLevel-1].gold} Gold, ${definition.costs[nextLevel-1].materials} Materials</div>
                         <button class="building-button" data-building="${defenseId}" ${canAfford ? '' : 'disabled'}>
                            Upgrade to Level ${nextLevel}
                         </button>` :
                        `<div class="building-cost">Fully upgraded</div>
                         <button class="building-button" disabled>Fully Upgraded</button>`
                    }
                `;
                container.appendChild(defenseElement);
                
                // Add event listener to the button if not disabled
                if (nextLevel <= defense.maxLevel && canAfford) {
                    const button = defenseElement.querySelector('.building-button');
                    button.addEventListener('click', () => {
                        upgradeBuilding('defenses', defenseId);
                    });
                }
            });
        }

        function renderResources() {
            const container = document.getElementById('resources-tab');
            container.innerHTML = '';
            
            Object.keys(castleState.resources).forEach(resourceId => {
                const resource = castleState.resources[resourceId];
                const definition = buildingDefinitions[resourceId];
                const nextLevel = resource.level + 1;
                
                const canAfford = nextLevel <= definition.costs.length && 
                                 castleState.gold >= definition.costs[nextLevel-1].gold && 
                                 castleState.materials >= definition.costs[nextLevel-1].materials;
                
                const resourceElement = document.createElement('div');
                resourceElement.className = 'building';
                resourceElement.innerHTML = `
                    <div class="building-header">
                        <div class="building-title">${definition.name}</div>
                        <div class="building-level">Level ${resource.level}/${resource.maxLevel}</div>
                    </div>
                    <div class="building-description">${definition.description}</div>
                    <div class="building-stats">
                        <div>Benefit: ${definition.benefits}</div>
                        ${resource.level > 0 ? `<div>Production: ${calculateProduction(resourceId)}/min</div>` : ''}
                    </div>
                    ${nextLevel <= resource.maxLevel ? 
                        `<div class="building-cost">Upgrade Cost: ${definition.costs[nextLevel-1].gold} Gold, ${definition.costs[nextLevel-1].materials} Materials</div>
                         <button class="building-button" data-building="${resourceId}" ${canAfford ? '' : 'disabled'}>
                            Upgrade to Level ${nextLevel}
                         </button>` :
                        `<div class="building-cost">Fully upgraded</div>
                         <button class="building-button" disabled>Fully Upgraded</button>`
                    }
                `;
                container.appendChild(resourceElement);
                
                // Add event listener to the button if not disabled
                if (nextLevel <= resource.maxLevel && canAfford) {
                    const button = resourceElement.querySelector('.building-button');
                    button.addEventListener('click', () => {
                        upgradeBuilding('resources', resourceId);
                    });
                }
            });
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-tab');
            container.innerHTML = '';
            
            Object.keys(castleState.upgrades).forEach(upgradeId => {
                const upgrade = castleState.upgrades[upgradeId];
                const definition = buildingDefinitions[upgradeId];
                const nextLevel = upgrade.level + 1;
                
                const canAfford = nextLevel <= definition.costs.length && 
                                 castleState.gold >= definition.costs[nextLevel-1].gold && 
                                 castleState.materials >= definition.costs[nextLevel-1].materials;
                
                const upgradeElement = document.createElement('div');
                upgradeElement.className = 'building';
                upgradeElement.innerHTML = `
                    <div class="building-header">
                        <div class="building-title">${definition.name}</div>
                        <div class="building-level">Level ${upgrade.level}/${upgrade.maxLevel}</div>
                    </div>
                    <div class="building-description">${definition.description}</div>
                    <div class="building-stats">
                        <div>Benefit: ${definition.benefits}</div>
                    </div>
                    ${nextLevel <= upgrade.maxLevel ? 
                        `<div class="building-cost">Upgrade Cost: ${definition.costs[nextLevel-1].gold} Gold, ${definition.costs[nextLevel-1].materials} Materials</div>
                         <button class="building-button" data-building="${upgradeId}" ${canAfford ? '' : 'disabled'}>
                            Upgrade to Level ${nextLevel}
                         </button>` :
                        `<div class="building-cost">Fully upgraded</div>
                         <button class="building-button" disabled>Fully Upgraded</button>`
                    }
                `;
                container.appendChild(upgradeElement);
                
                // Add event listener to the button if not disabled
                if (nextLevel <= upgrade.maxLevel && canAfford) {
                    const button = upgradeElement.querySelector('.building-button');
                    button.addEventListener('click', () => {
                        upgradeBuilding('upgrades', upgradeId);
                    });
                }
            });
        }

        function upgradeBuilding(category, buildingId) {
            const building = castleState[category][buildingId];
            const definition = buildingDefinitions[buildingId];
            const nextLevel = building.level + 1;
            
            if (nextLevel > building.maxLevel) {
                showToast("This building is already at maximum level!", "error");
                return;
            }
            
            const cost = definition.costs[nextLevel-1];
            
            if (castleState.gold < cost.gold || castleState.materials < cost.materials) {
                showToast("Not enough resources to upgrade!", "error");
                return;
            }
            
            // Deduct costs
            castleState.gold -= cost.gold;
            castleState.materials -= cost.materials;
            
            // Upgrade building
            building.level = nextLevel;
            
            // Update UI
            updateUI();
            updateCastleVisualization();
            
            // Re-render the appropriate tab
            if (category === 'structures') renderStructures();
            else if (category === 'defenses') renderDefenses();
            else if (category === 'resources') renderResources();
            else if (category === 'upgrades') renderUpgrades();
            
            // Save game state
            saveGameState();
            
            // Show success message
            showToast(`${definition.name} upgraded to level ${nextLevel}!`);
        }

        function calculateProduction(buildingId) {
            const level = castleState.resources[buildingId].level;
            if (level === 0) return 0;
            
            // Base production rates
            const baseRates = {
                goldMine: 10,
                quarry: 5,
                farm: 8,
                market: 12
            };
            
            // Apply upgrades
            const upgradeMultiplier = 1 + (castleState.upgrades.resourceProduction.level * 0.2);
            
            return Math.floor(baseRates[buildingId] * level * upgradeMultiplier);
        }

        function startResourceTimer() {
            // Update resource production every minute
            setInterval(() => {
                let producedAnything = false;
                
                // Gold mine production
                if (castleState.resources.goldMine.level > 0) {
                    const production = calculateProduction('goldMine');
                    castleState.gold += production;
                    producedAnything = true;
                }
                
                // Quarry production
                if (castleState.resources.quarry.level > 0) {
                    const production = calculateProduction('quarry');
                    castleState.materials += production;
                    producedAnything = true;
                }
                
                if (producedAnything) {
                    updateUI();
                    saveGameState();
                }
            }, 60000); // Every minute
        }

        function updateCastleVisualization() {
            // Show/hide castle parts based on their level
            castleFoundation.style.display = castleState.structures.foundation.level > 0 ? 'block' : 'none';
            castleWalls.style.display = castleState.structures.walls.level > 0 ? 'block' : 'none';
            castleTowers.style.display = castleState.structures.towers.level > 0 ? 'block' : 'none';
            castleKeep.style.display = castleState.structures.keep.level > 0 ? 'block' : 'none';
            
            // Adjust visual appearance based on level
            if (castleState.structures.walls.level > 0) {
                castleWalls.style.height = `${30 + castleState.structures.walls.level * 10}px`;
            }
            
            if (castleState.structures.towers.level > 0) {
                castleTowers.style.height = `${80 + castleState.structures.towers.level * 10}px`;
            }
            
            if (castleState.structures.keep.level > 0) {
                castleKeep.style.height = `${100 + castleState.structures.keep.level * 15}px`;
            }
        }

        function updateUI() {
            headerGold.textContent = castleState.gold;
            headerMaterials.textContent = castleState.materials;
        }

        function goBackToCastle() {
            // Save game state before navigating back
            saveGameState();
            
            // Navigate back to the castle page
            window.location.href = 'sanc2.html';
        }

        function showToast(message, type = "success") {
            toastEl.textContent = message;
            toastEl.className = `toast show ${type}`;
            
            setTimeout(() => {
                toastEl.className = 'toast';
            }, 3000);
        }

        // Add this to your page's event listeners
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is visible again, likely returning from another page
                loadGoldFromMainGame();
                loadMaterialsFromMainGame();
            }
        });
    </script>
</body>
</html>
