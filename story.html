  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG - Story Mode</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        #story-output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            line-height: 1.5;
            scroll-behavior: smooth;
        }
        
        #story-output::-webkit-scrollbar {
            width: 5px;
        }
        
        #story-output::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 10px;
        }
        
        #story-map {
            height: 200px;
            margin-bottom: 15px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: #111;
            position: relative;
            overflow: hidden;
        }
        
        .map-tile {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .map-tile.grass {
            background-color: #131;
        }
        
        .map-tile.path {
            background-color: #321;
        }
        
        .map-tile.water {
            background-color: #115;
        }
        
        .map-tile.town {
            background-color: #311;
        }
        
        .map-tile.forest {
            background-color: #031;
        }
        
        .map-tile.mountain {
            background-color: #444;
        }
        
        .player-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #0af;
            border: 2px solid #0ff;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 10px #0ff;
            transition: all 0.5s ease;
        }
        
        .npc-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #f0a;
            border: 2px solid #f0f;
            border-radius: 50%;
            z-index: 5;
        }
        
        .item-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #fc0;
            border: 2px solid #ff0;
            border-radius: 50%;
            z-index: 3;
        }
        
        #story-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        #action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .story-btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            padding: 12px 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .story-btn:active, .story-btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
            transform: translateY(-2px);
        }
        
        .direction-btn {
            font-size: 16px;
            padding: 15px 5px;
        }
        
        #btn-battle {
            background: #300;
            color: #f88;
            border-color: #f88;
        }
        
        #btn-battle:active, #btn-battle:hover {
            background: #f88;
            color: #300;
            box-shadow: 0 0 10px #f88;
        }
        
        /* Text styles */
        .npc {
            color: #aaf;
            text-shadow: 0 0 3px #00f;
        }
        
        .location {
            color: #fa0;
            text-shadow: 0 0 3px #f80;
        }
        
        .story-item {
            color: #ff0;
        }
        
        .dialog {
            color: #afa;
            font-style: italic;
            border-left: 3px solid #0f0;
            padding-left: 10px;
            margin: 5px 0;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 480px) {
            #header h1 {
                font-size: 12px;
            }
            
            .header-stat {
                font-size: 9px;
            }
            
            .story-btn {
                padding: 14px 5px;
                font-size: 11px;
            }
            
            #story-output {
                font-size: 13px;
            }
            
            .map-tile {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 380px) {
            #header {
                flex-direction: column;
                gap: 8px;
                padding: 8px;
            }
            
            #header-stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .story-btn {
                font-size: 10px;
                padding: 12px 3px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>RPG - Story Mode</h1>
        <div id="header-stats">
            <div class="header-stat">Lvl: <span id="header-level">1</span></div>
            <div class="header-stat">Gold: <span id="header-gold">50</span></div>
            <div class="header-stat">Location: <span id="header-location">Town</span></div>
        </div>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div id="story-map">
                <!-- Map will be generated by JavaScript -->
            </div>
            
            <div id="story-output"></div>
            
            <div id="story-controls">
                <button class="story-btn direction-btn" id="btn-north">↑</button>
                <button class="story-btn" id="btn-talk">Talk</button>
                <button class="story-btn" id="btn-inventory">Items</button>
                <button class="story-btn direction-btn" id="btn-west">←</button>
                <button class="story-btn direction-btn" id="btn-south">↓</button>
                <button class="story-btn direction-btn" id="btn-east">→</button>
                <button class="story-btn" id="btn-search">Search</button>
                <button class="story-btn" id="btn-quests">Quests</button>
                <button class="story-btn" id="btn-battle">Battle</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Story Game State - will be populated from saved game state
        const storyState = {
            player: null,
            map: [],
            npcs: [],
            items: [],
            currentNpc: null,
            currentDialog: 0
        };

        // DOM Elements
        const storyOutputEl = document.getElementById('story-output');
        const storyMapEl = document.getElementById('story-map');
        const headerLevel = document.getElementById('header-level');
        const headerGold = document.getElementById('header-gold');
        const headerLocation = document.getElementById('header-location');
        const toastEl = document.getElementById('toast');
        
        // Buttons
        const btnNorth = document.getElementById('btn-north');
        const btnSouth = document.getElementById('btn-south');
        const btnEast = document.getElementById('btn-east');
        const btnWest = document.getElementById('btn-west');
        const btnTalk = document.getElementById('btn-talk');
        const btnSearch = document.getElementById('btn-search');
        const btnInventory = document.getElementById('btn-inventory');
        const btnQuests = document.getElementById('btn-quests');
        const btnBattle = document.getElementById('btn-battle');

        // Initialize the game
        window.addEventListener('load', () => {
            initializeStoryGame();
        });
        
        btnBattle.addEventListener('click', () => {
            // Save current story state
            saveStoryGame();
            // Navigate back to battle page
            window.location.href = 'sanc2.html'; // Change to your battle page URL
        });
        
        btnNorth.addEventListener('click', () => movePlayer(0, -1));
        btnSouth.addEventListener('click', () => movePlayer(0, 1));
        btnEast.addEventListener('click', () => movePlayer(1, 0));
        btnWest.addEventListener('click', () => movePlayer(-1, 0));
        btnTalk.addEventListener('click', talkToNpc);
        btnSearch.addEventListener('click', searchArea);
        btnInventory.addEventListener('click', showStoryInventory);
        btnQuests.addEventListener('click', showStoryQuests);

        function initializeStoryGame() {
            // Load game state from localStorage
            loadGameState();
            
            // If no player data exists, initialize with defaults
            if (!storyState.player) {
                storyState.player = {
                    name: "Hero",
                    level: 1,
                    gold: 50,
                    inventory: [],
                    storyProgress: 0,
                    currentLocation: "town",
                    position: { x: 3, y: 3 },
                    hasTorch: false,
                    talkedToElder: false,
                    foundAncientItem: false,
                    helpedBlacksmith: false
                };
            }
            
            // Generate the game world
            generateMap();
            placeNpcs();
            placeItems();
            
            // Update UI
            updateHeaderStats();
            renderMap();
            
            // Show initial story message
            printStoryMessage("You find yourself in a small town. The villagers seem worried about something.");
            printStoryMessage("Explore the area, talk to people, and search for clues.");
        }

      // Function to load player state
function loadPlayerState() {
    const savedState = localStorage.getItem('playerState');
    if (savedState) {
        return JSON.parse(savedState);
    }
    return null;
}

// Function to display player stats in story mode
function displayPlayerStats() {
    const playerState = loadPlayerState();
    if (playerState) {
        // Create or update elements to show gold and items
        const statsElement = document.getElementById('player-stats') || createStatsElement();
        
        statsElement.innerHTML = `
            <h3>Player Stats</h3>
            <p>Gold: <span class="gold">${playerState.gold}</span></p>
            <p>Equipped Weapon: ${playerState.equipped.weapon ? playerState.equipped.weapon.name : 'None'}</p>
            <p>Equipped Armor: ${playerState.equipped.armor ? playerState.equipped.armor.name : 'None'}</p>
            <h4>Inventory (${playerState.inventory.length} items)</h4>
            <ul>
                ${playerState.inventory.map(item => `<li>${item.name}</li>`).join('')}
            </ul>
        `;
    }
}

// Helper function to create stats element if it doesn't exist
function createStatsElement() {
    const statsDiv = document.createElement('div');
    statsDiv.id = 'player-stats';
    statsDiv.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #0f0;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 200px;
        max-height: 300px;
        overflow-y: auto;
    `;
    document.body.appendChild(statsDiv);
    return statsDiv;
}

// Call this when story page loads
window.addEventListener('load', () => {
    displayPlayerStats();
    
    // Add a button to return to battle
    const returnButton = document.createElement('button');
    returnButton.textContent = 'Battle';
    returnButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 15px;
        background: #000;
        color: #0f0;
        border: 2px solid #0f0;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Press Start 2P', 'Courier New', monospace;
    `;
    returnButton.addEventListener('click', () => {
        window.location.href = 'sanc2.html';
    });
    document.body.appendChild(returnButton);
});
      
        function loadGameState() {
            try {
                const savedGame = localStorage.getItem('rpg_game_state');
                if (savedGame) {
                    const gameState = JSON.parse(savedGame);
                    
                    // Load player data
                    if (gameState.player) {
                        storyState.player = gameState.player;
                        
                        // Ensure story-specific properties exist
                        const storyProps = {
                            storyProgress: 0,
                            currentLocation: "town",
                            position: { x: 3, y: 3 },
                            hasTorch: false,
                            talkedToElder: false,
                            foundAncientItem: false,
                            helpedBlacksmith: false
                        };
                        
                        for (const [key, value] of Object.entries(storyProps)) {
                            if (storyState.player[key] === undefined) {
                                storyState.player[key] = value;
                            }
                        }
                    }
                    
                    // Load story state if it exists
                    if (gameState.story) {
                        Object.assign(storyState, gameState.story);
                    }
                }
            } catch (e) {
                console.error("Error loading game state:", e);
            }
        }

        function saveStoryGame() {
            try {
                // First load the current game state to preserve battle data
                let gameState = {};
                const savedGame = localStorage.getItem('rpg_game_state');
                if (savedGame) {
                    gameState = JSON.parse(savedGame);
                }
                
                // Update the player data
                gameState.player = storyState.player;
                
                // Save story-specific state
                gameState.story = {
                    map: storyState.map,
                    npcs: storyState.npcs,
                    items: storyState.items,
                    currentNpc: storyState.currentNpc,
                    currentDialog: storyState.currentDialog
                };
                
                // Save back to localStorage
                localStorage.setItem('rpg_game_state', JSON.stringify(gameState));
            } catch (e) {
                console.error("Error saving game state:", e);
            }
        }

        function generateMap() {
            // Create a simple 7x7 map for demonstration
            const map = [];
            const terrainTypes = ['grass', 'path', 'forest', 'water', 'mountain'];
            
            for (let y = 0; y < 7; y++) {
                const row = [];
                for (let x = 0; x < 7; x++) {
                    // Simple terrain generation
                    let terrain = 'grass';
                    
                    // Create paths
                    if (x === 3 || y === 3) terrain = 'path';
                    
                    // Create special areas
                    if (x === 3 && y === 3) {
                        terrain = 'town'; // Center is town
                    } else if (x === 0 && y === 0) {
                        terrain = 'forest'; // Top-left is forest
                    } else if (x === 6 && y === 6) {
                        terrain = 'mountain'; // Bottom-right is mountain
                    } else if (x === 2 && y === 5) {
                        terrain = 'water'; // Some water
                    }
                    
                    row.push(terrain);
                }
                map.push(row);
            }
            
            storyState.map = map;
        }

        function placeNpcs() {
            storyState.npcs = [
                {
                    id: 1,
                    name: "Elder",
                    position: { x: 3, y: 2 },
                    dialogs: [
                        "Welcome, traveler. Our town is in grave danger.",
                        "Dark creatures have been appearing from the forest to the north.",
                        "We need someone brave to investigate the ancient ruins in the mountains.",
                        "If you help us, we will reward you handsomely."
                    ],
                    quest: "Investigate the mountains",
                    givesQuest: true
                },
                {
                    id: 2,
                    name: "Blacksmith",
                    position: { x: 4, y: 3 },
                    dialogs: [
                        "I could use some help around here.",
                        "I'm missing my special hammer. I think I left it near the lake.",
                        "If you find it, I'll give you something useful."
                    ],
                    quest: "Find the blacksmith's hammer",
                    givesQuest: true
                },
                {
                    id: 3,
                    name: "Merchant",
                    position: { x: 2, y: 3 },
                    dialogs: [
                        "I have supplies for your journey.",
                        "Come back if you find anything interesting to trade."
                    ],
                    givesQuest: false
                }
            ];
        }

        function placeItems() {
            storyState.items = [
                {
                    id: 1,
                    name: "Torch",
                    position: { x: 3, y: 4 },
                    description: "A wooden torch that can light dark places.",
                    collected: storyState.player.hasTorch
                },
                {
                    id: 2,
                    name: "Ancient Artifact",
                    position: { x: 6, y: 6 },
                    description: "An ancient artifact with mysterious powers.",
                    collected: storyState.player.foundAncientItem
                },
                {
                    id: 3,
                    name: "Blacksmith's Hammer",
                    position: { x: 2, y: 5 },
                    description: "A heavy hammer used by the blacksmith.",
                    collected: storyState.player.helpedBlacksmith
                }
            ];
        }

        function renderMap() {
            // Clear the map
            storyMapEl.innerHTML = '';
            
            const tileSize = 40;
            const mapWidth = storyState.map[0].length;
            const mapHeight = storyState.map.length;
            
            // Calculate offset to center the map
            const offsetX = (storyMapEl.offsetWidth - (mapWidth * tileSize)) / 2;
            const offsetY = (storyMapEl.offsetHeight - (mapHeight * tileSize)) / 2;
            
            // Render tiles
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    const tile = document.createElement('div');
                    tile.className = `map-tile ${storyState.map[y][x]}`;
                    tile.style.left = `${offsetX + x * tileSize}px`;
                    tile.style.top = `${offsetY + y * tileSize}px`;
                    
                    // Add terrain symbol
                    switch(storyState.map[y][x]) {
                        case 'town':
                            tile.textContent = '⌂';
                            break;
                        case 'forest':
                            tile.textContent = '♣';
                            break;
                        case 'mountain':
                            tile.textContent = '▲';
                            break;
                        case 'water':
                            tile.textContent = '~';
                            break;
                        case 'path':
                            tile.textContent = '•';
                            break;
                    }
                    
                    storyMapEl.appendChild(tile);
                }
            }
            
            // Render NPCs
            storyState.npcs.forEach(npc => {
                const marker = document.createElement('div');
                marker.className = 'npc-marker';
                marker.style.left = `${offsetX + npc.position.x * tileSize + (tileSize - 24) / 2}px`;
                marker.style.top = `${offsetY + npc.position.y * tileSize + (tileSize - 24) / 2}px`;
                marker.title = npc.name;
                storyMapEl.appendChild(marker);
            });
            
            // Render items (if not collected)
            storyState.items.forEach(item => {
                if (!item.collected) {
                    const marker = document.createElement('div');
                    marker.className = 'item-marker';
                    marker.style.left = `${offsetX + item.position.x * tileSize + (tileSize - 20) / 2}px`;
                    marker.style.top = `${offsetY + item.position.y * tileSize + (tileSize - 20) / 2}px`;
                    marker.title = item.name;
                    storyMapEl.appendChild(marker);
                }
            });
            
            // Render player
            const playerMarker = document.createElement('div');
            playerMarker.className = 'player-marker';
            playerMarker.style.left = `${offsetX + storyState.player.position.x * tileSize + (tileSize - 30) / 2}px`;
            playerMarker.style.top = `${offsetY + storyState.player.position.y * tileSize + (tileSize - 30) / 2}px`;
            storyMapEl.appendChild(playerMarker);
        }

        function movePlayer(dx, dy) {
            const newX = storyState.player.position.x + dx;
            const newY = storyState.player.position.y + dy;
            
            // Check bounds
            if (newX < 0 || newX >= storyState.map[0].length || 
                newY < 0 || newY >= storyState.map.length) {
                printStoryMessage("You can't go that way.");
                return;
            }
            
            // Check terrain restrictions
            const newTerrain = storyState.map[newY][newX];
            if (newTerrain === 'water') {
                printStoryMessage("You need a boat to cross the water.");
                return;
            }
            
            if (newTerrain === 'mountain' && !storyState.player.hasTorch) {
                printStoryMessage("The mountain path is too dark without a light source.");
                return;
            }
            
            // Update player position
            storyState.player.position.x = newX;
            storyState.player.position.y = newY;
            
            // Update location name
            updateLocationName(newTerrain);
            
            // Check for NPCs
            checkForNpcs();
            
            // Check for items
            checkForItems();
            
            // Render updated map
            renderMap();
            
            // Save game state
            saveStoryGame();
        }

        function updateLocationName(terrain) {
            let locationName = "Unknown";
            
            switch(terrain) {
                case 'town':
                    locationName = "Town Square";
                    break;
                case 'forest':
                    locationName = "Dark Forest";
                    break;
                case 'mountain':
                    locationName = "Ancient Mountains";
                    break;
                case 'water':
                    locationName = "Lake";
                    break;
                case 'path':
                    locationName = "Path";
                    break;
                case 'grass':
                    locationName = "Grasslands";
                    break;
            }
            
            storyState.player.currentLocation = locationName;
            headerLocation.textContent = locationName;
        }

        function checkForNpcs() {
            const playerPos = storyState.player.position;
            
            for (const npc of storyState.npcs) {
                if (npc.position.x === playerPos.x && npc.position.y === playerPos.y) {
                    storyState.currentNpc = npc;
                    storyState.currentDialog = 0;
                    
                    printStoryMessage(`You approach ${npc.name}.`, "npc");
                    printStoryMessage(npc.dialogs[0], "dialog");
                    
                    if (npc.givesQuest && !storyState.player[`talkedTo${npc.name.replace(/\s+/g, '')}`]) {
                        printStoryMessage("(They seem to need help with something)", "npc");
                    }
                    
                    return;
                }
            }
            
            storyState.currentNpc = null;
        }

        function checkForItems() {
            const playerPos = storyState.player.position;
            
            for (const item of storyState.items) {
                if (!item.collected && 
                    item.position.x === playerPos.x && 
                    item.position.y === playerPos.y) {
                    
                    printStoryMessage(`You found a ${item.name}!`, "story-item");
                    printStoryMessage(item.description, "story-item");
                    
                    // Add to inventory
                    storyState.player.inventory.push(item.name);
                    item.collected = true;
                    
                    // Special item effects
                    if (item.name === "Torch") {
                        storyState.player.hasTorch = true;
                        printStoryMessage("You can now explore dark areas.", "success");
                    } else if (item.name === "Ancient Artifact") {
                        storyState.player.foundAncientItem = true;
                        storyState.player.storyProgress = 2;
                        printStoryMessage("The elder will want to see this!", "success");
                    } else if (item.name === "Blacksmith's Hammer") {
                        storyState.player.helpedBlacksmith = true;
                        printStoryMessage("You should return this to the blacksmith.", "success");
                    }
                    
                    showToast(`Found: ${item.name}`);
                    updateHeaderStats();
                    saveStoryGame();
                    
                    return;
                }
            }
        }

        function talkToNpc() {
            if (!storyState.currentNpc) {
                printStoryMessage("There's no one here to talk to.");
                return;
            }
            
            const npc = storyState.currentNpc;
            
            // Advance dialog
            storyState.currentDialog++;
            
            if (storyState.currentDialog >= npc.dialogs.length) {
                storyState.currentDialog = 0; // Loop back to start
            }
            
            printStoryMessage(`${npc.name}: "${npc.dialogs[storyState.currentDialog]}"`, "dialog");
            
            // Mark NPC as talked to
            const npcKey = `talkedTo${npc.name.replace(/\s+/g, '')}`;
            if (!storyState.player[npcKey]) {
                storyState.player[npcKey] = true;
                
                if (npc.givesQuest) {
                    printStoryMessage("New quest added!", "success");
                    storyState.player.storyProgress = Math.max(storyState.player.storyProgress, 1);
                }
            }
            
            // Check if player has completed a quest
            if (npc.name === "Blacksmith" && storyState.player.helpedBlacksmith) {
                if (!storyState.player.receivedBlacksmithReward) {
                    printStoryMessage("Thank you for finding my hammer! Here's a reward.", "npc");
                    storyState.player.gold += 50;
                    storyState.player.receivedBlacksmithReward = true;
                    printStoryMessage("Received 50 gold!", "gold");
                    updateHeaderStats();
                }
            }
            
            if (npc.name === "Elder" && storyState.player.foundAncientItem) {
                if (!storyState.player.receivedElderReward) {
                    printStoryMessage("You found the ancient artifact! Our town is saved!", "npc");
                    printStoryMessage("Take this legendary weapon as your reward.", "npc");
                    storyState.player.inventory.push("Legendary Sword");
                    storyState.player.receivedElderReward = true;
                    printStoryMessage("Received Legendary Sword!", "story-item");
                    storyState.player.storyProgress = 3;
                }
            }
            
            saveStoryGame();
        }

        function searchArea() {
            const terrain = storyState.map[storyState.player.position.y][storyState.player.position.x];
            
            switch(terrain) {
                case 'forest':
                    if (Math.random() > 0.7) {
                        const foundGold = Math.floor(Math.random() * 10) + 5;
                        storyState.player.gold += foundGold;
                        printStoryMessage(`You found ${foundGold} gold hidden in the underbrush!`, "gold");
                        updateHeaderStats();
                    } else {
                        printStoryMessage("You search the area but find nothing of value.");
                    }
                    break;
                    
                case 'grass':
                    if (Math.random() > 0.8) {
                        storyState.player.inventory.push("Medicinal Herb");
                        printStoryMessage("You found a Medicinal Herb!", "story-item");
                    } else {
                        printStoryMessage("You search the grassy field but find nothing unusual.");
                    }
                    break;
                    
                case 'mountain':
                    if (Math.random() > 0.6) {
                        const foundGold = Math.floor(Math.random() * 20) + 10;
                        storyState.player.gold += foundGold;
                        printStoryMessage(`You found ${foundGold} gold in a rocky crevice!`, "gold");
                        updateHeaderStats();
                    } else {
                        printStoryMessage("You search the mountains but find nothing of value.");
                    }
                    break;
                    
                case 'town':
                    printStoryMessage("There's nothing to search here. Try talking to people instead.");
                    break;
                    
                default:
                    printStoryMessage("You search the area but find nothing of interest.");
            }
            
            saveStoryGame();
        }

        function showStoryInventory() {
            printStoryMessage("=== INVENTORY ===");
            
            if (storyState.player.inventory.length === 0) {
                printStoryMessage("Your inventory is empty.");
            } else {
                storyState.player.inventory.forEach(item => {
                    printStoryMessage(`- ${item}`, "story-item");
                });
            }
            
            printStoryMessage(`Gold: ${storyState.player.gold}`, "gold");
        }

        function showStoryQuests() {
            printStoryMessage("=== QUESTS ===");
            
            if (storyState.player.storyProgress === 0) {
                printStoryMessage("Talk to the villagers to learn about their problems.");
            }
            
            if (storyState.player.talkedToElder) {
                if (storyState.player.foundAncientItem) {
                    printStoryMessage("✓ Return the ancient artifact to the elder", "success");
                } else {
                    printStoryMessage("- Investigate the mountains for the elder", "npc");
                }
            }
            
            if (storyState.player.talkedToBlacksmith) {
                if (storyState.player.helpedBlacksmith) {
                    if (!storyState.player.receivedBlacksmithReward) {
                        printStoryMessage("✓ Return the hammer to the blacksmith", "npc");
                    } else {
                        printStoryMessage("✓ Blacksmith's hammer returned", "success");
                    }
                } else {
                    printStoryMessage("- Find the blacksmith's hammer near the lake", "npc");
                }
            }
            
            if (storyState.player.storyProgress === 3) {
                printStoryMessage("All quests completed! You're a hero!", "success");
            }
        }

        function printStoryMessage(text, className = "") {
            const p = document.createElement('p');
            if (className) p.className = className;
            p.textContent = text;
            storyOutputEl.appendChild(p);
            storyOutputEl.scrollTop = storyOutputEl.scrollHeight;
        }

        function updateHeaderStats() {
            headerLevel.textContent = storyState.player.level;
            headerGold.textContent = storyState.player.gold;
            headerLocation.textContent = storyState.player.currentLocation;
        }

        function showToast(message) {
            toastEl.textContent = message;
            toastEl.className = 'toast show';
            
            setTimeout(() => {
                toastEl.className = 'toast';
            }, 2000);
        }
    </script>
</body>
</html>
