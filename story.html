<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle Builder - RPG</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23003300" width="100" height="100"/><path fill="%23005500" d="M0 0h100v100H0z"/></svg>');
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        #output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            line-height: 1.5;
            scroll-behavior: smooth;
        }
        
        #output::-webkit-scrollbar {
            width: 5px;
        }
        
        #output::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 10px;
        }
        
        #castle-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            margin: 15px 0;
            height: 250px;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            position: relative;
        }
        
        .map-cell {
            border: 1px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            background-color: rgba(0, 30, 0, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .map-cell.owned {
            background-color: rgba(0, 80, 0, 0.7);
        }
        
        .map-cell.center {
            background-color: rgba(0, 100, 0, 0.9);
            border: 2px solid #fc0;
            animation: pulse 2s infinite;
        }
        
        .map-cell.forest {
            background-color: rgba(34, 139, 34, 0.5);
        }
        
        .map-cell.mountain {
            background-color: rgba(139, 137, 137, 0.5);
        }
        
        .map-cell.lake {
            background-color: rgba(30, 144, 255, 0.5);
        }
        
        .map-cell.village {
            background-color: rgba(178, 34, 34, 0.5);
        }
        
        .map-cell.empty:hover {
            background-color: rgba(80, 80, 80, 0.5);
            cursor: pointer;
        }
        
        .map-cell .land-name {
            position: absolute;
            bottom: 2px;
            font-size: 6px;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
        }
        
        .gold {
            color: #fc0;
            text-shadow: 0 0 3px #fa0;
        }
        
        .castle-section {
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            position: relative;
        }
        
        .castle-title {
            font-size: 14px;
            color: #0f0;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #0f0;
        }
        
        .upgrades-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .upgrade {
            padding: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
        }
        
        .upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 255, 0, 0.3);
        }
        
        .upgrade-info {
            text-align: left;
            margin-bottom: 8px;
        }
        
        .upgrade-name {
            font-size: 12px;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .upgrade-desc {
            font-size: 9px;
            color: #aaa;
            line-height: 1.3;
        }
        
        .upgrade-level {
            font-size: 9px;
            color: #0af;
            margin: 5px 0;
        }
        
        .upgrade-cost {
            font-size: 11px;
            color: #fc0;
            margin: 5px 0;
        }
        
        .upgrade-btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            width: 100%;
        }
        
        .upgrade-btn:hover {
            background: #0f0;
            color: #000;
        }
        
        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .upgrade-btn.upgraded {
            background: #0f0;
            color: #000;
        }
        
        #return-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 15px;
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 100;
        }
        
        #return-btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        
        .territory-section {
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .territory-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .territory-item {
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .territory-item:hover {
            background-color: rgba(0, 50, 0, 0.5);
            transform: translateY(-3px);
        }
        
        .territory-name {
            font-size: 11px;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .territory-desc {
            font-size: 9px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .territory-cost {
            font-size: 10px;
            color: #fc0;
        }
        
        .stats-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
            z-index: 100;
        }
        
        .stats-panel h3 {
            font-size: 12px;
            margin-bottom: 10px;
            color: #0f0;
            text-align: center;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        .stats-panel p {
            margin: 5px 0;
            font-size: 10px;
        }
        
        .stats-panel ul {
            margin-left: 15px;
            font-size: 10px;
        }
        
        .stats-panel li {
            margin: 3px 0;
            word-break: break-word;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #0f0;
        }
        
        .tab {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 10px;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            border-color: #0f0;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f0;
            border-radius: 5px;
            z-index: 1000;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 0px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 0px; }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 204, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0); }
        }
        
        @media (max-width: 480px) {
            .territory-items, .upgrades-container {
                grid-template-columns: 1fr;
            }
            
            #castle-map {
                height: 200px;
            }
            
            .map-cell {
                font-size: 16px;
            }
            
            .stats-panel {
                position: relative;
                top: 0;
                right: 0;
                max-width: 100%;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Castle Builder</h1>
        <div id="header-stats">
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
            <div class="header-stat">Land: <span id="header-land">1</span>/25</div>
        </div>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div class="stats-panel">
                <h3>Kingdom Stats</h3>
                <p>Gold: <span id="stats-gold" class="gold">0</span></p>
                <p>Lands: <span id="stats-lands">1/25</span></p>
                <p>Defense: <span id="stats-defense">0</span></p>
                <p>Income: <span id="stats-income">0</span>/battle</p>
            </div>
            
            <div id="output">
                <p>Welcome to your domain! Expand your castle and lands with gold earned from battles.</p>
                <p>Your progress from battle mode has been loaded.</p>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('castle')">Castle</div>
                <div class="tab" onclick="switchTab('lands')">Lands</div>
                <div class="tab" onclick="switchTab('resources')">Resources</div>
            </div>
            
            <div id="castle-tab" class="tab-content active">
                <div class="castle-section">
                    <div class="castle-title">CASTLE UPGRADES</div>
                    <div class="upgrades-container">
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Wooden Keep</div>
                                <div class="upgrade-desc">Basic structure for your castle</div>
                                <div class="upgrade-level">Level: <span id="keep-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="keep-cost">100</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('keep')" id="keep-btn">Build</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Stone Walls</div>
                                <div class="upgrade-desc">Stronger defense for your castle</div>
                                <div class="upgrade-level">Level: <span id="walls-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="walls-cost">250</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('walls')" id="walls-btn">Build</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Watch Tower</div>
                                <div class="upgrade-desc">See enemies from afar</div>
                                <div class="upgrade-level">Level: <span id="tower-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="tower-cost">150</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('tower')" id="tower-btn">Build</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Moat & Drawbridge</div>
                                <div class="upgrade-desc">Improved castle defenses</div>
                                <div class="upgrade-level">Level: <span id="moat-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="moat-cost">300</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('moat')" id="moat-btn">Build</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Royal Stables</div>
                                <div class="upgrade-desc">Houses your battle steeds</div>
                                <div class="upgrade-level">Level: <span id="stables-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="stables-cost">200</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('stables')" id="stables-btn">Build</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Barracks</div>
                                <div class="upgrade-desc">Train soldiers for your army</div>
                                <div class="upgrade-level">Level: <span id="barracks-level">0</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="barracks-cost">400</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeCastle('barracks')" id="barracks-btn">Build</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="lands-tab" class="tab-content">
                <div id="castle-map">
                    <!-- Map will be generated by JavaScript -->
                </div>
                
                <div class="territory-section">
                    <div class="castle-title">EXPAND YOUR LANDS</div>
                    <div class="territory-items">
                        <div class="territory-item" onclick="purchaseLand('forest')">
                            <div class="territory-name">Forest</div>
                            <div class="territory-desc">Provides wood resources</div>
                            <div class="territory-cost">Cost: <span class="gold">150</span> gold</div>
                        </div>
                        <div class="territory-item" onclick="purchaseLand('mountain')">
                            <div class="territory-name">Mountain</div>
                            <div class="territory-desc">Provides stone and minerals</div>
                            <div class="territory-cost">Cost: <span class="gold">200</span> gold</div>
                        </div>
                        <div class="territory-item" onclick="purchaseLand('lake')">
                            <div class="territory-name">Lake</div>
                            <div class="territory-desc">Provides fish and water</div>
                            <div class="territory-cost">Cost: <span class="gold">180</span> gold</div>
                        </div>
                        <div class="territory-item" onclick="purchaseLand('village')">
                            <div class="territory-name">Village</div>
                            <div class="territory-desc">Provides taxes and recruits</div>
                            <div class="territory-cost">Cost: <span class="gold">350</span> gold</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="resources-tab" class="tab-content">
                <div class="castle-section">
                    <div class="castle-title">RESOURCE MANAGEMENT</div>
                    <div class="upgrades-container">
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Wood Production</div>
                                <div class="upgrade-desc">Increases wood income from forests</div>
                                <div class="upgrade-level">Level: <span id="wood-lvl">1</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="wood-cost">100</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeResource('wood')">Upgrade</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Stone Production</div>
                                <div class="upgrade-desc">Increases stone income from mountains</div>
                                <div class="upgrade-level">Level: <span id="stone-lvl">1</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="stone-cost">120</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeResource('stone')">Upgrade</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Food Production</div>
                                <div class="upgrade-desc">Increases food income from lakes</div>
                                <div class="upgrade-level">Level: <span id="food-lvl">1</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="food-cost">90</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeResource('food')">Upgrade</button>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Tax Collection</div>
                                <div class="upgrade-desc">Increases gold income from villages</div>
                                <div class="upgrade-level">Level: <span id="tax-lvl">1</span></div>
                            </div>
                            <div class="upgrade-cost">Cost: <span class="gold" id="tax-cost">200</span> gold</div>
                            <button class="upgrade-btn" onclick="upgradeResource('tax')">Upgrade</button>
                        </div>
                    </div>
                </div>
                
                <div class="castle-section">
                    <div class="castle-title">RESOURCE INCOME</div>
                    <div class="upgrades-container">
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Wood</div>
                                <div class="upgrade-desc">From forests: <span id="forest-count">0</span></div>
                            </div>
                            <div class="upgrade-cost">Income: <span class="gold" id="wood-income">0</span>/battle</div>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Stone</div>
                                <div class="upgrade-desc">From mountains: <span id="mountain-count">0</span></div>
                            </div>
                            <div class="upgrade-cost">Income: <span class="gold" id="stone-income">0</span>/battle</div>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Food</div>
                                <div class="upgrade-desc">From lakes: <span id="lake-count">0</span></div>
                            </div>
                            <div class="upgrade-cost">Income: <span class="gold" id="food-income">0</span>/battle</div>
                        </div>
                        <div class="upgrade">
                            <div class="upgrade-info">
                                <div class="upgrade-name">Gold</div>
                                <div class="upgrade-desc">From villages: <span id="village-count">0</span></div>
                            </div>
                            <div class="upgrade-cost">Income: <span class="gold" id="gold-income">0</span>/battle</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="return-btn" onclick="returnToBattle()">Return to Battle</button>

<script>
    // Player state
    const playerState = {
        gold: 0,
        land: {
            owned: 1, // Starting with just the center plot
            plots: Array(25).fill().map((_, i) => ({
                id: i,
                type: i === 12 ? 'center' : 'empty', // Center plot
                owned: i === 12
            }))
        },
        castle: {
            keep: 0,
            walls: 0,
            tower: 0,
            moat: 0,
            stables: 0,
            barracks: 0
        },
        resources: {
            forest: 0,
            mountain: 0,
            lake: 0,
            village: 0
        },
        production: {
            wood: 1,
            stone: 1,
            food: 1,
            tax: 1
        }
    };
    
    // Upgrade costs
    const upgradeCosts = {
        keep: [100, 250, 500],
        walls: [250, 500, 1000],
        tower: [150, 300, 600],
        moat: [300, 600, 1200],
        stables: [200, 400, 800],
        barracks: [400, 800, 1600],
        wood: [100, 200, 400],
        stone: [120, 240, 480],
        food: [90, 180, 360],
        tax: [200, 400, 800]
    };
    
    // Land costs
    const landCosts = {
        forest: 150,
        mountain: 200,
        lake: 180,
        village: 350
    };
    
    // DOM elements
    const outputEl = document.getElementById('output');
    const headerGold = document.getElementById('header-gold');
    const headerLand = document.getElementById('header-land');
    const castleMap = document.getElementById('castle-map');
    const statsGold = document.getElementById('stats-gold');
    const statsLands = document.getElementById('stats-lands');
    const statsDefense = document.getElementById('stats-defense');
    const statsIncome = document.getElementById('stats-income');
    
    // Initialize the page
    window.addEventListener('load', () => {
        loadPlayerState();
        generateMap();
        updateUI();
        printMessage("Welcome to your domain! Begin expanding your castle and lands.");
        showNotification("Game loaded successfully!");
    });
    
    // Generate the map grid
    function generateMap() {
        castleMap.innerHTML = '';
        
        playerState.land.plots.forEach((plot, index) => {
            const cell = document.createElement('div');
            cell.className = `map-cell ${plot.type} ${plot.owned ? 'owned' : ''}`;
            cell.onclick = () => {
                if (!plot.owned) {
                    showNotification("This land is not yet owned. Purchase from the Lands tab.");
                } else {
                    showNotification(`This is your ${plot.type} land.`);
                }
            };
            
            // Set appropriate emoji for each plot type
            if (plot.owned) {
                switch(plot.type) {
                    case 'center': cell.textContent = '🏰'; break;
                    case 'forest': cell.textContent = '🌲'; break;
                    case 'mountain': cell.textContent = '⛰️'; break;
                    case 'lake': cell.textContent = '🌊'; break;
                    case 'village': cell.textContent = '🏘️'; break;
                    default: cell.textContent = '🟩';
                }
                
                // Add land name for owned plots
                const landName = document.createElement('div');
                landName.className = 'land-name';
                landName.textContent = plot.type;
                cell.appendChild(landName);
            } else {
                cell.textContent = '❓';
            }
            
            castleMap.appendChild(cell);
        });
    }
    
    // Load player state from localStorage
    function loadPlayerState() {
        // First try to load from battle state
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                playerState.gold = state.player.gold || 0;
                
                // Load castle and land data if it exists
                const savedPlayerState = localStorage.getItem('playerCastleState');
                if (savedPlayerState) {
                    const castleState = JSON.parse(savedPlayerState);
                    playerState.land = castleState.land;
                    playerState.castle = castleState.castle;
                    playerState.resources = castleState.resources;
                    playerState.production = castleState.production || {
                        wood: 1,
                        stone: 1,
                        food: 1,
                        tax: 1
                    };
                }
            } catch (e) {
                console.error("Error loading state:", e);
            }
        }
    }
    
    // Save player state to localStorage
    function savePlayerState() {
        localStorage.setItem('playerCastleState', JSON.stringify(playerState));
    }
    
    // Update the UI with current player state
    function updateUI() {
        headerGold.textContent = playerState.gold;
        headerLand.textContent = playerState.land.owned;
        statsGold.textContent = playerState.gold;
        statsLands.textContent = `${playerState.land.owned}/25`;
        
        // Calculate defense and income
        const defense = playerState.castle.walls * 5 + playerState.castle.moat * 3 + playerState.castle.tower * 2;
        const income = calculateIncome();
        
        statsDefense.textContent = defense;
        statsIncome.textContent = income;
        
        // Update upgrade buttons and levels
        updateUpgradeButtons();
        
        // Update resource counts
        document.getElementById('forest-count').textContent = playerState.resources.forest;
        document.getElementById('mountain-count').textContent = playerState.resources.mountain;
        document.getElementById('lake-count').textContent = playerState.resources.lake;
        document.getElementById('village-count').textContent = playerState.resources.village;
        
        // Update resource income
        document.getElementById('wood-income').textContent = playerState.resources.forest * playerState.production.wood;
        document.getElementById('stone-income').textContent = playerState.resources.mountain * playerState.production.stone;
        document.getElementById('food-income').textContent = playerState.resources.lake * playerState.production.food;
        document.getElementById('gold-income').textContent = playerState.resources.village * playerState.production.tax;
        
        // Regenerate map to reflect changes
        generateMap();
    }
    
    // Calculate total income from resources
    function calculateIncome() {
        return (playerState.resources.forest * playerState.production.wood) +
               (playerState.resources.mountain * playerState.production.stone) +
               (playerState.resources.lake * playerState.production.food) +
               (playerState.resources.village * playerState.production.tax);
    }
    
    // Print a message to the output area
    function printMessage(text, className = "") {
        const p = document.createElement('p');
        if (className) p.className = className;
        p.textContent = text;
        outputEl.appendChild(p);
        outputEl.scrollTop = outputEl.scrollHeight;
    }
    
    // Show a notification
    function showNotification(text) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = text;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 2800);
    }
    
    // Upgrade castle structure
    function upgradeCastle(type) {
        const level = playerState.castle[type];
        const cost = upgradeCosts[type][level];
        
        if (level >= upgradeCosts[type].length) {
            showNotification("This structure is already at maximum level!");
            return;
        }
        
        if (playerState.gold >= cost) {
            playerState.gold -= cost;
            playerState.castle[type]++;
            
            let message = "";
            switch(type) {
                case 'keep':
                    message = `You've upgraded your keep to level ${playerState.castle[type]}!`;
                    break;
                case 'walls':
                    message = `Stone walls upgraded to level ${playerState.castle[type]}. Defense increased!`;
                    break;
                case 'tower':
                    message = `Watch tower upgraded to level ${playerState.castle[type]}. Visibility improved!`;
                    break;
                case 'moat':
                    message = `Moat and drawbridge upgraded to level ${playerState.castle[type]}. Excellent defense!`;
                    break;
                case 'stables':
                    message = `Royal stables upgraded to level ${playerState.castle[type]}. More steeds available!`;
                    break;
                case 'barracks':
                    message = `Barracks upgraded to level ${playerState.castle[type]}. Army capacity increased!`;
                    break;
            }
            
            printMessage(message, "success");
            showNotification(`Upgraded ${type} to level ${playerState.castle[type]}!`);
            savePlayerState();
            updateUI();
        } else {
            showNotification(`You need ${cost} gold to upgrade that!`);
        }
    }
    
    // Upgrade resource production
    function upgradeResource(type) {
        const level = playerState.production[type];
        const cost = upgradeCosts[type][level - 1]; // production levels start at 1
        
        if (level >= upgradeCosts[type].length + 1) {
            showNotification("This resource production is already at maximum level!");
            return;
        }
        
        if (playerState.gold >= cost) {
            playerState.gold -= cost;
            playerState.production[type]++;
            
            let message = "";
            switch(type) {
                case 'wood':
                    message = `Wood production increased to level ${playerState.production[type]}!`;
                    break;
                case 'stone':
                    message = `Stone production increased to level ${playerState.production[type]}!`;
                    break;
                case 'food':
                    message = `Food production increased to level ${playerState.production[type]}!`;
                    break;
                case 'tax':
                    message = `Tax collection improved to level ${playerState.production[type]}!`;
                    break;
            }
            
            printMessage(message, "success");
            showNotification(`${type} production upgraded!`);
            savePlayerState();
            updateUI();
        } else {
            showNotification(`You need ${cost} gold to upgrade that!`);
        }
    }
    
    // Purchase new land
    function purchaseLand(type) {
        const cost = landCosts[type];
        
        if (playerState.gold >= cost) {
            // Find an empty plot to claim
            const emptyPlots = playerState.land.plots.filter(plot => 
                !plot.owned && plot.type === 'empty'
            );
            
            if (emptyPlots.length > 0) {
                playerState.gold -= cost;
                playerState.land.owned++;
                playerState.resources[type]++;
                
                // Claim a random empty plot
                const randomIndex = Math.floor(Math.random() * emptyPlots.length);
                const plotId = emptyPlots[randomIndex].id;
                
                // Update the plot
                playerState.land.plots[plotId].owned = true;
                playerState.land.plots[plotId].type = type;
                
                let message = "";
                switch(type) {
                    case 'forest':
                        message = "You've acquired a forest! Wood resources are now available.";
                        break;
                    case 'mountain':
                        message = "You've claimed a mountain! Stone and minerals added to your resources.";
                        break;
                    case 'lake':
                        message = "You now own a lake! Fish and water resources are available.";
                        break;
                    case 'village':
                        message = "You've annexed a village! Taxes and recruits will aid your cause.";
                        break;
                }
                
                printMessage(message, "success");
                showNotification(`Acquired a ${type}!`);
                savePlayerState();
                updateUI();
                
                // Switch to lands tab to see the new acquisition
                switchTab('lands');
            } else {
                showNotification("No more land available to claim!");
            }
        } else {
            showNotification(`You need ${cost} gold to purchase that land!`);
        }
    }
    
    // Update upgrade buttons based on affordability
    function updateUpgradeButtons() {
        // Castle upgrades
        for (const type in playerState.castle) {
            const level = playerState.castle[type];
            const btn = document.getElementById(`${type}-btn`);
            const levelEl = document.getElementById(`${type}-level`);
            const costEl = document.getElementById(`${type}-cost`);
            
            if (levelEl) levelEl.textContent = level;
            
            if (level >= upgradeCosts[type].length) {
                if (btn) {
                    btn.textContent = "Max Level";
                    btn.disabled = true;
                    btn.classList.add('upgraded');
                }
                if (costEl) costEl.textContent = "Max";
            } else {
                const cost = upgradeCosts[type][level];
                if (costEl) costEl.textContent = cost;
                if (btn) {
                    btn.disabled = playerState.gold < cost;
                    btn.textContent = level === 0 ? "Build" : "Upgrade";
                }
            }
        }
        
        // Resource production upgrades
        for (const type in playerState.production) {
            const level = playerState.production[type];
            const levelEl = document.getElementById(`${type}-lvl`);
            const costEl = document.getElementById(`${type}-cost`);
            
            if (levelEl) levelEl.textContent = level;
            
            if (level >= upgradeCosts[type].length + 1) {
                if (costEl) costEl.textContent = "Max";
            } else {
                const cost = upgradeCosts[type][level - 1];
                if (costEl) costEl.textContent = cost;
            }
        }
    }
    
    // Switch between tabs
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activate selected tab
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // Activate tab button
        document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    }
    
    // Return to battle mode
    function returnToBattle() {
        // Calculate bonus gold from resources
        const bonusGold = calculateIncome();
        
        // Save the current player state
        savePlayerState();
        
        // Also update the battle state with any gold changes
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                state.player.gold = playerState.gold + bonusGold;
                localStorage.setItem('sanctuaryRPG_save', JSON.stringify(state));
                
                if (bonusGold > 0) {
                    showNotification(`Earned ${bonusGold} gold from your lands!`);
                }
            } catch (e) {
                console.error("Error updating battle state:", e);
            }
        }
        
        window.location.href = 'sanc2.html';
    }
</script>      
</body>
</html>
