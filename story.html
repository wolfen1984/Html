<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle Builder - RPG</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #111;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(0, 80, 0, 0.2) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 80, 0, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        #header {
            padding: 12px 10px;
            background-color: #000;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.3);
            z-index: 10;
        }
        
        #header h1 {
            font-size: 14px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        #header-stats {
            display: flex;
            gap: 15px;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .header-stat i {
            margin-right: 5px;
        }
        
        #game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden;
            background-color: rgba(0, 20, 0, 0.8);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect fill="%23003300" width="100" height="100"/><path fill="%23005500" d="M0 0h100v100H0z"/></svg>');
            box-shadow: inset 0 0 15px rgba(0, 255, 0, 0.2), 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        #output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            line-height: 1.5;
            scroll-behavior: smooth;
        }
        
        #output::-webkit-scrollbar {
            width: 5px;
        }
        
        #output::-webkit-scrollbar-thumb {
            background-color: #0f0;
            border-radius: 10px;
        }
        
        #castle-map {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            margin: 15px 0;
            height: 250px;
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .map-cell {
            border: 1px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            background-color: rgba(0, 30, 0, 0.5);
            transition: all 0.3s;
        }
        
        .map-cell.owned {
            background-color: rgba(0, 80, 0, 0.7);
        }
        
        .map-cell.center {
            background-color: rgba(0, 100, 0, 0.9);
            border: 2px solid #fc0;
        }
        
        .map-cell.forest {
            background-color: rgba(34, 139, 34, 0.5);
        }
        
        .map-cell.mountain {
            background-color: rgba(139, 137, 137, 0.5);
        }
        
        .map-cell.lake {
            background-color: rgba(30, 144, 255, 0.5);
        }
        
        .map-cell.village {
            background-color: rgba(178, 34, 34, 0.5);
        }
        
        .gold {
            color: #fc0;
            text-shadow: 0 0 3px #fa0;
        }
        
        .castle-section {
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .castle-title {
            font-size: 14px;
            color: #0f0;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #0f0;
        }
        
        .upgrade {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .upgrade-info {
            flex: 1;
            text-align: left;
        }
        
        .upgrade-name {
            font-size: 12px;
            color: #0f0;
        }
        
        .upgrade-desc {
            font-size: 9px;
            color: #aaa;
        }
        
        .upgrade-cost {
            font-size: 11px;
            color: #fc0;
            margin-left: 10px;
        }
        
        .upgrade-btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .upgrade-btn:hover {
            background: #0f0;
            color: #000;
        }
        
        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #return-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 15px;
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            z-index: 100;
        }
        
        #return-btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        
        .territory-section {
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .territory-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .territory-item {
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .territory-item:hover {
            background-color: rgba(0, 50, 0, 0.5);
            transform: translateY(-3px);
        }
        
        .territory-name {
            font-size: 11px;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .territory-desc {
            font-size: 9px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .territory-cost {
            font-size: 10px;
            color: #fc0;
        }
        
        @media (max-width: 480px) {
            .territory-items {
                grid-template-columns: 1fr;
            }
            
            #castle-map {
                height: 200px;
            }
            
            .map-cell {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Castle Builder</h1>
        <div id="header-stats">
            <div class="header-stat">Gold: <span id="header-gold">0</span></div>
            <div class="header-stat">Land: <span id="header-land">1</span>/25</div>
        </div>
    </div>
    
    <div id="game-wrapper">
        <div id="game-container">
            <div id="output">
                <p>Welcome to your domain! Expand your castle and lands with gold earned from battles.</p>
                <p>Your progress from battle mode has been loaded.</p>
            </div>
            
            <div id="castle-map">
                <!-- Map will be generated by JavaScript -->
            </div>
            
            <div class="castle-section">
                <div class="castle-title">CASTLE UPGRADES</div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Wooden Keep</div>
                        <div class="upgrade-desc">Basic structure for your castle</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">100</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('keep')">Build</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Stone Walls</div>
                        <div class="upgrade-desc">Stronger defense for your castle</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">250</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('walls')">Build</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Watch Tower</div>
                        <div class="upgrade-desc">See enemies from afar</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">150</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('tower')">Build</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Moat & Drawbridge</div>
                        <div class="upgrade-desc">Improved castle defenses</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">300</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('moat')">Build</button>
                </div>
                <div class="upgrade">
                    <div class="upgrade-info">
                        <div class="upgrade-name">Royal Stables</div>
                        <div class="upgrade-desc">Houses your battle steeds</div>
                    </div>
                    <div class="upgrade-cost">Cost: <span class="gold">200</span> gold</div>
                    <button class="upgrade-btn" onclick="upgradeCastle('stables')">Build</button>
                </div>
            </div>
            
            <div class="territory-section">
                <div class="castle-title">EXPAND YOUR LANDS</div>
                <div class="territory-items">
                    <div class="territory-item" onclick="purchaseLand('forest')">
                        <div class="territory-name">Forest</div>
                        <div class="territory-desc">Provides wood resources</div>
                        <div class="territory-cost">Cost: <span class="gold">150</span> gold</div>
                    </div>
                    <div class="territory-item" onclick="purchaseLand('mountain')">
                        <div class="territory-name">Mountain</div>
                        <div class="territory-desc">Provides stone and minerals</div>
                        <div class="territory-cost">Cost: <span class="gold">200</span> gold</div>
                    </div>
                    <div class="territory-item" onclick="purchaseLand('lake')">
                        <div class="territory-name">Lake</div>
                        <div class="territory-desc">Provides fish and water</div>
                        <div class="territory-cost">Cost: <span class="gold">180</span> gold</div>
                    </div>
                    <div class="territory-item" onclick="purchaseLand('village')">
                        <div class="territory-name">Village</div>
                        <div class="territory-desc">Provides taxes and recruits</div>
                        <div class="territory-cost">Cost: <span class="gold">350</span> gold</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="return-btn" onclick="returnToBattle()">Return to Battle</button>

<script>
    // Player state
    const playerState = {
        gold: 0,
        land: {
            owned: 1, // Starting with just the center plot
            plots: Array(25).fill().map((_, i) => ({
                id: i,
                type: i === 12 ? 'center' : 'empty', // Center plot
                owned: i === 12
            }))
        },
        castle: {
            keep: 0,
            walls: 0,
            tower: 0,
            moat: 0,
            stables: 0
        },
        resources: {
            forest: 0,
            mountain: 0,
            lake: 0,
            village: 0
        }
    };
    
    // Upgrade costs
    const upgradeCosts = {
        keep: 100,
        walls: 250,
        tower: 150,
        moat: 300,
        stables: 200
    };
    
    // Land costs
    const landCosts = {
        forest: 150,
        mountain: 200,
        lake: 180,
        village: 350
    };
    
    // DOM elements
    const outputEl = document.getElementById('output');
    const headerGold = document.getElementById('header-gold');
    const headerLand = document.getElementById('header-land');
    const castleMap = document.getElementById('castle-map');
    
    // Initialize the page
    window.addEventListener('load', () => {
        loadPlayerState();
        generateMap();
        updateUI();
        printMessage("Welcome to your domain! Begin expanding your castle and lands.");
    });
    
    // Generate the map grid
    function generateMap() {
        castleMap.innerHTML = '';
        
        playerState.land.plots.forEach((plot, index) => {
            const cell = document.createElement('div');
            cell.className = `map-cell ${plot.type} ${plot.owned ? 'owned' : ''}`;
            
            // Set appropriate emoji for each plot type
            if (plot.owned) {
                switch(plot.type) {
                    case 'center': cell.textContent = 'ðŸ°'; break;
                    case 'forest': cell.textContent = 'ðŸŒ²'; break;
                    case 'mountain': cell.textContent = 'â›°ï¸'; break;
                    case 'lake': cell.textContent = 'ðŸŒŠ'; break;
                    case 'village': cell.textContent = 'ðŸ˜ï¸'; break;
                    default: cell.textContent = 'ðŸŸ©';
                }
            } else {
                cell.textContent = 'â“';
            }
            
            castleMap.appendChild(cell);
        });
    }
    
    // Load player state from localStorage
    function loadPlayerState() {
        // First try to load from battle state
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                playerState.gold = state.player.gold || 0;
                
                // Load castle and land data if it exists
                const savedPlayerState = localStorage.getItem('playerCastleState');
                if (savedPlayerState) {
                    const castleState = JSON.parse(savedPlayerState);
                    playerState.land = castleState.land;
                    playerState.castle = castleState.castle;
                    playerState.resources = castleState.resources;
                }
            } catch (e) {
                console.error("Error loading state:", e);
            }
        }
    }
    
    // Save player state to localStorage
    function savePlayerState() {
        localStorage.setItem('playerCastleState', JSON.stringify(playerState));
    }
    
    // Update the UI with current player state
    function updateUI() {
        headerGold.textContent = playerState.gold;
        headerLand.textContent = playerState.land.owned;
        
        // Update upgrade buttons based on affordability
        updateUpgradeButtons();
        
        // Regenerate map to reflect changes
        generateMap();
    }
    
    // Print a message to the output area
    function printMessage(text, className = "") {
        const p = document.createElement('p');
        if (className) p.className = className;
        p.textContent = text;
        outputEl.appendChild(p);
        outputEl.scrollTop = outputEl.scrollHeight;
    }
    
    // Upgrade castle structure
    function upgradeCastle(type) {
        const cost = upgradeCosts[type];
        
        if (playerState.gold >= cost) {
            playerState.gold -= cost;
            playerState.castle[type]++;
            
            let message = "";
            switch(type) {
                case 'keep':
                    message = "You've built a wooden keep! Your castle is taking shape.";
                    break;
                case 'walls':
                    message = "Stone walls now protect your castle. Defense increased!";
                    break;
                case 'tower':
                    message = "A watch tower now stands tall. You can see enemies from afar.";
                    break;
                case 'moat':
                    message = "The moat and drawbridge provide excellent defense!";
                    break;
                case 'stables':
                    message = "Royal stables are now ready for your battle steeds.";
                    break;
            }
            
            printMessage(message, "success");
            savePlayerState();
            updateUI();
        } else {
            printMessage(`You need ${cost} gold to build that!`, "error");
        }
    }
    
    // Purchase new land
    function purchaseLand(type) {
        const cost = landCosts[type];
        
        if (playerState.gold >= cost) {
            // Find an empty plot to claim
            const emptyPlots = playerState.land.plots.filter(plot => 
                !plot.owned && plot.type === 'empty'
            );
            
            if (emptyPlots.length > 0) {
                playerState.gold -= cost;
                playerState.land.owned++;
                playerState.resources[type]++;
                
                // Claim a random empty plot
                const randomIndex = Math.floor(Math.random() * emptyPlots.length);
                const plotId = emptyPlots[randomIndex].id;
                
                // Update the plot
                playerState.land.plots[plotId].owned = true;
                playerState.land.plots[plotId].type = type;
                
                let message = "";
                switch(type) {
                    case 'forest':
                        message = "You've acquired a forest! Wood resources are now available.";
                        break;
                    case 'mountain':
                        message = "You've claimed a mountain! Stone and minerals added to your resources.";
                        break;
                    case 'lake':
                        message = "You now own a lake! Fish and water resources are available.";
                        break;
                    case 'village':
                        message = "You've annexed a village! Taxes and recruits will aid your cause.";
                        break;
                }
                
                printMessage(message, "success");
                savePlayerState();
                updateUI();
            } else {
                printMessage("No more land available to claim!", "error");
            }
        } else {
            printMessage(`You need ${cost} gold to purchase that land!`, "error");
        }
    }
    
    // Update upgrade buttons based on affordability
    function updateUpgradeButtons() {
        const buttons = document.querySelectorAll('.upgrade-btn');
        
        buttons[0].disabled = playerState.gold < upgradeCosts.keep;
        buttons[1].disabled = playerState.gold < upgradeCosts.walls;
        buttons[2].disabled = playerState.gold < upgradeCosts.tower;
        buttons[3].disabled = playerState.gold < upgradeCosts.moat;
        buttons[4].disabled = playerState.gold < upgradeCosts.stables;
        
        buttons[0].textContent = playerState.castle.keep > 0 ? "Upgraded" : "Build";
        buttons[1].textContent = playerState.castle.walls > 0 ? "Upgraded" : "Build";
        buttons[2].textContent = playerState.castle.tower > 0 ? "Upgraded" : "Build";
        buttons[3].textContent = playerState.castle.moat > 0 ? "Upgraded" : "Build";
        buttons[4].textContent = playerState.castle.stables > 0 ? "Upgraded" : "Build";
    }
    
    // Return to battle mode
    function returnToBattle() {
        // Save the current player state
        savePlayerState();
        
        // Also update the battle state with any gold changes
        const battleState = localStorage.getItem('sanctuaryRPG_save');
        if (battleState) {
            try {
                const state = JSON.parse(battleState);
                state.player.gold = playerState.gold;
                localStorage.setItem('sanctuaryRPG_save', JSON.stringify(state));
            } catch (e) {
                console.error("Error updating battle state:", e);
            }
        }
        
        window.location.href = 'sanc2.html';
    }
</script>      
</body>
</html>
