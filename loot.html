<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of Shadows - Enhanced RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #000;
            color: #0f0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border: 2px solid #0f0;
            background-color: #000;
            position: relative;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }
        
        .active {
            display: flex;
        }
        
        h1, h2, h3 {
            color: #0f0;
            text-align: center;
            margin: 10px 0;
            text-transform: uppercase;
        }
        
        .button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .button:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            border-bottom: 1px dashed #0f0;
            padding-bottom: 10px;
        }
        
        .log {
            border: 1px solid #0f0;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            border: 1px solid #0f0;
            padding: 8px;
            cursor: pointer;
            position: relative;
        }
        
        .item-stats {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .equipment-slot {
            border: 1px solid #0f0;
            padding: 8px;
            min-height: 60px;
        }
        
        .equipment-stats {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .enemy {
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            position: relative;
        }
        
        .battle-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .spell-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin: 10px 0;
        }
        
        .spell-item {
            border: 1px solid #0f0;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        
        .spell-info {
            flex: 1;
        }
        
        .spell-cost {
            color: #0af;
            margin-left: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #000;
            border: 1px solid #0f0;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #0f0;
            width: 0%;
            transition: width 0.3s;
        }
        
        .mp-bar {
            background-color: #00a;
        }
        
        .class-select {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .class-option {
            border: 1px solid #0f0;
            padding: 15px;
            cursor: pointer;
        }
        
        .class-option:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .loot-item {
            color: #ff0;
            animation: pulse 1s infinite;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .crit-message {
            color: #f00;
            font-weight: bold;
        }
        
        .dodge-message {
            color: #00f;
            font-weight: bold;
        }
        
        .miss-message {
            color: #888;
            font-style: italic;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .shop-item {
            border: 1px solid #0f0;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shop-item-info {
            flex: 1;
        }
        
        .shop-item-cost {
            color: #ff0;
            margin-left: 10px;
        }
        
        .item-comparison {
            font-size: 12px;
            margin-top: 3px;
        }
        
        .better-stat {
            color: #0f0;
        }
        
        .worse-stat {
            color: #f00;
        }
        
        .same-stat {
            color: #888;
        }
        
        .rarity-common { color: #fff; }
        .rarity-uncommon { color: #1eff00; }
        .rarity-rare { color: #0070dd; }
        .rarity-epic { color: #a335ee; }
        .rarity-legendary { color: #ff8000; }
        
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1s ease-out forwards;
        }
        
        .damage-text {
            color: #f00;
        }
        
        .heal-text {
            color: #0f0;
        }
        
        .mana-text {
            color: #0af;
        }
        
        .enemy-health-bar {
            width: 100%;
            height: 10px;
            background-color: #000;
            border: 1px solid #f00;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background-color: #f00;
            width: 100%;
            transition: width 0.3s;
        }
        
        .hotkey {
            font-size: 10px;
            color: #888;
            margin-left: 5px;
        }
        
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .quest-log {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .quest-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #0f0;
        }
        
        .quest-completed {
            color: #0f0;
            text-decoration: line-through;
        }
        
        .status-effect {
            display: inline-block;
            padding: 2px 5px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .status-poison {
            background-color: #0f0;
            color: #000;
        }
        
        .status-burn {
            background-color: #f00;
            color: #fff;
        }
        
        .status-stun {
            background-color: #ff0;
            color: #000;
        }
        
        .status-bleed {
            background-color: #800;
            color: #fff;
        }
        
        .status-freeze {
            background-color: #0af;
            color: #fff;
        }
        
        .tooltip {
            position: absolute;
            background: #000;
            border: 1px solid #0f0;
            padding: 8px;
            z-index: 1000;
            max-width: 250px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .quick-slot {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 1px solid #0f0;
            margin: 2px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
        }
        
        .quick-slots-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #ff0;
            padding: 20px;
            z-index: 2000;
            text-align: center;
            animation: achievementPop 3s ease-in-out forwards;
        }
        
        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .save-slot {
            border: 1px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .save-slot:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .save-info {
            font-size: 12px;
            color: #888;
        }
        
        .skill-tree {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .skill-node {
            border: 1px solid #0f0;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .skill-node.unlocked {
            background-color: #0f0;
            color: #000;
        }
        
        .skill-node.available {
            border-color: #ff0;
        }
        
        .skill-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .boss-health-container {
            position: relative;
            margin: 10px 0;
        }
        
        .boss-health-bar {
            height: 20px;
            background: linear-gradient(90deg, #f00, #ff0);
            border: 1px solid #fff;
            position: relative;
            overflow: hidden;
        }
        
        .boss-health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            color: #fff;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }
        
        .phase-indicator {
            color: #ff0;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
            animation: pulse 1s infinite;
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        @keyframes slash {
            0% { transform: translateX(-10px) rotate(-45deg); opacity: 0; }
            50% { transform: translateX(0) rotate(0); opacity: 1; }
            100% { transform: translateX(10px) rotate(45deg); opacity: 0; }
        }
        
        @keyframes spellCast {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        .boss-enemy {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        .slash-effect {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, transparent 40%, #f00 50%, transparent 60%);
            opacity: 0;
            pointer-events: none;
        }
        
        .spell-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            filter: blur(5px);
        }
        
        .fire-effect {
            background: radial-gradient(circle, #ff0, #f00);
            box-shadow: 0 0 20px #f00;
        }
        
        .ice-effect {
            background: radial-gradient(circle, #aaf, #00f);
            box-shadow: 0 0 20px #00f;
        }
        
        .lightning-effect {
            background: radial-gradient(circle, #ff0, #aa0);
            box-shadow: 0 0 20px #ff0;
        }
        
        .inventory-sort {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        
        .sort-button {
            flex: 1;
            padding: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="sound-toggle" id="sound-toggle">ðŸ”Š SOUND ON</div>
        
        <!-- Tooltip Element -->
        <div id="tooltip" class="tooltip"></div>
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>CASTLE OF SHADOWS</h1>
            <h3>Enhanced RPG</h3>
            <div style="margin: 40px 0;">
                <p>Welcome to the cursed Castle of Shadows!</p>
                <p>Choose your class and begin your quest.</p>
            </div>
            <div class="button" id="start-button">BEGIN ADVENTURE</div>
            <div class="button" id="load-button">LOAD GAME</div>
        </div>
        
        <!-- Load Game Screen -->
        <div id="load-screen" class="screen">
            <h1>LOAD GAME</h1>
            <div id="save-slots">
                <!-- Save slots will be populated here -->
            </div>
            <div class="button" id="back-from-load">BACK</div>
        </div>
        
        <!-- Class Selection Screen -->
        <div id="class-screen" class="screen">
            <h1>CHOOSE YOUR CLASS</h1>
            <div class="class-select">
                <div class="class-option" data-class="warrior">
                    <h3>WARRIOR</h3>
                    <p>High HP, Strength and Defense</p>
                    <p>Starts with Sword and Heavy Armor</p>
                </div>
                <div class="class-option" data-class="mage">
                    <h3>MAGE</h3>
                    <p>High Magic and Intelligence</p>
                    <p>Starts with Staff and Fire Spell</p>
                </div>
                <div class="class-option" data-class="rogue">
                    <h3>ROGUE</h3>
                    <p>High Agility, Critical and Dodge</p>
                    <p>Starts with Dagger and Light Armor</p>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>CASTLE OF SHADOWS</h2>
            <div class="stats">
                <div>
                    <div>Level: <span id="player-level">1</span></div>
                    <div>HP: <span id="player-hp">100</span>/<span id="player-max-hp">100</span></div>
                    <div>MP: <span id="player-mp">50</span>/<span id="player-max-mp">50</span></div>
                </div>
                <div>
                    <div>EXP: <span id="player-exp">0</span>/<span id="player-exp-needed">100</span></div>
                    <div>Gold: <span id="player-gold">10</span></div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="exp-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-bar">
                <div id="mp-bar" class="progress-fill mp-bar" style="width: 100%"></div>
            </div>
            
            <!-- Quick Slots -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="quick-slot-2">3</div>
            </div>
            
            <div class="stat-grid">
                <div>Strength: <span id="player-strength">10</span></div>
                <div>Defense: <span id="player-defense">5</span></div>
                <div>Agility: <span id="player-agility">10</span></div>
                <div>Dodge: <span id="player-dodge">5</span>%</div>
                <div>Critical: <span id="player-critical">5</span>%</div>
                <div>Accuracy: <span id="player-accuracy">85</span>%</div>
            </div>
            
            <div class="button" id="explore-button">EXPLORE CASTLE</div>
            <div class="button" id="inventory-button">INVENTORY</div>
            <div class="button" id="spells-button">SPELLS</div>
            <div class="button" id="spell-shop-button">SPELL SHOP</div>
            <div class="button" id="quests-button">QUESTS</div>
            <div class="button" id="skills-button">SKILL TREE</div>
            <div class="button" id="achievements-button">ACHIEVEMENTS</div>
            <div class="button" id="save-button">SAVE GAME</div>
            
            <h3>Active Effects</h3>
            <div id="status-effects">
                <!-- Status effects will appear here -->
            </div>
            
            <div class="log" id="game-log">
                <div class="log-entry">You stand in the entrance hall of the Castle of Shadows...</div>
            </div>
        </div>
        
        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <h2>BATTLE!</h2>
            <div class="stats">
                <div>
                    <div>Player HP: <span id="battle-player-hp">100</span>/<span id="battle-player-max-hp">100</span></div>
                    <div>Player MP: <span id="battle-player-mp">50</span>/<span id="battle-player-max-mp">50</span></div>
                </div>
                <div>
                    <div><span id="enemy-name">Goblin</span> HP: <span id="enemy-hp">50</span>/<span id="enemy-max-hp">50</span></div>
                </div>
            </div>
            <div class="progress-bar">
                <div id="battle-mp-bar" class="progress-fill mp-bar" style="width: 100%"></div>
            </div>
            
            <!-- Boss Health Bar -->
            <div id="boss-health-container" class="boss-health-container" style="display: none;">
                <div class="boss-health-bar">
                    <div id="boss-health-fill" style="width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0);"></div>
                </div>
                <div class="boss-health-text" id="boss-health-text">BOSS HEALTH: 100%</div>
            </div>
            
            <div class="enemy-health-bar">
                <div id="enemy-health-fill" class="enemy-health-fill" style="width: 100%"></div>
            </div>
            
            <div class="phase-indicator" id="phase-indicator" style="display: none;"></div>
            
            <div class="enemy" id="enemy-display">[ENEMY]</div>
            <div class="log" id="battle-log">
                <div class="log-entry">A wild enemy appears!</div>
            </div>
            <div class="battle-actions">
                <div class="button" id="attack-button">ATTACK <span class="hotkey">(1)</span></div>
                <div class="button" id="spell-button">SPELL <span class="hotkey">(2)</span></div>
                <div class="button" id="item-button">USE ITEM <span class="hotkey">(3)</span></div>
                <div class="button" id="flee-button">FLEE <span class="hotkey">(4)</span></div>
            </div>
            
            <!-- Quick Slots in Battle -->
            <div class="quick-slots-container">
                <div class="quick-slot" data-slot="0" id="battle-quick-slot-0">1</div>
                <div class="quick-slot" data-slot="1" id="battle-quick-slot-1">2</div>
                <div class="quick-slot" data-slot="2" id="battle-quick-slot-2">3</div>
            </div>
        </div>
        
        <!-- Spell Selection Screen (in battle) -->
        <div id="spell-select-screen" class="screen">
            <h2>SELECT SPELL</h2>
            <div class="stats">
                <div>MP: <span id="spell-select-mp">50</span>/<span id="spell-select-max-mp">50</span></div>
            </div>
            <div id="spell-select-list" class="spell-list">
                <!-- Spells will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spell-select">BACK</div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>INVENTORY</h2>
            <div class="stats">
                <div>Gold: <span id="inventory-gold">10</span></div>
            </div>
            
            <!-- Sort Buttons -->
            <div class="inventory-sort">
                <div class="button sort-button" data-sort="name">Sort by Name</div>
                <div class="button sort-button" data-sort="type">Sort by Type</div>
                <div class="button sort-button" data-sort="rarity">Sort by Rarity</div>
            </div>
            
            <h3>EQUIPMENT</h3>
            <div class="equipment-slots">
                <div class="equipment-slot" data-slot="head">
                    Head: <span id="head-slot">Empty</span>
                    <div id="head-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="chest">
                    Chest: <span id="chest-slot">Empty</span>
                    <div id="chest-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="hands">
                    Hands: <span id="hands-slot">Empty</span>
                    <div id="hands-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="shield">
                    Shield: <span id="shield-slot">Empty</span>
                    <div id="shield-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="mainhand">
                    Main Hand: <span id="mainhand-slot">Empty</span>
                    <div id="mainhand-stats" class="equipment-stats"></div>
                </div>
                <div class="equipment-slot" data-slot="offhand">
                    Off Hand: <span id="offhand-slot">Empty</span>
                    <div id="offhand-stats" class="equipment-stats"></div>
                </div>
            </div>
            
            <h3>INVENTORY ITEMS</h3>
            <div class="inventory-grid" id="inventory-items">
                <!-- Items will be added here dynamically -->
            </div>
            
            <div class="button" id="back-from-inventory">BACK</div>
        </div>
        
        <!-- Spells Screen -->
        <div id="spells-screen" class="screen">
            <h2>SPELLS</h2>
            <div id="spells-list" class="spell-list">
                <!-- Spells will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spells">BACK</div>
        </div>
        
        <!-- Spell Shop Screen -->
        <div id="spell-shop-screen" class="screen">
            <h2>SPELL SHOP</h2>
            <div class="stats">
                <div>Gold: <span id="shop-gold">10</span></div>
                <div>Level: <span id="shop-level">1</span></div>
            </div>
            <div id="spell-shop-items" class="spell-list">
                <!-- Spell shop items will be added here dynamically -->
            </div>
            <div class="button" id="back-from-spell-shop">BACK</div>
        </div>
        
        <!-- Quests Screen -->
        <div id="quests-screen" class="screen">
            <h2>QUESTS</h2>
            <div class="quest-log" id="quest-log">
                <!-- Quests will be added here dynamically -->
            </div>
            <div class="button" id="back-from-quests">BACK</div>
        </div>
        
        <!-- Skills Screen -->
        <div id="skills-screen" class="screen">
            <h2>SKILL TREE</h2>
            <div class="stats">
                <div>Skill Points: <span id="skill-points">0</span></div>
                <div>Class: <span id="skill-class">None</span></div>
            </div>
            <div id="skill-tree" class="skill-tree">
                <!-- Skill nodes will be added here dynamically -->
            </div>
            <div class="button" id="back-from-skills">BACK</div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievements-screen" class="screen">
            <h2>ACHIEVEMENTS</h2>
            <div id="achievements-list">
                <!-- Achievements will be added here dynamically -->
            </div>
            <div class="button" id="back-from-achievements">BACK</div>
        </div>
        
        <!-- Loot Screen -->
        <div id="loot-screen" class="screen">
            <h2>VICTORY!</h2>
            <div class="log">
                <div class="log-entry">You defeated the enemy!</div>
                <div class="log-entry">You gained <span id="exp-gained">0</span> experience!</div>
                <div class="log-entry">You found:</div>
                <div id="loot-items">
                    <!-- Loot items will be added here -->
                </div>
            </div>
            <div class="button" id="take-loot">CONTINUE</div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentScreen: 'start',
            player: {
                class: null,
                level: 1,
                exp: 0,
                expNeeded: 100,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                gold: 50,
                strength: 10,
                defense: 5,
                agility: 10,
                magic: 0,
                intelligence: 10,
                dodge: 5,
                critical: 5,
                accuracy: 85,
                equipment: {
                    head: null,
                    chest: null,
                    hands: null,
                    shield: null,
                    mainhand: null,
                    offhand: null
                },
                inventory: [],
                spells: [],
                statusEffects: [],
                quests: [],
                skillPoints: 0,
                skills: [],
                quickSlots: [null, null, null],
                achievements: []
            },
            currentEnemy: null,
            battleLog: [],
            gameLog: [],
            soundEnabled: true,
            enemyMaxHp: 0,
            saveSlots: 3,
            tooltipTimeout: null,
            // Achievement tracking
            enemiesDefeated: 0,
            roomsExplored: 0,
            totalGoldEarned: 0,
            spellsLearned: 0,
            dragonsDefeated: 0,
            goblinsDefeated: 0
        };

        // Sound Manager
        const SoundManager = {
            context: null,
            
            init() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio API is not supported in this browser");
                }
            },
            
            playTone(frequency, duration, type = 'sine', volume = 0.1) {
                if (!gameState.soundEnabled || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.value = volume;
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + duration);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + duration);
            },
            
            playClick() {
                this.playTone(800, 0.1, 'square', 0.05);
            },
            
            playAttack() {
                this.playTone(200, 0.2, 'sawtooth', 0.1);
            },
            
            playSpell() {
                this.playTone(600, 0.3, 'sine', 0.1);
            },
            
            playHeal() {
                this.playTone(400, 0.4, 'sine', 0.1);
            },
            
            playLevelUp() {
                this.playTone(523, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(784, 0.1, 'sine', 0.1), 200);
            },
            
            playVictory() {
                this.playTone(784, 0.2, 'sine', 0.1);
                setTimeout(() => this.playTone(659, 0.2, 'sine', 0.1), 200);
                setTimeout(() => this.playTone(523, 0.2, 'sine', 0.1), 400);
            },
            
            playDefeat() {
                this.playTone(200, 0.5, 'sawtooth', 0.1);
            },
            
            playCritical() {
                this.playTone(1000, 0.3, 'sawtooth', 0.2);
            },
            
            playDodge() {
                this.playTone(1200, 0.2, 'triangle', 0.1);
            },
            
            playAchievement() {
                this.playTone(1047, 0.1, 'sine', 0.1);
                setTimeout(() => this.playTone(1319, 0.1, 'sine', 0.1), 100);
                setTimeout(() => this.playTone(1568, 0.2, 'sine', 0.1), 200);
            }
        };

        // Quests
        const quests = {
            goblinSlayer: {
                id: "goblinSlayer",
                name: "Goblin Slayer",
                description: "Defeat 5 Goblins",
                target: "Goblin",
                required: 5,
                current: 0,
                reward: { gold: 100, exp: 50, item: "silver_sword" },
                completed: false
            },
            skeletonHunter: {
                id: "skeletonHunter",
                name: "Skeleton Hunter",
                description: "Defeat 3 Skeletons",
                target: "Skeleton",
                required: 3,
                current: 0,
                reward: { gold: 75, exp: 40, item: "iron_helmet" },
                completed: false
            }
        };

        // Achievements System
        const achievements = {
            firstBlood: {
                id: "firstBlood",
                name: "First Blood",
                description: "Defeat your first enemy",
                icon: "âš”ï¸",
                check: () => gameState.enemiesDefeated >= 1,
                unlocked: false
            },
            goblinSlayer: {
                id: "goblinSlayer",
                name: "Goblin Slayer",
                description: "Defeat 10 Goblins",
                icon: "ðŸ‘¹",
                check: () => gameState.goblinsDefeated >= 10,
                unlocked: false
            },
            masterExplorer: {
                id: "masterExplorer",
                name: "Master Explorer",
                description: "Explore 50 rooms",
                icon: "ðŸ—ºï¸",
                check: () => gameState.roomsExplored >= 50,
                unlocked: false
            },
            wealthyAdventurer: {
                id: "wealthyAdventurer",
                name: "Wealthy Adventurer",
                description: "Collect 1000 gold",
                icon: "ðŸ’°",
                check: () => gameState.totalGoldEarned >= 1000,
                unlocked: false
            },
            spellMaster: {
                id: "spellMaster",
                name: "Spell Master",
                description: "Learn 5 different spells",
                icon: "ðŸ”®",
                check: () => gameState.spellsLearned >= 5,
                unlocked: false
            },
            dragonSlayer: {
                id: "dragonSlayer",
                name: "Dragon Slayer",
                description: "Defeat the Shadow Dragon",
                icon: "ðŸ‰",
                check: () => gameState.dragonsDefeated >= 1,
                unlocked: false
            }
        };

        // Skill Trees
        const skillTrees = {
            warrior: [
                { id: "warrior1", name: "Power Strike", description: "Increases attack damage by 10%", cost: 1, effect: "damageBoost", value: 0.1, requires: [] },
                { id: "warrior2", name: "Iron Skin", description: "Increases defense by 15%", cost: 1, effect: "defenseBoost", value: 0.15, requires: ["warrior1"] },
                { id: "warrior3", name: "Battle Fury", description: "Critical chance increased by 5%", cost: 2, effect: "criticalBoost", value: 5, requires: ["warrior1"] },
                { id: "warrior4", name: "Second Wind", description: "Chance to heal when below 30% HP", cost: 2, effect: "secondWind", value: 0.2, requires: ["warrior2", "warrior3"] }
            ],
            mage: [
                { id: "mage1", name: "Arcane Focus", description: "Spell damage increased by 15%", cost: 1, effect: "spellDamageBoost", value: 0.15, requires: [] },
                { id: "mage2", name: "Mana Efficiency", description: "Spell costs reduced by 20%", cost: 1, effect: "manaEfficiency", value: 0.2, requires: ["mage1"] },
                { id: "mage3", name: "Elemental Mastery", description: "Chance to apply elemental effects", cost: 2, effect: "elementalMastery", value: 0.15, requires: ["mage1"] },
                { id: "mage4", name: "Arcane Surge", description: "Chance to cast spells for free", cost: 2, effect: "arcaneSurge", value: 0.1, requires: ["mage2", "mage3"] }
            ],
            rogue: [
                { id: "rogue1", name: "Deadly Precision", description: "Critical damage increased by 25%", cost: 1, effect: "criticalDamage", value: 0.25, requires: [] },
                { id: "rogue2", name: "Shadow Step", description: "Dodge chance increased by 10%", cost: 1, effect: "dodgeBoost", value: 10, requires: ["rogue1"] },
                { id: "rogue3", name: "Poisoned Blade", description: "Chance to apply poison on hit", cost: 2, effect: "poisonChance", value: 0.2, requires: ["rogue1"] },
                { id: "rogue4", name: "Assassinate", description: "Chance to instantly kill weak enemies", cost: 2, effect: "assassinate", value: 0.1, requires: ["rogue2", "rogue3"] }
            ]
        };

        // Game Data
        const classes = {
            warrior: {
                name: "Warrior",
                hp: 120,
                mp: 30,
                strength: 15,
                defense: 10,
                agility: 8,
                magic: 0,
                intelligence: 6,
                dodge: 3,
                critical: 5,
                accuracy: 80,
                startingItems: ['iron_sword', 'leather_armor', 'health_potion'],
                startingSpells: []
            },
            mage: {
                name: "Mage",
                hp: 80,
                mp: 100,
                strength: 5,
                defense: 3,
                agility: 10,
                magic: 15,
                intelligence: 15,
                dodge: 5,
                critical: 8,
                accuracy: 90,
                startingItems: ['oak_staff', 'cloth_robe', 'mana_potion', 'health_potion'],
                startingSpells: ['fire_bolt']
            },
            rogue: {
                name: "Rogue",
                hp: 90,
                mp: 60,
                strength: 12,
                defense: 4,
                agility: 15,
                magic: 5,
                intelligence: 8,
                dodge: 10,
                critical: 15,
                accuracy: 95,
                startingItems: ['steel_dagger', 'leather_vest', 'health_potion'],
                startingSpells: ['shadow_strike']
            }
        };

        // COMPLETELY UPDATED ITEMS WITH ALL NEW WEAPONS AND ARMOR
        const items = {
            // Common Weapons
            iron_sword: { 
                name: "Iron Sword", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 8, max: 12 },
                strength: 2,
                critical: 2,
                value: 15,
                rarity: "common",
                set: null
            },
            steel_dagger: { 
                name: "Steel Dagger", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 6, max: 10 },
                agility: 3,
                critical: 5,
                value: 10,
                rarity: "common",
                set: null
            },
            oak_staff: { 
                name: "Oak Staff", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 3, max: 6 },
                magic: 5,
                intelligence: 2,
                value: 12,
                rarity: "common",
                set: null
            },
            
            // Uncommon Weapons
            silver_sword: { 
                name: "Silver Sword", 
                type: "weapon", 
                slot: "mainhand", 
                damage: { min: 12, max: 18 },
                strength: 3,
                critical: 3,
                value: 30,
                rarity: "uncommon",
                set: "silver_set"
            },
            assassins_blade: {
                name: "Assassin's Blade",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 10, max: 15 },
                agility: 5,
                critical: 10,
                value: 35,
                rarity: "uncommon",
                set: null
            },
            crystal_staff: {
                name: "Crystal Staff",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 5, max: 9 },
                magic: 8,
                intelligence: 4,
                value: 40,
                rarity: "uncommon",
                set: null
            },
            
            // Rare Weapons
            dragonslayer: {
                name: "Dragonslayer",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 18, max: 26 },
                strength: 6,
                critical: 5,
                value: 100,
                rarity: "rare",
                set: null
            },
            shadowstrike_dagger: {
                name: "Shadowstrike Dagger",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 14, max: 20 },
                agility: 8,
                critical: 15,
                value: 90,
                rarity: "rare",
                set: null
            },
            archmage_staff: {
                name: "Archmage Staff",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 8, max: 14 },
                magic: 12,
                intelligence: 8,
                value: 110,
                rarity: "rare",
                set: null
            },
            
            // Epic Weapons
            excalibur: {
                name: "Excalibur",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 25, max: 35 },
                strength: 10,
                critical: 10,
                value: 300,
                rarity: "epic",
                set: null
            },
            deathwalker_blade: {
                name: "Deathwalker Blade",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 20, max: 30 },
                agility: 12,
                critical: 20,
                value: 280,
                rarity: "epic",
                set: null
            },
            staff_of_eternity: {
                name: "Staff of Eternity",
                type: "weapon",
                slot: "mainhand",
                damage: { min: 15, max: 25 },
                magic: 20,
                intelligence: 12,
                value: 320,
                rarity: "epic",
                set: null
            },
            
            // Common Armor
            leather_armor: { 
                name: "Leather Armor", 
                type: "armor", 
                slot: "chest", 
                defense: 5,
                agility: 1,
                value: 10,
                rarity: "common",
                set: null
            },
            cloth_robe: { 
                name: "Cloth Robe", 
                type: "armor", 
                slot: "chest", 
                defense: 2, 
                magic: 3,
                intelligence: 2,
                value: 8,
                rarity: "common",
                set: null
            },
            leather_vest: { 
                name: "Leather Vest", 
                type: "armor", 
                slot: "chest", 
                defense: 3,
                agility: 3,
                dodge: 2,
                value: 7,
                rarity: "common",
                set: null
            },
            
            // Uncommon Armor
            chainmail: {
                name: "Chainmail",
                type: "armor",
                slot: "chest",
                defense: 8,
                strength: 1,
                value: 25,
                rarity: "uncommon",
                set: null
            },
            mage_robe: {
                name: "Mage Robe",
                type: "armor",
                slot: "chest",
                defense: 4,
                magic: 5,
                intelligence: 3,
                value: 22,
                rarity: "uncommon",
                set: null
            },
            shadow_leather: {
                name: "Shadow Leather",
                type: "armor",
                slot: "chest",
                defense: 5,
                agility: 6,
                dodge: 5,
                value: 28,
                rarity: "uncommon",
                set: null
            },
            
            // Rare Armor
            plate_armor: {
                name: "Plate Armor",
                type: "armor",
                slot: "chest",
                defense: 12,
                strength: 2,
                agility: -2,
                value: 60,
                rarity: "rare",
                set: null
            },
            archmage_robe: {
                name: "Archmage Robe",
                type: "armor",
                slot: "chest",
                defense: 6,
                magic: 8,
                intelligence: 6,
                value: 65,
                rarity: "rare",
                set: null
            },
            assassins_garb: {
                name: "Assassin's Garb",
                type: "armor",
                slot: "chest",
                defense: 7,
                agility: 8,
                dodge: 8,
                value: 70,
                rarity: "rare",
                set: null
            },
            
            // Epic Armor
            dragonbone_armor: {
                name: "Dragonbone Armor",
                type: "armor",
                slot: "chest",
                defense: 18,
                strength: 5,
                value: 150,
                rarity: "epic",
                set: null
            },
            robe_of_the_archlich: {
                name: "Robe of the Archlich",
                type: "armor",
                slot: "chest",
                defense: 10,
                magic: 15,
                intelligence: 10,
                value: 160,
                rarity: "epic",
                set: null
            },
            cloak_of_shadows: {
                name: "Cloak of Shadows",
                type: "armor",
                slot: "chest",
                defense: 8,
                agility: 12,
                dodge: 15,
                value: 155,
                rarity: "epic",
                set: null
            },
            
            // Helmets
            leather_cap: { 
                name: "Leather Cap", 
                type: "armor", 
                slot: "head", 
                defense: 2,
                value: 5,
                rarity: "common",
                set: null
            },
            iron_helmet: { 
                name: "Iron Helmet", 
                type: "armor", 
                slot: "head", 
                defense: 4,
                value: 15,
                rarity: "uncommon",
                set: "iron_set"
            },
            mage_hood: {
                name: "Mage Hood",
                type: "armor",
                slot: "head",
                defense: 1,
                magic: 2,
                intelligence: 2,
                value: 12,
                rarity: "uncommon",
                set: null
            },
            great_helm: {
                name: "Great Helm",
                type: "armor",
                slot: "head",
                defense: 6,
                value: 30,
                rarity: "rare",
                set: null
            },
            crown_of_wisdom: {
                name: "Crown of Wisdom",
                type: "armor",
                slot: "head",
                defense: 3,
                magic: 5,
                intelligence: 8,
                value: 80,
                rarity: "epic",
                set: null
            },
            
            // Gloves
            leather_gloves: { 
                name: "Leather Gloves", 
                type: "armor", 
                slot: "hands", 
                defense: 1,
                agility: 1,
                value: 3,
                rarity: "common",
                set: null
            },
            iron_gauntlets: { 
                name: "Iron Gauntlets", 
                type: "armor", 
                slot: "hands", 
                defense: 3,
                strength: 1,
                value: 12,
                rarity: "uncommon",
                set: null
            },
            rogue_gloves: {
                name: "Rogue Gloves",
                type: "armor",
                slot: "hands",
                defense: 2,
                agility: 3,
                critical: 2,
                value: 15,
                rarity: "uncommon",
                set: null
            },
            dragonscale_gloves: {
                name: "Dragonscale Gloves",
                type: "armor",
                slot: "hands",
                defense: 5,
                strength: 3,
                value: 45,
                rarity: "rare",
                set: null
            },
            gloves_of_swiftness: {
                name: "Gloves of Swiftness",
                type: "armor",
                slot: "hands",
                defense: 3,
                agility: 8,
                dodge: 5,
                value: 90,
                rarity: "epic",
                set: null
            },
            
            // Shields
            wooden_shield: { 
                name: "Wooden Shield", 
                type: "armor", 
                slot: "shield", 
                defense: 3,
                value: 8,
                rarity: "common",
                set: null
            },
            iron_shield: {
                name: "Iron Shield",
                type: "armor",
                slot: "shield",
                defense: 5,
                value: 20,
                rarity: "uncommon",
                set: null
            },
            tower_shield: {
                name: "Tower Shield",
                type: "armor",
                slot: "shield",
                defense: 8,
                agility: -3,
                value: 40,
                rarity: "rare",
                set: null
            },
            aegis_of_protection: {
                name: "Aegis of Protection",
                type: "armor",
                slot: "shield",
                defense: 12,
                value: 100,
                rarity: "epic",
                set: null
            },
            
            // Consumables
            health_potion: { 
                name: "Health Potion", 
                type: "consumable", 
                effect: "heal", 
                power: 30, 
                value: 5,
                rarity: "common"
            },
            mana_potion: { 
                name: "Mana Potion", 
                type: "consumable", 
                effect: "restore_mana", 
                power: 20, 
                value: 5,
                rarity: "common"
            },
            greater_health_potion: {
                name: "Greater Health Potion",
                type: "consumable",
                effect: "heal",
                power: 60,
                value: 15,
                rarity: "uncommon"
            },
            greater_mana_potion: {
                name: "Greater Mana Potion",
                type: "consumable",
                effect: "restore_mana",
                power: 40,
                value: 15,
                rarity: "uncommon"
            },
            agility_potion: {
                name: "Agility Potion",
                type: "consumable",
                effect: "agility_boost",
                power: 5,
                duration: 3,
                value: 20,
                rarity: "uncommon"
            },
            strength_potion: {
                name: "Strength Potion",
                type: "consumable",
                effect: "strength_boost",
                power: 5,
                duration: 3,
                value: 20,
                rarity: "uncommon"
            },
            elixir_of_life: {
                name: "Elixir of Life",
                type: "consumable",
                effect: "full_heal",
                power: 0,
                value: 50,
                rarity: "rare"
            },
            antidote: {
                name: "Antidote",
                type: "consumable",
                effect: "cure_poison",
                power: 0,
                value: 10,
                rarity: "common"
            }
        };

        // Item Sets with Bonuses
        const itemSets = {
            silver_set: {
                name: "Silver Set",
                pieces: ["silver_sword", "silver_gauntlets"],
                bonuses: {
                    2: { description: "+10% Critical Chance", effect: "critical", value: 10 }
                }
            },
            iron_set: {
                name: "Iron Set",
                pieces: ["iron_helmet", "iron_chestplate"],
                bonuses: {
                    2: { description: "+15% Defense", effect: "defense", value: 0.15 }
                }
            }
        };

        // Spells with Elemental Types
        const spells = {
            fire_bolt: { 
                name: "Fire Bolt", 
                cost: 5, 
                damage: { min: 15, max: 25 },
                type: "attack",
                element: "fire",
                accuracy: 90,
                levelReq: 1,
                goldCost: 20,
                description: "Launches a bolt of fire at the enemy",
                effect: { type: "burn", chance: 0.2, duration: 3, damage: 3 }
            },
            shadow_strike: { 
                name: "Shadow Strike", 
                cost: 8, 
                damage: { min: 20, max: 30 },
                type: "attack",
                element: "dark",
                accuracy: 95,
                critical: 15,
                levelReq: 1,
                goldCost: 30,
                description: "Strikes from the shadows with increased critical chance"
            },
            heal: { 
                name: "Heal", 
                cost: 10, 
                power: 25, 
                type: "heal",
                levelReq: 2,
                goldCost: 50,
                description: "Restores a moderate amount of health"
            },
            ice_shard: {
                name: "Ice Shard",
                cost: 7,
                damage: { min: 12, max: 20 },
                type: "attack",
                element: "ice",
                accuracy: 85,
                levelReq: 3,
                goldCost: 40,
                description: "Launches a sharp shard of ice",
                effect: { type: "freeze", chance: 0.15, duration: 1 }
            },
            lightning_bolt: {
                name: "Lightning Bolt",
                cost: 12,
                damage: { min: 25, max: 35 },
                type: "attack",
                element: "lightning",
                accuracy: 80,
                levelReq: 4,
                goldCost: 60,
                description: "Calls down a bolt of lightning",
                effect: { type: "stun", chance: 0.1, duration: 1 }
            }
        };

        // UPDATED ENEMIES WITH NEW LOOT TABLES
        const enemies = {
            level1: [
                { 
                    name: "Goblin", 
                    hp: 30, 
                    attack: 8, 
                    defense: 2, 
                    agility: 8,
                    dodge: 5,
                    critical: 5,
                    accuracy: 75,
                    exp: 20, 
                    gold: 5, 
                    loot: [
                        { id: 'health_potion', chance: 0.7 }
                    ],
                    resistances: { fire: 0.5 },
                    weaknesses: { ice: 1.5 }
                },
                { 
                    name: "Skeleton", 
                    hp: 25, 
                    attack: 10, 
                    defense: 3, 
                    agility: 6,
                    dodge: 3,
                    critical: 3,
                    accuracy: 80,
                    exp: 25, 
                    gold: 8, 
                    loot: [
                        { id: 'wooden_shield', chance: 0.6 }
                    ],
                    resistances: { piercing: 0.5 },
                    weaknesses: { blunt: 2.0 }
                },
                { 
                    name: "Bat Swarm", 
                    hp: 20, 
                    attack: 12, 
                    defense: 1, 
                    agility: 15,
                    dodge: 10,
                    critical: 8,
                    accuracy: 85,
                    exp: 18, 
                    gold: 3, 
                    loot: [
                        { id: 'leather_gloves', chance: 0.5 }
                    ],
                    resistances: { dark: 0.8 },
                    weaknesses: { fire: 1.5, lightning: 1.5 }
                }
            ],
            level2: [
                { 
                    name: "Zombie", 
                    hp: 50, 
                    attack: 12, 
                    defense: 4, 
                    agility: 4,
                    dodge: 2,
                    critical: 2,
                    accuracy: 70,
                    exp: 35, 
                    gold: 12, 
                    loot: [
                        { id: 'health_potion', chance: 0.8 },
                        { id: 'leather_cap', chance: 0.8 }
                    ],
                    statusEffects: [{ type: "poison", chance: 0.1, damage: 2, duration: 3 }]
                },
                { 
                    name: "Ghoul", 
                    hp: 45, 
                    attack: 15, 
                    defense: 3, 
                    agility: 10,
                    dodge: 6,
                    critical: 6,
                    accuracy: 80,
                    exp: 40, 
                    gold: 15, 
                    loot: [
                        { id: 'iron_gauntlets', chance: 0.7 }
                    ],
                    abilities: ["life_drain"]
                },
                { 
                    name: "Wraith", 
                    hp: 40, 
                    attack: 18, 
                    defense: 2, 
                    agility: 12,
                    dodge: 8,
                    critical: 10,
                    accuracy: 85,
                    exp: 38, 
                    gold: 10, 
                    loot: [
                        { id: 'mana_potion', chance: 0.6 }
                    ],
                    resistances: { physical: 0.5, dark: 0.8 },
                    weaknesses: { holy: 2.0 }
                }
            ],
            level3: [
                { 
                    name: "Vampire Spawn", 
                    hp: 80, 
                    attack: 20, 
                    defense: 6, 
                    agility: 14,
                    dodge: 10,
                    critical: 12,
                    accuracy: 85,
                    exp: 60, 
                    gold: 25, 
                    loot: [
                        { id: 'greater_health_potion', chance: 0.8 },
                        { id: 'iron_helmet', chance: 0.8 }
                    ],
                    abilities: ["life_steal"],
                    resistances: { dark: 0.8, physical: 0.7 },
                    weaknesses: { fire: 1.5, holy: 2.0 }
                },
                { 
                    name: "Shadow Beast", 
                    hp: 90, 
                    attack: 22, 
                    defense: 5, 
                    agility: 16,
                    dodge: 12,
                    critical: 15,
                    accuracy: 90,
                    exp: 70, 
                    gold: 30, 
                    loot: [
                        { id: 'chainmail', chance: 0.7 }
                    ],
                    resistances: { dark: 0.9, physical: 0.6 },
                    weaknesses: { light: 2.0, fire: 1.5 }
                },
                { 
                    name: "Death Knight", 
                    hp: 100, 
                    attack: 25, 
                    defense: 8, 
                    agility: 10,
                    dodge: 6,
                    critical: 8,
                    accuracy: 85,
                    exp: 80, 
                    gold: 40, 
                    loot: [
                        { id: 'silver_sword', chance: 0.6 }
                    ],
                    resistances: { physical: 0.8, dark: 0.7 },
                    weaknesses: { holy: 2.0, lightning: 1.5 }
                }
            ],
            level4: [
                { 
                    name: "Lich", 
                    hp: 120, 
                    attack: 28, 
                    defense: 6, 
                    agility: 12,
                    dodge: 8,
                    critical: 18,
                    accuracy: 90,
                    exp: 100, 
                    gold: 60, 
                    loot: [
                        { id: 'crystal_staff', chance: 0.8 },
                        { id: 'mage_robe', chance: 0.8 }
                    ],
                    abilities: ["raise_dead", "death_bolt"],
                    resistances: { dark: 0.9, magic: 0.8 },
                    weaknesses: { holy: 2.0, fire: 1.5 }
                },
                { 
                    name: "Dragon Whelp", 
                    hp: 150, 
                    attack: 32, 
                    defense: 10, 
                    agility: 14,
                    dodge: 10,
                    critical: 15,
                    accuracy: 85,
                    exp: 120, 
                    gold: 80, 
                    loot: [
                        { id: 'dragonslayer', chance: 0.7 },
                        { id: 'dragonscale_gloves', chance: 0.7 }
                    ],
                    abilities: ["fire_breath"],
                    resistances: { fire: 0.9, physical: 0.7 },
                    weaknesses: { ice: 2.0 }
                },
                { 
                    name: "Shadow Lord", 
                    hp: 140, 
                    attack: 30, 
                    defense: 8, 
                    agility: 18,
                    dodge: 15,
                    critical: 20,
                    accuracy: 95,
                    exp: 110, 
                    gold: 100, 
                    loot: [
                        { id: 'shadowstrike_dagger', chance: 0.6 },
                        { id: 'assassins_garb', chance: 0.6 }
                    ],
                    abilities: ["shadow_clone", "dark_embrace"],
                    resistances: { dark: 1.0, physical: 0.6 },
                    weaknesses: { light: 2.5, holy: 2.0 }
                }
            ],
            bosses: [
                {
                    name: "Shadow Dragon",
                    hp: 200,
                    attack: 25,
                    defense: 10,
                    agility: 12,
                    dodge: 8,
                    critical: 10,
                    accuracy: 85,
                    exp: 200,
                    gold: 100,
                    loot: [
                        { id: 'excalibur', chance: 0.5 },
                        { id: 'dragonbone_armor', chance: 0.5 }
                    ],
                    isBoss: true,
                    phases: [
                        { hpThreshold: 0.7, ability: "fire_breath", message: "The dragon unleashes a fiery breath!" },
                        { hpThreshold: 0.4, ability: "shadow_cloak", message: "The dragon vanishes into shadows!" },
                        { hpThreshold: 0.2, ability: "frenzy", message: "The dragon goes into a frenzy!" }
                    ],
                    abilities: {
                        fire_breath: { damage: 30, cooldown: 3 },
                        shadow_cloak: { dodge: 50, duration: 2 },
                        frenzy: { attack: 1.5, speed: 1.5 }
                    }
                }
            ]
        };

        // DOM Elements
        const screens = {
            start: document.getElementById('start-screen'),
            load: document.getElementById('load-screen'),
            class: document.getElementById('class-screen'),
            game: document.getElementById('game-screen'),
            battle: document.getElementById('battle-screen'),
            spellSelect: document.getElementById('spell-select-screen'),
            inventory: document.getElementById('inventory-screen'),
            spells: document.getElementById('spells-screen'),
            spellShop: document.getElementById('spell-shop-screen'),
            quests: document.getElementById('quests-screen'),
            skills: document.getElementById('skills-screen'),
            achievements: document.getElementById('achievements-screen'),
            loot: document.getElementById('loot-screen')
        };

        // Initialize game
        function initGame() {
            console.log("Initializing game...");
            
            // Initialize sound manager
            SoundManager.init();
            
            // Set up event listeners
            document.getElementById('start-button').addEventListener('click', () => {
                console.log("Start button clicked");
                SoundManager.playClick();
                showClassSelection();
            });
            
            document.getElementById('load-button').addEventListener('click', () => {
                SoundManager.playClick();
                showLoadScreen();
            });
            
            const classOptions = document.querySelectorAll('.class-option');
            classOptions.forEach(option => {
                option.addEventListener('click', () => {
                    SoundManager.playClick();
                    selectClass(option.dataset.class);
                });
            });
            
            document.getElementById('explore-button').addEventListener('click', () => {
                SoundManager.playClick();
                startBattle();
            });
            
            document.getElementById('inventory-button').addEventListener('click', () => {
                SoundManager.playClick();
                showInventory();
            });
            
            document.getElementById('spells-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpells();
            });
            
            document.getElementById('spell-shop-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpellShop();
            });
            
            document.getElementById('quests-button').addEventListener('click', () => {
                SoundManager.playClick();
                showQuests();
            });
            
            document.getElementById('skills-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSkills();
            });
            
            document.getElementById('achievements-button').addEventListener('click', () => {
                SoundManager.playClick();
                showAchievements();
            });
            
            document.getElementById('save-button').addEventListener('click', () => {
                SoundManager.playClick();
                saveGame(0);
                addToGameLog("Game saved!");
            });
            
            document.getElementById('back-from-inventory').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-spells').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-spell-shop').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-quests').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-skills').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-achievements').addEventListener('click', () => {
                SoundManager.playClick();
                showGameScreen();
            });
            
            document.getElementById('back-from-load').addEventListener('click', () => {
                SoundManager.playClick();
                showScreen('start');
            });
            
            document.getElementById('back-from-spell-select').addEventListener('click', () => {
                SoundManager.playClick();
                showBattleScreen();
            });
            
            // Battle buttons
            document.getElementById('attack-button').addEventListener('click', playerAttack);
            document.getElementById('spell-button').addEventListener('click', () => {
                SoundManager.playClick();
                showSpellSelection();
            });
            document.getElementById('item-button').addEventListener('click', useItemInBattle);
            document.getElementById('flee-button').addEventListener('click', attemptFlee);
            
            document.getElementById('take-loot').addEventListener('click', () => {
                SoundManager.playClick();
                takeLoot();
            });
            
            // Sound toggle
            document.getElementById('sound-toggle').addEventListener('click', toggleSound);
            
            // Sort buttons
            document.querySelectorAll('.sort-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    sortInventory(e.target.dataset.sort);
                });
            });
            
            // Quick slots
            document.querySelectorAll('.quick-slot').forEach(slot => {
                slot.addEventListener('click', (e) => {
                    SoundManager.playClick();
                    useQuickSlot(parseInt(e.target.dataset.slot));
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyPress);
            
            // Initialize quests
            initializeQuests();
            
            // Initialize achievements
            initializeAchievements();
            
            // Initialize game log
            addToGameLog("You stand in the entrance hall of the Castle of Shadows...");
            
            console.log("Game initialized successfully");
        }

        // Screen management
        function showScreen(screenName) {
            // Hide all screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the requested screen
            screens[screenName].classList.add('active');
            gameState.currentScreen = screenName;
        }

        function showClassSelection() {
            showScreen('class');
        }

        function selectClass(className) {
            gameState.player.class = className;
            const classData = classes[className];
            
            // Set player stats based on class
            gameState.player.maxHp = classData.hp;
            gameState.player.hp = classData.hp;
            gameState.player.maxMp = classData.mp;
            gameState.player.mp = classData.mp;
            gameState.player.strength = classData.strength;
            gameState.player.defense = classData.defense;
            gameState.player.agility = classData.agility;
            gameState.player.magic = classData.magic;
            gameState.player.intelligence = classData.intelligence;
            gameState.player.dodge = classData.dodge;
            gameState.player.critical = classData.critical;
            gameState.player.accuracy = classData.accuracy;
            
            // Add starting items
            classData.startingItems.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            // Add starting spells
            classData.startingSpells.forEach(spellId => {
                gameState.player.spells.push(spellId);
            });
            
            // Equip starting items
            if (className === 'warrior') {
                equipItem('iron_sword', 'mainhand');
                equipItem('leather_armor', 'chest');
            } else if (className === 'mage') {
                equipItem('oak_staff', 'mainhand');
                equipItem('cloth_robe', 'chest');
            } else if (className === 'rogue') {
                equipItem('steel_dagger', 'mainhand');
                equipItem('leather_vest', 'chest');
            }
            
            // Update UI
            updatePlayerStats();
            showGameScreen();
            
            addToGameLog(`You have chosen the path of the ${classData.name}.`);
            addToGameLog("You venture deeper into the Castle of Shadows...");
        }

        function showGameScreen() {
            showScreen('game');
            updatePlayerStats();
            updateStatusEffects();
        }

        function showBattleScreen() {
            showScreen('battle');
            updateBattleStats();
        }

        function showInventory() {
            showScreen('inventory');
            updateInventoryDisplay();
        }

        function showSpells() {
            showScreen('spells');
            updateSpellsDisplay();
        }

        function showSpellShop() {
            showScreen('spellShop');
            updateSpellShopDisplay();
        }

        function showSpellSelection() {
            showScreen('spellSelect');
            updateSpellSelectionDisplay();
        }

        function showQuests() {
            showScreen('quests');
            updateQuestsDisplay();
        }

        function showSkills() {
            showScreen('skills');
            updateSkillsDisplay();
        }

        function showAchievements() {
            showScreen('achievements');
            updateAchievementsDisplay();
        }

        function showLoadScreen() {
            showScreen('load');
            updateLoadScreen();
        }

        // Initialize quests
        function initializeQuests() {
            gameState.player.quests = [
                { ...quests.goblinSlayer },
                { ...quests.skeletonHunter }
            ];
        }

        // Initialize achievements
        function initializeAchievements() {
            gameState.player.achievements = [];
        }

        // Check achievements
        function checkAchievements() {
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                if (!gameState.player.achievements.includes(achievementId) && achievement.check()) {
                    unlockAchievement(achievementId);
                }
            });
        }

        function unlockAchievement(achievementId) {
            const achievement = achievements[achievementId];
            gameState.player.achievements.push(achievementId);
            
            // Show achievement popup
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <h3>Achievement Unlocked!</h3>
                <strong>${achievement.name}</strong><br>
                <small>${achievement.description}</small>
            `;
            
            document.body.appendChild(popup);
            
            // Play sound
            SoundManager.playAchievement();
            
            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
            }, 3000);
            
            addToGameLog(`Achievement unlocked: ${achievement.name}!`);
        }

        // Handle keyboard shortcuts
        function handleKeyPress(event) {
            if (gameState.currentScreen === 'battle') {
                switch(event.key) {
                    case '1':
                        SoundManager.playClick();
                        playerAttack();
                        break;
                    case '2':
                        SoundManager.playClick();
                        showSpellSelection();
                        break;
                    case '3':
                        SoundManager.playClick();
                        useItemInBattle();
                        break;
                    case '4':
                        SoundManager.playClick();
                        attemptFlee();
                        break;
                }
            }
        }

        // Toggle sound on/off
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('sound-toggle').textContent = 
                gameState.soundEnabled ? "ðŸ”Š SOUND ON" : "ðŸ”‡ SOUND OFF";
            SoundManager.playClick();
        }

        // Quick Slot System
        function useQuickSlot(slot) {
            const itemId = gameState.player.quickSlots[slot];
            if (!itemId) return;
            
            if (items[itemId]) {
                // It's an item
                useItem(itemId);
            } else if (spells[itemId]) {
                // It's a spell
                if (gameState.currentScreen === 'battle') {
                    castSpell(itemId);
                }
            }
        }

        function assignQuickSlot(slot, itemId) {
            gameState.player.quickSlots[slot] = itemId;
            updateQuickSlotDisplay();
        }

        function updateQuickSlotDisplay() {
            for (let i = 0; i < 3; i++) {
                const itemId = gameState.player.quickSlots[i];
                const slotElement = document.getElementById(`quick-slot-${i}`);
                const battleSlotElement = document.getElementById(`battle-quick-slot-${i}`);
                
                if (itemId) {
                    const item = items[itemId] || spells[itemId];
                    if (item) {
                        slotElement.textContent = `${i + 1}: ${item.name.substring(0, 3)}`;
                        if (battleSlotElement) {
                            battleSlotElement.textContent = `${i + 1}: ${item.name.substring(0, 3)}`;
                        }
                    }
                } else {
                    slotElement.textContent = i + 1;
                    if (battleSlotElement) {
                        battleSlotElement.textContent = i + 1;
                    }
                }
            }
        }

        // Enhanced Save System
        function saveGame(slot) {
            const saveData = {
                player: gameState.player,
                timestamp: Date.now(),
                version: "2.0",
                enemiesDefeated: gameState.enemiesDefeated,
                roomsExplored: gameState.roomsExplored,
                totalGoldEarned: gameState.totalGoldEarned,
                spellsLearned: gameState.spellsLearned,
                dragonsDefeated: gameState.dragonsDefeated,
                goblinsDefeated: gameState.goblinsDefeated
            };
            
            localStorage.setItem(`castleShadowsSave_${slot}`, JSON.stringify(saveData));
        }

        function loadGame(slot) {
            const saveData = localStorage.getItem(`castleShadowsSave_${slot}`);
            if (saveData) {
                const data = JSON.parse(saveData);
                
                // Restore game state
                gameState.player = data.player;
                gameState.enemiesDefeated = data.enemiesDefeated || 0;
                gameState.roomsExplored = data.roomsExplored || 0;
                gameState.totalGoldEarned = data.totalGoldEarned || 0;
                gameState.spellsLearned = data.spellsLearned || 0;
                gameState.dragonsDefeated = data.dragonsDefeated || 0;
                gameState.goblinsDefeated = data.goblinsDefeated || 0;
                
                updatePlayerStats();
                showGameScreen();
                addToGameLog("Game loaded successfully!");
                
                // Check achievements after load
                checkAchievements();
            }
        }

        function updateLoadScreen() {
            const saveSlotsElement = document.getElementById('save-slots');
            saveSlotsElement.innerHTML = '';
            
            for (let i = 0; i < gameState.saveSlots; i++) {
                const saveData = localStorage.getItem(`castleShadowsSave_${i}`);
                const slotElement = document.createElement('div');
                slotElement.className = 'save-slot';
                
                if (saveData) {
                    const data = JSON.parse(saveData);
                    const date = new Date(data.timestamp);
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        Level ${data.player.level} ${data.player.class}<br>
                        <small class="save-info">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</small>
                    `;
                } else {
                    slotElement.innerHTML = `
                        <strong>Slot ${i + 1}</strong><br>
                        <small class="save-info">Empty</small>
                    `;
                }
                
                slotElement.addEventListener('click', () => {
                    if (saveData) {
                        loadGame(i);
                    }
                });
                
                saveSlotsElement.appendChild(slotElement);
            }
        }

        // Skill Tree System
        function updateSkillsDisplay() {
            document.getElementById('skill-points').textContent = gameState.player.skillPoints;
            document.getElementById('skill-class').textContent = gameState.player.class ? 
                gameState.player.class.charAt(0).toUpperCase() + gameState.player.class.slice(1) : 'None';
            
            const skillTreeElement = document.getElementById('skill-tree');
            skillTreeElement.innerHTML = '';
            
            if (!gameState.player.class) {
                skillTreeElement.innerHTML = '<div>Select a class first!</div>';
                return;
            }
            
            const skills = skillTrees[gameState.player.class];
            skills.forEach(skill => {
                const isUnlocked = gameState.player.skills.includes(skill.id);
                const requirementsMet = skill.requires.every(req => gameState.player.skills.includes(req));
                const canUnlock = !isUnlocked && requirementsMet && gameState.player.skillPoints >= skill.cost;
                
                const skillElement = document.createElement('div');
                skillElement.className = `skill-node ${isUnlocked ? 'unlocked' : canUnlock ? 'available' : 'locked'}`;
                skillElement.innerHTML = `
                    <strong>${skill.name}</strong><br>
                    <small>${skill.description}</small><br>
                    <small>Cost: ${skill.cost} point(s)</small>
                `;
                
                if (canUnlock) {
                    skillElement.addEventListener('click', () => {
                        unlockSkill(skill.id);
                    });
                }
                
                skillTreeElement.appendChild(skillElement);
            });
        }

        function unlockSkill(skillId) {
            const skills = skillTrees[gameState.player.class];
            const skill = skills.find(s => s.id === skillId);
            
            if (skill && gameState.player.skillPoints >= skill.cost && !gameState.player.skills.includes(skillId)) {
                gameState.player.skillPoints -= skill.cost;
                gameState.player.skills.push(skillId);
                
                // Apply skill effect
                applySkillEffect(skill);
                
                addToGameLog(`Learned skill: ${skill.name}!`);
                updateSkillsDisplay();
                updatePlayerStats();
            }
        }

        function applySkillEffect(skill) {
            // Apply skill effects to player stats
            switch(skill.effect) {
                case 'damageBoost':
                    gameState.player.strength = Math.floor(gameState.player.strength * (1 + skill.value));
                    break;
                case 'defenseBoost':
                    gameState.player.defense = Math.floor(gameState.player.defense * (1 + skill.value));
                    break;
                case 'criticalBoost':
                    gameState.player.critical += skill.value;
                    break;
                case 'spellDamageBoost':
                    gameState.player.magic = Math.floor(gameState.player.magic * (1 + skill.value));
                    break;
                case 'dodgeBoost':
                    gameState.player.dodge += skill.value;
                    break;
            }
        }

        // Battle system
        function startBattle() {
            // Determine enemy based on player level
            let enemyPool;
            if (gameState.player.level <= 2) {
                enemyPool = enemies.level1;
            } else if (gameState.player.level <= 4) {
                enemyPool = enemies.level2;
            } else if (gameState.player.level <= 6) {
                enemyPool = enemies.level3;
            } else {
                // Chance for boss encounter at higher levels
                if (Math.random() < 0.3) {
                    enemyPool = enemies.bosses;
                } else {
                    enemyPool = enemies.level4;
                }
            }
            
            // Select random enemy
            const randomIndex = Math.floor(Math.random() * enemyPool.length);
            gameState.currentEnemy = { ...enemyPool[randomIndex] };
            gameState.enemyMaxHp = gameState.currentEnemy.hp;
            
            // Initialize boss systems if it's a boss
            if (gameState.currentEnemy.isBoss) {
                document.getElementById('boss-health-container').style.display = 'block';
                document.getElementById('enemy-health-bar').style.display = 'none';
                updateBossHealth();
                gameState.currentEnemy.currentPhase = 0;
            } else {
                document.getElementById('boss-health-container').style.display = 'none';
            }
            
            // Reset battle log
            gameState.battleLog = [];
            addToBattleLog(`A ${gameState.currentEnemy.name} appears!`);
            
            // Update battle UI
            updateBattleStats();
            
            // Display enemy
            const enemyDisplay = document.getElementById('enemy-display');
            enemyDisplay.textContent = `[${gameState.currentEnemy.name.toUpperCase()}]`;
            
            // Add boss styling for high-level enemies
            if (gameState.currentEnemy.isBoss) {
                enemyDisplay.classList.add('boss-enemy');
                addToBattleLog("A powerful boss enemy appears! Be careful!");
            } else {
                enemyDisplay.classList.remove('boss-enemy');
            }
            
            showScreen('battle');
        }

        function playerAttack() {
            if (!gameState.currentEnemy) return;
            
            SoundManager.playAttack();
            
            // Calculate hit chance
            const playerAccuracy = gameState.player.accuracy;
            const enemyDodge = gameState.currentEnemy.dodge;
            const hitChance = Math.max(10, Math.min(95, playerAccuracy - enemyDodge));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="miss-message">Your attack missed!</span>`);
                enemyAttack();
                return;
            }
            
            // Calculate player damage
            const playerStrength = gameState.player.strength;
            const weapon = gameState.player.equipment.mainhand ? items[gameState.player.equipment.mainhand] : null;
            const baseDamage = weapon ? 
                Math.floor(Math.random() * (weapon.damage.max - weapon.damage.min + 1)) + weapon.damage.min :
                5;
                
            const strengthBonus = Math.floor(playerStrength / 5);
            let damage = baseDamage + strengthBonus;
            
            // Check for critical hit
            const criticalChance = gameState.player.critical + (weapon ? weapon.critical || 0 : 0);
            let isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(damage * 1.5);
                isCritical = true;
                SoundManager.playCritical();
            }
            
            // Apply enemy defense
            const enemyDefense = gameState.currentEnemy.defense;
            damage = Math.max(1, damage - Math.floor(enemyDefense / 2));
            
            // Apply damage
            gameState.currentEnemy.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! You attack the ${gameState.currentEnemy.name} for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`You attack the ${gameState.currentEnemy.name} for ${damage} damage!`);
            }
            
            // Show floating damage number
            showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
            
            if (gameState.currentEnemy.isBoss) {
                updateBossHealth();
            } else {
                updateEnemyHP();
            }
            
            if (gameState.currentEnemy.hp <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy attacks back
            enemyAttack();
        }

        function enemyAttack() {
            if (!gameState.currentEnemy) return;
            
            // Calculate hit chance
            const enemyAccuracy = gameState.currentEnemy.accuracy;
            const playerDodge = gameState.player.dodge;
            const hitChance = Math.max(10, Math.min(95, enemyAccuracy - playerDodge));
            
            // Check if attack hits
            if (Math.random() * 100 > hitChance) {
                addToBattleLog(`<span class="dodge-message">You dodged the ${gameState.currentEnemy.name}'s attack!</span>`);
                SoundManager.playDodge();
                return;
            }
            
            // Calculate enemy damage
            const enemyAttack = gameState.currentEnemy.attack;
            const baseDamage = Math.floor(Math.random() * 5) + enemyAttack - 2;
            
            // Check for critical hit
            const criticalChance = gameState.currentEnemy.critical;
            let damage, isCritical = false;
            
            if (Math.random() * 100 < criticalChance) {
                damage = Math.floor(baseDamage * 1.5);
                isCritical = true;
            } else {
                damage = baseDamage;
            }
            
            // Apply player defense
            const playerDefense = gameState.player.defense;
            damage = Math.max(1, damage - Math.floor(playerDefense / 2));
            
            // Apply damage
            gameState.player.hp -= damage;
            
            // Display attack result
            if (isCritical) {
                addToBattleLog(`<span class="crit-message">CRITICAL HIT! The ${gameState.currentEnemy.name} attacks you for ${damage} damage!</span>`);
            } else {
                addToBattleLog(`The ${gameState.currentEnemy.name} attacks you for ${damage} damage!`);
            }
            
            // Show floating damage number and shake effect
            showFloatingText(damage, document.getElementById('battle-player-hp').parentElement, isCritical ? 'damage-text crit-message' : 'damage-text');
            document.getElementById('battle-screen').classList.add('shake');
            setTimeout(() => document.getElementById('battle-screen').classList.remove('shake'), 300);
            
            updatePlayerHP();
            
            if (gameState.player.hp <= 0) {
                playerDefeated();
            }
        }

        function castSpell(spellId) {
            const spell = spells[spellId];
            
            // Check if player has enough MP
            if (gameState.player.mp < spell.cost) {
                addToBattleLog(`Not enough MP to cast ${spell.name}!`);
                showBattleScreen();
                return;
            }
            
            SoundManager.playSpell();
            
            // Deduct MP cost
            gameState.player.mp -= spell.cost;
            updatePlayerMP();
            
            // Check if spell hits
            const spellAccuracy = spell.accuracy || 85;
            if (Math.random() * 100 > spellAccuracy) {
                addToBattleLog(`<span class="miss-message">Your ${spell.name} missed!</span>`);
                enemyAttack();
                showBattleScreen();
                return;
            }
            
            if (spell.type === 'attack') {
                const minDamage = spell.damage.min + Math.floor(gameState.player.magic / 3);
                const maxDamage = spell.damage.max + Math.floor(gameState.player.magic / 2);
                let damage = Math.floor(Math.random() * (maxDamage - minDamage + 1)) + minDamage;
                
                // Check for spell critical (based on intelligence)
                let isCritical = false;
                if (spell.critical && Math.random() * 100 < (spell.critical + Math.floor(gameState.player.intelligence / 5))) {
                    damage = Math.floor(damage * 1.5);
                    isCritical = true;
                    SoundManager.playCritical();
                }
                
                gameState.currentEnemy.hp -= damage;
                
                if (isCritical) {
                    addToBattleLog(`<span class="crit-message">CRITICAL SPELL! You cast ${spell.name} for ${damage} damage!</span>`);
                } else {
                    addToBattleLog(`You cast ${spell.name} for ${damage} damage!`);
                }
                
                // Show floating damage number
                showFloatingText(damage, document.getElementById('enemy-display'), isCritical ? 'damage-text crit-message' : 'damage-text');
                
                if (gameState.currentEnemy.isBoss) {
                    updateBossHealth();
                } else {
                    updateEnemyHP();
                }
                
                if (gameState.currentEnemy.hp <= 0) {
                    enemyDefeated();
                    return;
                }
            } else if (spell.type === 'heal') {
                SoundManager.playHeal();
                const healAmount = spell.power + Math.floor(gameState.player.magic / 2);
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                addToBattleLog(`You cast ${spell.name} and heal for ${healAmount} HP!`);
                
                // Show floating heal number
                showFloatingText(healAmount, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
            }
            
            // Enemy attacks back
            enemyAttack();
            
            showBattleScreen();
        }

        function enemyDefeated() {
            SoundManager.playVictory();
            addToBattleLog(`You defeated the ${gameState.currentEnemy.name}!`);
            
            // Calculate experience gained
            const expGained = gameState.currentEnemy.exp;
            gameState.player.exp += expGained;
            
            // Update quest progress
            updateQuestProgress(gameState.currentEnemy.name);
            
            // Update achievement tracking
            gameState.enemiesDefeated++;
            if (gameState.currentEnemy.name === "Goblin") {
                gameState.goblinsDefeated++;
            }
            if (gameState.currentEnemy.name === "Shadow Dragon") {
                gameState.dragonsDefeated++;
            }
            
            // Check for level up
            if (gameState.player.exp >= gameState.player.expNeeded) {
                levelUp();
            }
            
            // Collect loot
            const loot = [];
            const goldGained = gameState.currentEnemy.gold;
            gameState.player.gold += goldGained;
            gameState.totalGoldEarned += goldGained;
            
            // NEW LOOT SYSTEM: Check each loot item from enemy's loot table
            gameState.currentEnemy.loot.forEach(lootItem => {
                if (Math.random() < lootItem.chance) {
                    loot.push(lootItem.id);
                }
            });
            
            // NEW RARE LOOT SYSTEM: Check for rare additional loot
            const rareLootChance = 0.10 + (gameState.player.level * 0.05);
            if (Math.random() < rareLootChance) {
                // Get all uncommon, rare, and epic items
                const rareItems = Object.keys(items).filter(itemId => {
                    const rarity = items[itemId].rarity;
                    return rarity === 'uncommon' || rarity === 'rare' || rarity === 'epic';
                });
                
                if (rareItems.length > 0) {
                    const randomRareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                    loot.push(randomRareItem);
                    addToBattleLog(`<span class="rarity-${items[randomRareItem].rarity}">RARE LOOT: Found ${items[randomRareItem].name}!</span>`);
                }
            }
            
            // Add loot to inventory
            loot.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            // Display loot screen
            document.getElementById('exp-gained').textContent = expGained;
            
            const lootItemsElement = document.getElementById('loot-items');
            lootItemsElement.innerHTML = '';
            
            loot.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `log-entry loot-item rarity-${items[itemId].rarity}`;
                itemElement.textContent = items[itemId].name;
                lootItemsElement.appendChild(itemElement);
            });
            
            if (goldGained > 0) {
                const goldElement = document.createElement('div');
                goldElement.className = 'log-entry loot-item';
                goldElement.textContent = `${goldGained} gold`;
                lootItemsElement.appendChild(goldElement);
            }
            
            // Check achievements
            checkAchievements();
            
            showScreen('loot');
        }

        function playerDefeated() {
            SoundManager.playDefeat();
            addToBattleLog("You have been defeated...");
            addToBattleLog("You wake up at the castle entrance, weakened but alive.");
            
            // Reset player HP to 50%
            gameState.player.hp = Math.floor(gameState.player.maxHp / 2);
            gameState.player.mp = Math.floor(gameState.player.maxMp / 2);
            
            // Lose some gold
            const goldLost = Math.floor(gameState.player.gold * 0.2);
            gameState.player.gold -= goldLost;
            
            setTimeout(() => {
                addToGameLog(`You were defeated and lost ${goldLost} gold.`);
                showGameScreen();
                updatePlayerStats();
            }, 2000);
        }

        function attemptFlee() {
            // Flee chance based on player agility vs enemy agility
            const playerAgility = gameState.player.agility;
            const enemyAgility = gameState.currentEnemy.agility;
            const fleeChance = 0.3 + (playerAgility - enemyAgility) * 0.02;
            
            if (Math.random() < fleeChance) {
                addToBattleLog("You successfully fled from battle!");
                setTimeout(() => {
                    showGameScreen();
                }, 1000);
            } else {
                addToBattleLog("You failed to flee!");
                enemyAttack();
            }
        }

        function useItemInBattle() {
            // For simplicity, we'll just use a health potion if available
            const healthPotionIndex = gameState.player.inventory.indexOf('health_potion');
            
            if (healthPotionIndex !== -1) {
                SoundManager.playHeal();
                // Use health potion
                gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + items.health_potion.power);
                gameState.player.inventory.splice(healthPotionIndex, 1);
                addToBattleLog("You used a Health Potion!");
                
                // Show floating heal number
                showFloatingText(items.health_potion.power, document.getElementById('battle-player-hp').parentElement, 'heal-text');
                
                updatePlayerHP();
                
                // Enemy still attacks
                enemyAttack();
            } else {
                addToBattleLog("You don't have any usable items!");
            }
        }

        function takeLoot() {
            showGameScreen();
            updatePlayerStats();
            addToGameLog("You continue exploring the castle...");
        }

        // Level system
        function levelUp() {
            SoundManager.playLevelUp();
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expNeeded;
            gameState.player.expNeeded = Math.floor(gameState.player.expNeeded * 1.5);
            
            // Increase stats based on class
            const classData = classes[gameState.player.class];
            
            gameState.player.maxHp += 20 + (classData.hp > 100 ? 5 : 0);
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.maxMp += 10 + (classData.mp > 50 ? 5 : 0);
            gameState.player.mp = gameState.player.maxMp;
            gameState.player.strength += 2 + (classData.strength > 10 ? 1 : 0);
            gameState.player.defense += 1 + (classData.defense > 5 ? 1 : 0);
            gameState.player.agility += 1 + (classData.agility > 10 ? 1 : 0);
            gameState.player.magic += 1 + (classData.magic > 5 ? 1 : 0);
            gameState.player.intelligence += 1 + (classData.intelligence > 10 ? 1 : 0);
            gameState.player.dodge += 0.5;
            gameState.player.critical += 0.5;
            
            // Grant skill point every 2 levels
            if (gameState.player.level % 2 === 0) {
                gameState.player.skillPoints++;
                addToGameLog("You gained a skill point!");
            }
            
            addToGameLog(`You reached level ${gameState.player.level}!`);
            addToGameLog("Your stats have improved!");
            
            updatePlayerStats();
        }

        // Update quest progress
        function updateQuestProgress(enemyName) {
            gameState.player.quests.forEach(quest => {
                if (!quest.completed && quest.target === enemyName) {
                    quest.current++;
                    if (quest.current >= quest.required) {
                        quest.completed = true;
                        addToGameLog(`Quest completed: ${quest.name}!`);
                        
                        // Give rewards
                        gameState.player.gold += quest.reward.gold;
                        gameState.player.exp += quest.reward.exp;
                        if (quest.reward.item) {
                            gameState.player.inventory.push(quest.reward.item);
                            addToGameLog(`You received ${items[quest.reward.item].name} as a reward!`);
                        }
                        
                        addToGameLog(`You received ${quest.reward.gold} gold and ${quest.reward.exp} experience!`);
                    }
                }
            });
        }

        // Floating text for damage/healing
        function showFloatingText(value, parentElement, className) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${className}`;
            floatingText.textContent = value;
            floatingText.style.left = `${Math.random() * 50 + 25}%`;
            floatingText.style.top = '50%';
            
            parentElement.appendChild(floatingText);
            
            // Remove after animation
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }

        // Update boss health display
        function updateBossHealth() {
            const healthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('boss-health-fill').style.width = `${healthPercent}%`;
            document.getElementById('boss-health-text').textContent = `BOSS HEALTH: ${Math.round(healthPercent)}%`;
        }

        // Update status effects display
        function updateStatusEffects() {
            const statusEffectsElement = document.getElementById('status-effects');
            statusEffectsElement.innerHTML = '';
            
            if (gameState.player.statusEffects.length === 0) {
                statusEffectsElement.innerHTML = '<div>No active effects</div>';
                return;
            }
        }

        // Update quests display
        function updateQuestsDisplay() {
            const questLogElement = document.getElementById('quest-log');
            questLogElement.innerHTML = '';
            
            if (gameState.player.quests.length === 0) {
                questLogElement.innerHTML = '<div>No active quests</div>';
                return;
            }
            
            gameState.player.quests.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = `quest-item ${quest.completed ? 'quest-completed' : ''}`;
                
                const progressText = quest.completed ? 
                    'Completed!' : 
                    `${quest.current}/${quest.required} ${quest.target}s defeated`;
                
                questElement.innerHTML = `
                    <strong>${quest.name}</strong><br>
                    <small>${quest.description}</small><br>
                    <small>Progress: ${progressText}</small>
                `;
                
                questLogElement.appendChild(questElement);
            });
        }

        // Update achievements display
        function updateAchievementsDisplay() {
            const achievementsElement = document.getElementById('achievements-list');
            achievementsElement.innerHTML = '';
            
            Object.keys(achievements).forEach(achievementId => {
                const achievement = achievements[achievementId];
                const isUnlocked = gameState.player.achievements.includes(achievementId);
                
                const achievementElement = document.createElement('div');
                achievementElement.className = `item ${isUnlocked ? 'rarity-uncommon' : ''}`;
                achievementElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div style="font-size: 24px; margin-right: 10px;">${isUnlocked ? achievement.icon : 'â“'}</div>
                        <div>
                            <strong>${achievement.name}</strong><br>
                            <small>${achievement.description}</small><br>
                            <small>${isUnlocked ? 'âœ“ Unlocked' : 'Locked'}</small>
                        </div>
                    </div>
                `;
                
                achievementsElement.appendChild(achievementElement);
            });
        }

        // Inventory system
        function updateInventoryDisplay() {
            // Update gold display
            document.getElementById('inventory-gold').textContent = gameState.player.gold;
            
            // Update equipment slots with stats
            updateEquipmentDisplay();
            
            // Update inventory items
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            Object.keys(itemCounts).forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                // Add quick slot assignment buttons
                const quickSlotButtons = document.createElement('div');
                quickSlotButtons.style.marginTop = '5px';
                quickSlotButtons.style.display = 'flex';
                quickSlotButtons.style.gap = '2px';
                
                for (let i = 0; i < 3; i++) {
                    const slotButton = document.createElement('button');
                    slotButton.textContent = `Q${i + 1}`;
                    slotButton.style.flex = '1';
                    slotButton.style.padding = '2px';
                    slotButton.style.fontSize = '10px';
                    slotButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        assignQuickSlot(i, itemId);
                        addToGameLog(`Assigned ${items[itemId].name} to quick slot ${i + 1}`);
                    });
                    quickSlotButtons.appendChild(slotButton);
                }
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                itemElement.appendChild(quickSlotButtons);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
        }

        function sortInventory(sortType) {
            // Group items by type for display
            const itemCounts = {};
            gameState.player.inventory.forEach(itemId => {
                itemCounts[itemId] = (itemCounts[itemId] || 0) + 1;
            });
            
            let sortedItems = Object.keys(itemCounts);
            
            switch (sortType) {
                case 'name':
                    sortedItems.sort((a, b) => items[a].name.localeCompare(items[b].name));
                    break;
                case 'type':
                    sortedItems.sort((a, b) => items[a].type.localeCompare(items[b].type));
                    break;
                case 'rarity':
                    const rarityOrder = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4 };
                    sortedItems.sort((a, b) => rarityOrder[items[b].rarity] - rarityOrder[items[a].rarity]);
                    break;
            }
            
            updateInventoryDisplayWithSort(sortedItems, itemCounts);
        }

        function updateInventoryDisplayWithSort(sortedItems, itemCounts) {
            const inventoryElement = document.getElementById('inventory-items');
            inventoryElement.innerHTML = '';
            
            sortedItems.forEach(itemId => {
                const itemElement = document.createElement('div');
                itemElement.className = `item rarity-${items[itemId].rarity}`;
                
                const itemName = document.createElement('div');
                itemName.textContent = `${items[itemId].name} (x${itemCounts[itemId]})`;
                
                const itemStats = document.createElement('div');
                itemStats.className = 'item-stats';
                itemStats.innerHTML = getItemStatsDisplay(itemId);
                
                itemElement.appendChild(itemName);
                itemElement.appendChild(itemStats);
                
                // Add click event to equip/use item
                itemElement.addEventListener('click', () => {
                    SoundManager.playClick();
                    if (items[itemId].type === 'consumable') {
                        useItem(itemId);
                    } else {
                        equipItem(itemId, items[itemId].slot);
                    }
                });
                
                inventoryElement.appendChild(itemElement);
            });
        }

        function updateEquipmentDisplay() {
            // Head
            const headSlot = document.getElementById('head-slot');
            const headStats = document.getElementById('head-stats');
            if (gameState.player.equipment.head) {
                const item = items[gameState.player.equipment.head];
                headSlot.textContent = item.name;
                headStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.head);
            } else {
                headSlot.textContent = 'Empty';
                headStats.innerHTML = '';
            }
            
            // Chest
            const chestSlot = document.getElementById('chest-slot');
            const chestStats = document.getElementById('chest-stats');
            if (gameState.player.equipment.chest) {
                const item = items[gameState.player.equipment.chest];
                chestSlot.textContent = item.name;
                chestStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.chest);
            } else {
                chestSlot.textContent = 'Empty';
                chestStats.innerHTML = '';
            }
            
            // Hands
            const handsSlot = document.getElementById('hands-slot');
            const handsStats = document.getElementById('hands-stats');
            if (gameState.player.equipment.hands) {
                const item = items[gameState.player.equipment.hands];
                handsSlot.textContent = item.name;
                handsStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.hands);
            } else {
                handsSlot.textContent = 'Empty';
                handsStats.innerHTML = '';
            }
            
            // Shield
            const shieldSlot = document.getElementById('shield-slot');
            const shieldStats = document.getElementById('shield-stats');
            if (gameState.player.equipment.shield) {
                const item = items[gameState.player.equipment.shield];
                shieldSlot.textContent = item.name;
                shieldStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.shield);
            } else {
                shieldSlot.textContent = 'Empty';
                shieldStats.innerHTML = '';
            }
            
            // Main Hand
            const mainhandSlot = document.getElementById('mainhand-slot');
            const mainhandStats = document.getElementById('mainhand-stats');
            if (gameState.player.equipment.mainhand) {
                const item = items[gameState.player.equipment.mainhand];
                mainhandSlot.textContent = item.name;
                mainhandStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.mainhand);
            } else {
                mainhandSlot.textContent = 'Empty';
                mainhandStats.innerHTML = '';
            }
            
            // Off Hand
            const offhandSlot = document.getElementById('offhand-slot');
            const offhandStats = document.getElementById('offhand-stats');
            if (gameState.player.equipment.offhand) {
                const item = items[gameState.player.equipment.offhand];
                offhandSlot.textContent = item.name;
                offhandStats.innerHTML = getItemStatsDisplay(gameState.player.equipment.offhand);
            } else {
                offhandSlot.textContent = 'Empty';
                offhandStats.innerHTML = '';
            }
        }

        function getItemStatsDisplay(itemId) {
            const item = items[itemId];
            let statsHTML = '';
            
            if (item.type === 'weapon') {
                statsHTML = `DMG: ${item.damage.min}-${item.damage.max}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    const currentAvg = (equippedItem.damage.min + equippedItem.damage.max) / 2;
                    const newAvg = (item.damage.min + item.damage.max) / 2;
                    
                    if (newAvg > currentAvg) {
                        statsHTML += ` <span class="better-stat">(+${Math.round(newAvg - currentAvg)})</span>`;
                    } else if (newAvg < currentAvg) {
                        statsHTML += ` <span class="worse-stat">(${Math.round(newAvg - currentAvg)})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.strength) statsHTML += ` | STR: ${item.strength}`;
                if (item.agility) statsHTML += ` | AGI: ${item.agility}`;
                if (item.magic) statsHTML += ` | MAG: ${item.magic}`;
                if (item.critical) statsHTML += ` | CRIT: ${item.critical}%`;
            } else if (item.type === 'armor') {
                statsHTML = `DEF: ${item.defense}`;
                
                // Add comparison if player has an equipped item in this slot
                const equippedItemId = gameState.player.equipment[item.slot];
                if (equippedItemId && equippedItemId !== itemId) {
                    const equippedItem = items[equippedItemId];
                    
                    if (item.defense > equippedItem.defense) {
                        statsHTML += ` <span class="better-stat">(+${item.defense - equippedItem.defense})</span>`;
                    } else if (item.defense < equippedItem.defense) {
                        statsHTML += ` <span class="worse-stat">(${item.defense - equippedItem.defense})</span>`;
                    } else {
                        statsHTML += ` <span class="same-stat">(=)</span>`;
                    }
                }
                
                // Add other stats
                if (item.strength) statsHTML += ` | STR: ${item.strength}`;
                if (item.agility) statsHTML += ` | AGI: ${item.agility}`;
                if (item.magic) statsHTML += ` | MAG: ${item.magic}`;
                if (item.dodge) statsHTML += ` | DODGE: ${item.dodge}%`;
            } else if (item.type === 'consumable') {
                if (item.effect === 'heal' || item.effect === 'full_heal') {
                    statsHTML = `Heals: ${item.power} HP`;
                } else if (item.effect === 'restore_mana') {
                    statsHTML = `Restores: ${item.power} MP`;
                } else if (item.effect.includes('boost')) {
                    statsHTML = `+${item.power} ${item.effect.split('_')[1]} for ${item.duration} turns`;
                }
            }
            
            return statsHTML;
        }

        function equipItem(itemId, slot) {
            // If slot is already occupied, unequip current item
            if (gameState.player.equipment[slot]) {
                gameState.player.inventory.push(gameState.player.equipment[slot]);
            }
            
            // Remove item from inventory
            const itemIndex = gameState.player.inventory.indexOf(itemId);
            if (itemIndex !== -1) {
                gameState.player.inventory.splice(itemIndex, 1);
            }
            
            // Equip new item
            gameState.player.equipment[slot] = itemId;
            
            // Update stats
            updatePlayerStats();
            updateInventoryDisplay();
            
            addToGameLog(`You equipped ${items[itemId].name}.`);
        }

        function useItem(itemId) {
            const item = items[itemId];
            
            if (item.type === 'consumable') {
                if (item.effect === 'heal') {
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + item.power);
                    addToGameLog(`You used ${item.name} and restored ${item.power} HP.`);
                } else if (item.effect === 'full_heal') {
                    gameState.player.hp = gameState.player.maxHp;
                    addToGameLog(`You used ${item.name} and fully restored your health!`);
                } else if (item.effect === 'restore_mana') {
                    gameState.player.mp = Math.min(gameState.player.maxMp, gameState.player.mp + item.power);
                    addToGameLog(`You used ${item.name} and restored ${item.power} MP.`);
                }
                
                // Remove item from inventory
                const itemIndex = gameState.player.inventory.indexOf(itemId);
                if (itemIndex !== -1) {
                    gameState.player.inventory.splice(itemIndex, 1);
                }
                
                updatePlayerStats();
                updateInventoryDisplay();
            }
        }

        function updateSpellsDisplay() {
            const spellsElement = document.getElementById('spells-list');
            spellsElement.innerHTML = '';
            
            gameState.player.spells.forEach(spellId => {
                const spell = spells[spellId];
                const spellElement = document.createElement('div');
                spellElement.className = 'spell-item';
                
                const spellInfo = document.createElement('div');
                spellInfo.className = 'spell-info';
                spellInfo.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    <small>${spell.description}</small>
                `;
                
                const spellCost = document.createElement('div');
                spellCost.className = 'spell-cost';
                spellCost.textContent = `${spell.cost} MP`;
                
                spellElement.appendChild(spellInfo);
                spellElement.appendChild(spellCost);
                
                spellsElement.appendChild(spellElement);
            });
        }

        function updateSpellSelectionDisplay() {
            // Update MP display
            document.getElementById('spell-select-mp').textContent = gameState.player.mp;
            document.getElementById('spell-select-max-mp').textContent = gameState.player.maxMp;
            
            const spellSelectElement = document.getElementById('spell-select-list');
            spellSelectElement.innerHTML = '';
            
            gameState.player.spells.forEach(spellId => {
                const spell = spells[spellId];
                const spellElement = document.createElement('div');
                spellElement.className = 'spell-item';
                
                // Disable if not enough MP
                if (gameState.player.mp < spell.cost) {
                    spellElement.classList.add('disabled');
                }
                
                const spellInfo = document.createElement('div');
                spellInfo.className = 'spell-info';
                spellInfo.innerHTML = `
                    <strong>${spell.name}</strong><br>
                    <small>${spell.description}</small><br>
                    ${spell.type === 'attack' ? `Damage: ${spell.damage.min}-${spell.damage.max}` : `Heal: ${spell.power}`}
                `;
                
                const spellCost = document.createElement('div');
                spellCost.className = 'spell-cost';
                spellCost.textContent = `${spell.cost} MP`;
                
                spellElement.appendChild(spellInfo);
                spellElement.appendChild(spellCost);
                
                // Add click event to cast spell
                if (gameState.player.mp >= spell.cost) {
                    spellElement.addEventListener('click', () => {
                        SoundManager.playClick();
                        castSpell(spellId);
                    });
                }
                
                spellSelectElement.appendChild(spellElement);
            });
        }

        function updateSpellShopDisplay() {
            // Update shop display
            document.getElementById('shop-gold').textContent = gameState.player.gold;
            document.getElementById('shop-level').textContent = gameState.player.level;
            
            const shopElement = document.getElementById('spell-shop-items');
            shopElement.innerHTML = '';
            
            // Show all spells that player doesn't already have and meets level requirement
            Object.keys(spells).forEach(spellId => {
                const spell = spells[spellId];
                
                // Skip if player already has this spell
                if (gameState.player.spells.includes(spellId)) return;
                
                // Skip if player doesn't meet level requirement
                if (gameState.player.level < spell.levelReq) return;
                
                const shopItemElement = document.createElement('div');
                shopItemElement.className = 'spell-item';
                
                const infoElement = document.createElement('div');
                infoElement.className = 'spell-info';
                infoElement.innerHTML = `
                    <strong>${spell.name}</strong> (Level ${spell.levelReq}+)<br>
                    <small>${spell.description}</small><br>
                    ${spell.type === 'attack' ? `Damage: ${spell.damage.min}-${spell.damage.max}` : `Heal: ${spell.power}`} | Cost: ${spell.cost} MP
                `;
                
                const costElement = document.createElement('div');
                costElement.className = 'spell-cost';
                costElement.textContent = `${spell.goldCost} Gold`;
                
                const buyButton = document.createElement('div');
                buyButton.className = 'button';
                buyButton.textContent = 'BUY';
                buyButton.addEventListener('click', () => {
                    SoundManager.playClick();
                    buySpell(spellId);
                });
                
                shopItemElement.appendChild(infoElement);
                shopItemElement.appendChild(costElement);
                shopItemElement.appendChild(buyButton);
                
                shopElement.appendChild(shopItemElement);
            });
        }

        function buySpell(spellId) {
            const spell = spells[spellId];
            
            // Check if player can afford the spell
            if (gameState.player.gold < spell.goldCost) {
                addToGameLog("You don't have enough gold to buy this spell.");
                return;
            }
            
            // Check if player meets level requirement
            if (gameState.player.level < spell.levelReq) {
                addToGameLog(`You need to be level ${spell.levelReq} to learn this spell.`);
                return;
            }
            
            // Check if player already has the spell
            if (gameState.player.spells.includes(spellId)) {
                addToGameLog("You already know this spell.");
                return;
            }
            
            // Purchase the spell
            gameState.player.gold -= spell.goldCost;
            gameState.player.spells.push(spellId);
            gameState.spellsLearned++;
            
            addToGameLog(`You learned ${spell.name} for ${spell.goldCost} gold!`);
            
            // Update displays
            updatePlayerStats();
            updateSpellShopDisplay();
            
            // Check achievements
            checkAchievements();
        }

        // Calculate total player stats including equipment
        function calculatePlayerStats() {
            // Start with base stats
            const stats = {
                strength: gameState.player.strength,
                defense: gameState.player.defense,
                agility: gameState.player.agility,
                magic: gameState.player.magic,
                intelligence: gameState.player.intelligence,
                dodge: gameState.player.dodge,
                critical: gameState.player.critical,
                accuracy: gameState.player.accuracy
            };
            
            // Add equipment bonuses
            Object.values(gameState.player.equipment).forEach(itemId => {
                if (itemId && items[itemId]) {
                    const item = items[itemId];
                    if (item.strength) stats.strength += item.strength;
                    if (item.defense) stats.defense += item.defense;
                    if (item.agility) stats.agility += item.agility;
                    if (item.magic) stats.magic += item.magic;
                    if (item.intelligence) stats.intelligence += item.intelligence;
                    if (item.dodge) stats.dodge += item.dodge;
                    if (item.critical) stats.critical += item.critical;
                }
            });
            
            return stats;
        }

        // UI updates
        function updatePlayerStats() {
            const stats = calculatePlayerStats();
            
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('player-max-mp').textContent = gameState.player.maxMp;
            document.getElementById('player-exp').textContent = gameState.player.exp;
            document.getElementById('player-exp-needed').textContent = gameState.player.expNeeded;
            document.getElementById('player-gold').textContent = gameState.player.gold;
            
            // Update stat display
            document.getElementById('player-strength').textContent = stats.strength;
            document.getElementById('player-defense').textContent = stats.defense;
            document.getElementById('player-agility').textContent = stats.agility;
            document.getElementById('player-dodge').textContent = Math.floor(stats.dodge);
            document.getElementById('player-critical').textContent = Math.floor(stats.critical);
            document.getElementById('player-accuracy').textContent = stats.accuracy;
            
            // Update exp bar
            const expPercent = (gameState.player.exp / gameState.player.expNeeded) * 100;
            document.getElementById('exp-bar').style.width = `${expPercent}%`;
            
            // Update MP bar
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots
            updateQuickSlotDisplay();
        }

        function updateBattleStats() {
            document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
            document.getElementById('enemy-hp').textContent = gameState.currentEnemy.hp;
            document.getElementById('enemy-max-hp').textContent = gameState.enemyMaxHp;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-max-hp').textContent = gameState.player.maxHp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-max-mp').textContent = gameState.player.maxMp;
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
            
            // Update MP bar in battle
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
            
            // Update quick slots in battle
            updateQuickSlotDisplay();
        }

        function updatePlayerHP() {
            document.getElementById('player-hp').textContent = gameState.player.hp;
            document.getElementById('battle-player-hp').textContent = gameState.player.hp;
        }

        function updatePlayerMP() {
            document.getElementById('player-mp').textContent = gameState.player.mp;
            document.getElementById('battle-player-mp').textContent = gameState.player.mp;
            document.getElementById('spell-select-mp').textContent = gameState.player.mp;
            
            // Update MP bars
            const mpPercent = (gameState.player.mp / gameState.player.maxMp) * 100;
            document.getElementById('mp-bar').style.width = `${mpPercent}%`;
            document.getElementById('battle-mp-bar').style.width = `${mpPercent}%`;
        }

        function updateEnemyHP() {
            document.getElementById('enemy-hp').textContent = Math.max(0, gameState.currentEnemy.hp);
            
            // Update enemy health bar
            const enemyHealthPercent = (gameState.currentEnemy.hp / gameState.enemyMaxHp) * 100;
            document.getElementById('enemy-health-fill').style.width = `${enemyHealthPercent}%`;
        }

        function addToBattleLog(message) {
            const logElement = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addToGameLog(message) {
            const logElement = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
