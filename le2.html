<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dracula's Last Rise - Level 2: The Woodlands</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Retro DOS computer style - Blood Red/Black theme */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 10px;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                linear-gradient(rgba(120, 0, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(120, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 15px;
            border: 3px solid #cc0000;
            background-color: #000;
            box-shadow: 0 0 30px rgba(204, 0, 0, 0.5);
            position: relative;
            min-height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        /* Scanline effect for authentic CRT monitor feel */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(120, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px dashed #cc0000;
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #cc0000;
            text-shadow: 0 0 8px #cc0000;
            font-size: 32px;
            margin: 10px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: normal;
        }
        
        h2 {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            color: #fff;
            border-bottom: 1px solid #cc0000;
            padding-bottom: 5px;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 20px;
            font-weight: normal;
        }
        
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }
        
        .active-screen {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Level Progress Indicator */
        .level-progress {
            display: flex;
            justify-content: space-between;
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .level-number {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
            font-weight: bold;
            color: #888;
            background-color: #222;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .level-number.completed {
            background-color: #220000;
            color: #cc8888;
            border-color: #cc8888;
        }
        
        .level-number.current {
            background-color: #cc0000;
            color: #000;
            border-color: #cc0000;
            box-shadow: 0 0 12px #cc0000;
            text-shadow: 0 0 2px #000;
            font-weight: bold;
        }
        
        /* Stats Bar */
        .stats-bar {
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .stat-item {
            margin: 5px 10px;
        }
        
        .stat-label {
            color: #fff;
        }
        
        .stat-value {
            color: #cc0000;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Inventory */
        .inventory-container {
            background-color: #111;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 15px 0;
        }
        
        .inventory-title {
            color: #cc0000;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .inventory {
            min-height: 60px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            display: inline-block;
            background-color: #222;
            border: 1px solid #cc0000;
            padding: 8px 12px;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inventory-item:hover {
            background-color: #333;
            border-color: #ff4444;
            transform: translateY(-2px);
        }
        
        .inventory-item.equipped::after {
            content: "E";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #cc0000;
            color: #000;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        /* Story Text Area */
        .story-text {
            background-color: #000;
            border: 1px solid #cc0000;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
            max-height: 350px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
        }
        
        /* Choice Buttons */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .choice-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc0000;
            padding: 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .choice-btn:hover, .choice-btn:active {
            background-color: #333;
            color: #ff4444;
            border-color: #ff4444;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
        }
        
        .choice-btn::after {
            content: ">";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #cc0000;
            font-weight: bold;
        }
        
        .choice-btn:hover::after {
            color: #ff4444;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #222;
            color: #fff;
            border: 2px solid #cc0000;
            padding: 10px 15px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover, .action-btn:active {
            background-color: #333;
            color: #ff4444;
            border-color: #ff4444;
        }
        
        /* Dice Roll Display */
        .dice-roll {
            background-color: #330000;
            border: 1px solid #cc0000;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #cc0000;
            font-weight: bold;
        }
        
        /* Combat Display */
        .combat-log {
            background-color: #550000;
            border: 1px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            color: #cc0000;
            font-weight: bold;
        }
        
        /* Special Text Styles */
        .game-over {
            color: #f66;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 5px #f66;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .victory {
            color: #cc0000;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            margin: 20px;
            text-shadow: 0 0 8px #cc0000;
            font-family: 'Press Start 2P', 'Courier New', monospace;
        }
        
        .success {
            color: #6f6;
            font-weight: bold;
        }
        
        .damage {
            color: #f66;
            font-weight: bold;
        }
        
        .enemy {
            color: #fa6;
            font-weight: bold;
        }
        
        .gold {
            color: #ffd700;
            font-weight: bold;
        }
        
        .item {
            color: #8ff;
            font-weight: bold;
        }
        
        .vampire {
            color: #f66;
            font-weight: bold;
            text-shadow: 0 0 3px #f66;
        }
        
        .npc {
            color: #6f9;
            font-weight: bold;
        }
        
        .woodlands {
            color: #8f6;
            font-weight: bold;
        }
        
        .werewolf {
            color: #f84;
            font-weight: bold;
        }
        
        .cultist {
            color: #f48;
            font-weight: bold;
        }
        
        .church {
            color: #ccc;
            font-weight: bold;
        }
        
        /* Character Selection */
        .character-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0;
        }
        
        .character-option {
            background-color: #111;
            border: 2px solid #cc0000;
            padding: 15px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .character-option:hover {
            background-color: #222;
            border-color: #ff4444;
            transform: translateY(-5px);
        }
        
        .character-name {
            color: #cc0000;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .character-stats {
            font-size: 12px;
            text-align: left;
            margin-top: 10px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 10px;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        /* Blinking cursor effect */
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #cc0000;
            vertical-align: middle;
            margin-left: 5px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #cc0000;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .sound-toggle:hover {
            background: #222;
            color: #ff4444;
        }
        
        /* New Game Button */
        .new-game-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #111;
            border: 1px solid #cc0000;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            font-family: 'Source Code Pro', 'Courier New', monospace;
        }
        
        .new-game-btn:hover {
            background: #222;
            color: #ff4444;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .stats-bar {
                font-size: 12px;
            }
            
            .choice-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .level-number {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .inventory-title {
                font-size: 12px;
            }
            
            .character-select {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sound Toggle -->
        <div class="sound-toggle" onclick="toggleSound()">
            SOUND: <span id="sound-status">ON</span>
        </div>
        
        <!-- New Game Button -->
        <div class="new-game-btn" onclick="newGame()">
            NEW GAME
        </div>
        
        <div class="header">
            <h1>DRACULA'S LAST RISE</h1>
            <h2>LEVEL 2: THE WOODLANDS</h2>
        </div>
        
        <!-- Level Progress Indicator -->
        <div class="level-progress">
            <div class="level-number completed">1</div>
            <div class="level-number current">2</div>
            <div class="level-number">3</div>
            <div class="level-number">4</div>
            <div class="level-number">5</div>
            <div class="level-number">6</div>
            <div class="level-number">7</div>
            <div class="level-number">8</div>
            <div class="level-number">9</div>
            <div class="level-number">10</div>
        </div>
        
        <!-- Game Screen -->
        <div id="screen-game" class="screen active-screen">
            <div class="stats-bar">
                <div class="stat-item"><span class="stat-label">STRENGTH:</span> <span id="stat-strength" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">HEALTH:</span> <span id="stat-health" class="stat-value">0</span>/<span id="stat-maxhealth" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGILITY:</span> <span id="stat-agility" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">GOLD:</span> <span id="stat-gold" class="stat-value">0</span></div>
            </div>
            
            <div class="inventory-container">
                <div class="inventory-title">
                    <span>INVENTORY</span>
                    <span id="inventory-count">ITEMS: 0/10</span>
                </div>
                <div class="inventory" id="inventory">
                    <!-- Inventory items will be added here -->
                </div>
            </div>
            
            <h2>THE WOODLANDS</h2>
            <div class="story-text" id="story-text">
                <!-- Story content will be inserted here -->
            </div>
            
            <div class="choice-buttons" id="choice-buttons">
                <!-- Choice buttons will be inserted here -->
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="useAgility()">USE AGILITY</button>
                <button class="action-btn" onclick="useItem()">USE ITEM</button>
                <button class="action-btn" onclick="saveGame()">SAVE GAME</button>
                <button class="action-btn" onclick="loadGame()">LOAD GAME</button>
            </div>
        </div>
        
        <!-- Level Complete Screen -->
        <div id="screen-complete" class="screen">
            <h2>WOODLANDS CONQUERED!</h2>
            <div class="story-text">
                <p class="victory">YOU HAVE COMPLETED LEVEL 2!</p>
                <div style="margin-top: 15px; padding: 10px; background-color: #330000; border: 1px solid #cc0000;">
                    <p>You stand at the edge of the <span class="woodlands">Dark Woodlands</span>, looking up at the imposing <span class="church">Mountains of Moor</span>. The old church in the distance appears as a dark silhouette against the moonlit sky.</p>
                    <p>From the tavernkeeper's information and what you've discovered in the woodlands, you know that Dracula's cult is using the old church as a base. Strange lights flicker from its broken windows, and you can hear faint chanting carried by the wind.</p>
                    <p>A weathered signpost points toward the mountains: <em>"Moor Pass - 5 Miles. Beware the Shadow."</em></p>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-label">FINAL STRENGTH:</span> <span id="complete-stat-strength" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL HEALTH:</span> <span id="complete-stat-health" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL AGILITY:</span> <span id="complete-stat-agility" class="stat-value">0</span></div>
                    <div class="stat-item"><span class="stat-label">FINAL GOLD:</span> <span id="complete-stat-gold" class="stat-value">0</span></div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #003322; border: 1px solid #00ff88;">
                    <h3 style="color: #00ff88; margin-top: 0;">YOUR PROGRESS:</h3>
                    <p>You've survived the treacherous woodlands and uncovered more about Dracula's plans. The cult is stronger than you anticipated, and they're preparing something terrible in the mountains.</p>
                    <p>The <span class="church">Mountains of Moor</span> loom ahead - a place of ancient evil where Dracula's power grows stronger. The old church awaits, and with it, the answers you seek.</p>
                </div>
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" onclick="goToNextLevel()">CONTINUE TO LEVEL 3: MOUNTAINS OF MOOR</button>
            </div>
        </div>
        
        <div class="footer">
            DRACULA'S LAST RISE - A Gothic Horror Adventure<br>
            Level 2: The Woodlands
        </div>
    </div>

    <script>
        // Sound System
        let soundEnabled = true;
        let audioContext;
        
        // Simple beep generator using Web Audio API
        function playBeep(frequency, duration, type = 'square') {
            if (!soundEnabled) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Web Audio not supported:", e);
            }
        }
        
        // Sound effects for level 2
        function playSound(type) {
            if (!soundEnabled) return;
            
            switch(type) {
                case 'click':
                    playBeep(800, 0.1, 'square');
                    break;
                case 'roll':
                    playBeep(400, 0.05, 'sine');
                    setTimeout(() => playBeep(600, 0.05, 'sine'), 50);
                    setTimeout(() => playBeep(300, 0.1, 'sine'), 100);
                    break;
                case 'combat':
                    playBeep(1200, 0.05, 'sawtooth');
                    break;
                case 'item':
                    playBeep(600, 0.2, 'triangle');
                    break;
                case 'success':
                    playBeep(1000, 0.15, 'sine');
                    setTimeout(() => playBeep(1200, 0.15, 'sine'), 150);
                    break;
                case 'failure':
                    playBeep(300, 0.3, 'sawtooth');
                    break;
                case 'damage':
                    playBeep(200, 0.2, 'square');
                    break;
                case 'victory':
                    playBeep(500, 0.1, 'sine');
                    setTimeout(() => playBeep(700, 0.1, 'sine'), 100);
                    setTimeout(() => playBeep(900, 0.1, 'sine'), 200);
                    setTimeout(() => playBeep(1100, 0.2, 'sine'), 300);
                    setTimeout(() => playBeep(1300, 0.3, 'sine'), 500);
                    break;
                case 'gold':
                    playBeep(1000, 0.1, 'sine');
                    for(let i = 0; i < 5; i++) {
                        setTimeout(() => playBeep(800 + i*100, 0.1, 'sine'), 100 + i*100);
                    }
                    break;
                case 'werewolf':
                    playBeep(80, 0.4, 'square');
                    setTimeout(() => playBeep(60, 0.4, 'square'), 400);
                    break;
                case 'cultist':
                    playBeep(400, 0.3, 'sawtooth');
                    setTimeout(() => playBeep(300, 0.3, 'sawtooth'), 300);
                    break;
                case 'woods':
                    playBeep(300, 0.2, 'sine');
                    setTimeout(() => playBeep(200, 0.2, 'sine'), 200);
                    setTimeout(() => playBeep(150, 0.2, 'sine'), 400);
                    break;
            }
        }
        
        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-status').textContent = soundEnabled ? 'ON' : 'OFF';
            
            if (soundEnabled) {
                playSound('click');
            }
        }
        
        // New Game function
        function newGame() {
            playSound('click');
            if (confirm("Start a new game? This will erase your current progress.")) {
                localStorage.removeItem('draculaGameState');
                window.location.href = 'le1.html';
            }
        }
        
        // Game state object - loaded from localStorage
        const savedState = JSON.parse(localStorage.getItem('draculaGameState'));
        let gameState;
        
        // If no saved game or wrong level, create default state for Level 2
        if (!savedState || savedState.level !== 2) {
            // Create a default state for Level 2 if player comes directly without completing Level 1
            gameState = {
                playerClass: 'warrior',
                strength: 18,
                maxHealth: 60,
                health: 60,
                agility: 12,
                gold: 50,
                inventory: ['Health Potion', 'Torch', 'Silver Amulet'],
                equippedWeapon: 'Steel Sword',
                equippedArmor: 'Leather Armor',
                currentSection: 1,
                gameComplete: false,
                level: 2,
                // Level 2 specific flags
                werewolfEncountered: false,
                cultistAmbush: false,
                ancientShrineFound: false,
                silverAcquired: false,
                forestPathCleared: false,
                // Special items
                hasSilverWeapon: false,
                hasHolyWater: false,
                hasTorch: true,
                // Level completion flags
                level1Complete: true,
                level2Complete: false
            };
        } else {
            // Use the saved state
            gameState = savedState;
            
            // IMPORTANT: Reset gameComplete flag when starting Level 2
            // Even if Level 1 was marked as complete, Level 2 should start fresh
            gameState.gameComplete = false;
            gameState.level2Complete = false;
            
            // Ensure level is set to 2
            gameState.level = 2;
            
            // Reset any Level 2 completion flags from previous playthroughs
            gameState.werewolfEncountered = false;
            gameState.cultistAmbush = false;
            gameState.ancientShrineFound = false;
            gameState.silverAcquired = false;
            gameState.forestPathCleared = false;
            
            // Mark Level 1 as completed (for progress tracking)
            gameState.level1Complete = true;
        }
        
        // Combat state
        let combatState = {
            active: false,
            enemyName: '',
            enemyHealth: 0,
            enemyCurrentHealth: 0,
            enemyStrength: 0,
            enemyDamageDice: 1,
            enemyDamageSides: 6,
            nextSection: 0,
            round: 1,
            isGroup: false,
            groupCount: 0
        };
        
        // Initialize game
        function initGame() {
            // Check if Level 2 is already completed
            if (gameState.level2Complete) {
                showCompleteScreen();
                return;
            }
            
            // Update display and start the game
            updateStatsDisplay();
            updateInventoryDisplay();
            loadSection(gameState.currentSection);
        }
        
        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('stat-strength').textContent = gameState.strength;
            document.getElementById('stat-health').textContent = gameState.health;
            document.getElementById('stat-maxhealth').textContent = gameState.maxHealth;
            document.getElementById('stat-agility').textContent = gameState.agility;
            document.getElementById('stat-gold').textContent = gameState.gold;
        }
        
        // Add item to inventory
        function addToInventory(item) {
            if (!gameState.inventory.includes(item) && item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                gameState.inventory.push(item);
                updateInventoryDisplay();
            }
        }
        
        // Remove item from inventory
        function removeFromInventory(item) {
            const index = gameState.inventory.indexOf(item);
            if (index !== -1) {
                gameState.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
        }
        
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryDiv = document.getElementById('inventory');
            inventoryDiv.innerHTML = '';
            
            // Add equipped weapon and armor first
            const equippedWeapon = document.createElement('div');
            equippedWeapon.className = 'inventory-item equipped';
            equippedWeapon.textContent = gameState.equippedWeapon;
            equippedWeapon.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedWeapon}</span></div>`;
            };
            inventoryDiv.appendChild(equippedWeapon);
            
            const equippedArmor = document.createElement('div');
            equippedArmor.className = 'inventory-item equipped';
            equippedArmor.textContent = gameState.equippedArmor;
            equippedArmor.onclick = () => {
                playSound('click');
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">Currently equipped: <span class='item'>${gameState.equippedArmor}</span></div>`;
            };
            inventoryDiv.appendChild(equippedArmor);
            
            // Add other inventory items
            gameState.inventory.forEach(item => {
                // Skip if it's the equipped weapon or armor
                if (item !== gameState.equippedWeapon && item !== gameState.equippedArmor) {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.textContent = item;
                    itemElement.onclick = () => {
                        useInventoryItem(item);
                    };
                    inventoryDiv.appendChild(itemElement);
                }
            });
            
            // Update inventory count
            const totalItems = gameState.inventory.length + 2; // +2 for equipped items
            document.getElementById('inventory-count').textContent = `ITEMS: ${totalItems}/10`;
        }
        
        // Use inventory item
        function useInventoryItem(item) {
            playSound('click');
            let message = "";
            
            if (item === 'Health Potion') {
                const healAmount = rollDice(2, 6) + 5;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You drink the <span class='item'>Health Potion</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Healing Herbs') {
                const healAmount = rollDice(1, 6) + 2;
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                const actualHeal = gameState.health - oldHealth;
                removeFromInventory(item);
                playSound('item');
                message = `You use the <span class='item'>Healing Herbs</span> and restore ${actualHeal} Health!`;
                updateStatsDisplay();
            } else if (item === 'Smoke Bomb') {
                if (combatState.active) {
                    // Escape combat
                    message = `You throw a <span class='item'>Smoke Bomb</span> and escape from combat!`;
                    combatState.active = false;
                    removeFromInventory(item);
                    loadSection(combatState.nextSection + 1); // Go to next section after escape
                } else {
                    message = "The <span class='item'>Smoke Bomb</span> can be used to escape from combat.";
                }
            } else if (item === 'Ancient Tome') {
                message = "The <span class='item'>Ancient Tome</span> contains knowledge about vampires and their weaknesses.";
                if (!gameState.inventory.includes('Silver Amulet')) {
                    message += " You find a silver amulet tucked between its pages!";
                    addToInventory('Silver Amulet');
                }
            } else if (item === 'Torch') {
                message = "The <span class='item'>Torch</span> illuminates your path and can scare away wild animals.";
            } else if (item === 'Silver Amulet') {
                message = "The <span class='item'>Silver Amulet</span> feels warm to the touch. It might offer protection against dark creatures.";
            } else if (item === 'Holy Water') {
                message = "The <span class='item'>Holy Water</span> glows faintly. It could be effective against undead creatures.";
                gameState.hasHolyWater = true;
            } else if (item === 'Silver Ingot') {
                message = "The <span class='item'>Silver Ingot</span> is pure and unblemished. It could be fashioned into a weapon.";
            } else if (item === 'Wolf Pelt') {
                message = "The <span class='item'>Wolf Pelt</span> is thick and warm. It might be valuable.";
            } else if (item === 'Cultist Robe') {
                message = "The <span class='item'>Cultist Robe</span> bears strange symbols. It could provide disguise.";
            } else {
                message = `You examine the <span class='item'>${item}</span>.`;
            }
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${message}</div>`;
        }
        
        // Use item from action button
        function useItem() {
            playSound('click');
            if (gameState.inventory.length === 0) {
                document.getElementById('story-text').innerHTML += 
                    `<div class="dice-roll">You have no usable items in your inventory.</div>`;
                return;
            }
            
            let itemText = "<div class='dice-roll'><strong>Select an item to use:</strong><br>";
            
            // Show equipped items
            itemText += `<br><strong>Equipped:</strong><br>`;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedWeapon}')" class="action-btn" style="margin: 5px;">${gameState.equippedWeapon}</button> `;
            itemText += `<button onclick="useInventoryItem('${gameState.equippedArmor}')" class="action-btn" style="margin: 5px;">${gameState.equippedArmor}</button>`;
            
            // Show inventory items
            const usableItems = gameState.inventory.filter(item => 
                item !== gameState.equippedWeapon && item !== gameState.equippedArmor);
            
            if (usableItems.length > 0) {
                itemText += `<br><br><strong>Inventory:</strong><br>`;
                usableItems.forEach(item => {
                    itemText += `<button onclick="useInventoryItem('${item}')" class="action-btn" style="margin: 5px;">${item}</button> `;
                });
            }
            
            itemText += `<br><br><button onclick="document.getElementById('story-text').innerHTML += '<div class=dice-roll>Item use cancelled.</div>'" class="action-btn">Cancel</button>`;
            itemText += "</div>";
            
            document.getElementById('story-text').innerHTML += itemText;
        }
        
        // Game story sections for Level 2
        const storySections = {
            1: {
                text: "You leave the Blood Moon Tavern behind and enter the <span class='woodlands'>Dark Woodlands</span>. The trees here are ancient and twisted, their branches forming a canopy that blocks out the moonlight. The air is thick with the scent of damp earth and decay.",
                choices: [
                    {text: "Follow the main path through the woods", nextSection: 2, skillCheck: false},
                    {text: "Take a narrow game trail to the east", nextSection: 3, skillCheck: false},
                    {text: "Check your equipment and light your torch", nextSection: 4, skillCheck: false, requirement: function() { return gameState.hasTorch; }}
                ]
            },
            2: {
                text: "You follow the main path, which is overgrown but still visible. Strange sounds echo through the trees - rustling leaves, snapping twigs, and what might be whispers on the wind.",
                choices: [
                    {text: "Continue cautiously along the path", nextSection: 5, skillCheck: false},
                    {text: "Investigate the whispering sounds", nextSection: 6, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Hide and wait to see what approaches", nextSection: 7, skillCheck: false}
                ]
            },
            3: {
                text: "The game trail is narrow and difficult to navigate. Thorns snag at your clothes, and the darkness seems to press in from all sides. You can hear something large moving through the underbrush nearby.",
                choices: [
                    {text: "Continue along the game trail", nextSection: 8, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Return to the main path", nextSection: 1, skillCheck: false},
                    {text: "Climb a tree to get a better view", nextSection: 9, skillCheck: true, checkType: 'strength', difficulty: 14}
                ]
            },
            4: {
                text: "You light your torch. The flame pushes back the oppressive darkness, revealing details of the forest you would have missed. Strange carvings mark some of the trees - symbols you don't recognize.",
                choices: [
                    {text: "Follow the main path with torch lit", nextSection: 10, skillCheck: false},
                    {text: "Investigate the carved symbols", nextSection: 11, skillCheck: false},
                    {text: "Take the game trail to the east", nextSection: 12, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The torchlight comforts you, but also makes you more visible to anything lurking in the darkness.";
                }
            },
            5: {
                text: "As you continue along the path, you come across a small clearing. In the center stands a weathered stone shrine, covered in moss and ivy. A faint, eerie light emanates from within.",
                choices: [
                    {text: "Approach the shrine cautiously", nextSection: 13, skillCheck: false},
                    {text: "Ignore the shrine and continue", nextSection: 14, skillCheck: false},
                    {text: "Search the area around the shrine", nextSection: 15, skillCheck: true, checkType: 'agility', difficulty: 14}
                ]
            },
            6: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 16, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You move silently toward the whispering sounds. Through the trees, you spot three hooded figures performing a ritual around a small fire. Cultists! They haven't noticed you.";
                    } else {
                        playSound('cultist');
                        gameState.cultistAmbush = true;
                        return "You stumble on a root, making noise. The whispering stops abruptly. Suddenly, hooded figures emerge from the shadows all around you!";
                    }
                }
            },
            7: {
                text: "You hide behind a large tree and wait. After a few minutes, you see a pair of glowing yellow eyes moving through the darkness. The creature is wolf-like but larger than any natural wolf. A werewolf!",
                choices: [
                    {text: "Stay hidden and let it pass", nextSection: 17, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Attack it while it's unaware", nextSection: 18, skillCheck: false},
                    {text: "Use your torch to scare it away", nextSection: 19, skillCheck: false, requirement: function() { return gameState.hasTorch; }}
                ],
                action: function() {
                    gameState.werewolfEncountered = true;
                    playSound('werewolf');
                    return "The creature sniffs the air, its powerful muscles tense. It knows something is nearby.";
                }
            },
            8: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 20, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You navigate the treacherous trail with skill, avoiding the worst of the obstacles. You discover a hidden silver deposit glinting in what little light filters through the canopy.";
                    } else {
                        const damage = rollDice(1, 8);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You trip over a hidden root and fall into a thorny bush, taking " + damage + " damage. The noise might have alerted nearby creatures.";
                    }
                }
            },
            9: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 21, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        gameState.forestPathCleared = true;
                        return "You climb to a high branch and get your bearings. You can see the path ahead clearly, including a shortcut that will save time. You also spot the distant mountains where the old church is located.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "The branch breaks under your weight! You fall, taking " + damage + " damage. The noise echoes through the quiet forest.";
                    }
                }
            },
            10: {
                text: "With your torch lighting the way, you make steady progress. The carved symbols on the trees seem to glow faintly in the torchlight. They appear to be pointing in a specific direction.",
                choices: [
                    {text: "Follow the direction indicated by the symbols", nextSection: 22, skillCheck: false},
                    {text: "Ignore the symbols and continue on the path", nextSection: 5, skillCheck: false},
                    {text: "Extinguish the torch and proceed cautiously", nextSection: 2, skillCheck: false}
                ]
            },
            11: {
                text: "You examine the carved symbols more closely. They're ancient and unfamiliar, but one pattern repeats: a crescent moon with a drop of blood beneath it. This must be a symbol of Dracula's cult.",
                choices: [
                    {text: "Follow the symbols to see where they lead", nextSection: 22, skillCheck: false},
                    {text: "Return to the main path", nextSection: 2, skillCheck: false}
                ],
                action: function() {
                    return "The symbols seem to form a trail. Someone or something wants travelers to follow this path.";
                }
            },
            12: {
                text: "You take the game trail with your torch held high. The light reveals animal tracks - some normal, others too large to be any natural creature of these woods.",
                choices: [
                    {text: "Follow the strange tracks", nextSection: 23, skillCheck: false},
                    {text: "Stay on the trail but be wary", nextSection: 8, skillCheck: false}
                ]
            },
            13: {
                text: "You approach the ancient shrine. Up close, you can see it's dedicated to some forgotten woodland deity. Offerings of flowers and small trinkets lie at its base, surprisingly fresh.",
                choices: [
                    {text: "Take a silver amulet from the offerings", nextSection: 24, skillCheck: false},
                    {text: "Leave an offering of your own", nextSection: 25, skillCheck: false},
                    {text: "Search the shrine for hidden compartments", nextSection: 26, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    gameState.ancientShrineFound = true;
                    playSound('item');
                    return "The shrine radiates a protective energy. This might be a safe place to rest, if only for a moment.";
                }
            },
            14: {
                text: "You bypass the shrine and continue deeper into the woodlands. The path becomes steeper, winding uphill toward the mountains. The trees thin slightly, allowing glimpses of the night sky.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false},
                    {text: "Rest for a moment and check your bearings", nextSection: 28, skillCheck: false}
                ],
                action: function() {
                    return "The air grows colder as you ascend. In the distance, you can just make out the silhouette of the old church on the mountainside.";
                }
            },
            15: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 29, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Silver Ingot');
                        gameState.silverAcquired = true;
                        return "Behind the shrine, hidden in the roots of an old tree, you find a small silver ingot! This pure silver could be useful against supernatural creatures.";
                    } else {
                        playSound('failure');
                        return "You search the area but find nothing of value. The shrine seems to have been picked clean by previous travelers.";
                    }
                }
            },
            16: {
                text: "After observing the cultists, you carefully back away. They seem to be preparing for some ritual, chanting in a language you don't understand.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false},
                    {text: "Find another path to avoid the cultists", nextSection: 30, skillCheck: false},
                    {text: "Attack the cultists to disrupt their ritual", nextSection: 31, skillCheck: false}
                ]
            },
            17: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 32, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You remain perfectly still as the werewolf passes by. It pauses, sniffing the air one last time, then continues on its way. You wait several minutes before moving again.";
                    } else {
                        playSound('werewolf');
                        return "You shift position slightly, making a noise. The werewolf's head snaps toward you, its eyes locking with yours. It growls low in its throat, preparing to attack!";
                        // Force combat
                        setTimeout(() => {
                            loadSection(18);
                        }, 1500);
                        return "";
                    }
                }
            },
            18: {
                text: "You attack the werewolf!",
                choices: [
                    {text: "Fight!", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Werewolf";
                    combatState.enemyHealth = 50;
                    combatState.enemyCurrentHealth = 50;
                    combatState.enemyStrength = 18;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 8;
                    combatState.nextSection = 34;
                    combatState.round = 0;
                    combatState.isGroup = false;
                    combatState.groupCount = 1;
                    
                    playSound('werewolf');
                    return "<span class='werewolf'>Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            19: {
                text: "You step forward, holding your torch high. The werewolf recoils from the flame, snarling but keeping its distance. Fire is one of the few things these creatures fear.",
                choices: [
                    {text: "Continue holding the torch as you back away", nextSection: 35, skillCheck: false},
                    {text: "Attack while it's afraid of the fire", nextSection: 36, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The werewolf hesitates, torn between its predatory instinct and its fear of fire. This might be your chance to escape or attack.";
                }
            },
            20: {
                text: "After your journey along the game trail, you emerge into a small clearing. Before you lies a silver deposit, the metal gleaming in the faint moonlight.",
                choices: [
                    {text: "Take some silver", nextSection: 37, skillCheck: false},
                    {text: "Continue onward", nextSection: 27, skillCheck: false},
                    {text: "Set up camp here for the night", nextSection: 38, skillCheck: false}
                ]
            },
            21: {
                text: "After climbing the tree, you continue your journey with better knowledge of the terrain.",
                choices: [
                    {text: "Take the shortcut you spotted", nextSection: 39, skillCheck: false},
                    {text: "Continue on the main path", nextSection: 27, skillCheck: false}
                ]
            },
            22: {
                text: "You follow the trail of symbols. They lead you to a hidden grove where the trees form a natural circle. In the center, a stone altar stands, stained dark with what looks like old blood.",
                choices: [
                    {text: "Examine the altar", nextSection: 40, skillCheck: false},
                    {text: "Search the grove for clues", nextSection: 41, skillCheck: true, checkType: 'agility', difficulty: 15},
                    {text: "Leave this cursed place immediately", nextSection: 42, skillCheck: false}
                ],
                action: function() {
                    playSound('cultist');
                    return "This is clearly a site of dark rituals. The air feels heavy with malevolent energy.";
                }
            },
            23: {
                text: "You follow the strange tracks. They lead to a cave entrance partially hidden by thick vines. Bones litter the ground outside - some animal, some disturbingly human.",
                choices: [
                    {text: "Enter the cave", nextSection: 43, skillCheck: false},
                    {text: "Avoid the cave and continue on the trail", nextSection: 8, skillCheck: false},
                    {text: "Set a trap at the cave entrance", nextSection: 44, skillCheck: true, checkType: 'agility', difficulty: 16}
                ],
                action: function() {
                    playSound('werewolf');
                    return "A low growl echoes from deep within the cave. Whatever lives here is home... and aware of your presence.";
                }
            },
            24: {
                text: "You take the silver amulet from the shrine's offerings. As your fingers touch it, a warm feeling spreads through your body. This item has protective properties.",
                choices: [
                    {text: "Continue your journey", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Amulet');
                    playSound('item');
                    return "The <span class='item'>Silver Amulet</span> glows faintly in your hand. It feels like a ward against evil.";
                }
            },
            25: {
                text: "You leave a gold coin as an offering at the shrine. As you do, you feel a sense of peace wash over you. Your health is partially restored.",
                choices: [
                    {text: "Continue your journey", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(2, 6);
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    gameState.gold -= 1;
                    updateStatsDisplay();
                    playSound('item');
                    return "The shrine accepts your offering. You feel restored, healing " + actualHeal + " Health.";
                }
            },
            26: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 45, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Holy Water');
                        gameState.hasHolyWater = true;
                        return "You find a hidden compartment at the base of the shrine! Inside is a small vial of holy water, still pure and potent.";
                    } else {
                        playSound('failure');
                        return "You search thoroughly but find no hidden compartments. The shrine is exactly what it appears to be.";
                    }
                }
            },
            27: {
                text: "You press on toward the mountains. The terrain becomes rougher, and you have to climb over fallen trees and navigate around rocky outcrops. The old church is now clearly visible ahead.",
                choices: [
                    {text: "Approach the church cautiously", nextSection: 46, skillCheck: false},
                    {text: "Find a vantage point to observe first", nextSection: 47, skillCheck: true, checkType: 'agility', difficulty: 14},
                    {text: "Rest and prepare for what's ahead", nextSection: 48, skillCheck: false}
                ],
                action: function() {
                    playSound('woods');
                    return "The <span class='church'>old church</span> stands silhouetted against the moon, its broken spire pointing like an accusing finger at the sky. Flickering lights move within.";
                }
            },
            28: {
                text: "You take a moment to rest and check your equipment. The woodlands have taken their toll, but you're nearing your destination.",
                choices: [
                    {text: "Continue toward the church", nextSection: 46, skillCheck: false},
                    {text: "Use any healing items you have", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    return "This might be your last chance to prepare before facing whatever awaits in the church.";
                }
            },
            29: {
                text: "After searching around the shrine, you continue your journey.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            30: {
                text: "You circle around to avoid the cultists, adding time to your journey but avoiding a direct confrontation. As you detour, you discover an old hunter's cabin, long abandoned.",
                choices: [
                    {text: "Search the cabin", nextSection: 50, skillCheck: false},
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            31: {
                text: "You decide to attack the cultists! They're caught by surprise, but there are three of them.",
                choices: [
                    {text: "Fight!", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Cultist Trio";
                    combatState.enemyHealth = 45;
                    combatState.enemyCurrentHealth = 45;
                    combatState.enemyStrength = 12;
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 52;
                    combatState.round = 0;
                    combatState.isGroup = true;
                    combatState.groupCount = 3;
                    
                    playSound('cultist');
                    return "<span class='cultist'>Cultist Trio</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            32: {
                text: "After the werewolf passes, you wait several minutes before continuing. Your heart pounds in your chest, but you've survived the encounter.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "That was too close. The woodlands are more dangerous than you anticipated.";
                }
            },
            33: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the werewolf!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            34: {
                text: "The werewolf lies dead at your feet. Searching the body, you find nothing of value except its pelt, which might be worth something.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Wolf Pelt');
                    const goldFound = rollDice(2, 8);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You take the <span class='item'>Wolf Pelt</span> and find <span class='gold'>" + goldFound + " Gold</span> in a small pouch around the creature's neck.";
                }
            },
            35: {
                text: "You back away slowly, keeping the torch between you and the werewolf. It snarls but doesn't pursue, its eyes fixed on the flame. Once you're a safe distance away, you turn and run.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You escape the werewolf, but your torch is nearly spent from being held so high. You'll need to be more careful from now on.";
                }
            },
            36: {
                text: "You attack the werewolf while it's distracted by the torch!",
                choices: [
                    {text: "Fight!", nextSection: 33, skillCheck: false}
                ],
                action: function() {
                    // Surprise round advantage - initial damage
                    const surpriseDamage = rollDice(1, 8) + 3;
                    
                    combatState.active = true;
                    combatState.enemyName = "Surprised Werewolf";
                    combatState.enemyHealth = 50 - surpriseDamage;
                    combatState.enemyCurrentHealth = 50 - surpriseDamage;
                    combatState.enemyStrength = 16; // Lower due to surprise and fear of fire
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 34;
                    combatState.round = 0;
                    combatState.isGroup = false;
                    combatState.groupCount = 1;
                    
                    playSound('combat');
                    return "You strike while it's distracted for " + surpriseDamage + " damage!<br><br><span class='werewolf'>Surprised Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            37: {
                text: "You collect some of the silver. It's pure and heavy, valuable both as currency and as a weapon against supernatural creatures.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Silver Ingot');
                    gameState.silverAcquired = true;
                    const goldValue = rollDice(3, 10);
                    gameState.gold += goldValue;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You acquire a <span class='item'>Silver Ingot</span> and collect <span class='gold'>" + goldValue + " Gold</span> worth of silver nuggets.";
                }
            },
            38: {
                text: "You decide to camp for the night. The silver deposit seems like a relatively safe spot - supernatural creatures tend to avoid pure silver.",
                choices: [
                    {text: "Continue in the morning", nextSection: 53, skillCheck: false}
                ],
                action: function() {
                    const healAmount = rollDice(1, 8) + 4;
                    const oldHealth = gameState.health;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                    const actualHeal = gameState.health - oldHealth;
                    updateStatsDisplay();
                    playSound('item');
                    return "You get a few hours of restful sleep, healing " + actualHeal + " Health. The silver around you keeps the night creatures at bay.";
                }
            },
            39: {
                text: "You take the shortcut you spotted from the tree. It's a steep climb but saves considerable time. Soon you're approaching the edge of the woodlands, with the mountains now directly ahead.",
                choices: [
                    {text: "Continue toward the church", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Your clever observation has saved you time and avoided additional dangers. The woodlands are nearly behind you.";
                }
            },
            40: {
                text: "The altar is cold to the touch. The dark stains are definitely blood, and recent. Various ritual implements lie scattered around - a black candle, a ritual knife, and pages torn from a book.",
                choices: [
                    {text: "Take the ritual knife", nextSection: 54, skillCheck: false},
                    {text: "Examine the book pages", nextSection: 55, skillCheck: false},
                    {text: "Destroy the altar", nextSection: 56, skillCheck: true, checkType: 'strength', difficulty: 16}
                ]
            },
            41: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 57, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        addToInventory('Cultist Robe');
                        return "Hidden in the bushes, you find a discarded cultist robe. It's still in good condition and might be useful for disguise.";
                    } else {
                        playSound('failure');
                        return "You search the grove but find nothing of value. The cultists were careful to leave no evidence behind.";
                    }
                }
            },
            42: {
                text: "You quickly leave the ritual site. The feeling of oppression lifts as you put distance between yourself and the altar.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Some places are best left unexplored. You trust your instincts and move away from the dark energy.";
                }
            },
            43: {
                text: "You enter the cave. The air inside is thick with the smell of wet fur and blood. Bones crunch underfoot. Deep in the cave, you see a pair of glowing eyes.",
                choices: [
                    {text: "Attack the creature in its lair", nextSection: 58, skillCheck: false},
                    {text: "Retreat from the cave", nextSection: 59, skillCheck: false},
                    {text: "Use a torch to light the cave", nextSection: 60, skillCheck: false, requirement: function() { return gameState.hasTorch; }}
                ]
            },
            44: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 61, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You rig a simple trap at the cave entrance using vines and a heavy rock. If the creature returns, it will be injured or at least delayed.";
                    } else {
                        playSound('failure');
                        return "You try to set a trap but make too much noise. A loud roar echoes from the cave!";
                        // Force cave encounter
                        setTimeout(() => {
                            loadSection(43);
                        }, 1500);
                        return "";
                    }
                }
            },
            45: {
                text: "After searching the shrine, you continue your journey.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            46: {
                text: "You approach the old church at the edge of the woodlands. The building is in disrepair, with broken windows and a partially collapsed roof. Flickering candlelight shines from within, and you can hear chanting.",
                choices: [
                    {text: "Enter through the main doors", nextSection: 62, skillCheck: false},
                    {text: "Sneak around to find another entrance", nextSection: 63, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Climb to a window to peer inside", nextSection: 64, skillCheck: true, checkType: 'agility', difficulty: 15}
                ],
                action: function() {
                    playSound('cultist');
                    return "This is it. The cult's headquarters. Whatever happens here will determine the fate of the region.";
                }
            },
            47: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 65, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "From your vantage point, you can see inside the church. There are at least a dozen cultists performing a ritual around a central altar. At the head stands a tall figure in dark robes - their leader. You also spot two prisoners bound near the altar.";
                    } else {
                        playSound('failure');
                        return "You try to find a good vantage point but can't see much. You'll have to approach blindly.";
                        // Go to church approach
                        setTimeout(() => {
                            loadSection(46);
                        }, 1000);
                        return "";
                    }
                }
            },
            48: {
                text: "You take time to prepare. This might be your final stand against the cult before you reach the mountains proper.",
                choices: [
                    {text: "Approach the church", nextSection: 46, skillCheck: false},
                    {text: "Use any remaining healing items", nextSection: 49, skillCheck: false}
                ],
                action: function() {
                    return "This is your last chance to use any items or prepare your weapons. The cult awaits.";
                }
            },
            49: {
                text: "You use this moment to heal and prepare.",
                choices: [
                    {text: "Approach the church", nextSection: 46, skillCheck: false}
                ],
                action: function() {
                    let message = "You prepare for the confrontation ahead.";
                    
                    // Check for healing items
                    const hasHealthPotion = gameState.inventory.includes('Health Potion');
                    const hasHealingHerbs = gameState.inventory.includes('Healing Herbs');
                    
                    if (hasHealthPotion) {
                        const healAmount = rollDice(2, 6) + 5;
                        const oldHealth = gameState.health;
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                        const actualHeal = gameState.health - oldHealth;
                        removeFromInventory('Health Potion');
                        message += `<br>You drink your <span class='item'>Health Potion</span>, healing ${actualHeal} Health.`;
                    } else if (hasHealingHerbs) {
                        const healAmount = rollDice(1, 6) + 2;
                        const oldHealth = gameState.health;
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                        const actualHeal = gameState.health - oldHealth;
                        removeFromInventory('Healing Herbs');
                        message += `<br>You use your <span class='item'>Healing Herbs</span>, healing ${actualHeal} Health.`;
                    } else {
                        message += "<br>You have no healing items remaining.";
                    }
                    
                    updateStatsDisplay();
                    return message;
                }
            },
            50: {
                text: "The cabin is dark and dusty. It looks like it hasn't been occupied in years. You find some old supplies and a journal detailing strange occurrences in the woodlands.",
                choices: [
                    {text: "Take supplies from the cabin", nextSection: 66, skillCheck: false},
                    {text: "Read the journal", nextSection: 67, skillCheck: false},
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            51: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 51, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the cultists!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            52: {
                text: "The cultists lie defeated. Searching their bodies, you find ritual items and some gold.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 10);
                    gameState.gold += goldFound;
                    addToInventory('Cultist Robe');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and take a <span class='item'>Cultist Robe</span> that might be useful for disguise.";
                }
            },
            53: {
                text: "After resting at the silver deposit, you continue your journey refreshed. The woodlands seem less threatening in the early morning light.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            54: {
                text: "You take the ritual knife. It's cold and seems to absorb the light around it. This is an evil tool, but it might be useful.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Ritual Knife');
                    playSound('item');
                    return "The <span class='item'>Ritual Knife</span> feels wrong in your hand, but its edge is sharp. It could serve as a weapon in a pinch.";
                }
            },
            55: {
                text: "The book pages contain information about Dracula's resurrection ritual. According to the text, the cult needs three sacrifices under a blood moon to complete the ritual. The next blood moon is in two nights!",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "You now understand the cult's plan. They're preparing to sacrifice prisoners to resurrect Dracula. You have little time to stop them.";
                }
            },
            56: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 68, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You smash the altar with a large rock, reducing it to rubble. The dark energy in the grove dissipates immediately. You've disrupted one of their ritual sites.";
                    } else {
                        playSound('failure');
                        return "The altar is sturdier than it looks. You can't damage it with your bare hands. As you struggle, you hear approaching footsteps!";
                        // Cultists arrive
                        setTimeout(() => {
                            loadSection(31);
                        }, 1500);
                        return "";
                    }
                }
            },
            57: {
                text: "After searching the grove, you continue your journey.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            58: {
                text: "You attack the creature in its lair! It's a massive wolf-like beast with intelligence in its eyes.",
                choices: [
                    {text: "Fight!", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Alpha Werewolf";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 20;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 70;
                    combatState.round = 0;
                    combatState.isGroup = false;
                    combatState.groupCount = 1;
                    
                    playSound('werewolf');
                    return "<span class='werewolf'>Alpha Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            59: {
                text: "You wisely retreat from the cave. Some battles aren't worth fighting, especially not in the enemy's territory.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Discretion is the better part of valor. You leave the cave and its occupant undisturbed.";
                }
            },
            60: {
                text: "You light your torch and hold it high. The cave interior is revealed - bones everywhere, and at the back, a massive werewolf chained to the wall! It's a prisoner, not a wild beast.",
                choices: [
                    {text: "Free the werewolf", nextSection: 71, skillCheck: false},
                    {text: "Leave it chained", nextSection: 59, skillCheck: false},
                    {text: "Attack while it's restrained", nextSection: 72, skillCheck: false}
                ],
                action: function() {
                    playSound('item');
                    return "The creature looks at you with intelligent, pleading eyes. The chains are thick but old and rusty.";
                }
            },
            61: {
                text: "After setting your trap, you continue on your way. You hear a loud crash and angry roar from behind you - your trap worked!",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "Whatever was in that cave will be delayed or injured. You've bought yourself some time.";
                }
            },
            62: {
                text: "You burst through the main doors! The cultists inside turn as one, their chanting cutting off abruptly. The leader steps forward, a cruel smile on his face.",
                choices: [
                    {text: "Attack the cultists", nextSection: 73, skillCheck: false},
                    {text: "Demand the release of the prisoners", nextSection: 74, skillCheck: false},
                    {text: "Use holy water if you have it", nextSection: 75, skillCheck: false, requirement: function() { return gameState.hasHolyWater; }}
                ],
                action: function() {
                    playSound('cultist');
                    return "<span class='cultist'>Cult Leader</span>: 'Ah, the hunter arrives right on schedule. You'll make an excellent sacrifice!'";
                }
            },
            63: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You find a side entrance used for bringing in supplies. It's unguarded. You slip inside unnoticed, finding yourself in a storage room adjacent to the main chapel.";
                    } else {
                        playSound('failure');
                        return "You try to sneak around but trip over a loose stone. The noise alerts a guard!";
                        // Combat with guard
                        setTimeout(() => {
                            combatState.active = true;
                            combatState.enemyName = "Cult Guard";
                            combatState.enemyHealth = 30;
                            combatState.enemyCurrentHealth = 30;
                            combatState.enemyStrength = 14;
                            combatState.enemyDamageDice = 2;
                            combatState.enemyDamageSides = 6;
                            combatState.nextSection = 77;
                            combatState.round = 0;
                            combatState.isGroup = false;
                            combatState.groupCount = 1;
                            loadSection(78);
                        }, 1500);
                        return "A cult guard emerges from the shadows, weapon drawn!";
                    }
                }
            },
            64: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 79, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You climb to a broken window and peer inside. You count twelve cultists, plus their leader. The two prisoners are bound to pillars near the altar. There's also a rear exit that might be useful.";
                    } else {
                        const damage = rollDice(1, 6);
                        gameState.health -= damage;
                        updateStatsDisplay();
                        playSound('damage');
                        return "You slip and fall from the window, taking " + damage + " damage! The noise alerts the cultists inside.";
                        // Go to main entrance forced
                        setTimeout(() => {
                            loadSection(62);
                        }, 1500);
                        return "";
                    }
                }
            },
            65: {
                text: "After observing the church, you now have valuable information about what you're facing.",
                choices: [
                    {text: "Enter through the main doors", nextSection: 62, skillCheck: false},
                    {text: "Try to find another entrance", nextSection: 63, skillCheck: false},
                    {text: "Create a distraction first", nextSection: 80, skillCheck: true, checkType: 'agility', difficulty: 15}
                ]
            },
            66: {
                text: "You find some useful supplies in the cabin: a few healing herbs and an old but serviceable dagger.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    addToInventory('Healing Herbs');
                    if (!gameState.inventory.includes('Dagger') && gameState.equippedWeapon !== 'Dagger') {
                        addToInventory('Old Dagger');
                    }
                    playSound('item');
                    return "You find <span class='item'>Healing Herbs</span> and an <span class='item'>Old Dagger</span>. The cabin's former occupant was clearly prepared for trouble.";
                }
            },
            67: {
                text: "The journal details increasing supernatural activity in the woodlands over the past year. The writer mentions a 'pale man in dark robes' who appeared one night and began recruiting followers. The last entry is chilling: 'They took my neighbor last night. I can hear chanting from the old church. I must leave tomorrow.'",
                choices: [
                    {text: "Take supplies and continue", nextSection: 66, skillCheck: false},
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "The journal confirms everything you've learned. The cult has been active for at least a year, growing bolder with each passing month.";
                }
            },
            68: {
                text: "After dealing with the altar, you continue your journey. The woodlands seem a little less oppressive now.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ]
            },
            69: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 69, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the alpha werewolf!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            70: {
                text: "The alpha werewolf is defeated. Its lair contains more treasure than a normal beast would have accumulated.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(5, 10);
                    gameState.gold += goldFound;
                    addToInventory('Alpha Wolf Pelt');
                    addToInventory('Silver Ingot');
                    gameState.silverAcquired = true;
                    updateStatsDisplay();
                    playSound('gold');
                    return "You find <span class='gold'>" + goldFound + " Gold</span>, an <span class='item'>Alpha Wolf Pelt</span>, and another <span class='item'>Silver Ingot</span>. This creature was hoarding treasure.";
                }
            },
            71: {
                text: "You break the chains with your weapon. The werewolf transforms before your eyes into a human man, weak and malnourished. 'Thank you,' he gasps. 'The cult captured me weeks ago. They've been experimenting on me.'",
                choices: [
                    {text: "Ask what he knows", nextSection: 81, skillCheck: false},
                    {text: "Give him supplies and continue", nextSection: 82, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The man is grateful but clearly traumatized by his experience.";
                }
            },
            72: {
                text: "You attack the chained werewolf. It cannot defend itself properly.",
                choices: [
                    {text: "Finish it", nextSection: 83, skillCheck: false}
                ],
                action: function() {
                    // Easy combat due to chains
                    combatState.active = true;
                    combatState.enemyName = "Chained Werewolf";
                    combatState.enemyHealth = 60;
                    combatState.enemyCurrentHealth = 60;
                    combatState.enemyStrength = 8; // Much lower due to chains
                    combatState.enemyDamageDice = 1;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 84;
                    combatState.round = 0;
                    combatState.isGroup = false;
                    combatState.groupCount = 1;
                    
                    playSound('combat');
                    return "<span class='werewolf'>Chained Werewolf</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength + " (Restrained)";
                }
            },
            73: {
                text: "You attack the cultists! There are many of them, but you have the element of surprise.",
                choices: [
                    {text: "Fight!", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    combatState.active = true;
                    combatState.enemyName = "Cult of Dracula";
                    combatState.enemyHealth = 80;
                    combatState.enemyCurrentHealth = 80;
                    combatState.enemyStrength = 15;
                    combatState.enemyDamageDice = 3;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 86;
                    combatState.round = 0;
                    combatState.isGroup = true;
                    combatState.groupCount = 12;
                    
                    playSound('cultist');
                    return "<span class='cultist'>Cult of Dracula</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength;
                }
            },
            74: {
                text: "'Release the prisoners!' you demand. The cult leader laughs. 'Or what? You'll attack us? There are twelve of us and one of you.'",
                choices: [
                    {text: "Attack anyway", nextSection: 73, skillCheck: false},
                    {text: "Try to negotiate", nextSection: 87, skillCheck: true, checkType: 'agility', difficulty: 18},
                    {text: "Create a diversion", nextSection: 88, skillCheck: false}
                ],
                action: function() {
                    return "<span class='cultist'>Cult Leader</span>: 'Join us, hunter. Serve Dracula and you'll be rewarded with eternal life.'";
                }
            },
            75: {
                text: "You throw the holy water at the cult leader. It splashes across his face and chest. He screams as his skin smokes and blisters!",
                choices: [
                    {text: "Attack while they're distracted", nextSection: 89, skillCheck: false}
                ],
                action: function() {
                    removeFromInventory('Holy Water');
                    playSound('success');
                    return "The holy water burns the cult leader severely. The other cultists look shocked and uncertain. This is your chance!";
                }
            },
            76: {
                text: "From the storage room, you have a clear view of the main chapel. The cultists are focused on their ritual and haven't noticed you.",
                choices: [
                    {text: "Sneak up and attack the leader", nextSection: 90, skillCheck: true, checkType: 'agility', difficulty: 17},
                    {text: "Free the prisoners quietly", nextSection: 91, skillCheck: true, checkType: 'agility', difficulty: 16},
                    {text: "Attack from your hidden position", nextSection: 92, skillCheck: false}
                ]
            },
            77: {
                text: "After defeating the guard, you now have access to the church.",
                choices: [
                    {text: "Enter the church", nextSection: 62, skillCheck: false}
                ]
            },
            78: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 78, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the cult guard!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            79: {
                text: "After observing through the window, you now know what you're facing inside the church.",
                choices: [
                    {text: "Enter through the main doors", nextSection: 62, skillCheck: false},
                    {text: "Try the rear exit you spotted", nextSection: 93, skillCheck: false}
                ]
            },
            80: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 94, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You create a distraction by throwing rocks at the far side of the church. Several cultists go to investigate, reducing their numbers inside.";
                        // Reduced enemy count for combat
                        setTimeout(() => {
                            combatState.active = true;
                            combatState.enemyName = "Reduced Cult";
                            combatState.enemyHealth = 60;
                            combatState.enemyCurrentHealth = 60;
                            combatState.enemyStrength = 14;
                            combatState.enemyDamageDice = 2;
                            combatState.enemyDamageSides = 6;
                            combatState.nextSection = 86;
                            combatState.round = 0;
                            combatState.isGroup = true;
                            combatState.groupCount = 8; // Reduced from 12
                            loadSection(85);
                        }, 1500);
                        return "";
                    } else {
                        playSound('failure');
                        return "Your distraction attempt fails. The cultists remain inside, alert and waiting.";
                        // Go to main entrance
                        setTimeout(() => {
                            loadSection(62);
                        }, 1000);
                        return "";
                    }
                }
            },
            81: {
                text: "'What do you know about the cult?' you ask. The man shivers. 'They're preparing for Dracula's return. They need three sacrifices under the blood moon. I was to be the third. The other two are in the old church.'",
                choices: [
                    {text: "Give him supplies and continue", nextSection: 82, skillCheck: false},
                    {text: "Ask him to help you", nextSection: 95, skillCheck: false}
                ],
                action: function() {
                    return "<span class='npc'>Freed Prisoner</span>: 'Their leader is not human. He has powers... dark magic. Be careful.'";
                }
            },
            82: {
                text: "You give the man some supplies and directions to safety. He thanks you profusely before staggering off into the night.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    if (gameState.inventory.includes('Healing Herbs')) {
                        removeFromInventory('Healing Herbs');
                        return "You give him your <span class='item'>Healing Herbs</span>. He needs them more than you do. 'May God protect you,' he says before leaving.";
                    } else {
                        return "You have no supplies to give, but you point him toward the nearest village. He nods gratefully and leaves.";
                    }
                }
            },
            83: {
                text: "You execute the defenseless creature. It feels wrong, but it's done.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(3, 8);
                    gameState.gold += goldFound;
                    addToInventory('Wolf Pelt');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and take its <span class='item'>Wolf Pelt</span>. The cave is now safe, but you feel no pride in this victory.";
                }
            },
            84: {
                text: "The chained werewolf is defeated. It was an easy but dishonorable fight.",
                choices: [
                    {text: "Continue toward the mountains", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    const goldFound = rollDice(2, 6);
                    gameState.gold += goldFound;
                    addToInventory('Wolf Pelt');
                    updateStatsDisplay();
                    playSound('gold');
                    return "You find <span class='gold'>" + goldFound + " Gold</span> and take its <span class='item'>Wolf Pelt</span>.";
                }
            },
            85: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 85, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the cult!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            86: {
                text: "The cult lies defeated. The prisoners are freed, and the immediate threat is over. But as you catch your breath, you realize this was just an outpost - the true danger lies deeper in the mountains.",
                choices: [
                    {text: "Complete Level 2", nextSection: 96, skillCheck: false}
                ],
                action: function() {
                    gameState.level2Complete = true;
                    gameState.gameComplete = true;
                    const goldFound = rollDice(5, 20);
                    gameState.gold += goldFound;
                    updateStatsDisplay();
                    playSound('victory');
                    return "You free the prisoners and search the church. You find <span class='gold'>" + goldFound + " Gold</span> and important documents detailing Dracula's plans. The cult is broken here, but the real battle is yet to come.";
                }
            },
            87: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 97, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "'Let the prisoners go, and I'll leave peacefully,' you say. 'If not, I'll make sure Dracula hears how you failed him.' The cult leader hesitates, then nods. 'Release them. This isn't worth my position.' The cultists reluctantly free the prisoners.";
                        // Success without combat
                        setTimeout(() => {
                            gameState.level2Complete = true;
                            gameState.gameComplete = true;
                            loadSection(96);
                        }, 1500);
                        return "";
                    } else {
                        playSound('failure');
                        return "'You think you can threaten me?' the cult leader scoffs. 'Kill him!'";
                        // Force combat
                        setTimeout(() => {
                            loadSection(73);
                        }, 1500);
                        return "";
                    }
                }
            },
            88: {
                text: "You create a diversion by knocking over a brazier. Fire spreads across the floor, causing panic among the cultists.",
                choices: [
                    {text: "Attack while they're distracted", nextSection: 89, skillCheck: false},
                    {text: "Free the prisoners during the chaos", nextSection: 91, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "The fire creates confusion. Some cultists try to put it out, others run for safety. This is your chance!";
                }
            },
            89: {
                text: "You attack while the cultists are distracted!",
                choices: [
                    {text: "Fight!", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    // Combat with advantage due to distraction
                    combatState.active = true;
                    combatState.enemyName = "Distracted Cult";
                    combatState.enemyHealth = 70; // Reduced from 80
                    combatState.enemyCurrentHealth = 70;
                    combatState.enemyStrength = 13; // Reduced from 15
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 86;
                    combatState.round = 0;
                    combatState.isGroup = true;
                    combatState.groupCount = 12;
                    
                    playSound('combat');
                    return "<span class='cultist'>Distracted Cult</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength + " (Distracted)";
                }
            },
            90: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 99, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You sneak up behind the cult leader and strike! He falls without a sound. With their leader dead, the other cultists panic and flee!";
                        // Success without full combat
                        setTimeout(() => {
                            gameState.level2Complete = true;
                            gameState.gameComplete = true;
                            loadSection(96);
                        }, 1500);
                        return "";
                    } else {
                        playSound('failure');
                        return "You try to sneak up but step on a loose floorboard. The cult leader turns just as you attack, deflecting your blow!";
                        // Force combat
                        setTimeout(() => {
                            loadSection(73);
                        }, 1500);
                        return "";
                    }
                }
            },
            91: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 100, skillCheck: false}
                ],
                action: function() {
                    if (window.checkResult) {
                        playSound('success');
                        return "You sneak to the prisoners and cut their bonds without being noticed. You escort them out of the church before the cultists realize what's happened.";
                        // Success without combat
                        setTimeout(() => {
                            gameState.level2Complete = true;
                            gameState.gameComplete = true;
                            loadSection(96);
                        }, 1500);
                        return "";
                    } else {
                        playSound('failure');
                        return "You're spotted freeing the prisoners! The cult leader shouts an alarm.";
                        // Force combat
                        setTimeout(() => {
                            loadSection(73);
                        }, 1500);
                        return "";
                    }
                }
            },
            92: {
                text: "You attack from your hidden position, catching the cultists by surprise!",
                choices: [
                    {text: "Fight!", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    // Combat with surprise advantage
                    combatState.active = true;
                    combatState.enemyName = "Surprised Cult";
                    combatState.enemyHealth = 70; // Reduced from 80
                    combatState.enemyCurrentHealth = 70;
                    combatState.enemyStrength = 13; // Reduced from 15
                    combatState.enemyDamageDice = 2;
                    combatState.enemyDamageSides = 6;
                    combatState.nextSection = 86;
                    combatState.round = 0;
                    combatState.isGroup = true;
                    combatState.groupCount = 12;
                    
                    playSound('combat');
                    return "<span class='cultist'>Surprised Cult</span>: Health " + combatState.enemyCurrentHealth + ", Strength " + combatState.enemyStrength + " (Surprised)";
                }
            },
            93: {
                text: "You circle around to the rear of the church. The exit is unguarded - the cultists are all inside for the ritual.",
                choices: [
                    {text: "Enter through the rear exit", nextSection: 76, skillCheck: false}
                ],
                action: function() {
                    playSound('success');
                    return "You slip inside unnoticed. From here, you can see the entire ritual taking place in the main chapel.";
                }
            },
            94: {
                text: "After creating your distraction, you prepare to enter the church.",
                choices: [
                    {text: "Enter now", nextSection: 62, skillCheck: false}
                ]
            },
            95: {
                text: "'Will you help me against the cult?' you ask. The man shakes his head. 'I... I can't. What they did to me... I need to get as far from here as possible.' He looks ashamed but determined.",
                choices: [
                    {text: "Give him supplies and wish him well", nextSection: 82, skillCheck: false},
                    {text: "Continue alone", nextSection: 27, skillCheck: false}
                ],
                action: function() {
                    return "<span class='npc'>Freed Prisoner</span>: 'I'm sorry. Good luck, hunter. You'll need it.'";
                }
            },
            96: {
                text: "",
                choices: [
                    {text: "Continue", nextSection: 101, skillCheck: false}
                ],
                action: function() {
                    // Show complete screen
                    showCompleteScreen();
                    return "";
                }
            },
            97: {
                text: "After negotiating with the cult leader, the prisoners are freed and you leave the church.",
                choices: [
                    {text: "Complete Level 2", nextSection: 96, skillCheck: false}
                ]
            },
            98: {
                text: "",
                choices: [
                    {text: "Attack!", nextSection: 98, skillCheck: false}
                ],
                action: function() {
                    // Execute one round of combat
                    if (combatState.active) {
                        const combatResult = executeCombatRound();
                        
                        // Check if combat is over
                        if (combatState.enemyCurrentHealth <= 0) {
                            combatState.active = false;
                            // Automatically go to victory section after a short delay
                            setTimeout(() => {
                                loadSection(combatState.nextSection);
                            }, 1500);
                            return combatResult + "<br><br><span class='success'>You defeated the cult!</span>";
                        } else if (gameState.health <= 0) {
                            combatState.active = false;
                            // Game over - will be handled in executeCombatRound
                            return combatResult;
                        }
                        
                        return combatResult;
                    }
                    return "Combat has ended.";
                }
            },
            99: {
                text: "After assassinating the cult leader, the remaining cultists flee in panic.",
                choices: [
                    {text: "Complete Level 2", nextSection: 96, skillCheck: false}
                ]
            },
            100: {
                text: "After rescuing the prisoners without being detected, you escape the church with them.",
                choices: [
                    {text: "Complete Level 2", nextSection: 96, skillCheck: false}
                ]
            },
            101: {
                text: "",
                choices: []
            }
        };
        
        // Load story section
        function loadSection(sectionId) {
            playSound('click');
            gameState.currentSection = sectionId;
            const section = storySections[sectionId];
            
            if (!section) {
                document.getElementById('story-text').innerHTML = "<p class='game-over'>Error: Story section not found!</p>";
                return;
            }
            
            let storyText = section.text;
            
            // Execute any section action
            if (section.action) {
                const actionResult = section.action();
                if (actionResult) {
                    storyText += "<br><br>" + actionResult;
                }
            }
            
            document.getElementById('story-text').innerHTML = "<p>" + storyText + "</p><div class='blinking-cursor'></div>";
            
            // Clear choice buttons
            const choiceButtons = document.getElementById('choice-buttons');
            choiceButtons.innerHTML = '';
            
            // If in combat, show attack button
            if (combatState.active && (sectionId === 33 || sectionId === 51 || sectionId === 69 || sectionId === 78 || sectionId === 85 || sectionId === 98)) {
                const attackButton = document.createElement('button');
                attackButton.className = 'choice-btn';
                attackButton.textContent = "Attack!";
                attackButton.onclick = function() {
                    loadSection(sectionId); // Reload the same section to execute another combat round
                };
                choiceButtons.appendChild(attackButton);
                return;
            }
            
            // Filter choices based on requirements
            const availableChoices = section.choices.filter(choice => {
                if (!choice.requirement) return true;
                if (typeof choice.requirement === 'function') {
                    return choice.requirement();
                }
                return gameState.inventory.includes(choice.requirement) || 
                       gameState.equippedWeapon === choice.requirement ||
                       gameState.equippedArmor === choice.requirement;
            });
            
            // If no choices available (and not a special section), provide a default
            if (availableChoices.length === 0 && section.choices.length > 0) {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = "Continue";
                button.onclick = function() {
                    loadSection(1); // Go back to start
                };
                choiceButtons.appendChild(button);
            } else {
                availableChoices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = function() {
                        if (choice.skillCheck) {
                            performSkillCheck(choice.checkType, choice.difficulty, choice.nextSection);
                        } else {
                            loadSection(choice.nextSection);
                        }
                    };
                    choiceButtons.appendChild(button);
                });
            }
            
            // Save game progress
            saveGame();
        }
        
        // Execute one round of combat
        function executeCombatRound() {
            combatState.round++;
            
            // Roll dice for both combatants
            const playerRoll = rollDice(2, 6);
            const enemyRoll = rollDice(2, 6);
            
            // Add strength to dice rolls
            const playerTotal = playerRoll + gameState.strength;
            const enemyTotal = enemyRoll + combatState.enemyStrength;
            
            let resultText = `<div class="combat-log"><span class="enemy">ROUND ${combatState.round}: ${combatState.enemyName}</span><br>`;
            resultText += `Your Health: ${gameState.health}/${gameState.maxHealth}, Enemy Health: ${combatState.enemyCurrentHealth}<br>`;
            resultText += `You roll ${playerRoll} + Strength ${gameState.strength} = <strong>${playerTotal}</strong><br>`;
            resultText += `Enemy rolls ${enemyRoll} + Strength ${combatState.enemyStrength} = <strong>${enemyTotal}</strong><br>`;
            
            if (playerTotal > enemyTotal) {
                // Player hits enemy
                let damage = 0;
                let weaponType = gameState.equippedWeapon;
                
                // Weapon bonuses
                if (weaponType === 'Steel Sword') {
                    damage = rollDice(2, 8) + 3;
                } else if (weaponType === 'Silver Dagger' || weaponType === 'Silver Ingot') {
                    damage = rollDice(2, 6) + 4; // Bonus against supernatural
                } else if (weaponType === 'Walking Stick') {
                    damage = rollDice(1, 6) + 1;
                } else if (weaponType === 'Ritual Knife') {
                    damage = rollDice(1, 6) + 2;
                } else {
                    damage = rollDice(1, 6);
                }
                
                // Silver bonus against werewolves
                if (combatState.enemyName.includes('Werewolf') && gameState.hasSilverWeapon) {
                    damage += 5;
                    resultText += `Silver weapon bonus: +5 damage!<br>`;
                }
                
                combatState.enemyCurrentHealth -= damage;
                resultText += `<span class="success">You hit for ${damage} damage!</span><br>`;
                playSound('combat');
                
            } else if (playerTotal < enemyTotal) {
                // Enemy hits player
                let enemyDamage = rollDice(combatState.enemyDamageDice, combatState.enemyDamageSides);
                
                // Group enemies attack together
                if (combatState.isGroup && combatState.groupCount > 1) {
                    enemyDamage += Math.floor(combatState.groupCount * 2); // Extra damage for group
                    resultText += `The enemies attack together!<br>`;
                }
                
                gameState.health -= enemyDamage;
                resultText += `<span class="damage">The ${combatState.enemyName} hits you for ${enemyDamage} damage!</span>`;
                playSound('damage');
                
            } else {
                // Tie - no damage dealt
                resultText += "The attacks are evenly matched! No damage dealt this round.";
            }
            
            resultText += `</div>`;
            updateStatsDisplay();
            
            return resultText;
        }
        
        // Show complete screen
        function showCompleteScreen() {
            // Update complete screen stats
            document.getElementById('complete-stat-strength').textContent = gameState.strength;
            document.getElementById('complete-stat-health').textContent = gameState.health;
            document.getElementById('complete-stat-agility').textContent = gameState.agility;
            document.getElementById('complete-stat-gold').textContent = gameState.gold;
            
            playSound('victory');
            document.getElementById('screen-game').classList.remove('active-screen');
            document.getElementById('screen-complete').classList.add('active-screen');
            
            // Save completed game state
            saveGame();
        }
        
        // Go to next level
        function goToNextLevel() {
            playSound('click');
            // Save game state for level 3
            gameState.level = 3;
            gameState.currentSection = 1;
            saveGame();
            
            // Redirect to level 3
            window.location.href = 'le3.html';
        }
        
        // Perform skill check
        function performSkillCheck(checkType, difficulty, nextSection) {
            playSound('roll');
            const diceRoll = rollDice(2, 6);
            let statValue = gameState[checkType];
            let success = diceRoll <= statValue;
            
            // Store result globally for section actions to use
            window.checkResult = success;
            
            let resultText = `You roll ${diceRoll}. Your ${checkType.toUpperCase()} is ${statValue}. `;
            resultText += success ? 
                `<span class="success">Success!</span>` : 
                `<span class="damage">Failure!</span>`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
            } else {
                playSound('failure');
            }
            
            // Continue to next section after a brief delay
            setTimeout(() => {
                loadSection(nextSection);
            }, 1500);
        }
        
        // Use Agility
        function useAgility() {
            playSound('click');
            if (gameState.agility <= 0) {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">You have no Agility!</div>`;
                return;
            }
            
            const diceRoll = rollDice(2, 6);
            const success = diceRoll <= gameState.agility;
            
            let resultText = `You use your agility... Roll: ${diceRoll}, Agility: ${gameState.agility}. `;
            resultText += success ? 
                `<span class="success">Agile!</span> You move with grace and speed.` : 
                `<span class="damage">Clumsy!</span> You fumble.`;
            
            document.getElementById('story-text').innerHTML += `<div class="dice-roll">${resultText}</div>`;
            
            if (success) {
                playSound('success');
                // Good effect
                const goodEffects = [
                    "You dodge an attack!",
                    "You move silently past an enemy.",
                    "You climb a difficult obstacle.",
                    "You slip through a narrow passage."
                ];
                const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
            } else {
                playSound('failure');
                // Bad effect
                const badEffects = [
                    "You trip and take 5 damage!",
                    "You make noise and alert nearby enemies.",
                    "You get tangled in something.",
                    "You knock something over, making noise."
                ];
                const effect = badEffects[Math.floor(Math.random() * badEffects.length)];
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">${effect}</div>`;
                
                if (effect.includes("damage")) {
                    gameState.health -= 5;
                    updateStatsDisplay();
                    playSound('damage');
                }
            }
        }
        
        // Save game
        function saveGame() {
            playSound('click');
            localStorage.setItem('draculaGameState', JSON.stringify(gameState));
            document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game saved!</span></div>`;
        }
        
        // Load game
        function loadGame() {
            playSound('click');
            const savedGame = localStorage.getItem('draculaGameState');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                
                // Only load if saved level is 2 (this page)
                if (savedState.level === 2) {
                    Object.assign(gameState, savedState);
                    
                    updateStatsDisplay();
                    updateInventoryDisplay();
                    loadSection(gameState.currentSection);
                    
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll"><span class="success">Game loaded!</span></div>`;
                } else {
                    document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found for Level 2.</div>`;
                }
            } else {
                document.getElementById('story-text').innerHTML += `<div class="dice-roll">No saved game found.</div>`;
            }
        }
        
        // Utility function to roll dice
        function rollDice(num, sides) {
            let total = 0;
            for (let i = 0; i < num; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Initialize on load
        window.onload = initGame;
        
        // Add click sound to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    playSound('click');
                });
            });
        });
    </script>
</body>
</html>
