<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower of Terror - Ultimate Expansion</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: #000;
            color: #f00;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-x pan-y;
            padding: 5px;
        }
        
        .container {
            max-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 2px solid #f00;
            background-color: #000;
            padding: 8px;
            gap: 8px;
        }
        
        .header {
            text-align: center;
            padding: 8px 5px;
            border-bottom: 1px dashed #f00;
            flex-shrink: 0;
        }
        
        .game-title {
            font-size: 1.8rem;
            color: #f00;
            text-shadow: 0 0 5px #f00;
            margin-bottom: 5px;
        }
        
        .level-title {
            font-size: 1.2rem;
            color: #f00;
        }
        
        .screen {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #f00;
            padding: 12px;
            background-color: #111;
            font-size: 1.3rem;
            line-height: 1.6;
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .screen::-webkit-scrollbar {
            width: 8px;
        }
        
        .screen::-webkit-scrollbar-thumb {
            background-color: #f00;
        }
        
        .output-text {
            margin-bottom: 10px;
            animation: typing 0.05s steps(1, end);
            word-wrap: break-word;
        }
        
        .enemy-text {
            color: #ff5555;
        }
        
        .combat-text {
            color: #ff3333;
            font-weight: bold;
        }
        
        .damage-text {
            color: #ff0000;
            text-shadow: 0 0 3px #ff0000;
        }
        
        .heal-text {
            color: #55ff55;
        }
        
        .loot-text {
            color: #ffaa00;
        }
        
        .player-text {
            color: #ff8888;
        }
        
        .important-text {
            color: #ff0;
            font-weight: bold;
        }
        
        .danger-text {
            color: #f00;
        }
        
        .success-text {
            color: #0f0;
        }
        
        .gold-text {
            color: #ffd700;
            text-shadow: 0 0 3px #ffd700;
        }
        
        .npc-text {
            color: #00aaff;
        }
        
        .merchant-text {
            color: #ff8800;
        }
        
        .mystic-text {
            color: #aa00ff;
        }
        
        .secret-text {
            color: #ff00ff;
            text-shadow: 0 0 3px #ff00ff;
        }
        
        .poison-text {
            color: #00ff00;
        }
        
        .action-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .action-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .action-choices {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .button {
            background-color: #000;
            color: #f00;
            border: 1px solid #f00;
            padding: 14px 8px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        .button:active {
            background-color: #f00;
            color: #000;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }
        
        .command-button {
            background-color: #000;
            color: #f00;
            border: 1px solid #f00;
            padding: 14px 5px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .command-button:active {
            background-color: #f00;
            color: #000;
        }
        
        .combat-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .combat-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .combat-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .combat-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #f00;
            background-color: #000;
            font-size: 1.1rem;
        }
        
        .player-stats, .enemy-stats {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-bar {
            width: 100px;
            height: 10px;
            background-color: #222;
            margin: 2px 0;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            background-color: #f00;
            width: 100%;
        }
        
        .mana-bar {
            height: 100%;
            background-color: #00f;
            width: 100%;
        }
        
        .inventory-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
        }
        
        .inventory-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .inventory-item {
            border: 1px dashed #f00;
            padding: 8px 10px;
            font-size: 1.1rem;
            min-width: 100px;
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-top: 1px dashed #f00;
            flex-shrink: 0;
            font-size: 1rem;
        }
        
        .equipment-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
            margin-top: 8px;
        }
        
        .equipment-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .equipment-slot {
            border: 1px dashed #f00;
            padding: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .map-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
            margin-top: 8px;
        }
        
        .map-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .map-display {
            font-family: monospace;
            white-space: pre;
            font-size: 0.9rem;
            line-height: 1.2;
            background-color: #000;
            padding: 10px;
            border: 1px dashed #f00;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes typing {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-height: 700px) {
            .button, .command-button {
                padding: 10px 5px;
                font-size: 1.1rem;
                min-height: 40px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .level-title {
                font-size: 1rem;
            }
            
            .screen {
                font-size: 1.2rem;
            }
        }
        
        @media (max-height: 600px) {
            .screen {
                font-size: 1.1rem;
                padding: 8px;
            }
            
            .button, .command-button {
                padding: 8px 4px;
                min-height: 36px;
                font-size: 1rem;
            }
        }
        
        .conversation-log {
            border-top: 1px dashed #f00;
            margin-top: 10px;
            padding-top: 10px;
        }
        
        .conversation-title {
            color: #f00;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .shop-panel {
            display: none;
            border: 1px solid #f00;
            padding: 10px;
            background-color: #111;
            flex-shrink: 0;
            margin-top: 8px;
        }
        
        .shop-title {
            color: #f00;
            margin-bottom: 10px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .shop-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .shop-item {
            border: 1px dashed #f00;
            padding: 8px 10px;
            font-size: 1.1rem;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
        }
        
        .shop-item:active {
            background-color: #f00;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">TOWER OF TERROR - ULTIMATE</div>
            <div class="level-title" id="levelTitle">FLOOR 1 - ENTRANCE HALL</div>
        </div>
        
        <div class="screen" id="gameScreen">
            <div class="output-text">TOWER OF TERROR - Ultimate Expansion</div>
            <div class="output-text">Copyright (C) 1985 Shadowbyte Games</div>
            <div class="output-text">Loading game data... OK</div>
            <div class="output-text">Loading 50+ rooms... OK</div>
            <div class="output-text">Loading expanded combat system... OK</div>
            <div class="output-text">Initializing auto-scroll... OK</div>
            <div class="output-text">----------------------------------------</div>
            <div class="output-text" id="currentOutput">You stand before the TOWER OF TERROR, a monolithic structure piercing the blood-red sky. The entrance hall is vast and echoes with distant screams. Cold wind howls from within, carrying whispers of forgotten souls. A rusty sign reads: "Abandon all hope, ye who enter." To the north, a massive stone staircase leads upward. To the east, a corridor disappears into darkness. To the west, a heavy wooden door stands slightly ajar.</div>
        </div>
        
        <!-- Action Panel for choices -->
        <div class="action-panel" id="actionPanel">
            <div class="action-title" id="actionTitle">Select Action</div>
            <div class="action-choices" id="actionChoices">
                <!-- Dynamic buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Combat Panel -->
        <div class="combat-panel" id="combatPanel">
            <div class="combat-title" id="combatTitle">COMBAT</div>
            <div class="combat-info" id="combatInfo">
                <div class="player-stats">
                    <div>YOU</div>
                    <div>HP: <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                    <div class="stat-bar">
                        <div class="health-bar" id="playerHealthBar"></div>
                    </div>
                    <div>MP: <span id="playerMP">30</span>/<span id="playerMaxMP">30</span></div>
                    <div class="stat-bar">
                        <div class="mana-bar" id="playerManaBar"></div>
                    </div>
                </div>
                <div class="enemy-stats">
                    <div id="enemyName">ENEMY</div>
                    <div>HP: <span id="enemyHP">50</span>/<span id="enemyMaxHP">50</span></div>
                    <div class="stat-bar">
                        <div class="health-bar" id="enemyHealthBar"></div>
                    </div>
                    <div id="enemyStatus">Status: Normal</div>
                </div>
            </div>
            <div class="combat-choices" id="combatChoices">
                <!-- Dynamic combat buttons will be inserted here -->
            </div>
        </div>
        
        <!-- Shop Panel -->
        <div class="shop-panel" id="shopPanel">
            <div class="shop-title" id="shopTitle">SHOP</div>
            <div class="shop-items" id="shopItems">
                <!-- Shop items will be inserted here -->
            </div>
        </div>
        
        <!-- Main Command Buttons -->
        <div class="command-buttons">
            <button class="command-button" id="lookBtn">LOOK</button>
            <button class="command-button" id="exploreBtn">EXPLORE</button>
            <button class="command-button" id="inventoryBtn">INVENTORY</button>
            <button class="command-button" id="equipmentBtn">EQUIPMENT</button>
            <button class="command-button" id="useBtn">USE ITEM</button>
            <button class="command-button" id="restBtn">REST</button>
            <button class="command-button" id="moveBtn">MOVE</button>
            <button class="command-button" id="talkBtn">TALK</button>
        </div>
        
        <!-- Inventory Panel -->
        <div class="inventory-panel" id="inventoryPanel">
            <div class="inventory-title">INVENTORY</div>
            <div class="inventory-items" id="inventoryItems">
                <div class="inventory-item">Empty</div>
            </div>
        </div>
        
        <!-- Equipment Panel -->
        <div class="equipment-panel" id="equipmentPanel">
            <div class="equipment-title">EQUIPMENT</div>
            <div class="equipment-slots" id="equipmentSlots">
                <!-- Equipment slots will be inserted here -->
            </div>
        </div>
        
        <!-- Map Panel -->
        <div class="map-panel" id="mapPanel">
            <div class="map-title">TOWER MAP</div>
            <div class="map-display" id="mapDisplay">
                <!-- Map will be displayed here -->
            </div>
        </div>
        
        <div class="status-bar">
            <div>Floor: <span id="floorValue">1</span> | Room: <span id="roomValue">Entrance Hall</span></div>
            <div>HP: <span id="healthValue">100</span>/<span id="maxHealthValue">100</span></div>
            <div>MP: <span id="manaValue">30</span>/<span id="maxManaValue">30</span></div>
            <div>Gold: <span class="gold-text" id="goldValue">0</span></div>
            <div>Score: <span id="scoreValue">0</span></div>
        </div>
    </div>

    <script>
        // ============================================
        // MASSIVELY EXPANDED GAME STATE WITH 50+ ROOMS
        // ============================================
        let gameState = {
            currentFloor: 1,
            currentRoom: "entranceHall",
            inCombat: false,
            currentEnemy: null,
            playerTurn: true,
            inventory: ["rusty dagger", "health potion", "torch"],
            equipment: {
                weapon: "rusty dagger",
                armor: null,
                accessory: null,
                shield: null
            },
            score: 0,
            health: 100,
            maxHealth: 100,
            mana: 30,
            maxMana: 30,
            attack: 12,
            defense: 5,
            gold: 0,
            exploredRooms: {},
            floorCleared: false,
            discoveredRooms: {},
            // NPC interactions
            npcInteractions: {
                blacksmith: { talked: false, servicesUsed: [] },
                mystic: { talked: false, servicesUsed: [] },
                merchant: { talked: false, servicesUsed: [] },
                prisoner: { talked: false, questGiven: false },
                alchemist: { talked: false, servicesUsed: [] },
                librarian: { talked: false, servicesUsed: [] },
                armorer: { talked: false, servicesUsed: [] },
                innkeeper: { talked: false, servicesUsed: [] },
                prophet: { talked: false, servicesUsed: [] },
                ghost: { talked: false, servicesUsed: [] }
            },
            // Quest flags
            quests: {
                prisonerFreed: false,
                libraryBookFound: false,
                alchemyIngredients: 0,
                armorerRepaired: false,
                secretPassageFound: false,
                ritualCompleted: false
            },
            // Room connections - 50+ rooms across 8 floors
            roomConnections: {
                // FLOOR 1: ENTRANCE & DUNGEONS (12 rooms)
                entranceHall: { north: "grandStaircase", east: "eastCorridor", west: "westWing", south: null, up: null, down: null },
                grandStaircase: { north: "floor2Landing", east: null, west: null, south: "entranceHall", up: null, down: null },
                eastCorridor: { north: "guardRoom", east: "storageRoom", west: "entranceHall", south: "kitchen", up: null, down: null },
                westWing: { north: "libraryEntrance", east: "entranceHall", west: "study", south: "diningHall", up: null, down: null },
                guardRoom: { north: null, east: "armory", west: null, south: "eastCorridor", up: null, down: "dungeonStairs" },
                storageRoom: { north: null, east: null, west: "eastCorridor", south: null, up: null, down: null },
                kitchen: { north: "eastCorridor", east: null, west: null, south: "pantry", up: null, down: null },
                pantry: { north: "kitchen", east: null, west: null, south: null, up: null, down: null },
                libraryEntrance: { north: "mainLibrary", east: null, west: null, south: "westWing", up: null, down: null },
                study: { north: null, east: "westWing", west: "secretPassage", south: null, up: null, down: null },
                diningHall: { north: "westWing", east: null, west: "servantQuarters", south: null, up: null, down: null },
                servantQuarters: { north: null, east: "diningHall", west: null, south: null, up: null, down: null },
                armory: { north: null, east: null, west: "guardRoom", south: null, up: null, down: null },
                mainLibrary: { north: "archives", east: null, west: null, south: "libraryEntrance", up: null, down: null },
                archives: { north: null, east: null, west: null, south: "mainLibrary", up: null, down: null },
                secretPassage: { north: null, east: "study", west: "hiddenChamber", south: null, up: null, down: null },
                hiddenChamber: { north: null, east: "secretPassage", west: null, south: null, up: null, down: null },
                dungeonStairs: { north: null, east: null, west: null, south: null, up: "guardRoom", down: "dungeonEntrance" },
                
                // FLOOR -1: DUNGEONS (8 rooms)
                dungeonEntrance: { north: "dungeonHall", east: "tortureChamber", west: "prisonCells", south: null, up: "dungeonStairs", down: "lowerDungeon" },
                dungeonHall: { north: "dungeonDepths", east: null, west: null, south: "dungeonEntrance", up: null, down: null },
                tortureChamber: { north: null, east: null, west: "dungeonEntrance", south: null, up: null, down: null },
                prisonCells: { north: "solitaryConfinement", east: "dungeonEntrance", west: null, south: null, up: null, down: null },
                solitaryConfinement: { north: null, east: null, west: null, south: "prisonCells", up: null, down: null },
                dungeonDepths: { north: "ossuary", east: "forgottenTomb", west: "floodedChamber", south: "dungeonHall", up: null, down: null },
                ossuary: { north: null, east: null, west: null, south: "dungeonDepths", up: null, down: null },
                forgottenTomb: { north: null, east: null, west: "dungeonDepths", south: null, up: null, down: null },
                floodedChamber: { north: null, east: "dungeonDepths", west: null, south: null, up: null, down: null },
                lowerDungeon: { north: "abandonedLab", east: null, west: null, south: null, up: "dungeonEntrance", down: "catacombs" },
                
                // FLOOR -2: CATACOMBS (6 rooms)
                catacombs: { north: "ancientCrypt", east: "boneChamber", west: "burialVault", south: "ossuaryHall", up: "lowerDungeon", down: "deepCatacombs" },
                ancientCrypt: { north: null, east: null, west: null, south: "catacombs", up: null, down: null },
                boneChamber: { north: null, east: null, west: "catacombs", south: null, up: null, down: null },
                burialVault: { north: null, east: "catacombs", west: null, south: null, up: null, down: null },
                ossuaryHall: { north: "catacombs", east: null, west: null, south: "ritualChamber", up: null, down: null },
                ritualChamber: { north: "ossuaryHall", east: null, west: null, south: null, up: null, down: null },
                deepCatacombs: { north: "labyrinthEntrance", east: null, west: null, south: null, up: "catacombs", down: null },
                labyrinthEntrance: { north: "minotaurLair", east: "labyrinthEast", west: "labyrinthWest", south: "deepCatacombs", up: null, down: null },
                minotaurLair: { north: null, east: null, west: null, south: "labyrinthEntrance", up: null, down: null },
                
                // FLOOR 2: LIVING QUARTERS (10 rooms)
                floor2Landing: { north: "nobleHall", east: "alchemyLab", west: "blacksmith", south: "grandStaircase", up: "floor3Landing", down: null },
                nobleHall: { north: "throneAntechamber", east: "artGallery", west: "musicRoom", south: "floor2Landing", up: null, down: null },
                alchemyLab: { north: "ingredientStorage", east: "experimentRoom", west: "floor2Landing", south: null, up: null, down: null },
                blacksmith: { north: "forgeRoom", east: "floor2Landing", west: "weaponStorage", south: null, up: null, down: null },
                throneAntechamber: { north: "throneRoom", east: null, west: null, south: "nobleHall", up: null, down: null },
                artGallery: { north: null, east: null, west: "nobleHall", south: null, up: null, down: null },
                musicRoom: { north: null, east: "nobleHall", west: "balcony", south: null, up: null, down: null },
                ingredientStorage: { north: null, east: null, west: null, south: "alchemyLab", up: null, down: null },
                experimentRoom: { north: null, east: null, west: "alchemyLab", south: null, up: null, down: null },
                forgeRoom: { north: null, east: null, west: null, south: "blacksmith", up: null, down: null },
                weaponStorage: { north: null, east: "blacksmith", west: null, south: null, up: null, down: null },
                balcony: { north: null, east: "musicRoom", west: null, south: null, up: null, down: null },
                throneRoom: { north: "royalChambers", east: null, west: null, south: "throneAntechamber", up: null, down: null },
                
                // FLOOR 3: ROYAL QUARTERS (8 rooms)
                floor3Landing: { north: "royalSuite", east: "chapel", west: "observatory", south: null, up: "floor4Landing", down: "floor2Landing" },
                royalSuite: { north: "royalBedroom", east: "dressingRoom", west: "studyRoom", south: "floor3Landing", up: null, down: null },
                chapel: { north: "altarRoom", east: "confessional", west: "floor3Landing", south: null, up: null, down: null },
                observatory: { north: "telescopeRoom", east: "floor3Landing", west: "astralProjection", south: null, up: null, down: null },
                royalBedroom: { north: "secretExit", east: null, west: null, south: "royalSuite", up: null, down: null },
                dressingRoom: { north: null, east: null, west: "royalSuite", south: null, up: null, down: null },
                studyRoom: { north: null, east: "royalSuite", west: null, south: null, up: null, down: null },
                altarRoom: { north: null, east: null, west: null, south: "chapel", up: null, down: null },
                confessional: { north: null, east: null, west: "chapel", south: null, up: null, down: null },
                telescopeRoom: { north: null, east: null, west: null, south: "observatory", up: null, down: null },
                astralProjection: { north: null, east: "observatory", west: null, south: null, up: null, down: null },
                secretExit: { north: "hiddenPassage", east: null, west: null, south: "royalBedroom", up: null, down: null },
                hiddenPassage: { north: "secretLibrary", east: null, west: null, south: "secretExit", up: null, down: null },
                
                // FLOOR 4: WIZARD'S TOWER (6 rooms)
                floor4Landing: { north: "wizardStudy", east: "elementalFire", west: "elementalWater", south: null, up: "floor5Landing", down: "floor3Landing" },
                wizardStudy: { north: "spellLibrary", east: "summoningRoom", west: "potionLab", south: "floor4Landing", up: null, down: null },
                elementalFire: { north: "fireSanctum", east: null, west: "floor4Landing", south: null, up: null, down: null },
                elementalWater: { north: "waterSanctum", east: "floor4Landing", west: null, south: null, up: null, down: null },
                spellLibrary: { north: null, east: null, west: null, south: "wizardStudy", up: null, down: null },
                summoningRoom: { north: null, east: null, west: "wizardStudy", south: null, up: null, down: null },
                potionLab: { north: null, east: "wizardStudy", west: null, south: null, up: null, down: null },
                fireSanctum: { north: null, east: null, west: null, south: "elementalFire", up: null, down: null },
                waterSanctum: { north: null, east: null, west: null, south: "elementalWater", up: null, down: null },
                
                // FLOOR 5: ELEMENTAL PLANES (6 rooms)
                floor5Landing: { north: "earthChamber", east: "airChamber", west: "voidChamber", south: null, up: "rooftop", down: "floor4Landing" },
                earthChamber: { north: "crystalCavern", east: null, west: null, south: "floor5Landing", up: null, down: null },
                airChamber: { north: "cloudSanctum", east: null, west: "floor5Landing", south: null, up: null, down: null },
                voidChamber: { north: "abyssGate", east: "floor5Landing", west: null, south: null, up: null, down: null },
                crystalCavern: { north: null, east: null, west: null, south: "earthChamber", up: null, down: null },
                cloudSanctum: { north: null, east: null, west: null, south: "airChamber", up: null, down: null },
                abyssGate: { north: null, east: null, west: null, south: "voidChamber", up: null, down: null },
                
                // FLOOR 6: ROOFTOP & FINAL BOSS (4 rooms)
                rooftop: { north: "clockTower", east: "gargoylePerch", west: "bellTower", south: "finalArena", up: null, down: "floor5Landing" },
                clockTower: { north: null, east: null, west: null, south: "rooftop", up: null, down: null },
                gargoylePerch: { north: null, east: null, west: "rooftop", south: null, up: null, down: null },
                bellTower: { north: null, east: "rooftop", west: null, south: null, up: null, down: null },
                finalArena: { north: "rooftop", east: null, west: null, south: "towerHeart", up: null, down: null },
                towerHeart: { north: "finalArena", east: null, west: null, south: null, up: null, down: null },
                
                // SECRET LIBRARY (2 rooms)
                secretLibrary: { north: "forbiddenArchive", east: null, west: null, south: "hiddenPassage", up: null, down: null },
                forbiddenArchive: { north: null, east: null, west: null, south: "secretLibrary", up: null, down: null },
                
                // ABANDONED LAB (2 rooms)
                abandonedLab: { north: "experimentHall", east: "containment", west: "researchRoom", south: "lowerDungeon", up: null, down: null },
                experimentHall: { north: null, east: null, west: null, south: "abandonedLab", up: null, down: null },
                containment: { north: null, east: null, west: "abandonedLab", south: null, up: null, down: null },
                researchRoom: { north: null, east: "abandonedLab", west: null, south: null, up: null, down: null },
                
                // LABYRINTH SECTIONS (4 rooms)
                labyrinthEast: { north: "labyrinthCenter", east: "deadEnd1", west: "labyrinthEntrance", south: "labyrinthSouth", up: null, down: null },
                labyrinthWest: { north: "puzzleRoom", east: "labyrinthEntrance", west: "deadEnd2", south: "treasureRoom", up: null, down: null },
                labyrinthCenter: { north: "minotaurAltar", east: null, west: null, south: "labyrinthEast", up: null, down: null },
                minotaurAltar: { north: null, east: null, west: null, south: "labyrinthCenter", up: null, down: null },
                deadEnd1: { north: null, east: null, west: "labyrinthEast", south: null, up: null, down: null },
                deadEnd2: { north: null, east: "labyrinthWest", west: null, south: null, up: null, down: null },
                labyrinthSouth: { north: "labyrinthEast", east: null, west: null, south: "exitPassage", up: null, down: null },
                puzzleRoom: { north: null, east: null, west: null, south: "labyrinthWest", up: null, down: null },
                treasureRoom: { north: "labyrinthWest", east: null, west: null, south: null, up: null, down: null },
                exitPassage: { north: "labyrinthSouth", east: null, west: null, south: "catacombExit", up: null, down: null },
                catacombExit: { north: "exitPassage", east: null, west: null, south: "catacombs", up: null, down: null }
            },
            
            // Room descriptions for all 50+ rooms
            roomDescriptions: {
                // Floor 1
                entranceHall: "You stand in the grand entrance hall. Massive pillars support a ceiling lost in darkness. Flickering torches cast long shadows. To the north, a stone staircase spirals upward. To the east, a corridor disappears into darkness. To the west, a heavy wooden door stands slightly ajar.",
                grandStaircase: "The grand staircase is wide enough for twenty men abreast. The stone steps are worn smooth by centuries of use. Above, the tower continues into darkness. Below, the entrance hall.",
                eastCorridor: "A long corridor stretches east-west. Torches in iron sconces provide flickering light. The air is cold and smells of damp stone.",
                westWing: "The west wing of the tower. Tattered tapestries line the walls, depicting ancient battles. Doors lead in various directions.",
                guardRoom: "An old guard room. Rusted weapons hang on the walls. A trapdoor in the floor leads down to the dungeons.",
                storageRoom: "A cluttered storage room filled with barrels, crates, and discarded equipment. Dust covers everything.",
                kitchen: "A massive kitchen with enormous ovens and cooking pits. The smell of old spices lingers in the air.",
                pantry: "A pantry filled with long-rotted foodstuffs. Rats scurry in the shadows.",
                libraryEntrance: "The entrance to the tower's library. The smell of old parchment and leather fills the air.",
                study: "A scholar's study. Books and scrolls are piled on every surface. A large desk dominates the room.",
                diningHall: "A banquet hall with a table that could seat fifty. Cobwebs hang from the chandeliers.",
                servantQuarters: "Small, sparse rooms that once housed the tower's servants.",
                armory: "Weapons and armor line the walls. Most are rusted, but a few might still be serviceable.",
                mainLibrary: "A vast library filled with thousands of books. Ladders reach to the highest shelves.",
                archives: "The library archives. Special collections and restricted texts are stored here.",
                secretPassage: "A hidden passage behind a bookshelf. Dusty and narrow.",
                hiddenChamber: "A secret chamber hidden behind the study. What secrets does it hold?",
                dungeonStairs: "A steep stone staircase leading down into darkness. The air grows colder.",
                
                // Dungeons
                dungeonEntrance: "The entrance to the tower dungeons. Iron bars and chains line the walls.",
                dungeonHall: "The main dungeon corridor. Prison cells line both sides.",
                tortureChamber: "A room filled with horrific devices. The walls are stained dark.",
                prisonCells: "Rows of empty prison cells. In one, a skeletal figure sits silently.",
                solitaryConfinement: "A pitch-black isolation cell. The air is thick with despair.",
                dungeonDepths: "The deeper levels of the dungeon. The air is cold and damp.",
                ossuary: "A chamber filled with bones. They're stacked neatly in alcoves.",
                forgottenTomb: "An ancient tomb sealed within the dungeon walls.",
                floodedChamber: "Part of the dungeon that has flooded over time. Water drips from the ceiling.",
                lowerDungeon: "The lowest level of the dungeon. Strange sounds echo here.",
                
                // Catacombs
                catacombs: "Ancient catacombs beneath the tower. Bones are embedded in the walls.",
                ancientCrypt: "A crypt for nobility. Stone sarcophagi line the walls.",
                boneChamber: "A chamber where bones are sorted and stored. Morbid artistry covers the walls.",
                burialVault: "A vault containing valuable burial items. Some might still be here.",
                ossuaryHall: "A hall decorated with intricate bone patterns.",
                ritualChamber: "A chamber used for dark rituals. Strange symbols cover the floor.",
                deepCatacombs: "The deepest catacombs. Few have ventured this far.",
                labyrinthEntrance: "The entrance to an ancient labyrinth carved beneath the tower.",
                minotaurLair: "A vast chamber with bones scattered everywhere. Something large lives here.",
                
                // Floor 2
                floor2Landing: "The second floor landing. The air is slightly warmer here.",
                nobleHall: "A grand hall for nobility. Tattered banners hang from the walls.",
                alchemyLab: "An alchemist's laboratory. Strange smells and bubbling sounds fill the air.",
                blacksmith: "A blacksmith's forge. The heat is intense even now.",
                throneAntechamber: "A waiting room for those seeking audience with the tower's master.",
                artGallery: "A gallery filled with portraits whose eyes seem to follow you.",
                musicRoom: "A room filled with musical instruments. They play eerie notes on their own.",
                ingredientStorage: "Shelves filled with jars of strange ingredients.",
                experimentRoom: "A room for dangerous alchemical experiments.",
                forgeRoom: "The blacksmith's main working area. Tools line the walls.",
                weaponStorage: "A room for finished weapons and armor.",
                balcony: "A balcony overlooking the tower grounds. The view is breathtaking and terrifying.",
                throneRoom: "An empty throne room. The throne itself seems to watch you.",
                
                // Floor 3
                floor3Landing: "The third floor landing. Luxurious carpets cover the floor.",
                royalSuite: "Luxurious living quarters fit for royalty.",
                chapel: "A small chapel. The altar is stained with dark substances.",
                observatory: "A room for observing the stars. A large telescope points skyward.",
                royalBedroom: "An opulent bedroom with a massive four-poster bed.",
                dressingRoom: "A room filled with moth-eaten fine clothing.",
                studyRoom: "A private study with comfortable chairs.",
                altarRoom: "The chapel's altar room. The air feels charged.",
                confessional: "A confessional booth. Someone might be listening.",
                telescopeRoom: "The main observatory area. Star charts cover the walls.",
                astralProjection: "A room for meditative and astral practices.",
                secretExit: "A hidden exit from the royal chambers.",
                hiddenPassage: "A secret passageway through the walls.",
                
                // Floor 4
                floor4Landing: "The fourth floor landing. Magical energy crackles in the air.",
                wizardStudy: "A wizard's study. Books float in the air of their own accord.",
                elementalFire: "A chamber filled with magical fire that doesn't consume.",
                elementalWater: "A room where water floats in spheres through the air.",
                spellLibrary: "A library of magical tomes. Some glow with power.",
                summoningRoom: "A circle for summoning otherworldly beings.",
                potionLab: "A laboratory for brewing magical potions.",
                fireSanctum: "The heart of the fire elemental chamber.",
                waterSanctum: "The source of the floating water.",
                
                // Floor 5
                floor5Landing: "The fifth floor landing. Elemental forces war here.",
                earthChamber: "A chamber of living stone and crystal.",
                airChamber: "A room where winds howl constantly.",
                voidChamber: "A place of absolute darkness and silence.",
                crystalCavern: "A cavern of glowing crystals.",
                cloudSanctum: "A room filled with perpetual clouds.",
                abyssGate: "A gateway to somewhere else entirely.",
                
                // Rooftop
                rooftop: "The tower rooftop. Wind howls around you. The view is incredible and terrifying.",
                clockTower: "The tower's clock mechanism. It hasn't told time in centuries.",
                gargoylePerch: "Gargoyles line the edges, watching with stone eyes.",
                bellTower: "A massive bell hangs here. It rings on its own sometimes.",
                finalArena: "An arena for the final confrontation.",
                towerHeart: "The very heart of the tower's power.",
                
                // Secret areas
                secretLibrary: "A hidden library with forbidden knowledge.",
                forbiddenArchive: "The most dangerous books in the tower.",
                abandonedLab: "An abandoned laboratory. Something went wrong here.",
                experimentHall: "A hall for larger experiments.",
                containment: "Containment cells for dangerous creatures.",
                researchRoom: "A research room filled with notes.",
                
                // Labyrinth
                labyrinthEast: "The eastern section of the labyrinth. The walls shift subtly.",
                labyrinthWest: "The western labyrinth. Echoes confuse your sense of direction.",
                labyrinthCenter: "The center of the labyrinth. Something waits here.",
                minotaurAltar: "An altar to the labyrinth's guardian.",
                deadEnd1: "A dead end in the labyrinth.",
                deadEnd2: "Another dead end.",
                labyrinthSouth: "The southern labyrinth section.",
                puzzleRoom: "A room with a puzzle that must be solved.",
                treasureRoom: "A room filled with treasure... and traps.",
                exitPassage: "A passage leading out of the labyrinth.",
                catacombExit: "The exit back to the catacombs."
            },
            
            // Room NPCs
            roomNPCs: {
                prisonCells: "prisoner",
                alchemyLab: "alchemist",
                blacksmith: "blacksmith",
                mainLibrary: "librarian",
                armory: "armorer",
                servantQuarters: "innkeeper",
                chapel: "prophet",
                balcony: "ghost",
                throneRoom: "merchant",
                wizardStudy: "mystic"
            },
            
            // Room loot availability
            roomLootAvailable: {
                armory: true,
                storageRoom: true,
                mainLibrary: true,
                treasureRoom: true,
                burialVault: true,
                secretLibrary: true,
                archives: true,
                ingredientStorage: true,
                weaponStorage: true,
                researchRoom: true
            },
            
            // Special room properties
            roomSpecial: {
                puzzleRoom: { puzzle: "riddle", solved: false },
                ritualChamber: { ritual: "available", completed: false },
                minotaurLair: { boss: "minotaur", defeated: false },
                finalArena: { boss: "towerMaster", defeated: false },
                towerHeart: { final: true, accessible: false }
            },
            
            // Player abilities
            abilities: [
                { name: "Heavy Strike", cost: 0, damageMultiplier: 1.5, description: "A powerful attack that deals 1.5x damage" },
                { name: "Fire Bolt", cost: 8, damageMultiplier: 2.0, description: "Launch a bolt of fire (requires mana)" },
                { name: "Ice Shard", cost: 6, damageMultiplier: 1.8, slowEffect: true, description: "Launch shards of ice that slow the enemy" },
                { name: "Heal", cost: 12, healAmount: 40, description: "Restore 40 health (requires mana)" },
                { name: "Shield Bash", cost: 5, damageMultiplier: 1.2, stunChance: 0.3, description: "Bash with your shield, chance to stun" },
                { name: "Lightning Arc", cost: 15, damageMultiplier: 2.5, description: "Chain lightning that hits multiple enemies" },
                { name: "Poison Strike", cost: 10, damageMultiplier: 1.5, poisonEffect: true, description: "A poisoned attack that deals damage over time" }
            ],
            
            // Additional game state
            keys: {
                dungeonKey: false,
                libraryKey: false,
                armoryKey: false,
                secretKey: false,
                labyrinthKey: false
            },
            
            // Map discovery
            mapRevealed: {
                floor1: false,
                floor2: false,
                floor3: false,
                floor4: false,
                floor5: false,
                dungeon: false,
                catacombs: false,
                secret: false
            }
        };
        
        // Enhanced enemy definitions with more variety
        const enemies = {
            // Floor 1 enemies
            zombie: { name: "Zombie", health: 60, maxHealth: 60, attack: 10, defense: 2, gold: 15, xp: 25, floor: 1 },
            skeleton: { name: "Skeleton Warrior", health: 50, maxHealth: 50, attack: 14, defense: 5, gold: 20, xp: 30, floor: 1 },
            ghoul: { name: "Ghoul", health: 70, maxHealth: 70, attack: 12, defense: 4, gold: 18, xp: 28, floor: 1 },
            giantRat: { name: "Giant Rat", health: 30, maxHealth: 30, attack: 8, defense: 1, gold: 8, xp: 15, floor: 1 },
            spider: { name: "Giant Spider", health: 45, maxHealth: 45, attack: 16, defense: 3, gold: 22, xp: 32, floor: 1, poison: true },
            batSwarm: { name: "Bat Swarm", health: 35, maxHealth: 35, attack: 12, defense: 0, gold: 10, xp: 20, floor: 1 },
            
            // Dungeon enemies
            wraith: { name: "Wraith", health: 80, maxHealth: 80, attack: 22, defense: 8, gold: 35, xp: 50, floor: -1 },
            ghost: { name: "Ghost", health: 65, maxHealth: 65, attack: 25, defense: 4, gold: 32, xp: 48, floor: -1 },
            skeletonMage: { name: "Skeleton Mage", health: 55, maxHealth: 55, attack: 30, defense: 2, gold: 40, xp: 55, floor: -1 },
            zombieBrute: { name: "Zombie Brute", health: 120, maxHealth: 120, attack: 25, defense: 10, gold: 45, xp: 60, floor: -1 },
            
            // Catacomb enemies
            boneGolem: { name: "Bone Golem", health: 150, maxHealth: 150, attack: 35, defense: 15, gold: 80, xp: 100, floor: -2 },
            cryptWight: { name: "Crypt Wight", health: 100, maxHealth: 100, attack: 40, defense: 8, gold: 70, xp: 90, floor: -2 },
            shadowStalker: { name: "Shadow Stalker", health: 90, maxHealth: 90, attack: 45, defense: 5, gold: 75, xp: 95, floor: -2 },
            
            // Floor 2 enemies
            specter: { name: "Specter", health: 90, maxHealth: 90, attack: 28, defense: 10, gold: 50, xp: 70, floor: 2 },
            armoredSkeleton: { name: "Armored Skeleton", health: 110, maxHealth: 110, attack: 32, defense: 20, gold: 60, xp: 80, floor: 2 },
            hauntedArmor: { name: "Haunted Armor", health: 130, maxHealth: 130, attack: 30, defense: 25, gold: 65, xp: 85, floor: 2 },
            
            // Floor 3 enemies
            demon: { name: "Lesser Demon", health: 150, maxHealth: 150, attack: 40, defense: 15, gold: 100, xp: 130, floor: 3 },
            lich: { name: "Lich Apprentice", health: 140, maxHealth: 140, attack: 45, defense: 12, gold: 110, xp: 140, floor: 3 },
            vampire: { name: "Vampire Spawn", health: 160, maxHealth: 160, attack: 38, defense: 18, gold: 120, xp: 150, floor: 3 },
            
            // Floor 4 enemies
            fireElemental: { name: "Fire Elemental", health: 180, maxHealth: 180, attack: 50, defense: 10, gold: 150, xp: 180, floor: 4, fire: true },
            waterElemental: { name: "Water Elemental", health: 200, maxHealth: 200, attack: 45, defense: 15, gold: 155, xp: 185, floor: 4 },
            earthElemental: { name: "Earth Elemental", health: 250, maxHealth: 250, attack: 40, defense: 30, gold: 160, xp: 190, floor: 4 },
            
            // Floor 5 enemies
            airElemental: { name: "Air Elemental", health: 170, maxHealth: 170, attack: 55, defense: 5, gold: 165, xp: 195, floor: 5 },
            voidCreature: { name: "Void Creature", health: 220, maxHealth: 220, attack: 60, defense: 20, gold: 180, xp: 210, floor: 5 },
            chaosBeast: { name: "Chaos Beast", health: 300, maxHealth: 300, attack: 65, defense: 25, gold: 200, xp: 250, floor: 5 },
            
            // Boss enemies
            minotaur: { name: "Minotaur", health: 500, maxHealth: 500, attack: 70, defense: 40, gold: 500, xp: 500, floor: -2, boss: true },
            demonLord: { name: "Demon Lord", health: 800, maxHealth: 800, attack: 90, defense: 50, gold: 1000, xp: 1000, floor: 5, boss: true },
            towerMaster: { name: "Tower Master", health: 1000, maxHealth: 1000, attack: 100, defense: 60, gold: 1500, xp: 1500, floor: 6, boss: true }
        };
        
        // Enhanced equipment definitions
        const equipmentItems = {
            // Weapons (Tier 1-5)
            "rusty dagger": { type: "weapon", attack: 3, value: 5, tier: 1 },
            "iron sword": { type: "weapon", attack: 8, value: 20, tier: 1 },
            "steel sword": { type: "weapon", attack: 14, value: 50, tier: 2 },
            "silver sword": { type: "weapon", attack: 18, value: 80, tier: 2, undeadBonus: 5 },
            "enchanted blade": { type: "weapon", attack: 22, value: 150, tier: 3 },
            "demon slayer": { type: "weapon", attack: 30, value: 300, tier: 4, demonBonus: 10 },
            "dragonscale sword": { type: "weapon", attack: 35, value: 400, tier: 4 },
            "great axe": { type: "weapon", attack: 25, defense: -2, value: 120, tier: 3 },
            "war hammer": { type: "weapon", attack: 20, stunChance: 0.1, value: 100, tier: 3 },
            "shadow dagger": { type: "weapon", attack: 18, criticalChance: 0.15, value: 180, tier: 3 },
            "firebrand": { type: "weapon", attack: 28, fireDamage: 5, value: 250, tier: 4 },
            "frostblade": { type: "weapon", attack: 26, iceDamage: 5, slowEffect: 0.1, value: 260, tier: 4 },
            "staff of magic": { type: "weapon", attack: 15, manaBonus: 20, value: 200, tier: 3 },
            "minotaur axe": { type: "weapon", attack: 40, value: 500, tier: 5 },
            "tower master's blade": { type: "weapon", attack: 50, value: 1000, tier: 5 },
            
            // Armor
            "leather armor": { type: "armor", defense: 4, value: 10, tier: 1 },
            "chainmail": { type: "armor", defense: 9, value: 35, tier: 2 },
            "plate armor": { type: "armor", defense: 15, value: 80, tier: 3 },
            "dragon scale armor": { type: "armor", defense: 22, fireResistance: 0.3, value: 200, tier: 4 },
            "mage robes": { type: "armor", defense: 6, manaBonus: 10, value: 60, tier: 2 },
            "shadow cloak": { type: "armor", defense: 8, dodgeChance: 0.1, value: 120, tier: 3 },
            "knight's plate": { type: "armor", defense: 18, value: 150, tier: 3 },
            "demonhide armor": { type: "armor", defense: 20, poisonResistance: 0.5, value: 220, tier: 4 },
            "elemental mail": { type: "armor", defense: 25, fireResistance: 0.2, iceResistance: 0.2, value: 300, tier: 4 },
            "tower guardian armor": { type: "armor", defense: 30, value: 500, tier: 5 },
            
            // Shields
            "wooden shield": { type: "shield", defense: 3, blockChance: 0.1, value: 15, tier: 1 },
            "iron shield": { type: "shield", defense: 6, blockChance: 0.15, value: 40, tier: 2 },
            "tower shield": { type: "shield", defense: 10, blockChance: 0.2, value: 80, tier: 3 },
            "dragonbone shield": { type: "shield", defense: 14, blockChance: 0.25, fireResistance: 0.2, value: 180, tier: 4 },
            "magic ward": { type: "shield", defense: 12, manaBonus: 15, value: 150, tier: 3 },
            
            // Accessories
            "health amulet": { type: "accessory", healthBonus: 20, value: 50, tier: 2 },
            "mana ring": { type: "accessory", manaBonus: 15, value: 60, tier: 2 },
            "attack bracelet": { type: "accessory", attackBonus: 5, value: 70, tier: 2 },
            "defense ring": { type: "accessory", defenseBonus: 4, value: 65, tier: 2 },
            "lucky charm": { type: "accessory", criticalChance: 0.1, dodgeChance: 0.05, value: 100, tier: 3 },
            "vampire ring": { type: "accessory", lifesteal: 0.1, value: 150, tier: 3 },
            "elemental ward": { type: "accessory", fireResistance: 0.2, iceResistance: 0.2, value: 120, tier: 3 },
            "minotaur horn": { type: "accessory", attackBonus: 10, healthBonus: 50, value: 250, tier: 4 },
            "tower heart": { type: "accessory", healthBonus: 100, manaBonus: 50, value: 500, tier: 5 }
        };
        
        // Enhanced consumable items
        const consumableItems = {
            "health potion": { type: "consumable", healthRestore: 40, value: 15 },
            "mana potion": { type: "consumable", manaRestore: 25, value: 20 },
            "greater health potion": { type: "consumable", healthRestore: 80, value: 35 },
            "greater mana potion": { type: "consumable", manaRestore: 50, value: 40 },
            "elixir": { type: "consumable", healthRestore: 120, manaRestore: 40, value: 80 },
            "antidote": { type: "consumable", curePoison: true, value: 25 },
            "torch": { type: "utility", value: 5 },
            "lockpick": { type: "utility", value: 20 },
            "smoke bomb": { type: "combat", fleeBonus: 0.3, value: 30 },
            "throwing knife": { type: "combat", damage: 15, value: 10 },
            "bomb": { type: "combat", damage: 40, value: 50 },
            "scroll of fireball": { type: "combat", damage: 60, value: 75 },
            "scroll of healing": { type: "consumable", healthRestore: 100, value: 60 },
            "poison vial": { type: "combat", poisonDamage: 20, value: 40 },
            "holy water": { type: "combat", undeadDamage: 50, value: 60 },
            "invisibility potion": { type: "utility", stealthBonus: 0.5, value: 100 }
        };
        
        // Enhanced NPC definitions with complete functionality
        const npcData = {
            blacksmith: {
                name: "Thrain the Blacksmith",
                description: "A muscular dwarf covered in soot and sweat. He works tirelessly at his forge.",
                dialogue: {
                    initial: "Hail, traveler! I am Thrain, master blacksmith. Care to see my wares or need something repaired?",
                    regular: "Back for more, eh? What can Thrain do for you today?",
                    services: [
                        { name: "Buy Weapons", gold: 0, action: "blacksmith_buy" },
                        { name: "Buy Armor", gold: 0, action: "blacksmith_buy_armor" },
                        { name: "Repair Equipment", gold: 20, action: "blacksmith_repair" },
                        { name: "Upgrade Equipment", gold: 50, action: "blacksmith_upgrade" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    weapons: [
                        { name: "iron sword", price: 30, stock: 3 },
                        { name: "steel sword", price: 60, stock: 2 },
                        { name: "war hammer", price: 90, stock: 1 },
                        { name: "wooden shield", price: 15, stock: 3 }
                    ],
                    armor: [
                        { name: "leather armor", price: 25, stock: 3 },
                        { name: "chainmail", price: 50, stock: 2 },
                        { name: "plate armor", price: 100, stock: 1 }
                    ]
                }
            },
            mystic: {
                name: "Elara the Mystic",
                description: "A hooded figure surrounded by bubbling potions and ancient scrolls. Her eyes glow with arcane energy.",
                dialogue: {
                    initial: "Ah, a seeker of knowledge... or perhaps just another lost soul. I am Elara. I deal in potions and arcane artifacts.",
                    regular: "Have you come to peruse my collection?",
                    services: [
                        { name: "Buy Potions", gold: 0, action: "mystic_buy_potions" },
                        { name: "Buy Scrolls", gold: 0, action: "mystic_buy_scrolls" },
                        { name: "Identify Item", gold: 15, action: "mystic_identify" },
                        { name: "Enchant Item", gold: 100, action: "mystic_enchant" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    potions: [
                        { name: "health potion", price: 20, stock: 5 },
                        { name: "mana potion", price: 25, stock: 5 },
                        { name: "greater health potion", price: 40, stock: 3 },
                        { name: "antidote", price: 30, stock: 3 }
                    ],
                    scrolls: [
                        { name: "scroll of fireball", price: 80, stock: 2 },
                        { name: "scroll of healing", price: 65, stock: 2 },
                        { name: "bomb", price: 55, stock: 3 }
                    ]
                }
            },
            merchant: {
                name: "Silas the Merchant",
                description: "A sly-looking man with a calculating gaze. His pack is filled with various goods.",
                dialogue: {
                    initial: "Well met, traveler! I am Silas, purveyor of fine goods. Everything has a price, and I have everything!",
                    regular: "Back for more? My prices are always fair... for me.",
                    services: [
                        { name: "Buy General Goods", gold: 0, action: "merchant_buy" },
                        { name: "Sell Items", gold: 0, action: "merchant_sell" },
                        { name: "Special Deals", gold: 0, action: "merchant_special" },
                        { name: "Rumors", gold: 10, action: "merchant_rumors" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    general: [
                        { name: "torch", price: 5, stock: 10 },
                        { name: "lockpick", price: 25, stock: 5 },
                        { name: "throwing knife", price: 12, stock: 8 },
                        { name: "smoke bomb", price: 35, stock: 4 },
                        { name: "health potion", price: 22, stock: 6 },
                        { name: "mana potion", price: 28, stock: 6 }
                    ],
                    special: [
                        { name: "enchanted blade", price: 180, stock: 1 },
                        { name: "shadow dagger", price: 200, stock: 1 },
                        { name: "lucky charm", price: 110, stock: 2 }
                    ]
                }
            },
            prisoner: {
                name: "The Prisoner",
                description: "A skeletal figure chained to the wall. He looks up as you approach, hollow eye sockets fixed on you.",
                dialogue: {
                    initial: "...You... you're alive? Please... free me... I have information... about the tower...",
                    regular: "Have you found the key? Please... I beg you...",
                    services: [
                        { name: "Ask about the tower", gold: 0, action: "prisoner_info" },
                        { name: "Ask about the key", gold: 0, action: "prisoner_key" },
                        { name: "Try to free him", gold: 0, action: "prisoner_free" },
                        { name: "Leave him", gold: 0, action: "goodbye" }
                    ]
                }
            },
            alchemist: {
                name: "Mori the Alchemist",
                description: "An elderly woman surrounded by bubbling beakers and strange apparatus.",
                dialogue: {
                    initial: "Ah, a visitor! Careful not to touch anything. I am Mori, master alchemist of this tower.",
                    regular: "Back for more potions? Or perhaps you've found interesting ingredients?",
                    services: [
                        { name: "Buy Potions", gold: 0, action: "alchemist_buy" },
                        { name: "Sell Ingredients", gold: 0, action: "alchemist_sell" },
                        { name: "Brew Custom Potion", gold: 50, action: "alchemist_brew" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    potions: [
                        { name: "health potion", price: 18, stock: 6 },
                        { name: "mana potion", price: 22, stock: 6 },
                        { name: "greater health potion", price: 38, stock: 3 },
                        { name: "greater mana potion", price: 45, stock: 3 },
                        { name: "elixir", price: 85, stock: 2 },
                        { name: "antidote", price: 28, stock: 4 }
                    ]
                }
            },
            librarian: {
                name: "Orin the Librarian",
                description: "A thin man with spectacles, surrounded by towering stacks of books.",
                dialogue: {
                    initial: "Shhh! This is a library! I am Orin, keeper of knowledge. What do you seek?",
                    regular: "Have you come to study or to borrow?",
                    services: [
                        { name: "Research Tower History", gold: 0, action: "librarian_research" },
                        { name: "Borrow Spellbook", gold: 25, action: "librarian_borrow" },
                        { name: "Ask About Secrets", gold: 15, action: "librarian_secrets" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                }
            },
            armorer: {
                name: "Gareth the Armorer",
                description: "A burly man polishing a breastplate. His arms are covered in scars.",
                dialogue: {
                    initial: "Hail! I'm Gareth. If you need armor, you've come to the right place.",
                    regular: "Back for more protection, eh?",
                    services: [
                        { name: "Buy Armor", gold: 0, action: "armorer_buy" },
                        { name: "Repair Armor", gold: 15, action: "armorer_repair" },
                        { name: "Enhance Armor", gold: 75, action: "armorer_enhance" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    armor: [
                        { name: "leather armor", price: 30, stock: 3 },
                        { name: "chainmail", price: 55, stock: 2 },
                        { name: "plate armor", price: 110, stock: 1 },
                        { name: "iron shield", price: 45, stock: 2 },
                        { name: "tower shield", price: 90, stock: 1 }
                    ]
                }
            },
            innkeeper: {
                name: "Bella the Innkeeper",
                description: "A friendly-looking woman who seems oddly out of place in this tower.",
                dialogue: {
                    initial: "Oh my! A living soul! I'm Bella. This used to be a proper inn, you know.",
                    regular: "Back for some rest and relaxation?",
                    services: [
                        { name: "Rest (Heal)", gold: 10, action: "innkeeper_rest" },
                        { name: "Buy Food", gold: 0, action: "innkeeper_food" },
                        { name: "Hear Gossip", gold: 5, action: "innkeeper_gossip" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                },
                shopItems: {
                    food: [
                        { name: "health potion", price: 25, stock: 3, desc: "Restores 40 health" },
                        { name: "torch", price: 8, stock: 5, desc: "Lights dark areas" }
                    ]
                }
            },
            prophet: {
                name: "The Prophet",
                description: "A blindfolded figure kneeling before the altar. He seems to know you're there without looking.",
                dialogue: {
                    initial: "I have foreseen your coming. The tower has awaited one such as you.",
                    regular: "Have you come for guidance or prophecy?",
                    services: [
                        { name: "Seek Prophecy", gold: 0, action: "prophet_prophecy" },
                        { name: "Ask About Future", gold: 25, action: "prophet_future" },
                        { name: "Request Blessing", gold: 50, action: "prophet_bless" },
                        { name: "Goodbye", gold: 0, action: "goodbye" }
                    ]
                }
            },
            ghost: {
                name: "The Weeping Ghost",
                description: "A translucent figure weeping at the balcony's edge. She doesn't seem to notice you.",
                dialogue: {
                    initial: "...Why... why did he leave me here?...",
                    regular: "...The view was so beautiful once...",
                    services: [
                        { name: "Ask Who She Is", gold: 0, action: "ghost_who" },
                        { name: "Ask About The View", gold: 0, action: "ghost_view" },
                        { name: "Offer Help", gold: 0, action: "ghost_help" },
                        { name: "Leave Her", gold: 0, action: "goodbye" }
                    ]
                }
            }
        };
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        const gameScreen = document.getElementById('gameScreen');
        const actionPanel = document.getElementById('actionPanel');
        const actionTitle = document.getElementById('actionTitle');
        const actionChoices = document.getElementById('actionChoices');
        const combatPanel = document.getElementById('combatPanel');
        const combatTitle = document.getElementById('combatTitle');
        const combatInfo = document.getElementById('combatInfo');
        const combatChoices = document.getElementById('combatChoices');
        const shopPanel = document.getElementById('shopPanel');
        const shopTitle = document.getElementById('shopTitle');
        const shopItems = document.getElementById('shopItems');
        const inventoryPanel = document.getElementById('inventoryPanel');
        const inventoryItems = document.getElementById('inventoryItems');
        const equipmentPanel = document.getElementById('equipmentPanel');
        const equipmentSlots = document.getElementById('equipmentSlots');
        const mapPanel = document.getElementById('mapPanel');
        const mapDisplay = document.getElementById('mapDisplay');
        const healthValue = document.getElementById('healthValue');
        const maxHealthValue = document.getElementById('maxHealthValue');
        const manaValue = document.getElementById('manaValue');
        const maxManaValue = document.getElementById('maxManaValue');
        const scoreValue = document.getElementById('scoreValue');
        const goldValue = document.getElementById('goldValue');
        const floorValue = document.getElementById('floorValue');
        const roomValue = document.getElementById('roomValue');
        const levelTitle = document.getElementById('levelTitle');
        
        // Combat UI elements
        const playerHP = document.getElementById('playerHP');
        const playerMaxHP = document.getElementById('playerMaxHP');
        const playerMP = document.getElementById('playerMP');
        const playerMaxMP = document.getElementById('playerMaxMP');
        const enemyName = document.getElementById('enemyName');
        const enemyHP = document.getElementById('enemyHP');
        const enemyMaxHP = document.getElementById('enemyMaxHP');
        const playerHealthBar = document.getElementById('playerHealthBar');
        const playerManaBar = document.getElementById('playerManaBar');
        const enemyHealthBar = document.getElementById('enemyHealthBar');
        
        // ============================================
        // AUTO-SCROLL FUNCTIONALITY
        // ============================================
        function autoScrollToBottom() {
            setTimeout(() => {
                gameScreen.scrollTop = gameScreen.scrollHeight;
            }, 50);
        }
        
        // ============================================
        // MAP SYSTEM
        // ============================================
        function generateMap() {
            let map = "";
            const currentRoom = gameState.currentRoom;
            
            // Determine which floor we're on
            let floorRooms = [];
            let floorName = "";
            
            // Floor categorization
            if (gameState.currentFloor === 1) {
                floorName = "FLOOR 1 - ENTRANCE LEVEL";
                floorRooms = [
                    "entranceHall", "grandStaircase", "eastCorridor", "westWing",
                    "guardRoom", "storageRoom", "kitchen", "pantry",
                    "libraryEntrance", "study", "diningHall", "servantQuarters",
                    "armory", "mainLibrary", "archives", "secretPassage", "hiddenChamber"
                ];
            } else if (gameState.currentFloor === -1) {
                floorName = "FLOOR -1 - DUNGEONS";
                floorRooms = [
                    "dungeonEntrance", "dungeonHall", "tortureChamber", "prisonCells",
                    "solitaryConfinement", "dungeonDepths", "ossuary", "forgottenTomb",
                    "floodedChamber", "lowerDungeon"
                ];
            } else if (gameState.currentFloor === -2) {
                floorName = "FLOOR -2 - CATACOMBS";
                floorRooms = [
                    "catacombs", "ancientCrypt", "boneChamber", "burialVault",
                    "ossuaryHall", "ritualChamber", "deepCatacombs", "labyrinthEntrance",
                    "minotaurLair"
                ];
            } else if (gameState.currentFloor === 2) {
                floorName = "FLOOR 2 - LIVING QUARTERS";
                floorRooms = [
                    "floor2Landing", "nobleHall", "alchemyLab", "blacksmith",
                    "throneAntechamber", "artGallery", "musicRoom", "ingredientStorage",
                    "experimentRoom", "forgeRoom", "weaponStorage", "balcony",
                    "throneRoom"
                ];
            } else if (gameState.currentFloor === 3) {
                floorName = "FLOOR 3 - ROYAL QUARTERS";
                floorRooms = [
                    "floor3Landing", "royalSuite", "chapel", "observatory",
                    "royalBedroom", "dressingRoom", "studyRoom", "altarRoom",
                    "confessional", "telescopeRoom", "astralProjection", "secretExit",
                    "hiddenPassage"
                ];
            } else if (gameState.currentFloor === 4) {
                floorName = "FLOOR 4 - WIZARD'S TOWER";
                floorRooms = [
                    "floor4Landing", "wizardStudy", "elementalFire", "elementalWater",
                    "spellLibrary", "summoningRoom", "potionLab", "fireSanctum",
                    "waterSanctum"
                ];
            } else if (gameState.currentFloor === 5) {
                floorName = "FLOOR 5 - ELEMENTAL PLANES";
                floorRooms = [
                    "floor5Landing", "earthChamber", "airChamber", "voidChamber",
                    "crystalCavern", "cloudSanctum", "abyssGate"
                ];
            } else if (gameState.currentFloor === 6) {
                floorName = "FLOOR 6 - ROOFTOP";
                floorRooms = [
                    "rooftop", "clockTower", "gargoylePerch", "bellTower",
                    "finalArena", "towerHeart"
                ];
            }
            
            map += `=== ${floorName} ===\n`;
            map += `Current Room: ${currentRoom}\n`;
            map += "\n";
            
            // Create a simple grid representation
            for (let room of floorRooms) {
                if (gameState.exploredRooms[room] || room === currentRoom) {
                    const roomName = room.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    const marker = room === currentRoom ? "" : "";
                    map += `${marker} ${roomName}\n`;
                    
                    // Show exits if current room
                    if (room === currentRoom) {
                        const exits = [];
                        const conn = gameState.roomConnections[room];
                        if (conn.north) exits.push("North");
                        if (conn.east) exits.push("East");
                        if (conn.south) exits.push("South");
                        if (conn.west) exits.push("West");
                        if (conn.up) exits.push("Up");
                        if (conn.down) exits.push("Down");
                        
                        if (exits.length > 0) {
                            map += `  Exits: ${exits.join(", ")}\n`;
                        }
                    }
                }
            }
            
            // Add discovered secret rooms
            if (gameState.exploredRooms["secretLibrary"]) {
                map += "\n=== SECRET AREAS ===\n";
                map += " Secret Library\n";
                if (gameState.exploredRooms["forbiddenArchive"]) {
                    map += " Forbidden Archive\n";
                }
            }
            
            if (gameState.exploredRooms["abandonedLab"]) {
                map += "\n Abandoned Laboratory\n";
            }
            
            return map;
        }
        
        function showMap() {
            mapDisplay.textContent = generateMap();
            mapPanel.style.display = "block";
            autoScrollToBottom();
        }
        
        function hideMap() {
            mapPanel.style.display = "none";
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        function initGame() {
            updateStatus();
            addToOutput("Touch commands to play. Goal: Reach the tower's heart on Floor 6.", "important-text");
            addToOutput("Tip: Explore every room thoroughly. Many secrets await discovery.", "secret-text");
            addToOutput("NEW: Type 'map' to see discovered rooms on current floor.", "important-text");
            setupEventListeners();
            updateEquipmentDisplay();
            autoScrollToBottom();
            
            // Initialize discovered rooms
            gameState.discoveredRooms[gameState.currentRoom] = true;
        }
        
        // Set up event listeners for buttons
        function setupEventListeners() {
            // Command buttons
            document.getElementById('lookBtn').addEventListener('click', handleLook);
            document.getElementById('exploreBtn').addEventListener('click', handleExplore);
            document.getElementById('inventoryBtn').addEventListener('click', handleInventory);
            document.getElementById('equipmentBtn').addEventListener('click', handleEquipment);
            document.getElementById('useBtn').addEventListener('click', handleUseItem);
            document.getElementById('restBtn').addEventListener('click', handleRest);
            document.getElementById('moveBtn').addEventListener('click', handleMove);
            document.getElementById('talkBtn').addEventListener('click', handleTalk);
            
            // Add map command via keyboard
            document.addEventListener('keydown', function(e) {
                if (e.key === 'm' || e.key === 'M') {
                    if (mapPanel.style.display === "block") {
                        hideMap();
                    } else {
                        showMap();
                    }
                }
            });
        }
        
        // ============================================
        // ENHANCED OUTPUT FUNCTION WITH AUTO-SCROLL
        // ============================================
        function addToOutput(text, className = "") {
            const newLine = document.createElement("div");
            newLine.className = `output-text ${className}`;
            newLine.textContent = text;
            gameScreen.appendChild(newLine);
            
            autoScrollToBottom();
        }
        
        function addConversation(speaker, text, npcType = "npc") {
            let speakerName, speakerClass;
            
            switch(npcType) {
                case "player":
                    speakerName = "You";
                    speakerClass = "player-text";
                    break;
                case "blacksmith":
                    speakerName = "Thrain";
                    speakerClass = "npc-text";
                    break;
                case "mystic":
                    speakerName = "Elara";
                    speakerClass = "mystic-text";
                    break;
                case "merchant":
                    speakerName = "Silas";
                    speakerClass = "merchant-text";
                    break;
                case "prisoner":
                    speakerName = "Prisoner";
                    speakerClass = "npc-text";
                    break;
                case "alchemist":
                    speakerName = "Mori";
                    speakerClass = "npc-text";
                    break;
                case "librarian":
                    speakerName = "Orin";
                    speakerClass = "npc-text";
                    break;
                case "armorer":
                    speakerName = "Gareth";
                    speakerClass = "npc-text";
                    break;
                case "innkeeper":
                    speakerName = "Bella";
                    speakerClass = "npc-text";
                    break;
                case "prophet":
                    speakerName = "Prophet";
                    speakerClass = "npc-text";
                    break;
                case "ghost":
                    speakerName = "Ghost";
                    speakerClass = "npc-text";
                    break;
                default:
                    speakerName = speaker;
                    speakerClass = "npc-text";
            }
            
            addToOutput(`${speakerName}: ${text}`, speakerClass);
            autoScrollToBottom();
        }
        
        // ============================================
        // STATUS & UI UPDATES
        // ============================================
        function updateStatus() {
            healthValue.textContent = gameState.health;
            maxHealthValue.textContent = gameState.maxHealth;
            manaValue.textContent = gameState.mana;
            maxManaValue.textContent = gameState.maxMana;
            scoreValue.textContent = gameState.score;
            goldValue.textContent = gameState.gold;
            floorValue.textContent = gameState.currentFloor;
            
            // Update room name display
            const roomName = gameState.currentRoom.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            roomValue.textContent = roomName;
            
            // Update location display
            levelTitle.textContent = `FLOOR ${gameState.currentFloor} - ${roomName.toUpperCase()}`;
            
            // Update combat UI if in combat
            if (gameState.inCombat) {
                updateCombatUI();
            }
        }
        
        function updateCombatUI() {
            playerHP.textContent = gameState.health;
            playerMaxHP.textContent = gameState.maxHealth;
            playerMP.textContent = gameState.mana;
            playerMaxMP.textContent = gameState.maxMana;
            
            // Update health bars
            const playerHealthPercent = (gameState.health / gameState.maxHealth) * 100;
            playerHealthBar.style.width = `${playerHealthPercent}%`;
            
            const playerManaPercent = (gameState.mana / gameState.maxMana) * 100;
            playerManaBar.style.width = `${playerManaPercent}%`;
            
            if (gameState.currentEnemy) {
                enemyName.textContent = gameState.currentEnemy.name;
                enemyHP.textContent = gameState.currentEnemy.health;
                enemyMaxHP.textContent = gameState.currentEnemy.maxHealth;
                
                const enemyHealthPercent = (gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100;
                enemyHealthBar.style.width = `${enemyHealthPercent}%`;
            }
        }
        
        // ============================================
        // PANEL MANAGEMENT
        // ============================================
        function showActionPanel(title, choices, callback) {
            actionTitle.textContent = title;
            actionChoices.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'button';
                button.textContent = choice.text;
                button.addEventListener('click', () => {
                    hideActionPanel();
                    callback(choice.value, choice.text);
                    autoScrollToBottom();
                });
                actionChoices.appendChild(button);
            });
            
            actionPanel.style.display = 'block';
            autoScrollToBottom();
        }
        
        function hideActionPanel() {
            actionPanel.style.display = 'none';
        }
        
        function showCombatPanel() {
            updateCombatUI();
            updateCombatChoices();
            combatPanel.style.display = 'block';
            autoScrollToBottom();
        }
        
        function hideCombatPanel() {
            combatPanel.style.display = 'none';
        }
        
        function showShopPanel(title, items, shopType, npcType) {
            shopTitle.textContent = title;
            shopItems.innerHTML = '';
            
            if (items.length === 0) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "shop-item";
                emptyItem.textContent = "Nothing for sale";
                shopItems.appendChild(emptyItem);
            } else {
                items.forEach(item => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "shop-item";
                    itemElement.innerHTML = `<strong>${item.name.toUpperCase()}</strong><br>${item.price} gold`;
                    
                    if (item.desc) {
                        itemElement.innerHTML += `<br><small>${item.desc}</small>`;
                    }
                    
                    itemElement.addEventListener('click', () => {
                        buyItem(item.name, item.price, shopType, npcType);
                    });
                    shopItems.appendChild(itemElement);
                });
            }
            
            const cancelButton = document.createElement("div");
            cancelButton.className = "shop-item";
            cancelButton.innerHTML = `<strong>CANCEL</strong>`;
            cancelButton.addEventListener('click', hideShopPanel);
            shopItems.appendChild(cancelButton);
            
            shopPanel.style.display = 'block';
            autoScrollToBottom();
        }
        
        function hideShopPanel() {
            shopPanel.style.display = 'none';
        }
        
        // ============================================
        // EXPANDED COMBAT SYSTEM
        // ============================================
        function updateCombatChoices() {
            combatChoices.innerHTML = '';
            
            // Basic attack
            const attackButton = document.createElement('button');
            attackButton.className = 'button';
            attackButton.textContent = 'ATTACK';
            attackButton.addEventListener('click', () => {
                playerAttack('normal');
                autoScrollToBottom();
            });
            combatChoices.appendChild(attackButton);
            
            // Abilities
            gameState.abilities.forEach(ability => {
                const abilityButton = document.createElement('button');
                abilityButton.className = 'button';
                abilityButton.textContent = ability.name;
                
                // Disable if not enough mana
                if (ability.cost > gameState.mana) {
                    abilityButton.disabled = true;
                    abilityButton.style.opacity = '0.5';
                }
                
                abilityButton.addEventListener('click', () => {
                    if (ability.name === "Heal") {
                        playerHeal(ability);
                    } else {
                        playerAttack(ability.name.toLowerCase());
                    }
                    autoScrollToBottom();
                });
                combatChoices.appendChild(abilityButton);
            });
            
            // Item button
            const itemButton = document.createElement('button');
            itemButton.className = 'button';
            itemButton.textContent = 'USE ITEM';
            itemButton.addEventListener('click', () => {
                showCombatItems();
                autoScrollToBottom();
            });
            combatChoices.appendChild(itemButton);
            
            // Flee button
            const fleeButton = document.createElement('button');
            fleeButton.className = 'button';
            fleeButton.textContent = 'FLEE';
            fleeButton.addEventListener('click', () => {
                attemptFlee();
                autoScrollToBottom();
            });
            combatChoices.appendChild(fleeButton);
        }
        
        // ============================================
        // EXPANDED GAME COMMANDS
        // ============================================
        function handleLook() {
            if (gameState.inCombat) {
                addToOutput("You're in combat! Focus on the enemy!", "combat-text");
                return;
            }
            
            const roomDesc = gameState.roomDescriptions[gameState.currentRoom];
            addToOutput(roomDesc);
            
            // Check for special room features
            if (gameState.roomSpecial[gameState.currentRoom]) {
                const special = gameState.roomSpecial[gameState.currentRoom];
                if (special.puzzle && !special.solved) {
                    addToOutput("There's a puzzle here that needs solving.", "important-text");
                }
                if (special.boss && !special.defeated) {
                    addToOutput("A powerful presence waits here...", "danger-text");
                }
            }
            
            // Check if there's an NPC in the room
            if (gameState.roomNPCs[gameState.currentRoom]) {
                const npcType = gameState.roomNPCs[gameState.currentRoom];
                const npc = npcData[npcType];
                addToOutput(`You see ${npc.name} here. ${npc.description}`, "npc-text");
            }
            
            // Check for special exits
            const connections = gameState.roomConnections[gameState.currentRoom];
            if (connections.up) {
                addToOutput("There's a way up from here.", "important-text");
            }
            if (connections.down) {
                addToOutput("There's a way down from here.", "important-text");
            }
            
            autoScrollToBottom();
        }
        
        function handleExplore() {
            if (gameState.inCombat) {
                addToOutput("You're in combat! You can't explore now!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (gameState.exploredRooms[gameState.currentRoom]) {
                addToOutput("You've already explored this room thoroughly.");
                autoScrollToBottom();
                return;
            }
            
            addToOutput("You carefully explore the area...", "important-text");
            
            // Special room exploration
            if (gameState.roomSpecial[gameState.currentRoom]) {
                exploreSpecialRoom();
                return;
            }
            
            // Determine what happens during exploration
            const explorationRoll = Math.random();
            
            if (explorationRoll < 0.4) {
                // Encounter an enemy
                triggerEnemyEncounter();
            } else if (explorationRoll < 0.7) {
                // Find loot (if room has loot)
                if (gameState.roomLootAvailable[gameState.currentRoom]) {
                    findLoot();
                } else {
                    // Find gold instead
                    const goldFound = Math.floor(Math.random() * 50) + 20;
                    addToOutput(`You find ${goldFound} gold coins!`, "gold-text");
                    gameState.gold += goldFound;
                    updateStatus();
                }
            } else if (explorationRoll < 0.85) {
                // Find a useful item
                const items = ["health potion", "mana potion", "torch", "lockpick", "throwing knife", "antidote"];
                const foundItem = items[Math.floor(Math.random() * items.length)];
                addToOutput(`You find a ${foundItem.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(foundItem);
                updateInventory();
            } else if (explorationRoll < 0.95) {
                // Find a clue or note
                const clues = [
                    "You find a torn page from a journal. It mentions a 'hidden library' somewhere in the tower.",
                    "A cryptic note: 'The minotaur guards more than the labyrinth. His horn holds power.'",
                    "You discover a map fragment showing part of the catacombs.",
                    "A faded inscription: 'Only the pure of heart may reach the tower's heart.'"
                ];
                addToOutput(clues[Math.floor(Math.random() * clues.length)], "secret-text");
            } else {
                // Find a secret passage or trigger special event
                if (Math.random() < 0.3 && !gameState.quests.secretPassageFound) {
                    addToOutput("You discover a hidden passage!", "secret-text");
                    gameState.quests.secretPassageFound = true;
                } else {
                    addToOutput("You explore the area but find nothing of value.");
                }
            }
            
            gameState.exploredRooms[gameState.currentRoom] = true;
            gameState.discoveredRooms[gameState.currentRoom] = true;
            autoScrollToBottom();
        }
        
        function exploreSpecialRoom() {
            const special = gameState.roomSpecial[gameState.currentRoom];
            
            if (special.puzzle && !special.solved) {
                handlePuzzle();
            } else if (special.boss && !special.defeated) {
                triggerBossEncounter(special.boss);
            } else if (special.ritual && !special.completed) {
                handleRitual();
            } else {
                addToOutput("You've already dealt with what was special about this room.");
                gameState.exploredRooms[gameState.currentRoom] = true;
                autoScrollToBottom();
            }
        }
        
        function handlePuzzle() {
            if (gameState.currentRoom === "puzzleRoom") {
                addToOutput("You see a stone pedestal with three symbols: a flame, a drop, and a leaf.", "important-text");
                addToOutput("Above them, an inscription reads: 'I can be cracked, made, told, and played. What am I?'", "important-text");
                
                showActionPanel("SOLVE THE RIDDLE:", [
                    { text: "A JOKE", value: "joke" },
                    { text: "AN EGG", value: "egg" },
                    { text: "A HEART", value: "heart" },
                    { text: "A CODE", value: "code" }
                ], handlePuzzleAnswer);
            }
        }
        
        function handlePuzzleAnswer(answer) {
            if (answer === "joke") {
                addToOutput("The pedestal glows! A hidden compartment opens, revealing treasure!", "success-text");
                gameState.roomSpecial[gameState.currentRoom].solved = true;
                gameState.inventory.push("puzzle key");
                gameState.score += 100;
                updateInventory();
                updateStatus();
            } else {
                addToOutput("Nothing happens. The answer must be something else.", "danger-text");
            }
            autoScrollToBottom();
        }
        
        function handleRitual() {
            addToOutput("The ritual chamber is filled with strange symbols. An altar stands in the center.", "important-text");
            addToOutput("Do you attempt to complete the ritual?", "important-text");
            
            showActionPanel("ATTEMPT THE RITUAL?", [
                { text: "YES, ATTEMPT RITUAL", value: "attempt" },
                { text: "NO, IT'S TOO DANGEROUS", value: "no" }
            ], handleRitualChoice);
        }
        
        function handleRitualChoice(choice) {
            if (choice === "attempt") {
                if (gameState.mana >= 30) {
                    addToOutput("You channel your mana into the ritual...", "important-text");
                    addToOutput("The symbols glow with power! You feel stronger!", "success-text");
                    gameState.roomSpecial[gameState.currentRoom].completed = true;
                    gameState.maxHealth += 50;
                    gameState.maxMana += 30;
                    gameState.health = gameState.maxHealth;
                    gameState.mana = gameState.maxMana;
                    gameState.score += 200;
                    updateStatus();
                } else {
                    addToOutput("You don't have enough mana to attempt the ritual.", "danger-text");
                }
            } else {
                addToOutput("You decide not to risk it.");
            }
            autoScrollToBottom();
        }
        
        // ============================================
        // EXPANDED ENCOUNTER SYSTEM
        // ============================================
        function triggerEnemyEncounter() {
            // Determine enemy based on floor and room
            let enemyPool = [];
            const floor = gameState.currentFloor;
            
            if (floor === 1) {
                enemyPool = ["zombie", "skeleton", "ghoul", "giantRat", "spider", "batSwarm"];
            } else if (floor === -1) {
                enemyPool = ["wraith", "ghost", "skeletonMage", "zombieBrute"];
            } else if (floor === -2) {
                enemyPool = ["boneGolem", "cryptWight", "shadowStalker"];
            } else if (floor === 2) {
                enemyPool = ["specter", "armoredSkeleton", "hauntedArmor"];
            } else if (floor === 3) {
                enemyPool = ["demon", "lich", "vampire"];
            } else if (floor === 4) {
                enemyPool = ["fireElemental", "waterElemental", "earthElemental"];
            } else if (floor === 5) {
                enemyPool = ["airElemental", "voidCreature", "chaosBeast"];
            } else {
                enemyPool = ["zombie", "skeleton", "ghoul"]; // Default
            }
            
            const enemyType = enemyPool[Math.floor(Math.random() * enemyPool.length)];
            createEnemy(enemyType);
        }
        
        function triggerBossEncounter(bossType) {
            if (bossType === "minotaur") {
                createEnemy("minotaur");
            } else if (bossType === "towerMaster") {
                createEnemy("towerMaster");
            } else {
                createEnemy("demonLord");
            }
        }
        
        function createEnemy(enemyType) {
            const enemyTemplate = enemies[enemyType];
            gameState.currentEnemy = {
                name: enemyTemplate.name,
                health: enemyTemplate.health,
                maxHealth: enemyTemplate.maxHealth,
                attack: enemyTemplate.attack,
                defense: enemyTemplate.defense,
                gold: enemyTemplate.gold,
                xp: enemyTemplate.xp,
                boss: enemyTemplate.boss || false,
                special: enemyTemplate
            };
            
            if (enemyTemplate.boss) {
                addToOutput(`THE ${gameState.currentEnemy.name.toUpperCase()} APPEARS!`, "combat-text");
                addToOutput("BOSS BATTLE!", "danger-text");
            } else {
                addToOutput(`A ${gameState.currentEnemy.name} appears!`, "enemy-text");
                addToOutput("COMBAT INITIATED!", "combat-text");
            }
            
            gameState.inCombat = true;
            gameState.playerTurn = true;
            
            showCombatPanel();
            autoScrollToBottom();
        }
        
        // ============================================
        // EXPANDED LOOT SYSTEM
        // ============================================
        function findLoot() {
            let lootPool = [];
            const room = gameState.currentRoom;
            const floor = gameState.currentFloor;
            
            // Different loot based on room type and floor
            if (room.includes("armory") || room.includes("weapon")) {
                lootPool = ["iron sword", "steel sword", "chainmail", "plate armor", "wooden shield", "iron shield"];
            } else if (room.includes("library") || room.includes("archive")) {
                lootPool = ["scroll of fireball", "scroll of healing", "mana ring", "attack bracelet", "defense ring"];
            } else if (room.includes("treasure") || room.includes("vault")) {
                lootPool = ["gold", "enchanted blade", "shadow dagger", "lucky charm", "elixir"];
            } else if (room.includes("lab") || room.includes("alchemy")) {
                lootPool = ["health potion", "mana potion", "greater health potion", "greater mana potion", "antidote"];
            } else {
                // General loot based on floor
                if (floor === 1) {
                    lootPool = ["health potion", "torch", "rusty dagger", "leather armor"];
                } else if (floor === 2 || floor === -1) {
                    lootPool = ["health potion", "mana potion", "iron sword", "chainmail"];
                } else if (floor === 3 || floor === -2) {
                    lootPool = ["greater health potion", "greater mana potion", "steel sword", "plate armor"];
                } else if (floor >= 4) {
                    lootPool = ["elixir", "enchanted blade", "shadow dagger", "elemental ward"];
                }
            }
            
            const lootType = lootPool[Math.floor(Math.random() * lootPool.length)];
            
            if (lootType === "gold") {
                const goldFound = Math.floor(Math.random() * 100) + 50;
                addToOutput(`You find ${goldFound} gold coins!`, "gold-text");
                gameState.gold += goldFound;
                updateStatus();
            } else {
                addToOutput(`You find a ${lootType.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(lootType);
                updateInventory();
            }
            
            autoScrollToBottom();
        }
        
        // ============================================
        // EXPANDED MOVEMENT SYSTEM
        // ============================================
        function handleMove() {
            if (gameState.inCombat) {
                addToOutput("You can't move during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            const connections = gameState.roomConnections[gameState.currentRoom];
            const directions = [];
            
            if (connections.north) directions.push({ text: "NORTH", value: connections.north });
            if (connections.east) directions.push({ text: "EAST", value: connections.east });
            if (connections.west) directions.push({ text: "WEST", value: connections.west });
            if (connections.south) directions.push({ text: "SOUTH", value: connections.south });
            if (connections.up) directions.push({ text: "UP", value: connections.up });
            if (connections.down) directions.push({ text: "DOWN", value: connections.down });
            
            if (directions.length === 0) {
                addToOutput("There are no exits from this room.");
                autoScrollToBottom();
                return;
            }
            
            showActionPanel("MOVE WHERE?", directions, handleMoveChoice);
            autoScrollToBottom();
        }
        
        function handleMoveChoice(roomId) {
            // Check for locked doors/requirements
            if (roomId === "secretLibrary" && !gameState.keys.secretKey) {
                addToOutput("The door to the secret library is locked. You need a special key.", "danger-text");
                autoScrollToBottom();
                return;
            }
            
            if (roomId === "minotaurLair" && !gameState.keys.labyrinthKey) {
                addToOutput("The minotaur's lair is sealed by ancient magic. You need something to break the seal.", "danger-text");
                autoScrollToBottom();
                return;
            }
            
            if (roomId === "towerHeart" && !gameState.roomSpecial["finalArena"].defeated) {
                addToOutput("The path to the tower's heart is blocked by a powerful barrier. Defeat the Tower Master first.", "danger-text");
                autoScrollToBottom();
                return;
            }
            
            // Update current room
            const oldRoom = gameState.currentRoom;
            gameState.currentRoom = roomId;
            
            // Update floor if necessary
            updateFloorBasedOnRoom(roomId);
            
            // Convert room ID to readable name
            const roomName = roomId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            addToOutput(`You move to the ${roomName}.`, "important-text");
            
            // Mark room as discovered
            gameState.discoveredRooms[roomId] = true;
            
            // Show room description
            const roomDesc = gameState.roomDescriptions[roomId];
            addToOutput(roomDesc);
            
            // Check for NPC
            if (gameState.roomNPCs[roomId]) {
                const npcType = gameState.roomNPCs[roomId];
                const npc = npcData[npcType];
                addToOutput(`You see ${npc.name} here.`, "npc-text");
            }
            
            // Check for special room entrance
            if (roomId === "minotaurLair" && !gameState.roomSpecial["minotaurLair"].defeated) {
                addToOutput("The ground shakes. Something enormous approaches...", "danger-text");
            }
            
            if (roomId === "finalArena" && !gameState.roomSpecial["finalArena"].defeated) {
                addToOutput("This is it. The final confrontation. Prepare yourself.", "danger-text");
            }
            
            updateStatus();
            autoScrollToBottom();
        }
        
        function updateFloorBasedOnRoom(roomId) {
            // Update floor based on room location
            if (roomId.includes("dungeon") || gameState.currentFloor === -1 || gameState.currentFloor === -2) {
                if (roomId === "dungeonStairs" || roomId === "dungeonEntrance" || roomId === "guardRoom") {
                    gameState.currentFloor = 1;
                } else if (roomId === "catacombs" || roomId === "labyrinth") {
                    gameState.currentFloor = -2;
                } else {
                    gameState.currentFloor = -1;
                }
            } else if (roomId.startsWith("floor2") || roomId === "nobleHall" || roomId === "alchemyLab" || roomId === "blacksmith") {
                gameState.currentFloor = 2;
            } else if (roomId.startsWith("floor3") || roomId === "royalSuite" || roomId === "chapel" || roomId === "observatory") {
                gameState.currentFloor = 3;
            } else if (roomId.startsWith("floor4") || roomId === "wizardStudy" || roomId.includes("elemental")) {
                gameState.currentFloor = 4;
            } else if (roomId.startsWith("floor5") || roomId.includes("Chamber") && !roomId.includes("torture")) {
                gameState.currentFloor = 5;
            } else if (roomId === "rooftop" || roomId === "finalArena" || roomId === "towerHeart") {
                gameState.currentFloor = 6;
            } else if (roomId === "secretLibrary" || roomId === "forbiddenArchive") {
                gameState.currentFloor = 0; // Secret floor
            } else {
                gameState.currentFloor = 1; // Default to floor 1
            }
        }
        
        // ============================================
        // COMPLETE NPC INTERACTIONS (FULLY IMPLEMENTED)
        // ============================================
        function handleTalk() {
            if (gameState.inCombat) {
                addToOutput("You can't talk during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            // Check if there's an NPC in the room
            const npcType = gameState.roomNPCs[gameState.currentRoom];
            
            if (!npcType) {
                addToOutput("There's no one here to talk to.");
                autoScrollToBottom();
                return;
            }
            
            const npc = npcData[npcType];
            const interaction = gameState.npcInteractions[npcType];
            
            // Show initial dialogue or regular dialogue
            if (!interaction.talked) {
                addConversation(npcType, npc.dialogue.initial, npcType);
                interaction.talked = true;
            } else {
                addConversation(npcType, npc.dialogue.regular, npcType);
            }
            
            // Show service options
            setTimeout(() => {
                const choices = npc.dialogue.services.map(service => ({
                    text: service.name + (service.gold > 0 ? ` (${service.gold} gold)` : ''),
                    value: service.action
                }));
                
                showActionPanel(`TALK TO ${npc.name.toUpperCase()}:`, choices, (action) => handleNPCAction(npcType, action));
                autoScrollToBottom();
            }, 500);
        }
        
        function handleNPCAction(npcType, action) {
            const npc = npcData[npcType];
            
            switch(action) {
                case "goodbye":
                    addConversation("player", "Goodbye.", "player");
                    addConversation(npcType, "Farewell, traveler.", npcType);
                    break;
                    
                // Merchant Silas - FULLY IMPLEMENTED
                case "merchant_buy":
                    addConversation("player", "What do you have for sale?", "player");
                    addConversation(npcType, "Take a look at my wares!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Shop`, npc.shopItems.general, "general", npcType);
                    }, 500);
                    break;
                    
                case "merchant_sell":
                    addConversation("player", "I'd like to sell some items.", "player");
                    addConversation(npcType, "Let's see what you have.", npcType);
                    setTimeout(() => {
                        showSellItems();
                    }, 500);
                    break;
                    
                case "merchant_special":
                    addConversation("player", "Do you have any special items?", "player");
                    addConversation(npcType, "Ah, for the discerning customer! Here are my special wares.", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Special Items`, npc.shopItems.special, "special", npcType);
                    }, 500);
                    break;
                    
                case "merchant_rumors":
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        addConversation("player", "Tell me what you know about this tower.", "player");
                        addConversation(npcType, "Very well. I've heard whispers... The minotaur in the labyrinth guards more than just the maze. His horn is said to hold great power.", npcType);
                        updateStatus();
                    } else {
                        addConversation(npcType, "Information costs coin, my friend.", npcType);
                    }
                    break;
                    
                // Blacksmith Thrain - FULLY IMPLEMENTED
                case "blacksmith_buy":
                    addConversation("player", "Show me your weapons.", "player");
                    addConversation(npcType, "The finest steel in the tower!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Weapons`, npc.shopItems.weapons, "weapons", npcType);
                    }, 500);
                    break;
                    
                case "blacksmith_buy_armor":
                    addConversation("player", "What armor do you have?", "player");
                    addConversation(npcType, "Armor to turn aside any blow!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Armor`, npc.shopItems.armor, "armor", npcType);
                    }, 500);
                    break;
                    
                case "blacksmith_repair":
                    if (gameState.gold >= 20) {
                        gameState.gold -= 20;
                        addConversation("player", "Can you repair my equipment?", "player");
                        addConversation(npcType, "Aye, I'll put it right for you. Your equipment is now in top condition!", npcType);
                        addToOutput("Your equipment has been repaired.", "success-text");
                        updateStatus();
                    } else {
                        addConversation(npcType, "You don't have enough gold for repairs.", npcType);
                    }
                    break;
                    
                case "blacksmith_upgrade":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        addConversation("player", "Can you upgrade my equipment?", "player");
                        addConversation(npcType, "Let me work my craft! Your equipment has been enhanced!", npcType);
                        addToOutput("Your equipment has been upgraded! Attack +5, Defense +3", "success-text");
                        gameState.attack += 5;
                        gameState.defense += 3;
                        updateStatus();
                        updateEquipmentDisplay();
                    } else {
                        addConversation(npcType, "Upgrades aren't cheap, lad.", npcType);
                    }
                    break;
                    
                // Mystic Elara - FULLY IMPLEMENTED
                case "mystic_buy_potions":
                    addConversation("player", "I need potions.", "player");
                    addConversation(npcType, "Potions for every ailment!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Potions`, npc.shopItems.potions, "potions", npcType);
                    }, 500);
                    break;
                    
                case "mystic_buy_scrolls":
                    addConversation("player", "Show me your scrolls.", "player");
                    addConversation(npcType, "Arcane power at your fingertips!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Scrolls`, npc.shopItems.scrolls, "scrolls", npcType);
                    }, 500);
                    break;
                    
                case "mystic_identify":
                    if (gameState.gold >= 15) {
                        gameState.gold -= 15;
                        addConversation("player", "Can you identify this for me?", "player");
                        addConversation(npcType, "Let me see... Ah yes! This is a rare item indeed!", npcType);
                        addToOutput("Elara identifies your items. They all seem normal.", "important-text");
                        updateStatus();
                    } else {
                        addConversation(npcType, "Arcane knowledge requires compensation.", npcType);
                    }
                    break;
                    
                case "mystic_enchant":
                    if (gameState.gold >= 100) {
                        gameState.gold -= 100;
                        addConversation("player", "Can you enchant my weapon?", "player");
                        addConversation(npcType, "I shall imbue it with elemental power!", npcType);
                        addToOutput("Your weapon glows with magical energy! It now deals extra damage!", "success-text");
                        if (gameState.equipment.weapon) {
                            const weapon = gameState.equipment.weapon;
                            if (equipmentItems[weapon]) {
                                equipmentItems[weapon].attack += 10;
                                addToOutput(`${weapon} now has +10 attack!`, "loot-text");
                            }
                        }
                        updateStatus();
                    } else {
                        addConversation(npcType, "Enchantment is expensive magic.", npcType);
                    }
                    break;
                    
                // Prisoner - FULLY IMPLEMENTED
                case "prisoner_info":
                    addConversation("player", "Tell me about this tower.", "player");
                    addConversation(npcType, "This tower... it was once a place of learning... but dark magic corrupted it... The master seeks a new body...", npcType);
                    break;
                    
                case "prisoner_key":
                    addConversation("player", "Where is the key to your chains?", "player");
                    addConversation(npcType, "The jailer... in the torture chamber... he has it...", npcType);
                    break;
                    
                case "prisoner_free":
                    if (gameState.inventory.includes("jailer's key") || gameState.currentRoom === "tortureChamber") {
                        addConversation("player", "I'll free you.", "player");
                        addConversation(npcType, "Thank you! I was once a knight... here, take my family heirloom.", npcType);
                        addToOutput("The prisoner gives you an ANCIENT AMULET!", "loot-text");
                        gameState.inventory.push("ancient amulet");
                        updateInventory();
                        gameState.score += 100;
                        updateStatus();
                        gameState.quests.prisonerFreed = true;
                    } else {
                        addConversation(npcType, "You need the jailer's key first. It's in the torture chamber.", npcType);
                    }
                    break;
                    
                // Alchemist Mori - FULLY IMPLEMENTED
                case "alchemist_buy":
                    addConversation("player", "I need alchemical supplies.", "player");
                    addConversation(npcType, "Potions brewed with expertise!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Alchemical Supplies`, npc.shopItems.potions, "potions", npcType);
                    }, 500);
                    break;
                    
                case "alchemist_sell":
                    addConversation("player", "I have ingredients to sell.", "player");
                    addConversation(npcType, "Let me see what you've found.", npcType);
                    if (gameState.inventory.some(item => item.includes("herb") || item.includes("root") || item.includes("mushroom"))) {
                        addToOutput("You sell your alchemical ingredients for 25 gold!", "gold-text");
                        gameState.gold += 25;
                        // Remove alchemical ingredients
                        gameState.inventory = gameState.inventory.filter(item => 
                            !item.includes("herb") && !item.includes("root") && !item.includes("mushroom")
                        );
                        updateInventory();
                        updateStatus();
                    } else {
                        addConversation(npcType, "You don't have any alchemical ingredients to sell.", npcType);
                    }
                    break;
                    
                case "alchemist_brew":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        addConversation("player", "Can you brew me a custom potion?", "player");
                        addConversation(npcType, "A special brew, just for you! Here's an Elixir of Power!", npcType);
                        addToOutput("You receive a POWERFUL ELIXIR! It restores all health and mana!", "loot-text");
                        gameState.inventory.push("powerful elixir");
                        updateInventory();
                        updateStatus();
                    } else {
                        addConversation(npcType, "Special brews require special payment.", npcType);
                    }
                    break;
                    
                // Librarian Orin - FULLY IMPLEMENTED
                case "librarian_research":
                    addConversation("player", "Can you help me research the tower?", "player");
                    addConversation(npcType, "According to the ancient texts, this tower was built by a mad wizard who sought immortality. He failed... but his spirit remains.", npcType);
                    break;
                    
                case "librarian_borrow":
                    if (gameState.gold >= 25) {
                        gameState.gold -= 25;
                        addConversation("player", "Can I borrow a spellbook?", "player");
                        addConversation(npcType, "Handle it with care! This is a first edition!", npcType);
                        addToOutput("You borrow a SPELLBOOK OF FIRE! You learn the Fire Bolt ability!", "loot-text");
                        if (!gameState.abilities.find(a => a.name === "Fire Bolt")) {
                            gameState.abilities.push({ name: "Fire Bolt", cost: 8, damageMultiplier: 2.0, description: "Launch a bolt of fire (requires mana)" });
                        }
                        updateStatus();
                    } else {
                        addConversation(npcType, "Knowledge isn't free, you know.", npcType);
                    }
                    break;
                    
                case "librarian_secrets":
                    if (gameState.gold >= 15) {
                        gameState.gold -= 15;
                        addConversation("player", "Tell me the tower's secrets.", "player");
                        addConversation(npcType, "There's a hidden library behind the study. Look for the third bookcase on the left.", npcType);
                        updateStatus();
                    } else {
                        addConversation(npcType, "Secrets have their price.", npcType);
                    }
                    break;
                    
                // Armorer Gareth - FULLY IMPLEMENTED
                case "armorer_buy":
                    addConversation("player", "Show me your armor.", "player");
                    addConversation(npcType, "The best protection money can buy!", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Armor`, npc.shopItems.armor, "armor", npcType);
                    }, 500);
                    break;
                    
                case "armorer_repair":
                    if (gameState.gold >= 15) {
                        gameState.gold -= 15;
                        addConversation("player", "Can you repair my armor?", "player");
                        addConversation(npcType, "Good as new! Your armor is repaired.", npcType);
                        if (gameState.equipment.armor) {
                            addToOutput("Your armor has been fully repaired!", "success-text");
                        }
                        updateStatus();
                    } else {
                        addConversation(npcType, "Repairs cost coin.", npcType);
                    }
                    break;
                    
                case "armorer_enhance":
                    if (gameState.gold >= 75) {
                        gameState.gold -= 75;
                        addConversation("player", "Can you enhance my armor?", "player");
                        addConversation(npcType, "I'll reinforce it with rare materials!", npcType);
                        addToOutput("Your armor has been enhanced! Defense +10", "success-text");
                        gameState.defense += 10;
                        updateStatus();
                        updateEquipmentDisplay();
                    } else {
                        addConversation(npcType, "Enhancements are expensive work.", npcType);
                    }
                    break;
                    
                // Innkeeper Bella - FULLY IMPLEMENTED
                case "innkeeper_rest":
                    if (gameState.gold >= 10) {
                        gameState.gold -= 10;
                        gameState.health = gameState.maxHealth;
                        gameState.mana = gameState.maxMana;
                        addConversation("player", "I need to rest.", "player");
                        addConversation(npcType, "Of course! Rest well, dear.", npcType);
                        addToOutput("You rest and recover all health and mana!", "heal-text");
                        updateStatus();
                    } else {
                        addConversation(npcType, "I'm sorry, but I can't offer free lodging.", npcType);
                    }
                    break;
                    
                case "innkeeper_food":
                    addConversation("player", "Do you have any food?", "player");
                    addConversation(npcType, "Just some supplies left. Take a look.", npcType);
                    setTimeout(() => {
                        showShopPanel(`${npc.name}'s Supplies`, npc.shopItems.food, "food", npcType);
                    }, 500);
                    break;
                    
                case "innkeeper_gossip":
                    if (gameState.gold >= 5) {
                        gameState.gold -= 5;
                        addConversation("player", "What's the gossip around here?", "player");
                        addConversation(npcType, "I've heard the tower's master hasn't been seen in weeks. Some say he's preparing a dark ritual in the ritual chamber.", npcType);
                        updateStatus();
                    } else {
                        addConversation(npcType, "A little coin for a little gossip?", npcType);
                    }
                    break;
                    
                // Prophet - FULLY IMPLEMENTED
                case "prophet_prophecy":
                    addConversation("player", "What do you foresee?", "player");
                    addConversation(npcType, "I see... a great battle at the tower's peak... a choice between power and salvation... Your path is shrouded in mist...", npcType);
                    break;
                    
                case "prophet_future":
                    if (gameState.gold >= 25) {
                        gameState.gold -= 25;
                        addConversation("player", "Tell me about my future.", "player");
                        addConversation(npcType, "You will face three great trials: the beast below, the elemental chaos, and the master's wrath. Only with true courage will you prevail.", npcType);
                        updateStatus();
                    } else {
                        addConversation(npcType, "The future is not free to see.", npcType);
                    }
                    break;
                    
                case "prophet_bless":
                    if (gameState.gold >= 50) {
                        gameState.gold -= 50;
                        gameState.maxHealth += 20;
                        gameState.maxMana += 10;
                        addConversation("player", "Bless me, prophet.", "player");
                        addConversation(npcType, "May the light guide your path and strengthen your soul.", npcType);
                        addToOutput("You feel stronger! Max HP +20, Max MP +10", "success-text");
                        updateStatus();
                    } else {
                        addConversation(npcType, "The divine requires sacrifice.", npcType);
                    }
                    break;
                    
                // Ghost - FULLY IMPLEMENTED
                case "ghost_who":
                    addConversation("player", "Who are you?", "player");
                    addConversation(npcType, "I was... a lady of the court... long ago... he promised to return...", npcType);
                    break;
                    
                case "ghost_view":
                    addConversation("player", "What was this place like?", "player");
                    addConversation(npcType, "Beautiful... gardens as far as the eye could see... music and laughter... now only silence...", npcType);
                    break;
                    
                case "ghost_help":
                    addConversation("player", "Can I help you?", "player");
                    addConversation(npcType, "I'm waiting for my love... he promised to return... find his ring in the royal bedroom... bring it to me...", npcType);
                    // Add quest
                    if (!gameState.quests.ghostQuest) {
                        gameState.quests.ghostQuest = "Find the lover's ring";
                        addToOutput("New Quest: Find the lover's ring in the royal bedroom!", "important-text");
                    }
                    break;
                    
                default:
                    addConversation(npcType, "I can't help you with that right now.", npcType);
            }
            
            autoScrollToBottom();
        }
        
        function buyItem(itemName, price, shopType, npcType) {
            if (gameState.gold >= price) {
                gameState.gold -= price;
                gameState.inventory.push(itemName);
                addToOutput(`You buy ${itemName} for ${price} gold.`, "gold-text");
                updateStatus();
                updateInventory();
            } else {
                addToOutput("You don't have enough gold!", "danger-text");
            }
        }
        
        function showSellItems() {
            if (gameState.inventory.length === 0) {
                addToOutput("You have nothing to sell.", "important-text");
                return;
            }
            
            const sellableItems = gameState.inventory.filter(item => 
                equipmentItems[item] || consumableItems[item]
            );
            
            if (sellableItems.length === 0) {
                addToOutput("You have nothing valuable to sell.", "important-text");
                return;
            }
            
            const choices = sellableItems.map((item, index) => {
                const value = equipmentItems[item] ? Math.floor(equipmentItems[item].value * 0.6) : 
                             consumableItems[item] ? Math.floor(consumableItems[item].value * 0.5) : 10;
                return {
                    text: `${item.toUpperCase()} (${value} gold)`,
                    value: {item: item, price: value}
                };
            });
            
            choices.push({ text: "CANCEL", value: "cancel" });
            
            showActionPanel("SELL WHICH ITEM?", choices, (choice) => {
                if (choice === "cancel") {
                    addToOutput("You decide not to sell anything.");
                    return;
                }
                
                const {item, price} = choice;
                const itemIndex = gameState.inventory.indexOf(item);
                if (itemIndex > -1) {
                    gameState.inventory.splice(itemIndex, 1);
                    gameState.gold += price;
                    addToOutput(`You sell ${item} for ${price} gold.`, "gold-text");
                    updateInventory();
                    updateStatus();
                }
            });
        }
        
        // ============================================
        // INVENTORY & EQUIPMENT MANAGEMENT
        // ============================================
        function handleInventory() {
            if (gameState.inCombat) {
                addToOutput("You can't access inventory during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (inventoryPanel.style.display === "block") {
                inventoryPanel.style.display = "none";
            } else {
                inventoryPanel.style.display = "block";
                updateInventory();
            }
            autoScrollToBottom();
        }
        
        function updateInventory() {
            inventoryItems.innerHTML = "";
            
            if (gameState.inventory.length === 0) {
                const emptyItem = document.createElement("div");
                emptyItem.className = "inventory-item";
                emptyItem.textContent = "Empty";
                inventoryItems.appendChild(emptyItem);
            } else {
                // Group items by type
                const itemCounts = {};
                gameState.inventory.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
                
                Object.keys(itemCounts).forEach(item => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "inventory-item";
                    const count = itemCounts[item] > 1 ? ` (${itemCounts[item]})` : '';
                    itemElement.textContent = `${item.toUpperCase()}${count}`;
                    inventoryItems.appendChild(itemElement);
                });
            }
        }
        
        function handleEquipment() {
            if (gameState.inCombat) {
                addToOutput("You can't change equipment during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (equipmentPanel.style.display === "block") {
                equipmentPanel.style.display = "none";
            } else {
                equipmentPanel.style.display = "block";
                updateEquipmentDisplay();
            }
            autoScrollToBottom();
        }
        
        function updateEquipmentDisplay() {
            equipmentSlots.innerHTML = '';
            
            // Weapon slot
            const weaponSlot = document.createElement("div");
            weaponSlot.className = "equipment-slot";
            weaponSlot.innerHTML = `<strong>WEAPON</strong><br>${gameState.equipment.weapon ? gameState.equipment.weapon.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(weaponSlot);
            
            // Armor slot
            const armorSlot = document.createElement("div");
            armorSlot.className = "equipment-slot";
            armorSlot.innerHTML = `<strong>ARMOR</strong><br>${gameState.equipment.armor ? gameState.equipment.armor.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(armorSlot);
            
            // Shield slot
            const shieldSlot = document.createElement("div");
            shieldSlot.className = "equipment-slot";
            shieldSlot.innerHTML = `<strong>SHIELD</strong><br>${gameState.equipment.shield ? gameState.equipment.shield.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(shieldSlot);
            
            // Accessory slot
            const accessorySlot = document.createElement("div");
            accessorySlot.className = "equipment-slot";
            accessorySlot.innerHTML = `<strong>ACCESSORY</strong><br>${gameState.equipment.accessory ? gameState.equipment.accessory.toUpperCase() : 'None'}`;
            equipmentSlots.appendChild(accessorySlot);
            
            // Stats display
            const statsSlot = document.createElement("div");
            statsSlot.className = "equipment-slot";
            statsSlot.innerHTML = `<strong>STATS</strong><br>ATK: ${gameState.attack}<br>DEF: ${gameState.defense}<br>HP: ${gameState.maxHealth}<br>MP: ${gameState.maxMana}`;
            equipmentSlots.appendChild(statsSlot);
        }
        
        // ============================================
        // COMBAT FUNCTIONS (from previous version)
        // ============================================
        function showCombatItems() {
            const combatItems = gameState.inventory.filter(item => 
                consumableItems[item] && (consumableItems[item].type === "combat" || consumableItems[item].type === "consumable")
            );
            
            if (combatItems.length === 0) {
                addToOutput("You have no usable items in combat.", "important-text");
                return;
            }
            
            const choices = combatItems.map(item => ({
                text: `${item.toUpperCase()}`,
                value: item
            }));
            
            choices.push({ text: "CANCEL", value: "cancel" });
            
            showActionPanel("USE ITEM IN COMBAT:", choices, handleCombatItemChoice);
        }
        
        function handleCombatItemChoice(item) {
            if (item === "cancel") {
                addToOutput("You decide not to use an item.");
                return;
            }
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Apply item effect
            const itemData = consumableItems[item];
            
            if (itemData.healthRestore) {
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + itemData.healthRestore);
                const healed = gameState.health - oldHealth;
                addToOutput(`You use ${item} and restore ${healed} health.`, "heal-text");
            }
            
            if (itemData.manaRestore) {
                const oldMana = gameState.mana;
                gameState.mana = Math.min(gameState.maxMana, gameState.mana + itemData.manaRestore);
                const restored = gameState.mana - oldMana;
                addToOutput(`You use ${item} and restore ${restored} mana.`, "heal-text");
            }
            
            if (itemData.damage && gameState.currentEnemy) {
                const damage = itemData.damage;
                gameState.currentEnemy.health -= damage;
                addToOutput(`You use ${item} and deal ${damage} damage to the ${gameState.currentEnemy.name}!`, "damage-text");
                
                if (gameState.currentEnemy.health <= 0) {
                    enemyDefeated();
                    return;
                }
            }
            
            if (itemData.undeadDamage && gameState.currentEnemy && 
                (gameState.currentEnemy.name.includes("Zombie") || 
                 gameState.currentEnemy.name.includes("Skeleton") ||
                 gameState.currentEnemy.name.includes("Ghost") ||
                 gameState.currentEnemy.name.includes("Wraith"))) {
                const damage = itemData.undeadDamage;
                gameState.currentEnemy.health -= damage;
                addToOutput(`The holy water burns the undead ${gameState.currentEnemy.name} for ${damage} damage!`, "damage-text");
                
                if (gameState.currentEnemy.health <= 0) {
                    enemyDefeated();
                    return;
                }
            }
            
            updateInventory();
            updateCombatUI();
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function playerAttack(attackType) {
            if (!gameState.playerTurn || !gameState.inCombat) return;
            
            let damage = gameState.attack;
            let abilityCost = 0;
            let specialEffect = "";
            
            // Determine attack type
            switch(attackType) {
                case "heavy strike":
                    damage = Math.floor(damage * 1.5);
                    addToOutput("You use HEAVY STRIKE!", "combat-text");
                    break;
                case "fire bolt":
                    damage = Math.floor(damage * 2.0);
                    abilityCost = 8;
                    specialEffect = " The enemy is burned!";
                    addToOutput("You cast FIRE BOLT!", "combat-text");
                    break;
                case "ice shard":
                    damage = Math.floor(damage * 1.8);
                    abilityCost = 6;
                    specialEffect = " The enemy is slowed!";
                    addToOutput("You cast ICE SHARD!", "combat-text");
                    break;
                case "shield bash":
                    damage = Math.floor(damage * 1.2);
                    abilityCost = 5;
                    if (Math.random() < 0.3) {
                        specialEffect = " The enemy is stunned!";
                    }
                    addToOutput("You use SHIELD BASH!", "combat-text");
                    break;
                case "lightning arc":
                    damage = Math.floor(damage * 2.5);
                    abilityCost = 15;
                    specialEffect = " Lightning arcs to nearby enemies!";
                    addToOutput("You cast LIGHTNING ARC!", "combat-text");
                    break;
                case "poison strike":
                    damage = Math.floor(damage * 1.5);
                    abilityCost = 10;
                    specialEffect = " The enemy is poisoned!";
                    addToOutput("You use POISON STRIKE!", "combat-text");
                    break;
                default:
                    addToOutput("You attack!", "combat-text");
            }
            
            // Deduct mana if using ability
            if (abilityCost > 0) {
                if (gameState.mana >= abilityCost) {
                    gameState.mana -= abilityCost;
                    addToOutput(`You use ${abilityCost} mana.`, "important-text");
                } else {
                    addToOutput("Not enough mana! Using normal attack instead.", "danger-text");
                    damage = gameState.attack;
                    abilityCost = 0;
                    specialEffect = "";
                }
            }
            
            // Calculate final damage (consider enemy defense)
            damage = Math.max(1, damage - gameState.currentEnemy.defense);
            gameState.currentEnemy.health -= damage;
            
            addToOutput(`You hit the ${gameState.currentEnemy.name} for ${damage} damage!${specialEffect}`, "damage-text");
            
            updateCombatUI();
            
            // Check if enemy is defeated
            if (gameState.currentEnemy.health <= 0) {
                enemyDefeated();
                return;
            }
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function playerHeal(ability) {
            if (!gameState.playerTurn || !gameState.inCombat) return;
            
            if (gameState.mana < ability.cost) {
                addToOutput("Not enough mana!", "danger-text");
                return;
            }
            
            gameState.mana -= ability.cost;
            const oldHealth = gameState.health;
            gameState.health = Math.min(gameState.maxHealth, gameState.health + ability.healAmount);
            const healed = gameState.health - oldHealth;
            
            addToOutput(`You use HEAL and restore ${healed} health.`, "heal-text");
            addToOutput(`You use ${ability.cost} mana.`, "important-text");
            
            updateCombatUI();
            
            // Enemy's turn
            gameState.playerTurn = false;
            setTimeout(enemyAttack, 1000);
        }
        
        function enemyAttack() {
            if (!gameState.inCombat) return;
            
            addToOutput(`The ${gameState.currentEnemy.name} attacks!`, "enemy-text");
            
            // Calculate damage (consider player defense)
            let damage = Math.max(1, gameState.currentEnemy.attack - gameState.defense);
            
            // Critical hit chance
            if (Math.random() < 0.1) {
                damage = Math.floor(damage * 1.5);
                addToOutput("Critical hit!", "danger-text");
            }
            
            // Special enemy abilities
            if (gameState.currentEnemy.special) {
                if (gameState.currentEnemy.special.poison && Math.random() < 0.2) {
                    addToOutput("The enemy's attack poisons you!", "poison-text");
                    // Poison effect would be tracked here
                }
                
                if (gameState.currentEnemy.special.fire && Math.random() < 0.3) {
                    damage += 10;
                    addToOutput("The enemy's fire burns you!", "damage-text");
                }
            }
            
            gameState.health -= damage;
            
            addToOutput(`The ${gameState.currentEnemy.name} hits you for ${damage} damage!`, "damage-text");
            
            updateCombatUI();
            
            // Check if player is defeated
            if (gameState.health <= 0) {
                playerDefeated();
                return;
            }
            
            // Player's turn again
            gameState.playerTurn = true;
            updateCombatChoices();
        }
        
        function enemyDefeated() {
            const enemy = gameState.currentEnemy;
            const isBoss = enemy.boss;
            
            if (isBoss) {
                addToOutput(`You have defeated the ${enemy.name}!`, "success-text");
                addToOutput("VICTORY!", "important-text");
                
                // Mark boss as defeated
                if (enemy.name === "Minotaur") {
                    gameState.roomSpecial["minotaurLair"].defeated = true;
                    addToOutput("The labyrinth is now safe! You find the Minotaur's Horn.", "loot-text");
                    gameState.inventory.push("minotaur horn");
                } else if (enemy.name === "Tower Master") {
                    gameState.roomSpecial["finalArena"].defeated = true;
                    addToOutput("The Tower Master is defeated! The path to the tower's heart is now open.", "success-text");
                    addToOutput("You find the Tower Master's Blade!", "loot-text");
                    gameState.inventory.push("tower master's blade");
                }
            } else {
                addToOutput(`You defeated the ${enemy.name}!`, "success-text");
            }
            
            // Award gold and score
            const goldEarned = enemy.gold;
            const xpEarned = enemy.xp;
            
            gameState.gold += goldEarned;
            gameState.score += xpEarned;
            
            addToOutput(`You gain ${goldEarned} gold and ${xpEarned} score!`, "gold-text");
            
            // Chance to drop loot
            const dropChance = isBoss ? 1.0 : 0.5; // Bosses always drop loot
            if (dropChance > Math.random()) {
                let lootPool = [];
                
                if (isBoss) {
                    if (enemy.name === "Minotaur") {
                        lootPool = ["minotaur axe", "minotaur horn", "tower shield"];
                    } else {
                        lootPool = ["tower master's blade", "tower guardian armor", "tower heart"];
                    }
                } else {
                    // Regular enemy loot based on floor
                    const floor = gameState.currentFloor;
                    if (floor === 1 || floor === -1) {
                        lootPool = ["health potion", "iron sword", "leather armor", "wooden shield"];
                    } else if (floor === 2 || floor === -2) {
                        lootPool = ["mana potion", "steel sword", "chainmail", "health amulet"];
                    } else if (floor === 3) {
                        lootPool = ["greater health potion", "war hammer", "plate armor", "lucky charm"];
                    } else if (floor >= 4) {
                        lootPool = ["elixir", "enchanted blade", "shadow cloak", "vampire ring"];
                    }
                }
                
                const lootType = lootPool[Math.floor(Math.random() * lootPool.length)];
                
                addToOutput(`The enemy drops a ${lootType.toUpperCase()}!`, "loot-text");
                gameState.inventory.push(lootType);
                updateInventory();
            }
            
            // End combat
            gameState.inCombat = false;
            gameState.currentEnemy = null;
            
            hideCombatPanel();
            updateStatus();
            
            // Check for victory condition
            if (gameState.currentRoom === "finalArena" && gameState.roomSpecial["finalArena"].defeated) {
                addToOutput("You have proven yourself worthy. The tower's heart awaits...", "important-text");
            }
            
            autoScrollToBottom();
        }
        
        function playerDefeated() {
            addToOutput("You have been defeated!", "danger-text");
            addToOutput("GAME OVER", "combat-text");
            
            // Calculate final score
            gameState.score += Math.floor(gameState.gold / 2);
            addToOutput(`Final Score: ${gameState.score}`, "important-text");
            addToOutput(`Rooms Discovered: ${Object.keys(gameState.discoveredRooms).length}`, "important-text");
            addToOutput(`Floors Reached: ${gameState.currentFloor}`, "important-text");
            
            // Disable all buttons
            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
            
            // End combat
            gameState.inCombat = false;
            hideCombatPanel();
            autoScrollToBottom();
        }
        
        function attemptFlee() {
            if (!gameState.inCombat) return;
            
            let fleeChance = 0.6; // Base 60% chance to flee
            
            // Check for smoke bomb in inventory
            if (gameState.inventory.includes("smoke bomb")) {
                fleeChance += 0.3;
                // Remove smoke bomb
                const bombIndex = gameState.inventory.indexOf("smoke bomb");
                if (bombIndex > -1) {
                    gameState.inventory.splice(bombIndex, 1);
                    addToOutput("You use a smoke bomb to cover your escape!", "important-text");
                    updateInventory();
                }
            }
            
            // Bosses are harder to flee from
            if (gameState.currentEnemy && gameState.currentEnemy.boss) {
                fleeChance *= 0.5;
            }
            
            if (Math.random() < fleeChance) {
                addToOutput("You successfully flee from combat!", "success-text");
                gameState.inCombat = false;
                gameState.currentEnemy = null;
                hideCombatPanel();
                
                // Take damage when fleeing
                const fleeDamage = Math.floor(Math.random() * 20) + 10;
                gameState.health -= fleeDamage;
                addToOutput(`You take ${fleeDamage} damage while fleeing.`, "damage-text");
                
                updateStatus();
                
                if (gameState.health <= 0) {
                    playerDefeated();
                }
            } else {
                addToOutput("You failed to flee!", "danger-text");
                
                // Enemy gets a free attack
                gameState.playerTurn = false;
                setTimeout(enemyAttack, 1000);
            }
            autoScrollToBottom();
        }
        
        function handleUseItem() {
            if (gameState.inCombat) {
                addToOutput("You can't use items from inventory during combat! Use the combat item button instead.", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (gameState.inventory.length === 0) {
                addToOutput("Your inventory is empty. There's nothing to use.");
                autoScrollToBottom();
                return;
            }
            
            // Filter usable items
            const usableItems = gameState.inventory.filter(item => 
                consumableItems[item] || equipmentItems[item]
            );
            
            if (usableItems.length === 0) {
                addToOutput("You have no usable items in your inventory.");
                autoScrollToBottom();
                return;
            }
            
            const choices = usableItems.map((item, index) => ({
                text: `${item.toUpperCase()}${equipmentItems[item] ? ` (Equip)` : ` (Use)`}`,
                value: item
            }));
            
            // Add option to cancel
            choices.push({ text: "CANCEL", value: "cancel" });
            
            showActionPanel("USE OR EQUIP ITEM:", choices, handleUseItemChoice);
            autoScrollToBottom();
        }
        
        function handleUseItemChoice(item) {
            if (item === "cancel") {
                addToOutput("Cancelled.");
                autoScrollToBottom();
                return;
            }
            
            // Check if it's equipment
            if (equipmentItems[item]) {
                equipItem(item);
                autoScrollToBottom();
                return;
            }
            
            // Check if it's a consumable
            if (consumableItems[item]) {
                useConsumable(item);
                autoScrollToBottom();
                return;
            }
            
            addToOutput(`You can't use the ${item} right now.`);
            autoScrollToBottom();
        }
        
        function equipItem(item) {
            const itemData = equipmentItems[item];
            const slot = itemData.type;
            
            // Check if player already has something equipped in this slot
            if (gameState.equipment[slot]) {
                // Unequip current item
                const oldItem = gameState.equipment[slot];
                gameState.inventory.push(oldItem);
                
                // Remove stats
                removeEquipmentStats(oldItem);
                
                addToOutput(`You unequip ${oldItem}.`, "important-text");
            }
            
            // Equip new item
            gameState.equipment[slot] = item;
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Add stats
            applyEquipmentStats(item);
            
            addToOutput(`You equip ${item}.`, "success-text");
            
            updateInventory();
            updateEquipmentDisplay();
            updateStatus();
            autoScrollToBottom();
        }
        
        function applyEquipmentStats(item) {
            const itemData = equipmentItems[item];
            
            if (itemData.attack) gameState.attack += itemData.attack;
            if (itemData.defense) gameState.defense += itemData.defense;
            if (itemData.healthBonus) gameState.maxHealth += itemData.healthBonus;
            if (itemData.manaBonus) gameState.maxMana += itemData.manaBonus;
            if (itemData.attackBonus) gameState.attack += itemData.attackBonus;
            if (itemData.defenseBonus) gameState.defense += itemData.defenseBonus;
        }
        
        function removeEquipmentStats(item) {
            const itemData = equipmentItems[item];
            
            if (itemData.attack) gameState.attack -= itemData.attack;
            if (itemData.defense) gameState.defense -= itemData.defense;
            if (itemData.healthBonus) gameState.maxHealth -= itemData.healthBonus;
            if (itemData.manaBonus) gameState.maxMana -= itemData.manaBonus;
            if (itemData.attackBonus) gameState.attack -= itemData.attackBonus;
            if (itemData.defenseBonus) gameState.defense -= itemData.defenseBonus;
            
            // Ensure max health/mana doesn't go below current
            if (gameState.health > gameState.maxHealth) gameState.health = gameState.maxHealth;
            if (gameState.mana > gameState.maxMana) gameState.mana = gameState.maxMana;
        }
        
        function useConsumable(item) {
            const itemData = consumableItems[item];
            
            // Remove from inventory
            const itemIndex = gameState.inventory.indexOf(item);
            if (itemIndex > -1) {
                gameState.inventory.splice(itemIndex, 1);
            }
            
            // Apply effects
            if (itemData.healthRestore) {
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + itemData.healthRestore);
                const healed = gameState.health - oldHealth;
                addToOutput(`You use ${item} and restore ${healed} health.`, "heal-text");
            }
            
            if (itemData.manaRestore) {
                const oldMana = gameState.mana;
                gameState.mana = Math.min(gameState.maxMana, gameState.mana + itemData.manaRestore);
                const restored = gameState.mana - oldMana;
                addToOutput(`You use ${item} and restore ${restored} mana.`, "heal-text");
            }
            
            if (itemData.curePoison) {
                addToOutput(`You use ${item} and cure any poisoning.`, "heal-text");
            }
            
            updateInventory();
            updateStatus();
            autoScrollToBottom();
        }
        
        function handleRest() {
            if (gameState.inCombat) {
                addToOutput("You can't rest during combat!", "combat-text");
                autoScrollToBottom();
                return;
            }
            
            if (gameState.health >= gameState.maxHealth && gameState.mana >= gameState.maxMana) {
                addToOutput("You're already at full health and mana.");
                autoScrollToBottom();
                return;
            }
            
            addToOutput("You take a moment to rest and recover...", "important-text");
            
            // Restore health and mana
            const healthRestored = Math.floor(gameState.maxHealth * 0.4);
            const manaRestored = Math.floor(gameState.maxMana * 0.6);
            
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healthRestored);
            gameState.mana = Math.min(gameState.maxMana, gameState.mana + manaRestored);
            
            addToOutput(`You restore ${healthRestored} health and ${manaRestored} mana.`, "heal-text");
            
            // Small chance of enemy encounter while resting
            if (Math.random() < 0.2) {
                addToOutput("An enemy stumbles upon you while you're resting!", "danger-text");
                setTimeout(() => {
                    triggerEnemyEncounter();
                    autoScrollToBottom();
                }, 1000);
            }
            
            updateStatus();
            autoScrollToBottom();
        }
        
        // ============================================
        // VICTORY CONDITION
        // ============================================
        function checkVictory() {
            if (gameState.currentRoom === "towerHeart") {
                victory();
            }
        }
        
        function victory() {
            addToOutput("CONGRATULATIONS!", "success-text");
            addToOutput("You have reached the very heart of the Tower of Terror!", "important-text");
            addToOutput("The tower's power is now yours to command.", "secret-text");
            
            // Calculate final score bonus
            const roomsDiscovered = Object.keys(gameState.discoveredRooms).length;
            const victoryBonus = gameState.currentFloor * 500 + gameState.gold + (roomsDiscovered * 10);
            gameState.score += victoryBonus;
            
            addToOutput(`Rooms Discovered: ${roomsDiscovered}`, "important-text");
            addToOutput(`Gold Collected: ${gameState.gold}`, "gold-text");
            addToOutput(`Final Score: ${gameState.score}`, "important-text");
            addToOutput("You are the true master of the tower!", "success-text");
            
            // Disable all buttons
            document.querySelectorAll('.button, .command-button').forEach(btn => btn.disabled = true);
            
            // Show victory message
            setTimeout(() => {
                addToOutput("Thanks for playing TOWER OF TERROR - ULTIMATE EXPANSION!", "important-text");
                addToOutput("Refresh the page to play again.", "success-text");
                autoScrollToBottom();
            }, 2000);
        }
        
        // ============================================
        // INITIALIZE GAME
        // ============================================
        initGame();
        
        // Add map command help
        setTimeout(() => {
            addToOutput("TIP: Press 'M' key to toggle the map of discovered rooms.", "important-text");
        }, 1000);
    </script>
</body>
</html>
