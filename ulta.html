<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultima I: The First Age of Darkness</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
                    }
        
        body {
            background-color: #000;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 20px;
            line-height: 1.4;
            overflow: hidden;
            height: 100vh;
        }
        
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid white;
            padding: 10px;
            background-color: #000;
            height: 95vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .game-subtitle {
            font-size: 14px;
            color: #0a0;
            margin-bottom: 10px;
        }
        
        .game-screen {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid white;
            padding: 10px;
            margin-bottom: 10px;
            height: 60vh;
            background-color: #000;
        }
        
        .game-text {
            margin-bottom: 10px;
        }
        
        .prompt {
            color: #0ff;
        }
        
        .input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .cursor {
            background-color: #0f0;
            width: 8px;
            height: 16px;
            animation: blink 1s infinite;
            margin-right: 5px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .dos-button {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dos-button:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .dos-button:active {
            background-color: #0a0;
            color: #000;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #0f0;
            padding-top: 10px;
            font-size: 14px;
        }
        
        .player-stats {
            display: flex;
            gap: 15px;
        }
        
        .stat {
            color: #0ff;
        }
        
        .game-over {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        .combat-text {
            color: #f00;
        }
        
        .item-text {
            color: #ff0;
        }
        
        .location-text {
            color: #0af;
        }
        
        .command {
            color: #0f0;
            font-weight: bold;
        }
        
        .xp-text {
            color: #f0f;
        }
        
        .inventory-item {
            color: #ff9d00;
        }
        
        .ability-text {
            color: #9dff00;
        }
        
        /* Scrollbar styling */
        .game-screen::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-screen::-webkit-scrollbar-track {
            background: #000;
        }
        
        .game-screen::-webkit-scrollbar-thumb {
            background: #0a0;
            border: 1px solid #0f0;
        }
        
        .game-screen::-webkit-scrollbar-thumb:hover {
            background: #0f0;
        }
        
        @media (max-width: 850px) {
            .game-container {
                max-width: 95%;
                height: 90vh;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            .dos-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">ULTIMA I</div>
            <div class="game-subtitle">The First Age of Darkness</div>
            <div>───────────────</div>
        </div>
        
        <div class="game-screen" id="gameScreen">
            <div class="game-text">Welcome to Ultima I: The First Age of Darkness</div>
            <div class="game-text">A time of chaos and peril in the land of Sosaria.</div>
            <div class="game-text">Mondain the Wizard has created the Gem of Immortality,</div>
            <div class="game-text">plunging the world into eternal darkness.</div>
            <div class="game-text">Only a hero of true valor can defeat him and restore light.</div>
            <br>
            <div class="game-text prompt">Press START to begin your quest...</div>
        </div>
        
        <div class="button-container" id="buttonContainer">
            <button class="dos-button" id="startBtn">START GAME</button>
            <button class="dos-button" id="helpBtn">HELP</button>
            <button class="dos-button" id="creditsBtn">CREDITS</button>
        </div>
        
        <div class="status-bar" id="statusBar">
            <div class="player-stats">
                <div>Health: <span class="stat" id="health">100</span></div>
                <div>Strength: <span class="stat" id="strength">10</span></div>
                <div>Level: <span class="stat" id="level">1</span></div>
                <div>Gold: <span class="stat" id="gold">50</span></div>
            </div>
            <div>Location: <span class="stat" id="location">Title Screen</span></div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            screen: "title",
            player: {
                name: "",
                health: 100,
                maxHealth: 100,
                strength: 10,
                dexterity: 10,
                intelligence: 10,
                gold: 50,
                experience: 0,
                nextLevelExp: 100,
                level: 1,
                weapon: "Dagger",
                armor: "Leather",
                location: "Britain",
                quest: 0, // 0 = not started, 1 = find gem, 2 = defeat Mondain
                inventory: ["Healing Potion", "Healing Potion", "Torch"],
                inventoryLimit: 10,
                abilities: [],
                combatStance: "balanced"
            },
            world: {
                towns: [
                    { name: "Britain", type: "capital", shops: ["inn", "weapons", "armor", "magic"], quest: "king" },
                    { name: "Moonglow", type: "magic", shops: ["inn", "magic", "library"], quest: "mage" },
                    { name: "Yew", type: "forest", shops: ["inn", "weapons"], quest: "druid" },
                    { name: "Minoc", type: "mining", shops: ["inn", "armor", "blacksmith"], quest: "miner" },
                    { name: "Trinsic", type: "knightly", shops: ["inn", "weapons", "armor", "training"], quest: "knight" },
                    { name: "Skara Brae", type: "coastal", shops: ["inn", "fishing"], quest: "fisherman" },
                    { name: "Magincia", type: "ruined", shops: ["inn"], quest: "survivor" },
                    { name: "Paws", type: "farming", shops: ["inn", "supplies"], quest: "farmer" },
                    { name: "Buccaneer's Den", type: "pirate", shops: ["inn", "weapons", "tavern"], quest: "pirate" },
                    { name: "Vesper", type: "trade", shops: ["inn", "weapons", "armor", "magic", "general"], quest: "merchant" },
                    { name: "Cove", type: "hidden", shops: ["inn", "special"], quest: "hermit" },
                    { name: "Wind", type: "mountain", shops: ["inn"], quest: "shaman" },
                    { name: "Daggerfall", type: "port", shops: ["inn", "ships", "weapons"], quest: "captain" },
                    { name: "Borderkeep", type: "fortress", shops: ["inn", "armor", "training"], quest: "commander" },
                    { name: "Serpent's Hold", type: "warrior", shops: ["inn", "weapons", "training"], quest: "champion" }
                ],
                dungeons: [
                    { name: "Deceit", level: 1, location: "near Yew", boss: "Gorgon", reward: "Silver Sword" },
                    { name: "Despise", level: 2, location: "near Britain", boss: "Lich", reward: "Magic Shield" },
                    { name: "Destard", level: 3, location: "far north", boss: "Dragon", reward: "Dragon Armor" },
                    { name: "Covetous", level: 2, location: "east of Minoc", boss: "Giant Spider", reward: "Spider Silk Cloak" },
                    { name: "Shame", level: 4, location: "mountain pass", boss: "Balron", reward: "Demon Sword" },
                    { name: "Wrong", level: 3, location: "swamp lands", boss: "Hydra", reward: "Hydra Helm" },
                    { name: "Hythloth", level: 5, location: "volcanic island", boss: "Mondain", reward: "Gem of Immortality" }
                ],
                wildernessEncounters: [
                    "bandits", "wolves", "giant rats", "wild dogs", "bears",
                    "brigands", "harpies", "giant snakes", "wild boars", "specters"
                ]
            },
            enemies: [
                { name: "Goblin", health: 20, maxHealth: 20, strength: 5, dexterity: 8, gold: 10, exp: 20, abilities: ["quick strike"] },
                { name: "Orc", health: 35, maxHealth: 35, strength: 8, dexterity: 5, gold: 20, exp: 35, abilities: ["brutal swing"] },
                { name: "Troll", health: 50, maxHealth: 50, strength: 12, dexterity: 3, gold: 35, exp: 50, abilities: ["regenerate"] },
                { name: "Skeleton", health: 30, maxHealth: 30, strength: 10, dexterity: 6, gold: 25, exp: 30, abilities: ["bone armor"] },
                { name: "Bandit", health: 25, maxHealth: 25, strength: 7, dexterity: 9, gold: 15, exp: 25, abilities: ["dirty trick"] },
                { name: "Wizard", health: 40, maxHealth: 40, strength: 5, dexterity: 7, gold: 40, exp: 45, abilities: ["fireball", "heal"] },
                { name: "Knight", health: 60, maxHealth: 60, strength: 15, dexterity: 10, gold: 50, exp: 60, abilities: ["shield bash", "armor up"] },
                { name: "Dragon", health: 120, maxHealth: 120, strength: 25, dexterity: 12, gold: 200, exp: 150, abilities: ["fire breath", "tail swipe", "fear"] },
                { name: "Mondain", health: 150, maxHealth: 150, strength: 30, dexterity: 15, gold: 500, exp: 300, abilities: ["dark bolt", "life drain", "summon minion", "immortality"] }
            ],
            items: {
                weapons: [
                    { name: "Dagger", price: 10, strength: 2, type: "weapon" },
                    { name: "Short Sword", price: 25, strength: 4, type: "weapon" },
                    { name: "Long Sword", price: 50, strength: 7, type: "weapon" },
                    { name: "Broad Sword", price: 80, strength: 10, type: "weapon" },
                    { name: "Silver Sword", price: 150, strength: 15, type: "weapon", special: "undead slayer" },
                    { name: "Magic Sword", price: 300, strength: 20, type: "weapon", special: "magic damage" },
                    { name: "Dragon Sword", price: 500, strength: 25, type: "weapon", special: "fire damage" }
                ],
                armors: [
                    { name: "Leather", price: 15, defense: 5, type: "armor" },
                    { name: "Chainmail", price: 40, defense: 10, type: "armor" },
                    { name: "Plate Mail", price: 100, defense: 15, type: "armor" },
                    { name: "Magic Robe", price: 120, defense: 12, type: "armor", special: "magic resist" },
                    { name: "Dragon Armor", price: 400, defense: 25, type: "armor", special: "fire resist" }
                ],
                consumables: [
                    { name: "Healing Potion", price: 15, effect: "heal", value: 30, type: "consumable" },
                    { name: "Strength Potion", price: 25, effect: "strength", value: 5, duration: 3, type: "consumable" },
                    { name: "Antidote", price: 10, effect: "cure", value: 1, type: "consumable" },
                    { name: "Mana Potion", price: 30, effect: "mana", value: 20, type: "consumable" },
                    { name: "Smoke Bomb", price: 20, effect: "escape", value: 90, type: "consumable" }
                ],
                questItems: [
                    { name: "Gem of Immortality", type: "quest", value: 1000 },
                    { name: "King's Seal", type: "quest", value: 100 },
                    { name: "Mage's Tome", type: "quest", value: 200 },
                    { name: "Druid's Herb", type: "quest", value: 150 }
                ]
            },
            currentEnemy: null,
            inCombat: false,
            buffs: []
        };

        // DOM elements
        const gameScreen = document.getElementById('gameScreen');
        const buttonContainer = document.getElementById('buttonContainer');
        const statusBar = document.getElementById('statusBar');
        const healthElement = document.getElementById('health');
        const strengthElement = document.getElementById('strength');
        const levelElement = document.getElementById('level');
        const goldElement = document.getElementById('gold');
        const locationElement = document.getElementById('location');
        
        // Buttons
        const startBtn = document.getElementById('startBtn');
        const helpBtn = document.getElementById('helpBtn');
        const creditsBtn = document.getElementById('creditsBtn');
        
        // Initialize game
        function init() {
            startBtn.addEventListener('click', startGame);
            helpBtn.addEventListener('click', showHelp);
            creditsBtn.addEventListener('click', showCredits);
            
            updateStatusBar();
        }
        
        // Update status bar with player stats
        function updateStatusBar() {
            healthElement.textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            strengthElement.textContent = gameState.player.strength;
            levelElement.textContent = gameState.player.level;
            goldElement.textContent = gameState.player.gold;
            locationElement.textContent = gameState.player.location;
        }
        
        // Add text to game screen
        function addText(text, className = "") {
            const textElement = document.createElement('div');
            textElement.className = `game-text ${className}`;
            textElement.textContent = text;
            gameScreen.appendChild(textElement);
            gameScreen.scrollTop = gameScreen.scrollHeight;
        }
        
        // Clear the game screen
        function clearScreen() {
            gameScreen.innerHTML = '';
        }
        
        // Clear buttons
        function clearButtons() {
            buttonContainer.innerHTML = '';
        }
        
        // Add a button
        function addButton(text, action, id = "") {
            const button = document.createElement('button');
            button.className = 'dos-button';
            button.textContent = text;
            button.id = id;
            button.addEventListener('click', action);
            buttonContainer.appendChild(button);
        }
        
        // Start the game
        function startGame() {
            clearScreen();
            clearButtons();
            gameState.screen = "character";
            
            addText("CHARACTER CREATION", "prompt");
            addText("What is your name, adventurer?");
            addText("(Type your name and press Enter)");
            
            // Create input field for character name
            const inputLine = document.createElement('div');
            inputLine.className = 'input-line';
            
            const cursor = document.createElement('div');
            cursor.className = 'cursor';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.style.background = 'black';
            input.style.color = '#0f0';
            input.style.border = 'none';
            input.style.outline = 'none';
            input.style.fontFamily = "'Courier New', monospace";
            input.style.fontSize = '16px';
            input.style.width = '200px';
            
            inputLine.appendChild(cursor);
            inputLine.appendChild(input);
            gameScreen.appendChild(inputLine);
            
            input.focus();
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (input.value.trim() !== "") {
                        gameState.player.name = input.value.trim();
                        createCharacter();
                    }
                }
            });
        }
        
        // Create character
        function createCharacter() {
            clearScreen();
            clearButtons();
            
            addText(`Welcome, ${gameState.player.name}!`, "prompt");
            addText("You stand in the town of Britain, the capital of Sosaria.");
            addText("The townsfolk speak of Mondain's evil spreading across the land.");
            addText("The king has called for heroes to find the Gem of Immortality");
            addText("and defeat the wizard Mondain.");
            addText("");
            addText("What would you like to do?");
            
            addButton("TOWN SQUARE", townSquare);
            addButton("INVENTORY", showInventory);
            addButton("CHARACTER", showCharacter);
            addButton("TRAVEL", travel);
            addButton("QUESTS", questInfo);
            
            gameState.screen = "main";
            updateStatusBar();
        }
        
        // Town square main hub
        function townSquare() {
            clearScreen();
            clearButtons();
            
            const currentTown = gameState.world.towns.find(t => t.name === gameState.player.location);
            
            addText(`${gameState.player.location.toUpperCase()} TOWN SQUARE`, "location-text");
            addText(`You are in the ${currentTown.type} town of ${gameState.player.location}.`);
            addText("");
            
            // Show available shops based on town type
            currentTown.shops.forEach(shop => {
                switch(shop) {
                    case 'inn':
                        addButton("VISIT INN", visitInn);
                        break;
                    case 'weapons':
                        addButton("WEAPON SHOP", visitWeaponShop);
                        break;
                    case 'armor':
                        addButton("ARMOR SHOP", visitArmorShop);
                        break;
                    case 'magic':
                        addButton("MAGIC SHOP", visitMagicShop);
                        break;
                    case 'training':
                        addButton("TRAINING HALL", visitTraining);
                        break;
                    case 'general':
                        addButton("GENERAL STORE", visitGeneralStore);
                        break;
                    case 'library':
                        addButton("LIBRARY", visitLibrary);
                        break;
                    case 'tavern':
                        addButton("TAVERN", visitTavern);
                        break;
                }
            });
            
            // Special town quest
            addButton("TOWN QUEST", function() {
                startTownQuest(currentTown.quest);
            });
            
            addButton("EXPLORE DUNGEON", exploreDungeon);
            addButton("RETURN", createCharacter);
        }
        
        // Show inventory
        function showInventory() {
            clearScreen();
            clearButtons();
            
            addText("INVENTORY", "prompt");
            addText("────────────────");
            
            if (gameState.player.inventory.length === 0) {
                addText("Your inventory is empty.");
            } else {
                addText(`Items (${gameState.player.inventory.length}/${gameState.player.inventoryLimit}):`);
                gameState.player.inventory.forEach((item, index) => {
                    addText(`${index + 1}. ${item}`, "inventory-item");
                });
            }
            
            addText("");
            addText("Equipped:");
            addText(`Weapon: ${gameState.player.weapon}`);
            addText(`Armor: ${gameState.player.armor}`);
            
            addButton("USE ITEM", useItem);
            addButton("DROP ITEM", dropItem);
            addButton("RETURN", createCharacter);
        }
        
        // Use item from inventory
        function useItem() {
            clearScreen();
            clearButtons();
            
            addText("USE ITEM", "prompt");
            addText("Select an item to use:");
            
            gameState.player.inventory.forEach((item, index) => {
                if (item.includes("Potion") || item.includes("Antidote") || item.includes("Bomb")) {
                    addButton(`${item}`, function() {
                        if (item === "Healing Potion") {
                            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 30);
                            addText(`You drink the ${item}, healing 30 health.`, "item-text");
                            removeFromInventory(item);
                        } else if (item === "Strength Potion") {
                            gameState.player.strength += 5;
                            addText(`You drink the ${item}, gaining +5 strength!`, "item-text");
                            gameState.buffs.push({ type: "strength", value: 5, duration: 3 });
                            removeFromInventory(item);
                        } else if (item === "Smoke Bomb") {
                            if (gameState.inCombat) {
                                addText("You throw a smoke bomb and escape!", "item-text");
                                gameState.inCombat = false;
                                removeFromInventory(item);
                                setTimeout(createCharacter, 1000);
                                return;
                            } else {
                                addText("No need for that now.", "item-text");
                            }
                        }
                        updateStatusBar();
                        setTimeout(showInventory, 1500);
                    });
                }
            });
            
            addButton("CANCEL", showInventory);
        }
        
        // Drop item from inventory
        function dropItem() {
            clearScreen();
            clearButtons();
            
            addText("DROP ITEM", "prompt");
            addText("Select an item to drop:");
            
            gameState.player.inventory.forEach((item, index) => {
                addButton(`${item}`, function() {
                    removeFromInventory(item);
                    addText(`You dropped ${item}.`, "item-text");
                    setTimeout(showInventory, 1000);
                });
            });
            
            addButton("CANCEL", showInventory);
        }
        
        // Remove item from inventory
        function removeFromInventory(itemName) {
            const index = gameState.player.inventory.indexOf(itemName);
            if (index > -1) {
                gameState.player.inventory.splice(index, 1);
            }
        }
        
        // Show character sheet
        function showCharacter() {
            clearScreen();
            clearButtons();
            
            addText("CHARACTER SHEET", "prompt");
            addText("────────────────");
            addText(`Name: ${gameState.player.name}`);
            addText(`Level: ${gameState.player.level}`);
            addText(`Experience: ${gameState.player.experience}/${gameState.player.nextLevelExp}`);
            addText("");
            addText("Stats:");
            addText(`Health: ${gameState.player.health}/${gameState.player.maxHealth}`);
            addText(`Strength: ${gameState.player.strength}`);
            addText(`Dexterity: ${gameState.player.dexterity}`);
            addText(`Intelligence: ${gameState.player.intelligence}`);
            addText("");
            addText("Abilities:");
            if (gameState.player.abilities.length === 0) {
                addText("None learned yet.");
            } else {
                gameState.player.abilities.forEach(ability => {
                    addText(`• ${ability}`, "ability-text");
                });
            }
            
            addText("");
            addText("Active Buffs:");
            if (gameState.buffs.length === 0) {
                addText("None");
            } else {
                gameState.buffs.forEach(buff => {
                    addText(`• ${buff.type} +${buff.value} (${buff.duration} turns)`);
                });
            }
            
            addButton("RETURN", createCharacter);
        }
        
        // Visit inn
        function visitInn() {
            clearScreen();
            clearButtons();
            
            addText(`${gameState.player.location.toUpperCase()} INN`, "location-text");
            addText("The innkeeper greets you warmly.");
            addText("'A room for the night will cost 10 gold pieces.'");
            addText("You currently have " + gameState.player.gold + " gold.");
            
            if (gameState.player.health < gameState.player.maxHealth) {
                addText("Resting will restore your health.");
            }
            
            addButton("REST (10 GOLD)", function() {
                if (gameState.player.gold >= 10) {
                    gameState.player.gold -= 10;
                    gameState.player.health = gameState.player.maxHealth;
                    // Clear temporary buffs when resting
                    gameState.buffs = gameState.buffs.filter(buff => buff.duration > 10); // Keep only long-lasting buffs
                    addText("You rest peacefully and feel refreshed.");
                    updateStatusBar();
                } else {
                    addText("You don't have enough gold for a room.");
                }
                setTimeout(visitInn, 1500);
            });
            
            addButton("LISTEN FOR RUMORS", function() {
                const rumors = [
                    "I heard there's a dragon in the northern mountains.",
                    "The king is offering a reward for brave adventurers.",
                    "Strange lights have been seen in the old ruins.",
                    "Bandits are attacking travelers on the eastern road.",
                    "A powerful artifact was lost in the Deceit dungeon."
                ];
                addText("");
                addText(`Innkeeper: "${rumors[Math.floor(Math.random() * rumors.length)]}"`);
            });
            
            addButton("LEAVE INN", townSquare);
        }
        
        // Visit weapon shop
        function visitWeaponShop() {
            clearScreen();
            clearButtons();
            
            addText("WEAPON SHOP", "location-text");
            addText("The blacksmith shows you his wares:");
            
            gameState.items.weapons.forEach(weapon => {
                if (weapon.price <= gameState.player.gold * 3) { // Show only somewhat affordable items
                    const currentBonus = weapon.name === gameState.player.weapon ? " (EQUIPPED)" : "";
                    addText(`${weapon.name}: ${weapon.price} gold - Strength +${weapon.strength}${currentBonus}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.weapons.forEach(weapon => {
                if (weapon.price <= gameState.player.gold && weapon.name !== gameState.player.weapon) {
                    addButton(`BUY ${weapon.name}`, function() {
                        if (gameState.player.gold >= weapon.price) {
                            gameState.player.gold -= weapon.price;
                            gameState.player.weapon = weapon.name;
                            gameState.player.strength += weapon.strength;
                            if (weapon.special) {
                                addText(`This ${weapon.name} has a special property: ${weapon.special}!`, "item-text");
                            }
                            addText(`You purchase a ${weapon.name}.`, "item-text");
                            updateStatusBar();
                            setTimeout(visitWeaponShop, 1500);
                        }
                    });
                }
            });
            
            addButton("SELL CURRENT WEAPON", function() {
                if (gameState.player.weapon !== "Dagger") {
                    const currentWeapon = gameState.items.weapons.find(w => w.name === gameState.player.weapon);
                    const sellPrice = Math.floor(currentWeapon.price * 0.5);
                    gameState.player.gold += sellPrice;
                    gameState.player.strength -= currentWeapon.strength;
                    gameState.player.weapon = "Dagger";
                    addText(`You sold your ${currentWeapon.name} for ${sellPrice} gold.`, "item-text");
                    updateStatusBar();
                    setTimeout(visitWeaponShop, 1500);
                } else {
                    addText("You can't sell your starting dagger.");
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit armor shop
        function visitArmorShop() {
            clearScreen();
            clearButtons();
            
            addText("ARMOR SHOP", "location-text");
            addText("The armorer presents his armor:");
            
            gameState.items.armors.forEach(armor => {
                if (armor.price <= gameState.player.gold * 3) {
                    const currentBonus = armor.name === gameState.player.armor ? " (EQUIPPED)" : "";
                    addText(`${armor.name}: ${armor.price} gold - Defense +${armor.defense}${currentBonus}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.armors.forEach(armor => {
                if (armor.price <= gameState.player.gold && armor.name !== gameState.player.armor) {
                    addButton(`BUY ${armor.name}`, function() {
                        if (gameState.player.gold >= armor.price) {
                            gameState.player.gold -= armor.price;
                            gameState.player.armor = armor.name;
                            gameState.player.maxHealth += armor.defense * 2;
                            gameState.player.health += armor.defense * 2;
                            if (armor.special) {
                                addText(`This ${armor.name} has a special property: ${armor.special}!`, "item-text");
                            }
                            addText(`You purchase ${armor.name}.`, "item-text");
                            updateStatusBar();
                            setTimeout(visitArmorShop, 1500);
                        }
                    });
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit magic shop
        function visitMagicShop() {
            clearScreen();
            clearButtons();
            
            addText("MAGIC SHOP", "location-text");
            addText("The mage shows you magical items:");
            
            gameState.items.consumables.forEach(item => {
                if (item.price <= gameState.player.gold * 2) {
                    addText(`${item.name}: ${item.price} gold - ${item.effect}`);
                }
            });
            
            addText("");
            addText(`You have ${gameState.player.gold} gold.`);
            
            gameState.items.consumables.forEach(item => {
                if (item.price <= gameState.player.gold) {
                    addButton(`BUY ${item.name}`, function() {
                        if (gameState.player.gold >= item.price) {
                            if (gameState.player.inventory.length < gameState.player.inventoryLimit) {
                                gameState.player.gold -= item.price;
                                gameState.player.inventory.push(item.name);
                                addText(`You purchase a ${item.name}.`, "item-text");
                                updateStatusBar();
                            } else {
                                addText("Your inventory is full!");
                            }
                            setTimeout(visitMagicShop, 1500);
                        }
                    });
                }
            });
            
            addButton("LEARN ABILITY", function() {
                if (gameState.player.gold >= 100) {
                    gameState.player.gold -= 100;
                    const abilities = ["Power Attack", "Double Strike", "Counter Attack", "Shield Block", "Dodge"];
                    const newAbility = abilities[Math.floor(Math.random() * abilities.length)];
                    if (!gameState.player.abilities.includes(newAbility)) {
                        gameState.player.abilities.push(newAbility);
                        addText(`You learned ${newAbility}!`, "ability-text");
                    } else {
                        addText("You already know that ability.");
                        gameState.player.gold += 100;
                    }
                    updateStatusBar();
                    setTimeout(visitMagicShop, 1500);
                } else {
                    addText("You need 100 gold to learn an ability.");
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit general store
        function visitGeneralStore() {
            clearScreen();
            clearButtons();
            
            addText("GENERAL STORE", "location-text");
            addText("The shopkeeper offers various supplies:");
            
            const supplies = [
                { name: "Torch", price: 5, desc: "Lights dark areas" },
                { name: "Rope", price: 10, desc: "Useful for climbing" },
                { name: "Rations", price: 3, desc: "Food for traveling" },
                { name: "Waterskin", price: 8, desc: "Holds water" }
            ];
            
            supplies.forEach(supply => {
                addText(`${supply.name}: ${supply.price} gold - ${supply.desc}`);
            });
            
            addButton("BUY TORCH", function() {
                if (gameState.player.gold >= 5) {
                    gameState.player.gold -= 5;
                    gameState.player.inventory.push("Torch");
                    addText("You buy a torch.", "item-text");
                    updateStatusBar();
                }
            });
            
            addButton("LEAVE SHOP", townSquare);
        }
        
        // Visit training hall
        function visitTraining() {
            clearScreen();
            clearButtons();
            
            addText("TRAINING HALL", "location-text");
            addText("The trainer can help you improve your skills:");
            
            addText(`Current Strength: ${gameState.player.strength}`);
            addText(`Current Dexterity: ${gameState.player.dexterity}`);
            addText("");
            addText("Training costs 50 gold per stat point.");
            
            addButton("TRAIN STRENGTH (50 GOLD)", function() {
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    gameState.player.strength += 1;
                    addText("You train your strength. +1 Strength!", "ability-text");
                    updateStatusBar();
                    setTimeout(visitTraining, 1500);
                } else {
                    addText("You need 50 gold to train.");
                }
            });
            
            addButton("TRAIN DEXTERITY (50 GOLD)", function() {
                if (gameState.player.gold >= 50) {
                    gameState.player.gold -= 50;
                    gameState.player.dexterity += 1;
                    addText("You train your dexterity. +1 Dexterity!", "ability-text");
                    updateStatusBar();
                    setTimeout(visitTraining, 1500);
                } else {
                    addText("You need 50 gold to train.");
                }
            });
            
            addButton("LEAVE", townSquare);
        }
        
        // Start town quest
        function startTownQuest(questType) {
            clearScreen();
            clearButtons();
            
            addText("TOWN QUEST", "location-text");
            
            const quests = {
                king: { 
                    title: "The King's Request",
                    desc: "The king needs you to clear bandits from the nearby road.",
                    reward: 100,
                    enemy: "Bandit"
                },
                mage: {
                    title: "Mage's Research",
                    desc: "A local mage needs rare herbs from the forest.",
                    reward: 75,
                    enemy: "Goblin"
                },
                knight: {
                    title: "Knight's Challenge",
                    desc: "Prove your worth by defeating a training knight.",
                    reward: 50,
                    enemy: "Knight"
                },
                merchant: {
                    title: "Merchant's Escort",
                    desc: "Escort a merchant caravan safely to the next town.",
                    reward: 80,
                    enemy: "Bandit"
                }
            };
            
            const quest = quests[questType] || quests.king;
            
            addText(quest.title);
            addText(quest.desc);
            addText("");
            addText(`Reward: ${quest.reward} gold`);
            
            addButton("ACCEPT QUEST", function() {
                addText("");
                addText("You set out on your quest...");
                // Start combat with quest enemy
                const enemyTemplate = gameState.enemies.find(e => e.name === quest.enemy);
                gameState.currentEnemy = {...enemyTemplate};
                gameState.inCombat = true;
                gameState.currentEnemy.questEnemy = true;
                gameState.currentEnemy.questReward = quest.reward;
                
                setTimeout(() => {
                    clearScreen();
                    addText(`You encounter a ${gameState.currentEnemy.name}!`, "combat-text");
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                }, 1500);
            });
            
            addButton("DECLINE", townSquare);
        }
        
        // Explore dungeon
        function exploreDungeon() {
            clearScreen();
            clearButtons();
            
            addText("DUNGEON ENTRANCE", "location-text");
            addText("You stand before a dark dungeon entrance.");
            
            // Show available dungeons based on player level
            const availableDungeons = gameState.world.dungeons.filter(d => d.level <= gameState.player.level);
            
            if (availableDungeons.length === 0) {
                addText("No dungeons are accessible at your level.");
                addButton("RETURN", townSquare);
                return;
            }
            
            availableDungeons.forEach(dungeon => {
                addButton(`ENTER ${dungeon.name} (Level ${dungeon.level})`, function() {
                    enterDungeon(dungeon);
                });
            });
            
            addButton("RETURN", townSquare);
        }
        
        // Enter dungeon
        function enterDungeon(dungeon) {
            clearScreen();
            clearButtons();
            
            addText(`ENTERING ${dungeon.name.toUpperCase()}`, "location-text");
            addText(`This dungeon is located ${dungeon.location}.`);
            addText(`Legend says a ${dungeon.boss} guards ${dungeon.reward}.`);
            
            // Multiple encounters in dungeon
            const encounterCount = 2 + Math.floor(Math.random() * 3);
            
            addText("");
            addText("You venture deep into the dungeon...");
            
            setTimeout(() => {
                startDungeonEncounter(dungeon, encounterCount, 1);
            }, 2000);
        }
        
        // Dungeon encounter sequence
        function startDungeonEncounter(dungeon, totalEncounters, currentEncounter) {
            clearScreen();
            
            if (currentEncounter > totalEncounters) {
                // Boss fight
                addText("You reach the deepest chamber of the dungeon!", "location-text");
                addText(`Before you stands the ${dungeon.boss}!`, "combat-text");
                
                const bossEnemy = gameState.enemies.find(e => e.name === dungeon.boss) || gameState.enemies[2]; // Fallback to Troll
                gameState.currentEnemy = {...bossEnemy};
                gameState.currentEnemy.health *= 1.5; // Boost boss health
                gameState.currentEnemy.strength += 5; // Boost boss strength
                gameState.currentEnemy.dungeonBoss = true;
                gameState.currentEnemy.dungeonReward = dungeon.reward;
                
                gameState.inCombat = true;
                
                setTimeout(() => {
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                }, 1500);
                
                return;
            }
            
            addText(`Dungeon Chamber ${currentEncounter}/${totalEncounters}`, "location-text");
            
            // Regular encounter
            const regularEnemies = gameState.enemies.filter(e => !["Dragon", "Mondain"].includes(e.name));
            const enemyTemplate = {...regularEnemies[Math.floor(Math.random() * regularEnemies.length)]};
            gameState.currentEnemy = enemyTemplate;
            gameState.currentEnemy.health = Math.floor(enemyTemplate.health * (0.8 + currentEncounter * 0.2));
            gameState.currentEnemy.strength = Math.floor(enemyTemplate.strength * (0.9 + currentEncounter * 0.1));
            gameState.inCombat = true;
            
            setTimeout(() => {
                addText(`A ${gameState.currentEnemy.name} blocks your path!`, "combat-text");
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1500);
        }
        
        // Travel to different location
        function travel() {
            clearScreen();
            clearButtons();
            
            addText("TRAVEL", "location-text");
            addText("Where would you like to travel?");
            addText("");
            
            // Group towns by region
            const regions = {
                "Central Sosaria": ["Britain", "Trinsic", "Paws", "Minoc"],
                "Eastern Lands": ["Moonglow", "Vesper", "Cove"],
                "Western Coast": ["Skara Brae", "Buccaneer's Den", "Daggerfall"],
                "Northern Frontiers": ["Yew", "Borderkeep", "Wind", "Serpent's Hold"],
                "Southern Ruins": ["Magincia"]
            };
            
            Object.entries(regions).forEach(([region, towns]) => {
                addText(`${region}:`);
                towns.forEach(town => {
                    if (town !== gameState.player.location) {
                        addButton(town, function() {
                            gameState.player.location = town;
                            
                            // Random encounter chance
                            const encounterChance = Math.random();
                            
                            clearScreen();
                            clearButtons();
                            
                            addText(`You travel to ${town}.`, "location-text");
                            
                            if (encounterChance < 0.4) {
                                // Combat encounter
                                startWildernessEncounter();
                            } else {
                                addText("The journey is uneventful.");
                                addButton("CONTINUE", createCharacter);
                            }
                            
                            updateStatusBar();
                        });
                    }
                });
                addText("");
            });
            
            addButton("CANCEL", createCharacter);
        }
        
        // Start wilderness encounter
        function startWildernessEncounter() {
            const encounterType = gameState.world.wildernessEncounters[Math.floor(Math.random() * gameState.world.wildernessEncounters.length)];
            
            addText(`You encounter ${encounterType}!`, "combat-text");
            
            // Map encounter to enemy type
            let enemyType;
            switch(encounterType) {
                case "bandits":
                case "brigands":
                    enemyType = "Bandit";
                    break;
                case "wolves":
                case "wild dogs":
                    enemyType = "Goblin"; // Use Goblin stats for animals
                    break;
                case "giant rats":
                    enemyType = "Goblin";
                    break;
                case "bears":
                case "wild boars":
                    enemyType = "Orc";
                    break;
                case "harpies":
                    enemyType = "Skeleton";
                    break;
                case "giant snakes":
                    enemyType = "Troll";
                    break;
                case "specters":
                    enemyType = "Wizard";
                    break;
                default:
                    enemyType = "Goblin";
            }
            
            const enemyTemplate = gameState.enemies.find(e => e.name === enemyType);
            gameState.currentEnemy = {...enemyTemplate};
            gameState.inCombat = true;
            
            setTimeout(() => {
                addText(`A wild ${gameState.currentEnemy.name} attacks!`, "combat-text");
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1500);
        }
        
        // Quest information
        function questInfo() {
            clearScreen();
            clearButtons();
            
            addText("QUEST INFORMATION", "prompt");
            
            if (gameState.player.quest === 0) {
                addText("The king has tasked you with finding the Gem of Immortality.");
                addText("Rumors say it's hidden in a dungeon near the town of Yew.");
                addText("Travel to different towns to gather information and supplies.");
                addText("");
                addText("Main Objective: Find the Gem of Immortality");
                addText("Current Task: Gain strength and explore dungeons");
                gameState.player.quest = 1;
            } else if (gameState.player.quest === 1) {
                addText("You've learned the Gem is guarded by powerful creatures.");
                addText("You'll need to be strong to defeat them.");
                addText("Some say Mondain himself protects the gem in his fortress.");
                addText("");
                addText("Main Objective: Find the Gem of Immortality");
                addText("Current Task: Explore the Hythloth dungeon");
            } else if (gameState.player.quest === 2) {
                addText("You have the Gem of Immortality!");
                addText("Now you must confront Mondain in his fortress.");
                addText("Travel to the far north to find his lair.");
                addText("");
                addText("Main Objective: Defeat Mondain");
                addText("Current Task: Challenge Mondain in Hythloth");
            }
            
            // Show side quests if any
            addText("");
            addText("Available in current town:");
            const currentTown = gameState.world.towns.find(t => t.name === gameState.player.location);
            addText(`- ${currentTown.quest} quest at the town square`);
            
            addButton("CONTINUE", createCharacter);
        }
        
        // Show combat options with expanded depth
        function showCombatOptions() {
            clearButtons();
            
            addButton("ATTACK", playerAttack);
            addButton("POWER ATTACK", powerAttack);
            addButton("DEFEND", playerDefend);
            addButton("USE ITEM", combatUseItem);
            
            // Show learned abilities
            gameState.player.abilities.forEach(ability => {
                addButton(ability.toUpperCase(), function() {
                    useAbility(ability);
                });
            });
            
            addButton("FLEE", attemptFlee);
            
            // Show combat stance option
            addButton(`STANCE: ${gameState.player.combatStance.toUpperCase()}`, changeStance);
        }
        
        // Change combat stance
        function changeStance() {
            clearScreen();
            
            const stances = ["balanced", "aggressive", "defensive"];
            const currentIndex = stances.indexOf(gameState.player.combatStance);
            gameState.player.combatStance = stances[(currentIndex + 1) % stances.length];
            
            addText(`You change to ${gameState.player.combatStance} stance.`, "combat-text");
            
            setTimeout(() => {
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            }, 1000);
        }
        
        // Player regular attack
        function playerAttack() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.player.strength) + 5;
            
            // Stance modifiers
            if (gameState.player.combatStance === "aggressive") {
                damage = Math.floor(damage * 1.3);
            } else if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.8);
            }
            
            // Dexterity affects hit chance
            const hitChance = 70 + gameState.player.dexterity;
            if (Math.random() * 100 > hitChance) {
                addText(`You miss the ${gameState.currentEnemy.name}!`, "combat-text");
            } else {
                gameState.currentEnemy.health -= damage;
                addText(`You attack the ${gameState.currentEnemy.name} for ${damage} damage!`, "combat-text");
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy attacks back
            enemyAttack();
        }
        
        // Power attack (uses more energy but deals more damage)
        function powerAttack() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.player.strength * 1.5) + 10;
            
            // Higher miss chance for power attack
            const hitChance = 50 + gameState.player.dexterity;
            if (Math.random() * 100 > hitChance) {
                addText(`Your power attack misses the ${gameState.currentEnemy.name}!`, "combat-text");
            } else {
                gameState.currentEnemy.health -= damage;
                addText(`You power attack the ${gameState.currentEnemy.name} for ${damage} damage!`, "combat-text");
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy gets a free attack (power attack leaves you open)
            enemyAttack();
        }
        
        // Use ability in combat
        function useAbility(ability) {
            clearScreen();
            
            switch(ability) {
                case "Double Strike":
                    let damage1 = Math.floor(Math.random() * gameState.player.strength * 0.7) + 3;
                    let damage2 = Math.floor(Math.random() * gameState.player.strength * 0.7) + 3;
                    gameState.currentEnemy.health -= (damage1 + damage2);
                    addText(`You strike twice for ${damage1} and ${damage2} damage!`, "ability-text");
                    break;
                    
                case "Counter Attack":
                    addText("You prepare to counter the enemy's attack...", "ability-text");
                    // Counter attack will trigger during enemy attack
                    gameState.player.counterReady = true;
                    break;
                    
                case "Shield Block":
                    addText("You raise your defense, reducing next damage by 50%", "ability-text");
                    gameState.player.defenseBoost = true;
                    break;
                    
                default:
                    addText(`You use ${ability}!`, "ability-text");
                    let damage = Math.floor(Math.random() * gameState.player.strength) + 8;
                    gameState.currentEnemy.health -= damage;
                    addText(`You deal ${damage} damage!`, "ability-text");
            }
            
            if (gameState.currentEnemy.health <= 0) {
                endCombat(true);
                return;
            }
            
            addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
            
            // Enemy attacks
            enemyAttack();
        }
        
        // Enemy attacks with abilities
        function enemyAttack() {
            // Check for counter attack
            if (gameState.player.counterReady) {
                const counterDamage = Math.floor(Math.random() * gameState.player.strength) + 5;
                gameState.currentEnemy.health -= counterDamage;
                addText(`You counter attack for ${counterDamage} damage!`, "ability-text");
                gameState.player.counterReady = false;
                
                if (gameState.currentEnemy.health <= 0) {
                    endCombat(true);
                    return;
                }
                
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
                return;
            }
            
            let damage = Math.floor(Math.random() * gameState.currentEnemy.strength) + 3;
            
            // Apply defense boost if active
            if (gameState.player.defenseBoost) {
                damage = Math.floor(damage * 0.5);
                gameState.player.defenseBoost = false;
                addText("Your defense reduces the damage!", "ability-text");
            }
            
            // Stance modifiers
            if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.7);
            } else if (gameState.player.combatStance === "aggressive") {
                damage = Math.floor(damage * 1.2);
            }
            
            // Check for enemy abilities
            if (gameState.currentEnemy.abilities && Math.random() < 0.3) {
                const ability = gameState.currentEnemy.abilities[Math.floor(Math.random() * gameState.currentEnemy.abilities.length)];
                
                switch(ability) {
                    case "fireball":
                        damage = Math.floor(damage * 1.5);
                        addText(`The ${gameState.currentEnemy.name} casts Fireball!`, "combat-text");
                        break;
                    case "regenerate":
                        const heal = Math.floor(gameState.currentEnemy.maxHealth * 0.1);
                        gameState.currentEnemy.health = Math.min(gameState.currentEnemy.maxHealth, gameState.currentEnemy.health + heal);
                        addText(`The ${gameState.currentEnemy.name} regenerates ${heal} health!`, "combat-text");
                        break;
                    case "life drain":
                        const drain = Math.floor(damage * 0.5);
                        gameState.currentEnemy.health += drain;
                        addText(`The ${gameState.currentEnemy.name} drains your life, healing ${drain} health!`, "combat-text");
                        break;
                }
            }
            
            gameState.player.health -= damage;
            
            addText(`The ${gameState.currentEnemy.name} attacks you for ${damage} damage!`, "combat-text");
            addText(`Your Health: ${gameState.player.health}/${gameState.player.maxHealth}`, "combat-text");
            
            updateStatusBar();
            
            if (gameState.player.health <= 0) {
                endCombat(false);
                return;
            }
            
            // Update buff durations
            gameState.buffs = gameState.buffs.filter(buff => {
                buff.duration--;
                return buff.duration > 0;
            });
            
            showCombatOptions();
        }
        
        // Player defends
        function playerDefend() {
            clearScreen();
            
            let damage = Math.floor(Math.random() * gameState.currentEnemy.strength * 0.5);
            
            // Extra defense in defensive stance
            if (gameState.player.combatStance === "defensive") {
                damage = Math.floor(damage * 0.5);
            }
            
            gameState.player.health -= damage;
            
            addText(`You brace for impact. The ${gameState.currentEnemy.name} attacks you for ${damage} damage!`, "combat-text");
            addText(`Your Health: ${gameState.player.health}/${gameState.player.maxHealth}`, "combat-text");
            
            // Heal a small amount when defending
            const heal = Math.floor(gameState.player.maxHealth * 0.05);
            gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + heal);
            addText(`You recover ${heal} health while defending.`, "combat-text");
            
            updateStatusBar();
            
            if (gameState.player.health <= 0) {
                endCombat(false);
                return;
            }
            
            showCombatOptions();
        }
        
        // Use item in combat
        function combatUseItem() {
            clearScreen();
            clearButtons();
            
            addText("USE ITEM IN COMBAT", "prompt");
            
            const combatItems = gameState.player.inventory.filter(item => 
                item.includes("Potion") || item.includes("Antidote") || item.includes("Bomb")
            );
            
            if (combatItems.length === 0) {
                addText("No usable items in inventory.");
                addButton("BACK", function() {
                    addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                    showCombatOptions();
                });
                return;
            }
            
            combatItems.forEach(item => {
                addButton(`${item}`, function() {
                    if (item === "Healing Potion") {
                        gameState.player.health = Math.min(gameState.player.maxHealth, gameState.player.health + 30);
                        addText(`You drink a Healing Potion, restoring 30 health.`, "item-text");
                        removeFromInventory(item);
                    } else if (item === "Strength Potion") {
                        gameState.player.strength += 5;
                        addText(`You drink a Strength Potion, gaining +5 strength!`, "item-text");
                        gameState.buffs.push({ type: "strength", value: 5, duration: 3 });
                        removeFromInventory(item);
                    } else if (item === "Smoke Bomb") {
                        addText("You throw a smoke bomb and escape!", "item-text");
                        gameState.inCombat = false;
                        removeFromInventory(item);
                        setTimeout(createCharacter, 1500);
                        return;
                    }
                    
                    updateStatusBar();
                    
                    // Enemy still attacks
                    setTimeout(() => {
                        addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                        enemyAttack();
                    }, 1000);
                });
            });
            
            addButton("BACK", function() {
                addText(`Enemy Health: ${gameState.currentEnemy.health}`, "combat-text");
                showCombatOptions();
            });
        }
        
        // Attempt to flee
        function attemptFlee() {
            clearScreen();
            
            // Base flee chance is 50%, increased by dexterity
            const fleeChance = 50 + gameState.player.dexterity;
            
            if (Math.random() * 100 < fleeChance) {
                addText("You successfully flee from battle!", "combat-text");
                gameState.inCombat = false;
                
                // Take some damage while fleeing
                const fleeDamage = Math.floor(Math.random() * gameState.currentEnemy.strength);
                gameState.player.health -= fleeDamage;
                if (fleeDamage > 0) {
                    addText(`You take ${fleeDamage} damage while fleeing.`, "combat-text");
                }
                
                updateStatusBar();
                
                if (gameState.player.health <= 0) {
                    endCombat(false);
                    return;
                }
                
                addButton("CONTINUE", createCharacter);
            } else {
                addText("You failed to flee!", "combat-text");
                enemyAttack();
            }
        }
        
        // End combat with expanded rewards
        function endCombat(playerWon) {
            clearButtons();
            
            if (playerWon) {
                const goldEarned = gameState.currentEnemy.gold;
                const expEarned = gameState.currentEnemy.exp;
                
                gameState.player.gold += goldEarned;
                gameState.player.experience += expEarned;
                
                addText(`You defeated the ${gameState.currentEnemy.name}!`, "combat-text");
                addText(`You earned ${goldEarned} gold and ${expEarned} experience.`, "item-text");
                
                // Special rewards
                if (gameState.currentEnemy.questEnemy) {
                    const questReward = gameState.currentEnemy.questReward;
                    gameState.player.gold += questReward;
                    addText(`Quest completed! You earn an additional ${questReward} gold.`, "item-text");
                }
                
                if (gameState.currentEnemy.dungeonBoss) {
                    const dungeonReward = gameState.currentEnemy.dungeonReward;
                    addText(`You found ${dungeonReward}!`, "item-text");
                    
                    // Add reward to inventory if it's an item
                    if (!gameState.player.inventory.includes(dungeonReward) && 
                        gameState.player.inventory.length < gameState.player.inventoryLimit) {
                        gameState.player.inventory.push(dungeonReward);
                    }
                    
                    // Check if this is the Gem of Immortality
                    if (dungeonReward === "Gem of Immortality") {
                        gameState.player.quest = 2;
                        addText("You now possess the Gem of Immortality!", "prompt");
                        addText("Now you must defeat Mondain himself!", "prompt");
                    }
                }
                
                // Check for level up
                checkLevelUp();
                
                // Special for Mondain
                if (gameState.currentEnemy.name === "Mondain") {
                    addText("", "prompt");
                    addText("╔══════════════════════════════════════╗", "prompt");
                    addText("║      C O N G R A T U L A T I O N S   ║", "prompt");
                    addText("╚══════════════════════════════════════╝", "prompt");
                    addText("You have defeated Mondain and saved Sosaria!", "prompt");
                    addText("The Gem of Immortality is destroyed and peace returns.", "prompt");
                    addText("You are now hailed as the greatest hero in the land!", "prompt");
                    addText("Thank you for playing Ultima I!", "prompt");
                    
                    addButton("PLAY AGAIN", function() {
                        location.reload();
                    });
                    
                    return;
                }
                
                // Continue dungeon if in one
                if (gameState.currentEnemy.dungeonBoss) {
                    addButton("LEAVE DUNGEON", createCharacter);
                } else if (gameState.currentEnemy.dungeonEncounter) {
                    // Continue to next dungeon encounter
                    const nextEncounter = gameState.currentEnemy.dungeonEncounter + 1;
                    const totalEncounters = gameState.currentEnemy.totalEncounters;
                    const dungeon = gameState.currentEnemy.dungeon;
                    
                    addButton("CONTINUE EXPLORING", function() {
                        startDungeonEncounter(dungeon, totalEncounters, nextEncounter);
                    });
                } else {
                    addButton("CONTINUE", createCharacter);
                }
            } else {
                addText("You have been defeated...", "game-over");
                addText("Your adventure ends here.", "game-over");
                
                // Show final stats
                addText("");
                addText("Final Statistics:", "prompt");
                addText(`Level: ${gameState.player.level}`);
                addText(`Gold Collected: ${gameState.player.gold}`);
                addText(`Experience: ${gameState.player.experience}`);
                
                addButton("NEW GAME", function() {
                    location.reload();
                });
            }
            
            gameState.inCombat = false;
            updateStatusBar();
        }
        
        // Check for level up
        function checkLevelUp() {
            while (gameState.player.experience >= gameState.player.nextLevelExp) {
                gameState.player.level++;
                gameState.player.experience -= gameState.player.nextLevelExp;
                gameState.player.nextLevelExp = Math.floor(gameState.player.nextLevelExp * 1.5);
                
                // Stat increases
                gameState.player.maxHealth += 20 + gameState.player.level;
                gameState.player.health = gameState.player.maxHealth;
                gameState.player.strength += 2;
                gameState.player.dexterity += 1;
                gameState.player.intelligence += 1;
                
                addText(`╔══════════════════════════╗`, "xp-text");
                addText(`║  LEVEL UP: ${gameState.player.level.toString().padStart(2, ' ')}        ║`, "xp-text");
                addText(`╚══════════════════════════╝`, "xp-text");
                addText(`Health increased to ${gameState.player.maxHealth}`, "xp-text");
                addText(`Strength increased to ${gameState.player.strength}`, "xp-text");
                
                // Learn new ability every 3 levels
                if (gameState.player.level % 3 === 0) {
                    const newAbilities = ["Critical Strike", "Whirlwind Attack", "Second Wind", "Battle Cry", "Precision Strike"];
                    const availableAbilities = newAbilities.filter(a => !gameState.player.abilities.includes(a));
                    
                    if (availableAbilities.length > 0) {
                        const newAbility = availableAbilities[Math.floor(Math.random() * availableAbilities.length)];
                        gameState.player.abilities.push(newAbility);
                        addText(`Learned new ability: ${newAbility}!`, "ability-text");
                    }
                }
            }
        }
        
        // Show help
        function showHelp() {
            clearScreen();
            clearButtons();
            
            addText("ULTIMA I - HELP", "prompt");
            addText("════════════════════════════════");
            addText("");
            addText("OBJECTIVE: Defeat the wizard Mondain by finding");
            addText("the Gem of Immortality and confronting him.");
            addText("");
            addText("CORE SYSTEMS:");
            addText("- INVENTORY: Carry items, potions, and equipment");
            addText("- CHARACTER PROGRESSION: Gain XP, level up, learn abilities");
            addText("- EXPANDED WORLD: 15 towns, 7 dungeons, wilderness encounters");
            addText("- COMBAT DEPTH: Stances, abilities, enemy skills");
            addText("");
            addText("COMBAT ACTIONS:");
            addText("- ATTACK: Basic attack");
            addText("- POWER ATTACK: High damage, lower accuracy");
            addText("- DEFEND: Reduce damage, heal slightly");
            addText("- ABILITIES: Special moves learned through leveling");
            addText("- STANCES: Change between balanced/aggressive/defensive");
            addText("");
            addText("PROGRESSION:");
            addText("- Gain XP from defeating enemies");
            addText("- Level up to increase stats and learn abilities");
            addText("- Complete town quests for gold and rewards");
            addText("- Explore dungeons for powerful artifacts");
            
            addButton("BACK", function() {
                if (gameState.screen === "title") {
                    clearScreen();
                    clearButtons();
                    
                    addText("Welcome to Ultima I: The First Age of Darkness");
                    addText("A time of chaos and peril in the land of Sosaria.");
                    addText("Mondain the Wizard has created the Gem of Immortality,");
                    addText("plunging the world into eternal darkness.");
                    addText("Only a hero of true valor can defeat him and restore light.");
                    addText("");
                    addText("Press START to begin your quest...");
                    
                    addButton("START GAME", startGame);
                    addButton("HELP", showHelp);
                    addButton("CREDITS", showCredits);
                } else {
                    createCharacter();
                }
            });
        }
        
        // Show credits
        function showCredits() {
            clearScreen();
            clearButtons();
            
            addText("ULTIMA I - CREDITS", "prompt");
            addText("════════════════════════════════");
            addText("");
            addText("Original Game Design:");
            addText("Richard Garriott (Lord British)");
            addText("");
            addText("DOS Version:");
            addText("Origin Systems, 1987");
            addText("");
            addText("This Enhanced Web Adaptation:");
            addText("Created for educational purposes");
            addText("");
            addText("New Systems Added:");
            addText("- Inventory Management");
            addText("- Character Progression (Leveling, Abilities)");
            addText("- Expanded World (15 Towns, 7 Dungeons)");
            addText("- Combat Depth (Stances, Enemy Abilities)");
            addText("- Content Expansion (Quests, Items, Enemies)");
            addText("");
            addText("Inspired by the classic Ultima series");
            addText("that defined the computer RPG genre.");
            
            addButton("BACK", function() {
                if (gameState.screen === "title") {
                    clearScreen();
                    clearButtons();
                    
                    addText("Welcome to Ultima I: The First Age of Darkness");
                    addText("A time of chaos and peril in the land of Sosaria.");
                    addText("Mondain the Wizard has created the Gem of Immortality,");
                    addText("plunging the world into eternal darkness.");
                    addText("Only a hero of true valor can defeat him and restore light.");
                    addText("");
                    addText("Press START to begin your quest...");
                    
                    addButton("START GAME", startGame);
                    addButton("HELP", showHelp);
                    addButton("CREDITS", showCredits);
                } else {
                    createCharacter();
                }
            });
        }
        
        // Initialize the game when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
