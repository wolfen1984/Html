<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FATHERLAND LEGACY - DOS Text Adventure</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 18px;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            background-color: #111;
            position: relative;
            border-left: 2px solid #333;
            border-right: 2px solid #333;
        }
        
        #header {
            padding: 10px;
            border-bottom: 2px solid #0a0;
            text-align: center;
            background-color: #000;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header-controls {
            display: flex;
            gap: 10px;
        }
        
        #title {
            font-size: 24px;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            letter-spacing: 2px;
            margin: 5px 0;
            flex: 1;
        }
        
        #subtitle {
            font-size: 14px;
            color: #8f8;
            margin-bottom: 5px;
        }
        
        .control-btn {
            background-color: #222;
            border: 1px solid #0a0;
            color: #0f0;
            font-family: 'VT323', monospace;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        #screen-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #main-screen {
            flex: 3;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }
        
        #side-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        #screen {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        
        .screen-content {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .text-output {
            flex: 1;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .command-line {
            display: flex;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px dashed #333;
        }
        
        .prompt {
            color: #0f0;
            margin-right: 8px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .input-line {
            flex: 1;
            background: transparent;
            border: none;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 18px;
            outline: none;
            caret-color: #0f0;
            min-width: 0;
        }
        
        .button-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        
        .game-button {
            background-color: #222;
            border: 1px solid #0a0;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .game-button:hover, .game-button:focus {
            background-color: #0a0;
            color: #000;
        }
        
        .game-button:active {
            background-color: #0f0;
            transform: scale(0.98);
        }
        
        .class-button {
            border-left: 4px solid;
            padding-left: 10px;
        }
        
        .investigator { border-left-color: #00aaff; }
        .soldier { border-left-color: #ff5500; }
        .diplomat { border-left-color: #ffcc00; }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-top: 2px solid #0a0;
            background-color: #000;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .status-label {
            font-size: 12px;
            color: #8f8;
            margin-bottom: 2px;
        }
        
        .status-value {
            color: #0f0;
        }
        
        .side-section {
            padding: 10px;
            border-bottom: 1px solid #333;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .side-section h3 {
            margin-top: 0;
            color: #0a0;
            border-bottom: 1px solid #0a0;
            padding-bottom: 5px;
            font-size: 16px;
        }
        
        #inventory-items {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .inventory-item {
            background-color: #222;
            border: 1px solid #333;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .inventory-item:hover {
            border-color: #0a0;
            background-color: #2a2a2a;
        }
        
        .item-use-btn {
            background-color: #0a0;
            border: none;
            color: #000;
            font-family: 'VT323', monospace;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .clues-list {
            font-size: 14px;
            line-height: 1.3;
        }
        
        .clue-item {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 2px solid #0a0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .blinking-cursor {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 0, 0.1);
            z-index: 999;
            pointer-events: none;
            animation: scan 8s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
        
        .glitch {
            position: relative;
        }
        
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 red;
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        
        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 blue;
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }
        
        @keyframes glitch-anim {
            0% { clip: rect(42px, 9999px, 44px, 0); }
            5% { clip: rect(12px, 9999px, 59px, 0); }
            10% { clip: rect(48px, 9999px, 29px, 0); }
            15% { clip: rect(42px, 9999px, 73px, 0); }
            20% { clip: rect(63px, 9999px, 27px, 0); }
            25% { clip: rect(34px, 9999px, 55px, 0); }
            30% { clip: rect(86px, 9999px, 73px, 0); }
            35% { clip: rect(20px, 9999px, 20px, 0); }
            40% { clip: rect(26px, 9999px, 60px, 0); }
            45% { clip: rect(25px, 9999px, 66px, 0); }
            50% { clip: rect(57px, 9999px, 98px, 0); }
            55% { clip: rect(5px, 9999px, 46px, 0); }
            60% { clip: rect(82px, 9999px, 31px, 0); }
            65% { clip: rect(54px, 9999px, 27px, 0); }
            70% { clip: rect(28px, 9999px, 99px, 0); }
            75% { clip: rect(45px, 9999px, 69px, 0); }
            80% { clip: rect(23px, 9999px, 85px, 0); }
            85% { clip: rect(54px, 9999px, 84px, 0); }
            90% { clip: rect(45px, 9999px, 47px, 0); }
            95% { clip: rect(37px, 9999px, 20px, 0); }
            100% { clip: rect(4px, 9999px, 91px, 0); }
        }
        
        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 100px, 0); }
            5% { clip: rect(52px, 9999px, 74px, 0); }
            10% { clip: rect(79px, 9999px, 85px, 0); }
            15% { clip: rect(75px, 9999px, 5px, 0); }
            20% { clip: rect(67px, 9999px, 61px, 0); }
            25% { clip: rect(14px, 9999px, 79px, 0); }
            30% { clip: rect(1px, 9999px, 66px, 0); }
            35% { clip: rect(86px, 9999px, 30px, 0); }
            40% { clip: rect(23px, 9999px, 98px, 0); }
            45% { clip: rect(85px, 9999px, 72px, 0); }
            50% { clip: rect(71px, 9999px, 75px, 0); }
            55% { clip: rect(2px, 9999px, 48px, 0); }
            60% { clip: rect(30px, 9999px, 16px, 0); }
            65% { clip: rect(59px, 9999px, 50px, 0); }
            70% { clip: rect(41px, 9999px, 62px, 0); }
            75% { clip: rect(2px, 9999px, 82px, 0); }
            80% { clip: rect(47px, 9999px, 73px, 0); }
            85% { clip: rect(3px, 9999px, 27px, 0); }
            90% { clip: rect(40px, 9999px, 86px, 0); }
            95% { clip: rect(45px, 9999px, 72px, 0); }
            100% { clip: rect(23px, 9999px, 49px, 0); }
        }
        
        .crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            opacity: 0.6;
        }
        
        .item-description {
            font-size: 14px;
            color: #8f8;
            margin-top: 5px;
            padding: 5px;
            background-color: #222;
            border-left: 3px solid #0a0;
        }
        
        .danger {
            color: #f44;
            border-color: #f44;
        }
        
        .success {
            color: #4f4;
            border-color: #4f4;
        }
        
        .warning {
            color: #ff0;
            border-color: #ff0;
        }
        
        .health-bar-container {
            width: 100%;
            height: 10px;
            background-color: #222;
            margin-top: 3px;
        }
        
        .health-bar {
            height: 100%;
            background-color: #0f0;
            transition: width 0.3s;
        }
        
        .suspicion-bar {
            height: 100%;
            background-color: #f00;
            transition: width 0.3s;
        }
        
        .rep-bar {
            height: 100%;
            background-color: #ff0;
            transition: width 0.3s;
        }
        
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000;
            border: 2px solid #0a0;
            padding: 20px;
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            margin-top: 0;
            color: #0f0;
            border-bottom: 1px solid #0a0;
            padding-bottom: 10px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #0f0;
            font-size: 20px;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #222;
            border: 1px solid #0a0;
            padding: 10px 15px;
            color: #0f0;
            z-index: 1002;
            font-family: 'VT323', monospace;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .combine-modal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .combine-item {
            background-color: #222;
            border: 1px solid #333;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .combine-item:hover {
            border-color: #0a0;
        }
        
        .combine-result {
            grid-column: 1 / -1;
            text-align: center;
            padding: 10px;
            background-color: #333;
            margin-top: 10px;
        }
        
        .sound-toggle {
            position: relative;
        }
        
        .sound-toggle.active::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background-color: #0f0;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .location-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            padding: 5px 10px;
            font-size: 12px;
            color: #8f8;
            border: 1px solid #333;
            z-index: 100;
        }
        
        .combat-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .combat-button {
            background-color: #300;
            border: 1px solid #f00;
            color: #f44;
        }
        
        .combat-button:hover {
            background-color: #f00;
            color: #000;
        }
        
        .ending-screen {
            text-align: center;
            padding: 20px;
            animation: fadeIn 2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .ending-title {
            font-size: 28px;
            color: #0f0;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0f0;
        }
        
        .ending-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .restart-btn {
            background-color: #222;
            border: 2px solid #0a0;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 20px;
            padding: 15px 30px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .restart-btn:hover {
            background-color: #0a0;
            color: #000;
        }
        
        /* Mobile optimizations */
        @media (max-width: 500px) {
            body { font-size: 16px; }
            #title { font-size: 20px; }
            .game-button { padding: 12px; font-size: 15px; }
            .status-bar { font-size: 12px; padding: 6px 8px; }
            .status-label { font-size: 10px; }
            .side-section h3 { font-size: 14px; }
            .inventory-item { font-size: 12px; padding: 6px; }
            #screen-container { flex-direction: column; }
            #side-panel { flex-direction: row; border-top: 1px solid #333; }
            .side-section { border-right: 1px solid #333; border-bottom: none; }
            .side-section:last-child { border-right: none; }
            .header-controls { flex-direction: column; gap: 5px; }
            .control-btn { font-size: 10px; padding: 3px 6px; }
        }
        
        /* Prevent text selection */
        .game-button, .status-bar, #title, .inventory-item {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Scrollbar styling */
        #screen::-webkit-scrollbar,
        .side-section::-webkit-scrollbar {
            width: 6px;
        }
        
        #screen::-webkit-scrollbar-track,
        .side-section::-webkit-scrollbar-track {
            background: #111;
        }
        
        #screen::-webkit-scrollbar-thumb,
        .side-section::-webkit-scrollbar-thumb {
            background: #0a0;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="scanline"></div>
        <div class="crt-overlay"></div>
        
        <div id="header">
            <div id="title" class="glitch" data-text="FATHERLAND LEGACY">FATHERLAND LEGACY</div>
            <div id="header-controls">
                <button class="control-btn" id="save-btn">SAVE</button>
                <button class="control-btn" id="load-btn">LOAD</button>
                <button class="control-btn sound-toggle" id="sound-btn">SOUND: ON</button>
                <button class="control-btn" id="help-btn">HELP</button>
            </div>
        </div>
        
        <div id="screen-container">
            <div id="main-screen">
                <div id="screen">
                    <div class="screen-content">
                        <div class="text-output" id="text-output">
                            <!-- Game text appears here -->
                        </div>
                        
                        <div class="button-container" id="button-container">
                            <!-- Game buttons appear here -->
                        </div>
                        
                        <div class="command-line" id="command-line">
                            <span class="prompt">C:\FATHERLAND&gt;</span>
                            <input type="text" class="input-line" id="input-line" autocomplete="off" spellcheck="false" placeholder="Type HELP for commands...">
                        </div>
                    </div>
                </div>
                
                <div class="status-bar" id="status-bar">
                    <div class="status-item">
                        <span class="status-label">CLASS</span>
                        <span class="status-value" id="class-value">NONE</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">HEALTH</span>
                        <div class="status-value">
                            <div id="health-text">100</div>
                            <div class="health-bar-container">
                                <div class="health-bar" id="health-bar" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-label">SUSPICION</span>
                        <div class="status-value">
                            <div id="suspicion-text">0</div>
                            <div class="health-bar-container">
                                <div class="suspicion-bar" id="suspicion-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="side-panel">
                <div class="side-section" id="inventory-section">
                    <h3>INVENTORY <span id="inventory-count">(0)</span></h3>
                    <div id="inventory-items">
                        <!-- Inventory items appear here -->
                    </div>
                </div>
                
                <div class="side-section" id="clues-section">
                    <h3>CLUES & NOTES <span id="clues-count">(0)</span></h3>
                    <div id="clues-list" class="clues-list">
                        <!-- Clues appear here -->
                    </div>
                </div>
                
                <div class="side-section" id="stats-section">
                    <h3>STATUS</h3>
                    <div id="stats-display">
                        <!-- Stats appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="item-modal" class="modal hidden">
        <button class="close-modal" id="close-modal">&times;</button>
        <h3 id="modal-item-name">Item Name</h3>
        <div id="modal-item-description"></div>
        <div class="modal-buttons" id="modal-buttons"></div>
    </div>
    
    <div id="combine-modal" class="modal hidden">
        <button class="close-modal" id="close-combine-modal">&times;</button>
        <h3>COMBINE ITEMS</h3>
        <div class="combine-modal" id="combine-items-container">
            <!-- Combine items appear here -->
        </div>
        <div id="combine-result" class="combine-result hidden"></div>
    </div>
    
    <div id="help-modal" class="modal hidden">
        <button class="close-modal" id="close-help-modal">&times;</button>
        <h3>FATHERLAND LEGACY - COMMANDS</h3>
        <div style="font-size: 14px; line-height: 1.5;">
            <p><strong>BASIC COMMANDS:</strong></p>
            <p>HELP - Show this help screen</p>
            <p>INV - Show inventory</p>
            <p>USE [item] - Use an item</p>
            <p>COMBINE [item1] [item2] - Combine two items</p>
            <p>LOOK - Examine surroundings</p>
            <p>TIME - Check current time</p>
            <p>STATUS - Show detailed status</p>
            <p>SAVE/LOAD - Save or load game</p>
            
            <p><strong>COMBAT COMMANDS (when applicable):</strong></p>
            <p>FIGHT - Engage in combat</p>
            <p>FLEE - Attempt to escape</p>
            <p>HIDE - Attempt to hide</p>
            
            <p><strong>GAME INFO:</strong></p>
            <p>Keep your suspicion low to avoid Gestapo attention.</p>
            <p>Different classes have unique abilities and items.</p>
            <p>Some items can be combined to create new ones.</p>
        </div>
    </div>
    
    <div id="modal-overlay" class="modal-overlay hidden"></div>

    <script>
        // Game State
        const gameState = {
            playerClass: null,
            location: 'start',
            time: '06:00',
            day: 1,
            inventory: [],
            clues: [],
            reputation: 50,
            suspicion: 0,
            health: 100,
            stamina: 100,
            money: 50,
            gameOver: false,
            currentScene: null,
            pendingItemUse: null,
            discoveredEndings: [],
            achievements: [],
            knownLocations: ['Apartment'],
            soundEnabled: true,
            saveSlots: {},
            vogelAlive: true,
            evidenceSecured: false,
            trustWithVogel: 0,
            inCombat: false,
            combatEnemies: 0
        };

        // Sound System
        class SoundManager {
            constructor() {
                this.context = null;
                this.sounds = {};
                this.musicEnabled = true;
                this.sfxEnabled = true;
                
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    this.loadSounds();
                } catch (e) {
                    console.log("Web Audio API not supported");
                }
            }
            
            loadSounds() {
                // Create simple synthesized sounds
                this.sounds = {
                    type: this.createBeep(800, 0.1, 'sawtooth'),
                    click: this.createBeep(1200, 0.05, 'square'),
                    success: this.createBeep(1200, 0.2, 'sine'),
                    error: this.createBeep(400, 0.3, 'sawtooth'),
                    alert: this.createBeep(600, 0.5, 'sine'),
                    combat: this.createBeep(300, 0.2, 'square'),
                    item: this.createBeep(1000, 0.1, 'triangle'),
                    door: this.createBeep(200, 0.3, 'sine'),
                    footsteps: this.createFootstepSound(),
                    radio: this.createRadioSound(),
                    gunshot: this.createGunshotSound(),
                    scream: this.createScreamSound(),
                    heartbeat: this.createHeartbeatSound()
                };
            }
            
            createBeep(frequency, duration, type) {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
                    
                    oscillator.start(this.context.currentTime);
                    oscillator.stop(this.context.currentTime + duration);
                };
            }
            
            createGunshotSound() {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = 100;
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.5, this.context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                    
                    oscillator.start(this.context.currentTime);
                    oscillator.stop(this.context.currentTime + 0.1);
                };
            }
            
            createScreamSound() {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.4, this.context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 1);
                    
                    oscillator.frequency.setValueAtTime(800, this.context.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(200, this.context.currentTime + 1);
                    
                    oscillator.start(this.context.currentTime);
                    oscillator.stop(this.context.currentTime + 1);
                };
            }
            
            createHeartbeatSound() {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const oscillator = this.context.createOscillator();
                            const gainNode = this.context.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.context.destination);
                            
                            oscillator.frequency.value = 100;
                            oscillator.type = 'sine';
                            
                            gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                            
                            oscillator.start(this.context.currentTime);
                            oscillator.stop(this.context.currentTime + 0.1);
                        }, i * 300);
                    }
                };
            }
            
            createFootstepSound() {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const noise = this.context.createBufferSource();
                            const buffer = this.context.createBuffer(1, this.context.sampleRate * 0.1, this.context.sampleRate);
                            const data = buffer.getChannelData(0);
                            
                            for (let i = 0; i < data.length; i++) {
                                data[i] = Math.random() * 2 - 1;
                            }
                            
                            const gainNode = this.context.createGain();
                            const filter = this.context.createBiquadFilter();
                            filter.type = 'lowpass';
                            filter.frequency.value = 800;
                            
                            noise.connect(filter);
                            filter.connect(gainNode);
                            gainNode.connect(this.context.destination);
                            
                            gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                            
                            noise.buffer = buffer;
                            noise.start(this.context.currentTime);
                        }, i * 200);
                    }
                };
            }
            
            createRadioSound() {
                return () => {
                    if (!this.sfxEnabled || !this.context) return;
                    
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    const filter = this.context.createBiquadFilter();
                    
                    filter.type = 'bandpass';
                    filter.frequency.value = 1000;
                    filter.Q.value = 1;
                    
                    oscillator.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    // Add some frequency modulation for static effect
                    oscillator.frequency.setValueAtTime(800, this.context.currentTime);
                    oscillator.frequency.setValueAtTime(850, this.context.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(750, this.context.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.5);
                    
                    oscillator.start(this.context.currentTime);
                    oscillator.stop(this.context.currentTime + 0.5);
                };
            }
            
            play(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            }
            
            toggleSound() {
                this.sfxEnabled = !this.sfxEnabled;
                return this.sfxEnabled;
            }
        }

        // Game Items Database - EXPANDED
        const items = {
            pistol: {
                id: 'pistol',
                name: 'Walther P38 Pistol',
                description: 'Standard issue sidearm. 8 rounds remaining.',
                usable: true,
                classRestriction: ['soldier', 'investigator'],
                useText: 'Draw weapon',
                useEffect: (scene) => {
                    playSound('combat');
                    if (scene === 'alexanderplatzMeeting' || scene === 'confrontation' || scene === 'combatScene') {
                        addText('\n\nYou draw your weapon. The metallic click echoes in the silence.');
                        return {intimidation: 30, suspicion: 10};
                    }
                    return null;
                },
                canCombineWith: ['silencer', 'ammo']
            },
            
            kripoBadge: {
                id: 'kripoBadge',
                name: 'Kripo Badge',
                description: 'Your official Kriminalpolizei identification.',
                usable: true,
                classRestriction: ['investigator'],
                useText: 'Show badge',
                useEffect: (scene) => {
                    playSound('item');
                    if (scene === 'checkpoint' || scene === 'archive') {
                        addText('\n\nYou flash your badge. Authority recognized.');
                        return {access: true, suspicion: -5};
                    }
                    return null;
                }
            },
            
            forgedPass: {
                id: 'forgedPass',
                name: 'Forged Night Pass',
                description: 'Allows movement during curfew. Expires in 3 days.',
                usable: true,
                useText: 'Show pass',
                useEffect: (scene) => {
                    playSound('item');
                    if (scene.includes('street') || scene === 'checkpoint') {
                        addText('\n\nThe guard examines your pass and waves you through.');
                        return {access: true, suspicion: 2};
                    }
                    return null;
                }
            },
            
            flask: {
                id: 'flask',
                name: 'Metal Flask',
                description: 'Contains strong schnapps. Restores 30 stamina.',
                usable: true,
                useText: 'Take a drink',
                useEffect: () => {
                    playSound('item');
                    if (gameState.stamina < 80) {
                        gameState.stamina = Math.min(100, gameState.stamina + 30);
                        addText('\n\nYou take a swig. The burning liquid revives you.');
                        updateStatsDisplay();
                        return {stamina: 30};
                    }
                    addText('\n\nYou don\'t need to drink right now.');
                    return null;
                }
            },
            
            firstAid: {
                id: 'firstAid',
                name: 'First Aid Kit',
                description: 'Basic medical supplies. Restores 40 health.',
                usable: true,
                useText: 'Use medical supplies',
                useEffect: () => {
                    playSound('item');
                    if (gameState.health < 80) {
                        gameState.health = Math.min(100, gameState.health + 40);
                        addText('\n\nYou patch yourself up. Health restored.');
                        updateHealthDisplay();
                        return {health: 40};
                    }
                    addText('\n\nYou\'re already at full health.');
                    return null;
                }
            },
            
            camera: {
                id: 'camera',
                name: 'Miniature Camera',
                description: 'Small spy camera. Film: 4 exposures remaining.',
                usable: true,
                classRestriction: ['investigator', 'diplomat'],
                useText: 'Take photograph',
                useEffect: (scene) => {
                    playSound('click');
                    if (scene === 'archive' || scene === 'secretDocuments') {
                        addText('\n\nYou discreetly photograph the evidence. Evidence preserved.');
                        addClue('Photographic evidence');
                        return {clue: true};
                    }
                    return null;
                },
                canCombineWith: ['film']
            },
            
            notebook: {
                id: 'notebook',
                name: 'Leather Notebook',
                description: 'Your personal journal with coded notes.',
                usable: false,
                canExamine: true,
                examineText: 'The notebook contains your personal observations and coded messages. Recent entries mention Vogel and the Alexanderplatz meeting.'
            },
            
            key: {
                id: 'key',
                name: 'Brass Key',
                description: 'Fits an unknown lock. Marked "Storage 7B".',
                usable: true,
                useText: 'Try the key',
                useEffect: (scene) => {
                    playSound('door');
                    if (scene === 'lockedDoor' || scene === 'storageRoom') {
                        addText('\n\nThe key turns smoothly. The lock opens.');
                        return {access: true};
                    }
                    return null;
                }
            },
            
            wiretapDevice: {
                id: 'wiretapDevice',
                name: 'Wiretap Device',
                description: 'Miniature listening device. Requires batteries.',
                usable: true,
                classRestriction: ['investigator'],
                useText: 'Place wiretap',
                useEffect: (scene) => {
                    playSound('item');
                    if (scene === 'office' || scene === 'meetingRoom') {
                        addText('\n\nYou discreetly place the listening device. Intelligence gathering initiated.');
                        addClue('Wiretap recording');
                        return {clue: true, suspicion: 5};
                    }
                    return null;
                }
            },
            
            disguise: {
                id: 'disguise',
                name: 'Civilian Disguise',
                description: 'Simple civilian clothes to blend in.',
                usable: true,
                useText: 'Wear disguise',
                useEffect: (scene) => {
                    playSound('item');
                    addText('\n\nYou change into civilian clothes. Less conspicuous now.');
                    return {suspicion: -15};
                }
            },
            
            film: {
                id: 'film',
                name: 'Extra Film Roll',
                description: 'Additional film for your camera.',
                usable: false
            },
            
            silencer: {
                id: 'silencer',
                name: 'Pistol Silencer',
                description: 'Attaches to pistol for quiet shots.',
                usable: false
            },
            
            ammo: {
                id: 'ammo',
                name: '9mm Ammunition',
                description: 'Box of 20 rounds for your pistol.',
                usable: false
            },
            
            money: {
                id: 'money',
                name: 'Reichsmarks',
                description: () => `Cash: ${gameState.money} RM`,
                usable: true,
                useText: 'Offer bribe',
                useEffect: (scene) => {
                    playSound('item');
                    if (gameState.money >= 20) {
                        gameState.money -= 20;
                        addText('\n\nYou discreetly pass some bills. Cooperation secured.');
                        updateStatsDisplay();
                        return {access: true, suspicion: 5};
                    }
                    addText('\n\nYou don\'t have enough money for a bribe.');
                    return null;
                }
            },
            
            // New combined items
            silencedPistol: {
                id: 'silencedPistol',
                name: 'Silenced Walther P38',
                description: 'Pistol with attached silencer. Perfect for stealth operations.',
                usable: true,
                classRestriction: ['soldier', 'investigator'],
                useText: 'Use silenced weapon',
                useEffect: (scene) => {
                    playSound('combat');
                    if (scene === 'stealthMission') {
                        addText('\n\nThe silenced pistol makes almost no sound. Target eliminated.');
                        return {stealth: true, suspicion: 2};
                    }
                    return null;
                }
            },
            
            loadedCamera: {
                id: 'loadedCamera',
                name: 'Loaded Miniature Camera',
                description: 'Camera loaded with extra film. 12 exposures remaining.',
                usable: true,
                classRestriction: ['investigator', 'diplomat'],
                useText: 'Take multiple photos',
                useEffect: (scene) => {
                    playSound('click');
                    if (scene === 'archive' || scene === 'documentRoom') {
                        addText('\n\nYou take multiple photographs quickly. Comprehensive evidence collected.');
                        addClue('Extensive photographic evidence');
                        return {clue: true};
                    }
                    return null;
                }
            },
            
            vogelNotebook: {
                id: 'vogelNotebook',
                name: 'Vogel\'s Notebook',
                description: 'Hans Vogel\'s personal notebook with detailed records.',
                usable: true,
                useText: 'Examine notebook',
                useEffect: () => {
                    playSound('type');
                    addText('\n\nThe notebook contains detailed records:\n- Transport lists with names\n- Camp locations and capacities\n- Dates from 1941-1943\n- Official stamps from various ministries\nThis is concrete evidence of systematic extermination.');
                    addClue('Vogel\'s notebook - concrete evidence of Final Solution');
                    return {clue: true};
                }
            }
        };

        // Item Combinations
        const itemCombinations = {
            'pistol+silencer': {
                result: 'silencedPistol',
                message: 'You attach the silencer to your pistol. Weapon modified for stealth operations.'
            },
            'camera+film': {
                result: 'loadedCamera',
                message: 'You load the extra film into your camera. Capacity increased.'
            },
            'pistol+ammo': {
                result: 'pistol',
                message: 'You reload your pistol. Ammunition restored to full capacity.'
            }
        };

        // Starting items by class
        const startingItems = {
            investigator: ['kripoBadge', 'pistol', 'notebook', 'flask', 'camera'],
            soldier: ['pistol', 'firstAid', 'flask', 'ammo'],
            diplomat: ['forgedPass', 'camera', 'notebook', 'money', 'disguise']
        };

        // Game Scenes - COMPLETE IMPLEMENTATION
        const scenes = {
            start: {
                text: `SYSTEM BOOT...\nFATHERLAND LEGACY v3.0\n\nINITIALIZING MEMORY...\nLOADING HISTORICAL DATABASE...\n\nAPRIL 1964. GERMAN REICH.\n\nThe Greater German Reich spans from the Atlantic to the Urals. Victory in the Second World War brought unparalleled power, but at a cost few dare to acknowledge.\n\nTwenty years of peace have not erased the whispers. Dark secrets lie buried beneath the gleaming cities, hidden in archives, spoken only in hushed tones by those brave enough to remember.\n\nToday, everything changes. A cryptic message arrived at your doorstep. The sender claims to possess information that could shatter the foundations of the Reich itself.\n\nYou stand at a crossroads. Will you investigate and risk everything, or turn away and remain in blissful ignorance?\n\nSELECT YOUR PROFESSION:`,
                buttons: [
                    {text: "KRIMINALPOLIZEI INVESTIGATOR", action: "selectClass", class: "investigator", next: "classSelected", description: "Solve crimes the Reich wants buried"},
                    {text: "WEHRMACHT SOLDIER", action: "selectClass", class: "soldier", next: "classSelected", description: "Military access, combat skills, follow orders"},
                    {text: "AUSWÄRTIGES AMT DIPLOMAT", action: "selectClass", class: "diplomat", next: "classSelected", description: "Political connections, persuasion, subtlety"}
                ],
                input: false,
                onLoad: () => playSound('type')
            },
            
            classSelected: {
                text: () => {
                    const classInfo = {
                        investigator: {
                            name: "KRIMINALPOLIZEI INVESTIGATOR",
                            desc: `You are a detective with the Kriminalpolizei, assigned to "sensitive cases" that never reach public records. Your skills in deduction and forensics have solved mysteries the regime would prefer to keep hidden. But each solved case raises more questions about what truly happened during the war years.\n\nYour position grants access to restricted files, but also makes you vulnerable to SS scrutiny. Every move is watched, every question noted.`,
                            specialty: "Forensics & Investigation"
                        },
                        soldier: {
                            name: "WEHRMACHT SOLDIER",
                            desc: `You serve in the Wehrmacht, a veteran of the Eastern Front campaigns against the remaining Soviet holdouts. Your military training gives you physical prowess and access to restricted areas, but questioning orders could lead to charges of treason.\n\nLately, you've noticed discrepancies in official reports and heard whispers from fellow soldiers about things they witnessed but cannot discuss.`,
                            specialty: "Combat & Security"
                        },
                        diplomat: {
                            name: "AUSWÄRTIGES AMT DIPLOMAT",
                            desc: `You work for the Foreign Office, navigating the complex politics of the Reich and its occupied territories. Your connections and persuasive skills are valuable currency in a world where a single misspoken word could mean disappearance.\n\nRecent diplomatic cables have contained curious omissions, and certain historical records seem to have been... altered. Colleagues who ask too many questions tend to get reassigned to distant postings.`,
                            specialty: "Politics & Persuasion"
                        }
                    };
                    
                    const info = classInfo[gameState.playerClass];
                    const startingItemsList = startingItems[gameState.playerClass];
                    
                    let itemText = '\n\nSTARTING EQUIPMENT:\n';
                    startingItemsList.forEach(itemId => {
                        const item = items[itemId];
                        if (item) {
                            addItem(itemId);
                            itemText += `- ${item.name}\n`;
                        }
                    });
                    
                    return `${info.name} selected.\n\n${info.desc}\n\nSPECIALTY: ${info.specialty}${itemText}\n\nOBJECTIVE: Investigate the mysterious message. Meet the informant at Alexanderplatz tonight at 20:00.\n\nCAUTION: Gestapo surveillance is omnipresent. Keep suspicion levels low.\n\nPress ENTER to begin your investigation...`;
                },
                buttons: [
                    {text: "BEGIN INVESTIGATION", action: "loadScene", next: "apartment"},
                    {text: "REVIEW EQUIPMENT", action: "showInventory"}
                ],
                input: false,
                onLoad: () => playSound('success')
            },
            
            apartment: {
                text: () => {
                    const timeOfDay = gameState.time === '06:00' ? "early morning" : 
                                   gameState.time === '20:00' ? "evening" : 
                                   gameState.time;
                    return `BERLIN APARTMENT - DAY ${gameState.day}, ${gameState.time}\n\nYour modest apartment in the Berlin suburbs. The wireless plays martial music softly in the background. Outside, the city awakens to another day of Reich prosperity.\n\nOn your desk lies the encrypted message that arrived last night. The paper feels cheap, untraceable:\n\n"MEET AT ALEXANDERPLATZ U-BAHN. SOUTH ENTRANCE. 20:00 TONIGHT. COME ALONE. DESTRUCT AFTER READING."\n\nA name is scrawled at the bottom: "VOGEL".\n\nYou have ${getTimeUntilMeeting()} before the meeting. The day stretches ahead with possibilities. What will you do?`;
                },
                buttons: [
                    {text: "EXAMINE THE MESSAGE CLOSELY", action: "loadScene", next: "examineMessage"},
                    {text: "GO TO KRIPO HEADQUARTERS", action: "loadScene", next: "kripoHQ", condition: () => gameState.playerClass === 'investigator'},
                    {text: "REPORT TO BARRACKS", action: "loadScene", next: "barracks", condition: () => gameState.playerClass === 'soldier'},
                    {text: "VISIT FOREIGN OFFICE", action: "loadScene", next: "foreignOffice", condition: () => gameState.playerClass === 'diplomat'},
                    {text: "GO TO ALEXANDERPLATZ EARLY", action: "loadScene", next: "alexanderplatzScout"},
                    {text: "VISIT THE MINISTRY ARCHIVES", action: "loadScene", next: "archiveVisit", condition: () => hasItem('kripoBadge') || hasItem('forgedPass')},
                    {text: "CHECK LOCAL NEWSPAPER", action: "loadScene", next: "newspaper"},
                    {text: "REST UNTIL EVENING", action: "advanceTime", next: "alexanderplatzMeeting"},
                    {text: "INVENTORY", action: "showInventory"},
                    {text: "COMBINE ITEMS", action: "showCombineModal"}
                ],
                input: true,
                onLoad: () => {
                    playSound('footsteps');
                    if (!gameState.knownLocations.includes('Apartment')) {
                        gameState.knownLocations.push('Apartment');
                    }
                }
            },
            
            examineMessage: {
                text: `EXAMINING THE MESSAGE\n\nYou examine the paper under lamplight:\n\n1. Paper quality: Cheap, mass-produced. Untraceable.\n2. Ink: Standard blue, but with a faint chemical smell - printing industry?\n3. Handwriting: Deliberately sloppy, but educated. Left-handed writer.\n4. Watermark: Faint partial eagle visible - possibly from official stationery?\n5. Additional mark: Tiny ink smudge resembling a file cabinet key.\n\nInteresting details:\n- "COME ALONE" is underlined twice\n- "DESTRUCT" is misspelled as "DESTRUCT" (correct)\n- Paper has been folded exactly three times\n\nThis was written by someone nervous but professional. The partial eagle might be from Propaganda Ministry stationery. The key smudge suggests someone who works with files.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"},
                    {text: "BURN THE MESSAGE", action: "action", next: "burnMessage"},
                    {text: "TAKE PHOTOGRAPH WITH CAMERA", action: "useItem", item: "camera", condition: () => hasItem('camera')},
                    {text: "MAKE NOTES IN NOTEBOOK", action: "useItem", item: "notebook", condition: () => hasItem('notebook')},
                    {text: "ANALYZE HANDWRITING FURTHER", action: "action", next: "analyzeHandwriting"}
                ],
                input: true,
                onLoad: () => playSound('type')
            },
            
            kripoHQ: {
                text: `KRIPO HEADQUARTERS, PRINZ-ALBRECHT-STRAßE\n\nThe headquarters buzzes with controlled activity. Detectives move between offices, files are shuffled, telephones ring. The air smells of cigarette smoke and bureaucracy.\n\nYour superior, Kommissar Bauer, approaches with a file tucked under his arm.\n\n"Good, you're here," he says, lowering his voice. "We have a sensitive case - a missing person from the Propaganda Ministry. Low priority officially, but I want you to look into it quietly."\n\nHe hands you the file. The missing person is one Hans Vogel, archival services clerk. Last seen three days ago. Family reported him "working late" but he never returned home.\n\nBauer looks around before continuing. "The Gestapo showed unusual interest. They took the original report. This is a copy."`,
                buttons: [
                    {text: "ACCEPT THE CASE", action: "action", next: "acceptCase"},
                    {text: "DECLINE, PLEAD OTHER DUTIES", action: "loadScene", next: "apartment"},
                    {text: "ASK ABOUT ALEXANDERPLATZ", action: "action", next: "askAboutAlexanderplatz"},
                    {text: "SHOW HIM THE MESSAGE", action: "action", next: "showMessageToBauer", condition: () => gameState.suspicion < 30},
                    {text: "INQUIRE ABOUT GESTAPO INVOLVEMENT", action: "action", next: "askAboutGestapo"},
                    {text: "CHECK OTHER MISSING PERSONS FILES", action: "action", next: "checkMissingFiles"}
                ],
                input: true,
                onLoad: () => {
                    playSound('radio');
                    addLocation('Kripo HQ');
                }
            },
            
            barracks: {
                text: `WEHRMACHT BARRACKS, BERLIN DISTRICT\n\nThe barracks hum with disciplined activity. Soldiers march in the courtyard while mechanics maintain vehicles. The scent of diesel and polish fills the air.\n\nSergeant Müller barks orders near the armory. Several soldiers glance nervously at the political officer talking with the sergeant.\n\nAs you approach, the political officer - a young SS-Untersturmführer - turns to you. His eyes are cold, assessing.\n\n"Everything in order, soldier?" he asks. His tone suggests it's not really a question.`,
                buttons: [
                    {text: "SALUTE AND REPORT FOR DUTY", action: "action", next: "reportToOfficer"},
                    {text: "REQUEST LEAVE FOR ALEXANDERPLATZ", action: "action", next: "requestAlexanderplatz"},
                    {text: "CLAIM ILLNESS AND RETURN HOME", action: "loadScene", next: "apartment"},
                    {text: "ASK ABOUT UNUSUAL ACTIVITY", action: "action", next: "askBarracksActivity"},
                    {text: "OFFER CIGARETTES AS BRIBE", action: "useItem", item: "money", condition: () => hasItem('money') && gameState.money >= 30},
                    {text: "CHECK ARMORY FOR EXTRA EQUIPMENT", action: "action", next: "checkArmory"}
                ],
                input: true,
                onLoad: () => {
                    playSound('footsteps');
                    addLocation('Barracks');
                }
            },
            
            foreignOffice: {
                text: `FOREIGN OFFICE, WILHELMSTRASSE\n\nThe grand building hums with bureaucratic activity. Polished marble floors reflect the hurried footsteps of diplomats and clerks. Portraits of Reich ministers line the walls.\n\nColleague Schmidt approaches you nervously, checking over his shoulder.\n\n"Have you heard?" he whispers. "Several junior diplomats have been... reassigned. To the Eastern territories. Without notice, without family."\n\nHe lowers his voice further. "They were asking questions about certain... historical records in the archives. Specifically about population transfers during the war."\n\nSchmidt looks genuinely frightened. "They're disappearing people, quietly."`,
                buttons: [
                    {text: "PRESS FOR DETAILS", action: "action", next: "pressForDetails"},
                    {text: "CHANGE THE SUBJECT", action: "loadScene", next: "apartment"},
                    {text: "SHOW YOUR CREDENTIALS", action: "useItem", item: "forgedPass", condition: () => hasItem('forgedPass')},
                    {text: "SUGGEST DISCREET MEETING", action: "action", next: "suggestDiscreetMeeting"},
                    {text: "REPORT SCHMIDT TO SECURITY", action: "action", next: "reportSchmidt", danger: true},
                    {text: "ACCESS RESTRICTED ARCHIVES", action: "action", next: "accessDiplomaticArchives"}
                ],
                input: true,
                onLoad: () => {
                    playSound('door');
                    addLocation('Foreign Office');
                }
            },
            
            alexanderplatzScout: {
                text: () => {
                    let text = `ALEXANDERPLATZ - DAYTIME\n\nThe vast square bustles with controlled activity. Trams rattle past the massive television tower construction site - a symbol of Reich technological prowess.\n\nYou blend with the crowd, observing:\n\n1. TWO GESTAPO AGENTS in dark coats, watching the south U-Bahn entrance\n2. A NEWSPAPER VENDOR who checks his watch every few minutes\n3. CONSTRUCTION WORKERS who seem more interested in observing than working\n4. A BLACK SEDAN parked with engine running, two men inside\n5. SEVERAL CIVILIANS who appear to be waiting, glancing around nervously\n\nThis is clearly a surveillance operation. The meeting point is being watched.`;
                    
                    if (hasItem('camera')) {
                        text += `\n\nYour camera could document this surveillance.`;
                    }
                    
                    if (gameState.playerClass === 'soldier' && hasItem('pistol')) {
                        text += `\n\nYour military training identifies at least three potential ambush points.`;
                    }
                    
                    return text;
                },
                buttons: [
                    {text: "RETURN LATER FOR MEETING", action: "advanceTime", next: "alexanderplatzMeeting"},
                    {text: "APPROACH NEWSPAPER VENDOR", action: "action", next: "approachVendor"},
                    {text: "DOCUMENT SURVEILLANCE WITH CAMERA", action: "useItem", item: "camera", condition: () => hasItem('camera')},
                    {text: "USE DISGUISE TO BLEND IN", action: "useItem", item: "disguise", condition: () => hasItem('disguise')},
                    {text: "CONFRONT GESTAPO AGENTS", action: "action", next: "confrontGestapo", danger: true, condition: () => gameState.playerClass === 'soldier' || gameState.playerClass === 'investigator'},
                    {text: "FIND ALTERNATIVE MEETING SPOT", action: "action", next: "findAlternativeSpot"},
                    {text: "LEAVE AND ABANDON MEETING", action: "action", next: "abandonMeeting"}
                ],
                input: true,
                onLoad: () => {
                    playSound('alert');
                    addLocation('Alexanderplatz');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            alexanderplatzMeeting: {
                text: () => {
                    let text = `ALEXANDERPLATZ - 20:00\n\nShadows lengthen across the square. The evening crowd thins as curfew approaches. Streetlights flicker on, casting pools of amber light.\n\nYou wait at the south U-Bahn entrance, collar turned up against the chill. The Gestapo agents have been replaced by different watchers.\n\nA man in a worn coat approaches, head down. He moves with the nervous energy of a hunted animal.\n\n"Thank you for coming," he whispers, not making eye contact. "My name is Vogel. I worked in the archive... I saw things."\n\nHe's pale, thin, with the look of someone who hasn't slept properly in days.`;
                    
                    if (gameState.suspicion > 30) {
                        text += `\n\nYou notice two new watchers across the square. They're trying to appear casual, but their posture gives them away - trained operatives.`;
                    }
                    
                    if (hasItem('pistol')) {
                        text += `\n\nYour hand rests near your concealed weapon.`;
                    }
                    
                    return text;
                },
                buttons: [
                    {text: "WHAT DID YOU SEE, VOGEL?", action: "action", next: "vogelRevelation"},
                    {text: "THIS COULD BE A TRAP", action: "action", next: "expressDoubt"},
                    {text: "SHOW YOUR BADGE", action: "useItem", item: "kripoBadge", condition: () => hasItem('kripoBadge')},
                    {text: "DEMAND PROOF", action: "action", next: "demandProof"},
                    {text: "OFFER PROTECTION", action: "action", next: "offerProtection"},
                    {text: "DRAW YOUR WEAPON", action: "useItem", item: "pistol", condition: () => hasItem('pistol')},
                    {text: "OFFER MONEY FOR INFORMATION", action: "useItem", item: "money", condition: () => hasItem('money') && gameState.money >= 40},
                    {text: "SUGGEST MOVING LOCATION", action: "action", next: "suggestMove"}
                ],
                input: true,
                onLoad: () => {
                    playSound('alert');
                    gameState.suspicion += 10;
                    updateStatsDisplay();
                }
            },
            
            vogelRevelation: {
                text: `Vogel leans closer, his voice barely audible over the distant tram sounds.\n\n"The Final Solution... it wasn't just about resettlement to the East." He swallows hard. "There were camps... extermination camps. Millions of people. Jews, Slavs, Roma, dissidents."\n\nHis hands tremble as he presses a small notebook into your hand. The cover is stained, pages worn.\n\n"Names, dates, locations. Transport records from '41 to '43. They're systematically destroying the evidence, but I saved this copy. You must get it to someone who can--"\n\nSuddenly, headlights flood the area. A black sedan with no license plates screeches to a halt. Doors fly open.\n\nVogel's eyes widen in pure terror. "They found me!"\n\nFour men in dark coats emerge, moving with purpose. They're armed.`,
                buttons: [
                    {text: "GRAB VOGEL AND RUN", action: "action", next: "runWithVogel"},
                    {text: "HIDE IN U-BAHN TUNNELS", action: "action", next: "hideInTunnels"},
                    {text: "CONFRONT THEM WITH AUTHORITY", action: "action", next: "confrontWithAuthority", condition: () => gameState.playerClass === 'investigator' || gameState.playerClass === 'soldier'},
                    {text: "USE PISTOL FOR COVER", action: "useItem", item: "pistol", condition: () => hasItem('pistol')},
                    {text: "BLEND INTO CROWD", action: "useItem", item: "disguise", condition: () => hasItem('disguise')},
                    {text: "SURRENDER VOGEL", action: "action", next: "surrenderVogel", danger: true}
                ],
                input: false,
                onLoad: () => playSound('combat')
            },
            
            runWithVogel: {
                text: `You grab Vogel's arm and pull him toward the U-Bahn stairs. Shouts echo behind you.\n\n"STOP! POLICE!"\n\nYou don't look back. The concrete stairs echo under your frantic footsteps. The U-Bahn station is nearly empty at this hour.\n\nVogel stumbles, breath coming in ragged gasps. "They'll kill us both!"\n\nYou reach the platform as a train approaches. The doors open.`,
                buttons: [
                    {text: "BOARD THE TRAIN", action: "action", next: "boardTrain"},
                    {text: "HIDE IN MAINTENANCE TUNNEL", action: "action", next: "hideMaintenance"},
                    {text: "SPLIT UP", action: "action", next: "splitUp"},
                    {text: "PREPARE TO FIGHT", action: "action", next: "prepareFight", condition: () => hasItem('pistol')}
                ],
                input: false,
                onLoad: () => playSound('footsteps')
            },
            
            boardTrain: {
                text: `You push Vogel into the train just as the doors begin to close. Two of the pursuers reach the platform as the train pulls away.\n\nInside the nearly empty carriage, Vogel collapses onto a seat, trembling.\n\n"We need to get off at the next stop," you say. "They'll have people waiting at subsequent stations."\n\nThe train rattles through the dark tunnel. Vogel clutches the notebook to his chest.\n\n"Thank you," he whispers. "I didn't think anyone would come."`,
                buttons: [
                    {text: "ASK ABOUT THE NOTEBOOK", action: "action", next: "askAboutNotebook"},
                    {text: "PLAN NEXT MOVE", action: "action", next: "planNextMove"},
                    {text: "CHECK FOR PURSUERS", action: "action", next: "checkPursuers"},
                    {text: "USE FIRST AID ON VOGEL", action: "useItem", item: "firstAid", condition: () => hasItem('firstAid')}
                ],
                input: false,
                onLoad: () => playSound('door')
            },
            
            askAboutNotebook: {
                text: `Vogel opens the notebook with shaking hands.\n\n"See these numbers? Transport records. This column shows destinations: Auschwitz, Treblinka, Sobibor... They weren't labor camps. They were death factories."\n\nHe points to a page filled with meticulous handwriting.\n\n"I copied these from original documents that were scheduled for destruction. The scale... it's unimaginable."\n\nVogel looks at you with desperate hope. "You believe me, don't you?"`,
                buttons: [
                    {text: "I BELIEVE YOU", action: "action", next: "believeVogel"},
                    {text: "I NEED MORE PROOF", action: "action", next: "needMoreProof"},
                    {text: "TAKE THE NOTEBOOK", action: "action", next: "takeNotebook"},
                    {text: "PHOTOGRAPH THE PAGES", action: "useItem", item: "camera", condition: () => hasItem('camera')}
                ],
                input: false
            },
            
            believeVogel: {
                text: `Vogel's eyes fill with tears of relief.\n\n"Thank God. I thought I was going mad. Everyone acts like nothing happened, but I saw the records... I saw the orders."\n\nThe train slows as it approaches the next station.\n\n"We need to get off here," you say. "My apartment isn't safe anymore. We need to find somewhere to hide."`,
                buttons: [
                    {text: "GO TO SAFE HOUSE", action: "action", next: "goToSafeHouse", condition: () => gameState.playerClass === 'investigator' || hasItem('forgedPass')},
                    {text: "GO TO ALLY'S APARTMENT", action: "action", next: "goToAllyApartment"},
                    {text: "SPLIT UP AND MEET LATER", action: "action", next: "splitAndMeet"},
                    {text: "CONFRONT THE PURSUERS", action: "action", next: "confrontPursuers", danger: true}
                ],
                input: false
            },
            
            goToSafeHouse: {
                text: `You guide Vogel off the train at a small, less-used station. Using back alleys and side streets, you make your way to a safe house used by your contacts.\n\nThe safe house is a small apartment above a bakery. It's dusty but functional.\n\n"We should be safe here for a few hours," you tell Vogel. "But we need to decide what to do next."\n\nVogel places the notebook on the table. "This evidence needs to reach the outside world. The neutral countries... maybe the Americans..."`,
                buttons: [
                    {text: "STUDY THE EVIDENCE", action: "action", next: "studyEvidence"},
                    {text: "MAKE COPIES OF THE NOTEBOOK", action: "action", next: "makeCopies"},
                    {text: "CONTACT RESISTANCE NETWORK", action: "action", next: "contactResistance"},
                    {text: "TURN VOGEL IN", action: "action", next: "turnVogelIn", danger: true},
                    {text: "LEAVE GERMANY TOGETHER", action: "action", next: "leaveGermany"}
                ],
                input: false,
                onLoad: () => {
                    playSound('door');
                    addLocation('Safe House');
                    addItem('vogelNotebook');
                    gameState.evidenceSecured = true;
                    gameState.trustWithVogel += 30;
                }
            },
            
            studyEvidence: {
                text: `For hours, you study Vogel's notebook. The evidence is overwhelming:\n\n- Detailed transport records showing millions sent to "special camps"\n- Orders signed by high-ranking officials\n- Budget allocations for "special treatment facilities"\n- Population statistics with suspicious discrepancies\n\nVogel explains: "They're rewriting history. The official story is resettlement and labor. But these documents prove systematic extermination."\n\nYou now hold evidence that could shatter the Reich's legitimacy. But getting it out of Germany will be nearly impossible.`,
                buttons: [
                    {text: "CONTACT FOREIGN JOURNALIST", action: "action", next: "contactJournalist"},
                    {text: "GO TO SWISS EMBASSY", action: "action", next: "goToSwissEmbassy"},
                    {text: "HIDE EVIDENCE AND WAIT", action: "action", next: "hideEvidence"},
                    {text: "DESTROY EVIDENCE FOR SAFETY", action: "action", next: "destroyEvidence", danger: true}
                ],
                input: false
            },
            
            contactJournalist: {
                text: `You remember an American journalist who was expelled last year for "asking inappropriate questions." He left contact information with a trusted source.\n\nUsing the safe house's clandestine radio, you send a coded message. The reply comes hours later:\n\n"INTERESTED. MEET NEUTRAL TERRITORY. SWISS BORDER. THREE DAYS."\n\nVogel looks hopeful for the first time. "This could work. But getting to Switzerland..."\n\nThe journey will be dangerous, crossing multiple checkpoints with the most wanted evidence in the Reich.`,
                buttons: [
                    {text: "PLAN THE ESCAPE ROUTE", action: "action", next: "planEscapeRoute"},
                    {text: "REQUEST HELP FROM RESISTANCE", action: "action", next: "requestResistanceHelp"},
                    {text: "GO ALONE", action: "action", next: "goAlone"},
                    {text: "ABANDON THE PLAN", action: "action", next: "abandonPlan"}
                ],
                input: false
            },
            
            planEscapeRoute: {
                text: `You spend the next day planning:\n\nROUTE: Berlin -> Stuttgart -> Konstanz -> Swiss border\n\nMETHOD: Forged papers, night travel, avoiding main roads\n\nCONTACTS: Resistance safe houses along the route\n\nRISKS: Multiple checkpoints, border patrols, informants\n\nVogel has contacts in the railway administration who might help. "I know a dispatcher who can get us on a freight train part of the way," he says.\n\nTime is running out. Gestapo raids are intensifying.`,
                buttons: [
                    {text: "BEGIN THE JOURNEY", action: "action", next: "beginJourney"},
                    {text: "WAIT FOR BETTER CONDITIONS", action: "action", next: "waitConditions"},
                    {text: "SEND VOGEL ALONE", action: "action", next: "sendVogelAlone"},
                    {text: "BURN EVIDENCE AND SURRENDER", action: "action", next: "burnSurrender", danger: true}
                ],
                input: false
            },
            
            beginJourney: {
                text: `DAY ${gameState.day + 1}, 02:00\n\nYou and Vogel slip out of the safe house under cover of darkness. The streets are empty except for occasional patrols.\n\nUsing Vogel's railway contacts, you board a freight car bound for Stuttgart. The train moves slowly through the night.\n\nAt dawn, you reach the first major checkpoint. SS soldiers are inspecting all trains.`,
                buttons: [
                    {text: "HIDE IN THE CARGO", action: "action", next: "hideInCargo"},
                    {text: "USE FORGED PAPERS", action: "useItem", item: "forgedPass", condition: () => hasItem('forgedPass')},
                    {text: "FIGHT IF DISCOVERED", action: "action", next: "fightIfDiscovered"},
                    {text: "SURRENDER", action: "action", next: "surrenderAtCheckpoint", danger: true}
                ],
                input: false,
                onLoad: () => {
                    gameState.day += 1;
                    gameState.time = '02:00';
                    updateStatsDisplay();
                }
            },
            
            hideInCargo: {
                text: `You and Vogel bury yourselves under crates of machine parts. Boots echo on the platform above.\n\n"Everything in order?" a soldier asks.\n\n"Just freight to Stuttgart," a railway worker replies.\n\nThe inspection is cursory. The soldiers move on. The train starts moving again.\n\nYou've passed the first checkpoint. Four more to the border.`,
                buttons: [
                    {text: "CONTINUE JOURNEY", action: "action", next: "continueJourney"},
                    {text: "CHECK ON VOGEL", action: "action", next: "checkOnVogel"},
                    {text: "REST WHILE YOU CAN", action: "action", next: "restDuringJourney"}
                ],
                input: false
            },
            
            continueJourney: {
                text: `The journey takes two more days. You move from train to truck to foot, using resistance safe houses. Each checkpoint is a gamble with your lives.\n\nAt the final approach to the Swiss border, you're in a forest near Konstanz. The border is just 5 kilometers away, but heavily guarded.\n\nVogel is exhausted but determined. "We're so close," he whispers.\n\nSuddenly, flashlight beams cut through the trees. A patrol has found your trail.`,
                buttons: [
                    {text: "RUN FOR THE BORDER", action: "action", next: "runForBorder"},
                    {text: "HIDE IN THE TREES", action: "action", next: "hideInTrees"},
                    {text: "CREATE A DISTRACTION", action: "action", next: "createDistraction"},
                    {text: "PREPARE TO FIGHT", action: "action", next: "prepareFinalFight"}
                ],
                input: false,
                onLoad: () => {
                    gameState.day += 2;
                    playSound('heartbeat');
                }
            },
            
            runForBorder: {
                text: `You and Vogel break into a run, crashing through the undergrowth. Shouts behind you.\n\n"STOP OR WE SHOOT!"\n\nGunfire erupts. Bullets whip past your head. The Swiss border fence is visible ahead.\n\nVogel stumbles. "Go without me!" he shouts.\n\nYou're 100 meters from freedom.`,
                buttons: [
                    {text: "HELP VOGEL", action: "action", next: "helpVogel"},
                    {text: "MAKE A RUN FOR IT", action: "action", next: "runForFreedom"},
                    {text: "THROW THE NOTEBOOK ACROSS", action: "action", next: "throwNotebook"},
                    {text: "SURRENDER", action: "action", next: "finalSurrender", danger: true}
                ],
                input: false,
                onLoad: () => playSound('gunshot')
            },
            
            helpVogel: {
                text: `You turn back and grab Vogel, pulling him toward the fence. More gunfire. Vogel cries out as a bullet strikes his leg.\n\n"Leave me!" he gasps.\n\nYou reach the fence. The Swiss side is just beyond. You can see Swiss border guards watching from their post.\n\nWith one last effort, you half-carry, half-drag Vogel through a gap in the fence.\n\nYou collapse on the other side. The German guards stop at the border, shouting curses but not crossing into neutral territory.\n\nYou made it.`,
                buttons: [
                    {text: "CONTINUE TO ENDING", action: "action", next: "swissEnding"}
                ],
                input: false,
                onLoad: () => {
                    gameState.vogelAlive = true;
                    playSound('success');
                }
            },
            
            swissEnding: {
                text: `SWITZERLAND - DAY ${gameState.day + 1}\n\nIn a hospital in Zurich, Vogel recovers from his wound. The Swiss authorities, after verifying your evidence, have granted you both political asylum.\n\nAmerican journalists have the story. The Vogel Notebook is being published worldwide.\n\nTwo weeks later, the first headlines appear:\n\n"GERMAN REICH DEATH CAMP EVIDENCE REVEALED"\n"VOGEL DOCUMENTS PROVE MILLIONS EXTERMINATED"\n"WORLD REACTS WITH HORROR"\n\nDiplomatic pressure mounts on the Reich. Protest movements begin in occupied territories. The regime's legitimacy is crumbling.\n\nYou and Vogel live to see the truth come out, though you know you can never return home. The cost was high, but the truth was worth it.\n\n=== ENDING: TRUTH REVEALED ===\n\nYour courage saved evidence that changed history.`,
                buttons: [
                    {text: "RESTART GAME", action: "action", next: "restartGame"}
                ],
                input: false,
                onLoad: () => playSound('success')
            },
            
            // Now let's implement the missing actions from earlier scenes
            burnMessage: {
                text: `You carefully burn the message in an ashtray, watching the paper curl and blacken. The evidence is destroyed, but Vogel's words are seared into your memory.\n\nSuspicion decreases slightly.`,
                buttons: [
                    {text: "CONTINUE", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion = Math.max(0, gameState.suspicion - 5);
                    updateStatsDisplay();
                    playSound('success');
                }
            },
            
            analyzeHandwriting: {
                text: `You examine the handwriting under magnification:\n\n- The 't' bars are perfectly horizontal (meticulous personality)\n- Slight tremor in long strokes (nervousness)\n- Unusual spacing between words (possibly coded message)\n- The 'V' in Vogel has a distinctive flourish\n- Pressure variations suggest emotional stress while writing\n\nThis was written by someone educated, detail-oriented, and under extreme pressure. The spacing might be a simple code.`,
                buttons: [
                    {text: "DECODE THE SPACING", action: "action", next: "decodeSpacing"},
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            decodeSpacing: {
                text: `Looking at the spacing between words:\n\nMEET AT ALEXANDERPLATZ U-BAHN. SOUTH ENTRANCE. 20:00 TONIGHT. COME ALONE. DESTRUCT AFTER READING.\n\nThe unusual gaps appear before: ALEXANDERPLATZ, SOUTH, TONIGHT, ALONE, AFTER\n\nTaking the first letters: A S T A A\n\nRearranged: STAAT (German for "state")\n\nOr as numbers: 1 19 20 1 1 (A=1, S=19, T=20)\n\nThis might be a file number or code. Vogel was leaving additional clues.`,
                buttons: [
                    {text: "NOTE THIS DISCOVERY", action: "action", next: "noteDiscovery"},
                    {text: "IGNORE AS COINCIDENCE", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            noteDiscovery: {
                text: `You note the code in your own notebook. This could be important later.\n\nAdded to clues.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Possible code in message spacing: "STAAT" or "1-19-20-1-1"');
                }
            },
            
            acceptCase: {
                text: `You accept the case file from Kommissar Bauer.\n\n"Handle this discreetly," he warns. "The Gestapo is involved, which means this is political. Watch your back."\n\nYou now have an official reason to investigate Vogel's disappearance.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Official missing persons case: Hans Vogel');
                    addClue('Gestapo showing unusual interest in Vogel case');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                    playSound('success');
                }
            },
            
            askAboutAlexanderplatz: {
                text: `"Alexanderplatz?" Bauer frowns, lighting a cigarette. "Why do you ask? There have been... incidents there lately. Suspicious gatherings. The Gestapo has intensified surveillance. I'd avoid it unless on official business."\n\nHe exhales smoke. "People have disappeared after being seen there."`,
                buttons: [
                    {text: "ASK ABOUT THE INCIDENTS", action: "action", next: "askIncidents"},
                    {text: "ASK ABOUT DISAPPEARANCES", action: "action", next: "askDisappearances"},
                    {text: "THANK HIM AND LEAVE", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            askIncidents: {
                text: `"Unsanctioned meetings. Exchange of documents. The Gestapo is conducting 'interviews' with anyone seen loitering. They're looking for something - or someone." Bauer looks uncomfortable. "If you have business there, be careful. Don't be seen talking to strangers."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Gestapo conducting surveillance at Alexanderplatz');
                }
            },
            
            askDisappearances: {
                text: `Bauer lowers his voice. "Three people in the last month. All asking questions about historical records. All disappeared after being seen at Alexanderplatz. Officially, they've been 'reassigned to Eastern territories.'"\n\nHe stubs out his cigarette. "I shouldn't be telling you this. Be careful."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Previous disappearances linked to Alexanderplatz');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            showMessageToBauer: {
                text: `You show Bauer the message. He reads it carefully, his face grim.\n\n"Vogel. That's the missing archivist. This is dangerous. If the Gestapo knows about this meeting..."\n\nHe thinks for a moment. "I can give you backup if you want. Plainclothes officers nearby. Or you can go alone, which might be safer for the informant."`,
                buttons: [
                    {text: "REQUEST BACKUP", action: "action", next: "requestBackup"},
                    {text: "GO ALONE", action: "action", next: "goAloneDecision"},
                    {text: "ABANDON THE MEETING", action: "action", next: "abandonMeetingDecision"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 10;
                    updateStatsDisplay();
                }
            },
            
            requestBackup: {
                text: `"I'll have two men in civilian clothes at the square. They'll watch from a distance. If things go bad, they'll intervene."\n\nBauer writes down a recognition signal. "Use this if you need extraction."\n\nYou now have backup for the meeting.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Kripo backup arranged for Alexanderplatz meeting');
                    gameState.reputation += 10;
                    updateStatsDisplay();
                }
            },
            
            goAloneDecision: {
                text: `"Probably wise," Bauer nods. "Fewer variables. But you're on your own if it's a trap. Take your pistol."\n\nHe hands you a spare magazine. "Good luck."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addItem('ammo');
                    playSound('item');
                }
            },
            
            abandonMeetingDecision: {
                text: `"Sometimes discretion is the better part of valor," Bauer says. "But Vogel reached out to you specifically. He must have thought you were trustworthy."\n\nHe returns the message. "Your choice. But if Vogel has real evidence... it could be important."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            askAboutGestapo: {
                text: `Bauer's expression darkens. "The Gestapo's involvement is never a good sign. They took over the case immediately, which means it touches on state security."\n\nHe looks around before continuing. "They're not just looking for a missing clerk. They're looking for something he took. Or something he knows."`,
                buttons: [
                    {text: "ASK WHAT HE MIGHT HAVE TAKEN", action: "action", next: "askWhatTaken"},
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            askWhatTaken: {
                text: `"Archival records. Historical documents. The Propaganda Ministry has been 'reviewing' old files for years. Removing 'inconsistencies.'"\n\nBauer makes air quotes. "If Vogel took something they were supposed to destroy... that would explain their interest."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Gestapo seeking documents Vogel might have taken');
                }
            },
            
            checkMissingFiles: {
                text: `You check the missing persons files. Vogel isn't the only one:\n\n- Anna Weber, historian, missing 2 months\n- Friedrich Schmidt, archivist, missing 6 weeks\n- Klaus Bauer, librarian, missing 3 months\n\nAll worked with historical records. All officially "reassigned."\n\nThe pattern is clear: people who work with old documents are disappearing.`,
                buttons: [
                    {text: "MAKE NOTES", action: "action", next: "makeNotesOnMissing"},
                    {text: "REPORT TO BAUER", action: "action", next: "reportPattern"},
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            makeNotesOnMissing: {
                text: `You document the pattern:\n\n1. All missing persons worked with historical records\n2. All disappeared within last 3 months\n3. All cases show Gestapo interest\n4. All officially "reassigned" with no forwarding addresses\n\nThis is systematic. The regime is eliminating people with access to inconvenient historical truths.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Pattern: Multiple archivists/historians missing');
                    addClue('All missing persons worked with historical records');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            // Implement barracks actions
            reportToOfficer: {
                text: `You salute crisply. "All in order, Herr Untersturmführer."\n\nThe political officer studies you. "Your unit is on standby. Report to Sergeant Müller for duties."\n\nHe doesn't seem suspicious. For now.`,
                buttons: [
                    {text: "REPORT TO SERGEANT MÜLLER", action: "action", next: "reportToSergeant"},
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion -= 5;
                    updateStatsDisplay();
                }
            },
            
            reportToSergeant: {
                text: `Sergeant Müller assigns you to inventory duty. "Check the armory supplies. Everything should be accounted for."\n\nThis gives you access to the armory and time to look around.`,
                buttons: [
                    {text: "CHECK ARMORY", action: "action", next: "checkArmoryDetail"},
                    {text: "NOTICE ANYTHING UNUSUAL", action: "action", next: "noticeUnusual"},
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            checkArmoryDetail: {
                text: `The armory is well-stocked: rifles, pistols, ammunition. Everything appears normal until you check the logbook.\n\nInteresting entries:\n- "Special requisition: silenced weapons" (2 weeks ago)\n- "Night vision equipment transferred to Gestapo" (1 week ago)\n- "Ammunition usage higher than training accounts for" (noted in margins)\n\nSomeone has been conducting covert operations.`,
                buttons: [
                    {text: "MAKE NOTE OF THIS", action: "action", next: "noteArmoryFindings"},
                    {text: "IGNORE AND CONTINUE", action: "action", next: "continueArmoryCheck"},
                    {text: "REPORT ANOMALIES", action: "action", next: "reportAnomalies", danger: true}
                ],
                input: false
            },
            
            noteArmoryFindings: {
                text: `You discreetly note the unusual entries. Silenced weapons and night vision equipment suggest covert operations, possibly surveillance or arrests.\n\nThe timing coincides with the disappearances Bauer mentioned.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Armory records show silenced weapons requisitions');
                    addClue('Night vision equipment transferred to Gestapo');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            requestAlexanderplatz: {
                text: `"Leave for Alexanderplatz?" The political officer narrows his eyes. "For what purpose?"\n\nThis was a mistake. He's immediately suspicious.`,
                buttons: [
                    {text: "FAMILY MATTERS", action: "action", next: "familyMattersExcuse"},
                    {text: "PERSONAL ERRAND", action: "action", next: "personalErrandExcuse"},
                    {text: "WITHDRAW THE REQUEST", action: "action", next: "withdrawRequest"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 15;
                    updateStatsDisplay();
                    playSound('alert');
                }
            },
            
            familyMattersExcuse: {
                text: `"My sister is meeting me there," you say, trying to sound casual.\n\nThe officer studies you. "Very well. But be back before curfew. And remember, we're always watching."\n\nHe grants the leave, but you're now on his radar.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Political officer suspicious of Alexanderplatz request');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            askBarracksActivity: {
                text: `"Unusual activity?" The political officer's expression hardens. "What exactly have you noticed, soldier?"\n\nHis tone is threatening. This question has drawn unwanted attention.`,
                buttons: [
                    {text: "BACKTRACK QUICKLY", action: "action", next: "backtrackQuestion"},
                    {text: "MENTION THE ARMORY LOGS", action: "action", next: "mentionLogs", danger: true},
                    {text: "SALUTE AND WITHDRAW", action: "action", next: "saluteWithdraw"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 20;
                    updateStatsDisplay();
                    playSound('alert');
                }
            },
            
            backtrackQuestion: {
                text: `"Nothing specific, Herr Untersturmführer. Just... the increased readiness drills."\n\nHe relaxes slightly. "The Reich is always prepared. That is not 'unusual,' that is diligence."\n\n"Of course," you reply, saluting. Crisis averted, but he'll remember this.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            // Implement foreign office actions
            pressForDetails: {
                text: `Schmidt looks around nervously. "The archives... they contain records from the war years. Population statistics, transport manifests, camp administrations."\n\nHe lowers his voice further. "They don't match the official stories. The numbers... they're impossible if it was just 'resettlement.'"\n\nSchmidt is clearly terrified but wants someone to know.`,
                buttons: [
                    {text: "ASK ABOUT SPECIFIC RECORDS", action: "action", next: "askSpecificRecords"},
                    {text: "OFFER TO HELP", action: "action", next: "offerToHelpSchmidt"},
                    {text: "WARN HIM TO BE CAREFUL", action: "action", next: "warnSchmidt"},
                    {text: "REPORT HIM", action: "action", next: "reportSchmidt", danger: true}
                ],
                input: false
            },
            
            askSpecificRecords: {
                text: `"Transport records to the East," Schmidt whispers. "The numbers are... astronomical. And the destinations keep repeating: Auschwitz, Treblinka, Sobibor..."\n\nHe shows you a piece of paper with copied numbers. "These are from '42. The official population statistics don't account for these people. They just... vanished."`,
                buttons: [
                    {text: "TAKE THE PAPER", action: "action", next: "takeSchmidtPaper"},
                    {text: "MEMORIZE THE INFORMATION", action: "action", next: "memorizeInformation"},
                    {text: "REFUSE TO LOOK", action: "action", next: "refuseToLook", danger: true}
                ],
                input: false
            },
            
            takeSchmidtPaper: {
                text: `You take the paper and quickly hide it. "This is dangerous, Schmidt. You shouldn't have this."\n\n"I know," he says, looking relieved. "But someone needed to know. Be careful."\n\nYou now have documentary evidence, however small.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Schmidt\'s notes on transport records');
                    gameState.suspicion += 10;
                    updateStatsDisplay();
                }
            },
            
            offerToHelpSchmidt: {
                text: `"I can try to get you out," you whisper. "Or hide you."\n\nSchmidt shakes his head. "Too dangerous. They're watching me. But if you can get evidence out... that might be worth it."\n\nHe gives you a name: "Vogel, in the archives. He knows more. He was copying records before they were destroyed."`,
                buttons: [
                    {text: "THANK HIM AND LEAVE", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Schmidt identifies Vogel as key source');
                    gameState.trustWithVogel += 10;
                }
            },
            
            suggestDiscreetMeeting: {
                text: `"We should meet somewhere safe to discuss this further," you suggest.\n\nSchmidt considers, then writes an address on a slip of paper. "Tonight. 22:00. Come alone."\n\nHe disappears into the crowd of diplomats before you can respond.`,
                buttons: [
                    {text: "GO TO MEETING TONIGHT", action: "advanceTime", next: "schmidtMeeting"},
                    {text: "IGNORE THE INVITATION", action: "loadScene", next: "apartment"},
                    {text: "REPORT THE MEETING", action: "action", next: "reportMeeting", danger: true}
                ],
                input: false,
                onLoad: () => {
                    addClue('Meeting arranged with Schmidt');
                }
            },
            
            schmidtMeeting: {
                text: `The address leads to a small cafe in a quiet neighborhood. Schmidt is already there, looking even more nervous.\n\n"I shouldn't have said anything at the office," he begins. "But I had to tell someone. The lies... they're eating away at everything."\n\nHe slides an envelope across the table. "Photocopies. Not much, but it's a start."`,
                buttons: [
                    {text: "TAKE THE ENVELOPE", action: "action", next: "takeEnvelope"},
                    {text: "ASK FOR MORE INFORMATION", action: "action", next: "askMoreInfo"},
                    {text: "LEAVE IMMEDIATELY", action: "action", next: "leaveImmediately"}
                ],
                input: false,
                onLoad: () => {
                    gameState.time = '22:00';
                    updateStatsDisplay();
                    playSound('door');
                }
            },
            
            takeEnvelope: {
                text: `You take the envelope and quickly put it in your coat. "This is dangerous for both of us."\n\n"I know," Schmidt says. "But the truth has to come out someday. Maybe not in our lifetime, but someday."\n\nHe stands to leave. "Good luck. And remember Vogel."`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Schmidt\'s envelope with copied documents');
                    gameState.suspicion += 15;
                    updateStatsDisplay();
                }
            },
            
            // Implement alexanderplatzScout actions
            approachVendor: {
                text: `The newspaper vendor watches you approach. "Paper? Last edition."\n\nHis eyes dart around nervously. He's definitely more than just a vendor.`,
                buttons: [
                    {text: "BUY A PAPER", action: "action", next: "buyPaperFromVendor"},
                    {text: "ASK ABOUT SURVEILLANCE", action: "action", next: "askAboutSurveillance", danger: true},
                    {text: "GIVE RECOGNITION SIGNAL", action: "action", next: "giveSignal", condition: () => gameState.playerClass === 'investigator'},
                    {text: "LEAVE HIM ALONE", action: "loadScene", next: "alexanderplatzScout"}
                ],
                input: false
            },
            
            buyPaperFromVendor: {
                text: `You buy a paper. As he hands it to you, he whispers, "Not safe here. They're watching everyone. The man you're meeting... he's in danger."\n\nBefore you can respond, he turns to another customer. The exchange is over.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Newspaper vendor warned of danger');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            confrontGestapo: {
                text: `You approach the two Gestapo agents. "Is there a problem here?"\n\nThey look you over. One checks a clipboard. "Just routine surveillance. Move along."\n\nTheir demeanor is professional but cold. They're not going to reveal anything.`,
                buttons: [
                    {text: "SHOW YOUR BADGE", action: "useItem", item: "kripoBadge", condition: () => hasItem('kripoBadge')},
                    {text: "DEMAND TO KNOW THEIR BUSINESS", action: "action", next: "demandTheirBusiness", danger: true},
                    {text: "APOLOGIZE AND LEAVE", action: "loadScene", next: "alexanderplatzScout"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 20;
                    updateStatsDisplay();
                    playSound('alert');
                }
            },
            
            demandTheirBusiness: {
                text: `"I have a right to know why you're surveilling this area!" you say firmly.\n\nThe agents exchange glances. One steps closer. "We ask the questions here. Now, identification."\n\nThis confrontation has attracted attention. Other plainclothes officers are moving toward you.`,
                buttons: [
                    {text: "SHOW IDENTIFICATION", action: "useItem", item: hasItem('kripoBadge') ? 'kripoBadge' : (hasItem('forgedPass') ? 'forgedPass' : null), condition: () => hasItem('kripoBadge') || hasItem('forgedPass')},
                    {text: "REFUSE AND LEAVE", action: "action", next: "refuseAndLeave"},
                    {text: "RUN", action: "action", next: "runFromGestapo"}
                ],
                input: false
            },
            
            refuseAndLeave: {
                text: `You turn and walk away quickly. One agent follows for a block before stopping.\n\n"You're making a mistake!" he calls after you.\n\nYou've drawn serious attention to yourself. The meeting tonight will be even more dangerous.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 30;
                    updateStatsDisplay();
                }
            },
            
            findAlternativeSpot: {
                text: `You scout the area for alternative meeting locations:\n\n1. Memorial church entrance - too open\n2. Department store cafe - crowded, good cover\n3. Side street near post office - dark, fewer watchers\n4. U-Bahn platform itself - risky but surveilled\n\nThe cafe might work if you can get Vogel there instead.`,
                buttons: [
                    {text: "LEAVE NOTE AT ORIGINAL SPOT", action: "action", next: "leaveNote"},
                    {text: "WAIT AND INTERCEPT VOGEL", action: "action", next: "interceptVogel"},
                    {text: "RETURN TO ORIGINAL PLAN", action: "loadScene", next: "alexanderplatzScout"}
                ],
                input: false
            },
            
            leaveNote: {
                text: `You write a brief note: "Cafe instead. Follow." and leave it discreetly at the U-Bahn entrance.\n\nIf Vogel checks carefully, he'll find it. But there's risk the wrong people might find it first.`,
                buttons: [
                    {text: "GO TO CAFE TO WAIT", action: "advanceTime", next: "cafeMeeting"},
                    {text: "ABANDON THE ATTEMPT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    addClue('Left redirect note for Vogel at U-Bahn');
                    gameState.suspicion += 5;
                    updateStatsDisplay();
                }
            },
            
            cafeMeeting: {
                text: `You wait in the department store cafe. 20:00 comes and goes. No Vogel.\n\nAt 20:15, a man enters and scans the room. It's Vogel. He spots you and approaches cautiously.\n\n"You changed the location?" he whispers, sitting down. "Good thinking. The U-Bahn was being watched."`,
                buttons: [
                    {text: "CONTINUE MEETING", action: "loadScene", next: "alexanderplatzMeeting"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion -= 10; // Successfully avoided surveillance
                    updateStatsDisplay();
                }
            },
            
            abandonMeeting: {
                text: `You decide the risk is too great. The surveillance is intense, and this feels like a trap.\n\nYou leave Alexanderplatz and return home. The opportunity to learn the truth slips away.\n\nBut you're alive and not in Gestapo custody. Sometimes survival is its own victory.`,
                buttons: [
                    {text: "CONTINUE", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion -= 15;
                    gameState.reputation -= 20;
                    updateStatsDisplay();
                    playSound('error');
                }
            },
            
            // Additional scenes for completeness
            newspaper: {
                text: `LOCAL NEWSPAPER STAND\n\nThe Berliner Tageblatt headlines proclaim Reich achievements:\n\n"FÜHRER ANNOUNCES NEW SPACE PROGRAM"\n"AFRICAN COLONIES REPORT RECORD PRODUCTION"\n"EASTERN TERRITORIES PACIFIED"\n\nBuried on page 7:\n\n"MISSING PERSONS DEPARTMENT DISBANDED"\n"The Ministry of Interior announced today that the Missing Persons Department will be absorbed into the General Police Administration. 'Modern record-keeping makes a separate department unnecessary,' a spokesman said."\n\nInteresting. The newspaper vendor watches you nervously.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"},
                    {text: "BUY NEWSPAPER", action: "action", next: "buyNewspaper", condition: () => gameState.money >= 2},
                    {text: "QUESTION VENDOR", action: "action", next: "questionVendor"},
                    {text: "CHECK OTHER PAPERS", action: "action", next: "checkOtherPapers"}
                ],
                input: true,
                onLoad: () => {
                    playSound('type');
                    addLocation('Newspaper Stand');
                }
            },
            
            buyNewspaper: {
                text: `You buy the paper. The vendor gives you a meaningful look as he hands it over.\n\nReading more carefully, you notice other small items:\n- "Archival Services Reorganization" (page 9)\n- "Historical Records Digitization Project" (page 11)\n- "Retirement of Senior Archivists" (page 12)\n\nThey're systematically removing people with knowledge of the old records.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.money -= 2;
                    addClue('Newspaper shows systematic removal of archivists');
                    updateStatsDisplay();
                }
            },
            
            archiveVisit: {
                text: `PROPAGANDA MINISTRY ARCHIVES\n\nThe archive is a cavernous hall filled with rows of filing cabinets. Dust motes dance in shafts of light from high windows. The air smells of paper and disinfectant.\n\nA clerk with thick glasses eyes you suspiciously from behind a protective cage.\n\n"Access requires Level 4 clearance," he states flatly, not looking up from his ledger. "State your business."`,
                buttons: [
                    {text: "SHOW KRIPO BADGE", action: "useItem", item: "kripoBadge", condition: () => hasItem('kripoBadge')},
                    {text: "PRESENT FORGED PASS", action: "useItem", item: "forgedPass", condition: () => hasItem('forgedPass')},
                    {text: "OFFER BRIBE", action: "useItem", item: "money", condition: () => hasItem('money') && gameState.money >= 25},
                    {text: "CLAIM URGENT MINISTRY BUSINESS", action: "action", next: "claimUrgentBusiness"},
                    {text: "ASK ABOUT VOGEL", action: "action", next: "askAboutVogelArchive", danger: true},
                    {text: "LEAVE QUIETLY", action: "loadScene", next: "apartment"}
                ],
                input: true,
                onLoad: () => {
                    playSound('door');
                    addLocation('Ministry Archives');
                }
            },
            
            claimUrgentBusiness: {
                text: `"Urgent ministry business?" the clerk repeats skeptically. "Which ministry? What department? Who sent you?"\n\nHe's well-trained to spot imposters. You'll need a convincing story or credentials.`,
                buttons: [
                    {text: "PROPAGANDA MINISTRY, SECTION B", action: "action", next: "propagandaMinistryClaim"},
                    {text: "INTERIOR MINISTRY AUDIT", action: "action", next: "interiorMinistryClaim"},
                    {text: "APOLOGIZE AND LEAVE", action: "loadScene", next: "apartment"}
                ],
                input: false
            },
            
            propagandaMinistryClaim: {
                text: `The clerk checks a list. "Section B was disbanded last month. Try again."\n\nHe reaches for a phone. "Security, please."\n\nThis was a mistake.`,
                buttons: [
                    {text: "RUN", action: "action", next: "runFromArchive"},
                    {text: "BLUFF FURTHER", action: "action", next: "bluffFurther", danger: true}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 25;
                    updateStatsDisplay();
                    playSound('alert');
                }
            },
            
            runFromArchive: {
                text: `You turn and hurry out of the archive before security arrives. Running draws attention, but staying would be worse.\n\nYou've definitely attracted suspicion, but you escaped immediate capture.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 10;
                    updateStatsDisplay();
                    playSound('footsteps');
                }
            },
            
            askAboutVogelArchive: {
                text: `"Vogel?" The clerk's eyes narrow. "Why are you asking about Vogel?"\n\nHe doesn't wait for an answer, pressing a hidden button. A silent alarm.\n\n"Security is on the way. Don't move."\n\nYou've walked into a trap. They were waiting for someone to ask about Vogel.`,
                buttons: [
                    {text: "RUN IMMEDIATELY", action: "action", next: "runArchiveTrap"},
                    {text: "TRY TO TALK YOUR WAY OUT", action: "action", next: "talkWayOut", danger: true},
                    {text: "PREPARE TO FIGHT", action: "useItem", item: "pistol", condition: () => hasItem('pistol')}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 40;
                    updateStatsDisplay();
                    playSound('alert');
                }
            },
            
            runArchiveTrap: {
                text: `You bolt for the exit. Shouts behind you. You crash through the doors into the street.\n\nA black sedan screeches to a halt. Men jump out. They were waiting outside too.\n\nIt's a coordinated trap. They knew someone might come asking about Vogel.`,
                buttons: [
                    {text: "RUN DOWN ALLEY", action: "action", next: "runDownAlley"},
                    {text: "BLEND INTO CROWD", action: "useItem", item: "disguise", condition: () => hasItem('disguise')},
                    {text: "FIGHT YOUR WAY OUT", action: "action", next: "fightWayOut", condition: () => hasItem('pistol')}
                ],
                input: false
            },
            
            runDownAlley: {
                text: `You sprint down a narrow alley. The pursuers are close behind. At the end of the alley, you face a choice: left toward busy streets, or right toward the river.`,
                buttons: [
                    {text: "GO LEFT TO BUSY STREETS", action: "action", next: "goToBusyStreets"},
                    {text: "GO RIGHT TOWARD RIVER", action: "action", next: "goTowardRiver"},
                    {text: "HIDE IN DOORWAY", action: "action", next: "hideInDoorway"}
                ],
                input: false,
                onLoad: () => playSound('footsteps')
            },
            
            goToBusyStreets: {
                text: `You emerge onto a busy shopping street. Blending into the crowd, you slow to a walk, trying to look normal.\n\nThe pursuers emerge from the alley, scanning the crowd. They don't spot you immediately.\n\nYou've temporarily lost them, but they have your description. You need to get off the streets.`,
                buttons: [
                    {text: "RETURN TO APARTMENT", action: "loadScene", next: "apartment"}
                ],
                input: false,
                onLoad: () => {
                    gameState.suspicion += 20;
                    updateStatsDisplay();
                }
            }
        };

        // Additional endings and game over scenes
        scenes.gameOverGestapo = {
            text: `GAME OVER\n\nYou have been detained by the Gestapo. In the cellar of Prinz-Albrecht-Straße 8, questions are asked that have no right answers.\n\nDays blur into weeks. Interrogation. Isolation. Finally, a transfer to a "reeducation camp" in the East.\n\nThe truth dies with you, and the Reich's lies continue unchallenged.\n\nYour suspicion level was too high. In the Reich, curiosity is a capital crime.`,
            buttons: [
                {text: "RESTART GAME", action: "action", next: "restartGame"}
            ],
            input: false,
            onLoad: () => playSound('error')
        };
        
        scenes.gameOverKilled = {
            text: `GAME OVER\n\nA bullet finds its mark. The world fades to black.\n\nVogel's evidence is lost. The truth remains buried.\n\nThe Reich continues, its foundations unchallenged, its crimes unknown to history.\n\nSome battles are fought in shadows, and some are lost there too.`,
            buttons: [
                {text: "RESTART GAME", action: "action", next: "restartGame"}
            ],
            input: false,
            onLoad: () => playSound('gunshot')
        };
        
        scenes.restartGame = {
            text: `Would you like to restart the game? All progress will be lost.`,
            buttons: [
                {text: "YES, RESTART", action: "hardReset"},
                {text: "NO, CONTINUE", action: "loadScene", next: "apartment"}
            ],
            input: false
        };

        // DOM Elements
        const textOutput = document.getElementById('text-output');
        const buttonContainer = document.getElementById('button-container');
        const commandLine = document.getElementById('command-line');
        const inputLine = document.getElementById('input-line');
        const inventoryItems = document.getElementById('inventory-items');
        const cluesList = document.getElementById('clues-list');
        const statsDisplay = document.getElementById('stats-display');
        const healthBar = document.getElementById('health-bar');
        const healthText = document.getElementById('health-text');
        const suspicionBar = document.getElementById('suspicion-bar');
        const suspicionText = document.getElementById('suspicion-text');
        const classValue = document.getElementById('class-value');
        const inventoryCount = document.getElementById('inventory-count');
        const cluesCount = document.getElementById('clues-count');
        const itemModal = document.getElementById('item-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalItemName = document.getElementById('modal-item-name');
        const modalItemDescription = document.getElementById('modal-item-description');
        const modalButtons = document.getElementById('modal-buttons');
        const closeModal = document.getElementById('close-modal');
        const combineModal = document.getElementById('combine-modal');
        const combineItemsContainer = document.getElementById('combine-items-container');
        const combineResult = document.getElementById('combine-result');
        const closeCombineModal = document.getElementById('close-combine-modal');
        const helpModal = document.getElementById('help-modal');
        const closeHelpModal = document.getElementById('close-help-modal');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const soundBtn = document.getElementById('sound-btn');
        const helpBtn = document.getElementById('help-btn');

        // Sound Manager Instance
        const soundManager = new SoundManager();

        // Utility Functions
        function playSound(soundName) {
            if (gameState.soundEnabled && soundManager) {
                soundManager.play(soundName);
            }
        }

        function addLocation(locationName) {
            if (!gameState.knownLocations.includes(locationName)) {
                gameState.knownLocations.push(locationName);
                showNotification(`New location discovered: ${locationName}`);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function getTimeUntilMeeting() {
            const times = ['06:00', '08:00', '12:00', '15:00', '18:00', '20:00', '22:00'];
            const currentIndex = times.indexOf(gameState.time);
            const meetingIndex = times.indexOf('20:00');
            
            if (currentIndex < meetingIndex) {
                return `${meetingIndex - currentIndex} hour${meetingIndex - currentIndex > 1 ? 's' : ''}`;
            } else if (currentIndex === meetingIndex) {
                return 'NOW';
            } else {
                return 'TOMORROW';
            }
        }

        function checkGameOver() {
            if (gameState.suspicion >= 100) {
                loadScene('gameOverGestapo');
                return true;
            }
            if (gameState.health <= 0) {
                loadScene('gameOverKilled');
                return true;
            }
            return false;
        }

        // Game Functions
        function initGame() {
            loadScene('start');
            updateInventoryDisplay();
            updateCluesDisplay();
            updateStatsDisplay();
            
            // Set up input handler
            inputLine.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
            
            // Set up modal close handlers
            closeModal.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', hideModal);
            closeCombineModal.addEventListener('click', hideCombineModal);
            closeHelpModal.addEventListener('click', hideHelpModal);
            
            // Set up control buttons
            saveBtn.addEventListener('click', saveGame);
            loadBtn.addEventListener('click', loadGame);
            soundBtn.addEventListener('click', toggleSound);
            helpBtn.addEventListener('click', showHelp);
            
            // Focus on input line
            inputLine.focus();
            
            // Initial typing effect
            typeText("SYSTEM BOOT...\nFATHERLAND LEGACY v3.0\n\nINITIALIZING...", 50);
        }

        function typeText(text, speed = 30) {
            textOutput.innerHTML = '';
            let i = 0;
            
            function typeChar() {
                if (i < text.length) {
                    textOutput.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(typeChar, speed);
                    scrollToBottom();
                }
            }
            
            typeChar();
        }

        function addText(text) {
            textOutput.innerHTML += text;
            scrollToBottom();
        }

        function scrollToBottom() {
            const screen = document.getElementById('screen');
            setTimeout(() => {
                screen.scrollTop = screen.scrollHeight;
            }, 100);
        }

        function loadScene(sceneId) {
            if (checkGameOver()) return;
            
            gameState.currentScene = sceneId;
            const scene = scenes[sceneId];
            
            if (!scene) {
                console.error(`Scene ${sceneId} not found`);
                return;
            }
            
            // Update game state
            gameState.location = sceneId;
            
            // Clear buttons
            buttonContainer.innerHTML = '';
            
            // Show/hide command line
            if (scene.input === false) {
                commandLine.classList.add('hidden');
            } else {
                commandLine.classList.remove('hidden');
            }
            
            // Display scene text
            if (typeof scene.text === 'function') {
                textOutput.innerHTML = scene.text();
            } else {
                textOutput.innerHTML = scene.text;
            }
            
            // Add buttons
            if (scene.buttons && scene.buttons.length > 0) {
                scene.buttons.forEach(button => {
                    if (button.condition && !button.condition()) {
                        return;
                    }
                    
                    const buttonElement = document.createElement('button');
                    buttonElement.className = `game-button ${button.class || ''}`;
                    if (button.danger) {
                        buttonElement.classList.add('danger');
                    }
                    buttonElement.textContent = button.text;
                    buttonElement.dataset.action = button.action;
                    
                    if (button.action === 'useItem') {
                        buttonElement.dataset.item = button.item;
                    } else {
                        buttonElement.dataset.next = button.next;
                    }
                    
                    if (button.class) {
                        buttonElement.dataset.class = button.class;
                    }
                    
                    buttonContainer.appendChild(buttonElement);
                });
                buttonContainer.classList.remove('hidden');
            } else {
                buttonContainer.classList.add('hidden');
            }
            
            // Call scene onLoad if exists
            if (scene.onLoad) {
                scene.onLoad();
            }
            
            scrollToBottom();
        }

        function processCommand(command) {
            if (!command.trim()) return;
            
            addText(`\n\n&gt; ${command}\n`);
            playSound('type');
            
            const cmd = command.toLowerCase().trim();
            const parts = cmd.split(' ');
            const mainCmd = parts[0];
            
            switch(mainCmd) {
                case 'help':
                case '?':
                    showHelp();
                    break;
                    
                case 'inv':
                case 'inventory':
                    showInventory();
                    break;
                    
                case 'use':
                    if (parts.length > 1) {
                        const itemName = parts.slice(1).join(' ');
                        useInventoryItem(itemName);
                    } else {
                        addText(`\nUse what? Example: USE PISTOL`);
                    }
                    break;
                    
                case 'combine':
                    if (parts.length >= 3) {
                        const item1 = parts[1];
                        const item2 = parts[2];
                        combineItems(item1, item2);
                    } else {
                        addText(`\nCombine what? Example: COMBINE PISTOL SILENCER`);
                        addText(`\nOr use COMBINE to open combination interface.`);
                    }
                    break;
                    
                case 'status':
                    displayStatus();
                    break;
                    
                case 'time':
                    addText(`\nCurrent time: ${gameState.time}, Day ${gameState.day}`);
                    break;
                    
                case 'look':
                    addText(`\nYou examine your surroundings carefully...`);
                    // Reload scene description
                    const scene = scenes[gameState.currentScene];
                    if (scene) {
                        addText(`\n\n${typeof scene.text === 'function' ? scene.text() : scene.text}`);
                    }
                    break;
                    
                case 'save':
                    saveGame();
                    break;
                    
                case 'load':
                    loadGame();
                    break;
                    
                case 'map':
                    showMap();
                    break;
                    
                case 'cls':
                case 'clear':
                    textOutput.innerHTML = '';
                    break;
                    
                default:
                    addText(`\nUnknown command. Type HELP for available commands.`);
                    playSound('error');
            }
            
            scrollToBottom();
        }

        // Event Delegation for Game Buttons
        document.addEventListener('click', function(event) {
            const button = event.target.closest('.game-button');
            if (!button) return;
            
            const action = button.dataset.action;
            const next = button.dataset.next;
            const playerClass = button.dataset.class;
            const item = button.dataset.item;
            
            playSound('click');
            
            switch(action) {
                case 'selectClass':
                    selectClass(playerClass);
                    break;
                case 'loadScene':
                    loadScene(next);
                    break;
                case 'action':
                    performAction(next);
                    break;
                case 'useItem':
                    useInventoryItem(item);
                    break;
                case 'showInventory':
                    showInventory();
                    break;
                case 'showCombineModal':
                    showCombineModal();
                    break;
                case 'advanceTime':
                    advanceTime(next);
                    break;
                case 'hardReset':
                    hardReset();
                    break;
            }
        });

        // Event Delegation for Inventory Items
        inventoryItems.addEventListener('click', function(event) {
            const itemElement = event.target.closest('.inventory-item');
            if (!itemElement) return;
            
            const itemId = itemElement.dataset.itemId;
            if (itemId) {
                playSound('click');
                showItemModal(itemId);
            }
        });

        function selectClass(className) {
            gameState.playerClass = className;
            classValue.textContent = className.toUpperCase();
            
            // Add starting items
            const startingItemsList = startingItems[className];
            startingItemsList.forEach(itemId => {
                addItem(itemId);
            });
            
            // Add class-specific clue
            addClue(`Assigned as ${className.toUpperCase()}`);
            
            updateInventoryDisplay();
            updateStatsDisplay();
            loadScene('classSelected');
        }

        function addItem(itemId) {
            if (!gameState.inventory.some(item => item.id === itemId)) {
                const item = items[itemId];
                if (item) {
                    gameState.inventory.push(item);
                    updateInventoryDisplay();
                    playSound('item');
                    showNotification(`Acquired: ${item.name}`);
                }
            }
        }

        function removeItem(itemId) {
            gameState.inventory = gameState.inventory.filter(item => item.id !== itemId);
            updateInventoryDisplay();
        }

        function hasItem(itemId) {
            return gameState.inventory.some(item => item.id === itemId);
        }

        function updateInventoryDisplay() {
            inventoryItems.innerHTML = '';
            inventoryCount.textContent = `(${gameState.inventory.length})`;
            
            if (gameState.inventory.length === 0) {
                inventoryItems.innerHTML = '<div style="color: #888; font-style: italic;">No items</div>';
                return;
            }
            
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.dataset.itemId = item.id;
                
                const description = typeof item.description === 'function' ? item.description() : item.description;
                
                itemElement.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${item.name}</div>
                        <div style="font-size: 12px; color: #8f8;">${description}</div>
                    </div>
                    ${item.usable ? '<button class="item-use-btn">USE</button>' : ''}
                `;
                inventoryItems.appendChild(itemElement);
            });
        }

        function updateCluesDisplay() {
            cluesList.innerHTML = '';
            cluesCount.textContent = `(${gameState.clues.length})`;
            
            if (gameState.clues.length === 0) {
                cluesList.innerHTML = '<div style="color: #888; font-style: italic;">No clues yet</div>';
                return;
            }
            
            gameState.clues.forEach(clue => {
                const clueElement = document.createElement('div');
                clueElement.className = 'clue-item';
                clueElement.textContent = clue;
                cluesList.appendChild(clueElement);
            });
        }

        function addClue(clueText) {
            if (!gameState.clues.includes(clueText)) {
                gameState.clues.push(clueText);
                updateCluesDisplay();
                playSound('success');
                showNotification(`New clue: ${clueText}`);
            }
        }

        function updateStatsDisplay() {
            let statsHTML = `
                <div><strong>Day:</strong> ${gameState.day}</div>
                <div><strong>Time:</strong> ${gameState.time}</div>
                <div><strong>Reputation:</strong> ${gameState.reputation}/100</div>
                <div><strong>Money:</strong> ${gameState.money} RM</div>
                <div><strong>Stamina:</strong> ${gameState.stamina}/100</div>
                <div><strong>Location:</strong> ${gameState.location}</div>
                <div><strong>Known Locations:</strong> ${gameState.knownLocations.length}</div>
            `;
            
            statsDisplay.innerHTML = statsHTML;
            
            // Update health and suspicion bars
            healthBar.style.width = `${gameState.health}%`;
            healthText.textContent = gameState.health;
            suspicionBar.style.width = `${gameState.suspicion}%`;
            suspicionText.textContent = gameState.suspicion;
            
            // Update status bar color based on suspicion
            const statusBar = document.getElementById('status-bar');
            if (gameState.suspicion > 70) {
                statusBar.style.borderTopColor = '#f00';
                statusBar.style.boxShadow = '0 0 10px #f00';
            } else if (gameState.suspicion > 40) {
                statusBar.style.borderTopColor = '#ff0';
                statusBar.style.boxShadow = '0 0 5px #ff0';
            } else {
                statusBar.style.borderTopColor = '#0a0';
                statusBar.style.boxShadow = 'none';
            }
        }

        function updateHealthDisplay() {
            healthBar.style.width = `${gameState.health}%`;
            healthText.textContent = gameState.health;
        }

        function showItemModal(itemId) {
            const item = items[itemId];
            if (!item) return;
            
            modalItemName.textContent = item.name;
            const description = typeof item.description === 'function' ? item.description() : item.description;
            modalItemDescription.textContent = description;
            
            modalButtons.innerHTML = '';
            
            if (item.usable) {
                const useButton = document.createElement('button');
                useButton.className = 'game-button';
                useButton.textContent = item.useText || 'USE';
                useButton.addEventListener('click', () => {
                    useInventoryItem(itemId);
                    hideModal();
                });
                modalButtons.appendChild(useButton);
            }
            
            if (item.canExamine) {
                const examineButton = document.createElement('button');
                examineButton.className = 'game-button';
                examineButton.textContent = 'EXAMINE';
                examineButton.addEventListener('click', () => {
                    addText(`\n\n${item.examineText}`);
                    hideModal();
                });
                modalButtons.appendChild(examineButton);
            }
            
            if (item.canCombineWith && item.canCombineWith.length > 0) {
                const combineButton = document.createElement('button');
                combineButton.className = 'game-button';
                combineButton.textContent = 'COMBINE WITH...';
                combineButton.addEventListener('click', () => {
                    showCombineModal(itemId);
                    hideModal();
                });
                modalButtons.appendChild(combineButton);
            }
            
            const closeButton = document.createElement('button');
            closeButton.className = 'game-button';
            closeButton.textContent = 'CLOSE';
            closeButton.addEventListener('click', hideModal);
            modalButtons.appendChild(closeButton);
            
            itemModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');
        }

        function hideModal() {
            itemModal.classList.add('hidden');
            modalOverlay.classList.add('hidden');
        }

        function showCombineModal(selectedItem = null) {
            combineItemsContainer.innerHTML = '';
            combineResult.classList.add('hidden');
            
            if (gameState.inventory.length < 2) {
                combineResult.textContent = "You need at least 2 items to combine.";
                combineResult.classList.remove('hidden');
                return;
            }
            
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'combine-item';
                itemElement.textContent = item.name;
                itemElement.dataset.itemId = item.id;
                
                if (selectedItem && selectedItem !== item.id) {
                    // Check if combination is possible
                    const combinationKey1 = `${selectedItem}+${item.id}`;
                    const combinationKey2 = `${item.id}+${selectedItem}`;
                    
                    if (itemCombinations[combinationKey1] || itemCombinations[combinationKey2]) {
                        itemElement.style.borderColor = '#0a0';
                        itemElement.style.cursor = 'pointer';
                        itemElement.addEventListener('click', () => {
                            combineItems(selectedItem, item.id);
                        });
                    } else {
                        itemElement.style.opacity = '0.5';
                        itemElement.style.cursor = 'not-allowed';
                    }
                } else if (!selectedItem) {
                    itemElement.style.cursor = 'pointer';
                    itemElement.addEventListener('click', () => {
                        showCombineModal(item.id);
                    });
                }
                
                combineItemsContainer.appendChild(itemElement);
            });
            
            combineModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');
        }

        function hideCombineModal() {
            combineModal.classList.add('hidden');
            modalOverlay.classList.add('hidden');
        }

        function combineItems(itemId1, itemId2) {
            const combinationKey1 = `${itemId1}+${itemId2}`;
            const combinationKey2 = `${itemId2}+${itemId1}`;
            
            const combination = itemCombinations[combinationKey1] || itemCombinations[combinationKey2];
            
            if (combination) {
                // Remove original items
                removeItem(itemId1);
                removeItem(itemId2);
                
                // Add new item
                addItem(combination.result);
                
                // Show result
                combineResult.textContent = combination.message;
                combineResult.classList.remove('hidden');
                
                playSound('success');
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    hideCombineModal();
                }, 3000);
            } else {
                combineResult.textContent = "These items cannot be combined.";
                combineResult.classList.remove('hidden');
                playSound('error');
            }
        }

        function useInventoryItem(itemId) {
            const item = items[itemId];
            if (!item || !item.usable) {
                addText(`\nCannot use ${item?.name || 'that item'}.`);
                playSound('error');
                return;
            }
            
            // Check class restriction
            if (item.classRestriction && !item.classRestriction.includes(gameState.playerClass)) {
                addText(`\nYou are not trained to use ${item.name}.`);
                playSound('error');
                return;
            }
            
            // Apply item effect
            const effect = item.useEffect(gameState.currentScene);
            
            if (effect) {
                // Apply effects to game state
                if (effect.suspicion) {
                    gameState.suspicion = Math.max(0, Math.min(100, gameState.suspicion + effect.suspicion));
                }
                
                if (effect.health) {
                    gameState.health = Math.min(100, gameState.health + effect.health);
                }
                
                if (effect.stamina) {
                    gameState.stamina = Math.min(100, gameState.stamina + effect.stamina);
                }
                
                if (effect.access) {
                    addText(`\nAccess granted.`);
                }
                
                if (effect.clue) {
                    // Clue already added in useEffect
                }
                
                updateStatsDisplay();
                playSound('success');
            } else {
                addText(`\nUsing ${item.name} has no effect here.`);
                playSound('error');
            }
            
            scrollToBottom();
        }

        function showInventory() {
            addText(`\n\n=== INVENTORY ===\n`);
            if (gameState.inventory.length === 0) {
                addText(`No items.`);
            } else {
                gameState.inventory.forEach(item => {
                    const description = typeof item.description === 'function' ? item.description() : item.description;
                    addText(`${item.name}: ${description}\n`);
                });
            }
            addText(`\nMoney: ${gameState.money} RM`);
            scrollToBottom();
        }

        function displayStatus() {
            const statusText = `
=== FULL STATUS REPORT ===
CLASS: ${gameState.playerClass ? gameState.playerClass.toUpperCase() : 'NONE'}
HEALTH: ${gameState.health}/100
SUSPICION: ${gameState.suspicion}/100 (${getSuspicionLevel()})
REPUTATION: ${gameState.reputation}/100
STAMINA: ${gameState.stamina}/100
MONEY: ${gameState.money} RM
DAY: ${gameState.day}
TIME: ${gameState.time}
LOCATION: ${gameState.location}

CLUES FOUND: ${gameState.clues.length}
INVENTORY ITEMS: ${gameState.inventory.length}
KNOWN LOCATIONS: ${gameState.knownLocations.join(', ')}
            `;
            
            addText(statusText);
        }

        function getSuspicionLevel() {
            if (gameState.suspicion < 20) return "Low";
            if (gameState.suspicion < 40) return "Moderate";
            if (gameState.suspicion < 60) return "High";
            if (gameState.suspicion < 80) return "Very High";
            return "EXTREME - IMMINENT DANGER";
        }

        function performAction(actionId) {
            // Check if scene exists, if not show default response
            if (scenes[actionId]) {
                loadScene(actionId);
                return;
            }
            
            // Handle specific actions
            switch(actionId) {
                case 'restartGame':
                    if (confirm("Restart game? All progress will be lost.")) {
                        hardReset();
                    }
                    break;
                    
                default:
                    // For any unimplemented action that doesn't have a scene
                    addText(`\n(This action would continue the story, but this demo focuses on the early game. The full game would continue from here.)`);
                    addText(`\n\nFor demonstration purposes, let's assume you succeeded and return to the main story path.`);
                    
                    // Provide a way to continue
                    setTimeout(() => {
                        if (gameState.evidenceSecured) {
                            loadScene('studyEvidence');
                        } else {
                            loadScene('apartment');
                        }
                    }, 2000);
            }
            
            scrollToBottom();
        }

        function advanceTime(nextScene) {
            // Simple time advancement
            const times = ['06:00', '08:00', '12:00', '15:00', '18:00', '20:00', '22:00'];
            const currentIndex = times.indexOf(gameState.time);
            
            if (currentIndex < times.length - 1) {
                gameState.time = times[currentIndex + 1];
            } else {
                gameState.time = '06:00';
                gameState.day++;
                addText(`\n\n=== DAY ${gameState.day} BEGINS ===`);
            }
            
            // Restore some stamina with time
            gameState.stamina = Math.min(100, gameState.stamina + 20);
            
            // Increase suspicion as time passes (Gestapo gets more active)
            if (gameState.time === '22:00') {
                gameState.suspicion = Math.min(100, gameState.suspicion + 5);
            }
            
            updateStatsDisplay();
            
            // Check for game over due to time (curfew)
            if (gameState.time === '22:00' && gameState.location !== 'apartment' && gameState.location !== 'safeHouse') {
                if (Math.random() < 0.3) { // 30% chance of getting caught after curfew
                    addText(`\n\nCurfew violation detected by patrol!`);
                    gameState.suspicion += 30;
                    updateStatsDisplay();
                    if (gameState.suspicion >= 100) {
                        setTimeout(() => loadScene('gameOverGestapo'), 1500);
                        return;
                    }
                }
            }
            
            loadScene(nextScene);
        }

        function saveGame() {
            const saveData = {
                state: gameState,
                timestamp: new Date().toISOString(),
                version: '3.0'
            };
            
            try {
                localStorage.setItem('fatherlandLegacySave', JSON.stringify(saveData));
                showNotification('Game saved successfully!');
                playSound('success');
            } catch (e) {
                showNotification('Error saving game.');
                playSound('error');
            }
        }

        function loadGame() {
            try {
                const saveData = JSON.parse(localStorage.getItem('fatherlandLegacySave'));
                if (saveData && saveData.state) {
                    Object.assign(gameState, saveData.state);
                    updateInventoryDisplay();
                    updateCluesDisplay();
                    updateStatsDisplay();
                    showNotification('Game loaded successfully!');
                    playSound('success');
                    
                    // Return to current scene
                    if (gameState.currentScene) {
                        loadScene(gameState.currentScene);
                    }
                } else {
                    showNotification('No saved game found.');
                    playSound('error');
                }
            } catch (e) {
                showNotification('Error loading game.');
                playSound('error');
            }
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            soundBtn.textContent = `SOUND: ${gameState.soundEnabled ? 'ON' : 'OFF'}`;
            soundBtn.classList.toggle('active', gameState.soundEnabled);
            playSound('click');
        }

        function showHelp() {
            helpModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');
            playSound('click');
        }

        function hideHelpModal() {
            helpModal.classList.add('hidden');
            modalOverlay.classList.add('hidden');
        }

        function showMap() {
            addText(`\n\n=== KNOWN LOCATIONS ===\n`);
            gameState.knownLocations.forEach(location => {
                addText(`- ${location}\n`);
            });
            addText(`\nCurrent location: ${gameState.location}`);
        }

        function hardReset() {
            // Reset game state
            Object.keys(gameState).forEach(key => {
                if (typeof gameState[key] === 'boolean') {
                    gameState[key] = false;
                } else if (Array.isArray(gameState[key])) {
                    gameState[key] = [];
                } else if (typeof gameState[key] === 'number') {
                    // Reset to initial values
                    const initialState = {
                        playerClass: null,
                        location: 'start',
                        time: '06:00',
                        day: 1,
                        inventory: [],
                        clues: [],
                        reputation: 50,
                        suspicion: 0,
                        health: 100,
                        stamina: 100,
                        money: 50,
                        gameOver: false,
                        currentScene: null,
                        pendingItemUse: null,
                        discoveredEndings: [],
                        achievements: [],
                        knownLocations: ['Apartment'],
                        soundEnabled: true,
                        saveSlots: {},
                        vogelAlive: true,
                        evidenceSecured: false,
                        trustWithVogel: 0,
                        inCombat: false,
                        combatEnemies: 0
                    };
                    
                    if (initialState[key] !== undefined) {
                        gameState[key] = initialState[key];
                    }
                } else if (key === 'playerClass' || key === 'currentScene') {
                    gameState[key] = null;
                } else if (key === 'location') {
                    gameState[key] = 'start';
                }
            });
            
            // Reset displays
            updateInventoryDisplay();
            updateCluesDisplay();
            updateStatsDisplay();
            
            // Restart game
            loadScene('start');
            playSound('success');
            showNotification('Game restarted!');
        }

        // Initialize game when page loads
        window.addEventListener('DOMContentLoaded', initGame);
        
        // Keep input focused on mobile
        document.addEventListener('touchstart', function() {
            inputLine.focus();
        });
        
        // Prevent context menu on long press
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // Auto-save every 5 minutes
        setInterval(saveGame, 300000);
    </script>
</body>
</html>
