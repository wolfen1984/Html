<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atari DnD Adventure - Enhanced</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 2px solid #fff;
            padding: 15px;
            background-color: #000;
        }
        
        .screen-title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
            color: #fff;
            border-bottom: 2px solid #fff;
            padding-bottom: 10px;
        }
        
        .game-area {
            display: flex;
            gap: 15px;
            min-height: 600px;
        }
        
        .main-display {
            flex: 3;
            border: 2px solid #fff;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background-color: #111;
        }
        
        .stats-panel {
            flex: 1;
            border: 2px solid #fff;
            padding: 15px;
            background-color: #111;
            min-width: 320px;
        }
        
        .text-log {
            flex: 1;
            border: 2px solid #fff;
            padding: 10px;
            margin-bottom: 15px;
            overflow-y: auto;
            max-height: 400px;
            background-color: #000;
            line-height: 1.8;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .shop-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        button {
            background-color: #000;
            color: #fff;
            border: 2px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        button:hover {
            background-color: #333;
            color: #0f0;
        }
        
        button:active {
            background-color: #555;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stat-block {
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .stat-name {
            color: #0f0;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #fff;
            margin-left: 10px;
        }
        
        .character-creator {
            border: 2px solid #fff;
            padding: 15px;
            background-color: #111;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            color: #0f0;
            margin-bottom: 5px;
        }
        
        select, input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            padding: 5px;
            width: 250px;
        }
        
        .game-message {
            color: #fff;
            margin-bottom: 10px;
        }
        
        .combat-log {
            color: #f00;
        }
        
        .loot-log {
            color: #ff0;
        }
        
        .heal-log {
            color: #0f0;
        }
        
        .skill-log {
            color: #0af;
        }
        
        .shop-log {
            color: #ff9900;
        }
        
        .health-bar {
            width: 100%;
            height: 15px;
            border: 1px solid #fff;
            background-color: #000;
            margin-top: 5px;
        }
        
        .health-fill {
            height: 100%;
            background-color: #f00;
            width: 100%;
            transition: width 0.5s;
        }
        
        .xp-bar {
            width: 100%;
            height: 8px;
            border: 1px solid #fff;
            background-color: #000;
            margin-top: 5px;
        }
        
        .xp-fill {
            height: 100%;
            background-color: #0f0;
            width: 0%;
            transition: width 0.5s;
        }
        
        .hidden {
            display: none;
        }
        
        .game-over {
            color: #f00;
            font-size: 18px;
            text-align: center;
            margin-top: 20px;
        }
        
        .victory {
            color: #0f0;
            font-size: 18px;
            text-align: center;
            margin-top: 20px;
        }
        
        .stat-allocation {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .stat-controls {
            display: flex;
            gap: 5px;
        }
        
        .stat-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
            text-align: center;
        }
        
        .stat-current {
            min-width: 40px;
            text-align: center;
            color: #fff;
        }
        
        .points-remaining {
            color: #0f0;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .inventory-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .inventory-item {
            border: 1px solid #fff;
            padding: 5px;
            background-color: #222;
            font-size: 9px;
            cursor: pointer;
        }
        
        .inventory-item:hover {
            background-color: #444;
            color: #0f0;
        }
        
        .enemy-health {
            border: 1px solid #fff;
            padding: 5px;
            margin: 10px 0;
            background-color: #222;
        }
        
        .location-info {
            color: #0af;
            margin-bottom: 10px;
        }
        
        .skill-button {
            background-color: #000;
            color: #0af;
            border: 1px solid #0af;
            font-size: 9px;
            padding: 5px;
            margin: 2px;
            cursor: pointer;
        }
        
        .skill-button:hover {
            background-color: #0af;
            color: #000;
        }
        
        .quest-log {
            border: 1px solid #fff;
            padding: 5px;
            margin-top: 10px;
            background-color: #111;
            font-size: 9px;
        }
        
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #444;
            background-color: #222;
        }
        
        .shop-item-name {
            color: #ff9900;
        }
        
        .shop-item-price {
            color: #ff0;
        }
        
        .shop-buy {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            font-size: 9px;
            cursor: pointer;
        }
        
        .shop-buy:hover {
            background-color: #0f0;
            color: #000;
        }
        
        .shop-buy:disabled {
            background-color: #333;
            color: #666;
            border-color: #666;
        }
        
        .combat-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #222;
            border: 1px solid #f00;
        }
        
        .status-effects {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .status-effect {
            padding: 3px 6px;
            background-color: #333;
            border: 1px solid #ff0;
            font-size: 8px;
            color: #ff0;
        }
        
        .special-ability {
            background-color: #000;
            color: #f0f;
            border: 1px solid #f0f;
        }
        
        .special-ability:hover {
            background-color: #f0f;
            color: #000;
        }
        
        .shop-display {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ff9900;
            background-color: #111;
        }
        
        .equipment-slot {
            border: 1px dashed #666;
            padding: 3px;
            margin: 2px;
            font-size: 8px;
        }
        
        .equipment-slot-filled {
            border: 1px solid #0f0;
            background-color: #0f0;
            color: #000;
        }
        
        .damage-popup {
            position: absolute;
            color: #f00;
            font-weight: bold;
            animation: floatUp 1s forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="screen-title">ATARI DUNGEONS & DRAGONS - ENHANCED</div>
        
        <!-- Character Creation Screen -->
        <div id="character-creation" class="character-creator">
            <div class="screen-title">CHARACTER CREATION</div>
            
            <div class="form-group">
                <label for="char-name">NAME:</label>
                <input type="text" id="char-name" value="VALEROS" maxlength="12">
            </div>
            
            <div class="form-group">
                <label for="char-race">RACE:</label>
                <select id="char-race">
                    <option value="Human">HUMAN (+1 ALL STATS)</option>
                    <option value="Elf">ELF (+2 DEX, +1 INT)</option>
                    <option value="Dwarf">DWARF (+2 CON, +1 STR)</option>
                    <option value="Halfling">HALFLING (+2 DEX, +1 CHA)</option>
                    <option value="Half-Orc">HALF-ORC (+2 STR, +1 CON)</option>
                    <option value="Dragonborn">DRAGONBORN (+2 STR, +1 CHA)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="char-class">CLASS:</label>
                <select id="char-class">
                    <option value="Fighter">FIGHTER</option>
                    <option value="Wizard">WIZARD</option>
                    <option value="Rogue">ROGUE</option>
                    <option value="Cleric">CLERIC</option>
                    <option value="Ranger">RANGER</option>
                    <option value="Paladin">PALADIN</option>
                    <option value="Barbarian">BARBARIAN</option>
                    <option value="Bard">BARD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>STAT ALLOCATION (27 POINTS):</label>
                <div class="points-remaining" id="points-remaining">POINTS REMAINING: 27</div>
                <div class="stat-block" id="stat-allocation">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="form-group">
                <label>BACKGROUND:</label>
                <select id="char-background">
                    <option value="Soldier">SOLDIER (+1 STR, Combat Training)</option>
                    <option value="Acolyte">ACOLYTE (+1 WIS, Healing Knowledge)</option>
                    <option value="Urchin">URCHIN (+1 DEX, Stealthy)</option>
                    <option value="Sage">SAGE (+1 INT, Lore Knowledge)</option>
                    <option value="Noble">NOBLE (+1 CHA, Wealthy)</option>
                    <option value="Outlander">OUTLANDER (+1 CON, Survivalist)</option>
                </select>
            </div>
            
            <button id="start-game">BEGIN ADVENTURE</button>
        </div>
        
        <!-- Main Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="game-area">
                <div class="main-display">
                    <div id="combat-display" class="combat-stats hidden">
                        <div>
                            <div class="stat-name">ENEMY:</div>
                            <div class="stat-value" id="enemy-name">GOBLIN</div>
                            <div class="stat-value" id="enemy-hp">HP: 10/10</div>
                            <div class="health-bar">
                                <div class="health-fill" id="enemy-health-fill"></div>
                            </div>
                        </div>
                        <div>
                            <div class="stat-name">STATUS:</div>
                            <div class="stat-value" id="enemy-status">NORMAL</div>
                            <div class="status-effects" id="enemy-effects"></div>
                        </div>
                    </div>
                    
                    <div class="text-log" id="game-text">
                        <div class="game-message">WELCOME TO THE DUNGEON OF INFINITE PERIL!</div>
                    </div>
                    
                    <div class="action-buttons" id="action-buttons">
                        <!-- Buttons will be populated by JavaScript -->
                    </div>
                    
                    <div class="shop-display hidden" id="shop-display">
                        <!-- Shop items will be populated by JavaScript -->
                    </div>
                    
                    <div class="quest-log" id="quest-log">
                        <div class="stat-name">ACTIVE QUESTS:</div>
                        <div id="quest-list">- FIND THE AMULET OF YENDOR</div>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div class="screen-title">CHARACTER STATS</div>
                    
                    <div class="stat-block">
                        <div class="stat-name">NAME:</div>
                        <div class="stat-value" id="stat-name">VALEROS</div>
                        
                        <div class="stat-name">RACE/CLASS:</div>
                        <div class="stat-value" id="stat-race-class">HUMAN FIGHTER</div>
                        
                        <div class="stat-name">LEVEL:</div>
                        <div class="stat-value" id="stat-level">1</div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">HEALTH:</div>
                        <div class="stat-value" id="stat-hp">10/10</div>
                        <div class="health-bar">
                            <div class="health-fill" id="health-fill"></div>
                        </div>
                        
                        <div class="stat-name">MANA/STAMINA:</div>
                        <div class="stat-value" id="stat-mana">10/10</div>
                        <div class="health-bar">
                            <div class="health-fill" id="mana-fill" style="background-color: #0af;"></div>
                        </div>
                        
                        <div class="stat-name">EXPERIENCE:</div>
                        <div class="stat-value" id="stat-xp">0/100</div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="xp-fill"></div>
                        </div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">ARMOR CLASS:</div>
                        <div class="stat-value" id="stat-ac">15</div>
                        
                        <div class="stat-name">DAMAGE BONUS:</div>
                        <div class="stat-value" id="stat-damage">+3</div>
                        
                        <div class="stat-name">GOLD:</div>
                        <div class="stat-value" id="stat-gold">100</div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">ATTRIBUTES:</div>
                        <div class="stat-value">STR: <span id="stat-str-display">16</span> (+<span id="stat-str-mod">3</span>)</div>
                        <div class="stat-value">DEX: <span id="stat-dex-display">12</span> (+<span id="stat-dex-mod">1</span>)</div>
                        <div class="stat-value">CON: <span id="stat-con-display">14</span> (+<span id="stat-con-mod">2</span>)</div>
                        <div class="stat-value">INT: <span id="stat-int-display">10</span> (+<span id="stat-int-mod">0</span>)</div>
                        <div class="stat-value">WIS: <span id="stat-wis-display">8</span> (-<span id="stat-wis-mod">1</span>)</div>
                        <div class="stat-value">CHA: <span id="stat-cha-display">13</span> (+<span id="stat-cha-mod">1</span>)</div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">EQUIPMENT:</div>
                        <div id="equipment-slots">
                            <div class="equipment-slot" id="slot-weapon">WEAPON: <span id="equipped-weapon">IRON SWORD</span></div>
                            <div class="equipment-slot" id="slot-armor">ARMOR: <span id="equipped-armor">LEATHER ARMOR</span></div>
                            <div class="equipment-slot" id="slot-shield">SHIELD: <span id="equipped-shield">NONE</span></div>
                        </div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">INVENTORY:</div>
                        <div class="inventory-items" id="inventory-items">
                            <!-- Inventory items will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="stat-block">
                        <div class="stat-name">SKILLS & ABILITIES:</div>
                        <div id="skill-buttons">
                            <!-- Skill buttons will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden">
            <div class="game-over">GAME OVER</div>
            <div class="text-log" id="game-over-text"></div>
            <button id="restart-game">START NEW GAME</button>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="hidden">
            <div class="victory">VICTORY!</div>
            <div class="text-log" id="victory-text"></div>
            <button id="new-game-plus">NEW GAME+ (HARDER)</button>
            <button id="restart-victory">MAIN MENU</button>
        </div>
    </div>

    <script>
        // Enhanced Game State
        const gameState = {
            screen: 'character',
            player: {
                name: 'Valeros',
                race: 'Human',
                class: 'Fighter',
                background: 'Soldier',
                level: 1,
                hp: 10,
                maxHp: 10,
                mana: 10,
                maxMana: 10,
                ac: 15,
                str: 16,
                dex: 12,
                con: 14,
                int: 10,
                wis: 8,
                cha: 13,
                xp: 0,
                nextLevelXp: 100,
                gold: 100,
                inventory: ['Health Potion', 'Iron Sword', 'Leather Armor', 'Minor Healing Potion'],
                equipped: {
                    weapon: 'Iron Sword',
                    armor: 'Leather Armor',
                    shield: null
                },
                spells: [],
                skills: [],
                abilities: [],
                statusEffects: [],
                dungeonLevel: 1,
                quests: {
                    main: { name: 'Find the Amulet of Yendor', completed: false },
                    side1: { name: 'Clear the Goblin Nest', completed: false, progress: 0, required: 5 },
                    side2: { name: 'Recover the Lost Artifact', completed: false },
                    side3: { name: 'Slay the Dragon', completed: false }
                }
            },
            location: 'entrance',
            inCombat: false,
            enemy: null,
            enemyStatusEffects: [],
            gameLog: [],
            gameActive: true,
            shopOpen: false,
            pointsRemaining: 27,
            statCosts: { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 }
        };

        // Enhanced Enemies database
        const enemies = {
            goblin: { 
                name: 'Goblin', 
                hp: 10, 
                maxHp: 10, 
                ac: 13, 
                damage: '1d4+1', 
                xp: 50, 
                gold: '1d10+5', 
                special: 'Throw Rocks',
                abilities: ['dodge'],
                weaknesses: ['fire'],
                resistances: []
            },
            skeleton: { 
                name: 'Skeleton', 
                hp: 18, 
                maxHp: 18, 
                ac: 13, 
                damage: '1d6+2', 
                xp: 100, 
                gold: '2d10+10', 
                special: 'Resistant to piercing',
                abilities: ['bone_shield'],
                weaknesses: ['bludgeoning', 'radiant'],
                resistances: ['piercing', 'poison']
            },
            orc: { 
                name: 'Orc Warrior', 
                hp: 30, 
                maxHp: 30, 
                ac: 14, 
                damage: '1d12+3', 
                xp: 200, 
                gold: '3d12+15', 
                special: 'Aggressive Charge',
                abilities: ['rage', 'power_attack'],
                weaknesses: [],
                resistances: []
            },
            troll: { 
                name: 'Cave Troll', 
                hp: 84, 
                maxHp: 84, 
                ac: 15, 
                damage: '2d6+4', 
                xp: 450, 
                gold: '5d20+50', 
                special: 'Regeneration',
                abilities: ['regenerate', 'swipe'],
                weaknesses: ['fire', 'acid'],
                resistances: ['bludgeoning']
            },
            dragon: { 
                name: 'Ancient Red Dragon', 
                hp: 350, 
                maxHp: 350, 
                ac: 22, 
                damage: '2d10+2d6+8', 
                xp: 5000, 
                gold: '20d100+500', 
                special: 'Fire Breath',
                abilities: ['fire_breath', 'wing_buffet', 'fear_aura'],
                weaknesses: ['cold'],
                resistances: ['fire', 'slashing']
            },
            wolf: { 
                name: 'Dire Wolf', 
                hp: 37, 
                maxHp: 37, 
                ac: 14, 
                damage: '2d6+3', 
                xp: 100, 
                gold: '2d10+10', 
                special: 'Pack Tactics',
                abilities: ['pounce', 'knockdown'],
                weaknesses: [],
                resistances: []
            },
            bandit: { 
                name: 'Bandit Captain', 
                hp: 65, 
                maxHp: 65, 
                ac: 15, 
                damage: '1d8+3', 
                xp: 300, 
                gold: '5d20+30', 
                special: 'Parry',
                abilities: ['parry', 'dirty_fight'],
                weaknesses: [],
                resistances: []
            },
            mimic: { 
                name: 'Mimic', 
                hp: 58, 
                maxHp: 58, 
                ac: 12, 
                damage: '1d8+3', 
                xp: 250, 
                gold: '3d20+20', 
                special: 'Adhesive',
                abilities: ['adhesive', 'surprise_attack'],
                weaknesses: [],
                resistances: ['slashing']
            },
            zombie: { 
                name: 'Zombie Horde', 
                hp: 45, 
                maxHp: 45, 
                ac: 8, 
                damage: '1d6+1', 
                xp: 50, 
                gold: '1d6+5', 
                special: 'Undead Fortitude',
                abilities: ['undead_fortitude', 'grapple'],
                weaknesses: ['radiant', 'fire'],
                resistances: ['poison']
            }
        };

        // Enhanced Items database
        const items = {
            'Health Potion': { 
                type: 'consumable', 
                effect: 'heal', 
                value: '2d4+2', 
                cost: 50,
                description: 'RESTORES HEALTH'
            },
            'Minor Healing Potion': { 
                type: 'consumable', 
                effect: 'heal', 
                value: '1d4+1', 
                cost: 25,
                description: 'SMALL HEALTH RESTORE'
            },
            'Greater Healing Potion': { 
                type: 'consumable', 
                effect: 'heal', 
                value: '4d4+4', 
                cost: 100,
                description: 'LARGE HEALTH RESTORE'
            },
            'Mana Potion': { 
                type: 'consumable', 
                effect: 'mana', 
                value: '2d4+2', 
                cost: 75,
                description: 'RESTORES MANA'
            },
            'Iron Sword': { 
                type: 'weapon', 
                damage: '1d8', 
                cost: 150,
                description: 'BASIC SWORD',
                slot: 'weapon'
            },
            'Steel Sword': { 
                type: 'weapon', 
                damage: '1d10', 
                cost: 300,
                description: 'IMPROVED SWORD',
                slot: 'weapon'
            },
            'Magic Wand': { 
                type: 'weapon', 
                damage: '1d6+1', 
                cost: 500,
                description: 'MAGIC DAMAGE',
                slot: 'weapon'
            },
            'Longbow': { 
                type: 'weapon', 
                damage: '1d8', 
                cost: 200,
                description: 'RANGED ATTACK',
                slot: 'weapon'
            },
            'Leather Armor': { 
                type: 'armor', 
                ac: 2, 
                cost: 100,
                description: 'LIGHT ARMOR',
                slot: 'armor'
            },
            'Chain Mail': { 
                type: 'armor', 
                ac: 4, 
                cost: 300,
                description: 'MEDIUM ARMOR',
                slot: 'armor'
            },
            'Plate Armor': { 
                type: 'armor', 
                ac: 6, 
                cost: 750,
                description: 'HEAVY ARMOR',
                slot: 'armor'
            },
            'Shield': { 
                type: 'shield', 
                ac: 2, 
                cost: 100,
                description: '+2 AC',
                slot: 'shield'
            },
            'Magic Shield': { 
                type: 'shield', 
                ac: 3, 
                cost: 400,
                description: '+3 AC, MAGIC RESIST',
                slot: 'shield'
            },
            'Healing Scroll': { 
                type: 'consumable', 
                effect: 'heal', 
                value: '3d8', 
                cost: 200,
                description: 'SCROLL OF HEALING'
            },
            'Fire Bomb': { 
                type: 'consumable', 
                effect: 'damage', 
                value: '3d6', 
                cost: 150,
                description: 'AREA FIRE DAMAGE'
            },
            'Poison Vial': { 
                type: 'consumable', 
                effect: 'poison', 
                value: '1d4', 
                cost: 100,
                description: 'APPLIES POISON'
            },
            'Antidote': { 
                type: 'consumable', 
                effect: 'cure', 
                value: 'poison', 
                cost: 80,
                description: 'CURES POISON'
            },
            'Strength Potion': { 
                type: 'consumable', 
                effect: 'buff', 
                value: 'str', 
                cost: 200,
                description: '+2 STR FOR 5 TURNS'
            },
            'Dragon Scale': { 
                type: 'material', 
                value: 500,
                cost: 0,
                description: 'RARE CRAFTING MATERIAL'
            }
        };

        // Skills database
        const skills = {
            // Fighter skills
            'Power Attack': {
                class: 'Fighter',
                cost: 0,
                effect: 'Deal double damage but attack with disadvantage',
                type: 'combat',
                cooldown: 3
            },
            'Second Wind': {
                class: 'Fighter',
                cost: 0,
                effect: 'Heal 1d10 + level HP once per combat',
                type: 'heal',
                cooldown: 0,
                uses: 1
            },
            'Parry': {
                class: 'Fighter',
                cost: 0,
                effect: 'Increase AC by 5 against next attack',
                type: 'defense',
                cooldown: 2
            },
            
            // Wizard skills
            'Fireball': {
                class: 'Wizard',
                cost: 10,
                effect: 'Deal 8d6 fire damage to all enemies',
                type: 'spell',
                cooldown: 3
            },
            'Magic Missile': {
                class: 'Wizard',
                cost: 5,
                effect: '3 missiles that always hit for 1d4+1 each',
                type: 'spell',
                cooldown: 1
            },
            'Shield': {
                class: 'Wizard',
                cost: 5,
                effect: '+5 AC until your next turn',
                type: 'spell',
                cooldown: 2
            },
            
            // Rogue skills
            'Sneak Attack': {
                class: 'Rogue',
                cost: 0,
                effect: 'Deal extra 2d6 damage if enemy hasn\'t attacked',
                type: 'combat',
                cooldown: 1
            },
            'Evasion': {
                class: 'Rogue',
                cost: 0,
                effect: 'Take half damage from area effects',
                type: 'defense',
                cooldown: 3
            },
            'Backstab': {
                class: 'Rogue',
                cost: 0,
                effect: 'Triple damage if attacking from surprise',
                type: 'combat',
                cooldown: 4
            },
            
            // Cleric skills
            'Turn Undead': {
                class: 'Cleric',
                cost: 15,
                effect: 'Frighten undead enemies, may destroy weak ones',
                type: 'spell',
                cooldown: 5
            },
            'Divine Smite': {
                class: 'Cleric',
                cost: 10,
                effect: 'Add 2d8 radiant damage to attack',
                type: 'spell',
                cooldown: 2
            },
            'Cure Wounds': {
                class: 'Cleric',
                cost: 5,
                effect: 'Heal 1d8 + WIS modifier',
                type: 'spell',
                cooldown: 1
            }
        };

        // Shop inventory
        const shopInventory = [
            'Health Potion',
            'Minor Healing Potion',
            'Greater Healing Potion',
            'Mana Potion',
            'Steel Sword',
            'Chain Mail',
            'Shield',
            'Healing Scroll',
            'Fire Bomb',
            'Poison Vial',
            'Antidote',
            'Strength Potion'
        ];

        // Locations
        const locations = {
            entrance: {
                name: 'Dungeon Entrance',
                description: 'YOU STAND AT THE ENTRANCE TO A FORBIDDING DUNGEON. THE STONE ARCHWAY IS CARVED WITH ANCIENT RUNES. TWO TORCHES FLANK THE ENTRANCE.',
                actions: ['explore', 'rest', 'inspect', 'camp', 'shop'],
                encounters: ['goblin', 'wolf', 'trap', 'nothing', 'chest', 'zombie'],
                shops: true,
                connections: ['crossroads']
            },
            crossroads: {
                name: 'Crossroads',
                description: 'A LARGE INTERSECTION WITH THREE PATHS. TORCHES BURN IN IRON BRACKETS. AN OLD SIGNPOST POINTS IN DIFFERENT DIRECTIONS.',
                actions: ['north', 'east', 'west', 'rest', 'inspect', 'shop', 'back'],
                encounters: ['goblin', 'bandit', 'chest', 'nothing', 'skeleton'],
                shops: true,
                connections: ['corridor', 'chamber', 'depths', 'entrance']
            },
            corridor: {
                name: 'Dark Corridor',
                description: 'A DAMP, NARROW CORRIDOR STRETCHES BEFORE YOU. TORCHLIGHT FLICKERS AGAINST THE MOSS-COVERED WALLS. YOU HEAR ECHOES IN THE DISTANCE.',
                actions: ['explore', 'rest', 'inspect', 'back', 'search'],
                encounters: ['skeleton', 'bandit', 'trap', 'nothing', 'chest', 'zombie'],
                shops: false,
                connections: ['chamber', 'crossroads']
            },
            chamber: {
                name: 'Great Chamber',
                description: 'YOU ENTER A VAST CHAMBER. ANCIENT PILLARS REACH UP INTO DARKNESS. THE AIR IS THICK WITH DUST AND THE SCENT OF OLD MAGIC.',
                actions: ['explore', 'rest', 'inspect', 'back', 'search'],
                encounters: ['orc', 'wolf', 'mimic', 'chest', 'nothing', 'bandit'],
                shops: false,
                connections: ['depths', 'corridor']
            },
            depths: {
                name: 'Frozen Depths',
                description: 'YOU DESCEND INTO ICY DEPTHS. THE AIR GROWS BITTERLY COLD. STRANGE CRYSTALS EMIT A FAINT GLOW. FROST COVERS THE WALLS.',
                actions: ['explore', 'rest', 'inspect', 'back', 'search'],
                encounters: ['troll', 'skeleton', 'wolf', 'chest', 'nothing'],
                shops: false,
                connections: ['throne', 'chamber']
            },
            throne: {
                name: 'Dragon\'s Throne Room',
                description: 'BEFORE YOU STANDS A MASSIVE STONE THRONE ADORNED WITH GEMS. UPON IT RESTS THE GLOWING AMULET OF YENDOR! A DEEP GROWL ECHOES.',
                actions: ['take', 'inspect', 'flee'],
                encounters: ['dragon'],
                shops: false,
                connections: []
            }
        };

        // Initialize DOM elements
        const characterCreation = document.getElementById('character-creation');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const victoryScreen = document.getElementById('victory-screen');
        const gameText = document.getElementById('game-text');
        const actionButtons = document.getElementById('action-buttons');
        const shopDisplay = document.getElementById('shop-display');
        const combatDisplay = document.getElementById('combat-display');
        const questList = document.getElementById('quest-list');
        const startGameBtn = document.getElementById('start-game');
        const restartGameBtn = document.getElementById('restart-game');
        const newGamePlusBtn = document.getElementById('new-game-plus');
        const restartVictoryBtn = document.getElementById('restart-victory');
        
        // Character creation elements
        const charNameInput = document.getElementById('char-name');
        const charRaceSelect = document.getElementById('char-race');
        const charClassSelect = document.getElementById('char-class');
        const charBackgroundSelect = document.getElementById('char-background');
        const statAllocationDiv = document.getElementById('stat-allocation');
        const pointsRemainingDiv = document.getElementById('points-remaining');
        
        // Stat display elements
        const statName = document.getElementById('stat-name');
        const statRaceClass = document.getElementById('stat-race-class');
        const statLevel = document.getElementById('stat-level');
        const statHp = document.getElementById('stat-hp');
        const statMana = document.getElementById('stat-mana');
        const statXp = document.getElementById('stat-xp');
        const statAc = document.getElementById('stat-ac');
        const statDamage = document.getElementById('stat-damage');
        const statGold = document.getElementById('stat-gold');
        const healthFill = document.getElementById('health-fill');
        const manaFill = document.getElementById('mana-fill');
        const xpFill = document.getElementById('xp-fill');
        const inventoryItems = document.getElementById('inventory-items');
        const skillButtons = document.getElementById('skill-buttons');
        const equipmentSlots = document.getElementById('equipment-slots');
        
        // Stat mod displays
        const statStrDisplay = document.getElementById('stat-str-display');
        const statDexDisplay = document.getElementById('stat-dex-display');
        const statConDisplay = document.getElementById('stat-con-display');
        const statIntDisplay = document.getElementById('stat-int-display');
        const statWisDisplay = document.getElementById('stat-wis-display');
        const statChaDisplay = document.getElementById('stat-cha-display');
        const statStrMod = document.getElementById('stat-str-mod');
        const statDexMod = document.getElementById('stat-dex-mod');
        const statConMod = document.getElementById('stat-con-mod');
        const statIntMod = document.getElementById('stat-int-mod');
        const statWisMod = document.getElementById('stat-wis-mod');
        const statChaMod = document.getElementById('stat-cha-mod');

        // Combat display elements
        const enemyName = document.getElementById('enemy-name');
        const enemyHp = document.getElementById('enemy-hp');
        const enemyHealthFill = document.getElementById('enemy-health-fill');
        const enemyStatus = document.getElementById('enemy-status');
        const enemyEffects = document.getElementById('enemy-effects');

        // Initialize game
        function initGame() {
            initCharacterCreation();
            
            startGameBtn.addEventListener('click', startGame);
            restartGameBtn.addEventListener('click', restartGame);
            newGamePlusBtn.addEventListener('click', startNewGamePlus);
            restartVictoryBtn.addEventListener('click', restartGame);
            
            charRaceSelect.addEventListener('change', updateRaceBonuses);
            charClassSelect.addEventListener('change', updateClassInfo);
            charBackgroundSelect.addEventListener('change', updateBackgroundInfo);
            
            addToLog('WELCOME TO THE DUNGEON OF INFINITE PERIL!');
            addToLog('YOUR QUEST: RETRIEVE THE LOST AMULET OF YENDOR FROM THE DEPTHS.');
        }

        // Initialize character creation
        function initCharacterCreation() {
            statAllocationDiv.innerHTML = '';
            const stats = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            const baseValues = { STR: 8, DEX: 8, CON: 8, INT: 8, WIS: 8, CHA: 8 };
            
            stats.forEach(stat => {
                const statDiv = document.createElement('div');
                statDiv.className = 'stat-allocation';
                
                const statLabel = document.createElement('div');
                statLabel.className = 'stat-name';
                statLabel.textContent = `${stat}:`;
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'stat-controls';
                
                const minusBtn = document.createElement('button');
                minusBtn.className = 'stat-btn';
                minusBtn.textContent = '-';
                minusBtn.dataset.stat = stat;
                minusBtn.addEventListener('click', () => adjustStat(stat, -1));
                
                const valueDisplay = document.createElement('div');
                valueDisplay.className = 'stat-current';
                valueDisplay.id = `stat-${stat.toLowerCase()}-value`;
                valueDisplay.textContent = baseValues[stat];
                
                const plusBtn = document.createElement('button');
                plusBtn.className = 'stat-btn';
                plusBtn.textContent = '+';
                plusBtn.dataset.stat = stat;
                plusBtn.addEventListener('click', () => adjustStat(stat, 1));
                
                controlsDiv.appendChild(minusBtn);
                controlsDiv.appendChild(valueDisplay);
                controlsDiv.appendChild(plusBtn);
                
                statDiv.appendChild(statLabel);
                statDiv.appendChild(controlsDiv);
                
                statAllocationDiv.appendChild(statDiv);
            });
            
            gameState.pointsRemaining = 27;
            updatePointsDisplay();
        }

        // Adjust stat value
        function adjustStat(stat, change) {
            const valueDisplay = document.getElementById(`stat-${stat.toLowerCase()}-value`);
            let currentValue = parseInt(valueDisplay.textContent);
            const newValue = currentValue + change;
            
            if (newValue < 8 || newValue > 15) return;
            
            const currentCost = gameState.statCosts[currentValue] || 0;
            const newCost = gameState.statCosts[newValue] || 0;
            const pointDifference = newCost - currentCost;
            
            if (change > 0 && gameState.pointsRemaining < pointDifference) return;
            
            valueDisplay.textContent = newValue;
            gameState.pointsRemaining -= pointDifference;
            updatePointsDisplay();
            updateStatButtons();
        }

        // Update points display
        function updatePointsDisplay() {
            pointsRemainingDiv.textContent = `POINTS REMAINING: ${gameState.pointsRemaining}`;
            pointsRemainingDiv.style.color = gameState.pointsRemaining >= 0 ? '#0f0' : '#f00';
            startGameBtn.disabled = gameState.pointsRemaining !== 0;
        }

        // Update stat button states
        function updateStatButtons() {
            const stats = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            
            stats.forEach(stat => {
                const valueDisplay = document.getElementById(`stat-${stat.toLowerCase()}-value`);
                const currentValue = parseInt(valueDisplay.textContent);
                const minusBtn = valueDisplay.previousElementSibling;
                const plusBtn = valueDisplay.nextElementSibling;
                
                minusBtn.disabled = currentValue <= 8;
                plusBtn.disabled = currentValue >= 15 || gameState.pointsRemaining < 1;
            });
        }

        // Update race bonuses display
        function updateRaceBonuses() {
            // This would update display of race bonuses
        }

        // Update class info
        function updateClassInfo() {
            // Update class description
        }

        // Update background info
        function updateBackgroundInfo() {
            // Update background description
        }

        // Start the game
        function startGame() {
            gameState.player.name = charNameInput.value.toUpperCase() || 'VALEROS';
            gameState.player.race = charRaceSelect.value.split(' ')[0];
            gameState.player.class = charClassSelect.value;
            gameState.player.background = charBackgroundSelect.value.split(' ')[0];
            
            // Get allocated stats
            const stats = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            stats.forEach(stat => {
                const value = parseInt(document.getElementById(`stat-${stat.toLowerCase()}-value`).textContent);
                gameState.player[stat.toLowerCase()] = value;
            });
            
            // Apply bonuses and setup
            applyRaceBonuses();
            applyBackgroundBonuses();
            calculateDerivedStats();
            setupClassSkills();
            updateStatsDisplay();
            updateQuestLog();
            updateEquipmentDisplay();
            
            // Switch to game screen
            characterCreation.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameState.screen = 'game';
            
            addToLog(`WELCOME, ${gameState.player.name}!`);
            addToLog(`YOU ARE A ${gameState.player.race} ${gameState.player.class}.`);
            addToLog(`BACKGROUND: ${gameState.player.background.toUpperCase()}`);
            addToLog('YOUR QUEST BEGINS...');
            addToLog(locations[gameState.location].description);
            
            updateActionButtons();
        }

        // Apply race bonuses
        function applyRaceBonuses() {
            const race = gameState.player.race;
            switch(race) {
                case 'Human':
                    gameState.player.str += 1;
                    gameState.player.dex += 1;
                    gameState.player.con += 1;
                    gameState.player.int += 1;
                    gameState.player.wis += 1;
                    gameState.player.cha += 1;
                    break;
                case 'Elf':
                    gameState.player.dex += 2;
                    gameState.player.int += 1;
                    break;
                case 'Dwarf':
                    gameState.player.con += 2;
                    gameState.player.str += 1;
                    break;
                case 'Halfling':
                    gameState.player.dex += 2;
                    gameState.player.cha += 1;
                    break;
                case 'Half-Orc':
                    gameState.player.str += 2;
                    gameState.player.con += 1;
                    break;
                case 'Dragonborn':
                    gameState.player.str += 2;
                    gameState.player.cha += 1;
                    break;
            }
        }

        // Apply background bonuses
        function applyBackgroundBonuses() {
            const background = gameState.player.background;
            switch(background) {
                case 'Soldier':
                    gameState.player.str += 1;
                    gameState.player.skills.push('Intimidation');
                    break;
                case 'Acolyte':
                    gameState.player.wis += 1;
                    gameState.player.skills.push('Religion');
                    break;
                case 'Urchin':
                    gameState.player.dex += 1;
                    gameState.player.skills.push('Stealth');
                    break;
                case 'Sage':
                    gameState.player.int += 1;
                    gameState.player.skills.push('Arcana');
                    break;
                case 'Noble':
                    gameState.player.cha += 1;
                    gameState.player.gold += 100;
                    gameState.player.skills.push('Persuasion');
                    break;
                case 'Outlander':
                    gameState.player.con += 1;
                    gameState.player.skills.push('Survival');
                    break;
            }
        }

        // Calculate derived stats
        function calculateDerivedStats() {
            const player = gameState.player;
            
            // Calculate HP based on class and CON
            let baseHP = 10;
            switch(player.class) {
                case 'Fighter': case 'Paladin': case 'Barbarian': baseHP = 12; break;
                case 'Ranger': case 'Cleric': baseHP = 10; break;
                case 'Rogue': case 'Bard': baseHP = 8; break;
                case 'Wizard': baseHP = 6; break;
            }
            
            const conMod = Math.floor((player.con - 10) / 2);
            player.maxHp = baseHP + conMod * player.level;
            player.hp = player.maxHp;
            
            // Calculate Mana based on class
            if (player.class === 'Wizard' || player.class === 'Cleric' || player.class === 'Bard') {
                player.maxMana = 10 + Math.floor((player.int - 10) / 2) * player.level;
            } else {
                player.maxMana = 0;
            }
            player.mana = player.maxMana;
            
            // Calculate AC based on DEX and armor
            const dexMod = Math.floor((player.dex - 10) / 2);
            player.ac = 10 + dexMod;
            
            // Add armor if equipped
            if (player.equipped.armor) {
                const armor = items[player.equipped.armor];
                if (armor) player.ac += armor.ac;
            }
            if (player.equipped.shield) {
                const shield = items[player.equipped.shield];
                if (shield) player.ac += shield.ac;
            }
            
            // Calculate damage bonus
            let primaryStat = 'str';
            switch(player.class) {
                case 'Wizard': primaryStat = 'int'; break;
                case 'Rogue': case 'Ranger': primaryStat = 'dex'; break;
                case 'Cleric': case 'Paladin': primaryStat = 'wis'; break;
                case 'Bard': primaryStat = 'cha'; break;
            }
            player.damageBonus = Math.floor((player[primaryStat] - 10) / 2);
            
            // Set spells for spellcasting classes
            if (player.class === 'Wizard') {
                player.spells = ['Magic Missile', 'Shield', 'Fireball'];
            } else if (player.class === 'Cleric') {
                player.spells = ['Cure Wounds', 'Divine Smite', 'Turn Undead'];
            }
            
            // Update stat modifiers display
            updateStatModifiers();
        }

        // Update stat modifiers display
        function updateStatModifiers() {
            const player = gameState.player;
            const stats = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
            
            stats.forEach(stat => {
                const mod = Math.floor((player[stat] - 10) / 2);
                const modElement = document.getElementById(`stat-${stat}-mod`);
                if (modElement) {
                    modElement.textContent = mod >= 0 ? mod : `-${Math.abs(mod)}`;
                }
            });
            
            // Update damage bonus display
            document.getElementById('stat-damage').textContent = `+${player.damageBonus}`;
        }

        // Set up class skills
        function setupClassSkills() {
            const player = gameState.player;
            player.abilities = [];
            
            // Add class-specific abilities
            switch(player.class) {
                case 'Fighter':
                    player.abilities.push('Power Attack', 'Second Wind', 'Parry');
                    break;
                case 'Wizard':
                    player.abilities.push('Magic Missile', 'Shield', 'Fireball');
                    break;
                case 'Rogue':
                    player.abilities.push('Sneak Attack', 'Evasion', 'Backstab');
                    break;
                case 'Cleric':
                    player.abilities.push('Cure Wounds', 'Divine Smite', 'Turn Undead');
                    break;
                case 'Ranger':
                    player.abilities.push('Hunter\'s Mark', 'Multiattack', 'Evasion');
                    break;
                case 'Paladin':
                    player.abilities.push('Divine Smite', 'Lay on Hands', 'Aura of Protection');
                    break;
                case 'Barbarian':
                    player.abilities.push('Rage', 'Reckless Attack', 'Danger Sense');
                    break;
                case 'Bard':
                    player.abilities.push('Bardic Inspiration', 'Vicious Mockery', 'Healing Word');
                    break;
            }
            
            // Update skill buttons
            updateSkillButtons();
        }

        // Update skill buttons
        function updateSkillButtons() {
            skillButtons.innerHTML = '';
            
            // Add class abilities
            gameState.player.abilities.forEach(ability => {
                const skill = skills[ability];
                if (skill) {
                    const skillBtn = document.createElement('button');
                    skillBtn.className = 'skill-button';
                    skillBtn.textContent = ability;
                    skillBtn.title = skill.effect + (skill.cost > 0 ? ` (Cost: ${skill.cost} MP)` : '');
                    skillBtn.addEventListener('click', () => useAbility(ability));
                    
                    // Disable if not enough mana
                    if (skill.cost > 0 && gameState.player.mana < skill.cost) {
                        skillBtn.disabled = true;
                    }
                    
                    skillButtons.appendChild(skillBtn);
                }
            });
            
            // Add spells if any
            gameState.player.spells.forEach(spell => {
                const skillBtn = document.createElement('button');
                skillBtn.className = 'skill-button special-ability';
                skillBtn.textContent = spell;
                skillBtn.addEventListener('click', () => castSpell(spell));
                skillButtons.appendChild(skillBtn);
            });
        }

        // Use ability
        function useAbility(ability) {
            if (!gameState.gameActive || !gameState.inCombat) {
                addToLog('YOU CAN ONLY USE ABILITIES IN COMBAT!');
                return;
            }
            
            const skill = skills[ability];
            if (!skill) return;
            
            // Check mana cost
            if (skill.cost > 0 && gameState.player.mana < skill.cost) {
                addToLog('NOT ENOUGH MANA!', false, true);
                return;
            }
            
            // Deduct mana
            if (skill.cost > 0) {
                gameState.player.mana -= skill.cost;
                updateStatsDisplay();
            }
            
            addToLog(`YOU USE ${ability.toUpperCase()}!`, true);
            
            // Handle different abilities
            switch(ability) {
                case 'Power Attack':
                    powerAttack();
                    break;
                case 'Second Wind':
                    secondWind();
                    break;
                case 'Parry':
                    parry();
                    break;
                case 'Magic Missile':
                    magicMissile();
                    break;
                case 'Fireball':
                    fireball();
                    break;
                case 'Shield':
                    shieldSpell();
                    break;
                case 'Sneak Attack':
                    sneakAttack();
                    break;
                case 'Cure Wounds':
                    cureWounds();
                    break;
                case 'Divine Smite':
                    divineSmite();
                    break;
                default:
                    addToLog('ABILITY NOT YET IMPLEMENTED!');
            }
        }

        // Power Attack ability
        function powerAttack() {
            const player = gameState.player;
            const enemy = enemies[gameState.enemy];
            
            // Attack with disadvantage (roll twice, take lower)
            const roll1 = rollDice(20);
            const roll2 = rollDice(20);
            const attackRoll = Math.min(roll1, roll2);
            const attackBonus = Math.floor((player.str - 10) / 2);
            const totalAttack = attackRoll + attackBonus;
            
            addToLog(`ATTACK ROLL: ${roll1}, ${roll2} (DISADVANTAGE) + ${attackBonus} = ${totalAttack} vs AC ${enemy.ac}`, true);
            
            if (totalAttack >= enemy.ac || attackRoll === 20) {
                // Double damage on hit
                let damage = 0;
                if (player.equipped.weapon) {
                    const weapon = items[player.equipped.weapon];
                    if (weapon) {
                        damage = rollDice(parseInt(weapon.damage[2])) * 2 + player.damageBonus;
                    }
                } else {
                    damage = rollDice(4) * 2 + player.damageBonus;
                }
                
                if (attackRoll === 20) {
                    damage *= 2;
                    addToLog('CRITICAL HIT!', true);
                }
                
                enemy.hp -= damage;
                addToLog(`POWER ATTACK HITS FOR ${damage} DAMAGE!`, true);
                
                if (enemy.hp <= 0) {
                    defeatEnemy();
                    return;
                }
            } else {
                addToLog('YOUR POWER ATTACK MISSES!', true);
            }
            
            enemyAttack();
        }

        // Second Wind ability
        function secondWind() {
            const healAmount = rollDice(10) + gameState.player.level;
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
            addToLog(`YOU USE SECOND WIND AND HEAL ${healAmount} HP!`, false, true);
            updateStatsDisplay();
            
            // Mark as used for this combat
            if (!gameState.player.abilityUses) gameState.player.abilityUses = {};
            gameState.player.abilityUses.SecondWind = true;
            
            enemyAttack();
        }

        // Parry ability
        function parry() {
            addToLog('YOU ASSUME A DEFENSIVE POSTURE. +5 AC AGAINST NEXT ATTACK!', true);
            gameState.player.ac += 5;
            gameState.player.statusEffects.push({ type: 'parry', duration: 1 });
            updateStatsDisplay();
            
            enemyAttack();
        }

        // Magic Missile ability
        function magicMissile() {
            const enemy = enemies[gameState.enemy];
            const damage = (rollDice(4) + 1) * 3; // 3 missiles that always hit
            enemy.hp -= damage;
            addToLog(`MAGIC MISSILES HIT FOR ${damage} DAMAGE!`, true);
            
            if (enemy.hp <= 0) {
                defeatEnemy();
                return;
            }
            
            enemyAttack();
        }

        // Fireball ability
        function fireball() {
            const enemy = enemies[gameState.enemy];
            const damage = rollDice(6) + rollDice(6) + rollDice(6) + rollDice(6) + 
                          rollDice(6) + rollDice(6) + rollDice(6) + rollDice(6);
            enemy.hp -= damage;
            addToLog(`FIREBALL EXPLODES FOR ${damage} FIRE DAMAGE!`, true);
            
            // Check for weakness
            if (enemy.weaknesses && enemy.weaknesses.includes('fire')) {
                enemy.hp -= Math.floor(damage * 0.5);
                addToLog(`${enemy.name} IS WEAK TO FIRE! EXTRA DAMAGE!`, true);
            }
            
            if (enemy.hp <= 0) {
                defeatEnemy();
                return;
            }
            
            enemyAttack();
        }

        // Shield spell
        function shieldSpell() {
            addToLog('YOU CAST SHIELD! +5 AC UNTIL YOUR NEXT TURN.', true);
            gameState.player.ac += 5;
            gameState.player.statusEffects.push({ type: 'shield', duration: 2 });
            updateStatsDisplay();
            
            enemyAttack();
        }

        // Update stats display
        function updateStatsDisplay() {
            const player = gameState.player;
            
            statName.textContent = player.name;
            statRaceClass.textContent = `${player.race} ${player.class}`;
            statLevel.textContent = player.level;
            statHp.textContent = `${player.hp}/${player.maxHp}`;
            statMana.textContent = `${player.mana}/${player.maxMana}`;
            statXp.textContent = `${player.xp}/${player.nextLevelXp}`;
            statAc.textContent = player.ac;
            statGold.textContent = player.gold;
            
            // Update bars
            const healthPercent = (player.hp / player.maxHp) * 100;
            healthFill.style.width = `${healthPercent}%`;
            
            const manaPercent = player.maxMana > 0 ? (player.mana / player.maxMana) * 100 : 0;
            manaFill.style.width = `${manaPercent}%`;
            
            const xpPercent = (player.xp / player.nextLevelXp) * 100;
            xpFill.style.width = `${xpPercent}%`;
            
            // Update stat displays
            statStrDisplay.textContent = player.str;
            statDexDisplay.textContent = player.dex;
            statConDisplay.textContent = player.con;
            statIntDisplay.textContent = player.int;
            statWisDisplay.textContent = player.wis;
            statChaDisplay.textContent = player.cha;
            
            // Update inventory display
            updateInventoryDisplay();
            updateSkillButtons();
        }

        // Update equipment display
        function updateEquipmentDisplay() {
            document.getElementById('equipped-weapon').textContent = 
                gameState.player.equipped.weapon || 'NONE';
            document.getElementById('equipped-armor').textContent = 
                gameState.player.equipped.armor || 'NONE';
            document.getElementById('equipped-shield').textContent = 
                gameState.player.equipped.shield || 'NONE';
            
            // Update slot styles
            const slots = ['weapon', 'armor', 'shield'];
            slots.forEach(slot => {
                const slotElement = document.getElementById(`slot-${slot}`);
                if (gameState.player.equipped[slot]) {
                    slotElement.classList.add('equipment-slot-filled');
                } else {
                    slotElement.classList.remove('equipment-slot-filled');
                }
            });
        }

        // Update inventory display
        function updateInventoryDisplay() {
            inventoryItems.innerHTML = '';
            gameState.player.inventory.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                itemDiv.textContent = item;
                itemDiv.title = items[item]?.description || 'Unknown item';
                itemDiv.addEventListener('click', () => useItem(item));
                inventoryItems.appendChild(itemDiv);
            });
        }

        // Use item
        function useItem(item) {
            if (!gameState.gameActive) return;
            
            const itemData = items[item];
            if (!itemData) return;
            
            switch(itemData.type) {
                case 'consumable':
                    useConsumable(item, itemData);
                    break;
                case 'weapon':
                case 'armor':
                case 'shield':
                    equipItem(item, itemData);
                    break;
                default:
                    addToLog(`CAN'T USE ${item} RIGHT NOW.`);
            }
        }

        // Use consumable item
        function useConsumable(item, itemData) {
            switch(itemData.effect) {
                case 'heal':
                    const healAmount = rollDice(parseInt(itemData.value[0])) + 
                                     rollDice(parseInt(itemData.value[0])) + 
                                     parseInt(itemData.value.split('+')[1] || 0);
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                    addToLog(`YOU USE ${item} AND HEAL ${healAmount} HP!`, false, true);
                    break;
                    
                case 'mana':
                    const manaAmount = rollDice(parseInt(itemData.value[0])) + 
                                      rollDice(parseInt(itemData.value[0])) + 
                                      parseInt(itemData.value.split('+')[1] || 0);
                    gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaAmount);
                    addToLog(`YOU USE ${item} AND RESTORE ${manaAmount} MANA!`, false, true);
                    break;
                    
                case 'damage':
                    if (gameState.inCombat && gameState.enemy) {
                        const damage = rollDice(6) + rollDice(6) + rollDice(6);
                        enemies[gameState.enemy].hp -= damage;
                        addToLog(`YOU THROW ${item} FOR ${damage} FIRE DAMAGE!`, true);
                        
                        if (enemies[gameState.enemy].hp <= 0) {
                            defeatEnemy();
                        }
                    } else {
                        addToLog(`CAN ONLY USE ${item} IN COMBAT!`);
                        return;
                    }
                    break;
                    
                case 'buff':
                    addToLog(`YOU DRINK ${item}! +2 ${itemData.value.toUpperCase()} FOR 5 TURNS!`, false, true);
                    gameState.player.statusEffects.push({
                        type: itemData.value + '_buff',
                        value: 2,
                        duration: 5
                    });
                    break;
                    
                case 'cure':
                    // Remove poison
                    gameState.player.statusEffects = gameState.player.statusEffects.filter(
                        effect => effect.type !== 'poison'
                    );
                    addToLog(`YOU USE ${item} AND ARE CURED OF POISON!`, false, true);
                    break;
            }
            
            // Remove from inventory
            const index = gameState.player.inventory.indexOf(item);
            if (index > -1) {
                gameState.player.inventory.splice(index, 1);
                updateInventoryDisplay();
            }
            
            updateStatsDisplay();
            
            // If in combat, enemy gets a turn
            if (gameState.inCombat && itemData.effect !== 'heal' && itemData.effect !== 'mana' && itemData.effect !== 'cure') {
                setTimeout(enemyAttack, 500);
            }
        }

        // Equip item
        function equipItem(item, itemData) {
            const slot = itemData.slot;
            const oldItem = gameState.player.equipped[slot];
            
            // Unequip old item if exists
            if (oldItem) {
                gameState.player.inventory.push(oldItem);
            }
            
            // Equip new item
            gameState.player.equipped[slot] = item;
            
            // Remove from inventory
            const index = gameState.player.inventory.indexOf(item);
            if (index > -1) {
                gameState.player.inventory.splice(index, 1);
            }
            
            // Recalculate stats
            calculateDerivedStats();
            updateStatsDisplay();
            updateEquipmentDisplay();
            updateInventoryDisplay();
            
            addToLog(`YOU EQUIP ${item}!`, false, true);
        }

        // Update action buttons
        function updateActionButtons() {
            actionButtons.innerHTML = '';
            const location = locations[gameState.location];
            
            if (gameState.shopOpen) {
                // Shop actions
                const shopActions = [
                    { id: 'buy', text: 'BUY ITEMS' },
                    { id: 'sell', text: 'SELL ITEMS' },
                    { id: 'talk', text: 'TALK' },
                    { id: 'leave', text: 'LEAVE SHOP' }
                ];
                
                shopActions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.id = `btn-${action.id}`;
                    btn.textContent = action.text;
                    btn.addEventListener('click', () => handleShopAction(action.id));
                    actionButtons.appendChild(btn);
                });
                
                // Show shop display
                shopDisplay.classList.remove('hidden');
                displayShopItems();
            } else if (gameState.inCombat) {
                // Combat actions
                combatDisplay.classList.remove('hidden');
                
                const combatActions = [
                    { id: 'attack', text: 'ATTACK' },
                    { id: 'defend', text: 'DEFEND' },
                    { id: 'flee', text: 'FLEE' },
                    { id: 'item', text: 'USE ITEM' }
                ];
                
                // Add spell action for casters
                if (gameState.player.spells.length > 0 || gameState.player.maxMana > 0) {
                    combatActions.push({ id: 'spell', text: 'CAST SPELL' });
                }
                
                combatActions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.id = `btn-${action.id}`;
                    btn.textContent = action.text;
                    btn.addEventListener('click', () => handleCombatAction(action.id));
                    actionButtons.appendChild(btn);
                });
            } else {
                // Location actions
                combatDisplay.classList.add('hidden');
                shopDisplay.classList.add('hidden');
                
                location.actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.id = `btn-${action}`;
                    btn.textContent = action.toUpperCase();
                    btn.addEventListener('click', () => handleAction(action));
                    actionButtons.appendChild(btn);
                });
            }
        }

        // Handle location actions
        function handleAction(action) {
            switch(action) {
                case 'explore':
                    explore();
                    break;
                case 'rest':
                    rest();
                    break;
                case 'inspect':
                    inspect();
                    break;
                case 'back':
                    goBack();
                    break;
                case 'search':
                    searchArea();
                    break;
                case 'north':
                case 'east':
                case 'west':
                    moveDirection(action);
                    break;
                case 'shop':
                    enterShop();
                    break;
                case 'take':
                    takeAmulet();
                    break;
                case 'camp':
                    camp();
                    break;
                default:
                    addToLog(`ACTION ${action.toUpperCase()} NOT IMPLEMENTED YET.`);
            }
        }

        // Explore action - now properly implemented
        function explore() {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            addToLog('YOU VENTURE DEEPER INTO THE DUNGEON...');
            
            const location = locations[gameState.location];
            const connections = location.connections;
            
            if (connections && connections.length > 0) {
                // Move to a random connected location
                const randomIndex = Math.floor(Math.random() * connections.length);
                const newLocation = connections[randomIndex];
                gameState.location = newLocation;
                
                addToLog(`YOU ENTER ${locations[newLocation].name.toUpperCase()}!`);
                addToLog(locations[newLocation].description);
                
                // Increase dungeon level
                if (newLocation !== 'entrance' && newLocation !== 'crossroads') {
                    gameState.player.dungeonLevel++;
                }
                
                // Trigger random encounter
                const encounterChance = Math.random();
                if (encounterChance < 0.6) { // 60% chance of encounter
                    triggerRandomEncounter();
                } else if (encounterChance < 0.8) { // 20% chance of treasure
                    findTreasure();
                } else {
                    addToLog('THE AREA SEEMS PEACEFUL FOR NOW.');
                }
                
                updateStatsDisplay();
                updateActionButtons();
            } else {
                addToLog('YOU CANNOT EXPLORE FURTHER FROM HERE.');
            }
        }

        // Rest action - now properly implemented
        function rest() {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            const healAmount = Math.floor(gameState.player.maxHp * 0.3) + Math.floor((gameState.player.con - 10) / 2);
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
            
            if (gameState.player.maxMana > 0) {
                const manaAmount = Math.floor(gameState.player.maxMana * 0.3) + Math.floor((gameState.player.int - 10) / 2);
                gameState.player.mana = Math.min(gameState.player.maxMana, gameState.player.mana + manaAmount);
                addToLog(`YOU REST AND HEAL ${healAmount} HP AND ${manaAmount} MANA.`);
            } else {
                addToLog(`YOU REST AND HEAL ${healAmount} HP.`);
            }
            
            // Chance of encounter while resting
            if (Math.random() < 0.3) {
                addToLog('AN ENEMY DISTURBS YOUR REST!', true);
                const enemiesList = ['goblin', 'wolf', 'skeleton', 'zombie'];
                const randomEnemy = enemiesList[Math.floor(Math.random() * enemiesList.length)];
                startCombat(randomEnemy);
            }
            
            updateStatsDisplay();
        }

        // Inspect action - now properly implemented
        function inspect() {
            if (!gameState.gameActive) return;
            
            const location = locations[gameState.location];
            addToLog(`YOU INSPECT ${location.name.toUpperCase()}...`);
            addToLog(location.description);
            
            // Chance to find something
            const findChance = Math.random();
            if (findChance < 0.4) {
                if (findChance < 0.2) {
                    // Find gold
                    const goldFound = Math.floor(Math.random() * 30) + 10;
                    gameState.player.gold += goldFound;
                    addToLog(`YOU FIND ${goldFound} GOLD HIDDEN IN A CRACK!`, false, true);
                } else if (findChance < 0.35) {
                    // Find item
                    const possibleItems = ['Minor Healing Potion', 'Poison Vial', 'Fire Bomb'];
                    const foundItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    gameState.player.inventory.push(foundItem);
                    addToLog(`YOU FIND A ${foundItem.toUpperCase()}!`, false, true);
                    updateInventoryDisplay();
                } else {
                    // Find clue
                    const clues = [
                        'YOU FIND ANCIENT MARKINGS SPEAKING OF A POWERFUL AMULET.',
                        'A FADED MAP SHOWS SECRET PASSAGES DEEPER IN THE DUNGEON.',
                        'BLOODSTAINS LEAD TOWARDS THE EASTERN PASSAGE.',
                        'SCRATCH MARKS SUGGEST LARGE CREATURES PASS THROUGH HERE OFTEN.',
                        'A BROKEN SHIELD BEARS THE INSIGNIA OF A FAILED EXPEDITION.'
                    ];
                    const clue = clues[Math.floor(Math.random() * clues.length)];
                    addToLog(clue);
                }
            } else {
                addToLog('YOU FIND NOTHING OF INTEREST.');
            }
            
            updateStatsDisplay();
        }

        // Camp action - now properly implemented
        function camp() {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            // Full heal and mana restore
            const oldHp = gameState.player.hp;
            const oldMana = gameState.player.mana;
            
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.mana = gameState.player.maxMana;
            
            const hpHealed = gameState.player.hp - oldHp;
            const manaRestored = gameState.player.mana - oldMana;
            
            addToLog('YOU SET UP CAMP AND REST THOROUGHLY.');
            addToLog(`YOU HEAL ${hpHealed} HP!`, false, true);
            
            if (manaRestored > 0) {
                addToLog(`YOU RESTORE ${manaRestored} MANA!`, false, true);
            }
            
            // Higher chance of encounter while camping
            if (Math.random() < 0.5) {
                addToLog('ENEMIES DISCOVER YOUR CAMP!', true);
                const enemiesList = ['goblin', 'wolf', 'bandit', 'skeleton', 'zombie'];
                const randomEnemy = enemiesList[Math.floor(Math.random() * enemiesList.length)];
                startCombat(randomEnemy);
            }
            
            updateStatsDisplay();
        }

        // Search area action - now properly implemented
        function searchArea() {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            addToLog('YOU SEARCH THE AREA THOROUGHLY...');
            
            const searchRoll = Math.random();
            
            if (searchRoll < 0.7) {
                if (searchRoll < 0.3) {
                    // Find good treasure
                    const goldFound = Math.floor(Math.random() * 100) + 50;
                    gameState.player.gold += goldFound;
                    addToLog(`YOU FIND A HIDDEN CACHE WITH ${goldFound} GOLD!`, false, true);
                } else if (searchRoll < 0.5) {
                    // Find good item
                    const possibleItems = ['Health Potion', 'Healing Scroll', 'Fire Bomb', 'Strength Potion'];
                    const foundItem = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                    gameState.player.inventory.push(foundItem);
                    addToLog(`YOU FIND A ${foundItem.toUpperCase()} HIDDEN BEHIND A ROCK!`, false, true);
                    updateInventoryDisplay();
                } else if (searchRoll < 0.6) {
                    // Find equipment
                    const possibleEquipment = ['Chain Mail', 'Shield', 'Longbow'];
                    const foundItem = possibleEquipment[Math.floor(Math.random() * possibleEquipment.length)];
                    gameState.player.inventory.push(foundItem);
                    addToLog(`YOU FIND ${foundItem.toUpperCase()} IN AN OLD CHEST!`, false, true);
                    updateInventoryDisplay();
                } else {
                    // Find quest item or clue
                    addToLog('YOU FIND AN ANCIENT SCROLL WITH VITAL INFORMATION!');
                    addToLog('IT SPEAKS OF THE DRAGON\'S WEAKNESS TO COLD!');
                }
            } else {
                addToLog('YOUR SEARCH YIELDS NOTHING.');
            }
            
            // Chance to trigger trap
            if (Math.random() < 0.2) {
                triggerTrap();
            }
            
            updateStatsDisplay();
        }

        // Move in direction - now properly implemented
        function moveDirection(direction) {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            const directionMap = {
                north: {from: 'crossroads', to: 'corridor'},
                east: {from: 'crossroads', to: 'chamber'},
                west: {from: 'crossroads', to: 'depths'}
            };
            
            const move = directionMap[direction];
            if (move && gameState.location === move.from) {
                gameState.location = move.to;
                gameState.player.dungeonLevel++;
                
                addToLog(`YOU HEAD ${direction.toUpperCase()}...`);
                addToLog(`YOU ENTER ${locations[move.to].name.toUpperCase()}!`);
                addToLog(locations[move.to].description);
                
                // Trigger encounter
                const encounterChance = Math.random();
                if (encounterChance < 0.7) {
                    triggerRandomEncounter();
                } else {
                    addToLog('THE PATH IS CLEAR FOR NOW.');
                }
                
                updateStatsDisplay();
                updateActionButtons();
            } else {
                addToLog(`YOU CANNOT GO ${direction.toUpperCase()} FROM HERE.`);
            }
        }

        // Go back - now properly implemented
        function goBack() {
            if (!gameState.gameActive || gameState.inCombat) return;
            
            const locationOrder = ['entrance', 'crossroads', 'corridor', 'chamber', 'depths', 'throne'];
            const currentIndex = locationOrder.indexOf(gameState.location);
            
            if (currentIndex > 0) {
                const previousLocation = locationOrder[currentIndex - 1];
                gameState.location = previousLocation;
                gameState.player.dungeonLevel = Math.max(1, gameState.player.dungeonLevel - 1);
                
                addToLog('YOU RETREAT TO THE PREVIOUS AREA...');
                addToLog(locations[previousLocation].description);
                
                updateStatsDisplay();
                updateActionButtons();
            } else {
                addToLog('YOU CANNOT GO BACK FROM HERE.');
            }
        }

        // Take amulet - now properly implemented
        function takeAmulet() {
            if (!gameState.gameActive) return;
            
            if (gameState.location === 'throne') {
                if (enemies.dragon.hp > 0) {
                    addToLog('YOU REACH FOR THE AMULET, BUT THE DRAGON AWAKENS!', true);
                    startCombat('dragon');
                } else {
                    addToLog('WITH THE DRAGON DEFEATED, YOU CLAIM THE AMULET OF YENDOR!', false, true);
                    victory();
                }
            } else {
                addToLog('THERE IS NO AMULET TO TAKE HERE.');
            }
        }

        // Trigger random encounter
        function triggerRandomEncounter() {
            const location = locations[gameState.location];
            if (!location.encounters || location.encounters.length === 0) return;
            
            const encounterRoll = Math.random();
            let encounter;
            
            if (encounterRoll < 0.4) {
                encounter = location.encounters[0];
            } else if (encounterRoll < 0.7) {
                encounter = location.encounters[1] || location.encounters[0];
            } else if (encounterRoll < 0.9) {
                encounter = location.encounters[2] || location.encounters[0];
            } else {
                encounter = location.encounters[3] || 'nothing';
            }
            
            if (encounter === 'nothing') {
                addToLog('THE AREA IS CLEAR.');
            } else if (encounter === 'chest') {
                findTreasure();
            } else if (encounter === 'trap') {
                triggerTrap();
            } else if (enemies[encounter]) {
                startCombat(encounter);
            }
        }

        // Find treasure
        function findTreasure() {
            addToLog('YOU FIND A TREASURE CHEST!', false, true);
            
            const treasureRoll = Math.random();
            
            if (treasureRoll < 0.5) {
                const gold = Math.floor(Math.random() * 150) + 100;
                gameState.player.gold += gold;
                addToLog(`THE CHEST CONTAINS ${gold} GOLD PIECES!`, false, true);
            } else if (treasureRoll < 0.8) {
                const items = ['Health Potion', 'Greater Healing Potion', 'Mana Potion', 'Healing Scroll'];
                const foundItem = items[Math.floor(Math.random() * items.length)];
                gameState.player.inventory.push(foundItem);
                addToLog(`THE CHEST CONTAINS A ${foundItem.toUpperCase()}!`, false, true);
                updateInventoryDisplay();
            } else if (treasureRoll < 0.95) {
                const equipment = ['Chain Mail', 'Steel Sword', 'Shield', 'Longbow'];
                const foundItem = equipment[Math.floor(Math.random() * equipment.length)];
                gameState.player.inventory.push(foundItem);
                addToLog(`THE CHEST CONTAINS ${foundItem.toUpperCase()}!`, false, true);
                updateInventoryDisplay();
            } else {
                addToLog('THE CHEST IS TRAPPED!', true);
                triggerTrap();
            }
            
            updateStatsDisplay();
        }

        // Trigger trap
        function triggerTrap() {
            addToLog('YOU TRIGGER A TRAP!', true);
            
            const trapTypes = [
                { name: 'POISON DART', damage: '1d6+3', effect: 'poison' },
                { name: 'PIT TRAP', damage: '2d6+5', effect: null },
                { name: 'SWINGING BLADE', damage: '1d8+4', effect: null },
                { name: 'FALLING ROCKS', damage: '2d8+6', effect: null }
            ];
            
            const trap = trapTypes[Math.floor(Math.random() * trapTypes.length)];
            const damage = rollDice(parseInt(trap.damage[0])) + 
                          (trap.damage.includes('d') ? rollDice(parseInt(trap.damage.split('d')[1].split('+')[0])) : 0) +
                          parseInt(trap.damage.split('+')[1] || 0);
            
            gameState.player.hp -= damage;
            addToLog(`${trap.name} HITS YOU FOR ${damage} DAMAGE!`, true);
            
            if (trap.effect === 'poison') {
                gameState.player.statusEffects.push({ type: 'poison', duration: 3, damage: 2 });
                addToLog('YOU ARE POISONED!', true);
            }
            
            if (gameState.player.hp <= 0) {
                gameOver();
            }
            
            updateStatsDisplay();
        }

        // Handle shop actions
        function handleShopAction(action) {
            switch(action) {
                case 'buy':
                    displayShopItems();
                    break;
                case 'sell':
                    displaySellItems();
                    break;
                case 'talk':
                    talkToShopkeeper();
                    break;
                case 'leave':
                    leaveShop();
                    break;
            }
        }

        // Handle combat actions
        function handleCombatAction(action) {
            switch(action) {
                case 'attack':
                    attack();
                    break;
                case 'defend':
                    defend();
                    break;
                case 'flee':
                    flee();
                    break;
                case 'item':
                    showInventoryForUse();
                    break;
                case 'spell':
                    showSpells();
                    break;
            }
        }

        // Show inventory for use in combat
        function showInventoryForUse() {
            addToLog('SELECT AN ITEM FROM YOUR INVENTORY TO USE:');
            gameState.player.inventory.forEach(item => {
                const itemData = items[item];
                if (itemData && itemData.type === 'consumable') {
                    addToLog(`- ${item}: ${itemData.description}`);
                }
            });
            addToLog('CLICK ON ITEMS IN YOUR INVENTORY PANEL TO USE THEM.');
        }

        // Show spells
        function showSpells() {
            addToLog('AVAILABLE SPELLS:');
            gameState.player.spells.forEach(spell => {
                addToLog(`- ${spell}`);
            });
            addToLog('CLICK ON SPELLS IN YOUR SKILLS PANEL TO CAST THEM.');
        }

        // Cast spell
        function castSpell(spell) {
            if (!gameState.gameActive || !gameState.inCombat) {
                addToLog('YOU CAN ONLY CAST SPELLS IN COMBAT!');
                return;
            }
            
            addToLog(`YOU CAST ${spell.toUpperCase()}!`, true);
            
            // Basic spell implementation
            const enemy = enemies[gameState.enemy];
            let damage = 0;
            
            switch(spell) {
                case 'Magic Missile':
                    damage = (rollDice(4) + 1) * 3;
                    enemy.hp -= damage;
                    addToLog(`MAGIC MISSILES HIT FOR ${damage} DAMAGE!`, true);
                    break;
                case 'Fireball':
                    damage = rollDice(6) * 8;
                    enemy.hp -= damage;
                    addToLog(`FIREBALL EXPLODES FOR ${damage} DAMAGE!`, true);
                    break;
                case 'Cure Wounds':
                    const healAmount = rollDice(8) + Math.floor((gameState.player.wis - 10) / 2);
                    gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
                    addToLog(`YOU HEAL ${healAmount} HP!`, false, true);
                    updateStatsDisplay();
                    break;
                case 'Divine Smite':
                    damage = rollDice(8) * 2 + Math.floor((gameState.player.wis - 10) / 2);
                    enemy.hp -= damage;
                    addToLog(`DIVINE SMITE HITS FOR ${damage} RADIANT DAMAGE!`, true);
                    break;
                default:
                    addToLog('SPELL NOT YET IMPLEMENTED!');
                    return;
            }
            
            if (enemy.hp <= 0) {
                defeatEnemy();
            } else {
                enemyAttack();
            }
        }

        // Enter shop
        function enterShop() {
            gameState.shopOpen = true;
            addToLog('YOU ENTER THE MYSTERIOUS SHOP...', false, true);
            addToLog('"WELCOME, ADVENTURER! BUY SOMETHING NICE!"', false, true);
            updateActionButtons();
        }

        // Display shop items
        function displayShopItems() {
            shopDisplay.innerHTML = '<div class="stat-name">SHOP INVENTORY:</div>';
            
            shopInventory.forEach(itemName => {
                const item = items[itemName];
                if (!item) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'shop-item-name';
                nameSpan.textContent = itemName;
                nameSpan.title = item.description;
                
                const priceSpan = document.createElement('span');
                priceSpan.className = 'shop-item-price';
                priceSpan.textContent = `${item.cost} GOLD`;
                
                const buyBtn = document.createElement('button');
                buyBtn.className = 'shop-buy';
                buyBtn.textContent = 'BUY';
                buyBtn.disabled = gameState.player.gold < item.cost;
                buyBtn.addEventListener('click', () => buyItem(itemName, item));
                
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(priceSpan);
                itemDiv.appendChild(buyBtn);
                shopDisplay.appendChild(itemDiv);
            });
        }

        // Display items for sale
        function displaySellItems() {
            shopDisplay.innerHTML = '<div class="stat-name">YOUR ITEMS FOR SALE:</div>';
            
            if (gameState.player.inventory.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.textContent = 'NO ITEMS TO SELL';
                shopDisplay.appendChild(emptyDiv);
                return;
            }
            
            gameState.player.inventory.forEach(itemName => {
                const item = items[itemName];
                if (!item) return;
                
                const sellValue = Math.floor(item.cost * 0.5); // Sell for half price
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'shop-item-name';
                nameSpan.textContent = itemName;
                
                const priceSpan = document.createElement('span');
                priceSpan.className = 'shop-item-price';
                priceSpan.textContent = `${sellValue} GOLD`;
                
                const sellBtn = document.createElement('button');
                sellBtn.className = 'shop-buy';
                sellBtn.textContent = 'SELL';
                sellBtn.style.backgroundColor = '#300';
                sellBtn.style.color = '#f00';
                sellBtn.style.borderColor = '#f00';
                sellBtn.addEventListener('click', () => sellItem(itemName, sellValue));
                
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(priceSpan);
                itemDiv.appendChild(sellBtn);
                shopDisplay.appendChild(itemDiv);
            });
        }

        // Buy item
        function buyItem(itemName, item) {
            if (gameState.player.gold < item.cost) {
                addToLog('NOT ENOUGH GOLD!', false, true);
                return;
            }
            
            gameState.player.gold -= item.cost;
            gameState.player.inventory.push(itemName);
            
            addToLog(`YOU BUY ${itemName} FOR ${item.cost} GOLD!`, false, true);
            addToLog(`GOLD REMAINING: ${gameState.player.gold}`, false, true);
            
            updateStatsDisplay();
            displayShopItems(); // Refresh shop display
        }

        // Sell item
        function sellItem(itemName, sellValue) {
            // Don't sell equipped items
            const equipped = Object.values(gameState.player.equipped);
            if (equipped.includes(itemName)) {
                addToLog('CANNOT SELL EQUIPPED ITEM!', false, true);
                return;
            }
            
            const index = gameState.player.inventory.indexOf(itemName);
            if (index > -1) {
                gameState.player.inventory.splice(index, 1);
                gameState.player.gold += sellValue;
                
                addToLog(`YOU SELL ${itemName} FOR ${sellValue} GOLD!`, false, true);
                addToLog(`GOLD: ${gameState.player.gold}`, false, true);
                
                updateStatsDisplay();
                displaySellItems(); // Refresh sell display
            }
        }

        // Talk to shopkeeper
        function talkToShopkeeper() {
            const dialogues = [
                '"POTIONS, SCROLLS, WEAPONS... ALL FOR A REASONABLE PRICE!"',
                '"THE DEEPER YOU GO, THE BETTER THE LOOT... AND THE DEADLIER THE TRAPS!"',
                '"I HEARD THE DRAGON HAS AWOKEN. YOU\'LL NEED STRONGER GEAR."',
                '"MANY HAVE SOUGHT THE AMULET. BRING ME THEIR TREASURE AND I\'LL PAY WELL."',
                '"DON\'T FORGET TO CHECK YOUR EQUIPMENT. A GOOD SHIELD CAN SAVE YOUR LIFE!"'
            ];
            
            const dialogue = dialogues[Math.floor(Math.random() * dialogues.length)];
            addToLog('SHOPKEEPER: ' + dialogue, false, true);
        }

        // Leave shop
        function leaveShop() {
            gameState.shopOpen = false;
            addToLog('YOU LEAVE THE SHOP.', false, true);
            updateActionButtons();
        }

        // Attack action
        function attack() {
            if (!gameState.inCombat || !gameState.enemy) return;
            
            const player = gameState.player;
            const enemy = enemies[gameState.enemy];
            
            // Calculate attack roll
            const attackRoll = rollDice(20);
            let attackBonus = Math.floor((player.str - 10) / 2);
            
            // Check for buffs
            const strBuff = player.statusEffects.find(effect => effect.type === 'str_buff');
            if (strBuff) attackBonus += strBuff.value;
            
            const totalAttack = attackRoll + attackBonus;
            
            addToLog(`YOU ATTACK THE ${enemy.name}...`, true);
            addToLog(`ATTACK ROLL: ${attackRoll} + ${attackBonus} = ${totalAttack} vs AC ${enemy.ac}`, true);
            
            if (totalAttack >= enemy.ac || attackRoll === 20) {
                // Calculate damage
                let damage = player.damageBonus;
                
                if (player.equipped.weapon) {
                    const weapon = items[player.equipped.weapon];
                    if (weapon) {
                        damage += rollDice(parseInt(weapon.damage[2]));
                    }
                } else {
                    damage += rollDice(4); // Unarmed
                }
                
                // Critical hit
                if (attackRoll === 20) {
                    damage *= 2;
                    addToLog('CRITICAL HIT!', true);
                }
                
                // Apply enemy resistances
                if (enemy.resistances && enemy.resistances.length > 0) {
                    // Check if resistant to physical damage
                    if (enemy.resistances.includes('slashing') || enemy.resistances.includes('bludgeoning') || enemy.resistances.includes('piercing')) {
                        damage = Math.floor(damage / 2);
                        addToLog(`${enemy.name} RESISTS SOME DAMAGE!`, true);
                    }
                }
                
                enemy.hp -= damage;
                addToLog(`YOU HIT FOR ${damage} DAMAGE!`, true);
                
                // Check if enemy is defeated
                if (enemy.hp <= 0) {
                    defeatEnemy();
                    return;
                }
            } else {
                addToLog('YOUR ATTACK MISSES!', true);
            }
            
            updateEnemyDisplay();
            enemyAttack();
        }

        // Defend action
        function defend() {
            if (!gameState.inCombat || !gameState.enemy) return;
            
            addToLog('YOU TAKE A DEFENSIVE STANCE.', true);
            
            // Player gets temporary AC boost
            gameState.player.ac += 2;
            gameState.player.statusEffects.push({ type: 'defending', duration: 1 });
            
            updateStatsDisplay();
            enemyAttack();
        }

        // Flee action
        function flee() {
            if (!gameState.inCombat) return;
            
            const fleeChance = Math.floor((gameState.player.dex - 10) / 2) + 5;
            const fleeRoll = rollDice(20);
            
            addToLog('YOU ATTEMPT TO FLEE!', true);
            addToLog(`FLEE ROLL: ${fleeRoll} vs ${fleeChance}`, true);
            
            if (fleeRoll >= fleeChance) {
                addToLog('YOU SUCCESSFULLY FLEE FROM COMBAT!', true);
                endCombat();
            } else {
                addToLog('YOU FAIL TO ESCAPE!', true);
                enemyAttack();
            }
        }

        // Enemy attack
        function enemyAttack() {
            const player = gameState.player;
            const enemy = enemies[gameState.enemy];
            
            addToLog(`${enemy.name} ATTACKS!`, true);
            
            const attackRoll = rollDice(20);
            const totalAttack = attackRoll;
            
            addToLog(`${enemy.name} ATTACK ROLL: ${attackRoll} vs AC ${player.ac}`, true);
            
            // Check for player defensive effects
            let effectiveAC = player.ac;
            const defending = player.statusEffects.find(effect => effect.type === 'defending');
            if (defending) effectiveAC += 2;
            
            const parry = player.statusEffects.find(effect => effect.type === 'parry');
            if (parry) effectiveAC += 5;
            
            const shield = player.statusEffects.find(effect => effect.type === 'shield');
            if (shield) effectiveAC += 5;
            
            if (totalAttack >= effectiveAC || attackRoll === 20) {
                // Calculate damage
                let damage = 0;
                if (enemy.damage.includes('d')) {
                    const parts = enemy.damage.split('d');
                    const dice = parseInt(parts[0]);
                    const sides = parseInt(parts[1].split('+')[0]);
                    const bonus = parseInt(parts[1].split('+')[1]) || 0;
                    
                    for (let i = 0; i < dice; i++) {
                        damage += rollDice(sides);
                    }
                    damage += bonus;
                }
                
                // Critical hit
                if (attackRoll === 20) {
                    damage *= 2;
                    addToLog('CRITICAL HIT!', true);
                }
                
                player.hp -= damage;
                addToLog(`${enemy.name} HITS YOU FOR ${damage} DAMAGE!`, true);
                
                // Check if player is defeated
                if (player.hp <= 0) {
                    gameOver();
                    return;
                }
                
                updateStatsDisplay();
            } else {
                addToLog(`${enemy.name} MISSES!`, true);
            }
            
            // Update status effects duration
            updateStatusEffects();
        }

        // Update enemy display
        function updateEnemyDisplay() {
            if (!gameState.enemy) return;
            
            const enemy = enemies[gameState.enemy];
            enemyName.textContent = enemy.name;
            enemyHp.textContent = `HP: ${enemy.hp}/${enemy.maxHp}`;
            
            const healthPercent = (enemy.hp / enemy.maxHp) * 100;
            enemyHealthFill.style.width = `${healthPercent}%`;
            
            // Update enemy status
            if (gameState.enemyStatusEffects.length > 0) {
                enemyStatus.textContent = gameState.enemyStatusEffects.map(effect => effect.type.toUpperCase()).join(', ');
                enemyEffects.innerHTML = '';
                
                gameState.enemyStatusEffects.forEach(effect => {
                    const effectDiv = document.createElement('div');
                    effectDiv.className = 'status-effect';
                    effectDiv.textContent = effect.type.toUpperCase();
                    enemyEffects.appendChild(effectDiv);
                });
            } else {
                enemyStatus.textContent = 'NORMAL';
                enemyEffects.innerHTML = '';
            }
        }

        // Start combat
        function startCombat(enemyType) {
            gameState.inCombat = true;
            gameState.enemy = enemyType;
            gameState.enemyStatusEffects = [];
            
            const enemy = enemies[enemyType];
            addToLog(`A ${enemy.name} APPEARS! COMBAT BEGINS!`, true);
            
            updateEnemyDisplay();
            updateActionButtons();
            
            // Check for surprise round (player goes first)
            if (Math.random() < 0.3) {
                addToLog('YOU CAUGHT THE ENEMY BY SURPRISE! YOU GET A FREE ATTACK!', true);
            } else {
                // Enemy might get first attack
                if (Math.random() < 0.3) {
                    addToLog('THE ENEMY ACTS FIRST!', true);
                    setTimeout(enemyAttack, 1000);
                }
            }
        }

        // End combat
        function endCombat() {
            gameState.inCombat = false;
            gameState.enemy = null;
            gameState.enemyStatusEffects = [];
            
            // Reset player status effects from combat
            gameState.player.statusEffects = gameState.player.statusEffects.filter(
                effect => !['defending', 'parry', 'shield'].includes(effect.type)
            );
            
            // Reset AC
            calculateDerivedStats();
            
            updateStatsDisplay();
            updateActionButtons();
        }

        // Defeat enemy
        function defeatEnemy() {
            const enemy = enemies[gameState.enemy];
            
            addToLog(`YOU DEFEATED THE ${enemy.name}!`, true);
            
            // Award XP
            gameState.player.xp += enemy.xp;
            addToLog(`YOU GAIN ${enemy.xp} EXPERIENCE POINTS!`, false, true);
            
            // Award gold
            const goldAwarded = rollDice(parseInt(enemy.gold[0])) * (parseInt(enemy.gold[1]) || 1) + 
                              (parseInt(enemy.gold.split('+')[1]) || 0);
            gameState.player.gold += goldAwarded;
            addToLog(`YOU FIND ${goldAwarded} GOLD ON THE CORPSE.`, false, true);
            
            // Random loot drop
            if (Math.random() < 0.3) {
                const possibleLoot = ['Health Potion', 'Minor Healing Potion', 'Poison Vial'];
                const loot = possibleLoot[Math.floor(Math.random() * possibleLoot.length)];
                gameState.player.inventory.push(loot);
                addToLog(`YOU FIND A ${loot.toUpperCase()}!`, false, true);
                updateInventoryDisplay();
            }
            
            // Special loot for bosses
            if (enemy.name === 'Ancient Red Dragon') {
                gameState.player.inventory.push('Dragon Scale');
                addToLog('YOU FIND A RARE DRAGON SCALE!', false, true);
                updateInventoryDisplay();
            }
            
            // Update quest progress
            if (enemy.name === 'Goblin') {
                gameState.player.quests.side1.progress++;
                if (gameState.player.quests.side1.progress >= gameState.player.quests.side1.required) {
                    gameState.player.quests.side1.completed = true;
                    addToLog('QUEST COMPLETED: CLEARED THE GOBLIN NEST!', false, true);
                    gameState.player.xp += 200;
                    gameState.player.gold += 100;
                } else {
                    addToLog(`GOBLINS SLAIN: ${gameState.player.quests.side1.progress}/${gameState.player.quests.side1.required}`, false, true);
                }
                updateQuestLog();
            }
            
            if (enemy.name === 'Ancient Red Dragon') {
                gameState.player.quests.side3.completed = true;
                addToLog('QUEST COMPLETED: SLAY THE DRAGON!', false, true);
                updateQuestLog();
            }
            
            // Check for level up
            checkLevelUp();
            
            // End combat
            endCombat();
        }

        // Update quest log
        function updateQuestLog() {
            const quests = gameState.player.quests;
            let questHTML = '';
            
            for (const key in quests) {
                const quest = quests[key];
                if (quest.name) {
                    let status = '';
                    if (quest.completed) {
                        status = '[COMPLETED]';
                    } else if (quest.progress !== undefined) {
                        status = `[${quest.progress}/${quest.required}]`;
                    } else {
                        status = '[ACTIVE]';
                    }
                    questHTML += `<div>${status} ${quest.name}</div>`;
                }
            }
            
            questList.innerHTML = questHTML;
        }

        // Check for level up
        function checkLevelUp() {
            const player = gameState.player;
            
            if (player.xp >= player.nextLevelXp) {
                player.level++;
                const excessXp = player.xp - player.nextLevelXp;
                player.nextLevelXp = Math.floor(player.nextLevelXp * 1.5);
                player.xp = excessXp;
                
                // Increase HP
                const hpIncrease = Math.floor(Math.random() * 6) + 1 + Math.floor((player.con - 10) / 2);
                player.maxHp += hpIncrease;
                player.hp += hpIncrease;
                
                // Increase Mana for casters
                if (player.maxMana > 0) {
                    const manaIncrease = Math.floor(Math.random() * 4) + 1 + Math.floor((player.int - 10) / 2);
                    player.maxMana += manaIncrease;
                    player.mana += manaIncrease;
                }
                
                // Ability score improvement every 4 levels
                if (player.level % 4 === 0) {
                    const stats = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
                    const statToIncrease = stats[Math.floor(Math.random() * stats.length)];
                    player[statToIncrease]++;
                    addToLog(`YOUR ${statToIncrease.toUpperCase()} INCREASES BY 1!`, false, true);
                    calculateDerivedStats();
                }
                
                addToLog(`CONGRATULATIONS! YOU ADVANCE TO LEVEL ${player.level}!`, false, true);
                addToLog(`MAX HP INCREASED BY ${hpIncrease}!`, false, true);
                
                if (player.maxMana > 0) {
                    addToLog(`MAX MANA INCREASED!`, false, true);
                }
                
                updateStatsDisplay();
            }
        }

        // Update status effects
        function updateStatusEffects() {
            // Update player status effects
            gameState.player.statusEffects = gameState.player.statusEffects.filter(effect => {
                effect.duration--;
                return effect.duration > 0;
            });
            
            // Apply poison damage if poisoned
            const poisonEffect = gameState.player.statusEffects.find(effect => effect.type === 'poison');
            if (poisonEffect && poisonEffect.damage) {
                gameState.player.hp -= poisonEffect.damage;
                addToLog(`YOU TAKE ${poisonEffect.damage} POISON DAMAGE!`, true);
                
                if (gameState.player.hp <= 0) {
                    gameOver();
                    return;
                }
                updateStatsDisplay();
            }
            
            // Remove temporary AC bonuses
            calculateDerivedStats();
        }

        // Restart game
        function restartGame() {
            gameState.player = {
                name: 'Valeros',
                race: 'Human',
                class: 'Fighter',
                background: 'Soldier',
                level: 1,
                hp: 10,
                maxHp: 10,
                mana: 10,
                maxMana: 10,
                ac: 15,
                str: 16,
                dex: 12,
                con: 14,
                int: 10,
                wis: 8,
                cha: 13,
                xp: 0,
                nextLevelXp: 100,
                gold: 100,
                inventory: ['Health Potion', 'Iron Sword', 'Leather Armor', 'Minor Healing Potion'],
                equipped: {
                    weapon: 'Iron Sword',
                    armor: 'Leather Armor',
                    shield: null
                },
                spells: [],
                skills: [],
                abilities: [],
                statusEffects: [],
                dungeonLevel: 1,
                quests: {
                    main: { name: 'Find the Amulet of Yendor', completed: false },
                    side1: { name: 'Clear the Goblin Nest', completed: false, progress: 0, required: 5 },
                    side2: { name: 'Recover the Lost Artifact', completed: false },
                    side3: { name: 'Slay the Dragon', completed: false }
                }
            };
            
            gameState.location = 'entrance';
            gameState.inCombat = false;
            gameState.enemy = null;
            gameState.enemyStatusEffects = [];
            gameState.gameLog = [];
            gameState.gameActive = true;
            gameState.shopOpen = false;
            gameState.pointsRemaining = 27;
            
            // Update UI
            updateStatsDisplay();
            updateQuestLog();
            updateEquipmentDisplay();
            gameText.innerHTML = '';
            
            // Switch screens
            gameOverScreen.classList.add('hidden');
            victoryScreen.classList.add('hidden');
            characterCreation.classList.remove('hidden');
            gameState.screen = 'character';
            
            // Reset character creation form
            charNameInput.value = 'VALEROS';
            charRaceSelect.value = 'Human';
            charClassSelect.value = 'Fighter';
            charBackgroundSelect.value = 'Soldier';
            
            // Reset stat allocation
            initCharacterCreation();
            
            addToLog('WELCOME TO THE DUNGEON OF INFINITE PERIL!');
            addToLog('YOUR QUEST: RETRIEVE THE LOST AMULET OF YENDOR FROM THE DEPTHS.');
        }

        // New Game+
        function startNewGamePlus() {
            // Keep character stats but increase difficulty
            gameState.player.level = 1;
            gameState.player.xp = 0;
            gameState.player.nextLevelXp = 150;
            gameState.player.dungeonLevel = 1;
            gameState.location = 'entrance';
            gameState.inCombat = false;
            gameState.enemy = null;
            gameState.gameActive = true;
            gameState.gameLog = [];
            
            // Reset quests
            gameState.player.quests.main.completed = false;
            gameState.player.quests.side1.completed = false;
            gameState.player.quests.side1.progress = 0;
            gameState.player.quests.side2.completed = false;
            gameState.player.quests.side3.completed = false;
            
            // Update UI
            updateStatsDisplay();
            updateQuestLog();
            gameText.innerHTML = '';
            
            // Switch to game screen
            victoryScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameState.screen = 'game';
            
            addToLog('NEW GAME+ MODE ACTIVATED!');
            addToLog('ENEMIES ARE STRONGER AND YOU NEED MORE EXPERIENCE.');
            addToLog('YOUR QUEST BEGINS ANEW...');
            addToLog(locations[gameState.location].description);
            
            updateActionButtons();
        }

        // Game over
        function gameOver() {
            gameState.gameActive = false;
            
            addToLog('YOU HAVE BEEN DEFEATED...', true);
            addToLog('GAME OVER', true);
            
            // Show game over screen
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            
            // Display game over text
            const gameOverText = document.getElementById('game-over-text');
            gameOverText.innerHTML = '';
            
            const summary = document.createElement('div');
            summary.innerHTML = `
                <div>FINAL STATS:</div>
                <div>NAME: ${gameState.player.name}</div>
                <div>LEVEL: ${gameState.player.level}</div>
                <div>GOLD: ${gameState.player.gold}</div>
                <div>DUNGEON LEVEL REACHED: ${gameState.player.dungeonLevel}</div>
                <div>TOTAL XP: ${gameState.player.xp}</div>
                <br>
                <div>BETTER LUCK NEXT TIME!</div>
            `;
            gameOverText.appendChild(summary);
        }

        // Victory
        function victory() {
            gameState.gameActive = false;
            
            // Mark main quest as completed
            gameState.player.quests.main.completed = true;
            updateQuestLog();
            
            // Show victory screen
            gameScreen.classList.add('hidden');
            victoryScreen.classList.remove('hidden');
            
            // Display victory text
            const victoryText = document.getElementById('victory-text');
            victoryText.innerHTML = '';
            
            const summary = document.createElement('div');
            summary.innerHTML = `
                <div>YOU HAVE RETRIEVED THE AMULET OF YENDOR!</div>
                <div>YOUR QUEST IS COMPLETE!</div>
                <br>
                <div>FINAL STATS:</div>
                <div>NAME: ${gameState.player.name}</div>
                <div>RACE/CLASS: ${gameState.player.race} ${gameState.player.class}</div>
                <div>LEVEL: ${gameState.player.level}</div>
                <div>GOLD: ${gameState.player.gold}</div>
                <div>DUNGEON LEVEL REACHED: ${gameState.player.dungeonLevel}</div>
                <div>TOTAL XP: ${gameState.player.xp}</div>
                <br>
                <div>CONGRATULATIONS!</div>
            `;
            victoryText.appendChild(summary);
        }

        // Utility function to roll dice
        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        // Add text to log
        function addToLog(text, isCombat = false, isLoot = false, isHeal = false, isSkill = false, isShop = false) {
            const logEntry = document.createElement('div');
            if (isCombat) logEntry.classList.add('combat-log');
            else if (isLoot) logEntry.classList.add('loot-log');
            else if (isHeal) logEntry.classList.add('heal-log');
            else if (isSkill) logEntry.classList.add('skill-log');
            else if (isShop) logEntry.classList.add('shop-log');
            
            logEntry.textContent = text;
            gameText.appendChild(logEntry);
            
            // Auto-scroll to bottom
            gameText.scrollTop = gameText.scrollHeight;
            
            // Add to game state log
            gameState.gameLog.push(text);
        }

        // Initialize the game
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
