<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highway Hauntings - Route 66 Supernatural</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background-color: #0a0a14;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(47, 79, 79, 0.1) 0%, transparent 20%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(47, 79, 79, 0.05) 1px,
                    rgba(47, 79, 79, 0.05) 2px
                );
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border: 2px solid #8b0000;
            background-color: #0a0a14;
            position: relative;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
        }
        
        .active {
            display: flex !important;
        }
        
        h1, h2, h3 {
            color: #d4af37;
            text-align: center;
            margin: 10px 0;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.7);
            font-family: 'Georgia', serif;
        }
        
        .button {
            background-color: #1a1a2a;
            color: #d4af37;
            border: 1px solid #8b0000;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-family: 'Georgia', serif;
        }
        
        .button:hover {
            background-color: #8b0000;
            color: #f5f5dc;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.7);
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            border-bottom: 1px dashed #8b0000;
            padding-bottom: 10px;
        }
        
        .log {
            border: 1px solid #8b0000;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 14px;
            background-color: rgba(26, 26, 42, 0.8);
            font-family: 'Georgia', serif;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px;
            border-left: 2px solid transparent;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .radio-active {
            border-left: 2px solid #d4af37 !important;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            border: 1px solid #8b0000;
            padding: 8px;
            cursor: pointer;
            position: relative;
            background-color: rgba(26, 26, 42, 0.8);
        }
        
        .item-stats {
            font-size: 12px;
            margin-top: 5px;
            color: #d4af37;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #000;
            border: 1px solid #8b0000;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        
        .gas-bar .progress-fill {
            background-color: #d4af37;
        }
        
        .sanity-bar .progress-fill {
            background-color: #8b0000;
        }
        
        .money-bar .progress-fill {
            background-color: #228b22;
        }
        
        .class-select {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .class-option {
            border: 1px solid #8b0000;
            padding: 15px;
            cursor: pointer;
            background-color: rgba(26, 26, 42, 0.8);
            transition: all 0.3s;
        }
        
        .class-option:hover {
            background-color: #8b0000;
            color: #f5f5dc;
            transform: translateX(5px);
        }
        
        .travel-display {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .location-slot {
            border: 1px solid #8b0000;
            padding: 5px;
            margin: 5px;
            min-width: 80px;
            text-align: center;
            background-color: rgba(26, 26, 42, 0.8);
            position: relative;
        }
        
        .location-danger {
            font-size: 10px;
            color: #ff5555;
        }
        
        .location-clues {
            font-size: 10px;
            color: #00ffff;
        }
        
        .money-counter {
            color: #228b22;
            font-weight: bold;
        }
        
        .radio-button {
            background: linear-gradient(45deg, #8b0000, #d4af37);
            color: #f5f5dc;
            border: 1px solid #00ffff;
        }
        
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1s ease-out forwards;
            font-family: 'Georgia', serif;
        }
        
        .damage-text {
            color: #ff5555;
        }
        
        .clue-text {
            color: #00ffff;
        }
        
        .money-text {
            color: #228b22;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .rarity-common { color: #fff; }
        .rarity-uncommon { color: #1eff00; }
        .rarity-rare { color: #0070dd; }
        .rarity-epic { color: #a335ee; }
        .rarity-legendary { color: #ff8000; }
        
        .tooltip {
            position: absolute;
            background: #1a1a2a;
            border: 1px solid #8b0000;
            padding: 8px;
            z-index: 1000;
            max-width: 250px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            font-family: 'Georgia', serif;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        .investigation-bars {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }
        
        .investigation-bar-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .investigation-bar-label {
            width: 80px;
            font-size: 12px;
        }
        
        .investigation-bar {
            flex: 1;
            height: 15px;
            background-color: #000;
            border: 1px solid #8b0000;
            position: relative;
            overflow: hidden;
        }
        
        .investigation-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .gas-fill {
            background-color: #d4af37;
        }
        
        .sanity-fill {
            background-color: #8b0000;
        }
        
        .investigation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .evidence-slot {
            border: 1px solid #8b0000;
            padding: 10px;
            background-color: rgba(26, 26, 42, 0.8);
        }
        
        .evidence-equipment {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .evidence-equip-slot {
            border: 1px dashed #8b0000;
            padding: 5px;
            text-align: center;
            font-size: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upgrade-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .upgrade-slot {
            border: 1px solid #8b0000;
            padding: 10px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(26, 26, 42, 0.8);
            cursor: pointer;
        }
        
        .upgrade-slot.selected {
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
        }
        
        .upgrade-preview {
            border: 1px solid #00ffff;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(0, 255, 255, 0.1);
        }
        
        .evidence-item {
            border: 1px solid #8b0000;
            padding: 5px;
            margin: 2px;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            background-color: rgba(26, 26, 42, 0.8);
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #8b0000;
            margin-bottom: 10px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            font-family: 'Georgia', serif;
        }
        
        .tab.active {
            border-color: #8b0000;
            background-color: rgba(139, 0, 0, 0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .enhanced-button {
            background: linear-gradient(45deg, #8b0000, #d4af37);
            color: #f5f5dc;
            border: 1px solid #00ffff;
            position: relative;
            overflow: hidden;
            font-family: 'Georgia', serif;
        }
        
        .enhanced-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .enhanced-button:hover::before {
            left: 100%;
        }
        
        .location-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a2a;
            border: 2px solid #8b0000;
            padding: 20px;
            z-index: 1000;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.7);
        }
        
        .location-option {
            border: 1px solid #8b0000;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            background-color: rgba(26, 26, 42, 0.8);
        }
        
        .location-option:hover {
            background-color: rgba(139, 0, 0, 0.3);
        }
        
        .investigatable-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .investigatable-item {
            border: 1px solid #8b0000;
            padding: 8px;
            cursor: pointer;
            background-color: rgba(26, 26, 42, 0.8);
        }
        
        .investigatable-item:hover {
            border-color: #00ffff;
        }
        
        .investigatable-item.selected {
            border-color: #00ffff;
            background-color: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .encounter-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a2a;
            border: 2px solid #8b0000;
            padding: 20px;
            z-index: 1000;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.7);
        }

        .car-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            border-bottom: 1px dashed #8b0000;
            padding-bottom: 10px;
        }

        .car-upgrades {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .car-upgrade-slot {
            border: 1px solid #8b0000;
            padding: 15px;
            background-color: rgba(26, 26, 42, 0.8);
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .car-upgrade-slot.installed {
            border-color: #d4af37;
            background-color: rgba(212, 175, 55, 0.1);
        }

        .car-upgrade-slot.unlocked {
            border-color: #1eff00;
        }

        .car-upgrade-slot.locked {
            opacity: 0.6;
            background-color: rgba(26, 26, 42, 0.5);
        }

        .upgrade-level {
            color: #00ffff;
            font-weight: bold;
        }

        .upgrade-effect {
            color: #1eff00;
            font-size: 12px;
        }

        .upgrade-cost {
            color: #ff5555;
            font-size: 12px;
        }

        .radio-log {
            border: 1px solid #8b0000;
            padding: 10px;
            background-color: rgba(26, 26, 42, 0.8);
            margin: 10px 0;
        }

        .radio-message {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .encounter-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .encounter-stat {
            border: 1px solid #8b0000;
            padding: 5px;
            text-align: center;
        }
        
        .encounter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .equipment-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a2a;
            border: 2px solid #8b0000;
            padding: 20px;
            z-index: 1000;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.7);
        }
        
        .equipment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .audio-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        
        .audio-btn {
            background: rgba(26, 26, 42, 0.8);
            border: 1px solid #8b0000;
            color: #8b0000;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Georgia', serif;
        }
        
        .audio-btn:hover {
            background: #8b0000;
            color: #f5f5dc;
        }
        
        .accessibility-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        
        .accessibility-btn {
            background: rgba(26, 26, 42, 0.8);
            border: 1px solid #8b0000;
            color: #8b0000;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'Georgia', serif;
        }
        
        .accessibility-btn:hover {
            background: #8b0000;
            color: #f5f5dc;
        }
        
        .font-small {
            font-size: 12px;
        }
        
        .font-medium {
            font-size: 14px;
        }
        
        .font-large {
            font-size: 16px;
        }
        
        .font-xlarge {
            font-size: 18px;
        }
        
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tutorial-box {
            background: #1a1a2a;
            border: 2px solid #8b0000;
            padding: 20px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.7);
        }
        
        .tutorial-highlight {
            position: relative;
            z-index: 1999;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 10px 2px #00ffff;
        }
        
        .tutorial-progress {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            color: #8b0000;
        }
        
        .gas-low {
            animation: pulse-warning 1s infinite;
        }
        
        .sanity-low {
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 215, 0, 0.2); }
        }
        
        @keyframes pulse-red {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(139, 0, 0, 0.2); }
        }
        
        .defeat-screen h2 {
            color: #ff5555;
            animation: pulse 2s infinite;
        }
        
        .defeat-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .defeat-penalty {
            color: #ff5555;
            font-weight: bold;
        }
        
        .defeat-message {
            color: #8b0000;
            text-align: center;
            margin: 10px 0;
        }

        .evidence-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 10px 0;
        }

        .evidence-display .evidence-item {
            min-height: 100px;
            padding: 15px;
            font-size: 16px;
            border: 1px solid #8b0000;
            text-align: center;
            cursor: pointer;
            background-color: rgba(26, 26, 42, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .class-occultist { border-color: #8b0000; }
        .class-skeptic { border-color: #2f4f4f; }
        .class-drifter { border-color: #d4af37; }

        .class-occultist:hover { background-color: #8b0000; }
        .class-skeptic:hover { background-color: #2f4f4f; }
        .class-drifter:hover { background-color: #d4af37; }

        .set-item {
            border: 1px solid #ffd700 !important;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .legendary-item {
            border: 2px solid #ff8000 !important;
            animation: legendary-glow 2s infinite alternate;
            box-shadow: 0 0 10px rgba(255, 128, 0, 0.7);
        }

        @keyframes legendary-glow {
            0% { box-shadow: 0 0 5px rgba(255, 128, 0, 0.5); }
            100% { box-shadow: 0 0 15px rgba(255, 128, 0, 1); }
        }

        .road-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 50%, rgba(139, 0, 0, 0.1) 50%);
            background-size: 20px 100%;
            animation: road-move 1s linear infinite;
            pointer-events: none;
            opacity: 0.3;
        }

        @keyframes road-move {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .radio-static {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.1"/></svg>');
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .radio-static.active {
            opacity: 0.1;
        }
        
        .item:hover .tooltip {
            display: block;
        }
        
        #find-mystery-btn {
            background: linear-gradient(45deg, #8b0000, #2f4f4f);
            border: 1px solid #00ffff;
        }
        
        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-animation {
            animation: pulse-animation 1s infinite;
        }

        /* NEW STYLES FOR ENHANCEMENTS */
        
        .skill-bar {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .skill-bar .label {
            width: 120px;
            color: #d4af37;
        }
        
        .skill-bar .bar {
            flex: 1;
            height: 10px;
            background: #1a1a2a;
            border: 1px solid #8b0000;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }
        
        .skill-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #8b0000, #d4af37);
            transition: width 0.5s ease;
        }
        
        .skill-bar .value {
            width: 30px;
            text-align: right;
            color: #00ffff;
            font-weight: bold;
        }
        
        .faction-rep {
            display: flex;
            align-items: center;
            margin: 3px 0;
            font-size: 11px;
        }
        
        .faction-name {
            width: 80px;
            color: #d4af37;
        }
        
        .faction-bar {
            flex: 1;
            height: 8px;
            background: #1a1a2a;
            border: 1px solid #8b0000;
            margin: 0 5px;
            position: relative;
            overflow: hidden;
        }
        
        .faction-fill {
            height: 100%;
            background: #2f4f4f;
            transition: width 0.5s ease;
        }
        
        .weather-display {
            position: absolute;
            top: 10px;
            right: 120px;
            font-size: 11px;
            color: #00ffff;
            z-index: 100;
        }
        
        .time-display {
            position: absolute;
            top: 10px;
            right: 220px;
            font-size: 11px;
            color: #d4af37;
            z-index: 100;
        }
        
        .mini-map {
            border: 1px solid #8b0000;
            padding: 5px;
            margin: 10px 0;
            background: rgba(26, 26, 42, 0.9);
            font-family: monospace;
            line-height: 1;
            font-size: 8px;
            white-space: pre;
            overflow-x: auto;
        }
        
        .map-player {
            color: #ff0000;
            font-weight: bold;
        }
        
        .map-town {
            color: #00ff00;
        }
        
        .map-mystery {
            color: #ff00ff;
        }
        
        .multi-mystery-container {
            margin: 10px 0;
            border: 1px solid #8b0000;
            padding: 10px;
            background: rgba(26, 26, 42, 0.8);
        }
        
        .mystery-chain {
            border-left: 2px solid #d4af37;
            padding-left: 10px;
            margin: 10px 0;
        }
        
        .chain-step {
            margin: 5px 0;
            padding: 5px;
            border: 1px dashed #2f4f4f;
            background: rgba(47, 79, 79, 0.1);
        }
        
        .dynamic-radio-message {
            animation: radio-flicker 0.5s ease-in-out;
        }
        
        @keyframes radio-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .encounter-chain {
            background: linear-gradient(45deg, #1a1a2a, #2f4f4f);
            border: 1px solid #d4af37;
            padding: 10px;
            margin: 10px 0;
        }
        
        .risk-reward {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ff5555;
            background: rgba(255, 85, 85, 0.1);
        }
        
        .risk-reward .risk {
            color: #ff5555;
        }
        
        .risk-reward .reward {
            color: #1eff00;
        }
        
        .equipment-slot {
            border: 2px dashed #8b0000;
            padding: 15px;
            margin: 5px;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(26, 26, 42, 0.5);
            cursor: pointer;
        }
        
        .equipment-slot.filled {
            border: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .equipment-slot:hover {
            border-color: #00ffff;
        }
        
        .perk-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .perk-card {
            border: 1px solid #8b0000;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(26, 26, 42, 0.8);
            transition: all 0.3s;
        }
        
        .perk-card.unlocked {
            border-color: #1eff00;
            background: rgba(30, 255, 0, 0.1);
        }
        
        .perk-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .perk-card.available {
            border-color: #d4af37;
            animation: pulse 2s infinite;
        }
        
        .perk-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .perk-cost {
            color: #ff5555;
            font-size: 10px;
        }
        
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.7) 70%);
            z-index: 50;
        }
        
        .environmental-note {
            position: absolute;
            background: rgba(26, 26, 42, 0.9);
            border: 1px solid #8b0000;
            padding: 10px;
            max-width: 200px;
            font-size: 11px;
            z-index: 100;
            animation: fadeIn 0.5s ease;
        }
        
        .drag-over {
            border: 2px solid #00ffff !important;
            background: rgba(0, 255, 255, 0.1) !important;
        }
        
        .skill-effect {
            position: absolute;
            background: rgba(212, 175, 55, 0.8);
            color: #000;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            pointer-events: none;
            z-index: 100;
        }
        
        .economy-fluctuation {
            color: #ff5555;
            animation: pulse 1s infinite;
        }
        
        .negotiation-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
        }
        
        .negotiation-option {
            padding: 8px;
            border: 1px solid #8b0000;
            text-align: center;
            cursor: pointer;
            background: rgba(26, 26, 42, 0.8);
        }
        
        .negotiation-option:hover {
            background: rgba(139, 0, 0, 0.3);
        }
        
        .progressive-difficulty {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .difficulty-meter {
            flex: 1;
            height: 15px;
            background: linear-gradient(90deg, #1eff00, #ff8000, #ff0000);
            border: 1px solid #8b0000;
            margin: 0 10px;
            position: relative;
        }
        
        .difficulty-marker {
            position: absolute;
            top: -5px;
            width: 2px;
            height: 25px;
            background: #fff;
        }
        
        .car-maintenance {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .maintenance-bar {
            height: 15px;
            background: #1a1a2a;
            border: 1px solid #8b0000;
            position: relative;
            overflow: hidden;
        }
        
        .maintenance-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .maintenance-critical {
            animation: pulse-red 1s infinite;
        }
        
        .weather-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
        }
        
        .rain {
            background: linear-gradient(transparent, rgba(0, 100, 255, 0.1));
            animation: rain-fall 1s linear infinite;
        }
        
        @keyframes rain-fall {
            0% { background-position: 0 0; }
            100% { background-position: 0 20px; }
        }
        
        .fog {
            background: rgba(200, 200, 200, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .dust-storm {
            background: rgba(139, 69, 19, 0.4);
            animation: dust-swirl 10s linear infinite;
        }
        
        @keyframes dust-swirl {
            0% { background-position: 0 0; }
            100% { background-position: 100px 100px; }
        }
        
        .time-of-day {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 30;
        }
        
        .night {
            background: rgba(0, 0, 50, 0.6);
        }
        
        .dawn {
            background: linear-gradient(to bottom, rgba(255, 100, 0, 0.3), rgba(0, 0, 50, 0.6));
        }
        
        .dusk {
            background: linear-gradient(to bottom, rgba(0, 0, 50, 0.6), rgba(139, 0, 0, 0.3));
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 42, 0.95);
            border: 2px solid #ffd700;
            padding: 20px;
            z-index: 2000;
            text-align: center;
            animation: achievement-pop 2s ease;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
        }
        
        @keyframes achievement-pop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .faction-event {
            border: 2px solid;
            padding: 10px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }
        
        .police-event { border-color: #0000ff; background: rgba(0, 0, 255, 0.1); }
        .locals-event { border-color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .occultists-event { border-color: #8b0000; background: rgba(139, 0, 0, 0.1); }
        .media-event { border-color: #ffff00; background: rgba(255, 255, 0, 0.1); }
        
        .case-file {
            border: 2px solid #8b0000;
            padding: 15px;
            margin: 10px 0;
            background: rgba(26, 26, 42, 0.9);
            position: relative;
        }
        
        .case-file::before {
            content: 'CASE FILE';
            position: absolute;
            top: -10px;
            left: 10px;
            background: #1a1a2a;
            padding: 0 10px;
            color: #d4af37;
            font-size: 12px;
        }
        
        .connected-mystery {
            border-left: 3px solid #00ffff;
            padding-left: 10px;
            margin: 10px 0;
        }
        
        .speed-options {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }
        
        .speed-option {
            padding: 10px;
            border: 1px solid #8b0000;
            text-align: center;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
        }
        
        .speed-option.selected {
            background: #8b0000;
            border-color: #00ffff;
        }
        
        .speed-option:hover:not(.selected) {
            background: rgba(139, 0, 0, 0.3);
        }
        
        .push-luck {
            background: linear-gradient(45deg, #8b0000, #ff0000);
            border: 2px solid #ffd700;
            font-weight: bold;
        }
        
        .danger-investigation {
            background: linear-gradient(45deg, #8b0000, #ff5555);
            border: 2px solid #ff0000;
        }
        
        .betting-game {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        
        .bet-option {
            padding: 15px;
            border: 1px solid #8b0000;
            text-align: center;
            cursor: pointer;
            background: rgba(26, 26, 42, 0.8);
        }
        
        .bet-option:hover {
            background: rgba(139, 0, 0, 0.3);
        }
        
        .bet-option.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }
        
        .collectible {
            border: 2px solid #ffd700 !important;
            background: rgba(255, 215, 0, 0.1) !important;
            position: relative;
        }
        
        .collectible::after {
            content: 'â˜…';
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ffd700;
        }
        
        .photo-album {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        
        .photo-frame {
            border: 1px solid #8b0000;
            padding: 10px;
            text-align: center;
            background: rgba(26, 26, 42, 0.8);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .keyboard-shortcut {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: #8b0000;
        }
        
        .new-game-plus {
            background: linear-gradient(45deg, #8b0000, #ff8000, #8b0000);
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
            border: 2px solid #ffd700;
        }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .seasonal-event {
            border: 2px solid;
            padding: 10px;
            margin: 10px 0;
            animation: pulse 3s infinite;
        }
        
        .halloween { border-color: #ff8000; background: rgba(255, 128, 0, 0.1); }
        .christmas { border-color: #ff5555; background: rgba(255, 85, 85, 0.1); }
        
        .resting-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-size: 24px;
            color: #d4af37;
            animation: fadeIn 1s ease;
        }
        
        .car-names {
            font-style: italic;
            color: #00ffff;
            font-size: 12px;
            margin: 5px 0;
        }
        
        .quick-save-notification {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(26, 26, 42, 0.9);
            border: 1px solid #00ff00;
            padding: 10px;
            z-index: 1000;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%) translateY(-50%); }
            to { transform: translateX(0) translateY(-50%); }
        }
        
        .souvenir-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        
        .souvenir {
            border: 1px solid #8b0000;
            padding: 5px;
            font-size: 10px;
            background: rgba(26, 26, 42, 0.8);
        }
        
        .achievement-tracker {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(26, 26, 42, 0.9);
            border: 1px solid #8b0000;
            padding: 10px;
            font-size: 11px;
            z-index: 100;
            max-width: 200px;
        }
        
        .miles-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(26, 26, 42, 0.9);
            border: 1px solid #8b0000;
            padding: 10px;
            font-size: 11px;
            z-index: 100;
        }
        
        .keyboard-nav-hint {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 42, 0.9);
            border: 1px solid #8b0000;
            padding: 10px;
            font-size: 11px;
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Road Animation -->
        <div class="road-animation" id="road-animation"></div>
        
        <!-- Radio Static Overlay -->
        <div class="radio-static" id="radio-static"></div>
        
        <!-- Weather Effects -->
        <div class="weather-effect" id="weather-effect"></div>
        
        <!-- Time of Day -->
        <div class="time-of-day" id="time-of-day"></div>
        
        <!-- Vignette Effect -->
        <div class="vignette"></div>
        
        <!-- Audio Controls -->
        <div class="audio-controls">
            <button class="audio-btn" id="music-toggle">Music: ON</button>
            <button class="audio-btn" id="sfx-toggle">SFX: ON</button>
        </div>
        
        <!-- Accessibility Controls -->
        <div class="accessibility-controls">
            <button class="accessibility-btn" id="font-size-btn">Font: Medium</button>
            <button class="accessibility-btn" id="tutorial-btn">Tutorial</button>
            <button class="accessibility-btn" id="high-contrast">High Contrast</button>
        </div>
        
        <!-- Weather Display -->
        <div class="weather-display" id="weather-display">Clear</div>
        
        <!-- Time Display -->
        <div class="time-display" id="time-display">8:00 PM</div>
        
        <!-- Achievement Tracker -->
        <div class="achievement-tracker" id="achievement-tracker" style="display: none;">
            <strong>Achievements</strong><br>
            <span id="achievement-count">0/50</span>
        </div>
        
        <!-- Miles Counter -->
        <div class="miles-counter" id="miles-counter">
            Miles: <span id="total-miles">0</span>
        </div>
        
        <!-- Keyboard Navigation Hint -->
        <div class="keyboard-nav-hint" id="keyboard-hint" style="display: none;">
            Press 1-9 for quick actions
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>HIGHWAY HAUNTINGS</h1>
            <h3>Route 66 Supernatural Investigation</h3>
            <div style="margin: 40px 0; text-align: center;">
                <p>The year is 1978. You're driving down Route 66...</p>
                <p>The radio crackles with more than static.</p>
                <p>Lost souls whisper from roadside diners.</p>
                <p>Something watches from the desert.</p>
                <p style="color: #d4af37; margin-top: 20px;">Solve mysteries. Survive the road. Don't run out of gas.</p>
                <div class="car-names" id="random-car-name"></div>
            </div>
            <div class="button enhanced-button" id="start-button">START YOUR ENGINE</div>
            <div class="button" id="load-button">CONTINUE JOURNEY</div>
            <div class="button" id="new-game-plus" style="display: none;">NEW GAME+</div>
            <div class="souvenir-display" id="souvenir-display" style="display: none;"></div>
        </div>
        
        <!-- Class Selection Screen -->
        <div id="class-screen" class="screen">
            <h1>CHOOSE YOUR DRIVER</h1>
            <div class="class-select">
                <div class="class-option class-occultist" data-class="occultist">
                    <h3>THE OCCULTIST</h3>
                    <p>Knows ancient rituals and forbidden lore</p>
                    <p>+20% to supernatural investigations</p>
                    <p>Starts with Ritual Kit and Occult Library</p>
                    <p>Special: Can commune with spirits</p>
                    <p style="color: #8b0000;">"The old gods still walk these roads..."</p>
                </div>
                <div class="class-option class-skeptic" data-class="skeptic">
                    <h3>THE SKEPTIC</h3>
                    <p>Investigative journalist seeking the truth</p>
                    <p>+30% to gathering evidence</p>
                    <p>Starts with Camera and Tape Recorder</p>
                    <p>Special: Can debunk false leads</p>
                    <p style="color: #2f4f4f;">"There's always a rational explanation..."</p>
                </div>
                <div class="class-option class-drifter" data-class="drifter">
                    <h3>THE DRIFTER</h3>
                    <p>Seen too much, survived everything</p>
                    <p>+25% to survival and car maintenance</p>
                    <p>Starts with Tool Kit and Road Map</p>
                    <p>Special: Can intimidate threats</p>
                    <p style="color: #d4af37;">"Some roads shouldn't be traveled at night..."</p>
                </div>
            </div>
            <div class="button" id="back-to-start">BACK</div>
        </div>
        
        <!-- Main Game Screen -->
        <div id="game-screen" class="screen">
            <h2 id="game-title">ROUTE 66 - MILE <span id="current-mile-display">0</span></h2>
            
            <!-- Progressive Difficulty -->
            <div class="progressive-difficulty" id="difficulty-display">
                <span>Danger:</span>
                <div class="difficulty-meter">
                    <div class="difficulty-marker" style="left: 25%;"></div>
                    <div class="difficulty-marker" style="left: 50%;"></div>
                    <div class="difficulty-marker" style="left: 75%;"></div>
                </div>
                <span id="difficulty-level">LOW</span>
            </div>
            
            <div class="stats">
                <div>
                    <div>Location: <span id="current-location">Starting Point</span></div>
                    <div>Gas: <span id="player-gas">100</span>/<span id="player-max-gas">100</span></div>
                    <div>Sanity: <span id="player-sanity">80</span>/<span id="player-max-sanity">100</span></div>
                    <div>Time: <span id="current-time">8:00 PM</span></div>
                </div>
                <div>
                    <div>Cash: $<span id="player-cash" class="money-counter">50</span></div>
                    <div>Day: <span id="player-day">1</span></div>
                    <div>Mysteries: <span id="player-mysteries">0</span></div>
                    <div>Reputation: <span id="player-reputation">0</span></div>
                </div>
            </div>
            
            <div class="progress-bar gas-bar">
                <div id="gas-bar" class="progress-fill" style="width: 100%"></div>
            </div>
            <div class="progress-bar sanity-bar">
                <div id="sanity-bar" class="progress-fill" style="width: 80%"></div>
            </div>
            <div class="progress-bar money-bar">
                <div id="cash-bar" class="progress-fill" style="width: 50%"></div>
            </div>
            
            <!-- Skill Bars -->
            <h3>SKILLS</h3>
            <div class="skill-bar">
                <div class="label">Investigation:</div>
                <div class="bar"><div id="skill-investigation-bar" class="fill" style="width: 10%"></div></div>
                <div class="value" id="skill-investigation">1</div>
            </div>
            <div class="skill-bar">
                <div class="label">Driving:</div>
                <div class="bar"><div id="skill-driving-bar" class="fill" style="width: 10%"></div></div>
                <div class="value" id="skill-driving">1</div>
            </div>
            <div class="skill-bar">
                <div class="label">Occult:</div>
                <div class="bar"><div id="skill-occult-bar" class="fill" style="width: 10%"></div></div>
                <div class="value" id="skill-occult">1</div>
            </div>
            <div class="skill-bar">
                <div class="label">Repair:</div>
                <div class="bar"><div id="skill-repair-bar" class="fill" style="width: 10%"></div></div>
                <div class="value" id="skill-repair">1</div>
            </div>
            
            <!-- Faction Reputation -->
            <h3>FACTION STANDING</h3>
            <div class="faction-rep">
                <div class="faction-name">Police:</div>
                <div class="faction-bar"><div id="faction-police-bar" class="faction-fill" style="width: 50%"></div></div>
                <div id="faction-police">0</div>
            </div>
            <div class="faction-rep">
                <div class="faction-name">Locals:</div>
                <div class="faction-bar"><div id="faction-locals-bar" class="faction-fill" style="width: 50%"></div></div>
                <div id="faction-locals">0</div>
            </div>
            <div class="faction-rep">
                <div class="faction-name">Occultists:</div>
                <div class="faction-bar"><div id="faction-occultists-bar" class="faction-fill" style="width: 50%"></div></div>
                <div id="faction-occultists">0</div>
            </div>
            <div class="faction-rep">
                <div class="faction-name">Media:</div>
                <div class="faction-bar"><div id="faction-media-bar" class="faction-fill" style="width: 50%"></div></div>
                <div id="faction-media">0</div>
            </div>
            
            <h3>CURRENT INVESTIGATIONS</h3>
            <div id="current-investigations" class="log" style="height: 150px;">
                <div id="current-investigation">No active investigation</div>
                <div id="case-files"></div>
            </div>
            
            <h3>CAR STATUS</h3>
            <!-- Car Maintenance -->
            <div class="car-maintenance">
                <div>Engine: <div class="maintenance-bar"><div id="car-engine-bar" class="maintenance-fill" style="width: 100%"></div></div></div>
                <div>Tires: <div class="maintenance-bar"><div id="car-tires-bar" class="maintenance-fill" style="width: 100%"></div></div></div>
                <div>Battery: <div class="maintenance-bar"><div id="car-battery-bar" class="maintenance-fill" style="width: 100%"></div></div></div>
                <div>Suspension: <div class="maintenance-bar"><div id="car-suspension-bar" class="maintenance-fill" style="width: 100%"></div></div></div>
            </div>
            
            <!-- Mini Map -->
            <h3>MINI-MAP</h3>
            <div class="mini-map" id="mini-map">
[Your position]
    |
    v
[Chicago]
    |
[Springfield]
    |
[St. Louis]
    |
[Tulsa]
    |
[Amarillo]
            </div>
            
            <div class="button enhanced-button" id="drive-button">DRIVE TO NEXT TOWN</div>
            
            <!-- Speed Options -->
            <div class="speed-options" id="speed-options">
                <div class="speed-option" data-speed="safe">Safe (+10% gas)</div>
                <div class="speed-option selected" data-speed="normal">Normal</div>
                <div class="speed-option push-luck" data-speed="fast">Fast (-20% gas)</div>
            </div>
            
            <div class="button" id="investigate-button">INVESTIGATE AREA</div>
            <div class="button danger-investigation" id="danger-investigate" style="display: none;">DANGEROUS SITE (-30 sanity)</div>
            
            <div class="button" id="inventory-button">CAR INVENTORY</div>
            <div class="button" id="radio-button">SCAN RADIO</div>
            <div class="button" id="upgrades-button">CAR UPGRADES</div>
            <div class="button" id="perks-button">PERKS</div>
            <div class="button" id="map-button">CHECK MAP</div>
            <div class="button" id="rest-button">REST AT MOTEL</div>
            <div class="button" id="save-button">SAVE PROGRESS</div>
            <div class="button" id="find-mystery-btn" style="display: none;">FIND MYSTERY ($<span id="mystery-cost">25</span>)</div>
            
            <!-- Faction Events -->
            <div id="faction-events"></div>
            
            <div class="log" id="game-log">
                <div class="log-entry">The engine hums as you pull onto Route 66. The road stretches into darkness...</div>
                <div class="log-entry radio-active">RADIO: "...strange lights reported near mile marker 42..."</div>
            </div>
        </div>
        
        <!-- Drive/Encounter Screen -->
        <div id="drive-screen" class="screen">
            <h2>ON THE ROAD</h2>
            
            <!-- Risk/Reward Display -->
            <div class="risk-reward" id="risk-reward-display">
                <div class="risk">Risk: <span id="risk-level">LOW</span></div>
                <div class="reward">Reward: <span id="reward-level">LOW</span></div>
            </div>
            
            <div class="investigation-bars">
                <div class="investigation-bar-container">
                    <div class="investigation-bar-label">Gas:</div>
                    <div class="investigation-bar">
                        <div id="drive-gas-bar" class="investigation-bar-fill gas-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="investigation-bar-container">
                    <div class="investigation-bar-label">Sanity:</div>
                    <div class="investigation-bar">
                        <div id="drive-sanity-bar" class="investigation-bar-fill sanity-fill" style="width: 80%"></div>
                    </div>
                </div>
                <div class="investigation-bar-container">
                    <div class="investigation-bar-label">Distance:</div>
                    <div class="investigation-bar">
                        <div id="distance-bar" class="investigation-bar-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="stats">
                <div>
                    <div>Gas: <span id="drive-player-gas">100</span>/<span id="drive-player-max-gas">100</span></div>
                    <div>Sanity: <span id="drive-player-sanity">80</span>/<span id="drive-player-max-sanity">100</span></div>
                </div>
                <div>
                    <div>Cash: $<span id="drive-player-cash" class="money-counter">50</span></div>
                    <div>Next Town: <span id="next-town">50</span> miles</div>
                    <div>Speed: <span id="drive-speed">Normal</span></div>
                </div>
            </div>
            
            <h3>ROAD AHEAD</h3>
            <div class="log" id="drive-log">
                <div class="log-entry">Headlights cut through the darkness. The radio crackles...</div>
            </div>
            
            <div id="encounter-display" style="text-align: center; margin: 20px 0; font-size: 18px;">
                [DRIVING...]
            </div>
            
            <!-- Environmental Vignettes -->
            <div id="environmental-vignettes" style="margin: 10px 0;"></div>
            
            <div id="encounter-actions" style="display: none;">
                <h3>ENCOUNTER</h3>
                <div id="encounter-description"></div>
                
                <!-- Skill Check Display -->
                <div id="skill-check-display" style="margin: 10px 0; padding: 10px; border: 1px solid #d4af37; background: rgba(212, 175, 55, 0.1); display: none;">
                    <strong>Skill Check:</strong> <span id="required-skill">Investigation</span> 
                    (Your: <span id="player-skill-level">1</span> vs Needed: <span id="required-skill-level">2</span>)
                    <div class="progress-bar" style="height: 10px; margin: 5px 0;">
                        <div id="skill-check-bar" class="progress-fill" style="width: 50%; background: #d4af37;"></div>
                    </div>
                </div>
                
                <div class="encounter-actions" id="encounter-choices">
                </div>
            </div>
            
            <div id="drive-actions">
                <div class="button" id="continue-drive">CONTINUE DRIVING</div>
                <div class="button" id="stop-car">PULL OVER</div>
                <div class="button" id="check-radio">CHECK RADIO</div>
                <div class="button" id="return-to-map">RETURN TO MAP</div>
                <div class="button push-luck" id="push-luck-drive">PUSH YOUR LUCK (2x miles)</div>
            </div>
        </div>
        
        <!-- Investigation Screen -->
        <div id="investigate-screen" class="screen">
            <h2>INVESTIGATION</h2>
            
            <div class="stats">
                <div>Location: <span id="investigate-location">Current Area</span></div>
                <div>Time: <span id="investigate-time">Day</span></div>
                <div>Clues Found: <span id="clues-found">0</span>/<span id="clues-needed">0</span></div>
            </div>
            
            <!-- Multi-Part Mysteries -->
            <div id="multi-mystery-container" style="display: none;">
                <h3>MYSTERY CHAIN</h3>
                <div id="mystery-chain"></div>
            </div>
            
            <h3>ACTIVE MYSTERY</h3>
            <div id="mystery-description" class="log" style="height: 100px;">
                No active mystery
            </div>
            
            <!-- Equipment Slots -->
            <h3>EQUIPMENT</h3>
            <div style="display: flex; justify-content: space-around; margin: 10px 0;">
                <div class="equipment-slot" id="equip-main" data-slot="main">
                    <div>Main Tool</div>
                    <div id="equip-main-name"></div>
                </div>
                <div class="equipment-slot" id="equip-secondary" data-slot="secondary">
                    <div>Secondary</div>
                    <div id="equip-secondary-name"></div>
                </div>
                <div class="equipment-slot" id="equip-tool" data-slot="tool">
                    <div>Special</div>
                    <div id="equip-tool-name"></div>
                </div>
            </div>
            
            <h3>GATHER EVIDENCE</h3>
            <div class="investigation-grid" id="investigation-options">
                <!-- Investigation options appear here -->
            </div>
            
            <!-- Branching Solutions -->
            <div id="solution-options" style="display: none; margin: 20px 0;">
                <h3>POSSIBLE SOLUTIONS</h3>
                <div id="solution-choices"></div>
            </div>
            
            <h3>EVIDENCE COLLECTED</h3>
            <div id="evidence-collected" class="log" style="height: 150px; overflow-y: auto;">
                No evidence collected yet.
            </div>
            
            <div class="button enhanced-button" id="solve-button">SOLVE MYSTERY</div>
            <div class="button" id="back-from-investigate">RETURN TO CAR</div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>CAR INVENTORY</h2>
            <div class="tab-container">
                <div class="tab active" data-tab="items">Supplies</div>
                <div class="tab" data-tab="evidence">Evidence</div>
                <div class="tab" data-tab="tools">Tools</div>
                <div class="tab" data-tab="notes">Case Notes</div>
                <div class="tab" data-tab="photos">Photo Album</div>
                <div class="tab" data-tab="souvenirs">Souvenirs</div>
            </div>
            
            <div class="tab-content active" id="items-tab">
                <div class="car-stats">
                    <div>Gas Cans: <span id="gas-cans">1</span></div>
                    <div>Food Rations: <span id="food-rations">3</span></div>
                    <div>First Aid: <span id="first-aid">2</span></div>
                    <div>Spare Parts: <span id="spare-parts">0</span></div>
                </div>
                <div class="inventory-grid" id="inventory-items">
                    <!-- Inventory items appear here -->
                </div>
            </div>
            
            <div class="tab-content" id="evidence-tab">
                <h3>COLLECTED EVIDENCE</h3>
                <div id="evidence-display" class="inventory-grid">
                    <!-- Evidence appears here -->
                </div>
            </div>
            
            <div class="tab-content" id="tools-tab">
                <h3>INVESTIGATION TOOLS</h3>
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #8b0000;">
                    <strong>Equipped:</strong>
                    <div id="equipped-tools-display"></div>
                </div>
                <div id="tools-display" class="inventory-grid">
                    <!-- Tools appear here -->
                </div>
            </div>
            
            <div class="tab-content" id="notes-tab">
                <h3>CASE NOTES</h3>
                <div id="notes-display" class="log">
                    <!-- Case notes appear here -->
                </div>
            </div>
            
            <div class="tab-content" id="photos-tab">
                <h3>PHOTO ALBUM</h3>
                <div class="photo-album" id="photo-album-display">
                    <!-- Photos appear here -->
                </div>
            </div>
            
            <div class="tab-content" id="souvenirs-tab">
                <h3>SOUVENIRS</h3>
                <div class="souvenir-display" id="souvenir-inventory">
                    <!-- Souvenirs appear here -->
                </div>
            </div>
            
            <div class="button" id="back-from-inventory">BACK TO CAR</div>
        </div>
        
        <!-- Radio Screen -->
        <div id="radio-screen" class="screen">
            <h2>CAR RADIO</h2>
            <div class="stats">
                <div>Signal Strength: <span id="signal-strength">50%</span></div>
                <div>Frequency: <span id="current-frequency">88.5 FM</span></div>
                <div>Battery: <span id="radio-battery">100%</span></div>
                <div>Weather: <span id="radio-weather">Clear</span></div>
            </div>
            
            <div class="radio-log" id="radio-log">
                <div class="radio-message dynamic-radio-message">
                    <span>Police Band: "...missing persons report..."</span>
                    <span style="color: #d4af37;">[88.5 FM]</span>
                </div>
                <div class="radio-message dynamic-radio-message">
                    <span>Weather: "...unexplained fog patterns..."</span>
                    <span style="color: #d4af37;">[92.3 FM]</span>
                </div>
                <div class="radio-message dynamic-radio-message">
                    <span>Static: "...help us..."</span>
                    <span style="color: #8b0000;">[Unknown]</span>
                </div>
            </div>
            
            <h3>TUNE FREQUENCY</h3>
            <div class="investigation-grid">
                <div class="button" data-freq="88.5">88.5 FM (Police)</div>
                <div class="button" data-freq="92.3">92.3 FM (Weather)</div>
                <div class="button" data-freq="95.7">95.7 FM (News)</div>
                <div class="button" data-freq="98.1">98.1 FM (Music)</div>
                <div class="button enhanced-button" data-freq="scan">SCAN FOR SIGNALS</div>
                <div class="button" data-freq="static">LISTEN TO STATIC</div>
                <div class="button" data-freq="supernatural">SUPERNATURAL FREQ</div>
                <div class="button" data-freq="faction">FACTION CHANNELS</div>
            </div>
            
            <!-- Dynamic Radio Messages -->
            <div id="dynamic-radio" style="margin: 10px 0; padding: 10px; border: 1px solid #8b0000;">
                <h4>CURRENT CONDITIONS</h4>
                <div id="radio-conditions"></div>
            </div>
            
            <div class="button" id="back-from-radio">TURN OFF RADIO</div>
        </div>
        
        <!-- Car Upgrades Screen -->
        <div id="upgrades-screen" class="screen">
            <h2>CAR UPGRADES</h2>
            <div class="car-stats">
                <div>Cash: $<span id="upgrade-cash" class="money-counter">50</span></div>
                <div>Car Condition: <span id="car-condition">Good</span></div>
                <div>Trunk Space: <span id="trunk-space">10/20</span></div>
                <div>Maintenance Cost: $<span id="maintenance-cost">10</span></div>
            </div>
            
            <!-- Negotiation Options -->
            <div id="negotiation-options" style="display: none; margin: 10px 0;">
                <h3>NEGOTIATE PRICE</h3>
                <div class="negotiation-options">
                    <div class="negotiation-option" data-mod="0.8">Hard Bargain (-20%)</div>
                    <div class="negotiation-option selected" data-mod="1">Standard Price</div>
                    <div class="negotiation-option" data-mod="1.2">Generous (+20%)</div>
                </div>
            </div>
            
            <h3>AVAILABLE UPGRADES</h3>
            <div class="car-upgrades" id="car-upgrades-grid">
                <!-- Car upgrades appear here -->
            </div>
            
            <h3>INSTALLED UPGRADES</h3>
            <div id="installed-upgrades" class="log">
                <!-- Installed upgrades appear here -->
            </div>
            
            <div class="button" id="back-from-upgrades">BACK TO CAR</div>
        </div>
        
        <!-- Perks Screen -->
        <div id="perks-screen" class="screen">
            <h2>PERKS & ABILITIES</h2>
            <div class="stats">
                <div>Perk Points: <span id="perk-points" class="money-counter">0</span></div>
                <div>Class: <span id="perk-class">None</span></div>
                <div>Level: <span id="perk-level">1</span></div>
            </div>
            
            <h3>AVAILABLE PERKS</h3>
            <div class="perk-grid" id="perks-grid">
                <!-- Perks appear here -->
            </div>
            
            <h3>ACTIVE PERKS</h3>
            <div id="active-perks" class="log">
                <!-- Active perks appear here -->
            </div>
            
            <div class="button" id="back-from-perks">BACK TO CAR</div>
        </div>
        
        <!-- Map Screen -->
        <div id="map-screen" class="screen">
            <h2>ROUTE 66 MAP</h2>
            <div class="stats">
                <div>Current Mile: <span id="current-mile">0</span></div>
                <div>Next Town: <span id="map-next-town">50 miles</span></div>
                <div>Gas Stations: <span id="gas-stations">1 ahead</span></div>
                <div>Weather Ahead: <span id="map-weather">Clear</span></div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <pre style="color: #d4af37; font-family: monospace; position: relative;">
    CHICAGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          <span class="map-player" id="player-marker">â–²</span>       â”‚
    ST. LOUIS â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    SPRINGFIELD â”€â”€â”€â”€â”€â”˜
                     â”‚
    TULSA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    AMARILLO â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    ALBUQUERQUE â”€â”€â”€â”€â”€â”˜
                     â”‚
    FLAGSTAFF â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    LOS ANGELES â”€â”€â”€â”€â”€â”˜
                </pre>
            </div>
            
            <h3>KNOWN MYSTERIES</h3>
            <div id="map-mysteries" class="log">
                <!-- Known mysteries appear here -->
            </div>
            
            <!-- Connected Mysteries -->
            <div id="connected-mysteries" style="display: none;">
                <h3>CONNECTED CASES</h3>
                <div id="connected-cases"></div>
            </div>
            
            <div class="button enhanced-button" id="plan-route">PLAN ROUTE</div>
            <div class="button" id="back-from-map">BACK TO CAR</div>
        </div>
        
        <!-- Rest Screen -->
        <div id="rest-screen" class="screen">
            <h2>MOTEL STOP</h2>
            
            <!-- Economy Fluctuation -->
            <div id="economy-display" style="margin: 10px 0; padding: 10px; border: 1px solid #ff5555; background: rgba(255, 85, 85, 0.1);">
                <strong>Local Economy:</strong> <span id="economy-status">Normal</span>
                <div class="economy-fluctuation" id="price-fluctuation" style="display: none;">Prices increased by 20%!</div>
            </div>
            
            <div class="stats">
                <div>Cash: $<span id="rest-cash" class="money-counter">50</span></div>
                <div>Room Cost: $<span id="room-cost">20</span></div>
                <div>Food Cost: $<span id="food-cost">10</span></div>
                <div>Gas Cost: $<span id="gas-cost">30</span>/Can</div>
            </div>
            
            <div class="log" id="motel-description">
                <div class="log-entry">The "Desert Star Motel" sign flickers in the night.</div>
                <div class="log-entry">Room 13 is available... if you dare.</div>
            </div>
            
            <h3>OPTIONS</h3>
            <div class="investigation-grid">
                <div class="button" id="rest-cheap">SLEEP IN CAR (Free)</div>
                <div class="button" id="rest-room">RENT ROOM ($<span id="room-price">20</span>)</div>
                <div class="button" id="rest-food">BUY FOOD ($<span id="food-price">10</span>)</div>
                <div class="button" id="rest-gas">BUY GAS ($<span id="gas-price">30</span>/Can)</div>
                <div class="button" id="rest-find-mystery">LISTEN FOR RUMORS ($<span id="rumor-price">15</span>)</div>
                <div class="button" id="rest-betting">GAMBLE</div>
                <div class="button" id="rest-leave">LEAVE MOTEL</div>
            </div>
            
            <!-- Betting Game -->
            <div id="betting-game" style="display: none; margin: 20px 0;">
                <h3>POKER GAME</h3>
                <div class="betting-game">
                    <div class="bet-option" data-bet="5">Bet $5</div>
                    <div class="bet-option" data-bet="20">Bet $20</div>
                    <div class="bet-option" data-bet="50">Bet $50</div>
                </div>
                <div id="betting-result" style="text-align: center; margin: 10px 0;"></div>
                <div class="button" id="leave-betting">LEAVE TABLE</div>
            </div>
            
            <h3>NOTICE BOARD</h3>
            <div id="notice-board" class="log" style="height: 100px;">
                <div class="log-entry">"Missing: Traveling salesman, last seen near mile 156"</div>
                <div class="log-entry">"Wanted: Information about glowing rocks"</div>
            </div>
            
            <!-- Faction Rumors -->
            <div id="faction-rumors" style="display: none;">
                <h3>FACTION RUMORS</h3>
                <div id="rumor-list"></div>
            </div>
        </div>
        
        <!-- Mystery Solved Screen -->
        <div id="solved-screen" class="screen">
            <h2>MYSTERY SOLVED!</h2>
            <div class="log">
                <div class="log-entry">You've uncovered the truth!</div>
                <div class="log-entry" id="solution-text"></div>
                <div class="log-entry">Rewards:</div>
                <div id="reward-items">
                </div>
                <!-- Branching Outcome -->
                <div id="branching-outcome" style="display: none; margin: 10px 0; padding: 10px; border: 1px solid #00ffff;">
                    <h4>CHOOSE YOUR PATH:</h4>
                    <div id="outcome-choices"></div>
                </div>
            </div>
            <div class="button" id="continue-after-solve">CONTINUE JOURNEY</div>
        </div>
        
        <!-- Defeat Screen -->
        <div id="defeat-screen" class="screen">
            <h2>STRANDED</h2>
            <div class="log">
                <div class="log-entry">The road has claimed another traveler...</div>
                <div class="log-entry" id="defeat-message"></div>
                <div class="log-entry" id="loss-message"></div>
                <div class="log-entry">A tow truck finds you days later...</div>
            </div>
            <div class="defeat-options">
                <div class="button enhanced-button" id="continue-from-defeat">CONTINUE FROM LAST TOWN</div>
                <div class="button" id="return-to-menu-from-defeat">MAIN MENU</div>
            </div>
        </div>
    </div>

    <script>
        // ================================================
        // HIGHWAY HAUNTINGS - Enhanced Edition
        // ================================================

        // Audio System with Web Audio API
        const audioSystem = {
            context: null,
            enabled: { music: true, sfx: true },
            ambientSounds: {},
            
            init: function() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio system initialized");
                    
                    // Initialize ambient sounds
                    this.initAmbientSounds();
                } catch (e) {
                    console.error("Web Audio API not supported:", e);
                    this.context = null;
                }
            },
            
            initAmbientSounds: function() {
                this.ambientSounds = {
                    engine: this.createLoopingSound(120, 'sawtooth', 0.02),
                    rain: this.createLoopingSound(500, 'sine', 0.1),
                    wind: this.createLoopingSound(300, 'white', 0.05),
                    static: this.createLoopingSound(800, 'square', 0.03)
                };
            },
            
            createLoopingSound: function(freq, type, volume) {
                if (!this.context) return null;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = type;
                gainNode.gain.value = volume;
                
                return { oscillator, gainNode, playing: false };
            },
            
            playAmbient: function(soundName) {
                if (!this.enabled.sfx || !this.context || !this.ambientSounds[soundName]) return;
                
                const sound = this.ambientSounds[soundName];
                if (!sound.playing) {
                    sound.oscillator.start();
                    sound.playing = true;
                }
            },
            
            stopAmbient: function(soundName) {
                if (!this.ambientSounds[soundName] || !this.ambientSounds[soundName].playing) return;
                
                const sound = this.ambientSounds[soundName];
                sound.gainNode.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + 0.5);
                setTimeout(() => {
                    sound.oscillator.stop();
                    sound.playing = false;
                }, 500);
            },
            
            playClick: function() {
                if (!this.enabled.sfx || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                
                oscillator.start();
                oscillator.stop(this.context.currentTime + 0.1);
            },
            
            playEngine: function() {
                if (!this.enabled.sfx || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = 120;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.05, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(this.context.currentTime + 0.5);
            },
            
            playRadio: function() {
                if (!this.enabled.sfx || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = 600;
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.2);
                
                oscillator.start();
                oscillator.stop(this.context.currentTime + 0.2);
            },
            
            playSuccess: function() {
                if (!this.enabled.sfx || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(523.25, this.context.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, this.context.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, this.context.currentTime + 0.2); // G5
                
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(this.context.currentTime + 0.5);
            },
            
            playDefeat: function() {
                if (!this.enabled.sfx || !this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(220, this.context.currentTime); // A3
                oscillator.frequency.setValueAtTime(174.61, this.context.currentTime + 0.2); // F3
                oscillator.frequency.setValueAtTime(146.83, this.context.currentTime + 0.4); // D3
                
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.6);
                
                oscillator.start();
                oscillator.stop(this.context.currentTime + 0.6);
            },
            
            playWeather: function(weather) {
                if (!this.enabled.sfx || !this.context) return;
                
                switch(weather) {
                    case 'rain':
                        this.playAmbient('rain');
                        break;
                    case 'windy':
                        this.playAmbient('wind');
                        break;
                    default:
                        this.stopAmbient('rain');
                        this.stopAmbient('wind');
                }
            }
        };

        const gameState = {
            currentScreen: 'start',
            player: {
                class: null,
                location: 'chicago',
                mile: 0,
                totalMiles: 0,
                day: 1,
                hour: 20,
                minute: 0,
                gas: 100,
                maxGas: 100,
                sanity: 80,
                maxSanity: 100,
                cash: 50,
                mysteriesSolved: 0,
                reputation: 0,
                level: 1,
                xp: 0,
                perkPoints: 0,
                equipment: {
                    main: null,
                    secondary: null,
                    tool: null
                },
                inventory: [],
                evidence: [],
                tools: [],
                notes: [],
                photos: [],
                souvenirs: [],
                carUpgrades: [],
                perks: [],
                activeMysteries: [],
                cluesFound: 0,
                cluesNeeded: 3,
                caseFiles: {},
                
                // Enhanced systems
                skills: {
                    investigation: { level: 1, xp: 0, nextLevel: 100 },
                    driving: { level: 1, xp: 0, nextLevel: 100 },
                    occult: { level: 1, xp: 0, nextLevel: 100 },
                    repair: { level: 1, xp: 0, nextLevel: 100 }
                },
                
                factions: {
                    police: { rep: 0, level: 'Neutral' },
                    locals: { rep: 0, level: 'Neutral' },
                    occultists: { rep: 0, level: 'Neutral' },
                    media: { rep: 0, level: 'Neutral' }
                },
                
                carMaintenance: {
                    engine: 100,
                    tires: 100,
                    battery: 100,
                    suspension: 100
                },
                
                achievements: new Set(),
                collectibles: new Set()
            },
            
            // Progressive difficulty
            difficulty: {
                level: 1,
                encounterRate: 0.3,
                resourceDrain: 1.0,
                mysteryComplexity: 1
            },
            
            // Time and weather
            time: {
                hour: 20,
                minute: 0,
                dayPhase: 'night' // dawn, day, dusk, night
            },
            
            weather: {
                current: 'clear',
                forecast: 'clear',
                intensity: 1,
                effects: {}
            },
            
            // Economy
            economy: {
                inflation: 1.0,
                locationModifier: 1.0,
                priceFluctuation: 0
            },
            
            // Game world
            world: {
                discoveredLocations: new Set(['chicago']),
                activeEvents: [],
                seasonalEvents: [],
                factionEvents: []
            },
            
            currentEncounter: null,
            encounterChain: [],
            gameLog: [],
            radioLog: [],
            driveDistance: 0,
            nextTownDistance: 50,
            drivingSpeed: 'normal',
            riskLevel: 'low',
            
            accessibility: {
                fontSize: 'medium',
                tutorialEnabled: true,
                highContrast: false,
                reducedMotion: false,
                completedTutorials: []
            },
            
            newGamePlus: false
        };

        // Enhanced Traveler Classes
        const classes = {
            occultist: {
                name: "The Occultist",
                description: "Knows ancient rituals and forbidden lore",
                gas: 80,
                sanity: 70,
                cash: 40,
                startingItems: ['ritual_kit', 'occult_library', 'holy_water'],
                startingTools: ['ouija_board', 'silver_dagger'],
                specialAbility: 'commune',
                skillBonuses: { occult: 2, investigation: 1 },
                factionStart: { occultists: 20 },
                perkTree: 'occult'
            },
            skeptic: {
                name: "The Skeptic",
                description: "Investigative journalist seeking the truth",
                gas: 90,
                sanity: 90,
                cash: 60,
                startingItems: ['camera', 'tape_recorder', 'notebook'],
                startingTools: ['flashlight', 'magnifying_glass'],
                specialAbility: 'debunk',
                skillBonuses: { investigation: 2, driving: 1 },
                factionStart: { media: 20 },
                perkTree: 'investigation'
            },
            drifter: {
                name: "The Drifter",
                description: "Seen too much, survived everything",
                gas: 100,
                sanity: 60,
                cash: 50,
                startingItems: ['tool_kit', 'road_map', 'whiskey'],
                startingTools: ['crowbar', 'shotgun'],
                specialAbility: 'intimidate',
                skillBonuses: { repair: 2, driving: 1 },
                factionStart: { locals: 20 },
                perkTree: 'survival'
            }
        };

        // Enhanced Route 66 Locations
        const locations = {
            chicago: {
                name: "Chicago, IL",
                mile: 0,
                description: "The starting point. City lights fade behind you.",
                mysteries: ['vanishing_hitchhiker'],
                services: ['gas', 'motel', 'diner', 'repair'],
                danger: 1,
                economy: 1.2,
                weatherPattern: ['clear', 'rain'],
                factions: { police: 'strong', media: 'strong' }
            },
            st_louis: {
                name: "St. Louis, MO",
                mile: 300,
                description: "Gateway to the West. The arch looms in the distance.",
                mysteries: ['ghostly_arch', 'arch_construction'],
                services: ['gas', 'motel', 'repair', 'library'],
                danger: 2,
                economy: 1.0,
                weatherPattern: ['clear', 'fog'],
                factions: { police: 'medium', locals: 'strong' }
            },
            springfield: {
                name: "Springfield, IL",
                mile: 200,
                description: "A quiet town with restless spirits.",
                mysteries: ['grave_robber', 'hospital_ghosts'],
                services: ['gas', 'diner', 'hospital'],
                danger: 3,
                economy: 0.8,
                weatherPattern: ['clear', 'rain', 'fog'],
                factions: { locals: 'strong', occultists: 'weak' }
            },
            tulsa: {
                name: "Tulsa, OK",
                mile: 500,
                description: "Oil money and old secrets.",
                mysteries: ['oil_ghosts', 'oil_baron'],
                services: ['gas', 'motel', 'repair', 'bar'],
                danger: 2,
                economy: 1.1,
                weatherPattern: ['clear', 'dust'],
                factions: { police: 'weak', locals: 'medium' }
            },
            amarillo: {
                name: "Amarillo, TX",
                mile: 800,
                description: "Where the desert begins to whisper.",
                mysteries: ['sand_ghosts', 'desert_cult'],
                services: ['gas', 'motel'],
                danger: 4,
                economy: 0.9,
                weatherPattern: ['clear', 'dust', 'heatwave'],
                factions: { occultists: 'medium', locals: 'weak' }
            },
            albuquerque: {
                name: "Albuquerque, NM",
                mile: 1100,
                description: "Ancient ruins and modern mysteries.",
                mysteries: ['ancient_curse', 'alien_lights'],
                services: ['gas', 'motel', 'diner', 'repair', 'museum'],
                danger: 3,
                economy: 1.0,
                weatherPattern: ['clear', 'wind'],
                factions: { police: 'medium', occultists: 'strong' }
            },
            flagstaff: {
                name: "Flagstaff, AZ",
                mile: 1400,
                description: "Pine forests hiding dark things.",
                mysteries: ['forest_watchers', 'mountain_spirits'],
                services: ['gas', 'motel', 'campground'],
                danger: 4,
                economy: 0.9,
                weatherPattern: ['clear', 'fog', 'rain'],
                factions: { locals: 'strong', occultists: 'medium' }
            },
            los_angeles: {
                name: "Los Angeles, CA",
                mile: 2000,
                description: "The end of the road... or is it?",
                mysteries: ['final_mystery', 'city_ghosts'],
                services: ['all'],
                danger: 5,
                economy: 1.5,
                weatherPattern: ['clear', 'smog'],
                factions: { all: 'strong' }
            }
        };

        // Enhanced Supernatural Mysteries with Chains
        const mysteries = {
            vanishing_hitchhiker: {
                name: "The Vanishing Hitchhiker",
                description: "Travelers report picking up a hitchhiker who disappears from their car.",
                location: 'chicago',
                type: 'ghost',
                chain: ['hitchhiker_origin', 'hitchhiker_final'],
                cluesNeeded: 3,
                difficulty: 1,
                branchingSolutions: [
                    {
                        solution: "Lay the ghost to rest with a proper burial",
                        requirements: { occult: 2 },
                        rewards: { cash: 150, reputation: 20, item: 'peace_offering', faction: { occultists: 10 } }
                    },
                    {
                        solution: "Prove it's a mass hallucination",
                        requirements: { investigation: 2 },
                        rewards: { cash: 100, reputation: 15, item: 'debunking_evidence', faction: { media: 10 } }
                    },
                    {
                        solution: "Find the real person behind the legend",
                        requirements: { driving: 2 },
                        rewards: { cash: 120, reputation: 18, item: 'missing_person_file', faction: { police: 10 } }
                    }
                ],
                rewards: { cash: 100, reputation: 10, item: 'ghost_photo' }
            },
            
            ghostly_arch: {
                name: "The Ghostly Arch",
                description: "The St. Louis Arch appears to be haunted by construction workers.",
                location: 'st_louis',
                type: 'haunting',
                chain: ['arch_construction', 'arch_secrets'],
                cluesNeeded: 4,
                difficulty: 2,
                branchingSolutions: [
                    {
                        solution: "Expose the safety cover-up",
                        requirements: { investigation: 3 },
                        rewards: { cash: 200, reputation: 25, item: 'whistleblower_file', faction: { media: 15 } }
                    },
                    {
                        solution: "Perform a cleansing ritual",
                        requirements: { occult: 3 },
                        rewards: { cash: 180, reputation: 22, item: 'ritual_component', faction: { occultists: 15 } }
                    }
                ],
                rewards: { cash: 150, reputation: 15, item: 'construction_helmet' }
            },
            
            grave_robber: {
                name: "The Springfield Grave Robber",
                description: "Fresh graves are being dug up, but nothing is stolen.",
                location: 'springfield',
                type: 'mystery',
                chain: ['hospital_ghosts', 'doctor_secret'],
                cluesNeeded: 3,
                difficulty: 2,
                branchingSolutions: [
                    {
                        solution: "Confront the misguided doctor",
                        requirements: { investigation: 2 },
                        rewards: { cash: 180, reputation: 20, item: 'confession_tape', faction: { police: 10 } }
                    },
                    {
                        solution: "Help the doctor find peace",
                        requirements: { occult: 2 },
                        rewards: { cash: 160, reputation: 18, item: 'redeemed_soul', faction: { locals: 10 } }
                    }
                ],
                rewards: { cash: 200, reputation: 20, item: 'medical_journal' }
            },
            
            // Chain mysteries
            hitchhiker_origin: {
                name: "Hitchhiker's Origin",
                description: "Discover who the hitchhiker really was.",
                location: 'st_louis',
                type: 'ghost',
                requires: 'vanishing_hitchhiker',
                cluesNeeded: 2,
                difficulty: 2,
                rewards: { cash: 80, reputation: 8, item: 'identification' }
            },
            
            arch_construction: {
                name: "Arch Construction Secrets",
                description: "What really happened during construction?",
                location: 'st_louis',
                type: 'haunting',
                requires: 'ghostly_arch',
                cluesNeeded: 3,
                difficulty: 3,
                rewards: { cash: 120, reputation: 12, item: 'blueprint' }
            }
        };

        // Enhanced Items and Equipment
        const items = {
            // Starting items
            ritual_kit: {
                name: "Ritual Kit",
                type: "tool",
                description: "Salt, candles, and ancient symbols for protection.",
                effect: { type: "sanity_protection", value: 20 },
                durability: 100,
                rarity: "uncommon",
                equipSlot: "main",
                skillBonus: { occult: 1 }
            },
            
            camera: {
                name: "Camera",
                type: "tool",
                description: "35mm camera for evidence collection.",
                effect: { type: "evidence_quality", value: 30 },
                durability: 100,
                rarity: "common",
                equipSlot: "main",
                skillBonus: { investigation: 1 }
            },
            
            tool_kit: {
                name: "Tool Kit",
                type: "tool",
                description: "For car repairs and improvisation.",
                effect: { type: "repair_bonus", value: 25 },
                durability: 100,
                rarity: "common",
                equipSlot: "tool",
                skillBonus: { repair: 1 }
            },
            
            // Enhanced consumables
            gas_can: {
                name: "Gas Can",
                type: "consumable",
                description: "5 gallons of gasoline.",
                effect: { type: "refuel", value: 25 },
                durability: null,
                rarity: "common",
                price: 30
            },
            
            food_ration: {
                name: "Food Ration",
                type: "consumable",
                description: "Canned beans and crackers.",
                effect: { type: "sanity_restore", value: 10 },
                durability: null,
                rarity: "common",
                price: 10
            },
            
            first_aid: {
                name: "First Aid Kit",
                type: "consumable",
                description: "Bandages and antiseptic.",
                effect: { type: "sanity_restore", value: 20 },
                durability: 3,
                rarity: "uncommon",
                price: 25
            },
            
            // Evidence items with durability
            ghost_photo: {
                name: "Ghost Photograph",
                type: "evidence",
                description: "Foggy figure caught on film.",
                mystery: "vanishing_hitchhiker",
                durability: 1,
                rarity: "rare"
            },
            
            // Souvenirs
            chicago_souvenir: {
                name: "Chicago Snow Globe",
                type: "souvenir",
                description: "A souvenir from the Windy City.",
                effect: { type: "sanity_bonus", value: 5 },
                rarity: "common"
            },
            
            // Legendary items
            peace_offering: {
                name: "Peace Offering",
                type: "artifact",
                description: "An item that can calm restless spirits.",
                effect: { type: "encounter_reduction", value: 15 },
                durability: 5,
                rarity: "legendary",
                equipSlot: "tool"
            }
        };

        // Enhanced Car Upgrades with Levels
        const carUpgrades = {
            radio_upgrade: {
                name: "Enhanced Radio",
                description: "Picks up supernatural frequencies.",
                baseCost: 100,
                maxLevel: 3,
                currentLevel: 0,
                effects: [
                    { level: 1, effect: "Better signal strength" },
                    { level: 2, effect: "Scan supernatural frequencies" },
                    { level: 3, effect: "Communicate with spirits" }
                ],
                requirements: { mysteries: 0 }
            },
            
            extra_tank: {
                name: "Extra Gas Tank",
                description: "+50% gas capacity per level.",
                baseCost: 150,
                maxLevel: 2,
                currentLevel: 0,
                effects: [
                    { level: 1, effect: "+50% gas capacity" },
                    { level: 2, effect: "+100% gas capacity" }
                ],
                requirements: { cash: 100 }
            },
            
            reinforced_bumpers: {
                name: "Reinforced Bumpers",
                description: "Protection from night creatures.",
                baseCost: 200,
                maxLevel: 3,
                currentLevel: 0,
                effects: [
                    { level: 1, effect: "10% damage reduction" },
                    { level: 2, effect: "20% damage reduction" },
                    { level: 3, effect: "30% damage reduction" }
                ],
                requirements: { mysteries: 1 }
            }
        };

        // Enhanced Perks System
        const perks = {
            // Investigation perks
            keen_eye: {
                name: "Keen Eye",
                description: "+20% to clue discovery chance",
                cost: 1,
                type: "investigation",
                requirements: { investigation: 2 },
                effect: "clue_bonus"
            },
            
            quick_study: {
                name: "Quick Study",
                description: "Learn skills 25% faster",
                cost: 2,
                type: "investigation",
                requirements: { investigation: 3 },
                effect: "xp_bonus"
            },
            
            // Driving perks
            night_rider: {
                name: "Night Rider",
                description: "-30% sanity loss while driving at night",
                cost: 1,
                type: "driving",
                requirements: { driving: 2 },
                effect: "night_bonus"
            },
            
            fuel_efficient: {
                name: "Fuel Efficient",
                description: "-15% gas consumption",
                cost: 2,
                type: "driving",
                requirements: { driving: 3 },
                effect: "fuel_bonus"
            },
            
            // Occult perks
            spirit_whisperer: {
                name: "Spirit Whisperer",
                description: "Can understand ghostly whispers",
                cost: 1,
                type: "occult",
                requirements: { occult: 2 },
                effect: "spirit_communication"
            },
            
            protective_wards: {
                name: "Protective Wards",
                description: "+25% sanity protection",
                cost: 2,
                type: "occult",
                requirements: { occult: 3 },
                effect: "protection_bonus"
            },
            
            // Repair perks
            mechanic_touch: {
                name: "Mechanic's Touch",
                description: "Car repairs are 30% more effective",
                cost: 1,
                type: "repair",
                requirements: { repair: 2 },
                effect: "repair_bonus"
            },
            
            jury_rig: {
                name: "Jury Rig",
                description: "Can use any item for emergency repairs",
                cost: 2,
                type: "repair",
                requirements: { repair: 3 },
                effect: "emergency_repair"
            }
        };

        // Enhanced Encounters with Skill Checks
        const encounters = {
            hitchhiker: {
                name: "Hitchhiker",
                description: "A lone figure thumbs for a ride in the moonlight.",
                type: "supernatural",
                time: "night",
                weather: "any",
                choices: [
                    { 
                        text: "Pick them up", 
                        skillCheck: { skill: "occult", difficulty: 2 },
                        success: { sanity: -5, clue: "hitchhiker_info", item: "ride_gratitude" },
                        failure: { sanity: -20, gas: -10 },
                        chance: 0.7 
                    },
                    { 
                        text: "Stop and investigate", 
                        skillCheck: { skill: "investigation", difficulty: 1 },
                        success: { sanity: -10, clue: "local_lore", cash: 10 },
                        failure: { sanity: -15 },
                        chance: 0.5 
                    },
                    { 
                        text: "Drive past quickly", 
                        skillCheck: null,
                        effect: { sanity: -5, gas: -5 },
                        chance: 1.0 
                    }
                ],
                danger: 2
            },
            
            roadside_attraction: {
                name: "Roadside Attraction",
                description: "A bizarre tourist trap glowing in the dark.",
                type: "mystery",
                time: "any",
                weather: "any",
                choices: [
                    { 
                        text: "Investigate closely", 
                        skillCheck: { skill: "investigation", difficulty: 2 },
                        success: { sanity: -5, clue: "strange_artifact", cash: 20 },
                        failure: { sanity: -20, gas: -10 },
                        chance: 0.6 
                    },
                    { 
                        text: "Take photo evidence", 
                        skillCheck: { skill: "investigation", difficulty: 1 },
                        success: { sanity: -5, item: "attraction_photo", cash: 15 },
                        failure: { sanity: -10 },
                        chance: 0.8 
                    },
                    { 
                        text: "Ignore and move on", 
                        skillCheck: null,
                        effect: { sanity: 5 },
                        chance: 1.0 
                    }
                ],
                danger: 1
            },
            
            police_checkpoint: {
                name: "Police Checkpoint",
                description: "Flashing lights ahead. Officers wave you down.",
                type: "faction",
                time: "any",
                weather: "any",
                choices: [
                    { 
                        text: "Cooperate fully", 
                        skillCheck: null,
                        effect: { faction: { police: 5 }, time: 30 },
                        chance: 1.0 
                    },
                    { 
                        text: "Show your credentials", 
                        skillCheck: { skill: "investigation", difficulty: 1 },
                        success: { faction: { police: 10 }, item: "police_favor" },
                        failure: { faction: { police: -5 }, cash: -25 },
                        chance: 0.7 
                    },
                    { 
                        text: "Try to bribe", 
                        skillCheck: null,
                        effect: { faction: { police: -20 }, cash: -50, sanity: -10 },
                        chance: 0.3 
                    }
                ],
                danger: 1
            },
            
            time_slip: {
                name: "Time Slip",
                description: "The road suddenly looks decades older.",
                type: "supernatural",
                time: "night",
                weather: "fog",
                choices: [
                    { 
                        text: "Continue driving", 
                        skillCheck: { skill: "driving", difficulty: 3 },
                        success: { sanity: -20, clue: "temporal_anomaly", xp: 50 },
                        failure: { sanity: -40, gas: -30 },
                        chance: 0.8 
                    },
                    { 
                        text: "Stop and observe", 
                        skillCheck: { skill: "occult", difficulty: 2 },
                        success: { sanity: -15, clue: "time_echo" },
                        failure: { sanity: -30, time: 60 },
                        chance: 0.5 
                    },
                    { 
                        text: "Pull over and wait", 
                        skillCheck: null,
                        effect: { sanity: -20, gas: -10, time: 30 },
                        chance: 1.0 
                    }
                ],
                danger: 5
            }
        };

        // Enhanced Radio System
        const radioStations = {
            '88.5': {
                name: "Police Band",
                messages: {
                    normal: ["All units, be advised: missing persons report..."],
                    highDanger: ["10-78: Officer requesting backup at mile marker 156..."],
                    playerWanted: ["Be on lookout for suspicious vehicle matching your description..."],
                    playerFriendly: ["Civilian assistance appreciated in recent investigation..."]
                },
                unlockCondition: { faction: { police: 10 } }
            },
            
            '92.3': {
                name: "Weather Radio",
                messages: {
                    clear: ["Clear skies expected tonight..."],
                    rain: ["Flash flood warning in effect..."],
                    fog: ["Dense fog advisory until dawn..."],
                    supernatural: ["Unexplained atmospheric anomalies detected..."]
                },
                dynamic: true
            },
            
            '95.7': {
                name: "News Radio",
                messages: {
                    early: ["Another traveler reported missing on Route 66..."],
                    mid: ["Local authorities dismiss supernatural claims..."],
                    late: ["Breaking: Mass hysteria or real phenomena? Experts debate..."],
                    playerFamous: ["Mystery solver making headlines across Route 66..."]
                }
            },
            
            '98.1': {
                name: "Music Station",
                messages: {
                    night: ["Playing: 'Hotel California' by Eagles..."],
                    dawn: ["Sunrise soundtrack for all you night drivers..."],
                    stress: ["This next one goes out to anyone feeling the road's weight..."]
                }
            },
            
            'static': {
                name: "Static",
                messages: {
                    lowSanity: ["...they're watching you..."],
                    highOccult: ["...the veil is thin here..."],
                    mysteryNear: ["...can you hear them?..."],
                    generic: ["...help...us...", "...turn...back...", "...not...alone..."]
                }
            },
            
            'supernatural': {
                name: "Supernatural Frequency",
                messages: {
                    unlocked: ["...the old ones sleep but do not die...", "...salt and iron hold them back..."],
                    special: ["...your journey is being observed...", "...the road remembers..."]
                },
                unlockCondition: { occult: 3 }
            }
        };

        // Seasonal Events
        const seasonalEvents = {
            halloween: {
                name: "Halloween Special",
                active: false,
                startDate: [10, 25],
                endDate: [11, 2],
                effects: {
                    encounterRate: 1.5,
                    supernaturalEncounters: 2.0,
                    rewards: 1.3
                },
                specialEncounters: ['pumpkin_head', 'trick_or_treaters'],
                rewards: ['candy', 'costume']
            },
            
            christmas: {
                name: "Christmas Special",
                active: false,
                startDate: [12, 20],
                endDate: [12, 27],
                effects: {
                    sanityGain: 1.2,
                    factionRep: 1.5,
                    prices: 0.8
                },
                specialEncounters: ['ghost_of_christmas', 'helpful_stranger'],
                rewards: ['present', 'cookie']
            }
        };

        // Faction Events
        const factionEvents = {
            police: {
                name: "Police Assistance",
                description: "The local police need help with a case.",
                trigger: { faction: { police: 25 } },
                rewards: { cash: 100, item: 'police_badge', faction: { police: 10 } },
                requirements: { investigation: 2 }
            },
            
            occultists: {
                name: "Occult Gathering",
                description: "Local occultists invite you to a ritual.",
                trigger: { faction: { occultists: 30 } },
                rewards: { sanity: 30, item: 'ritual_knowledge', faction: { occultists: 15 } },
                requirements: { occult: 3 }
            },
            
            media: {
                name: "Media Interview",
                description: "A reporter wants to interview you about your investigations.",
                trigger: { faction: { media: 20 } },
                rewards: { cash: 150, reputation: 20, faction: { media: 10 } },
                requirements: { mysteries: 3 }
            },
            
            locals: {
                name: "Town Celebration",
                description: "The locals throw a party in your honor.",
                trigger: { faction: { locals: 40 } },
                rewards: { sanity: 40, item: 'local_gift', faction: { locals: 20 } },
                requirements: { driving: 2 }
            }
        };

        // Achievements
        const achievements = {
            first_mystery: {
                name: "First Case",
                description: "Solve your first mystery",
                reward: { perkPoints: 1 },
                icon: "ðŸ”"
            },
            
            road_warrior: {
                name: "Road Warrior",
                description: "Drive 1000 miles",
                reward: { cash: 200, item: 'road_warrior_badge' },
                icon: "ðŸš—"
            },
            
            ghost_hunter: {
                name: "Ghost Hunter",
                description: "Solve 5 supernatural mysteries",
                reward: { perkPoints: 2, item: 'ghost_hunter_license' },
                icon: "ðŸ‘»"
            },
            
            faction_friend: {
                name: "Faction Friend",
                description: "Reach 50 reputation with any faction",
                reward: { reputation: 25, cash: 100 },
                icon: "ðŸ¤"
            },
            
            master_investigator: {
                name: "Master Investigator",
                description: "Reach level 5 in Investigation skill",
                reward: { perkPoints: 1, item: 'master_investigator_kit' },
                icon: "ðŸ•µï¸"
            },
            
            survivalist: {
                name: "Survivalist",
                description: "Survive 10 dangerous encounters",
                reward: { sanity: 50, item: 'survival_manual' },
                icon: "ðŸ›¡ï¸"
            },
            
            collector: {
                name: "Collector",
                description: "Collect 10 souvenirs",
                reward: { cash: 300, item: 'collector_shelf' },
                icon: "ðŸ†"
            },
            
            rich_traveler: {
                name: "Rich Traveler",
                description: "Accumulate $1000",
                reward: { cash: 200, reputation: 30 },
                icon: "ðŸ’°"
            },
            
            night_crawler: {
                name: "Night Crawler",
                description: "Drive 500 miles at night",
                reward: { perkPoints: 1, item: 'night_vision_goggles' },
                icon: "ðŸŒ™"
            },
            
            mechanic: {
                name: "Mechanic",
                description: "Repair your car 20 times",
                reward: { repair: 50, item: 'master_toolkit' },
                icon: "ðŸ”§"
            }
        };

        // Enhanced Environmental Vignettes
        const vignettes = [
            {
                text: "An abandoned car sits by the roadside, doors open as if the occupants fled in a hurry.",
                effect: { sanity: -5 },
                chance: 0.3,
                time: "night"
            },
            {
                text: "You pass a roadside memorial with fresh flowers. The date of death is yesterday.",
                effect: { sanity: -8, clue: "recent_death" },
                chance: 0.2,
                time: "any"
            },
            {
                text: "A diner sign flickers 'Open 25 Hours' before correcting itself.",
                effect: { sanity: -3 },
                chance: 0.4,
                time: "dusk"
            },
            {
                text: "Children's laughter echoes from an empty playground.",
                effect: { sanity: -10 },
                chance: 0.1,
                time: "night"
            },
            {
                text: "You find a wallet with $20 and an ID from someone reported missing last week.",
                effect: { cash: 20, sanity: -15, clue: "missing_person" },
                chance: 0.15,
                time: "any"
            },
            {
                text: "A hitchhiker's sign reads 'Anywhere but here' on one side, 'Back to the beginning' on the other.",
                effect: { sanity: -7 },
                chance: 0.25,
                time: "day"
            }
        ];

        // Screen references
        const screens = {
            start: document.getElementById('start-screen'),
            class: document.getElementById('class-screen'),
            game: document.getElementById('game-screen'),
            drive: document.getElementById('drive-screen'),
            investigate: document.getElementById('investigate-screen'),
            inventory: document.getElementById('inventory-screen'),
            radio: document.getElementById('radio-screen'),
            upgrades: document.getElementById('upgrades-screen'),
            perks: document.getElementById('perks-screen'),
            map: document.getElementById('map-screen'),
            rest: document.getElementById('rest-screen'),
            solved: document.getElementById('solved-screen'),
            defeat: document.getElementById('defeat-screen')
        };

        // ================================================
        // ENHANCED INITIALIZATION
        // ================================================

        function initGame() {
            console.log("Initializing Highway Hauntings - Enhanced Edition...");
            
            // Initialize audio system
            audioSystem.init();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize game log
            addToGameLog("The engine hums as you pull onto Route 66. The road stretches into darkness...");
            addToGameLog("RADIO: \"...strange lights reported near mile marker 42...\"", true);
            
            // Start road animation
            startRoadAnimation();
            
            // Check for low resources
            setInterval(checkResources, 1000);
            
            // Update time every minute
            setInterval(updateGameTime, 10000); // 10 seconds real time = 1 minute game time
            
            // Check for achievements
            setInterval(checkAchievements, 30000);
            
            // Initialize random car name
            generateCarName();
            
            // Check for seasonal events
            checkSeasonalEvents();
            
            console.log("Game initialized successfully!");
        }

        function setupEventListeners() {
            // Start screen
            document.getElementById('start-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('class');
            });
            
            document.getElementById('load-button').addEventListener('click', () => {
                audioSystem.playClick();
                loadGame();
            });
            
            document.getElementById('new-game-plus').addEventListener('click', startNewGamePlus);
            
            // FIXED: Added missing event listener for back button
            document.getElementById('back-to-start').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('start');
            });
            
            // FIXED: Enhanced class selection with better event handling
            document.querySelectorAll('.class-option').forEach(option => {
                option.addEventListener('click', function() {
                    const className = this.getAttribute('data-class');
                    audioSystem.playClick();
                    selectClass(className);
                });
            });
            
            // Game screen buttons
            document.getElementById('drive-button').addEventListener('click', startDrive);
            document.getElementById('investigate-button').addEventListener('click', startInvestigation);
            document.getElementById('danger-investigate').addEventListener('click', startDangerousInvestigation);
            document.getElementById('inventory-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('inventory');
                updateInventoryScreen();
            });
            document.getElementById('radio-button').addEventListener('click', () => {
                audioSystem.playRadio();
                showScreen('radio');
                updateRadioScreen();
            });
            document.getElementById('upgrades-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('upgrades');
                updateUpgradesScreen();
            });
            document.getElementById('perks-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('perks');
                updatePerksScreen();
            });
            document.getElementById('map-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('map');
                updateMapScreen();
            });
            document.getElementById('rest-button').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('rest');
                updateRestScreen();
            });
            document.getElementById('save-button').addEventListener('click', () => {
                audioSystem.playClick();
                saveGame();
                addToGameLog("Progress saved at the last roadside phone.");
                showQuickSaveNotification();
            });
            document.getElementById('find-mystery-btn').addEventListener('click', purchaseMystery);
            
            // Speed options
            document.querySelectorAll('.speed-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.speed-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.drivingSpeed = this.dataset.speed;
                    updateSpeedDisplay();
                });
            });
            
            // Drive screen
            document.getElementById('continue-drive').addEventListener('click', continueDrive);
            document.getElementById('stop-car').addEventListener('click', stopCar);
            document.getElementById('check-radio').addEventListener('click', checkRadio);
            document.getElementById('return-to-map').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            document.getElementById('push-luck-drive').addEventListener('click', pushLuckDrive);
            
            // Investigation screen
            document.getElementById('back-from-investigate').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            document.getElementById('solve-button').addEventListener('click', solveMystery);
            
            // Equipment slots
            document.querySelectorAll('.equipment-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    openEquipmentSelection(this.dataset.slot);
                });
                
                // Drag and drop
                slot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                slot.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                slot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const itemId = e.dataTransfer.getData('text/plain');
                    if (itemId) {
                        equipItem(itemId, this.dataset.slot);
                    }
                });
            });
            
            // Inventory screen
            document.getElementById('back-from-inventory').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            
            // Radio screen
            document.querySelectorAll('[data-freq]').forEach(button => {
                button.addEventListener('click', function() {
                    audioSystem.playRadio();
                    tuneRadio(this.dataset.freq);
                });
            });
            document.getElementById('back-from-radio').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            
            // Upgrades screen
            document.getElementById('back-from-upgrades').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            
            // Negotiation options
            document.querySelectorAll('.negotiation-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.negotiation-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.economy.priceFluctuation = parseFloat(this.dataset.mod);
                    updateUpgradesScreen();
                });
            });
            
            // Perks screen
            document.getElementById('back-from-perks').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            
            // Map screen
            document.getElementById('back-from-map').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            document.getElementById('plan-route').addEventListener('click', planRoute);
            
            // Rest screen
            document.getElementById('rest-cheap').addEventListener('click', () => restCheap());
            document.getElementById('rest-room').addEventListener('click', () => restRoom());
            document.getElementById('rest-food').addEventListener('click', () => buyFood());
            document.getElementById('rest-gas').addEventListener('click', () => buyGas());
            document.getElementById('rest-find-mystery').addEventListener('click', findMystery);
            document.getElementById('rest-betting').addEventListener('click', startBettingGame);
            document.getElementById('rest-leave').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('game');
            });
            
            // Betting game
            document.querySelectorAll('.bet-option').forEach(option => {
                option.addEventListener('click', function() {
                    placeBet(parseInt(this.dataset.bet));
                });
            });
            document.getElementById('leave-betting').addEventListener('click', () => {
                document.getElementById('betting-game').style.display = 'none';
            });
            
            // Solved screen
            document.getElementById('continue-after-solve').addEventListener('click', () => {
                audioSystem.playClick();
                continueAfterSolve();
            });
            
            // Defeat screen
            document.getElementById('continue-from-defeat').addEventListener('click', () => {
                audioSystem.playClick();
                continueFromDefeat();
            });
            document.getElementById('return-to-menu-from-defeat').addEventListener('click', () => {
                audioSystem.playClick();
                showScreen('start');
            });
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const content = document.getElementById(`${tabName}-tab`);
                    if (content) {
                        content.classList.add('active');
                    }
                    
                    if (tabName === 'items') updateInventoryDisplay();
                    if (tabName === 'evidence') updateEvidenceDisplay();
                    if (tabName === 'tools') updateToolsDisplay();
                    if (tabName === 'notes') updateNotesDisplay();
                    if (tabName === 'photos') updatePhotoAlbum();
                    if (tabName === 'souvenirs') updateSouvenirsDisplay();
                });
            });
            
            // Audio controls
            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            document.getElementById('sfx-toggle').addEventListener('click', toggleSFX);
            
            // Accessibility
            document.getElementById('font-size-btn').addEventListener('click', cycleFontSize);
            document.getElementById('tutorial-btn').addEventListener('click', showTutorial);
            document.getElementById('high-contrast').addEventListener('click', toggleHighContrast);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Make functions globally available
            window.buyUpgrade = buyUpgrade;
            window.buyPerk = buyPerk;
        }

        // ================================================
        // ENHANCED PLAYER & CLASS SYSTEM
        // ================================================

        function selectClass(className) {
            console.log("Selecting class:", className);
            
            if (!classes[className]) {
                console.error("Invalid class:", className);
                return;
            }
            
            gameState.player.class = className;
            const classData = classes[className];
            
            gameState.player.gas = classData.gas;
            gameState.player.maxGas = 100;
            gameState.player.sanity = classData.sanity;
            gameState.player.maxSanity = 100;
            gameState.player.cash = classData.cash;
            
            // Add starting items
            classData.startingItems.forEach(itemId => {
                gameState.player.inventory.push(itemId);
            });
            
            classData.startingTools.forEach(toolId => {
                gameState.player.tools.push(toolId);
            });
            
            // Apply skill bonuses
            Object.entries(classData.skillBonuses).forEach(([skill, bonus]) => {
                gameState.player.skills[skill].level += bonus;
            });
            
            // Apply faction starting rep
            Object.entries(classData.factionStart).forEach(([faction, rep]) => {
                gameState.player.factions[faction].rep = rep;
            });
            
            // Set perk tree
            gameState.player.perkTree = classData.perkTree;
            
            // Add some supplies
            gameState.player.inventory.push('gas_can');
            for (let i = 0; i < 3; i++) {
                gameState.player.inventory.push('food_ration');
            }
            gameState.player.inventory.push('first_aid');
            
            // Start with first mystery
            gameState.player.activeMysteries.push('vanishing_hitchhiker');
            gameState.player.cluesNeeded = mysteries['vanishing_hitchhiker'].cluesNeeded;
            
            updateGameScreen();
            showScreen('game');
            
            addToGameLog(`You take the wheel as ${classData.name}.`);
            addToGameLog(classData.description);
            addToGameLog("Active mystery: The Vanishing Hitchhiker");
            addToGameLog("The radio crackles to life as you head west...", true);
            
            // Unlock first achievement
            unlockAchievement('first_mystery');
        }

        // ================================================
        // ENHANCED DRIVING SYSTEM WITH PROGRESSIVE DIFFICULTY
        // ================================================

        function startDrive() {
            gameState.driveDistance = 0;
            gameState.nextTownDistance = calculateNextTownDistance();
            updateDriveScreen();
            showScreen('drive');
            
            // Show environmental vignette
            showEnvironmentalVignette();
            
            addToDriveLog("Headlights cut through the darkness. The radio crackles...");
            
            // Update risk/reward based on speed and conditions
            updateRiskReward();
        }

        function continueDrive() {
            if (gameState.player.gas <= 0) {
                addToDriveLog("You're out of gas!");
                showDefeat("ran out of gas in the middle of nowhere.");
                return;
            }
            
            // Calculate distance based on speed
            let distanceTraveled = 10 + Math.floor(Math.random() * 20);
            let gasUsed = 5 + Math.floor(Math.random() * 10);
            
            // Apply speed modifiers
            switch(gameState.drivingSpeed) {
                case 'safe':
                    distanceTraveled = Math.floor(distanceTraveled * 0.8);
                    gasUsed = Math.floor(gasUsed * 0.9);
                    break;
                case 'fast':
                    distanceTraveled = Math.floor(distanceTraveled * 1.5);
                    gasUsed = Math.floor(gasUsed * 1.4);
                    // Higher chance of encounters
                    gameState.difficulty.encounterRate *= 1.5;
                    break;
            }
            
            // Apply driving skill bonus
            const drivingBonus = gameState.player.skills.driving.level * 0.05;
            distanceTraveled = Math.floor(distanceTraveled * (1 + drivingBonus));
            gasUsed = Math.floor(gasUsed * (1 - drivingBonus * 0.5));
            
            // Consume gas
            gameState.player.gas = Math.max(0, gameState.player.gas - gasUsed);
            
            // Progress distance
            gameState.driveDistance += distanceTraveled;
            gameState.player.mile += distanceTraveled;
            gameState.player.totalMiles += distanceTraveled;
            
            // Update time
            advanceTime(distanceTraveled * 2); // 2 minutes per mile
            
            // Degrade car maintenance
            degradeCarMaintenance(distanceTraveled);
            
            // Check for encounters with progressive difficulty
            const encounterChance = gameState.difficulty.encounterRate * 
                                   (gameState.drivingSpeed === 'fast' ? 1.5 : 1) *
                                   (gameState.time.dayPhase === 'night' ? 1.3 : 1);
            
            if (Math.random() < encounterChance) {
                triggerEncounter();
            } else {
                addToDriveLog(`You drive ${distanceTraveled} miles through the night.`);
                
                // Small chance for environmental vignette
                if (Math.random() < 0.2) {
                    showEnvironmentalVignette();
                }
            }
            
            // Update difficulty based on distance
            updateProgressiveDifficulty();
            
            // Small sanity drain affected by time and weather
            let sanityDrain = 2;
            if (gameState.time.dayPhase === 'night') sanityDrain += 1;
            if (gameState.weather.current !== 'clear') sanityDrain += 1;
            
            gameState.player.sanity = Math.max(0, gameState.player.sanity - sanityDrain);
            
            // Check if reached town
            if (gameState.driveDistance >= gameState.nextTownDistance) {
                reachTown();
                return;
            }
            
            updateDriveScreen();
        }

        function pushLuckDrive() {
            if (gameState.player.gas < 30) {
                addToDriveLog("Not enough gas to push your luck!");
                return;
            }
            
            // Double distance but high risk
            let distanceTraveled = 20 + Math.floor(Math.random() * 40);
            let gasUsed = 15 + Math.floor(Math.random() * 20);
            
            // Apply driving skill for risk reduction
            const drivingSkill = gameState.player.skills.driving.level;
            const riskReduction = drivingSkill * 0.1;
            gasUsed = Math.floor(gasUsed * (1 - riskReduction));
            
            gameState.player.gas = Math.max(0, gameState.player.gas - gasUsed);
            gameState.driveDistance += distanceTraveled;
            gameState.player.mile += distanceTraveled;
            gameState.player.totalMiles += distanceTraveled;
            
            // Very high encounter chance
            if (Math.random() < 0.8) {
                triggerEncounter();
            } else {
                addToDriveLog(`You push hard and cover ${distanceTraveled} miles quickly!`);
                showFloatingText("Pushed Luck!", "clue", document.getElementById('push-luck-drive'));
            }
            
            // High sanity drain
            gameState.player.sanity = Math.max(0, gameState.player.sanity - 10);
            
            updateDriveScreen();
        }

        function triggerEncounter() {
            // Weight encounters by time, weather, and location
            const weightedEncounters = getWeightedEncounters();
            if (weightedEncounters.length === 0) return;
            
            const randomEncounter = weightedEncounters[Math.floor(Math.random() * weightedEncounters.length)];
            gameState.currentEncounter = encounters[randomEncounter];
            
            if (!gameState.currentEncounter) return;
            
            // Show encounter
            document.getElementById('encounter-display').style.display = 'none';
            document.getElementById('encounter-actions').style.display = 'block';
            document.getElementById('drive-actions').style.display = 'none';
            
            document.getElementById('encounter-description').innerHTML = `
                <div class="log-entry"><strong>${gameState.currentEncounter.name}</strong></div>
                <div class="log-entry">${gameState.currentEncounter.description}</div>
            `;
            
            // Show skill check if applicable
            const skillCheckDisplay = document.getElementById('skill-check-display');
            if (gameState.currentEncounter.choices[0]?.skillCheck) {
                const skillCheck = gameState.currentEncounter.choices[0].skillCheck;
                const playerSkill = gameState.player.skills[skillCheck.skill].level;
                const successChance = Math.min(0.9, 0.5 + (playerSkill - skillCheck.difficulty) * 0.2);
                
                document.getElementById('required-skill').textContent = skillCheck.skill;
                document.getElementById('player-skill-level').textContent = playerSkill;
                document.getElementById('required-skill-level').textContent = skillCheck.difficulty;
                document.getElementById('skill-check-bar').style.width = `${successChance * 100}%`;
                skillCheckDisplay.style.display = 'block';
            } else {
                skillCheckDisplay.style.display = 'none';
            }
            
            // Create choices
            const choicesContainer = document.getElementById('encounter-choices');
            choicesContainer.innerHTML = '';
            
            gameState.currentEncounter.choices.forEach((choice, index) => {
                const choiceButton = document.createElement('div');
                choiceButton.className = 'button';
                choiceButton.textContent = choice.text;
                choiceButton.addEventListener('click', () => handleEncounterChoice(index));
                choicesContainer.appendChild(choiceButton);
            });
        }

        function getWeightedEncounters() {
            const weighted = [];
            
            Object.keys(encounters).forEach(encounterId => {
                const encounter = encounters[encounterId];
                let weight = 1;
                
                // Time weighting
                if (encounter.time !== 'any' && encounter.time !== gameState.time.dayPhase) {
                    weight *= 0.3;
                }
                
                // Weather weighting
                if (encounter.weather !== 'any' && encounter.weather !== gameState.weather.current) {
                    weight *= 0.5;
                }
                
                // Add multiple times based on weight
                for (let i = 0; i < weight * 10; i++) {
                    weighted.push(encounterId);
                }
            });
            
            return weighted;
        }

        function handleEncounterChoice(choiceIndex) {
            const choice = gameState.currentEncounter.choices[choiceIndex];
            
            if (!choice) return;
            
            // Check skill check if applicable
            let success = true;
            if (choice.skillCheck) {
                const playerSkill = gameState.player.skills[choice.skillCheck.skill].level;
                success = Math.random() < (0.5 + (playerSkill - choice.skillCheck.difficulty) * 0.2);
                
                // Gain XP for skill
                gainSkillXP(choice.skillCheck.skill, 10);
            }
            
            // Apply effects
            if (success && choice.success) {
                addToDriveLog(`Success! ${choice.text}`);
                applyEffects(choice.success);
                if (choice.success.clue) {
                    addClue(choice.success.clue);
                    showFloatingText("+1 Clue", "clue", event.target);
                }
            } else if (!success && choice.failure) {
                addToDriveLog(`Failed: ${choice.text}`);
                applyEffects(choice.failure);
            } else if (choice.effect) {
                addToDriveLog(`${choice.text}`);
                applyEffects(choice.effect);
            }
            
            // Reset encounter UI
            document.getElementById('encounter-display').style.display = 'block';
            document.getElementById('encounter-actions').style.display = 'none';
            document.getElementById('drive-actions').style.display = 'block';
            
            // Small time passage
            gameState.player.gas = Math.max(0, gameState.player.gas - 5);
            gameState.driveDistance += 5;
            
            updateDriveScreen();
        }

        function applyEffects(effects) {
            if (!effects) return;
            
            if (effects.sanity !== undefined) gameState.player.sanity += effects.sanity;
            if (effects.gas !== undefined) gameState.player.gas += effects.gas;
            if (effects.cash !== undefined) gameState.player.cash += effects.cash;
            if (effects.item) gameState.player.inventory.push(effects.item);
            if (effects.xp) gainXP(effects.xp);
            if (effects.clue) addClue(effects.clue);
            if (effects.faction) {
                Object.entries(effects.faction).forEach(([faction, rep]) => {
                    gameState.player.factions[faction].rep += rep;
                });
            }
            if (effects.time) advanceTime(effects.time);
        }

        function showEnvironmentalVignette() {
            const availableVignettes = vignettes.filter(v => 
                v.time === 'any' || v.time === gameState.time.dayPhase
            );
            
            if (availableVignettes.length > 0 && Math.random() < 0.3) {
                const vignette = availableVignettes[Math.floor(Math.random() * availableVignettes.length)];
                addToDriveLog(vignette.text);
                
                if (vignette.effect) {
                    applyEffects(vignette.effect);
                }
            }
        }

        // ================================================
        // ENHANCED INVESTIGATION SYSTEM
        // ================================================

        function startInvestigation() {
            if (gameState.player.activeMysteries.length === 0) {
                addToGameLog("No active mysteries to investigate.");
                addToGameLog("Try driving to a new town or purchasing information.");
                updateFindMysteryButton();
                return;
            }
            
            updateInvestigationScreen();
            showScreen('investigate');
        }

        function startDangerousInvestigation() {
            if (gameState.player.sanity < 30) {
                addToGameLog("You're too shaken to investigate dangerous sites.");
                return;
            }
            
            gameState.player.sanity -= 30;
            addToGameLog("You venture into a known dangerous location...");
            
            // High chance for clue, but also high chance for encounter
            if (Math.random() < 0.8) {
                gameState.player.cluesFound++;
                addToGameLog(`Found an important clue! (${gameState.player.cluesFound}/${gameState.player.cluesNeeded})`);
                showFloatingText("Dangerous Clue!", "clue", event.target);
                
                // Chance for rare item
                if (Math.random() < 0.3) {
                    const rareItems = ['ancient_artifact', 'cursed_object', 'forbidden_text'];
                    const rareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                    gameState.player.inventory.push(rareItem);
                    addToGameLog("Found a rare artifact!");
                }
            }
            
            // High chance for dangerous encounter
            if (Math.random() < 0.7) {
                gameState.player.sanity -= 20;
                addToGameLog("Something in the shadows attacks you!");
            }
            
            updateGameScreen();
        }

        function investigateAction(action) {
            const actionData = {
                'interview': { 
                    skill: 'investigation', 
                    difficulty: 1,
                    success: { sanity: -10, clueChance: 0.7, xp: 15 },
                    failure: { sanity: -15 }
                },
                'search': { 
                    skill: 'investigation', 
                    difficulty: 2,
                    success: { sanity: -5, clueChance: 0.6, xp: 10 },
                    failure: { sanity: -10 }
                },
                'research': { 
                    skill: 'investigation', 
                    difficulty: 3,
                    success: { sanity: -8, clueChance: 0.8, xp: 20 },
                    failure: { sanity: -12 }
                },
                'stakeout': { 
                    skill: 'driving', 
                    difficulty: 2,
                    success: { sanity: -15, clueChance: 0.9, xp: 25 },
                    failure: { sanity: -25, gas: -10 }
                }
            };
            
            const chosenAction = actionData[action];
            if (!chosenAction) return;
            
            // Check skill
            const playerSkill = gameState.player.skills[chosenAction.skill].level;
            const success = Math.random() < (0.5 + (playerSkill - chosenAction.difficulty) * 0.2);
            
            // Apply sanity cost
            gameState.player.sanity = Math.max(0, gameState.player.sanity + 
                (success ? chosenAction.success.sanity : chosenAction.failure.sanity));
            
            // Add to log
            addToGameLog(`${success ? 'Successful' : 'Failed'} ${action} action.`);
            
            if (success) {
                // Gain XP
                gainSkillXP(chosenAction.skill, chosenAction.success.xp);
                
                // Chance to find clue
                if (Math.random() < chosenAction.success.clueChance) {
                    gameState.player.cluesFound++;
                    addToGameLog(`Found a clue! (${gameState.player.cluesFound}/${gameState.player.cluesNeeded})`);
                    showFloatingText("+1 Clue", "clue", event.target);
                    
                    // Add evidence based on mystery type
                    addEvidenceForMystery();
                }
            }
            
            // Small chance of encounter during investigation
            if (Math.random() < 0.3) {
                gameState.player.sanity -= 10;
                addToGameLog("Something watches you from the shadows...");
            }
            
            updateInvestigationScreen();
            updateGameScreen();
            
            // Check if enough clues to solve
            if (gameState.player.cluesFound >= gameState.player.cluesNeeded) {
                document.getElementById('solve-button').classList.remove('disabled');
                document.getElementById('solve-button').style.backgroundColor = '#8b0000';
                addToGameLog("You have enough clues to solve the mystery!");
            }
        }

        function addEvidenceForMystery() {
            if (gameState.player.activeMysteries.length === 0) return;
            
            const mysteryId = gameState.player.activeMysteries[0];
            const mystery = mysteries[mysteryId];
            
            if (!mystery) return;
            
            // Add appropriate evidence based on mystery type
            let evidence;
            switch(mystery.type) {
                case 'ghost':
                    evidence = 'ectoplasm_sample';
                    break;
                case 'haunting':
                    evidence = 'cold_spot_reading';
                    break;
                case 'mystery':
                    evidence = 'suspicious_note';
                    break;
                default:
                    evidence = 'unexplained_phenomena';
            }
            
            gameState.player.evidence.push(evidence);
            addToGameLog(`Collected evidence: ${evidence.replace('_', ' ')}`);
        }

        function solveMystery() {
            const mysteryId = gameState.player.activeMysteries[0];
            if (!mysteryId) {
                addToGameLog("No mystery to solve!");
                return;
            }
            
            if (gameState.player.cluesFound < gameState.player.cluesNeeded) {
                addToGameLog(`Need ${gameState.player.cluesNeeded - gameState.player.cluesFound} more clues!`);
                return;
            }
            
            const mystery = mysteries[mysteryId];
            
            // Show branching solutions if available
            if (mystery.branchingSolutions) {
                showBranchingSolutions(mystery);
                return;
            }
            
            completeMystery(mystery);
        }

        function showBranchingSolutions(mystery) {
            document.getElementById('solution-text').textContent = "Choose how to resolve the mystery:";
            
            const outcomeContainer = document.getElementById('outcome-choices');
            outcomeContainer.innerHTML = '';
            
            mystery.branchingSolutions.forEach((solution, index) => {
                // Check requirements
                const meetsRequirements = Object.entries(solution.requirements).every(
                    ([skill, level]) => gameState.player.skills[skill].level >= level
                );
                
                const solutionButton = document.createElement('div');
                solutionButton.className = `button ${meetsRequirements ? '' : 'disabled'}`;
                solutionButton.innerHTML = `
                    <strong>${solution.solution}</strong><br>
                    <small>Requires: ${Object.entries(solution.requirements).map(([s, l]) => `${s} ${l}`).join(', ')}</small>
                `;
                
                if (meetsRequirements) {
                    solutionButton.addEventListener('click', () => chooseSolution(mystery, index));
                }
                
                outcomeContainer.appendChild(solutionButton);
            });
            
            document.getElementById('branching-outcome').style.display = 'block';
        }

        function chooseSolution(mystery, solutionIndex) {
            const solution = mystery.branchingSolutions[solutionIndex];
            
            document.getElementById('solution-text').textContent = solution.solution;
            
            // Calculate rewards
            const rewardContainer = document.getElementById('reward-items');
            rewardContainer.innerHTML = '';
            
            let totalCash = solution.rewards.cash || 0;
            let totalRep = solution.rewards.reputation || 0;
            
            // Bonus for extra clues
            const extraClues = gameState.player.cluesFound - mystery.cluesNeeded;
            if (extraClues > 0) {
                totalCash += extraClues * 25;
                totalRep += extraClues * 5;
                rewardContainer.innerHTML += `<div class="log-entry">Bonus for ${extraClues} extra clues: +$${extraClues * 25}, +${extraClues * 5} rep</div>`;
            }
            
            // Apply rewards
            gameState.player.cash += totalCash;
            gameState.player.reputation += totalRep;
            
            if (solution.rewards.item) {
                gameState.player.inventory.push(solution.rewards.item);
                rewardContainer.innerHTML += `<div class="log-entry">Item: ${items[solution.rewards.item]?.name || solution.rewards.item}</div>`;
            }
            
            if (solution.rewards.faction) {
                Object.entries(solution.rewards.faction).forEach(([faction, rep]) => {
                    gameState.player.factions[faction].rep += rep;
                    rewardContainer.innerHTML += `<div class="log-entry">${faction}: +${rep} reputation</div>`;
                });
            }
            
            rewardContainer.innerHTML += `<div class="log-entry">Cash: +$${totalCash}</div>`;
            rewardContainer.innerHTML += `<div class="log-entry">Reputation: +${totalRep}</div>`;
            
            // Gain XP
            gainXP(totalRep * 10);
            
            // Clear mystery
            completeMysteryProcess(mystery);
            
            showScreen('solved');
            audioSystem.playSuccess();
        }

        function completeMystery(mystery) {
            document.getElementById('solution-text').textContent = mystery.rewards.solution || "The mystery has been solved!";
            
            // Calculate rewards
            const rewardContainer = document.getElementById('reward-items');
            rewardContainer.innerHTML = '';
            
            let totalCash = mystery.rewards.cash || 0;
            let totalRep = mystery.rewards.reputation || 0;
            
            // Bonus for extra clues
            const extraClues = gameState.player.cluesFound - mystery.cluesNeeded;
            if (extraClues > 0) {
                totalCash += extraClues * 25;
                totalRep += extraClues * 5;
                rewardContainer.innerHTML += `<div class="log-entry">Bonus for ${extraClues} extra clues: +$${extraClues * 25}, +${extraClues * 5} rep</div>`;
            }
            
            // Apply rewards
            gameState.player.cash += totalCash;
            gameState.player.reputation += totalRep;
            
            if (mystery.rewards.item) {
                gameState.player.inventory.push(mystery.rewards.item);
                rewardContainer.innerHTML += `<div class="log-entry">Item: ${items[mystery.rewards.item]?.name || mystery.rewards.item}</div>`;
            }
            
            rewardContainer.innerHTML += `<div class="log-entry">Cash: +$${totalCash}</div>`;
            rewardContainer.innerHTML += `<div class="log-entry">Reputation: +${totalRep}</div>`;
            
            // Gain XP
            gainXP(totalRep * 10);
            
            // Clear mystery
            completeMysteryProcess(mystery);
            
            showScreen('solved');
            audioSystem.playSuccess();
        }

        function completeMysteryProcess(mystery) {
            gameState.player.mysteriesSolved++;
            
            // Remove from active mysteries
            const mysteryIndex = gameState.player.activeMysteries.indexOf(mystery.name);
            if (mysteryIndex > -1) {
                gameState.player.activeMysteries.splice(mysteryIndex, 1);
            }
            
            // Check for chain mysteries
            if (mystery.chain) {
                mystery.chain.forEach(chainMysteryId => {
                    if (!gameState.player.activeMysteries.includes(chainMysteryId)) {
                        gameState.player.activeMysteries.push(chainMysteryId);
                        addToGameLog(`New mystery discovered: ${mysteries[chainMysteryId]?.name || chainMysteryId}`);
                    }
                });
            }
            
            gameState.player.cluesFound = 0;
            gameState.player.evidence = []; // Clear evidence after solving
            
            // Add to case files
            if (!gameState.player.caseFiles[mystery.name]) {
                gameState.player.caseFiles[mystery.name] = {
                    solved: true,
                    date: gameState.player.day,
                    rewards: { cash: gameState.player.cash, reputation: gameState.player.reputation }
                };
            }
        }

        function continueAfterSolve() {
            // Chance to get a new mystery after solving one
            if (Math.random() < 0.7 && gameState.player.activeMysteries.length < 3) {
                const availableMysteries = Object.keys(mysteries).filter(m => 
                    mysteries[m].difficulty <= gameState.player.mysteriesSolved + 1 &&
                    !gameState.player.activeMysteries.includes(m)
                );
                
                if (availableMysteries.length > 0) {
                    const mysteryId = availableMysteries[Math.floor(Math.random() * availableMysteries.length)];
                    gameState.player.activeMysteries.push(mysteryId);
                    gameState.player.cluesFound = 0;
                    gameState.player.cluesNeeded = mysteries[mysteryId].cluesNeeded;
                    addToGameLog(`New mystery discovered: ${mysteries[mysteryId].name}`);
                }
            }
            
            showScreen('game');
            updateGameScreen();
        }

        // ================================================
        // ENHANCED INVENTORY & EQUIPMENT SYSTEM
        // ================================================

        function updateInventoryScreen() {
            // Update supplies counts
            const counts = {
                gas_can: 0,
                food_ration: 0,
                first_aid: 0,
                spare_part: 0
            };
            
            gameState.player.inventory.forEach(itemId => {
                if (counts[itemId] !== undefined) {
                    counts[itemId]++;
                }
            });
            
            document.getElementById('gas-cans').textContent = counts.gas_can;
            document.getElementById('food-rations').textContent = counts.food_ration;
            document.getElementById('first-aid').textContent = counts.first_aid;
            document.getElementById('spare-parts').textContent = counts.spare_part;
            
            // Update inventory items display
            updateInventoryDisplay();
            updateEvidenceDisplay();
            updateToolsDisplay();
            updateNotesDisplay();
            updatePhotoAlbum();
            updateSouvenirsDisplay();
            
            // Update equipped tools
            updateEquippedToolsDisplay();
        }

        function updateEquippedToolsDisplay() {
            const equippedDisplay = document.getElementById('equipped-tools-display');
            equippedDisplay.innerHTML = '';
            
            Object.entries(gameState.player.equipment).forEach(([slot, itemId]) => {
                if (itemId) {
                    const item = items[itemId];
                    if (item) {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'item';
                        itemElement.innerHTML = `
                            <strong>${slot}: ${item.name}</strong><br>
                            <small>${item.description}</small>
                        `;
                        itemElement.draggable = true;
                        itemElement.addEventListener('dragstart', (e) => {
                            e.dataTransfer.setData('text/plain', itemId);
                        });
                        equippedDisplay.appendChild(itemElement);
                    }
                }
            });
        }

        function openEquipmentSelection(slot) {
            // Show available tools for this slot
            const availableTools = gameState.player.tools.filter(toolId => {
                const tool = items[toolId];
                return tool && tool.equipSlot === slot;
            });
            
            if (availableTools.length === 0) {
                addToGameLog(`No tools available for ${slot} slot.`);
                return;
            }
            
            // Create selection modal (simplified)
            let message = `Select tool for ${slot}:\n`;
            availableTools.forEach((toolId, index) => {
                const tool = items[toolId];
                message += `${index + 1}. ${tool.name}\n`;
            });
            
            const selection = prompt(message);
            if (selection && parseInt(selection) <= availableTools.length) {
                const selectedTool = availableTools[parseInt(selection) - 1];
                equipItem(selectedTool, slot);
            }
        }

        function equipItem(itemId, slot) {
            const item = items[itemId];
            if (!item) return;
            
            // Check if item can be equipped in this slot
            if (item.equipSlot !== slot) {
                addToGameLog(`${item.name} cannot be equipped in ${slot} slot.`);
                return;
            }
            
            // Unequip current item if any
            const currentItem = gameState.player.equipment[slot];
            if (currentItem) {
                // Return to inventory
                gameState.player.tools.push(currentItem);
            }
            
            // Equip new item
            gameState.player.equipment[slot] = itemId;
            
            // Remove from tools
            const toolIndex = gameState.player.tools.indexOf(itemId);
            if (toolIndex > -1) {
                gameState.player.tools.splice(toolIndex, 1);
            }
            
            addToGameLog(`Equipped ${item.name} as ${slot}.`);
            updateInventoryScreen();
        }

        // ================================================
        // ENHANCED RADIO SYSTEM
        // ================================================

        function updateRadioScreen() {
            const signalStrength = 50 + Math.floor(Math.random() * 50);
            document.getElementById('signal-strength').textContent = `${signalStrength}%`;
            document.getElementById('current-frequency').textContent = '--.-- FM';
            document.getElementById('radio-battery').textContent = `${100 - gameState.player.day * 2}%`;
            document.getElementById('radio-weather').textContent = gameState.weather.current;
            
            // Update dynamic conditions
            updateRadioConditions();
        }

        function tuneRadio(frequency) {
            let station, message;
            
            switch(frequency) {
                case 'scan':
                    audioSystem.playRadio();
                    const stationKeys = Object.keys(radioStations).filter(k => k !== 'static' && k !== 'supernatural');
                    const randomStation = stationKeys[Math.floor(Math.random() * stationKeys.length)];
                    station = radioStations[randomStation];
                    
                    // Get appropriate message based on conditions
                    let messageType = 'normal';
                    if (gameState.difficulty.level > 3) messageType = 'highDanger';
                    if (gameState.player.factions.police.rep < -10) messageType = 'playerWanted';
                    if (gameState.player.factions.police.rep > 20) messageType = 'playerFriendly';
                    
                    const messages = station.messages[messageType] || station.messages.normal || station.messages.clear;
                    message = messages[Math.floor(Math.random() * messages.length)];
                    
                    document.getElementById('current-frequency').textContent = `${randomStation} FM`;
                    addToRadioLog(`[SCAN] ${station.name}: "${message}"`);
                    break;
                    
                case 'supernatural':
                    if (gameState.player.skills.occult.level >= 3) {
                        station = radioStations['supernatural'];
                        message = station.messages.unlocked[Math.floor(Math.random() * station.messages.unlocked.length)];
                        document.getElementById('current-frequency').textContent = '??? FM';
                        addToRadioLog(`[SUPERNATURAL] "${message}"`);
                        gameState.player.sanity -= 10;
                    } else {
                        addToRadioLog("[STATIC] Signal too weak to decipher...");
                    }
                    break;
                    
                case 'faction':
                    // Show faction-specific messages
                    showFactionRadio();
                    return;
                    
                default:
                    station = radioStations[frequency];
                    if (!station) return;
                    
                    // Get dynamic message based on game state
                    let dynamicMessage = getDynamicRadioMessage(station);
                    message = dynamicMessage || station.messages.normal?.[0] || "Signal unclear...";
                    
                    document.getElementById('current-frequency').textContent = `${frequency} FM`;
                    addToRadioLog(`${station.name}: "${message}"`);
            }
            
            // Show static animation
            document.getElementById('radio-static').classList.add('active');
            setTimeout(() => {
                document.getElementById('radio-static').classList.remove('active');
            }, frequency === 'static' ? 1000 : 500);
            
            // Update conditions display
            updateRadioConditions();
        }

        function getDynamicRadioMessage(station) {
            if (!station.dynamic) return null;
            
            if (station.name === "Weather Radio") {
                const weatherMessages = station.messages[gameState.weather.current];
                if (weatherMessages) {
                    return weatherMessages[Math.floor(Math.random() * weatherMessages.length)];
                }
            }
            
            if (station.name === "News Radio") {
                let messageSet;
                if (gameState.player.mysteriesSolved < 3) messageSet = station.messages.early;
                else if (gameState.player.mysteriesSolved < 7) messageSet = station.messages.mid;
                else messageSet = station.messages.late;
                
                if (gameState.player.reputation > 50) {
                    messageSet = station.messages.playerFamous || messageSet;
                }
                
                return messageSet?.[Math.floor(Math.random() * messageSet.length)];
            }
            
            if (station.name === "Music Station") {
                let messageSet = station.messages.night;
                if (gameState.time.dayPhase === 'dawn') messageSet = station.messages.dawn;
                if (gameState.player.sanity < 30) messageSet = station.messages.stress || messageSet;
                
                return messageSet?.[Math.floor(Math.random() * messageSet.length)];
            }
            
            return null;
        }

        function updateRadioConditions() {
            const conditionsDiv = document.getElementById('radio-conditions');
            conditionsDiv.innerHTML = '';
            
            const conditions = [
                `Time: ${gameState.time.dayPhase}`,
                `Weather: ${gameState.weather.current}`,
                `Danger Level: ${gameState.difficulty.level}/5`,
                `Signal Quality: ${50 + Math.floor(Math.random() * 50)}%`
            ];
            
            conditions.forEach(condition => {
                const condElement = document.createElement('div');
                condElement.textContent = condition;
                condElement.className = 'log-entry';
                conditionsDiv.appendChild(condElement);
            });
        }

        // ================================================
        // ENHANCED PROGRESSIVE SYSTEMS
        // ================================================

        function updateProgressiveDifficulty() {
            // Increase difficulty based on distance and mysteries solved
            const baseDifficulty = 1 + Math.floor(gameState.player.mile / 500) + Math.floor(gameState.player.mysteriesSolved / 3);
            gameState.difficulty.level = Math.min(5, baseDifficulty);
            
            // Update encounter rate
            gameState.difficulty.encounterRate = 0.3 + (gameState.difficulty.level * 0.1);
            
            // Update resource drain
            gameState.difficulty.resourceDrain = 1 + (gameState.difficulty.level * 0.2);
            
            // Update UI
            document.getElementById('difficulty-level').textContent = 
                ['LOW', 'MEDIUM', 'HIGH', 'VERY HIGH', 'EXTREME'][gameState.difficulty.level - 1] || 'LOW';
            
            const difficultyMarker = document.querySelector('.difficulty-meter');
            difficultyMarker.style.backgroundPosition = `${(gameState.difficulty.level - 1) * 25}%`;
        }

        function gainSkillXP(skill, xp) {
            if (!gameState.player.skills[skill]) return;
            
            gameState.player.skills[skill].xp += xp;
            
            // Check for level up
            if (gameState.player.skills[skill].xp >= gameState.player.skills[skill].nextLevel) {
                gameState.player.skills[skill].level++;
                gameState.player.skills[skill].xp = 0;
                gameState.player.skills[skill].nextLevel = Math.floor(gameState.player.skills[skill].nextLevel * 1.5);
                
                addToGameLog(`${skill.charAt(0).toUpperCase() + skill.slice(1)} skill increased to level ${gameState.player.skills[skill].level}!`);
                
                // Gain perk point every 3 levels
                if (gameState.player.skills[skill].level % 3 === 0) {
                    gameState.player.perkPoints++;
                    addToGameLog(`Gained a perk point! Total: ${gameState.player.perkPoints}`);
                }
            }
            
            updateSkillDisplay(skill);
        }

        function gainXP(xp) {
            gameState.player.xp += xp;
            const xpNeeded = gameState.player.level * 100;
            
            if (gameState.player.xp >= xpNeeded) {
                gameState.player.level++;
                gameState.player.xp = 0;
                gameState.player.perkPoints++;
                
                addToGameLog(`Level up! You are now level ${gameState.player.level}`);
                addToGameLog(`Gained a perk point! Total: ${gameState.player.perkPoints}`);
                
                // Unlock new perks
                checkPerkAvailability();
            }
        }

        // ================================================
        // ENHANCED TIME AND WEATHER SYSTEM
        // ================================================

        function updateGameTime() {
            // Advance time by 1 minute
            gameState.time.minute++;
            if (gameState.time.minute >= 60) {
                gameState.time.minute = 0;
                gameState.time.hour++;
                if (gameState.time.hour >= 24) {
                    gameState.time.hour = 0;
                    gameState.player.day++;
                }
            }
            
            // Update day phase
            updateDayPhase();
            
            // Update weather periodically
            if (Math.random() < 0.1) {
                updateWeather();
            }
            
            // Update displays
            updateTimeDisplay();
            updateWeatherDisplay();
            
            // Apply time-based effects
            applyTimeEffects();
        }

        function updateDayPhase() {
            const hour = gameState.time.hour;
            if (hour >= 5 && hour < 8) gameState.time.dayPhase = 'dawn';
            else if (hour >= 8 && hour < 18) gameState.time.dayPhase = 'day';
            else if (hour >= 18 && hour < 21) gameState.time.dayPhase = 'dusk';
            else gameState.time.dayPhase = 'night';
            
            // Update time of day effect
            const timeDisplay = document.getElementById('time-of-day');
            timeDisplay.className = 'time-of-day';
            timeDisplay.classList.add(gameState.time.dayPhase);
        }

        function updateWeather() {
            const weatherTypes = ['clear', 'rain', 'fog', 'wind', 'dust'];
            const location = locations[gameState.player.location];
            const locationWeather = location?.weatherPattern || ['clear'];
            
            // Weight by location preferences
            const weightedWeather = [...locationWeather, ...weatherTypes];
            const newWeather = weightedWeather[Math.floor(Math.random() * weightedWeather.length)];
            
            gameState.weather.current = newWeather;
            
            // Update weather effect display
            const weatherEffect = document.getElementById('weather-effect');
            weatherEffect.className = 'weather-effect';
            if (newWeather !== 'clear') {
                weatherEffect.classList.add(newWeather);
            }
            
            // Play ambient sounds
            audioSystem.playWeather(newWeather);
            
            // Log weather change
            if (Math.random() < 0.3) {
                addToGameLog(`Weather changes to ${newWeather}...`);
            }
        }

        function applyTimeEffects() {
            // Nighttime effects
            if (gameState.time.dayPhase === 'night') {
                // Increased encounter chance
                gameState.difficulty.encounterRate *= 1.3;
                
                // Increased sanity drain if driving
                if (gameState.currentScreen === 'drive') {
                    gameState.player.sanity = Math.max(0, gameState.player.sanity - 1);
                }
            }
            
            // Weather effects
            switch(gameState.weather.current) {
                case 'rain':
                    // Increased gas consumption
                    if (gameState.currentScreen === 'drive') {
                        gameState.player.gas = Math.max(0, gameState.player.gas - 1);
                    }
                    break;
                case 'fog':
                    // Increased encounter chance
                    gameState.difficulty.encounterRate *= 1.2;
                    break;
                case 'dust':
                    // Car maintenance degradation
                    degradeCarMaintenance(5);
                    break;
            }
        }

        // ================================================
        // ENHANCED ECONOMY & TRADING SYSTEM
        // ================================================

        function updateEconomy() {
            // Base inflation based on distance
            const baseInflation = 1 + (gameState.player.mile / 5000);
            
            // Location modifier
            const location = locations[gameState.player.location];
            const locationMod = location?.economy || 1.0;
            
            // Random fluctuation
            const fluctuation = 0.9 + Math.random() * 0.2;
            
            gameState.economy.inflation = baseInflation * locationMod * fluctuation;
            gameState.economy.locationModifier = locationMod;
            
            // Update price displays
            updatePriceDisplays();
        }

        function updatePriceDisplays() {
            const basePrices = {
                room: 20,
                food: 10,
                gas: 30,
                rumor: 15
            };
            
            Object.entries(basePrices).forEach(([item, basePrice]) => {
                const price = Math.floor(basePrice * gameState.economy.inflation);
                document.getElementById(`${item}-price`).textContent = price;
            });
            
            // Update mystery cost
            const mysteryCost = 25 + gameState.player.mysteriesSolved * 5;
            document.getElementById('mystery-cost').textContent = Math.floor(mysteryCost * gameState.economy.inflation);
        }

        // ================================================
        // ENHANCED UI UPDATES
        // ================================================

        function updateGameScreen() {
            // Basic stats
            document.getElementById('current-mile-display').textContent = gameState.player.mile;
            document.getElementById('current-location').textContent = locations[gameState.player.location]?.name || 'Unknown';
            document.getElementById('player-gas').textContent = gameState.player.gas;
            document.getElementById('player-max-gas').textContent = gameState.player.maxGas;
            document.getElementById('player-sanity').textContent = gameState.player.sanity;
            document.getElementById('player-max-sanity').textContent = gameState.player.maxSanity;
            document.getElementById('player-cash').textContent = gameState.player.cash;
            document.getElementById('player-day').textContent = gameState.player.day;
            document.getElementById('player-mysteries').textContent = gameState.player.mysteriesSolved;
            document.getElementById('player-reputation').textContent = gameState.player.reputation;
            document.getElementById('current-time').textContent = formatTime();
            
            // Update bars
            const gasPercent = (gameState.player.gas / gameState.player.maxGas) * 100;
            const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
            const cashPercent = Math.min(100, (gameState.player.cash / 1000) * 100);
            
            document.getElementById('gas-bar').style.width = `${gasPercent}%`;
            document.getElementById('sanity-bar').style.width = `${sanityPercent}%`;
            document.getElementById('cash-bar').style.width = `${cashPercent}%`;
            
            // Update skills
            updateSkillDisplay('investigation');
            updateSkillDisplay('driving');
            updateSkillDisplay('occult');
            updateSkillDisplay('repair');
            
            // Update factions
            updateFactionDisplay('police');
            updateFactionDisplay('locals');
            updateFactionDisplay('occultists');
            updateFactionDisplay('media');
            
            // Update car maintenance
            updateCarMaintenanceDisplay();
            
            // Update current investigations
            updateInvestigationsDisplay();
            
            // Update mini-map
            updateMiniMap();
            
            // Update find mystery button
            updateFindMysteryButton();
            
            // Check for faction events
            checkFactionEvents();
            
            // Update total miles
            document.getElementById('total-miles').textContent = gameState.player.totalMiles;
            
            // Update achievement tracker
            updateAchievementTracker();
        }

        function updateSkillDisplay(skill) {
            const skillData = gameState.player.skills[skill];
            if (!skillData) return;
            
            document.getElementById(`skill-${skill}`).textContent = skillData.level;
            const xpPercent = (skillData.xp / skillData.nextLevel) * 100;
            document.getElementById(`skill-${skill}-bar`).style.width = `${xpPercent}%`;
        }

        function updateFactionDisplay(faction) {
            const factionData = gameState.player.factions[faction];
            if (!factionData) return;
            
            document.getElementById(`faction-${faction}`).textContent = factionData.rep;
            const repPercent = Math.min(100, (factionData.rep + 100) / 2);
            document.getElementById(`faction-${faction}-bar`).style.width = `${repPercent}%`;
            
            // Update faction level
            let level = 'Neutral';
            if (factionData.rep >= 50) level = 'Ally';
            else if (factionData.rep >= 20) level = 'Friendly';
            else if (factionData.rep <= -20) level = 'Hostile';
            else if (factionData.rep <= -50) level = 'Enemy';
            
            factionData.level = level;
        }

        function updateCarMaintenanceDisplay() {
            const maintenance = gameState.player.carMaintenance;
            
            document.getElementById('car-engine-bar').style.width = `${maintenance.engine}%`;
            document.getElementById('car-tires-bar').style.width = `${maintenance.tires}%`;
            document.getElementById('car-battery-bar').style.width = `${maintenance.battery}%`;
            document.getElementById('car-suspension-bar').style.width = `${maintenance.suspension}%`;
            
            // Add critical warning class
            document.querySelectorAll('.maintenance-bar').forEach(bar => {
                bar.classList.remove('maintenance-critical');
            });
            
            if (maintenance.engine < 20) document.getElementById('car-engine-bar').parentElement.classList.add('maintenance-critical');
            if (maintenance.tires < 20) document.getElementById('car-tires-bar').parentElement.classList.add('maintenance-critical');
            if (maintenance.battery < 20) document.getElementById('car-battery-bar').parentElement.classList.add('maintenance-critical');
            if (maintenance.suspension < 20) document.getElementById('car-suspension-bar').parentElement.classList.add('maintenance-critical');
        }

        function degradeCarMaintenance(miles) {
            const degradationRate = 0.1; // 1% per 10 miles
            const degradeAmount = (miles * degradationRate) / 10;
            
            Object.keys(gameState.player.carMaintenance).forEach(part => {
                gameState.player.carMaintenance[part] = Math.max(0, gameState.player.carMaintenance[part] - degradeAmount);
                
                // Critical failure chance
                if (gameState.player.carMaintenance[part] < 10 && Math.random() < 0.1) {
                    addToGameLog(`CAR TROUBLE: ${part} failure!`);
                    gameState.player.gas -= 20;
                    gameState.player.sanity -= 15;
                }
            });
        }

        // ================================================
        // ENHANCED ACHIEVEMENT SYSTEM
        // ================================================

        function checkAchievements() {
            // Check mileage achievements
            if (gameState.player.totalMiles >= 1000 && !gameState.player.achievements.has('road_warrior')) {
                unlockAchievement('road_warrior');
            }
            
            // Check mystery achievements
            if (gameState.player.mysteriesSolved >= 5 && !gameState.player.achievements.has('ghost_hunter')) {
                unlockAchievement('ghost_hunter');
            }
            
            // Check faction achievements
            Object.values(gameState.player.factions).forEach(faction => {
                if (faction.rep >= 50 && !gameState.player.achievements.has('faction_friend')) {
                    unlockAchievement('faction_friend');
                }
            });
            
            // Check skill achievements
            Object.entries(gameState.player.skills).forEach(([skill, data]) => {
                if (data.level >= 5 && !gameState.player.achievements.has('master_investigator')) {
                    unlockAchievement('master_investigator');
                }
            });
            
            // Check wealth achievement
            if (gameState.player.cash >= 1000 && !gameState.player.achievements.has('rich_traveler')) {
                unlockAchievement('rich_traveler');
            }
            
            // Check night driving achievement
            if (gameState.player.totalMiles >= 500 && !gameState.player.achievements.has('night_crawler')) {
                // This would need tracking night miles separately
            }
        }

        function unlockAchievement(achievementId) {
            if (gameState.player.achievements.has(achievementId)) return;
            
            const achievement = achievements[achievementId];
            if (!achievement) return;
            
            gameState.player.achievements.add(achievementId);
            
            // Show achievement popup
            showAchievementPopup(achievement);
            
            // Apply rewards
            if (achievement.reward) {
                if (achievement.reward.perkPoints) gameState.player.perkPoints += achievement.reward.perkPoints;
                if (achievement.reward.cash) gameState.player.cash += achievement.reward.cash;
                if (achievement.reward.reputation) gameState.player.reputation += achievement.reward.reputation;
                if (achievement.reward.item) gameState.player.inventory.push(achievement.reward.item);
                if (achievement.reward[gameState.player.class]) {
                    // Class-specific reward
                }
            }
            
            // Update achievement tracker
            updateAchievementTracker();
        }

        function showAchievementPopup(achievement) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <h3>ACHIEVEMENT UNLOCKED!</h3>
                <h4>${achievement.name}</h4>
                <p>${achievement.description}</p>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        function updateAchievementTracker() {
            const tracker = document.getElementById('achievement-tracker');
            const count = document.getElementById('achievement-count');
            
            if (gameState.player.achievements.size > 0) {
                tracker.style.display = 'block';
                count.textContent = `${gameState.player.achievements.size}/${Object.keys(achievements).length}`;
            }
        }

        // ================================================
        // ENHANCED UTILITY FUNCTIONS
        // ================================================

        function formatTime() {
            let hours = gameState.time.hour;
            const minutes = gameState.time.minute.toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            return `${hours}:${minutes} ${ampm}`;
        }

        function advanceTime(minutes) {
            gameState.time.minute += minutes;
            while (gameState.time.minute >= 60) {
                gameState.time.minute -= 60;
                gameState.time.hour++;
                if (gameState.time.hour >= 24) {
                    gameState.time.hour = 0;
                    gameState.player.day++;
                }
            }
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                if (screen) screen.classList.remove('active');
            });
            
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
                gameState.currentScreen = screenName;
                
                switch(screenName) {
                    case 'game': updateGameScreen(); break;
                    case 'drive': updateDriveScreen(); break;
                    case 'investigate': updateInvestigationScreen(); break;
                    case 'inventory': updateInventoryScreen(); break;
                    case 'radio': updateRadioScreen(); break;
                    case 'upgrades': updateUpgradesScreen(); break;
                    case 'perks': updatePerksScreen(); break;
                    case 'map': updateMapScreen(); break;
                    case 'rest': updateRestScreen(); break;
                }
            }
        }

        function addToGameLog(message, isRadio = false) {
            const logElement = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${isRadio ? 'radio-active' : ''}`;
            entry.textContent = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addToDriveLog(message) {
            const logElement = document.getElementById('drive-log');
            const entry = document.createElement('div');
            entry.className = `log-entry`;
            entry.textContent = message;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addToRadioLog(message) {
            const logElement = document.getElementById('radio-log');
            const entry = document.createElement('div');
            entry.className = `radio-message dynamic-radio-message`;
            entry.innerHTML = `<span>${message}</span>`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // ================================================
        // NEW GAME+ AND SEASONAL EVENTS
        // ================================================

        function startNewGamePlus() {
            if (!confirm("Start New Game+? You'll keep your skills, perks, and some items, but mysteries will be harder.")) {
                return;
            }
            
            gameState.newGamePlus = true;
            
            // Keep skills, perks, and some items
            const keptItems = ['ritual_kit', 'camera', 'tool_kit', 'peace_offering'];
            gameState.player.inventory = gameState.player.inventory.filter(item => keptItems.includes(item));
            
            // Increase difficulty
            gameState.difficulty.level = 3;
            gameState.difficulty.encounterRate = 0.5;
            
            // Reset some stats
            gameState.player.mile = 0;
            gameState.player.day = 1;
            gameState.player.gas = 100;
            gameState.player.sanity = 80;
            gameState.player.cash = 100;
            gameState.player.mysteriesSolved = 0;
            gameState.player.activeMysteries = ['vanishing_hitchhiker'];
            
            // Start game
            showScreen('game');
            addToGameLog("NEW GAME+ - The road calls you back, harder mysteries await...");
        }

        function checkSeasonalEvents() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            
            // Check Halloween
            if (month === 10 && day >= 25 && day <= 31) {
                seasonalEvents.halloween.active = true;
                addToGameLog("SPECIAL EVENT: Halloween Spirit - Supernatural activity increased!");
            }
            
            // Check Christmas
            if (month === 12 && day >= 20 && day <= 27) {
                seasonalEvents.christmas.active = true;
                addToGameLog("SPECIAL EVENT: Christmas Spirit - Increased kindness from strangers!");
            }
        }

        // ================================================
        // KEYBOARD SHORTCUTS
        // ================================================

        function handleKeyboardShortcuts(e) {
            // Show hint on first keypress
            if (!gameState.accessibility.completedTutorials.includes('keyboard')) {
                document.getElementById('keyboard-hint').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('keyboard-hint').style.display = 'none';
                }, 5000);
                gameState.accessibility.completedTutorials.push('keyboard');
            }
            
            // Number keys for quick actions
            if (e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                const buttons = document.querySelectorAll('#game-screen .button:not(.disabled)');
                if (buttons[index]) {
                    audioSystem.playClick();
                    buttons[index].click();
                }
            }
            
            // Quick save (Ctrl+S)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveGame();
                showQuickSaveNotification();
            }
            
            // Quick load (Ctrl+L)
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                loadGame();
            }
            
            // Escape to go back
            if (e.key === 'Escape' && gameState.currentScreen !== 'game') {
                audioSystem.playClick();
                showScreen('game');
            }
        }

        function showQuickSaveNotification() {
            const notification = document.createElement('div');
            notification.className = 'quick-save-notification';
            notification.textContent = 'Game Saved';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // ================================================
        // ADDITIONAL ENHANCEMENTS
        // ================================================

        function generateCarName() {
            const carNames = [
                "The Midnight Rider", "Ghost Chaser", "Road Warrior", "Desert Phantom",
                "Night Stalker", "Highway Hunter", "Lone Traveler", "Dust Devil"
            ];
            const name = carNames[Math.floor(Math.random() * carNames.length)];
            document.getElementById('random-car-name').textContent = `Your car: "${name}"`;
        }

        function updateMiniMap() {
            const map = document.getElementById('mini-map');
            if (!map) return;
            
            // Simple ASCII map showing player position
            let mapText = '';
            const playerMile = gameState.player.mile;
            
            // This is a simplified representation
            if (playerMile < 100) mapText = '[CHICAGO]\n  |\n  v YOU\n[SPRINGFIELD]\n  |\n[ST. LOUIS]';
            else if (playerMile < 300) mapText = '[CHICAGO]\n  |\n[SPRINGFIELD]\n  |\n  v YOU\n[ST. LOUIS]';
            else if (playerMile < 500) mapText = '[SPRINGFIELD]\n  |\n[ST. LOUIS]\n  |\n  v YOU\n[TULSA]';
            else mapText = '[ST. LOUIS]\n  |\n[TULSA]\n  |\n  v YOU\n[AMARILLO]';
            
            map.textContent = mapText;
        }

        function startRoadAnimation() {
            const road = document.getElementById('road-animation');
            if (road) {
                road.style.animation = 'road-move 1s linear infinite';
            }
        }

        function checkResources() {
            // Check for low resources and add visual warnings
            if (gameState.player.gas < 30) {
                document.getElementById('gas-bar').parentElement.classList.add('gas-low');
            } else {
                document.getElementById('gas-bar').parentElement.classList.remove('gas-low');
            }
            
            if (gameState.player.sanity < 30) {
                document.getElementById('sanity-bar').parentElement.classList.add('sanity-low');
            } else {
                document.getElementById('sanity-bar').parentElement.classList.remove('sanity-low');
            }
        }

        // ================================================
        // MISSING IMPLEMENTATIONS
        // ================================================

        function updateDriveScreen() {
            // Update drive screen stats
            document.getElementById('drive-player-gas').textContent = gameState.player.gas;
            document.getElementById('drive-player-max-gas').textContent = gameState.player.maxGas;
            document.getElementById('drive-player-sanity').textContent = gameState.player.sanity;
            document.getElementById('drive-player-max-sanity').textContent = gameState.player.maxSanity;
            document.getElementById('drive-player-cash').textContent = gameState.player.cash;
            document.getElementById('next-town').textContent = Math.max(0, gameState.nextTownDistance - gameState.driveDistance);
            document.getElementById('drive-speed').textContent = gameState.drivingSpeed.charAt(0).toUpperCase() + gameState.drivingSpeed.slice(1);
            
            // Update bars
            const gasPercent = (gameState.player.gas / gameState.player.maxGas) * 100;
            const sanityPercent = (gameState.player.sanity / gameState.player.maxSanity) * 100;
            const distancePercent = (gameState.driveDistance / gameState.nextTownDistance) * 100;
            
            document.getElementById('drive-gas-bar').style.width = `${gasPercent}%`;
            document.getElementById('drive-sanity-bar').style.width = `${sanityPercent}%`;
            document.getElementById('distance-bar').style.width = `${distancePercent}%`;
        }

        function updateInvestigationScreen() {
            document.getElementById('investigate-location').textContent = locations[gameState.player.location]?.name || 'Unknown';
            document.getElementById('investigate-time').textContent = gameState.time.dayPhase;
            document.getElementById('clues-found').textContent = gameState.player.cluesFound;
            document.getElementById('clues-needed').textContent = gameState.player.cluesNeeded;
            
            // Update mystery description
            const mysteryId = gameState.player.activeMysteries[0];
            const mystery = mysteryId ? mysteries[mysteryId] : null;
            document.getElementById('mystery-description').innerHTML = mystery ? 
                `<div class="log-entry"><strong>${mystery.name}</strong></div>
                 <div class="log-entry">${mystery.description}</div>` : 
                "No active mystery";
        }

        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('inventory-items');
            inventoryGrid.innerHTML = '';
            
            gameState.player.inventory.forEach(itemId => {
                const item = items[itemId];
                if (item) {
                    const itemElement = document.createElement('div');
                    itemElement.className = `item rarity-${item.rarity}`;
                    itemElement.innerHTML = `
                        <strong>${item.name}</strong><br>
                        <small>${item.description}</small>
                        <div class="item-stats">${item.type}</div>
                    `;
                    inventoryGrid.appendChild(itemElement);
                }
            });
        }

        function updateEvidenceDisplay() {
            const evidenceGrid = document.getElementById('evidence-display');
            evidenceGrid.innerHTML = '';
            
            gameState.player.evidence.forEach(evidenceId => {
                const evidenceElement = document.createElement('div');
                evidenceElement.className = 'evidence-item';
                evidenceElement.textContent = evidenceId.replace('_', ' ');
                evidenceGrid.appendChild(evidenceElement);
            });
        }

        function updateToolsDisplay() {
            const toolsGrid = document.getElementById('tools-display');
            toolsGrid.innerHTML = '';
            
            gameState.player.tools.forEach(toolId => {
                const tool = items[toolId];
                if (tool) {
                    const toolElement = document.createElement('div');
                    toolElement.className = `item rarity-${tool.rarity}`;
                    toolElement.innerHTML = `
                        <strong>${tool.name}</strong><br>
                        <small>${tool.description}</small>
                        <div class="item-stats">${tool.equipSlot || 'Tool'}</div>
                    `;
                    toolsGrid.appendChild(toolElement);
                }
            });
        }

        function updateNotesDisplay() {
            const notesDisplay = document.getElementById('notes-display');
            notesDisplay.innerHTML = '';
            
            Object.entries(gameState.player.caseFiles).forEach(([mysteryId, data]) => {
                const mystery = mysteries[mysteryId];
                if (mystery) {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'log-entry';
                    noteElement.innerHTML = `<strong>${mystery.name}</strong> - Solved on Day ${data.date}`;
                    notesDisplay.appendChild(noteElement);
                }
            });
        }

        function updatePhotoAlbum() {
            const photoAlbum = document.getElementById('photo-album-display');
            photoAlbum.innerHTML = '';
            
            gameState.player.photos.forEach(photo => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-frame';
                photoElement.textContent = photo;
                photoAlbum.appendChild(photoElement);
            });
        }

        function updateSouvenirsDisplay() {
            const souvenirGrid = document.getElementById('souvenir-inventory');
            souvenirGrid.innerHTML = '';
            
            gameState.player.souvenirs.forEach(souvenirId => {
                const souvenir = items[souvenirId];
                if (souvenir) {
                    const souvenirElement = document.createElement('div');
                    souvenirElement.className = 'souvenir';
                    souvenirElement.textContent = souvenir.name;
                    souvenirGrid.appendChild(souvenirElement);
                }
            });
        }

        function updateUpgradesScreen() {
            document.getElementById('upgrade-cash').textContent = gameState.player.cash;
            // Add more upgrade screen updates here
        }

        function updatePerksScreen() {
            document.getElementById('perk-points').textContent = gameState.player.perkPoints;
            document.getElementById('perk-class').textContent = gameState.player.class ? classes[gameState.player.class].name : 'None';
            document.getElementById('perk-level').textContent = gameState.player.level;
            
            // Simplified perk display
            const perksGrid = document.getElementById('perks-grid');
            perksGrid.innerHTML = '';
            
            Object.entries(perks).forEach(([perkId, perk]) => {
                const hasPerk = gameState.player.perks.includes(perkId);
                const canBuy = !hasPerk && gameState.player.perkPoints >= perk.cost;
                
                const perkCard = document.createElement('div');
                perkCard.className = `perk-card ${hasPerk ? 'unlocked' : canBuy ? 'available' : 'locked'}`;
                perkCard.innerHTML = `
                    <div class="perk-icon">â­</div>
                    <h4>${perk.name}</h4>
                    <p>${perk.description}</p>
                    <div class="perk-cost">Cost: ${perk.cost} points</div>
                `;
                
                if (canBuy) {
                    perkCard.addEventListener('click', () => buyPerk(perkId));
                }
                
                perksGrid.appendChild(perkCard);
            });
        }

        function buyPerk(perkId) {
            const perk = perks[perkId];
            if (!perk || gameState.player.perkPoints < perk.cost || gameState.player.perks.includes(perkId)) {
                return;
            }
            
            gameState.player.perkPoints -= perk.cost;
            gameState.player.perks.push(perkId);
            addToGameLog(`Learned perk: ${perk.name}`);
            updatePerksScreen();
            updateGameScreen();
        }

        function updateMapScreen() {
            document.getElementById('current-mile').textContent = gameState.player.mile;
            document.getElementById('map-next-town').textContent = `${Math.max(0, gameState.nextTownDistance - gameState.driveDistance)} miles`;
            document.getElementById('gas-stations').textContent = "1 ahead";
            document.getElementById('map-weather').textContent = gameState.weather.current;
        }

        function updateRestScreen() {
            document.getElementById('rest-cash').textContent = gameState.player.cash;
            // Add more rest screen updates here
        }

        function updateInvestigationsDisplay() {
            const investigationDiv = document.getElementById('current-investigation');
            const caseFilesDiv = document.getElementById('case-files');
            
            if (gameState.player.activeMysteries.length === 0) {
                investigationDiv.innerHTML = "No active investigations";
                caseFilesDiv.innerHTML = '';
                return;
            }
            
            let html = '<strong>Active Cases:</strong><br>';
            gameState.player.activeMysteries.forEach(mysteryId => {
                const mystery = mysteries[mysteryId];
                if (mystery) {
                    html += `<div class="log-entry">â€¢ ${mystery.name} (${gameState.player.cluesFound}/${gameState.player.cluesNeeded} clues)</div>`;
                }
            });
            
            investigationDiv.innerHTML = html;
            
            // Show case files for solved mysteries
            if (Object.keys(gameState.player.caseFiles).length > 0) {
                let caseHtml = '<strong>Solved Cases:</strong><br>';
                Object.entries(gameState.player.caseFiles).forEach(([mysteryId, data]) => {
                    const mystery = mysteries[mysteryId];
                    if (mystery) {
                        caseHtml += `<div class="log-entry">âœ“ ${mystery.name} (Day ${data.date})</div>`;
                    }
                });
                caseFilesDiv.innerHTML = caseHtml;
            }
        }

        function updateFindMysteryButton() {
            const mysteryBtn = document.getElementById('find-mystery-btn');
            if (gameState.player.activeMysteries.length === 0) {
                mysteryBtn.style.display = 'block';
            } else {
                mysteryBtn.style.display = 'none';
            }
        }

        function checkFactionEvents() {
            // Simplified faction event check
            const factionEventsDiv = document.getElementById('faction-events');
            factionEventsDiv.innerHTML = '';
            
            Object.entries(gameState.player.factions).forEach(([faction, data]) => {
                if (data.rep >= 25 && Math.random() < 0.1) {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `faction-event ${faction}-event`;
                    eventDiv.textContent = `${faction.charAt(0).toUpperCase() + faction.slice(1)} event available!`;
                    factionEventsDiv.appendChild(eventDiv);
                }
            });
        }

        function checkPerkAvailability() {
            // Simplified perk availability check
        }

        function addClue(clue) {
            gameState.player.cluesFound++;
        }

        function calculateNextTownDistance() {
            return 50 + Math.floor(Math.random() * 50);
        }

        function reachTown() {
            addToDriveLog(`You arrive at the next town!`);
            gameState.player.location = 'st_louis'; // Simplified
            showScreen('game');
        }

        function stopCar() {
            addToDriveLog("You pull over to the side of the road...");
            // Add more stop car logic
        }

        function checkRadio() {
            addToDriveLog("You tune the radio...");
            // Add radio check logic
        }

        function updateRiskReward() {
            const riskLevel = document.getElementById('risk-level');
            const rewardLevel = document.getElementById('reward-level');
            
            let risk = 'LOW';
            let reward = 'LOW';
            
            if (gameState.difficulty.level >= 4) {
                risk = 'HIGH';
                reward = 'HIGH';
            } else if (gameState.difficulty.level >= 2) {
                risk = 'MEDIUM';
                reward = 'MEDIUM';
            }
            
            riskLevel.textContent = risk;
            rewardLevel.textContent = reward;
        }

        function updateSpeedDisplay() {
            // Update speed display if needed
        }

        function updateTimeDisplay() {
            document.getElementById('time-display').textContent = formatTime();
        }

        function updateWeatherDisplay() {
            document.getElementById('weather-display').textContent = gameState.weather.current;
        }

        function showFloatingText(text, type, element) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${type}-text`;
            floatingText.textContent = text;
            
            if (element) {
                const rect = element.getBoundingClientRect();
                floatingText.style.left = `${rect.left + rect.width/2}px`;
                floatingText.style.top = `${rect.top}px`;
            } else {
                floatingText.style.left = '50%';
                floatingText.style.top = '50%';
            }
            
            document.body.appendChild(floatingText);
            
            setTimeout(() => {
                floatingText.remove();
            }, 1000);
        }

        function showDefeat(reason) {
            document.getElementById('defeat-message').textContent = `You ${reason}`;
            showScreen('defeat');
            audioSystem.playDefeat();
        }

        function continueFromDefeat() {
            gameState.player.gas = 50;
            gameState.player.sanity = 50;
            gameState.player.cash = Math.max(0, gameState.player.cash - 100);
            showScreen('game');
        }

        function purchaseMystery() {
            const cost = 25 + gameState.player.mysteriesSolved * 5;
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                
                // Get a random mystery
                const availableMysteries = Object.keys(mysteries).filter(m => 
                    !gameState.player.activeMysteries.includes(m)
                );
                
                if (availableMysteries.length > 0) {
                    const mysteryId = availableMysteries[Math.floor(Math.random() * availableMysteries.length)];
                    gameState.player.activeMysteries.push(mysteryId);
                    gameState.player.cluesNeeded = mysteries[mysteryId].cluesNeeded;
                    addToGameLog(`Purchased information about: ${mysteries[mysteryId].name}`);
                }
            } else {
                addToGameLog("Not enough cash to purchase mystery information.");
            }
            updateGameScreen();
        }

        function restCheap() {
            addToGameLog("You sleep fitfully in your car...");
            gameState.player.sanity = Math.min(100, gameState.player.sanity + 10);
            advanceTime(480); // 8 hours
            updateGameScreen();
        }

        function restRoom() {
            const cost = 20;
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                addToGameLog("You rent a room and get some proper rest.");
                gameState.player.sanity = Math.min(100, gameState.player.sanity + 30);
                advanceTime(480);
            } else {
                addToGameLog("Not enough cash for a room.");
            }
            updateGameScreen();
        }

        function buyFood() {
            const cost = 10;
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                gameState.player.inventory.push('food_ration');
                addToGameLog("Bought food rations.");
            } else {
                addToGameLog("Not enough cash for food.");
            }
            updateGameScreen();
        }

        function buyGas() {
            const cost = 30;
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                gameState.player.inventory.push('gas_can');
                addToGameLog("Bought a gas can.");
            } else {
                addToGameLog("Not enough cash for gas.");
            }
            updateGameScreen();
        }

        function findMystery() {
            const cost = 15;
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                purchaseMystery();
            } else {
                addToGameLog("Not enough cash to listen for rumors.");
            }
        }

        function startBettingGame() {
            document.getElementById('betting-game').style.display = 'block';
        }

        function placeBet(amount) {
            if (gameState.player.cash >= amount) {
                gameState.player.cash -= amount;
                const win = Math.random() < 0.4;
                if (win) {
                    const winnings = amount * 2;
                    gameState.player.cash += winnings;
                    document.getElementById('betting-result').textContent = `You won $${winnings}!`;
                } else {
                    document.getElementById('betting-result').textContent = `You lost $${amount}.`;
                }
            } else {
                document.getElementById('betting-result').textContent = "Not enough cash to bet.";
            }
            updateGameScreen();
        }

        function planRoute() {
            addToGameLog("You plan your route...");
            // Add route planning logic
        }

        function saveGame() {
            try {
                localStorage.setItem('highwayHauntingsSave', JSON.stringify(gameState));
                console.log("Game saved successfully");
            } catch (e) {
                console.error("Failed to save game:", e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('highwayHauntingsSave');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    Object.assign(gameState, loadedState);
                    updateGameScreen();
                    showScreen('game');
                    addToGameLog("Journey continued from save point.");
                    console.log("Game loaded successfully");
                } else {
                    addToGameLog("No saved game found.");
                }
            } catch (e) {
                console.error("Failed to load game:", e);
                addToGameLog("Failed to load saved game.");
            }
        }

        function toggleMusic() {
            audioSystem.enabled.music = !audioSystem.enabled.music;
            document.getElementById('music-toggle').textContent = `Music: ${audioSystem.enabled.music ? 'ON' : 'OFF'}`;
        }

        function toggleSFX() {
            audioSystem.enabled.sfx = !audioSystem.enabled.sfx;
            document.getElementById('sfx-toggle').textContent = `SFX: ${audioSystem.enabled.sfx ? 'ON' : 'OFF'}`;
        }

        function cycleFontSize() {
            const sizes = ['small', 'medium', 'large', 'xlarge'];
            const current = gameState.accessibility.fontSize;
            const currentIndex = sizes.indexOf(current);
            const nextIndex = (currentIndex + 1) % sizes.length;
            gameState.accessibility.fontSize = sizes[nextIndex];
            
            document.getElementById('font-size-btn').textContent = `Font: ${sizes[nextIndex].charAt(0).toUpperCase() + sizes[nextIndex].slice(1)}`;
            
            // Apply font size to all text elements
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
                screen.classList.add(`font-${sizes[nextIndex]}`);
            });
        }

        function showTutorial() {
            alert("Highway Hauntings Tutorial:\n\n1. Choose your driver class\n2. Drive between towns to find mysteries\n3. Investigate areas to gather clues\n4. Solve mysteries for rewards\n5. Manage your gas, sanity, and cash\n6. Upgrade your car and learn perks\n\nGood luck on Route 66!");
        }

        function toggleHighContrast() {
            gameState.accessibility.highContrast = !gameState.accessibility.highContrast;
            document.getElementById('high-contrast').textContent = gameState.accessibility.highContrast ? 'Normal Contrast' : 'High Contrast';
            
            if (gameState.accessibility.highContrast) {
                document.body.style.filter = 'contrast(1.5)';
            } else {
                document.body.style.filter = 'none';
            }
        }

        // ================================================
        // INITIALIZE GAME
        // ================================================

        window.addEventListener('load', function() {
            console.log("Page loaded, initializing enhanced game...");
            initGame();
        });
    </script>
</body>
</html>
