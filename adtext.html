<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle of the Dammed 1982</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        .game-container {
            border: 2px solid #fff;
            padding: 20px;
            margin-top: 20px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #fff;
            padding-bottom: 10px;
        }
        
        .game-title {
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #fff;
        }
        
        .game-subtitle {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .game-output {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            border: 1px solid #333;
            padding: 15px;
            background-color: #111;
        }
        
        .game-output p {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .game-output .location {
            color: #ffff00;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .game-output .hint {
            color: #888;
            font-style: italic;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .game-output .enemy {
            color: #ff5555;
        }
        
        .game-output .npc {
            color: #55ff55;
        }
        
        .game-output .combat {
            color: #ff4444;
            font-weight: bold;
        }
        
        .game-output .player {
            color: #55ffff;
        }
        
        .game-output .health {
            color: #ff6666;
        }
        
        .game-output .damage {
            color: #ff9966;
        }
        
        .game-output .victory {
            color: #ffff55;
            font-weight: bold;
        }
        
        .game-output .defeat {
            color: #ff5555;
            font-weight: bold;
        }
        
        .game-input-container {
            display: flex;
            align-items: center;
            border-top: 1px dashed #fff;
            padding-top: 15px;
        }
        
        .game-prompt {
            margin-right: 10px;
            color: #00ff00;
        }
        
        #game-input {
            background-color: #000;
            color: #fff;
            border: 1px solid #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            padding: 10px;
            flex-grow: 1;
            outline: none;
        }
        
        #game-input:focus {
            box-shadow: 0 0 5px #fff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Scrollbar styling */
        .game-output::-webkit-scrollbar {
            width: 10px;
        }
        
        .game-output::-webkit-scrollbar-track {
            background: #111;
        }
        
        .game-output::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        .game-output::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #222;
            border: 1px solid #444;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .health-bar {
            width: 100px;
            height: 12px;
            background-color: #333;
            margin-left: 5px;
            border: 1px solid #555;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff5555;
            transition: width 0.3s;
        }
        
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            
            .game-title {
                font-size: 18px;
            }
            
            .game-container {
                padding: 10px;
            }
            
            #game-input {
                font-size: 12px;
                padding: 8px;
            }
            
            .status-bar {
                font-size: 10px;
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title">CASTLE OF THE DAMMED</h1>
        <p class="game-subtitle">Â© 1982 Dark Castle Software</p>
        <p class="game-subtitle">Text Adventure v1.0 - COMBAT UPDATE</p>
    </div>
    
    <div class="status-bar" id="status-bar">
        <div class="status-item">
            HP: <span id="player-hp-text">25/25</span>
            <div class="health-bar">
                <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
            </div>
        </div>
        <div class="status-item">
            Weapon: <span id="player-weapon">Fists</span>
        </div>
        <div class="status-item">
            Enemy HP: <span id="enemy-hp-text">-</span>
            <div class="health-bar">
                <div class="health-fill" id="enemy-health-fill" style="width: 0%; background-color: #ff9966;"></div>
            </div>
        </div>
    </div>
    
    <div class="game-container">
        <div class="game-output" id="game-output">
            <!-- Game text will appear here -->
        </div>
        
        <div class="game-input-container">
            <span class="game-prompt">&gt;</span>
            <input type="text" id="game-input" placeholder="Type your command..." autocomplete="off">
        </div>
    </div>

    <script>
        // ==================== COMBAT SYSTEM ====================
        
        // Player stats
        const player = {
            maxHP: 25,
            currentHP: 25,
            weapon: {
                name: "Fists",
                minDamage: 4,
                maxDamage: 6
            },
            inventory: []
        };
        
        // Enemy types
        const enemies = {
            skeleton: {
                name: "Skeletal Guard",
                maxHP: 15,
                currentHP: 15,
                minDamage: 2,
                maxDamage: 5,
                description: "A skeletal guard in rusted armor stands motionless. Red pinpoints of light glow in its empty eye sockets.",
                defeatMessage: "The skeletal guard crumbles to dust!",
                loot: "silver medallion"
            },
            // Add more enemies here as you expand the game
        };
        
        // Current combat state
        let combatActive = false;
        let currentEnemy = null;
        
        // ==================== GAME STATE ====================
        const gameState = {
            currentLocation: 'entrance',
            inventory: player.inventory, // Reference to player's inventory
            visitedLocations: ['entrance'],
            gameEnded: false,
            torchLit: false,
            enemyDefeated: false,
            chestOpened: false,
            secretRevealed: false,
            hasTalkedToGhost: false,
            ghostGone: false,
            treasureFound: false
        };
        
        // Update status display
        function updateStatus() {
            document.getElementById('player-hp-text').textContent = 
                `${player.currentHP}/${player.maxHP}`;
            
            const playerHealthPercent = (player.currentHP / player.maxHP) * 100;
            document.getElementById('player-health-fill').style.width = 
                `${Math.max(0, playerHealthPercent)}%`;
            
            document.getElementById('player-weapon').textContent = player.weapon.name;
            
            if (currentEnemy && combatActive) {
                document.getElementById('enemy-hp-text').textContent = 
                    `${currentEnemy.currentHP}/${currentEnemy.maxHP}`;
                
                const enemyHealthPercent = (currentEnemy.currentHP / currentEnemy.maxHP) * 100;
                document.getElementById('enemy-health-fill').style.width = 
                    `${Math.max(0, enemyHealthPercent)}%`;
                document.getElementById('enemy-health-fill').style.display = 'block';
            } else {
                document.getElementById('enemy-hp-text').textContent = '-';
                document.getElementById('enemy-health-fill').style.display = 'none';
            }
        }
        
        // Combat functions
        function startCombat(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(enemies[enemyType])); // Clone enemy
            combatActive = true;
            updateStatus();
            
            addToOutput(`A ${currentEnemy.name} stands before you!`, "enemy");
            addToOutput("COMBAT STARTED! Use ATTACK to fight!", "combat");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP} | ${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "combat");
        }
        
        function playerAttack() {
            if (!combatActive || !currentEnemy) {
                addToOutput("There's nothing to attack here.");
                return;
            }
            
            // Player attacks
            const playerDamage = Math.floor(
                Math.random() * (player.weapon.maxDamage - player.weapon.minDamage + 1)
            ) + player.weapon.minDamage;
            
            currentEnemy.currentHP -= playerDamage;
            currentEnemy.currentHP = Math.max(0, currentEnemy.currentHP);
            
            addToOutput(`You attack with your ${player.weapon.name} and deal ${playerDamage} damage!`, "player");
            addToOutput(`${currentEnemy.name} HP: ${currentEnemy.currentHP}/${currentEnemy.maxHP}`, "damage");
            
            // Check if enemy is defeated
            if (currentEnemy.currentHP <= 0) {
                endCombat(true);
                return;
            }
            
            // Enemy attacks back
            enemyAttack();
            updateStatus();
        }
        
        function enemyAttack() {
            const enemyDamage = Math.floor(
                Math.random() * (currentEnemy.maxDamage - currentEnemy.minDamage + 1)
            ) + currentEnemy.minDamage;
            
            player.currentHP -= enemyDamage;
            player.currentHP = Math.max(0, player.currentHP);
            
            addToOutput(`${currentEnemy.name} attacks you for ${enemyDamage} damage!`, "enemy");
            addToOutput(`Your HP: ${player.currentHP}/${player.maxHP}`, "health");
            
            // Check if player is defeated
            if (player.currentHP <= 0) {
                endCombat(false);
            }
        }
        
        function endCombat(playerWon) {
            if (playerWon) {
                addToOutput(currentEnemy.defeatMessage, "victory");
                
                // Add loot if any
                if (currentEnemy.loot && !gameState.inventory.includes(currentEnemy.loot)) {
                    gameState.inventory.push(currentEnemy.loot);
                    addToOutput(`You found a ${currentEnemy.loot}!`, "item");
                }
                
                // Mark enemy as defeated in game state
                if (currentEnemy.name === "Skeletal Guard") {
                    gameState.enemyDefeated = true;
                    gameState.secretRevealed = true;
                    if (currentEnemy.loot && !locations.guardroom.items.includes(currentEnemy.loot)) {
                        locations.guardroom.items.push(currentEnemy.loot);
                    }
                }
            } else {
                addToOutput("You have been defeated!", "defeat");
                addToOutput("GAME OVER - Refresh the page to try again.", "defeat");
                gameState.gameEnded = true;
                gameInput.disabled = true;
            }
            
            combatActive = false;
            currentEnemy = null;
            updateStatus();
        }
        
        // Object descriptions
        const objectDescriptions = {
            // Weapons
            "fists": "Your bare hands. Not very effective but better than nothing. Damage: 4-6",
            "rusty sword": "An old, rusted sword. It's seen better days but can still do damage. Damage: 6-10",
            "ancient mace": "A heavy mace with a spiked head. Slow but powerful. Damage: 8-12",
            
            // Existing objects remain the same...
            "castle": "The Castle of the Dammed looms before you. Its dark stone walls rise ominously against the stormy sky. Ancient and foreboding.",
            "gates": "Massive iron gates, twenty feet tall. Rusted and ancient, with one hinge broken. They stand slightly ajar, inviting yet threatening.",
            "wind": "A cold, howling wind that whips through the trees. It carries the scent of decay and whispers of forgotten souls.",
            "trees": "Barren, skeletal trees surround the castle grounds. Their twisted branches claw at the dark sky like desperate fingers.",
            "key": "A rusty iron key lies half-buried in the dirt. It looks old but sturdy, perhaps still functional.",
            "ground": "Hard-packed earth covered in patches of dead grass and scattered stones. The soil feels cold and lifeless.",
            "courtyard": "Through the gates, you see a desolate courtyard. The path north leads into the castle proper.",
            
            // Courtyard objects
            "walls": "Crumbling stone walls encircle the courtyard. Centuries of neglect have taken their toll on the masonry.",
            "vines": "Dead, brown vines cling to the walls like skeletal fingers. They rustle dryly in the wind.",
            "fountain": "A broken marble fountain depicting a weeping angel. Cracked and dry, it stands as a monument to decay.",
            "water": "Murky, stagnant water fills the fountain's basin. It smells foul and has a greenish tint.",
            "torch": "A wooden torch propped against the wall. The cloth wrapping appears dry enough to burn.",
            "doors": "Heavy wooden doors to the north and west. They look ancient but still solid.",
            "path": "A cobblestone path leads back south to the entrance. The stones are cracked and uneven.",
            "sky": "A dark, stormy sky hangs over the castle. No stars are visible through the thick clouds.",
            
            // Armory objects
            "armor": "Rusted suits of armor stand like silent sentinels. They seem almost lifelike in the dim light.",
            "weapons": "Ancient weapons line the walls - swords, axes, and maces, all coated with dust and rust.",
            "chest": "A large iron-bound chest sits in the corner. It looks old but sturdy, secured with a heavy lock.",
            "racks": "Weapon racks that once held gleaming arms now hold only decaying wood and rusted metal.",
            "shadows": "Deep shadows cling to the corners of the room, hiding who knows what secrets.",
            "medallion": "A silver medallion with strange markings. It feels cold and hums with faint energy.",
            
            // Guard Room objects
            "skeleton": "A skeletal guard in rusted armor stands motionless. Red pinpoints of light glow in its empty eye sockets. It looks ready to fight!",
            "table": "A rough wooden table covered in dust. Old maps and empty tankards litter its surface.",
            "chairs": "Three wooden chairs, two of them overturned as if someone left in a hurry.",
            "fireplace": "A cold, soot-blackened fireplace. The ashes within look centuries old.",
            
            // Ghost NPC
            "ghost": "A translucent figure of an old man in tattered robes. He looks troubled and seems to be waiting for something.",
            "crypt": "A stone crypt with ancient inscriptions. One wall looks different from the others...",
            
            // Secret Chamber objects
            "treasure": "Piles of gold coins, jewels, and ancient artifacts glitter in the torchlight.",
            "inscriptions": "Strange glowing inscriptions cover the walls. They pulse with arcane energy.",
            "altar": "A black stone altar with a single gem resting on it. The gem pulses with inner light.",
            "passage": "A newly revealed passage in the north wall. It leads to a hidden chamber.",
            
            // Treasure Vault objects
            "gold": "Mountains of gold coins fill the room, glittering in the torchlight.",
            "jewels": "Rubies, emeralds, sapphires and diamonds sparkle with inner fire.",
            "artifacts": "Ancient artifacts of forgotten civilizations line the walls.",
            "crown": "The Diamond Crown of Kings, said to grant wisdom to its wearer."
        };

        // Game locations with dynamic descriptions
        const locations = {
            entrance: {
                name: "CASTLE ENTRANCE",
                description: function() {
                    let desc = "You stand before the CASTLE of the Dammed. Massive iron GATES stand before you, slightly ajar. A cold WIND howls through barren TREES.";
                    if (this.items.includes('rusty key')) {
                        desc += " A rusty KEY lies on the GROUND.";
                    } else {
                        desc += " The GROUND is bare where the key once lay.";
                    }
                    desc += " To the north lies the COURTYARD.";
                    return desc;
                },
                items: ["rusty key"],
                exits: {
                    north: "courtyard",
                    south: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            courtyard: {
                name: "COURTYARD",
                description: function() {
                    let desc = "A desolate COURTYARD surrounded by crumbling stone WALLS. Dead VINES cling to the walls. There's a broken marble FOUNTAIN with murky WATER.";
                    if (this.items.includes('torch')) {
                        desc += " A TORCH is propped against the wall.";
                    } else {
                        desc += " The wall is bare where the torch once rested.";
                    }
                    desc += " Heavy wooden DOORS lead north and west. A PATH leads back south. The dark SKY hangs low overhead.";
                    return desc;
                },
                items: ["torch"],
                exits: {
                    north: "armory",
                    south: "entrance",
                    east: null,
                    west: "guardroom"
                },
                visited: false,
                enemy: null
            },
            // In the locations object
armory: {
    name: "ARMORY",
    description: function() {
        let desc = "An ancient ARMORY filled with rusted suits of ARMOR and WEAPONS on RACKS. Dense SHADOWS fill the corners.";
        
        if (!gameState.chestOpened) {
            desc += " A large CHEST sits in the corner.";
        } else {
            // Chest is opened
            const chestItems = [];
            if (this.items.includes('silver medallion')) chestItems.push("silver MEDALLION");
            if (this.items.includes('rusty sword')) chestItems.push("RUSTY SWORD");
            
            if (chestItems.length > 0) {
                desc += " The open CHEST reveals ";
                if (chestItems.length === 1) {
                    desc += `a ${chestItems[0]} inside.`;
                } else {
                    desc += `a ${chestItems[0]} and a ${chestItems[1]} inside.`;
                }
            } else {
                desc += " The CHEST sits open and empty.";
            }
        }
        
        desc += " The door to the south leads back to the COURTYARD.";
        return desc;
    },
    items: [],
    exits: {
        south: "courtyard",
        north: null,
        east: null,
        west: null
    },
    visited: false,
    enemy: null
},
            guardroom: {
                name: "GUARD ROOM",
                description: function() {
                    let desc = "A GUARD ROOM with a rough wooden TABLE and CHAIRS. A cold FIREplace stands against one wall.";
                    
                    if (!gameState.enemyDefeated) {
                        desc += " A skeletal guard SKELETON stands motionless in the center of the room.";
                    } else if (this.items.includes('silver medallion')) {
                        desc += " Where the skeleton fell, a silver MEDALLION lies on the floor.";
                    } else {
                        desc += " The spot where the skeleton stood is now empty.";
                    }
                    
                    desc += " The door to the east leads back to the COURTYARD.";
                    if (gameState.secretRevealed) {
                        desc += " A dark PASSAGE is now visible to the north.";
                    }
                    return desc;
                },
                items: [],
                exits: {
                    east: "courtyard",
                    north: "secretchamber",
                    south: null,
                    west: null
                },
                visited: false,
                enemy: "skeleton"  // This location has an enemy
            },
            secretchamber: {
                name: "SECRET CHAMBER",
                description: function() {
                    let desc = "A hidden chamber revealed by moving the CRYPT wall.";
                    if (gameState.torchLit) {
                        desc += " Piles of TREASURE glitter in your torchlight.";
                    } else {
                        desc += " It's too dark to see much.";
                    }
                    
                    desc += " Ancient INSCRIPTIONS cover the walls.";
                    
                    if (!gameState.ghostGone) {
                        desc += " The GHOST of an old man floats near the ALTAR.";
                    } else {
                        desc += " Where the ghost once stood, a new PASSAGE has opened in the north wall.";
                    }
                    
                    desc += " The passage south leads back to the GUARD ROOM.";
                    return desc;
                },
                items: [],
                exits: {
                    south: "guardroom",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            },
            treasureroom: {
                name: "TREASURE VAULT",
                description: function() {
                    let desc = "The FINAL TREASURE VAULT! Mountains of GOLD COINS, glittering JEWELS, and ancient ARTIFACTS fill this room.";
                    desc += " In the center stands a magnificent DIAMOND CROWN on a velvet cushion.";
                    desc += " You have found the legendary treasure of the Castle of the Dammed!";
                    return desc;
                },
                items: ["diamond crown"],
                exits: {
                    south: "secretchamber",
                    north: null,
                    east: null,
                    west: null
                },
                visited: false,
                enemy: null
            }
        };

        // Game commands
        const commands = {
            'north': 'north',
            'n': 'north',
            'south': 'south',
            's': 'south',
            'east': 'east',
            'e': 'east',
            'west': 'west',
            'w': 'west',
            'look': 'look',
            'l': 'look',
            'inventory': 'inventory',
            'i': 'inventory',
            'take': 'take',
            'get': 'take',
            'grab': 'take',
            'drop': 'drop',
            'examine': 'examine',
            'x': 'examine',
            'use': 'use',
            'open': 'open',
            'read': 'read',
            'talk': 'talk',
            'speak': 'talk',
            'ask': 'talk',
            'give': 'give',
            'attack': 'attack',
            'fight': 'attack',
            'kill': 'attack',
            'light': 'light',
            'help': 'help',
            'h': 'help',
            'quit': 'quit',
            'q': 'quit'
        };

        // DOM elements
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');

        // Initialize game
        function initGame() {
            gameOutput.innerHTML = '';
            addToOutput("CASTLE OF THE DAMMED", "title");
            addToOutput("1982 Text Adventure - COMBAT EDITION", "subtitle");
            addToOutput(" ");
            addToOutput("You are an adventurer seeking the legendary treasures of the Castle of the Dammed.", "story");
            addToOutput("Equipped only with your FISTS (4-6 damage), you must survive the castle's dangers.", "story");
            addToOutput(" ");
            addToOutput("Type HELP for commands, LOOK to examine your surroundings.", "hint");
            addToOutput(" ");
            updateStatus();
            showLocation();
            
            gameInput.focus();
            
            gameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                }
            });
        }

        // Add text to game output
        function addToOutput(text, className = '') {
            const p = document.createElement('p');
            p.textContent = text;
            if (className) {
                p.className = className;
            }
            gameOutput.appendChild(p);
            
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        // Show current location
        function showLocation() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            if (!loc.visited) {
                loc.visited = true;
                gameState.visitedLocations.push(gameState.currentLocation);
            }
            
            // Start combat if there's an enemy and it's not defeated
            if (loc.enemy && !gameState.enemyDefeated && gameState.currentLocation === 'guardroom') {
                if (!combatActive) {
                    startCombat(loc.enemy);
                }
            }
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Process player command
        function processCommand(input) {
            if (gameState.gameEnded) {
                addToOutput("The game has ended. Refresh the page to play again.", "hint");
                return;
            }
            
            const command = input.trim().toLowerCase();
            if (!command) return;
            
            const parts = command.split(' ');
            const verb = parts[0];
            const object = parts.slice(1).join(' ');
            
            if (!commands[verb]) {
                addToOutput(`I don't understand "${verb}".`);
                return;
            }
            
            const action = commands[verb];
            
            switch(action) {
                case 'north':
                case 'south':
                case 'east':
                case 'west':
                    movePlayer(action);
                    break;
                case 'look':
                    lookAround();
                    break;
                case 'inventory':
                    showInventory();
                    break;
                case 'take':
                    takeItem(object);
                    break;
                case 'drop':
                    dropItem(object);
                    break;
                case 'examine':
                    examineObject(object);
                    break;
                case 'use':
                    useItem(object);
                    break;
                case 'open':
                    openObject(object);
                    break;
                case 'read':
                    readObject(object);
                    break;
                case 'talk':
                    talkTo(object);
                    break;
                case 'give':
                    giveItem(object);
                    break;
                case 'attack':
                    if (combatActive) {
                        playerAttack();
                    } else {
                        attackEnemy(object);
                    }
                    break;
                case 'light':
                    lightTorch();
                    break;
                case 'help':
                    showHelp();
                    break;
                case 'quit':
                    quitGame();
                    break;
                default:
                    addToOutput(`Command "${verb}" not implemented yet.`);
            }
        }

        // Move player
        function movePlayer(direction) {
            if (combatActive) {
                addToOutput("You can't run from combat! You must FIGHT!", "combat");
                return;
            }
            
            const currentLoc = locations[gameState.currentLocation];
            const newLocation = currentLoc.exits[direction];
            
            if (!newLocation) {
                addToOutput(`You can't go ${direction}.`);
                return;
            }
            
            if (currentLoc.name === "GUARD ROOM" && direction === 'north' && !gameState.enemyDefeated) {
                addToOutput("The skeletal guard blocks your path! You must DEFEAT it first!", "enemy");
                return;
            }
            
            if (newLocation === 'secretchamber' && !gameState.secretRevealed) {
                addToOutput("There's no exit in that direction.");
                return;
            }
            
            if (newLocation === 'treasureroom' && !gameState.ghostGone) {
                addToOutput("There's no exit in that direction.");
                return;
            }
            
            gameState.currentLocation = newLocation;
            addToOutput(`You go ${direction}.`);
            showLocation();
            
            // Check for game completion
            if (newLocation === 'treasureroom') {
                addToOutput(" ");
                addToOutput("*** CONGRATULATIONS! ***", "title");
                addToOutput("You have completed CASTLE OF THE DAMMED!", "story");
                addToOutput("You found the legendary treasure and survived!", "story");
                addToOutput(" ");
                addToOutput("GAME OVER", "location");
                gameState.gameEnded = true;
            }
        }

        // Look around
        function lookAround() {
            const loc = locations[gameState.currentLocation];
            
            addToOutput(loc.name, "location");
            
            const description = loc.description();
            addToOutput(description);
            
            const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
            if (exits.length > 0) {
                addToOutput("Exits: " + exits.map(exit => exit.toUpperCase()).join(", "));
            }
        }

        // Show inventory
        function showInventory() {
            if (gameState.inventory.length === 0) {
                addToOutput("You are carrying nothing.");
            } else {
                addToOutput("You are carrying: " + gameState.inventory.map(item => item.toUpperCase()).join(", "));
                if (gameState.torchLit) {
                    addToOutput("(Your torch is LIT)");
                }
            }
            addToOutput(`Equipped weapon: ${player.weapon.name} (${player.weapon.minDamage}-${player.weapon.maxDamage} damage)`, "player");
            addToOutput(`HP: ${player.currentHP}/${player.maxHP}`, "health");
        }

        // Take item - updated section for weapons
function takeItem(itemName) {
    if (!itemName) {
        addToOutput("Take what?");
        return;
    }
    
    const loc = locations[gameState.currentLocation];
    const itemIndex = loc.items.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
    
    if (itemIndex === -1) {
        addToOutput(`I don't see a ${itemName} here.`);
        return;
    }
    
    const item = loc.items[itemIndex];
    
    // Special handling for weapons
    if (item === "rusty sword") {
        loc.items.splice(itemIndex, 1); // Remove from room items
        addToOutput(`You take the rusty sword and equip it! (Damage: 6-10)`);
        player.weapon = {
            name: "Rusty Sword",
            minDamage: 6,
            maxDamage: 10
        };
        updateStatus();
    } else {
        loc.items.splice(itemIndex, 1);
        gameState.inventory.push(item);
        addToOutput(`You take the ${item}.`);
    }
    
    // If taking the crown, complete the game
    if (item === "diamond crown") {
        gameState.treasureFound = true;
        addToOutput(" ");
        addToOutput("You hold the Diamond Crown of Kings! The treasure is yours!", "title");
    }
}

        // Drop item
        function dropItem(itemName) {
            if (!itemName) {
                addToOutput("Drop what?");
                return;
            }
            
            const itemIndex = gameState.inventory.findIndex(item => item.toLowerCase().includes(itemName.toLowerCase()));
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            // Can't drop equipped weapon
            if (item === "rusty sword" && player.weapon.name === "Rusty Sword") {
                addToOutput("You can't drop your equipped weapon! You need it for combat.");
                return;
            }
            
            gameState.inventory.splice(itemIndex, 1);
            locations[gameState.currentLocation].items.push(item);
            
            addToOutput(`You drop the ${item}.`);
        }

        // Examine object
        function examineObject(objectName) {
            if (!objectName) {
                addToOutput("Examine what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // Check for weapons first
            if (objectLower.includes("fist") || objectLower.includes("hand")) {
                addToOutput(objectDescriptions["fists"]);
                return;
            }
            
            if (objectLower.includes("rusty sword")) {
                addToOutput(objectDescriptions["rusty sword"]);
                return;
            }
            
            if (objectLower.includes("mace")) {
                addToOutput(objectDescriptions["ancient mace"]);
                return;
            }
            
            // Rest of the examine function remains the same...
            if (objectLower === "torch" && gameState.torchLit) {
                addToOutput("The torch burns brightly, casting flickering shadows.");
                return;
            }
            
            const inventoryItem = gameState.inventory.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (inventoryItem) {
                if (objectDescriptions[inventoryItem]) {
                    addToOutput(objectDescriptions[inventoryItem]);
                } else {
                    addToOutput(`You examine the ${inventoryItem}. It's in your inventory.`);
                }
                return;
            }
            
            const loc = locations[gameState.currentLocation];
            const locationItem = loc.items.find(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (locationItem) {
                if (objectDescriptions[locationItem]) {
                    addToOutput(objectDescriptions[locationItem]);
                } else {
                    addToOutput(`You examine the ${locationItem}.`);
                }
                return;
            }
            
            if (objectDescriptions[objectLower]) {
                addToOutput(objectDescriptions[objectLower]);
                return;
            }
            
            for (const [objKey, description] of Object.entries(objectDescriptions)) {
                if (objKey.includes(objectLower) || objectLower.includes(objKey)) {
                    addToOutput(description);
                    return;
                }
            }
            
            if (['north', 'south', 'east', 'west'].includes(objectLower)) {
                const loc = locations[gameState.currentLocation];
                const exits = Object.keys(loc.exits).filter(exit => loc.exits[exit] !== null);
                if (exits.includes(objectLower)) {
                    addToOutput(`You look ${objectLower}. You can go that way.`);
                } else {
                    addToOutput(`You look ${objectLower}. You cannot go that way.`);
                }
                return;
            }
            
            addToOutput(`You don't see a ${objectName} here.`);
        }

        // Use item
        function useItem(objectName) {
            if (!objectName) {
                addToOutput("Use what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            const itemIndex = gameState.inventory.findIndex(item => 
                item.toLowerCase().includes(objectLower)
            );
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${objectName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            // Using weapons (equip them)
            if (item === "rusty sword" && player.weapon.name !== "Rusty Sword") {
                player.weapon = {
                    name: "Rusty Sword",
                    minDamage: 6,
                    maxDamage: 10
                };
                addToOutput("You equip the rusty sword! (Damage: 6-10)", "player");
                updateStatus();
                return;
            }
            
            // Use item - updated chest opening section
if (item === "rusty key" && gameState.currentLocation === "armory" && 
    (objectLower.includes("chest") || objectLower.includes("key"))) {
    
    if (gameState.chestOpened) {
        addToOutput("The chest is already open.");
    } else {
        addToOutput("You use the rusty key on the chest. It turns with a loud CLICK!");
        addToOutput("The chest opens!", "item");
        gameState.chestOpened = true;
        // Add items to the chest
        locations.armory.items.push("silver medallion");
        locations.armory.items.push("rusty sword");
    }
    return;
}
            
            if (item === "torch" && gameState.torchLit && 
                gameState.currentLocation === "secretchamber" && 
                objectLower.includes("inscription")) {
                
                addToOutput("You hold the torch close to the inscriptions. They glow brighter!");
                addToOutput("The inscriptions reveal a secret: 'Only the worthy may pass'.");
                return;
            }
            
            addToOutput(`You're not sure how to use the ${item} here.`);
        }

        // Open object
        function openObject(objectName) {
            if (!objectName) {
                addToOutput("Open what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("chest") && gameState.currentLocation === "armory") {
                if (gameState.inventory.includes("rusty key")) {
                    if (gameState.chestOpened) {
                        addToOutput("The chest is already open.");
                    } else {
                        addToOutput("You use your rusty key to open the chest.");
                        addToOutput("Inside, you find a silver medallion and a rusty sword!", "item");
                        gameState.chestOpened = true;
                        locations.armory.items.push("silver medallion");
                        locations.armory.items.push("rusty sword");
                    }
                } else {
                    addToOutput("The chest is locked. You need a key.");
                }
                return;
            }
            
            addToOutput(`You can't open the ${objectName}.`);
        }

        // Read object
        function readObject(objectName) {
            if (!objectName) {
                addToOutput("Read what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("inscription") && gameState.currentLocation === "secretchamber") {
                if (gameState.torchLit) {
                    addToOutput("The inscriptions read: 'Here lies the guardian of secrets. Only with the silver token may passage be granted.'");
                } else {
                    addToOutput("It's too dark to read the inscriptions. You need light.");
                }
                return;
            }
            
            addToOutput(`There's nothing to read on the ${objectName}.`);
        }

        // Talk to NPC
        function talkTo(objectName) {
            if (!objectName) {
                addToOutput("Talk to who?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            if (objectLower.includes("ghost") && gameState.currentLocation === "secretchamber" && gameState.secretRevealed) {
                if (!gameState.hasTalkedToGhost) {
                    addToOutput("The ghost speaks in a whispery voice: 'I am the guardian of this chamber. For centuries I have waited...'", "npc");
                    addToOutput("'The skeletal guard holds a silver medallion. Bring it to me, and I shall reveal the true treasure.'", "npc");
                    gameState.hasTalkedToGhost = true;
                } else if (!gameState.ghostGone) {
                    addToOutput("The ghost repeats: 'Bring me the silver medallion from the skeletal guard.'", "npc");
                }
                return;
            }
            
            if ((objectLower.includes("skeleton") || objectLower.includes("guard")) && 
                gameState.currentLocation === "guardroom" && !gameState.enemyDefeated) {
                addToOutput("The skeletal guard doesn't speak. It only raises its rusted sword menacingly.", "enemy");
                return;
            }
            
            addToOutput("There's no one here to talk to.");
        }

        // Give item
        function giveItem(objectName) {
            if (!objectName) {
                addToOutput("Give what to whom?");
                return;
            }
            
            const parts = objectName.split(' to ');
            if (parts.length < 2) {
                addToOutput("Give what to whom? Try: GIVE MEDALLION TO GHOST");
                return;
            }
            
            const itemName = parts[0].trim().toLowerCase();
            const recipient = parts[1].trim().toLowerCase();
            
            const itemIndex = gameState.inventory.findIndex(item => 
                item.toLowerCase().includes(itemName)
            );
            
            if (itemIndex === -1) {
                addToOutput(`You're not carrying a ${itemName}.`);
                return;
            }
            
            const item = gameState.inventory[itemIndex];
            
            if (item === "silver medallion" && recipient.includes("ghost") && 
                gameState.currentLocation === "secretchamber" && gameState.secretRevealed) {
                
                addToOutput("You give the silver medallion to the ghost.", "npc");
                addToOutput("The ghost takes the medallion and smiles. 'At last! The guardian is appeased.'", "npc");
                addToOutput("The ghost fades away, and as he does, a section of the wall slides open!", "npc");
                addToOutput("A new passage is revealed to the NORTH!", "npc");
                
                // Add the new exit to the treasure room
                locations.secretchamber.exits.north = "treasureroom";
                gameState.ghostGone = true;
                
                gameState.inventory.splice(itemIndex, 1);
                return;
            }
            
            addToOutput(`You can't give the ${item} to ${recipient}.`);
        }

        // Attack enemy (non-combat context)
        function attackEnemy(objectName) {
            if (!objectName) {
                addToOutput("Attack what?");
                return;
            }
            
            const objectLower = objectName.toLowerCase();
            
            // If combat is active, the attack command is handled by playerAttack()
            if (combatActive) {
                playerAttack();
                return;
            }
            
            // Original attack code for non-combat context
            if ((objectLower.includes("skeleton") || objectLower.includes("guard")) && 
                gameState.currentLocation === "guardroom" && !gameState.enemyDefeated) {
                
                startCombat("skeleton");
                return;
            }
            
            addToOutput("There's nothing to attack here.");
        }

        // Light torch
        function lightTorch() {
            if (!gameState.inventory.includes("torch")) {
                addToOutput("You don't have a torch to light.");
                return;
            }
            
            if (gameState.torchLit) {
                addToOutput("Your torch is already lit.");
            } else {
                addToOutput("You light the torch. It casts a warm, flickering light.");
                gameState.torchLit = true;
            }
        }

        // Show help
        function showHelp() {
            addToOutput("CASTLE OF THE DAMMED - COMMANDS", "location");
            addToOutput("Movement: NORTH, SOUTH, EAST, WEST (or N, S, E, W)");
            addToOutput("Basic: LOOK, EXAMINE [object], TAKE [item], DROP [item], INVENTORY");
            addToOutput("Interactive: USE [item], OPEN [object], READ [object]");
            addToOutput("Social: TALK TO [character], GIVE [item] TO [character]");
            addToOutput("COMBAT: ATTACK (in combat)", "combat");
            addToOutput("Special: LIGHT (torch)");
            addToOutput("System: HELP, QUIT");
            addToOutput(" ");
            addToOutput("Your HP is shown at the top. If it reaches 0, game over!", "health");
            addToOutput("Find better weapons to deal more damage in combat!", "hint");
        }

        // Quit game
        function quitGame() {
            addToOutput("Are you sure you want to quit? (Y/N)");
            
            const originalEventHandler = gameInput.onkeypress;
            
            gameInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    const answer = this.value.trim().toLowerCase();
                    if (answer === 'y' || answer === 'yes') {
                        addToOutput("Thanks for playing Castle of the Dammed!");
                        gameState.gameEnded = true;
                    } else {
                        addToOutput("Resuming game...");
                    }
                    
                    gameInput.onkeypress = originalEventHandler;
                    gameInput.value = '';
                    gameInput.focus();
                }
            };
        }

        window.onload = initGame;
    </script>
</body>
</html>
