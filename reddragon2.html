<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legend of the Red Dragon (1989) - Atari Edition</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #000;
            color: #fff;
            line-height: 1.4;
            padding: 10px;
            max-width: 900px;
            margin: 0 auto;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(40, 0, 0, 0.9) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 20, 40, 0.9) 0%, transparent 20%);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .game-container {
            border: 4px double #fff;
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.85);
            box-shadow: 0 0 0 1px #333, 0 0 20px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* Scanline effect */
        .game-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%, 
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% 4px;
            z-index: 2;
            pointer-events: none;
        }
        
        h1 {
            color: #ff3355;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            font-size: 2rem;
            border-bottom: 2px dotted #666;
            padding-bottom: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        h2 {
            color: #ff3355;
            margin: 15px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px dashed #666;
            font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000;
        }
        
        h3 {
            color: #ffaa00;
            margin: 10px 0;
            font-size: 1rem;
        }
        
        .screen {
            display: none;
            min-height: 400px;
        }
        
        .active-screen {
            display: block;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: #222;
            padding: 10px;
            border: 2px solid #fff;
            margin-bottom: 20px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .status-item {
            margin: 5px 10px;
            color: #ff3355;
            text-shadow: 1px 1px 0 #000;
        }
        
        .status-value {
            color: #fff;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 1.2rem;
        }
        
        .menu {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
            margin: 20px 0;
        }
        
        .menu-option {
            background-color: #333;
            border: 2px solid #fff;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.1s;
            text-align: center;
            color: #ff3355;
            text-shadow: 1px 1px 0 #000;
            font-size: 12px;
        }
        
        .menu-option:hover {
            background-color: #444;
            border-color: #ffaa00;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #000;
            color: #fff;
        }
        
        .menu-option:active {
            transform: translateY(0);
            box-shadow: 0 0 0 #000;
        }
        
        .menu-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .combat-log {
            background-color: #111;
            border: 2px solid #fff;
            padding: 15px;
            height: 220px;
            overflow-y: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            color: #fff;
            font-size: 13px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            line-height: 1.6;
        }
        
        .character-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .character-stat {
            background-color: #222;
            padding: 12px;
            border-left: 4px solid #ffaa00;
            border-bottom: 2px solid #444;
            color: #ff3355;
        }
        
        .stat-value {
            color: #fff;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 1.2rem;
        }
        
        button {
            background-color: #333;
            color: #ffaa00;
            border: 2px solid #fff;
            padding: 12px 24px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            margin: 8px;
            transition: all 0.1s;
            text-shadow: 1px 1px 0 #000;
        }
        
        button:hover {
            background-color: #444;
            border-color: #ffaa00;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #000;
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 0 0 #000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: #666;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #ff3355;
            font-size: 12px;
        }
        
        input, select {
            background-color: #222;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px;
            width: 100%;
            max-width: 350px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }
        
        .inn-scene {
            background-color: #222;
            border: 2px solid #fff;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .inn-image {
            font-size: 3.5rem;
            margin: 10px 0;
            color: #ffaa00;
            text-shadow: 3px 3px 0 #000;
        }
        
        .inn-text {
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px dashed #666;
            margin-top: 15px;
        }
        
        .monster {
            color: #ff3355;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        
        .player {
            color: #44ff88;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        
        .gold {
            color: #ffaa00;
            font-weight: bold;
        }
        
        .xp {
            color: #44ff88;
            font-weight: bold;
        }
        
        .damage {
            color: #ff3355;
        }
        
        .heal {
            color: #44ff88;
        }
        
        .quest {
            color: #ffaa00;
        }
        
        .item {
            color: #44aaff;
        }
        
        .game-over {
            color: #ff3355;
            text-align: center;
            font-size: 2.5rem;
            margin: 30px 0;
            text-shadow: 4px 4px 0 #000;
            animation: pulse 1.5s infinite;
        }
        
        .victory {
            color: #ffaa00;
            text-align: center;
            font-size: 2.5rem;
            margin: 30px 0;
            text-shadow: 4px 4px 0 #000;
            animation: glow 2s infinite alternate;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 10px;
            border-top: 1px dashed #444;
            padding-top: 15px;
            font-family: 'Courier New', monospace;
        }
        
        /* CRT monitor curvature effect */
        .crt-curve {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
            background: radial-gradient(
                ellipse at center,
                rgba(0,0,0,0) 0%,
                rgba(0,0,0,0) 60%,
                rgba(0,0,0,0.3) 100%
            );
        }
        
        /* Blinking cursor effect */
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes glow {
            from { text-shadow: 4px 4px 0 #000, 0 0 10px #ffaa00; }
            to { text-shadow: 4px 4px 0 #000, 0 0 20px #ffaa00, 0 0 30px #ffaa00; }
        }
        
        /* Pixel art dividers */
        .divider {
            height: 2px;
            background-color: #fff;
            margin: 20px 0;
            position: relative;
        }
        
        .divider::before, .divider::after {
            content: "‚óÜ";
            position: absolute;
            top: -10px;
            color: #ffaa00;
            font-size: 20px;
            background-color: #000;
            padding: 0 10px;
        }
        
        .divider::before {
            left: 20px;
        }
        
        .divider::after {
            right: 20px;
        }
        
        /* Store items styling */
        .store-item {
            background-color: #222;
            border: 2px solid #666;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .store-item:hover {
            border-color: #ffaa00;
            background-color: #333;
        }
        
        .item-price {
            color: #ffaa00;
            float: right;
            font-size: 12px;
        }
        
        /* Quest items */
        .quest-item {
            background-color: #1a2a1a;
            border: 2px solid #44ff88;
            padding: 12px;
            margin: 8px 0;
            position: relative;
        }
        
        .quest-item.completed {
            background-color: #1a2a2a;
            border-color: #44aaff;
            opacity: 0.7;
        }
        
        .quest-reward {
            color: #ffaa00;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .quest-progress {
            background-color: #333;
            height: 8px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .quest-progress-bar {
            background-color: #44ff88;
            height: 100%;
            transition: width 0.3s;
        }
        
        /* Exploration areas */
        .area {
            background-color: #222;
            border: 2px solid #666;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .area:hover {
            border-color: #ffaa00;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #000;
        }
        
        .area-description {
            color: #aaa;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .area-level {
            color: #ff3355;
            float: right;
            font-size: 11px;
        }
        
        /* Found items display */
        .found-item {
            background-color: #2a2a4a;
            border: 1px solid #44aaff;
            padding: 10px;
            margin: 5px 0;
            font-size: 11px;
        }
        
        /* Skill system styles */
        .skill-item {
            background-color: #2a1a2a;
            border: 2px solid #ff44aa;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .skill-item:hover {
            border-color: #ffaa00;
            background-color: #3a2a3a;
        }
        
        .skill-item.unlocked {
            background-color: #1a2a1a;
            border-color: #44ff88;
        }
        
        .skill-level {
            color: #ffaa00;
            float: right;
            font-size: 11px;
        }
        
        .skill-description {
            color: #aaa;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .skill-cost {
            color: #44aaff;
            font-size: 10px;
            margin-top: 5px;
        }
        
        /* Dungeon styles */
        .dungeon-floor {
            background-color: #1a1a2a;
            border: 2px solid #666;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dungeon-floor:hover {
            border-color: #ffaa00;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 #000;
        }
        
        .dungeon-floor.completed {
            background-color: #1a2a1a;
            border-color: #44ff88;
            opacity: 0.7;
        }
        
        .dungeon-floor.current {
            background-color: #2a1a1a;
            border-color: #ff3355;
            animation: pulse 2s infinite;
        }
        
        .dungeon-floor.locked {
            background-color: #1a1a1a;
            border-color: #666;
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .floor-info {
            color: #aaa;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .floor-reward {
            color: #ffaa00;
            font-size: 10px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .menu {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            body {
                font-size: 12px;
            }
        }
        
        /* Pixel border effect */
        .pixel-border {
            position: relative;
            border: 2px solid #fff;
        }
        
        .pixel-border::before {
            content: "";
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 2px solid #666;
            z-index: -1;
        }
        
        /* Class icons */
        .class-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #ffaa00;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .fighter-icon { background-color: #ff3355; }
        .mage-icon { background-color: #44aaff; }
        .thief-icon { background-color: #44ff88; }
        
        /* Story quest styles */
        .story-chapter {
            background-color: #2a1a1a;
            border-left: 4px solid #ff3355;
            padding: 15px;
            margin: 10px 0;
        }
        
        .story-chapter.completed {
            background-color: #1a2a1a;
            border-left-color: #44ff88;
            opacity: 0.8;
        }
        
        .story-chapter.current {
            background-color: #2a2a1a;
            border-left-color: #ffaa00;
            animation: pulse 3s infinite;
        }
        
        .story-chapter.locked {
            background-color: #1a1a1a;
            border-left-color: #666;
            opacity: 0.5;
        }
        
        .chapter-reward {
            color: #ffaa00;
            font-size: 10px;
            margin-top: 5px;
        }
        
        /* Dungeon unlock message */
        .unlock-message {
            background-color: #2a2a1a;
            border: 2px solid #ffaa00;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="crt-curve"></div>
    
    <div class="game-container">
        <h1>LEGEND OF THE RED DRAGON</h1>
        <div class="divider"></div>
        
        <div class="status-bar pixel-border">
            <div class="status-item">DAY: <span class="status-value" id="dayCount">1</span></div>
            <div class="status-item">HP: <span class="status-value" id="health">100</span>/<span class="status-value" id="maxHealth">100</span></div>
            <div class="status-item">GOLD: <span class="status-value" id="gold">50</span></div>
            <div class="status-item">XP: <span class="status-value" id="xp">0</span></div>
            <div class="status-item">LVL: <span class="status-value" id="level">1</span></div>
            <div class="status-item">QUESTS: <span class="status-value" id="questCount">0</span></div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="creationScreen" class="screen active-screen">
            <h2>CHARACTER CREATION</h2>
            <p>WELCOME TO THE VILLAGE OF NODINGTON. A GREAT EVIL HAS AWAKENED IN THE FOREST. THE RED DRAGON THREATENS OUR LANDS.</p>
            <p>YOU MUST PREPARE YOURSELF FOR THE BATTLES AHEAD.</p>
            
            <div class="input-group">
                <label for="playerName">YOUR NAME:</label>
                <input type="text" id="playerName" placeholder="ENTER YOUR NAME" value="SIR LANCELOT">
            </div>
            
            <div class="input-group">
                <label for="playerClass">CHOOSE YOUR CLASS:</label>
                <select id="playerClass">
                    <option value="fighter">FIGHTER - STRONG AND TOUGH</option>
                    <option value="mage">MAGE - POWERFUL SPELLS</option>
                    <option value="thief">THIEF - QUICK AND EVASIVE</option>
                </select>
            </div>
            
            <div class="character-info">
                <div class="character-stat">
                    <strong>STRENGTH:</strong>
                    <span class="stat-value" id="strStat">10</span>
                </div>
                <div class="character-stat">
                    <strong>AGILITY:</strong>
                    <span class="stat-value" id="agiStat">10</span>
                </div>
                <div class="character-stat">
                    <strong>MAGIC:</strong>
                    <span class="stat-value" id="magStat">10</span>
                </div>
                <div class="character-stat">
                    <strong>HEALTH:</strong>
                    <span class="stat-value" id="hpStat">100</span>
                </div>
            </div>
            
            <p>YOU HAVE <span id="statPoints" class="stat-value">5</span> POINTS TO DISTRIBUTE.</p>
            
            <div class="menu">
                <div class="menu-option" onclick="increaseStat('str')">
                    <span class="class-icon fighter-icon"></span> INCREASE STRENGTH
                </div>
                <div class="menu-option" onclick="increaseStat('agi')">
                    <span class="class-icon thief-icon"></span> INCREASE AGILITY
                </div>
                <div class="menu-option" onclick="increaseStat('mag')">
                    <span class="class-icon mage-icon"></span> INCREASE MAGIC
                </div>
                <div class="menu-option" onclick="resetStats()">RESET POINTS</div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="completeCharacterCreation()">BEGIN YOUR ADVENTURE</button>
            </div>
        </div>
        
        <!-- Town Screen -->
        <div id="townScreen" class="screen">
            <h2>THE TOWN OF NODINGTON</h2>
            <p>YOU STAND IN THE CENTER OF NODINGTON. THE SUN IS HIGH IN THE SKY. YOU HAVE TIME FOR ONE ACTIVITY TODAY.</p>
            
            <div class="menu">
                <div class="menu-option" onclick="goToExploration()">EXPLORE THE REGION</div>
                <div class="menu-option" onclick="goToForest()">ENTER THE FOREST</div>
                <div class="menu-option" onclick="goToDungeons()">ENTER DUNGEONS</div>
                <div class="menu-option" onclick="goToInn()">VISIT THE INN</div>
                <div class="menu-option" onclick="goToStore()">VISIT THE STORE</div>
                <div class="menu-option" onclick="goToQuests()">CHECK QUESTS</div>
                <div class="menu-option" onclick="goToSkills()">SKILL TREE</div>
                <div class="menu-option" onclick="goToStats()">CHECK STATS</div>
                <div class="menu-option" onclick="goToStory()">MAIN STORY</div>
                <div class="menu-option" onclick="saveGame()">SAVE GAME</div>
                <div class="menu-option" onclick="endDay()">REST FOR THE DAY</div>
            </div>
            
            <div id="townMessage" style="margin-top: 20px; padding: 15px; background-color: #222; border: 1px dashed #666;"></div>
        </div>
        
        <!-- Exploration Screen -->
        <div id="explorationScreen" class="screen">
            <h2>EXPLORE THE REGION</h2>
            <p>CHOOSE A LOCATION TO EXPLORE. EACH AREA HOLDS DIFFERENT CHALLENGES AND REWARDS.</p>
            
            <div class="menu">
                <div class="area" onclick="exploreArea('haunted_woods')">
                    <strong>HAUNTED WOODS <span class="area-level">LEVEL 1-3</span></strong>
                    <div class="area-description">A DENSE, MYSTERIOUS FOREST RUMORED TO BE HAUNTED BY LOST SPIRITS.</div>
                </div>
                
                <div class="area" onclick="exploreArea('crystal_caves')" id="crystalCavesArea" style="display: none;">
                    <strong>CRYSTAL CAVES <span class="area-level">LEVEL 2-4</span></strong>
                    <div class="area-description">GLOWING CAVES FILLED WITH PRECIOUS GEMS AND DANGEROUS CREATURES.</div>
                </div>
                
                <div class="area" onclick="exploreArea('ancient_ruins')" id="ancientRuinsArea" style="display: none;">
                    <strong>ANCIENT RUINS <span class="area-level">LEVEL 3-5</span></strong>
                    <div class="area-description">RUINS OF A FORGOTTEN CIVILIZATION, RUMORED TO HOLD POWERFUL ARTIFACTS.</div>
                </div>
                
                <div class="area" onclick="exploreArea('dragons_peak')" id="dragonsPeakArea" style="display: none;">
                    <strong>DRAGON'S PEAK <span class="area-level">LEVEL 5+</span></strong>
                    <div class="area-description">THE LAIR OF THE RED DRAGON. ONLY FOR THE BRAVEST ADVENTURERS.</div>
                </div>
                
                <div class="area" onclick="exploreArea('mystic_lake')" id="mysticLakeArea" style="display: none;">
                    <strong>MYSTIC LAKE <span class="area-level">LEVEL 2-3</span></strong>
                    <div class="area-description">A SERENE LAKE WITH MAGICAL PROPERTIES AND AQUATIC CREATURES.</div>
                </div>
            </div>
            
            <div id="explorationResult" class="combat-log" style="height: 180px; margin-top: 20px;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
                <button onclick="continueExploring()" id="continueExploreButton" style="display: none;">CONTINUE EXPLORING</button>
            </div>
        </div>
        
        <!-- Forest Screen -->
        <div id="forestScreen" class="screen">
            <h2>THE DARK FOREST</h2>
            <p>YOU VENTURE INTO THE DARK FOREST, WHERE DANGEROUS CREATURES LURK AMONG THE TREES.</p>
            
            <div id="combatLog" class="combat-log"></div>
            
            <div id="combatControls" style="text-align: center; margin: 20px 0;">
                <button onclick="attackMonster()">ATTACK</button>
                <button onclick="useSpell()" id="spellButton">CAST SPELL</button>
                <button onclick="useSkill()" id="skillButton">USE SKILL</button>
                <button onclick="usePotion()" id="potionButton">USE POTION</button>
                <button onclick="fleeCombat()">FLEE</button>
                <button onclick="goToTown()">RETURN TO TOWN</button>
            </div>
            
            <div id="monsterInfo" style="background-color: #222; padding: 15px; border: 2px solid #fff; margin-top: 20px;"></div>
        </div>
        
        <!-- Inn Screen -->
        <div id="innScreen" class="screen">
            <h2>THE PRANCING PONY INN</h2>
            <p>THE WARM ATMOSPHERE OF THE INN WELCOMES YOU. A FIRE CRACKLES IN THE HEARTH.</p>
            
            <div class="inn-scene pixel-border">
                <div class="inn-image">‚öîÔ∏è üçª üèÆ</div>
                <div class="inn-text">
                    <p id="innText">YOU SEE A MYSTERIOUS FIGURE IN THE CORNER. SHE LOOKS YOUR WAY AND SMILES.</p>
                </div>
            </div>
            
            <div class="menu">
                <div class="menu-option" onclick="innRest()">REST (10 GOLD)</div>
                <div class="menu-option" onclick="innChat()">CHAT WITH THE BARMAID</div>
                <div class="menu-option" onclick="innSpecial()">TALK TO THE MYSTERIOUS WOMAN</div>
                <div class="menu-option" onclick="innGamble()">PLAY DICE GAME (5 GOLD)</div>
                <div class="menu-option" onclick="getQuestFromInn()">LOOK FOR QUESTS</div>
                <div class="menu-option" onclick="goToTown()">LEAVE THE INN</div>
            </div>
            
            <div id="innResult" style="margin-top: 20px; padding: 15px; background-color: #222; border: 1px dashed #666;"></div>
        </div>
        
        <!-- Store Screen -->
        <div id="storeScreen" class="screen">
            <h2>BLACKSMITH'S SHOP</h2>
            <p>THE BLACKSMITH GREETS YOU WARMLY. "WHAT CAN I GET FOR YOU TODAY?"</p>
            
            <div style="margin: 20px 0;">
                <div class="store-item" onclick="buyItem('dagger', 30)">
                    <strong>IRON DAGGER</strong> <span class="item-price">30 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">DAMAGE: 5-12</div>
                </div>
                <div class="store-item" onclick="buyItem('sword', 100)">
                    <strong>STEEL SWORD</strong> <span class="item-price">100 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">DAMAGE: 8-18</div>
                </div>
                <div class="store-item" onclick="buyItem('armor', 80)">
                    <strong>LEATHER ARMOR</strong> <span class="item-price">80 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">DEFENSE: +3</div>
                </div>
                <div class="store-item" onclick="buyItem('potion', 20)">
                    <strong>HEALING POTION</strong> <span class="item-price">20 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">RESTORES 50 HP</div>
                </div>
                <div class="store-item" onclick="buyItem('shield', 60)">
                    <strong>WOODEN SHIELD</strong> <span class="item-price">60 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">DEFENSE: +2</div>
                </div>
                <div class="store-item" onclick="buyItem('map', 50)" id="mapItem">
                    <strong>EXPLORER'S MAP</strong> <span class="item-price">50 GOLD</span>
                    <div style="color: #aaa; font-size: 11px; margin-top: 5px;">UNLOCKS NEW AREAS</div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="goToTown()">LEAVE STORE</button>
            </div>
            
            <div id="storeMessage" style="margin-top: 20px; padding: 15px; background-color: #222; border: 1px dashed #666;"></div>
        </div>
        
        <!-- Quests Screen -->
        <div id="questsScreen" class="screen">
            <h2>ACTIVE QUESTS</h2>
            <p>YOUR CURRENT MISSIONS AND OBJECTIVES.</p>
            
            <div id="questsList" style="margin: 20px 0;">
                <!-- Quests will be dynamically added here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
                <button onclick="abandonAllQuests()">ABANDON ALL QUESTS</button>
            </div>
            
            <div id="questsMessage" style="margin-top: 20px; padding: 15px; background-color: #222; border: 1px dashed #666;"></div>
        </div>
        
        <!-- Skills Screen -->
        <div id="skillsScreen" class="screen">
            <h2>SKILL TREE</h2>
            <p>YOU HAVE <span id="skillPointsDisplay" class="stat-value">0</span> SKILL POINTS AVAILABLE.</p>
            
            <div id="skillsList" style="margin: 20px 0;">
                <!-- Skills will be dynamically added here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
                <button onclick="resetSkills()">RESET ALL SKILLS (100 GOLD)</button>
            </div>
        </div>
        
        <!-- Stats Screen -->
        <div id="statsScreen" class="screen">
            <h2>YOUR STATISTICS</h2>
            
            <div class="character-info">
                <div class="character-stat">
                    <strong>NAME:</strong>
                    <span class="stat-value" id="statName">SIR LANCELOT</span>
                </div>
                <div class="character-stat">
                    <strong>CLASS:</strong>
                    <span class="stat-value" id="statClass">FIGHTER</span>
                </div>
                <div class="character-stat">
                    <strong>LEVEL:</strong>
                    <span class="stat-value" id="statLevel">1</span>
                </div>
                <div class="character-stat">
                    <strong>XP:</strong>
                    <span class="stat-value" id="statXP">0</span>/<span class="stat-value" id="statNextXP">100</span>
                </div>
            </div>
            
            <div class="character-info">
                <div class="character-stat">
                    <strong>STRENGTH:</strong>
                    <span class="stat-value" id="statSTR">10</span>
                </div>
                <div class="character-stat">
                    <strong>AGILITY:</strong>
                    <span class="stat-value" id="statAGI">10</span>
                </div>
                <div class="character-stat">
                    <strong>MAGIC:</strong>
                    <span class="stat-value" id="statMAG">10</span>
                </div>
                <div class="character-stat">
                    <strong>HEALTH:</strong>
                    <span class="stat-value" id="statHP">100</span>/<span class="stat-value" id="statMaxHP">100</span>
                </div>
            </div>
            
            <div class="character-info">
                <div class="character-stat">
                    <strong>WEAPON:</strong>
                    <span class="stat-value" id="statWeapon">RUSTY DAGGER</span>
                </div>
                <div class="character-stat">
                    <strong>DAMAGE:</strong>
                    <span class="stat-value" id="statDamage">5-10</span>
                </div>
                <div class="character-stat">
                    <strong>ARMOR:</strong>
                    <span class="stat-value" id="statArmor">NONE</span>
                </div>
                <div class="character-stat">
                    <strong>GOLD:</strong>
                    <span class="stat-value" id="statGold">50</span>
                </div>
            </div>
            
            <div class="character-info">
                <div class="character-stat">
                    <strong>QUESTS COMPLETED:</strong>
                    <span class="stat-value" id="statQuestsCompleted">0</span>
                </div>
                <div class="character-stat">
                    <strong>MONSTERS SLAIN:</strong>
                    <span class="stat-value" id="statMonstersSlain">0</span>
                </div>
                <div class="character-stat">
                    <strong>AREAS EXPLORED:</strong>
                    <span class="stat-value" id="statAreasExplored">0</span>
                </div>
                <div class="character-stat">
                    <strong>DAYS SURVIVED:</strong>
                    <span class="stat-value" id="statDays">1</span>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
            </div>
        </div>
        
        <!-- Story Screen -->
        <div id="storyScreen" class="screen">
            <h2>MAIN STORY</h2>
            <p>THE EPIC TALE OF YOUR JOURNEY TO DEFEAT THE RED DRAGON.</p>
            
            <div id="storyProgress" style="margin: 20px 0;">
                <!-- Story chapters will be dynamically added here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
                <button onclick="claimStoryReward()" id="claimRewardButton" style="display: none;">CLAIM CHAPTER REWARD</button>
            </div>
            
            <div id="storyMessage" style="margin-top: 20px; padding: 15px; background-color: #222; border: 1px dashed #666;"></div>
        </div>
        
        <!-- Dungeons Screen -->
        <div id="dungeonsScreen" class="screen">
            <h2>DUNGEONS</h2>
            <p>TEST YOUR SKILLS IN THESE DANGEROUS DUNGEONS. EACH HAS MULTIPLE FLOORS AND A POWERFUL BOSS.</p>
            
            <div id="dungeonsList" style="margin: 20px 0;">
                <!-- Dungeons will be dynamically added here -->
            </div>
            
            <div id="dungeonResult" class="combat-log" style="height: 180px; margin-top: 20px;"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="goToTown()">RETURN TO TOWN</button>
                <button onclick="enterDungeonFloor()" id="enterDungeonButton" style="display: none;">ENTER DUNGEON FLOOR</button>
                <button onclick="leaveDungeon()" id="leaveDungeonButton" style="display: none;">LEAVE DUNGEON</button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="screen">
            <h2 class="game-over">YOU HAVE DIED</h2>
            <div class="divider"></div>
            <p>YOUR ADVENTURE ENDS HERE, DEEP IN THE FOREST. THE RED DRAGON'S MINIONS HAVE CLAIMED ANOTHER VICTIM.</p>
            <p>YOU SURVIVED FOR <span class="stat-value" id="finalDay">1</span> DAYS.</p>
            <p>YOU REACHED LEVEL <span class="stat-value" id="finalLevel">1</span>.</p>
            <p>QUESTS COMPLETED: <span class="stat-value" id="finalQuests">0</span>.</p>
            <p>YESTERDAY'S HERO, TODAY'S LEGEND.</p>
            <div style="text-align: center; margin-top: 40px;">
                <button onclick="restartGame()">START NEW GAME</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victoryScreen" class="screen">
            <h2 class="victory">VICTORY!</h2>
            <div class="divider"></div>
            <p>AGAINST ALL ODDS, YOU HAVE DEFEATED THE RED DRAGON AND SAVED NODINGTON!</p>
            <p>THE VILLAGERS WILL SING SONGS OF YOUR BRAVERY FOR GENERATIONS TO COME.</p>
            <p>YOU COMPLETED YOUR QUEST IN <span class="stat-value" id="victoryDay">1</span> DAYS.</p>
            <p>YOU REACHED LEVEL <span class="stat-value" id="victoryLevel">1</span>.</p>
            <p>QUESTS COMPLETED: <span class="stat-value" id="victoryQuests">0</span>.</p>
            <p>LEGENDARY STATUS ACHIEVED!</p>
            <div style="text-align: center; margin-top: 40px;">
                <button onclick="restartGame()">START NEW GAME</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        LEGEND OF THE RED DRAGON (LORD) ‚Ä¢ ORIGINALLY CREATED BY SETH ABLE ROBINSON IN 1989 ‚Ä¢ ATARI 80S EDITION
    </div>

    <script>
        // Game state
        const gameState = {
            day: 1,
            playerName: "SIR LANCELOT",
            playerClass: "fighter",
            level: 1,
            xp: 0,
            nextLevelXP: 100,
            gold: 50,
            health: 100,
            maxHealth: 100,
            strength: 10,
            agility: 10,
            magic: 10,
            statPoints: 5,
            skillPoints: 0,
            weapon: "RUSTY DAGGER",
            weaponDamage: [3, 7],
            armor: "NONE",
            armorDefense: 0,
            shield: "NONE",
            shieldDefense: 0,
            hasPotion: false,
            potions: 0,
            inCombat: false,
            currentMonster: null,
            monsterHealth: 0,
            visitedInn: false,
            dragonDefeated: false,
            gameOver: false,
            kills: 0,
            totalDamage: 0,
            // Exploration & Quest System
            quests: [],
            completedQuests: 0,
            discoveredAreas: ["haunted_woods"],
            explorationLog: [],
            hasMap: false,
            foundItems: [],
            currentExploration: null,
            explorationStep: 0,
            // New Systems
            skills: {},
            mainStory: {
                currentChapter: 0,
                completedChapters: [],
                claimedRewards: []
            },
            dungeons: {
                "goblin_warrens": {
                    unlocked: false,
                    currentFloor: 0,
                    completedFloors: [],
                    bossDefeated: false
                },
                "tower_of_sorcery": {
                    unlocked: false,
                    currentFloor: 0,
                    completedFloors: [],
                    bossDefeated: false
                },
                "crystal_mines": {
                    unlocked: false,
                    currentFloor: 0,
                    completedFloors: [],
                    bossDefeated: false
                }
            },
            activeDungeon: null,
            dungeonFloor: 0
        };

        // Monster database
        const monsters = [
            { name: "GOBLIN", health: 20, damage: [2, 5], xp: 15, gold: [5, 15], level: 1, area: ["haunted_woods", "forest"] },
            { name: "WOLF", health: 30, damage: [4, 8], xp: 25, gold: [10, 20], level: 1, area: ["haunted_woods", "forest"] },
            { name: "ORC", health: 50, damage: [6, 12], xp: 40, gold: [15, 30], level: 2, area: ["haunted_woods", "crystal_caves"] },
            { name: "TROLL", health: 80, damage: [8, 16], xp: 60, gold: [20, 40], level: 3, area: ["crystal_caves", "ancient_ruins"] },
            { name: "DARK ELF", health: 60, damage: [10, 18], xp: 70, gold: [25, 50], level: 3, area: ["ancient_ruins", "mystic_lake"] },
            { name: "MINOTAUR", health: 120, damage: [12, 22], xp: 100, gold: [30, 60], level: 4, area: ["ancient_ruins"] },
            { name: "WEREWOLF", health: 100, damage: [15, 25], xp: 120, gold: [40, 70], level: 5, area: ["mystic_lake"] },
            { name: "VAMPIRE", health: 150, damage: [18, 30], xp: 150, gold: [50, 90], level: 6, area: ["dragons_peak"] },
            { name: "CRYSTAL GOLEM", health: 120, damage: [15, 25], xp: 100, gold: [40, 70], level: 4, area: ["crystal_caves"] },
            { name: "LAKE SERPENT", health: 140, damage: [16, 28], xp: 130, gold: [45, 80], level: 5, area: ["mystic_lake"] },
            { name: "ANCIENT GUARDIAN", health: 180, damage: [20, 35], xp: 180, gold: [60, 100], level: 7, area: ["ancient_ruins"] },
            { name: "RED DRAGON", health: 300, damage: [20, 40], xp: 500, gold: [100, 200], level: 10, area: ["dragons_peak"] },
            // Dungeon-specific monsters
            { name: "GOBLIN SCOUT", health: 25, damage: [3, 6], xp: 20, gold: [8, 18], level: 1, area: ["dungeon"] },
            { name: "GOBLIN WARRIOR", health: 40, damage: [5, 10], xp: 30, gold: [12, 25], level: 2, area: ["dungeon"] },
            { name: "GOBLIN SHAMAN", health: 35, damage: [8, 15], xp: 35, gold: [15, 30], level: 2, area: ["dungeon"] },
            { name: "GOBLIN KING", health: 150, damage: [15, 25], xp: 200, gold: [100, 200], level: 5, area: ["dungeon"] },
            { name: "APPRENTICE MAGE", health: 45, damage: [10, 18], xp: 40, gold: [20, 40], level: 3, area: ["dungeon"] },
            { name: "ARCANE GUARDIAN", health: 80, damage: [12, 22], xp: 60, gold: [30, 60], level: 4, area: ["dungeon"] },
            { name: "ARCHMAGE ZORATH", health: 200, damage: [25, 40], xp: 300, gold: [150, 300], level: 8, area: ["dungeon"] },
            { name: "CRYSTAL SPIDER", health: 60, damage: [8, 16], xp: 45, gold: [25, 50], level: 3, area: ["dungeon"] },
            { name: "EARTH ELEMENTAL", health: 120, damage: [15, 28], xp: 90, gold: [40, 80], level: 5, area: ["dungeon"] },
            { name: "CRYSTAL GUARDIAN", health: 180, damage: [20, 35], xp: 150, gold: [80, 160], level: 7, area: ["dungeon"] }
        ];

        // Quest database
        const quests = [
            {
                id: "goblin_menace",
                title: "GOBLIN MENACE",
                description: "THE VILLAGERS ARE TERRIFIED OF GOBLINS RAIDING THEIR FARMS. SLAY 5 GOBLINS.",
                type: "kill",
                target: "GOBLIN",
                required: 5,
                current: 0,
                reward: { gold: 50, xp: 100, item: "HEALING POTION" },
                area: "haunted_woods",
                level: 1
            },
            {
                id: "lost_relic",
                title: "LOST RELIC",
                description: "FIND THE ANCIENT AMULET HIDDEN IN THE HAUNTED WOODS.",
                type: "find",
                target: "ANCIENT AMULET",
                required: 1,
                current: 0,
                reward: { gold: 75, xp: 150, item: "MAGIC AMULET" },
                area: "haunted_woods",
                level: 2
            },
            {
                id: "crystal_hunt",
                title: "CRYSTAL HUNT",
                description: "COLLECT 3 GLOWING CRYSTALS FROM THE CRYSTAL CAVES.",
                type: "collect",
                target: "GLOWING CRYSTAL",
                required: 3,
                current: 0,
                reward: { gold: 100, xp: 200, item: "CRYSTAL SHARD" },
                area: "crystal_caves",
                level: 3
            },
            {
                id: "troll_problem",
                title: "TROLL PROBLEM",
                description: "DEFEAT 3 TROLLS THAT BLOCK THE ROAD TO THE MOUNTAINS.",
                type: "kill",
                target: "TROLL",
                required: 3,
                current: 0,
                reward: { gold: 150, xp: 250, item: "TROLL HIDE ARMOR" },
                area: "crystal_caves",
                level: 4
            },
            {
                id: "dragon_slayer",
                title: "DRAGON SLAYER",
                description: "DEFEAT THE RED DRAGON AND SAVE NODINGTON.",
                type: "kill",
                target: "RED DRAGON",
                required: 1,
                current: 0,
                reward: { gold: 1000, xp: 1000, item: "DRAGON SCALE ARMOR" },
                area: "dragons_peak",
                level: 10
            },
            {
                id: "lake_serpent",
                title: "LAKE SERPENT",
                description: "SLAY THE DREADED LAKE SERPENT THAT TERRORIZES FISHERMEN.",
                type: "kill",
                target: "LAKE SERPENT",
                required: 1,
                current: 0,
                reward: { gold: 300, xp: 400, item: "SERPENT FANG DAGGER" },
                area: "mystic_lake",
                level: 5
            },
            {
                id: "ancient_guardian",
                title: "ANCIENT GUARDIAN",
                description: "DEFEAT THE ANCIENT GUARDIAN AND CLAIM ITS TREASURE.",
                type: "kill",
                target: "ANCIENT GUARDIAN",
                required: 1,
                current: 0,
                reward: { gold: 500, xp: 600, item: "GUARDIAN'S BLESSING" },
                area: "ancient_ruins",
                level: 7
            }
        ];

        // Skill System
        const skillsDatabase = {
            // Fighter skills
            fighter: {
                "double_strike": {
                    name: "DOUBLE STRIKE",
                    description: "CHANCE TO ATTACK TWICE IN ONE TURN",
                    maxLevel: 5,
                    baseChance: 0.05,
                    perLevel: 0.05,
                    cost: 2,
                    type: "passive",
                    icon: "‚öîÔ∏è"
                },
                "berserker_rage": {
                    name: "BERSERKER RAGE",
                    description: "INCREASE DAMAGE WHEN HEALTH IS LOW",
                    maxLevel: 3,
                    baseBonus: 0.1,
                    perLevel: 0.15,
                    cost: 3,
                    type: "passive",
                    icon: "üò°"
                },
                "shield_bash": {
                    name: "SHIELD BASH",
                    description: "BASH ENEMY WITH SHIELD, STUNNING THEM",
                    maxLevel: 3,
                    baseChance: 0.2,
                    perLevel: 0.1,
                    damageMultiplier: 0.5,
                    cost: 4,
                    type: "active",
                    icon: "üõ°Ô∏è"
                },
                "whirlwind": {
                    name: "WHIRLWIND",
                    description: "ATTACK ALL ENEMIES FOR REDUCED DAMAGE",
                    maxLevel: 2,
                    damageMultiplier: 0.6,
                    perLevel: 0.1,
                    cost: 5,
                    type: "active",
                    icon: "üåÄ"
                }
            },
            // Mage skills
            mage: {
                "fireball": {
                    name: "FIREBALL",
                    description: "LAUNCH A POWERFUL FIREBALL AT ENEMY",
                    maxLevel: 5,
                    damageMultiplier: 1.5,
                    perLevel: 0.2,
                    cost: 2,
                    type: "active",
                    icon: "üî•"
                },
                "frost_nova": {
                    name: "FROST NOVA",
                    description: "FREEZE ALL ENEMIES, SLOWING THEM",
                    maxLevel: 3,
                    baseChance: 0.3,
                    perLevel: 0.1,
                    slowDuration: 2,
                    cost: 4,
                    type: "active",
                    icon: "‚ùÑÔ∏è"
                },
                "arcane_shield": {
                    name: "ARCANE SHIELD",
                    description: "CREATE A MAGICAL BARRIER THAT ABSORBS DAMAGE",
                    maxLevel: 3,
                    shieldAmount: 20,
                    perLevel: 10,
                    duration: 3,
                    cost: 3,
                    type: "active",
                    icon: "üîÆ"
                },
                "mana_surge": {
                    name: "MANA SURGE",
                    description: "INCREASE MAGIC DAMAGE FOR SEVERAL TURNS",
                    maxLevel: 2,
                    damageBonus: 0.3,
                    perLevel: 0.2,
                    duration: 3,
                    cost: 5,
                    type: "active",
                    icon: "‚ö°"
                }
            },
            // Thief skills
            thief: {
                "backstab": {
                    name: "BACKSTAB",
                    description: "DEAL EXTRA DAMAGE FROM BEHIND",
                    maxLevel: 5,
                    damageMultiplier: 2.0,
                    perLevel: 0.3,
                    chance: 0.3,
                    cost: 2,
                    type: "passive",
                    icon: "üó°Ô∏è"
                },
                "smoke_bomb": {
                    name: "SMOKE BOMB",
                    description: "THROW SMOKE BOMB TO ESCAPE COMBAT",
                    maxLevel: 3,
                    escapeChance: 0.6,
                    perLevel: 0.15,
                    cost: 3,
                    type: "active",
                    icon: "üí®"
                },
                "poison_dagger": {
                    name: "POISON DAGGER",
                    description: "APPLY POISON THAT DAMAGES OVER TIME",
                    maxLevel: 3,
                    poisonDamage: 5,
                    perLevel: 3,
                    duration: 3,
                    cost: 4,
                    type: "active",
                    icon: "‚ò†Ô∏è"
                },
                "shadow_step": {
                    name: "SHADOW STEP",
                    description: "TELEPORT BEHIND ENEMY FOR CRITICAL ATTACK",
                    maxLevel: 2,
                    critChance: 1.0,
                    damageMultiplier: 1.8,
                    cost: 5,
                    type: "active",
                    icon: "üë§"
                }
            },
            // General skills available to all classes
            general: {
                "health_boost": {
                    name: "HEALTH BOOST",
                    description: "PERMANENTLY INCREASE MAXIMUM HEALTH",
                    maxLevel: 5,
                    healthBonus: 20,
                    perLevel: 20,
                    cost: 1,
                    type: "passive",
                    icon: "‚ù§Ô∏è"
                },
                "gold_find": {
                    name: "GOLD FIND",
                    description: "INCREASE GOLD DROPS FROM ENEMIES",
                    maxLevel: 3,
                    bonus: 0.1,
                    perLevel: 0.1,
                    cost: 2,
                    type: "passive",
                    icon: "üí∞"
                },
                "xp_boost": {
                    name: "XP BOOST",
                    description: "GAIN MORE EXPERIENCE FROM BATTLES",
                    maxLevel: 3,
                    bonus: 0.1,
                    perLevel: 0.1,
                    cost: 2,
                    type: "passive",
                    icon: "‚≠ê"
                }
            }
        };

        // Main Story Questline
        const mainStory = [
            {
                chapter: 1,
                title: "THE BEGINNING",
                description: "LEARN ABOUT THE RED DRAGON THREAT FROM THE VILLAGE ELDER",
                objective: "TALK TO THE MYSTERIOUS WOMAN AT THE INN",
                reward: { gold: 50, xp: 100, skillPoints: 1 },
                unlock: "goblin_warrens",
                requiredLevel: 1
            },
            {
                chapter: 2,
                title: "GOBLIN THREAT",
                description: "CLEAR THE GOBLIN WARRENS TO SECURE THE VILLAGE",
                objective: "DEFEAT THE GOBLIN KING IN THE GOBLIN WARRENS",
                reward: { gold: 200, xp: 300, item: "GOBLIN SLAYER SWORD" },
                unlock: "crystal_caves",
                requiredLevel: 2
            },
            {
                chapter: 3,
                title: "CRYSTAL POWER",
                description: "INVESTIGATE THE CRYSTAL MINES FOR MAGICAL ENERGY",
                objective: "COMPLETE THE CRYSTAL MINES DUNGEON",
                reward: { gold: 300, xp: 500, skillPoints: 2 },
                unlock: "tower_of_sorcery",
                requiredLevel: 3
            },
            {
                chapter: 4,
                title: "MAGICAL KNOWLEDGE",
                description: "SEEK THE WISDOM OF THE ARCHMAGES IN THE TOWER OF SORCERY",
                objective: "DEFEAT ARCHMAGE ZORATH IN THE TOWER OF SORCERY",
                reward: { gold: 500, xp: 800, item: "ARCHMAGE ROBE" },
                unlock: "dragon_ritual",
                requiredLevel: 5
            },
            {
                chapter: 5,
                title: "DRAGON RITUAL",
                description: "PERFORM AN ANCIENT RITUAL TO WEAKEN THE RED DRAGON",
                objective: "COLLECT 3 DRAGON SCALES FROM DRAGON'S PEAK",
                reward: { gold: 800, xp: 1200, skillPoints: 3 },
                unlock: "final_battle",
                requiredLevel: 7
            },
            {
                chapter: 6,
                title: "FINAL BATTLE",
                description: "FACE THE RED DRAGON IN ITS LAIR AND SAVE NODINGTON",
                objective: "DEFEAT THE RED DRAGON",
                reward: { gold: 2000, xp: 3000, item: "DRAGONHEART AMULET" },
                unlock: "victory",
                requiredLevel: 10
            }
        ];

        // Dungeon System
        const dungeons = {
            "goblin_warrens": {
                name: "GOBLIN WARRENS",
                description: "A NETWORK OF TUNNELS INFESTED WITH GOBLINS",
                floors: 5,
                boss: "GOBLIN KING",
                minLevel: 1,
                rewards: {
                    floor: { gold: [20, 50], xp: [30, 80] },
                    boss: { gold: 200, xp: 300, item: "GOBLIN SLAYER SWORD" }
                },
                monsters: ["GOBLIN SCOUT", "GOBLIN WARRIOR", "GOBLIN SHAMAN"],
                special: "Goblins drop more gold"
            },
            "tower_of_sorcery": {
                name: "TOWER OF SORCERY",
                description: "A MYSTICAL TOWER GUARDED BY POWERFUL MAGES",
                floors: 8,
                boss: "ARCHMAGE ZORATH",
                minLevel: 3,
                rewards: {
                    floor: { gold: [40, 80], xp: [50, 100] },
                    boss: { gold: 500, xp: 800, item: "ARCHMAGE ROBE" }
                },
                monsters: ["APPRENTICE MAGE", "ARCANE GUARDIAN"],
                special: "Magical enemies are stronger"
            },
            "crystal_mines": {
                name: "CRYSTAL MINES",
                description: "DEEP MINES WITH CRYSTAL-BASED CREATURES",
                floors: 6,
                boss: "CRYSTAL GUARDIAN",
                minLevel: 2,
                rewards: {
                    floor: { gold: [30, 60], xp: [40, 90] },
                    boss: { gold: 300, xp: 500, skillPoints: 2 }
                },
                monsters: ["CRYSTAL SPIDER", "EARTH ELEMENTAL"],
                special: "Chance to find rare crystals"
            }
        };

        // Exploration areas
        const explorationAreas = {
            haunted_woods: {
                name: "HAUNTED WOODS",
                description: "A DENSE, MYSTERIOUS FOREST RUMORED TO BE HAUNTED BY LOST SPIRITS.",
                minLevel: 1,
                maxLevel: 3,
                encounters: [
                    { type: "combat", weight: 60 },
                    { type: "treasure", weight: 20 },
                    { type: "quest_item", weight: 10 },
                    { type: "nothing", weight: 10 }
                ],
                specialEvents: [
                    "YOU FIND AN OLD CABIN. INSIDE, YOU DISCOVER A RUSTY SWORD.",
                    "A MYSTERIOUS FOUNTAIN RESTORES YOUR HEALTH FULLY.",
                    "YOU STUMBLE UPON A BURIED CHEST CONTAINING GOLD."
                ]
            },
            crystal_caves: {
                name: "CRYSTAL CAVES",
                description: "GLOWING CAVES FILLED WITH PRECIOUS GEMS AND DANGEROUS CREATURES.",
                minLevel: 2,
                maxLevel: 4,
                encounters: [
                    { type: "combat", weight: 70 },
                    { type: "treasure", weight: 15 },
                    { type: "crystal", weight: 10 },
                    { type: "trap", weight: 5 }
                ],
                specialEvents: [
                    "YOU FIND A VEIN OF GLOWING CRYSTALS. THEY SEEM MAGICAL.",
                    "THE CAVES ECHO WITH STRANGE WHISPERS. YOU FEEL UNEASY.",
                    "A COLLAPSED TUNNEL REVEALS A HIDDEN CHAMBER."
                ]
            },
            ancient_ruins: {
                name: "ANCIENT RUINS",
                description: "RUINS OF A FORGOTTEN CIVILIZATION, RUMORED TO HOLD POWERFUL ARTIFACTS.",
                minLevel: 3,
                maxLevel: 5,
                encounters: [
                    { type: "combat", weight: 65 },
                    { type: "artifact", weight: 15 },
                    { type: "puzzle", weight: 10 },
                    { type: "trap", weight: 10 }
                ],
                specialEvents: [
                    "YOU DECIPHER ANCIENT RUNES THAT GRANT YOU WISDOM (+1 TO ALL STATS).",
                    "A HIDDEN CHAMBER CONTAINS FORGOTTEN TREASURE.",
                    "THE SPIRIT OF AN ANCIENT WARRIOR CHALLENGES YOU TO COMBAT."
                ]
            },
            dragons_peak: {
                name: "DRAGON'S PEAK",
                description: "THE LAIR OF THE RED DRAGON. ONLY FOR THE BRAVEST ADVENTURERS.",
                minLevel: 5,
                maxLevel: 10,
                encounters: [
                    { type: "combat", weight: 80 },
                    { type: "dragon_hoard", weight: 10 },
                    { type: "dragon_egg", weight: 5 },
                    { type: "escape", weight: 5 }
                ],
                specialEvents: [
                    "YOU FIND A DRAGON EGG! IT'S WORTH A FORTUNE.",
                    "THE DRAGON'S HOARD GLITTERS IN THE DARKNESS.",
                    "YOU DISCOVER AN ANCIENT DRAGON SLAYER'S JOURNAL."
                ]
            },
            mystic_lake: {
                name: "MYSTIC LAKE",
                description: "A SERENE LAKE WITH MAGICAL PROPERTIES AND AQUATIC CREATURES.",
                minLevel: 2,
                maxLevel: 3,
                encounters: [
                    { type: "combat", weight: 50 },
                    { type: "fishing", weight: 25 },
                    { type: "magic", weight: 15 },
                    { type: "nothing", weight: 10 }
                ],
                specialEvents: [
                    "THE LAKE'S WATERS HEAL YOUR WOUNDS (+50 HP).",
                    "YOU CATCH A MAGICAL FISH THAT GRANTS TEMPORARY STRENGTH.",
                    "A WATER SPIRIT OFFERS YOU A BOON."
                ]
            }
        };

        // Initialize the game
        function initGame() {
            updateStatusBar();
            showScreen('creationScreen');
            updateQuestCount();
            initializeSkills();
            
            // Check for saved game
            const savedGame = localStorage.getItem('lordSave');
            if (savedGame) {
                if (confirm("A SAVED GAME WAS FOUND. LOAD IT?")) {
                    const loadedState = JSON.parse(savedGame);
                    Object.assign(gameState, loadedState);
                    
                    // Ensure skills object exists
                    if (!gameState.skills) {
                        gameState.skills = {};
                        initializeSkills();
                    }
                    
                    updateStatusBar();
                    updateQuestCount();
                    updateExplorationAreas();
                    showScreen('townScreen');
                }
            }
        }

        // Initialize skills
        function initializeSkills() {
            // Initialize skills based on class
            const classSkills = skillsDatabase[gameState.playerClass];
            const generalSkills = skillsDatabase.general;
            
            // Initialize class skills
            for (const skillId in classSkills) {
                if (!gameState.skills[skillId]) {
                    gameState.skills[skillId] = {
                        level: 0,
                        maxLevel: classSkills[skillId].maxLevel
                    };
                }
            }
            
            // Initialize general skills
            for (const skillId in generalSkills) {
                if (!gameState.skills[skillId]) {
                    gameState.skills[skillId] = {
                        level: 0,
                        maxLevel: generalSkills[skillId].maxLevel
                    };
                }
            }
        }

        // Show a specific screen
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');
            
            // Update potion button state
            updatePotionButton();
            
            // Update exploration areas visibility
            if (screenId === 'explorationScreen') {
                updateExplorationAreas();
            }
            
            // Update quests screen
            if (screenId === 'questsScreen') {
                updateQuestsDisplay();
            }
            
            // Update skills screen
            if (screenId === 'skillsScreen') {
                updateSkillsDisplay();
            }
            
            // Update story screen
            if (screenId === 'storyScreen') {
                updateStoryDisplay();
            }
            
            // Update dungeons screen
            if (screenId === 'dungeonsScreen') {
                updateDungeonsDisplay();
            }
        }

        // Update the status bar
        function updateStatusBar() {
            document.getElementById('dayCount').textContent = gameState.day;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('maxHealth').textContent = gameState.maxHealth;
            document.getElementById('gold').textContent = gameState.gold;
            document.getElementById('xp').textContent = gameState.xp;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('questCount').textContent = gameState.quests.length;
        }

        // Update potion button visibility
        function updatePotionButton() {
            const potionButton = document.getElementById('potionButton');
            if (gameState.potions > 0) {
                potionButton.disabled = false;
                potionButton.textContent = `USE POTION (${gameState.potions})`;
            } else {
                potionButton.disabled = true;
                potionButton.textContent = 'USE POTION';
            }
        }

        // Character creation functions
        function increaseStat(stat) {
            if (gameState.statPoints > 0) {
                gameState[stat] += 1;
                gameState.statPoints -= 1;
                
                // Update display
                document.getElementById(stat + 'Stat').textContent = gameState[stat];
                document.getElementById('statPoints').textContent = gameState.statPoints;
                
                // Update max health if strength increased
                if (stat === 'str') {
                    gameState.maxHealth = 80 + (gameState.strength * 2);
                    document.getElementById('hpStat').textContent = gameState.maxHealth;
                }
            }
        }

        function resetStats() {
            gameState.strength = 10;
            gameState.agility = 10;
            gameState.magic = 10;
            gameState.statPoints = 5;
            gameState.maxHealth = 100;
            
            // Update display
            document.getElementById('strStat').textContent = gameState.strength;
            document.getElementById('agiStat').textContent = gameState.agility;
            document.getElementById('magStat').textContent = gameState.magic;
            document.getElementById('hpStat').textContent = gameState.maxHealth;
            document.getElementById('statPoints').textContent = gameState.statPoints;
        }

        function completeCharacterCreation() {
            const nameInput = document.getElementById('playerName').value.trim();
            const classSelect = document.getElementById('playerClass').value;
            
            if (nameInput) {
                gameState.playerName = nameInput.toUpperCase();
            }
            
            gameState.playerClass = classSelect;
            
            // Set class-specific bonuses
            if (classSelect === 'fighter') {
                gameState.strength += 3;
                gameState.maxHealth = 80 + (gameState.strength * 2);
                gameState.weaponDamage = [5, 10];
            } else if (classSelect === 'mage') {
                gameState.magic += 3;
                gameState.maxHealth = 60 + (gameState.strength * 2);
                gameState.gold += 20;
            } else if (classSelect === 'thief') {
                gameState.agility += 3;
                gameState.maxHealth = 70 + (gameState.strength * 2);
                gameState.gold += 30;
            }
            
            gameState.health = gameState.maxHealth;
            
            // Initialize skills for the chosen class
            initializeSkills();
            
            // Unlock first dungeon by default
            gameState.dungeons.goblin_warrens.unlocked = true;
            
            // Give starting quest
            addQuest("goblin_menace");
            
            // Start main story chapter 1
            gameState.mainStory.currentChapter = 0;
            
            // Update status and go to town
            updateStatusBar();
            showScreen('townScreen');
            
            // Show story intro
            document.getElementById('townMessage').innerHTML = 
                `<p class="quest">MAIN STORY STARTED: ${mainStory[0].title}</p>
                 <p>${mainStory[0].description}</p>
                 <p class="unlock-message">DUNGEON UNLOCKED: GOBLIN WARRENS!</p>`;
        }

        // Skill System Functions
        function goToSkills() {
            showScreen('skillsScreen');
        }

        function updateSkillsDisplay() {
            const skillsList = document.getElementById('skillsList');
            const skillPointsDisplay = document.getElementById('skillPointsDisplay');
            
            skillsList.innerHTML = '';
            skillPointsDisplay.textContent = gameState.skillPoints;
            
            // Get skills for current class
            const classSkills = skillsDatabase[gameState.playerClass];
            const generalSkills = skillsDatabase.general;
            
            // Display class skills
            let html = `<h3>${gameState.playerClass.toUpperCase()} SKILLS</h3>`;
            
            for (const skillId in classSkills) {
                const skill = classSkills[skillId];
                const playerSkill = gameState.skills[skillId];
                const isMaxed = playerSkill.level >= skill.maxLevel;
                const canUpgrade = gameState.skillPoints >= skill.cost && !isMaxed;
                
                html += `
                    <div class="skill-item ${playerSkill.level > 0 ? 'unlocked' : ''}" onclick="upgradeSkill('${skillId}')" 
                         style="${!canUpgrade && playerSkill.level === 0 ? 'opacity: 0.6;' : ''}">
                        <strong>${skill.icon} ${skill.name} (${playerSkill.level}/${skill.maxLevel})</strong>
                        <span class="skill-level">${playerSkill.level > 0 ? 'ACTIVE' : 'LOCKED'}</span>
                        <div class="skill-description">${skill.description}</div>
                        <div class="skill-cost">COST: ${skill.cost} SKILL POINT${skill.cost > 1 ? 'S' : ''}</div>
                    </div>
                `;
            }
            
            // Display general skills
            html += `<h3 style="margin-top: 20px;">GENERAL SKILLS</h3>`;
            
            for (const skillId in generalSkills) {
                const skill = generalSkills[skillId];
                const playerSkill = gameState.skills[skillId];
                const isMaxed = playerSkill.level >= skill.maxLevel;
                const canUpgrade = gameState.skillPoints >= skill.cost && !isMaxed;
                
                html += `
                    <div class="skill-item ${playerSkill.level > 0 ? 'unlocked' : ''}" onclick="upgradeSkill('${skillId}')"
                         style="${!canUpgrade && playerSkill.level === 0 ? 'opacity: 0.6;' : ''}">
                        <strong>${skill.icon} ${skill.name} (${playerSkill.level}/${skill.maxLevel})</strong>
                        <span class="skill-level">${playerSkill.level > 0 ? 'ACTIVE' : 'LOCKED'}</span>
                        <div class="skill-description">${skill.description}</div>
                        <div class="skill-cost">COST: ${skill.cost} SKILL POINT${skill.cost > 1 ? 'S' : ''}</div>
                    </div>
                `;
            }
            
            skillsList.innerHTML = html;
        }

        function upgradeSkill(skillId) {
            let skillData;
            
            // Find skill in databases
            if (skillsDatabase[gameState.playerClass][skillId]) {
                skillData = skillsDatabase[gameState.playerClass][skillId];
            } else if (skillsDatabase.general[skillId]) {
                skillData = skillsDatabase.general[skillId];
            } else {
                return;
            }
            
            const playerSkill = gameState.skills[skillId];
            
            // Check if can upgrade
            if (playerSkill.level >= skillData.maxLevel) {
                return;
            }
            
            if (gameState.skillPoints < skillData.cost) {
                return;
            }
            
            // Upgrade skill
            playerSkill.level++;
            gameState.skillPoints -= skillData.cost;
            
            // Apply skill effects
            applySkillEffects(skillId);
            
            // Update display
            updateSkillsDisplay();
            
            // Show message
            const townMessage = document.getElementById('townMessage');
            if (townMessage) {
                townMessage.innerHTML = `<p class="heal">SKILL UPGRADED: ${skillData.name} LEVEL ${playerSkill.level}</p>`;
            }
        }

        function applySkillEffects(skillId) {
            const playerSkill = gameState.skills[skillId];
            
            switch(skillId) {
                case "health_boost":
                    const healthBoost = skillsDatabase.general.health_boost;
                    gameState.maxHealth += healthBoost.healthBoost;
                    gameState.health = Math.min(gameState.maxHealth, gameState.health + healthBoost.healthBoost);
                    break;
                case "gold_find":
                case "xp_boost":
                    // These are applied during combat/exploration
                    break;
            }
            
            updateStatusBar();
        }

        function resetSkills() {
            if (gameState.gold >= 100) {
                if (confirm("RESET ALL SKILLS FOR 100 GOLD? YOU WILL GET ALL SPENT SKILL POINTS BACK.")) {
                    gameState.gold -= 100;
                    
                    // Calculate total skill points to return
                    let totalPoints = 0;
                    for (const skillId in gameState.skills) {
                        const playerSkill = gameState.skills[skillId];
                        if (playerSkill.level > 0) {
                            let skillData;
                            if (skillsDatabase[gameState.playerClass][skillId]) {
                                skillData = skillsDatabase[gameState.playerClass][skillId];
                            } else if (skillsDatabase.general[skillId]) {
                                skillData = skillsDatabase.general[skillId];
                            }
                            
                            if (skillData) {
                                totalPoints += playerSkill.level * skillData.cost;
                            }
                        }
                    }
                    
                    // Reset all skills
                    initializeSkills();
                    gameState.skillPoints += totalPoints;
                    
                    // Update display
                    updateSkillsDisplay();
                    updateStatusBar();
                    
                    // Show message
                    document.getElementById('townMessage').innerHTML = 
                        `<p class="heal">ALL SKILLS RESET. RECEIVED ${totalPoints} SKILL POINTS.</p>`;
                }
            } else {
                document.getElementById('townMessage').innerHTML = 
                    `<p class="damage">YOU NEED 100 GOLD TO RESET SKILLS.</p>`;
            }
        }

        function useSkill() {
            if (!gameState.inCombat || gameState.monsterHealth <= 0) return;
            
            const combatLog = document.getElementById('combatLog');
            const classSkills = skillsDatabase[gameState.playerClass];
            
            // Check for available active skills
            let availableSkills = [];
            for (const skillId in classSkills) {
                const skill = classSkills[skillId];
                const playerSkill = gameState.skills[skillId];
                
                if (skill.type === "active" && playerSkill.level > 0) {
                    availableSkills.push({ id: skillId, data: skill, level: playerSkill.level });
                }
            }
            
            if (availableSkills.length === 0) {
                combatLog.innerHTML += `<p class="damage">YOU HAVE NO ACTIVE SKILLS LEARNED!</p>`;
                return;
            }
            
            // For now, just use the first available skill
            // In a more complete version, you'd have a skill selection UI
            const skillToUse = availableSkills[0];
            useActiveSkill(skillToUse.id, skillToUse.data, skillToUse.level);
        }

        function useActiveSkill(skillId, skillData, skillLevel) {
            const combatLog = document.getElementById('combatLog');
            
            switch(skillId) {
                case "shield_bash":
                    const stunChance = skillData.baseChance + (skillData.perLevel * (skillLevel - 1));
                    const bashDamage = Math.floor((gameState.weaponDamage[0] + gameState.weaponDamage[1]) / 2 * skillData.damageMultiplier);
                    
                    combatLog.innerHTML += `YOU USE <span class="heal">${skillData.name}</span>!<br>`;
                    gameState.monsterHealth -= bashDamage;
                    combatLog.innerHTML += `YOU HIT FOR <span class="damage">${bashDamage}</span> DAMAGE.<br>`;
                    
                    if (Math.random() < stunChance) {
                        combatLog.innerHTML += `THE <span class="monster">${gameState.currentMonster.name}</span> IS STUNNED AND SKIPS A TURN!<br>`;
                        // Monster doesn't attack this turn
                        return true;
                    }
                    break;
                    
                case "fireball":
                    const fireDamage = Math.floor(gameState.magic * skillData.damageMultiplier + (skillData.perLevel * (skillLevel - 1) * gameState.magic));
                    combatLog.innerHTML += `YOU CAST <span class="heal">${skillData.name}</span>!<br>`;
                    gameState.monsterHealth -= fireDamage;
                    combatLog.innerHTML += `IT HITS FOR <span class="damage">${fireDamage}</span> DAMAGE.<br>`;
                    break;
                    
                case "backstab":
                    if (Math.random() < skillData.chance) {
                        const backstabDamage = Math.floor((gameState.weaponDamage[0] + gameState.weaponDamage[1]) / 2 * skillData.damageMultiplier);
                        combatLog.innerHTML += `YOU PERFORM <span class="heal">${skillData.name}</span>!<br>`;
                        gameState.monsterHealth -= backstabDamage;
                        combatLog.innerHTML += `CRITICAL HIT FOR <span class="damage">${backstabDamage}</span> DAMAGE!<br>`;
                    } else {
                        combatLog.innerHTML += `YOU TRY TO PERFORM <span class="heal">${skillData.name}</span> BUT MISS!<br>`;
                    }
                    break;
            }
            
            return false;
        }

        // Check for passive skill effects
        function checkPassiveSkills() {
            let effects = {
                doubleAttack: false,
                extraGold: 1.0,
                extraXP: 1.0
            };
            
            // Check class-specific passive skills
            const classSkills = skillsDatabase[gameState.playerClass];
            for (const skillId in classSkills) {
                const skill = classSkills[skillId];
                const playerSkill = gameState.skills[skillId];
                
                if (skill.type === "passive" && playerSkill.level > 0) {
                    switch(skillId) {
                        case "double_strike":
                            const doubleStrikeChance = skill.baseChance + (skill.perLevel * (playerSkill.level - 1));
                            if (Math.random() < doubleStrikeChance) {
                                effects.doubleAttack = true;
                            }
                            break;
                        case "berserker_rage":
                            if (gameState.health < gameState.maxHealth * 0.3) {
                                effects.damageBonus = skill.baseBonus + (skill.perLevel * (playerSkill.level - 1));
                            }
                            break;
                    }
                }
            }
            
            // Check general passive skills
            const generalSkills = skillsDatabase.general;
            for (const skillId in generalSkills) {
                const skill = generalSkills[skillId];
                const playerSkill = gameState.skills[skillId];
                
                if (skill.type === "passive" && playerSkill.level > 0) {
                    switch(skillId) {
                        case "gold_find":
                            effects.extraGold += skill.bonus * playerSkill.level;
                            break;
                        case "xp_boost":
                            effects.extraXP += skill.bonus * playerSkill.level;
                            break;
                    }
                }
            }
            
            return effects;
        }

        // Story System Functions
        function goToStory() {
            showScreen('storyScreen');
        }

        function updateStoryDisplay() {
            const storyProgress = document.getElementById('storyProgress');
            const claimRewardButton = document.getElementById('claimRewardButton');
            
            storyProgress.innerHTML = '';
            claimRewardButton.style.display = 'none';
            
            // Check if there's a completed chapter with unclaimed reward
            let hasUnclaimedReward = false;
            
            for (let i = 0; i < mainStory.length; i++) {
                const chapter = mainStory[i];
                const isCompleted = gameState.mainStory.completedChapters.includes(i);
                const isCurrent = gameState.mainStory.currentChapter === i;
                const isClaimed = gameState.mainStory.claimedRewards.includes(i);
                const canAccess = gameState.level >= chapter.requiredLevel;
                
                let chapterClass = "story-chapter";
                if (isCompleted) chapterClass += " completed";
                if (isCurrent) chapterClass += " current";
                if (!canAccess && !isCompleted) chapterClass += " locked";
                
                let statusText = "";
                if (isCompleted) {
                    statusText = isClaimed ? "REWARD CLAIMED" : "REWARD AVAILABLE";
                    if (!isClaimed) hasUnclaimedReward = true;
                } else if (isCurrent) {
                    statusText = "IN PROGRESS";
                } else if (canAccess) {
                    statusText = "AVAILABLE";
                } else {
                    statusText = `REQUIRES LEVEL ${chapter.requiredLevel}`;
                }
                
                storyProgress.innerHTML += `
                    <div class="${chapterClass}" ${canAccess || isCompleted ? `onclick="focusStoryChapter(${i})" style="cursor: pointer;"` : 'style="cursor: not-allowed;"'}>
                        <strong>CHAPTER ${chapter.chapter}: ${chapter.title}</strong>
                        <div style="float: right; color: #ffaa00; font-size: 10px;">${statusText}</div>
                        <div style="color: #aaa; font-size: 11px; margin: 5px 0;">${chapter.description}</div>
                        <div style="color: #44ff88; font-size: 11px;">OBJECTIVE: ${chapter.objective}</div>
                        <div class="chapter-reward">REWARD: ${chapter.reward.gold} GOLD, ${chapter.reward.xp} XP, ${chapter.reward.skillPoints ? chapter.reward.skillPoints + ' SKILL POINTS' : chapter.reward.item}</div>
                    </div>
                `;
            }
            
            // Show claim reward button if there's an unclaimed reward
            if (hasUnclaimedReward) {
                claimRewardButton.style.display = 'inline-block';
            }
        }

        function focusStoryChapter(chapterIndex) {
            const chapter = mainStory[chapterIndex];
            const canAccess = gameState.level >= chapter.requiredLevel;
            const isCompleted = gameState.mainStory.completedChapters.includes(chapterIndex);
            
            if (!canAccess && !isCompleted) {
                document.getElementById('storyMessage').innerHTML = 
                    `<p class="damage">YOU NEED TO BE LEVEL ${chapter.requiredLevel} TO ACCESS THIS CHAPTER.</p>`;
                return;
            }
            
            // Set as current chapter if not completed
            if (!isCompleted) {
                gameState.mainStory.currentChapter = chapterIndex;
                updateStoryDisplay();
                
                document.getElementById('storyMessage').innerHTML = 
                    `<p class="quest">CHAPTER ${chapter.chapter} FOCUSED: ${chapter.title}</p>
                     <p>${chapter.description}</p>`;
            }
        }

        function claimStoryReward() {
            // Find the first completed chapter with unclaimed reward
            for (let i = 0; i < mainStory.length; i++) {
                if (gameState.mainStory.completedChapters.includes(i) && 
                    !gameState.mainStory.claimedRewards.includes(i)) {
                    
                    const chapter = mainStory[i];
                    
                    // Give rewards
                    gameState.gold += chapter.reward.gold;
                    gameState.xp += chapter.reward.xp;
                    
                    if (chapter.reward.skillPoints) {
                        gameState.skillPoints += chapter.reward.skillPoints;
                    }
                    
                    if (chapter.reward.item) {
                        // Handle special items
                        if (chapter.reward.item === "GOBLIN SLAYER SWORD") {
                            gameState.weapon = "GOBLIN SLAYER SWORD";
                            gameState.weaponDamage = [12, 24];
                        } else if (chapter.reward.item === "ARCHMAGE ROBE") {
                            gameState.armor = "ARCHMAGE ROBE";
                            gameState.armorDefense = 8;
                            gameState.magic += 5;
                        } else if (chapter.reward.item === "DRAGONHEART AMULET") {
                            gameState.foundItems.push("DRAGONHEART AMULET");
                        }
                    }
                    
                    // Mark reward as claimed
                    gameState.mainStory.claimedRewards.push(i);
                    
                    // Update UI
                    updateStatusBar();
                    updateStoryDisplay();
                    
                    // Show message
                    document.getElementById('storyMessage').innerHTML = 
                        `<p class="heal">CLAIMED REWARD FOR CHAPTER ${chapter.chapter}: ${chapter.title}</p>
                         <p>RECEIVED: ${chapter.reward.gold} GOLD, ${chapter.reward.xp} XP${chapter.reward.skillPoints ? ', ' + chapter.reward.skillPoints + ' SKILL POINTS' : ''}</p>`;
                    
                    checkLevelUp();
                    return;
                }
            }
        }

        function checkStoryProgress() {
            const currentChapterIndex = gameState.mainStory.currentChapter;
            
            if (currentChapterIndex >= mainStory.length) {
                return; // Story completed
            }
            
            const chapter = mainStory[currentChapterIndex];
            let chapterCompleted = false;
            
            // Check chapter objectives
            switch(currentChapterIndex) {
                case 0: // Talk to mysterious woman
                    if (gameState.visitedInn) {
                        chapterCompleted = true;
                    }
                    break;
                case 1: // Defeat Goblin King
                    if (gameState.dungeons.goblin_warrens.bossDefeated) {
                        chapterCompleted = true;
                    }
                    break;
                case 2: // Complete Crystal Mines
                    if (gameState.dungeons.crystal_mines.bossDefeated) {
                        chapterCompleted = true;
                    }
                    break;
                case 3: // Defeat Archmage Zorath
                    if (gameState.dungeons.tower_of_sorcery.bossDefeated) {
                        chapterCompleted = true;
                    }
                    break;
                case 4: // Collect dragon scales
                    // Check if player has collected dragon scales
                    // This would need to be tracked separately
                    // For now, check if player has visited Dragon's Peak
                    if (gameState.discoveredAreas.includes("dragons_peak") && gameState.kills >= 20) {
                        chapterCompleted = true;
                    }
                    break;
                case 5: // Defeat Red Dragon
                    if (gameState.dragonDefeated) {
                        chapterCompleted = true;
                    }
                    break;
            }
            
            if (chapterCompleted) {
                // Complete current chapter
                if (!gameState.mainStory.completedChapters.includes(currentChapterIndex)) {
                    gameState.mainStory.completedChapters.push(currentChapterIndex);
                    
                    // Move to next chapter if available
                    if (currentChapterIndex + 1 < mainStory.length) {
                        gameState.mainStory.currentChapter = currentChapterIndex + 1;
                        
                        // Unlock next chapter's content
                        const nextChapter = mainStory[currentChapterIndex + 1];
                        if (nextChapter.unlock) {
                            // Unlock dungeons or areas
                            if (nextChapter.unlock === "goblin_warrens") {
                                gameState.dungeons.goblin_warrens.unlocked = true;
                            } else if (nextChapter.unlock === "crystal_caves") {
                                gameState.discoveredAreas.push("crystal_caves");
                                updateExplorationAreas();
                            } else if (nextChapter.unlock === "tower_of_sorcery") {
                                gameState.dungeons.tower_of_sorcery.unlocked = true;
                            } else if (nextChapter.unlock === "crystal_mines") {
                                gameState.dungeons.crystal_mines.unlocked = true;
                            }
                        }
                    }
                    
                    // Update story display
                    updateStoryDisplay();
                    
                    // Show completion message
                    document.getElementById('townMessage').innerHTML = 
                        `<p class="quest">CHAPTER COMPLETED: ${chapter.title}</p>
                         <p>REWARD AVAILABLE IN STORY MENU!</p>`;
                         
                    if (currentChapterIndex + 1 < mainStory.length) {
                        const nextChapter = mainStory[currentChapterIndex + 1];
                        document.getElementById('townMessage').innerHTML += 
                            `<p class="unlock-message">NEW CHAPTER AVAILABLE: ${nextChapter.title}</p>`;
                    }
                }
            }
        }

        // Dungeon System Functions
        function goToDungeons() {
            showScreen('dungeonsScreen');
        }

        function updateDungeonsDisplay() {
            const dungeonsList = document.getElementById('dungeonsList');
            const enterButton = document.getElementById('enterDungeonButton');
            const leaveButton = document.getElementById('leaveDungeonButton');
            const dungeonResult = document.getElementById('dungeonResult');
            
            dungeonsList.innerHTML = '';
            enterButton.style.display = 'none';
            leaveButton.style.display = 'none';
            dungeonResult.innerHTML = '';
            
            // Check if player is in a dungeon
            if (gameState.activeDungeon) {
                const dungeon = dungeons[gameState.activeDungeon];
                const playerDungeon = gameState.dungeons[gameState.activeDungeon];
                
                let statusText = '';
                if (playerDungeon.bossDefeated) {
                    statusText = `<p class="heal">BOSS DEFEATED! DUNGEON COMPLETED!</p>`;
                } else if (gameState.dungeonFloor === dungeon.floors - 1) {
                    statusText = `<p class="damage">BOSS FLOOR! PREPARE FOR ${dungeon.boss}!</p>`;
                } else {
                    statusText = `<p>FLOOR ${gameState.dungeonFloor + 1} OF ${dungeon.floors}</p>`;
                }
                
                dungeonsList.innerHTML = `
                    <div class="dungeon-floor current">
                        <strong>${dungeon.name} - FLOOR ${gameState.dungeonFloor + 1}</strong>
                        <div class="floor-info">${dungeon.description}</div>
                        ${statusText}
                        <div class="floor-reward">BOSS: ${dungeon.boss}</div>
                    </div>
                `;
                
                enterButton.style.display = 'inline-block';
                leaveButton.style.display = 'inline-block';
                return;
            }
            
            // Display available dungeons
            let hasDungeons = false;
            
            for (const dungeonId in dungeons) {
                const dungeon = dungeons[dungeonId];
                const playerDungeon = gameState.dungeons[dungeonId];
                
                if (playerDungeon.unlocked) {
                    hasDungeons = true;
                    let status = "";
                    let dungeonClass = "dungeon-floor";
                    
                    if (playerDungeon.bossDefeated) {
                        status = "COMPLETED";
                        dungeonClass += " completed";
                    } else if (playerDungeon.currentFloor > 0) {
                        status = `FLOOR ${playerDungeon.currentFloor + 1}/${dungeon.floors}`;
                        dungeonClass += " current";
                    } else {
                        status = "AVAILABLE";
                    }
                    
                    dungeonsList.innerHTML += `
                        <div class="${dungeonClass}" onclick="selectDungeon('${dungeonId}')">
                            <strong>${dungeon.name}</strong>
                            <span style="float: right; color: #ff3355; font-size: 11px;">LEVEL ${dungeon.minLevel}+</span>
                            <div class="floor-info">${dungeon.description}</div>
                            <div class="floor-reward">BOSS: ${dungeon.boss} | FLOORS: ${dungeon.floors}</div>
                            <div style="color: #aaa; font-size: 10px; margin-top: 5px;">STATUS: ${status}</div>
                        </div>
                    `;
                } else {
                    // Show locked dungeon
                    dungeonsList.innerHTML += `
                        <div class="dungeon-floor locked">
                            <strong>${dungeon.name}</strong>
                            <span style="float: right; color: #ff3355; font-size: 11px;">LEVEL ${dungeon.minLevel}+</span>
                            <div class="floor-info">${dungeon.description}</div>
                            <div class="floor-reward">BOSS: ${dungeon.boss} | FLOORS: ${dungeon.floors}</div>
                            <div style="color: #aaa; font-size: 10px; margin-top: 5px;">STATUS: LOCKED - REACH LEVEL ${dungeon.minLevel} TO UNLOCK</div>
                        </div>
                    `;
                }
            }
            
            // If no dungeons are unlocked yet
            if (!hasDungeons) {
                dungeonsList.innerHTML = `
                    <div class="unlock-message">
                        <h3>NO DUNGEONS UNLOCKED YET</h3>
                        <p>COMPLETE THE FIRST CHAPTER OF THE MAIN STORY OR REACH LEVEL 2 TO UNLOCK DUNGEONS.</p>
                        <p>VISIT THE INN AND TALK TO THE MYSTERIOUS WOMAN TO START THE MAIN STORY!</p>
                    </div>
                `;
            }
        }

        function selectDungeon(dungeonId) {
            const dungeon = dungeons[dungeonId];
            const playerDungeon = gameState.dungeons[dungeonId];
            
            if (!playerDungeon.unlocked) {
                document.getElementById('dungeonResult').innerHTML = 
                    `<p class="damage">THIS DUNGEON IS LOCKED. REACH LEVEL ${dungeon.minLevel} TO UNLOCK IT.</p>`;
                return;
            }
            
            if (gameState.level < dungeon.minLevel) {
                document.getElementById('dungeonResult').innerHTML = 
                    `<p class="damage">YOU NEED TO BE LEVEL ${dungeon.minLevel} TO ENTER THIS DUNGEON.</p>`;
                return;
            }
            
            if (playerDungeon.bossDefeated) {
                document.getElementById('dungeonResult').innerHTML = 
                    `<p class="heal">YOU HAVE ALREADY DEFEATED THE BOSS OF THIS DUNGEON.</p>
                     <p>YOU CAN STILL ENTER TO FIGHT MONSTERS FOR LOOT AND EXPERIENCE.</p>`;
            }
            
            // Set active dungeon
            gameState.activeDungeon = dungeonId;
            gameState.dungeonFloor = playerDungeon.currentFloor;
            
            // Update display
            updateDungeonsDisplay();
            document.getElementById('enterDungeonButton').style.display = 'inline-block';
            document.getElementById('dungeonResult').innerHTML = 
                `<p>SELECTED: ${dungeon.name}</p>
                 <p>ENTERING FLOOR ${gameState.dungeonFloor + 1} OF ${dungeon.floors}</p>
                 <p>${dungeon.description}</p>`;
        }

        function enterDungeonFloor() {
            if (!gameState.activeDungeon) return;
            
            if (gameState.health <= 0) {
                document.getElementById('dungeonResult').innerHTML = 
                    `<p class="damage">YOU ARE TOO INJURED TO ENTER THE DUNGEON. VISIT THE INN TO REST.</p>`;
                return;
            }
            
            const dungeon = dungeons[gameState.activeDungeon];
            const playerDungeon = gameState.dungeons[gameState.activeDungeon];
            const dungeonResult = document.getElementById('dungeonResult');
            
            dungeonResult.innerHTML = `YOU ENTER FLOOR ${gameState.dungeonFloor + 1} OF ${dungeon.name}...<br>`;
            
            // Check if this is the boss floor
            if (gameState.dungeonFloor === dungeon.floors - 1) {
                // Boss battle
                const bossMonster = monsters.find(m => m.name === dungeon.boss);
                if (bossMonster) {
                    gameState.currentMonster = bossMonster;
                    gameState.monsterHealth = bossMonster.health;
                    gameState.inCombat = true;
                    
                    dungeonResult.innerHTML += `YOU ENCOUNTER THE DUNGEON BOSS: <span class="monster">${bossMonster.name}</span>!<br>`;
                    
                    // Update combat screen
                    document.getElementById('combatLog').innerHTML = dungeonResult.innerHTML;
                    document.getElementById('monsterInfo').innerHTML = `
                        <h3>${gameState.currentMonster.name}</h3>
                        <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                        <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                        <p>LEVEL: ${gameState.currentMonster.level}</p>
                        <p style="color: #ff3355;">DUNGEON BOSS</p>
                    `;
                    
                    showScreen('forestScreen');
                }
            } else {
                // Regular floor encounter
                const floorMonsters = dungeon.monsters;
                const monsterName = floorMonsters[Math.floor(Math.random() * floorMonsters.length)];
                const monster = monsters.find(m => m.name === monsterName);
                
                if (monster) {
                    gameState.currentMonster = monster;
                    gameState.monsterHealth = monster.health;
                    gameState.inCombat = true;
                    
                    dungeonResult.innerHTML += `YOU ENCOUNTER A <span class="monster">${monster.name}</span>!<br>`;
                    
                    // Update combat screen
                    document.getElementById('combatLog').innerHTML = dungeonResult.innerHTML;
                    document.getElementById('monsterInfo').innerHTML = `
                        <h3>${gameState.currentMonster.name}</h3>
                        <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                        <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                        <p>LEVEL: ${gameState.currentMonster.level}</p>
                    `;
                    
                    showScreen('forestScreen');
                }
            }
            
            document.getElementById('enterDungeonButton').style.display = 'none';
        }

        function leaveDungeon() {
            gameState.activeDungeon = null;
            updateDungeonsDisplay();
            document.getElementById('dungeonResult').innerHTML = 
                `<p class="heal">YOU LEAVE THE DUNGEON.</p>`;
        }

        function completeDungeonFloor() {
            if (!gameState.activeDungeon) return;
            
            const dungeon = dungeons[gameState.activeDungeon];
            const playerDungeon = gameState.dungeons[gameState.activeDungeon];
            
            // Check if boss was defeated
            const isBossFloor = gameState.dungeonFloor === dungeon.floors - 1;
            const isBossDefeated = isBossFloor && gameState.monsterHealth <= 0;
            
            // Give rewards
            if (isBossDefeated) {
                // Boss rewards
                const skillEffects = checkPassiveSkills();
                const bossGold = Math.floor(dungeon.rewards.boss.gold * skillEffects.extraGold);
                const bossXP = Math.floor(dungeon.rewards.boss.xp * skillEffects.extraXP);
                
                gameState.gold += bossGold;
                gameState.xp += bossXP;
                
                if (dungeon.rewards.boss.skillPoints) {
                    gameState.skillPoints += dungeon.rewards.boss.skillPoints;
                }
                
                if (dungeon.rewards.boss.item) {
                    // Handle boss item reward
                    if (dungeon.rewards.boss.item === "GOBLIN SLAYER SWORD") {
                        gameState.weapon = "GOBLIN SLAYER SWORD";
                        gameState.weaponDamage = [12, 24];
                    } else if (dungeon.rewards.boss.item === "ARCHMAGE ROBE") {
                        gameState.armor = "ARCHMAGE ROBE";
                        gameState.armorDefense = 8;
                        gameState.magic += 5;
                    }
                }
                
                // Mark dungeon as completed
                playerDungeon.bossDefeated = true;
                playerDungeon.currentFloor = 0;
                
                // Check story progress
                checkStoryProgress();
                
                // Show victory message
                document.getElementById('combatLog').innerHTML += 
                    `<p class="victory">YOU HAVE DEFEATED ${dungeon.boss} AND CLEARED ${dungeon.name}!</p>
                     <p class="heal">REWARD: ${bossGold} GOLD, ${bossXP} XP${dungeon.rewards.boss.skillPoints ? ', ' + dungeon.rewards.boss.skillPoints + ' SKILL POINTS' : ''}</p>`;
                
            } else {
                // Floor rewards
                const skillEffects = checkPassiveSkills();
                const floorGold = Math.floor((Math.random() * (dungeon.rewards.floor.gold[1] - dungeon.rewards.floor.gold[0] + 1)) + dungeon.rewards.floor.gold[0]) * skillEffects.extraGold;
                const floorXP = Math.floor((Math.random() * (dungeon.rewards.floor.xp[1] - dungeon.rewards.floor.xp[0] + 1)) + dungeon.rewards.floor.xp[0]) * skillEffects.extraXP;
                
                gameState.gold += floorGold;
                gameState.xp += floorXP;
                
                document.getElementById('combatLog').innerHTML += 
                    `<p class="heal">FLOOR CLEARED! YOU GAIN ${floorGold} GOLD AND ${floorXP} XP.</p>`;
                
                // Advance to next floor
                playerDungeon.currentFloor = gameState.dungeonFloor + 1;
                gameState.dungeonFloor = playerDungeon.currentFloor;
                
                // Check if dungeon completed
                if (playerDungeon.currentFloor >= dungeon.floors) {
                    playerDungeon.bossDefeated = true;
                    document.getElementById('combatLog').innerHTML += 
                        `<p class="heal">YOU HAVE REACHED THE BOSS FLOOR!</p>`;
                }
            }
            
            updateStatusBar();
            checkLevelUp();
            
            // Reset combat state
            gameState.inCombat = false;
            gameState.currentMonster = null;
            gameState.monsterHealth = 0;
            
            // Return to dungeon screen
            setTimeout(() => {
                showScreen('dungeonsScreen');
                updateDungeonsDisplay();
            }, 2000);
        }

        // Quest System Functions (from original code, updated for new systems)
        function addQuest(questId) {
            const questTemplate = quests.find(q => q.id === questId);
            if (!questTemplate) return;
            
            // Check if quest already exists
            if (gameState.quests.some(q => q.id === questId)) {
                return;
            }
            
            const newQuest = JSON.parse(JSON.stringify(questTemplate));
            gameState.quests.push(newQuest);
            updateQuestCount();
            
            // Show notification
            document.getElementById('townMessage').innerHTML = 
                `<p class="quest">NEW QUEST: ${newQuest.title}</p>`;
        }

        function updateQuestProgress(monsterName, itemFound) {
            let questUpdated = false;
            
            gameState.quests.forEach(quest => {
                if (quest.type === "kill" && quest.target === monsterName) {
                    quest.current++;
                    questUpdated = true;
                    
                    if (quest.current >= quest.required) {
                        completeQuest(quest.id);
                    }
                } else if (quest.type === "find" && quest.target === itemFound) {
                    quest.current++;
                    questUpdated = true;
                    completeQuest(quest.id);
                } else if (quest.type === "collect" && itemFound === "GLOWING CRYSTAL") {
                    quest.current++;
                    questUpdated = true;
                    
                    if (quest.current >= quest.required) {
                        completeQuest(quest.id);
                    }
                }
            });
            
            if (questUpdated) {
                updateQuestCount();
            }
        }

        function completeQuest(questId) {
            const questIndex = gameState.quests.findIndex(q => q.id === questId);
            if (questIndex === -1) return;
            
            const quest = gameState.quests[questIndex];
            
            // Give rewards
            gameState.gold += quest.reward.gold;
            gameState.xp += quest.reward.xp;
            gameState.completedQuests++;
            
            // Check for special item rewards
            if (quest.reward.item) {
                if (quest.reward.item === "HEALING POTION") {
                    gameState.potions++;
                } else if (quest.reward.item === "MAGIC AMULET") {
                    gameState.magic += 2;
                } else if (quest.reward.item === "CRYSTAL SHARD") {
                    gameState.foundItems.push("CRYSTAL SHARD");
                } else if (quest.reward.item === "TROLL HIDE ARMOR") {
                    gameState.armor = "TROLL HIDE ARMOR";
                    gameState.armorDefense = 5;
                } else if (quest.reward.item === "DRAGON SCALE ARMOR") {
                    gameState.armor = "DRAGON SCALE ARMOR";
                    gameState.armorDefense = 10;
                } else if (quest.reward.item === "SERPENT FANG DAGGER") {
                    gameState.weapon = "SERPENT FANG DAGGER";
                    gameState.weaponDamage = [12, 25];
                }
            }
            
            // Show completion message
            document.getElementById('townMessage').innerHTML = 
                `<p class="quest">QUEST COMPLETED: ${quest.title}</p>
                 <p>REWARD: ${quest.reward.gold} GOLD, ${quest.reward.xp} XP</p>`;
            
            // Remove quest from active list
            gameState.quests.splice(questIndex, 1);
            updateQuestCount();
            checkLevelUp();
            updateStatusBar();
        }

        function updateQuestCount() {
            document.getElementById('questCount').textContent = gameState.quests.length;
        }

        function updateQuestsDisplay() {
            const questsList = document.getElementById('questsList');
            questsList.innerHTML = '';
            
            if (gameState.quests.length === 0) {
                questsList.innerHTML = '<p>NO ACTIVE QUESTS. VISIT THE INN TO FIND SOME.</p>';
                return;
            }
            
            gameState.quests.forEach(quest => {
                const questElement = document.createElement('div');
                questElement.className = 'quest-item';
                
                const progressPercent = Math.min((quest.current / quest.required) * 100, 100);
                
                questElement.innerHTML = `
                    <strong>${quest.title}</strong>
                    <div style="color: #aaa; font-size: 11px; margin: 5px 0;">${quest.description}</div>
                    <div>PROGRESS: ${quest.current}/${quest.required}</div>
                    <div class="quest-progress">
                        <div class="quest-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="quest-reward">REWARD: ${quest.reward.gold} GOLD, ${quest.reward.xp} XP</div>
                `;
                
                questsList.appendChild(questElement);
            });
        }

        function abandonAllQuests() {
            if (gameState.quests.length > 0) {
                if (confirm("ABANDON ALL QUESTS? YOU WILL LOSE ALL PROGRESS.")) {
                    gameState.quests = [];
                    updateQuestCount();
                    document.getElementById('questsMessage').innerHTML = 
                        "<p class='damage'>ALL QUESTS ABANDONED.</p>";
                    updateQuestsDisplay();
                }
            }
        }

        // Exploration System Functions (from original code)
        function goToExploration() {
            if (gameState.health <= 0) {
                document.getElementById('townMessage').innerHTML = "<p class='damage'>YOU ARE TOO INJURED TO EXPLORE. VISIT THE INN TO REST.</p>";
                return;
            }
            
            showScreen('explorationScreen');
        }

        function updateExplorationAreas() {
            // Show/Hide areas based on discovery and level
            const crystalCaves = document.getElementById('crystalCavesArea');
            const ancientRuins = document.getElementById('ancientRuinsArea');
            const dragonsPeak = document.getElementById('dragonsPeakArea');
            const mysticLake = document.getElementById('mysticLakeArea');
            
            // Crystal Caves unlocked at level 2 or with map
            if (gameState.level >= 2 || gameState.hasMap || gameState.discoveredAreas.includes("crystal_caves")) {
                crystalCaves.style.display = "block";
                if (!gameState.discoveredAreas.includes("crystal_caves")) {
                    gameState.discoveredAreas.push("crystal_caves");
                }
            }
            
            // Ancient Ruins unlocked at level 3 or with map
            if (gameState.level >= 3 || gameState.hasMap || gameState.discoveredAreas.includes("ancient_ruins")) {
                ancientRuins.style.display = "block";
                if (!gameState.discoveredAreas.includes("ancient_ruins")) {
                    gameState.discoveredAreas.push("ancient_ruins");
                }
            }
            
            // Dragon's Peak unlocked at level 5
            if (gameState.level >= 5 || gameState.discoveredAreas.includes("dragons_peak")) {
                dragonsPeak.style.display = "block";
                if (!gameState.discoveredAreas.includes("dragons_peak")) {
                    gameState.discoveredAreas.push("dragons_peak");
                }
            }
            
            // Mystic Lake unlocked with map or at level 2
            if (gameState.hasMap || gameState.level >= 2 || gameState.discoveredAreas.includes("mystic_lake")) {
                mysticLake.style.display = "block";
                if (!gameState.discoveredAreas.includes("mystic_lake")) {
                    gameState.discoveredAreas.push("mystic_lake");
                }
            }
        }

        function exploreArea(areaId) {
            const area = explorationAreas[areaId];
            if (!area) return;
            
            if (gameState.level < area.minLevel) {
                document.getElementById('explorationResult').innerHTML = 
                    `<p class="damage">YOU ARE NOT STRONG ENOUGH TO EXPLORE THIS AREA. REQUIRES LEVEL ${area.minLevel}.</p>`;
                return;
            }
            
            gameState.currentExploration = areaId;
            gameState.explorationStep = 0;
            
            document.getElementById('explorationResult').innerHTML = 
                `<p>YOU ENTER THE ${area.name}...</p>`;
            
            document.getElementById('continueExploreButton').style.display = "inline-block";
            
            // Start exploration
            continueExploring();
        }

        function continueExploring() {
            if (!gameState.currentExploration) return;
            
            const area = explorationAreas[gameState.currentExploration];
            const explorationResult = document.getElementById('explorationResult');
            gameState.explorationStep++;
            
            // Chance to find random encounter
            const encounterRoll = Math.random() * 100;
            let encounterType = "nothing";
            let totalWeight = 0;
            
            for (const encounter of area.encounters) {
                totalWeight += encounter.weight;
                if (encounterRoll <= totalWeight) {
                    encounterType = encounter.type;
                    break;
                }
            }
            
            let resultText = "";
            
            switch (encounterType) {
                case "combat":
                    // Get monster appropriate for area and player level
                    const areaMonsters = monsters.filter(m => 
                        m.area.includes(gameState.currentExploration) && 
                        m.level <= gameState.level + 2
                    );
                    
                    if (areaMonsters.length > 0) {
                        const monster = areaMonsters[Math.floor(Math.random() * areaMonsters.length)];
                        resultText = `YOU ENCOUNTER A <span class="monster">${monster.name}</span>!<br>`;
                        
                        // Offer combat choice
                        resultText += `<br>DO YOU WANT TO FIGHT?<br>
                            <button onclick="startExplorationCombat('${monster.name}')" style="margin: 5px;">FIGHT</button>
                            <button onclick="fleeFromEncounter()" style="margin: 5px;">FLEE</button>`;
                    } else {
                        resultText = "YOU EXPLORE THE AREA BUT FIND NOTHING OF INTEREST.";
                    }
                    break;
                    
                case "treasure":
                    const goldFound = Math.floor(Math.random() * 50) + 20;
                    gameState.gold += goldFound;
                    resultText = `YOU FIND A TREASURE CHEST!<br>YOU GAIN <span class="gold">${goldFound} GOLD</span>.`;
                    updateStatusBar();
                    break;
                    
                case "quest_item":
                    if (Math.random() < 0.3) {
                        if (gameState.currentExploration === "haunted_woods") {
                            resultText = `YOU FIND AN <span class="item">ANCIENT AMULET</span>!<br>`;
                            updateQuestProgress(null, "ANCIENT AMULET");
                        } else if (gameState.currentExploration === "crystal_caves") {
                            resultText = `YOU FIND A <span class="item">GLOWING CRYSTAL</span>!<br>`;
                            updateQuestProgress(null, "GLOWING CRYSTAL");
                        } else {
                            resultText = "YOU FIND A MYSTERIOUS ARTIFACT.";
                        }
                    } else {
                        resultText = "YOU SEARCH THE AREA BUT FIND NOTHING.";
                    }
                    break;
                    
                case "crystal":
                    const crystals = Math.floor(Math.random() * 3) + 1;
                    gameState.gold += crystals * 15;
                    resultText = `YOU FIND ${crystals} GLOWING CRYSTAL${crystals > 1 ? 'S' : ''}!<br>
                        YOU GAIN <span class="gold">${crystals * 15} GOLD</span>.`;
                    updateStatusBar();
                    break;
                    
                case "artifact":
                    if (Math.random() < 0.2) {
                        gameState.strength += 1;
                        gameState.agility += 1;
                        gameState.magic += 1;
                        resultText = `YOU FIND AN ANCIENT ARTIFACT!<br>
                            YOUR STRENGTH, AGILITY, AND MAGIC INCREASE BY 1!`;
                        updateStatusBar();
                    } else {
                        resultText = "YOU FIND BROKEN RELICS OF THE PAST.";
                    }
                    break;
                    
                case "dragon_hoard":
                    const dragonGold = Math.floor(Math.random() * 200) + 100;
                    gameState.gold += dragonGold;
                    resultText = `YOU FIND PART OF THE DRAGON'S HOARD!<br>
                        YOU GAIN <span class="gold">${dragonGold} GOLD</span>.`;
                    updateStatusBar();
                    break;
                    
                case "fishing":
                    const fishGold = Math.floor(Math.random() * 30) + 10;
                    gameState.gold += fishGold;
                    resultText = `YOU CATCH SOME RARE FISH!<br>
                        YOU GAIN <span class="gold">${fishGold} GOLD</span>.`;
                    updateStatusBar();
                    break;
                    
                case "magic":
                    if (gameState.health < gameState.maxHealth) {
                        const healAmount = Math.floor(Math.random() * 30) + 20;
                        gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
                        resultText = `THE MAGICAL WATERS HEAL YOU FOR <span class="heal">${healAmount} HP</span>.`;
                        updateStatusBar();
                    } else {
                        resultText = "YOU FEEL THE MAGIC IN THE AIR, BUT IT HAS NO EFFECT.";
                    }
                    break;
                    
                case "trap":
                    const trapDamage = Math.floor(Math.random() * 15) + 5;
                    gameState.health -= trapDamage;
                    resultText = `YOU TRIGGER A TRAP!<br>
                        YOU TAKE <span class="damage">${trapDamage} DAMAGE</span>.`;
                    updateStatusBar();
                    
                    if (gameState.health <= 0) {
                        gameState.gameOver = true;
                        setTimeout(() => {
                            document.getElementById('finalDay').textContent = gameState.day;
                            document.getElementById('finalLevel').textContent = gameState.level;
                            document.getElementById('finalQuests').textContent = gameState.completedQuests;
                            showScreen('gameOverScreen');
                        }, 1500);
                    }
                    break;
                    
                case "escape":
                    resultText = "YOU NEARLY FALL INTO A PIT! YOU QUICKLY RETREAT.";
                    gameState.currentExploration = null;
                    document.getElementById('continueExploreButton').style.display = "none";
                    break;
                    
                default:
                    // Special event chance
                    if (Math.random() < 0.2 && area.specialEvents) {
                        const event = area.specialEvents[Math.floor(Math.random() * area.specialEvents.length)];
                        resultText = event;
                        
                        // Handle specific events
                        if (event.includes("RUSTY SWORD")) {
                            if (gameState.weapon === "RUSTY DAGGER") {
                                gameState.weapon = "RUSTY SWORD";
                                gameState.weaponDamage = [4, 9];
                                resultText += "<br>YOUR WEAPON IS UPGRADED!";
                            }
                        } else if (event.includes("HEALTH FULLY")) {
                            gameState.health = gameState.maxHealth;
                            updateStatusBar();
                        } else if (event.includes("GOLD")) {
                            const foundGold = Math.floor(Math.random() * 40) + 20;
                            gameState.gold += foundGold;
                            resultText += `<br>YOU FIND <span class="gold">${foundGold} GOLD</span>.`;
                            updateStatusBar();
                        } else if (event.includes("WISDOM")) {
                            gameState.strength += 1;
                            gameState.agility += 1;
                            gameState.magic += 1;
                            updateStatusBar();
                        } else if (event.includes("DRAGON EGG")) {
                            gameState.gold += 500;
                            resultText += "<br>IT'S WORTH 500 GOLD!";
                            updateStatusBar();
                        }
                    } else {
                        resultText = "YOU EXPLORE THE AREA BUT FIND NOTHING OF INTEREST.";
                    }
            }
            
            explorationResult.innerHTML += `<br>${resultText}<br>`;
            explorationResult.scrollTop = explorationResult.scrollHeight;
            
            // Limit exploration steps
            if (gameState.explorationStep >= 5) {
                explorationResult.innerHTML += `<br><strong>YOU'VE EXPLORED ENOUGH FOR NOW. TIME TO RETURN TO TOWN.</strong>`;
                document.getElementById('continueExploreButton').style.display = "none";
                gameState.currentExploration = null;
            }
        }

        function startExplorationCombat(monsterName) {
            const monster = monsters.find(m => m.name === monsterName);
            if (!monster) return;
            
            gameState.currentMonster = monster;
            gameState.monsterHealth = monster.health;
            gameState.inCombat = true;
            
            // Update combat screen
            document.getElementById('combatLog').innerHTML = `YOU ENCOUNTER A <span class="monster">${gameState.currentMonster.name}</span>!<br>`;
            document.getElementById('monsterInfo').innerHTML = `
                <h3>${gameState.currentMonster.name}</h3>
                <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                <p>LEVEL: ${gameState.currentMonster.level}</p>
            `;
            
            // Enable/disable spell button based on class
            const spellButton = document.getElementById('spellButton');
            const skillButton = document.getElementById('skillButton');
            if (gameState.playerClass === 'mage') {
                spellButton.disabled = false;
            } else {
                spellButton.disabled = true;
            }
            
            // Enable skill button if player has active skills
            let hasActiveSkills = false;
            const classSkills = skillsDatabase[gameState.playerClass];
            for (const skillId in classSkills) {
                if (classSkills[skillId].type === "active" && gameState.skills[skillId].level > 0) {
                    hasActiveSkills = true;
                    break;
                }
            }
            skillButton.disabled = !hasActiveSkills;
            
            showScreen('forestScreen');
        }

        function fleeFromEncounter() {
            const explorationResult = document.getElementById('explorationResult');
            const fleeChance = gameState.agility / 100 + 0.3;
            
            if (Math.random() < fleeChance) {
                explorationResult.innerHTML += `<br>YOU SUCCESSFULLY FLEE FROM THE ENCOUNTER.`;
            } else {
                // Take damage while fleeing
                const fleeDamage = Math.floor(Math.random() * 10) + 5;
                gameState.health -= fleeDamage;
                explorationResult.innerHTML += `<br>YOU TAKE <span class="damage">${fleeDamage} DAMAGE</span> WHILE FLEEING.`;
                updateStatusBar();
                
                if (gameState.health <= 0) {
                    gameState.gameOver = true;
                    setTimeout(() => {
                        document.getElementById('finalDay').textContent = gameState.day;
                        document.getElementById('finalLevel').textContent = gameState.level;
                        document.getElementById('finalQuests').textContent = gameState.completedQuests;
                        showScreen('gameOverScreen');
                    }, 1500);
                }
            }
            
            explorationResult.scrollTop = explorationResult.scrollHeight;
        }

        // Town functions
        function goToForest() {
            if (gameState.health <= 0) {
                document.getElementById('townMessage').innerHTML = "<p class='damage'>YOU ARE TOO INJURED TO FIGHT. VISIT THE INN TO REST.</p>";
                return;
            }
            
            // Determine monster level based on player level and day
            let monsterLevel = Math.min(Math.floor(gameState.day / 3) + 1, 7);
            
            // Higher chance of stronger monsters as player levels up
            if (gameState.level > 3) {
                monsterLevel += Math.floor((gameState.level - 3) / 2);
            }
            
            // Filter monsters by level
            const availableMonsters = monsters.filter(m => m.level <= monsterLevel && m.area.includes("forest"));
            
            // Small chance for dragon after day 10 and level 5
            if (gameState.day > 10 && gameState.level >= 5 && Math.random() < 0.1 && !gameState.dragonDefeated) {
                gameState.currentMonster = monsters.find(m => m.name === "RED DRAGON");
            } else {
                // Weighted random selection (lower level monsters more common)
                const weightedMonsters = [];
                availableMonsters.forEach((monster, index) => {
                    const weight = 10 - monster.level;
                    for (let i = 0; i < weight; i++) {
                        weightedMonsters.push(monster);
                    }
                });
                
                gameState.currentMonster = weightedMonsters[Math.floor(Math.random() * weightedMonsters.length)];
            }
            
            if (!gameState.currentMonster) {
                gameState.currentMonster = monsters[0]; // Default to goblin
            }
            
            gameState.monsterHealth = gameState.currentMonster.health;
            gameState.inCombat = true;
            
            // Update combat screen
            document.getElementById('combatLog').innerHTML = `YOU ENCOUNTER A <span class="monster">${gameState.currentMonster.name}</span>!<br>`;
            document.getElementById('monsterInfo').innerHTML = `
                <h3>${gameState.currentMonster.name}</h3>
                <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                <p>LEVEL: ${gameState.currentMonster.level}</p>
            `;
            
            // Enable/disable spell button based on class
            const spellButton = document.getElementById('spellButton');
            const skillButton = document.getElementById('skillButton');
            if (gameState.playerClass === 'mage') {
                spellButton.disabled = false;
            } else {
                spellButton.disabled = true;
            }
            
            // Enable skill button if player has active skills
            let hasActiveSkills = false;
            const classSkills = skillsDatabase[gameState.playerClass];
            for (const skillId in classSkills) {
                if (classSkills[skillId].type === "active" && gameState.skills[skillId].level > 0) {
                    hasActiveSkills = true;
                    break;
                }
            }
            skillButton.disabled = !hasActiveSkills;
            
            showScreen('forestScreen');
        }

        function goToInn() {
            showScreen('innScreen');
        }

        function goToStore() {
            showScreen('storeScreen');
        }

        function goToQuests() {
            showScreen('questsScreen');
        }

        function goToStats() {
            // Update stats screen
            document.getElementById('statName').textContent = gameState.playerName;
            document.getElementById('statClass').textContent = gameState.playerClass.toUpperCase();
            document.getElementById('statLevel').textContent = gameState.level;
            document.getElementById('statXP').textContent = gameState.xp;
            document.getElementById('statNextXP').textContent = gameState.nextLevelXP;
            document.getElementById('statSTR').textContent = gameState.strength;
            document.getElementById('statAGI').textContent = gameState.agility;
            document.getElementById('statMAG').textContent = gameState.magic;
            document.getElementById('statHP').textContent = gameState.health;
            document.getElementById('statMaxHP').textContent = gameState.maxHealth;
            document.getElementById('statWeapon').textContent = gameState.weapon;
            document.getElementById('statDamage').textContent = `${gameState.weaponDamage[0]}-${gameState.weaponDamage[1]}`;
            document.getElementById('statArmor').textContent = gameState.armor;
            document.getElementById('statGold').textContent = gameState.gold;
            document.getElementById('statQuestsCompleted').textContent = gameState.completedQuests;
            document.getElementById('statMonstersSlain').textContent = gameState.kills;
            document.getElementById('statAreasExplored').textContent = gameState.discoveredAreas.length;
            document.getElementById('statDays').textContent = gameState.day;
            
            showScreen('statsScreen');
        }

        function endDay() {
            gameState.day++;
            
            // Health regeneration (more if well-rested)
            const healAmount = Math.min(20 + gameState.level * 2, gameState.maxHealth - gameState.health);
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
            
            updateStatusBar();
            document.getElementById('townMessage').innerHTML = `<p class="heal">YOU REST FOR THE DAY AND RECOVER ${healAmount} HP.</p>`;
        }

        // Inn functions
        function innRest() {
            const innResult = document.getElementById('innResult');
            
            if (gameState.gold >= 10) {
                gameState.gold -= 10;
                gameState.health = gameState.maxHealth;
                
                innResult.innerHTML = `<p class="heal">YOU REST AT THE INN AND RECOVER ALL YOUR HEALTH. YOU FEEL REFRESHED!</p>`;
                updateStatusBar();
            } else {
                innResult.innerHTML = `<p class="damage">YOU DON'T HAVE ENOUGH GOLD TO REST AT THE INN.</p>`;
            }
        }

        function innChat() {
            const innResult = document.getElementById('innResult');
            const messages = [
                "THE BARMAID TELLS YOU ABOUT STRANGE NOISES COMING FROM THE FOREST.",
                "THE BARMAID SHARES A RUMOR ABOUT A TREASURE HIDDEN IN THE MOUNTAINS.",
                "THE BARMAID WARNS YOU ABOUT THE RED DRAGON'S INCREASING ATTACKS.",
                "THE BARMAID MENTIONS THAT THE BLACKSMITH HAS NEW WEAPONS IN STOCK.",
                "THE BARMAID WHISPERS ABOUT A SECRET PASSAGE BEHIND THE WATERFALL.",
                "THE BARMAID SAYS SHE SAW A GROUP OF ADVENTURERS HEAD NORTH YESTERDAY."
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            innResult.innerHTML = `<p>${randomMessage}</p>`;
        }

        function innSpecial() {
            const innResult = document.getElementById('innResult');
            
            if (!gameState.visitedInn) {
                innResult.innerHTML = `<p>THE MYSTERIOUS WOMAN APPROACHES YOU. 'I'VE BEEN WAITING FOR YOU, ${gameState.playerName}. THE RED DRAGON MUST BE STOPPED. TAKE THIS POTION, IT MAY HELP YOU.'</p>`;
                gameState.potions++;
                updatePotionButton();
                gameState.visitedInn = true;
                
                // Check story progress (Chapter 1)
                if (gameState.mainStory.currentChapter === 0) {
                    checkStoryProgress();
                }
            } else {
                innResult.innerHTML = `<p>THE MYSTERIOUS WOMAN SMILES AT YOU. 'BE CAREFUL IN THE FOREST, ${gameState.playerName}. THE DRAGON GROWS STRONGER EACH DAY.'</p>`;
            }
        }

        function innGamble() {
            const innResult = document.getElementById('innResult');
            
            if (gameState.gold >= 5) {
                gameState.gold -= 5;
                
                const playerRoll = Math.floor(Math.random() * 6) + 1;
                const houseRoll = Math.floor(Math.random() * 6) + 1;
                
                innResult.innerHTML = `<p>YOU ROLL A ${playerRoll}. THE HOUSE ROLLS A ${houseRoll}.</p>`;
                
                if (playerRoll > houseRoll) {
                    const winnings = 10;
                    gameState.gold += winnings;
                    innResult.innerHTML += `<p class="heal">YOU WIN ${winnings} GOLD!</p>`;
                } else if (playerRoll < houseRoll) {
                    innResult.innerHTML += `<p class="damage">YOU LOSE! BETTER LUCK NEXT TIME.</p>`;
                } else {
                    gameState.gold += 5; // Return bet on tie
                    innResult.innerHTML += `<p>IT'S A TIE! YOUR BET IS RETURNED.</p>`;
                }
                
                updateStatusBar();
            } else {
                innResult.innerHTML = `<p class="damage">YOU NEED 5 GOLD TO PLAY THE DICE GAME.</p>`;
            }
        }

        function getQuestFromInn() {
            const innResult = document.getElementById('innResult');
            
            // Check for available quests based on player level
            const availableQuests = quests.filter(q => 
                q.level <= gameState.level + 1 && 
                !gameState.quests.some(activeQ => activeQ.id === q.id) &&
                gameState.completedQuests < 10 // Limit total quests
            );
            
            if (availableQuests.length === 0) {
                innResult.innerHTML = `<p>THERE ARE NO NEW QUESTS AVAILABLE AT THE MOMENT.</p>`;
                return;
            }
            
            // Randomly select a quest
            const randomQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
            addQuest(randomQuest.id);
            
            innResult.innerHTML = `<p class="quest">A TRAVELER OFFERS YOU A QUEST: ${randomQuest.title}</p>
                                 <p>${randomQuest.description}</p>`;
        }

        // Store functions
        function buyItem(item, cost) {
            const storeMessage = document.getElementById('storeMessage');
            
            if (gameState.gold >= cost) {
                gameState.gold -= cost;
                
                switch(item) {
                    case 'dagger':
                        gameState.weapon = "IRON DAGGER";
                        gameState.weaponDamage = [5, 12];
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE AN IRON DAGGER. YOUR DAMAGE INCREASES!</p>`;
                        break;
                    case 'sword':
                        gameState.weapon = "STEEL SWORD";
                        gameState.weaponDamage = [8, 18];
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE A STEEL SWORD. YOUR DAMAGE INCREASES SIGNIFICANTLY!</p>`;
                        break;
                    case 'armor':
                        gameState.armor = "LEATHER ARMOR";
                        gameState.armorDefense = 3;
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE LEATHER ARMOR. YOU TAKE LESS DAMAGE FROM ATTACKS!</p>`;
                        break;
                    case 'potion':
                        gameState.potions++;
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE A HEALING POTION. YOU NOW HAVE ${gameState.potions} POTION(S).</p>`;
                        updatePotionButton();
                        break;
                    case 'shield':
                        gameState.shield = "WOODEN SHIELD";
                        gameState.shieldDefense = 2;
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE A WOODEN SHIELD. YOUR DEFENSE INCREASES!</p>`;
                        break;
                    case 'map':
                        gameState.hasMap = true;
                        storeMessage.innerHTML = `<p class="heal">YOU PURCHASE AN EXPLORER'S MAP. NEW AREAS ARE NOW AVAILABLE!</p>`;
                        updateExplorationAreas();
                        document.getElementById('mapItem').style.display = 'none';
                        break;
                }
                
                updateStatusBar();
            } else {
                storeMessage.innerHTML = `<p class="damage">YOU DON'T HAVE ENOUGH GOLD FOR THAT ITEM.</p>`;
            }
        }

        // Combat functions (updated with skill system)
        function attackMonster() {
            if (!gameState.inCombat || gameState.monsterHealth <= 0) return;
            
            const combatLog = document.getElementById('combatLog');
            
            // Check passive skills
            const skillEffects = checkPassiveSkills();
            
            // Player attacks
            let attackCount = 1;
            if (skillEffects.doubleAttack) {
                attackCount = 2;
                combatLog.innerHTML += `<span class="heal">DOUBLE STRIKE ACTIVATED!</span><br>`;
            }
            
            for (let i = 0; i < attackCount; i++) {
                const baseDamage = Math.floor(Math.random() * (gameState.weaponDamage[1] - gameState.weaponDamage[0] + 1)) + gameState.weaponDamage[0];
                const strengthBonus = Math.floor(gameState.strength / 5);
                let playerDamage = baseDamage + strengthBonus;
                
                // Apply berserker rage if active
                if (skillEffects.damageBonus) {
                    playerDamage = Math.floor(playerDamage * (1 + skillEffects.damageBonus));
                }
                
                // Critical hit chance based on agility
                const critChance = gameState.agility * 0.01;
                const isCrit = Math.random() < critChance;
                const finalDamage = isCrit ? playerDamage * 2 : playerDamage;
                
                gameState.monsterHealth -= finalDamage;
                gameState.totalDamage += finalDamage;
                
                combatLog.innerHTML += `<span class="player">YOU</span> HIT THE <span class="monster">${gameState.currentMonster.name}</span> FOR <span class="damage">${finalDamage}</span> DAMAGE${isCrit ? ' (CRITICAL!)' : ''}.<br>`;
                
                // Check if monster is dead
                if (gameState.monsterHealth <= 0) {
                    combatLog.innerHTML += `YOU HAVE DEFEATED THE <span class="monster">${gameState.currentMonster.name}</span>!<br>`;
                    gameState.kills++;
                    
                    // Update quest progress
                    updateQuestProgress(gameState.currentMonster.name, null);
                    
                    // Check if this is a dungeon boss
                    if (gameState.activeDungeon && gameState.currentMonster.name === dungeons[gameState.activeDungeon].boss) {
                        completeDungeonFloor();
                        return;
                    }
                    
                    // Award XP and gold with skill bonuses
                    const xpGained = Math.floor(gameState.currentMonster.xp * skillEffects.extraXP);
                    const goldGained = Math.floor((Math.random() * (gameState.currentMonster.gold[1] - gameState.currentMonster.gold[0] + 1)) + gameState.currentMonster.gold[0]) * skillEffects.extraGold;
                    
                    gameState.xp += xpGained;
                    gameState.gold += goldGained;
                    
                    combatLog.innerHTML += `YOU GAIN <span class="xp">${xpGained} XP</span> AND <span class="gold">${goldGained} GOLD</span>.<br>`;
                    
                    // Chance for potion drop (10%)
                    if (Math.random() < 0.1) {
                        gameState.potions++;
                        combatLog.innerHTML += `THE MONSTER DROPPED A <span class="heal">HEALING POTION</span>!<br>`;
                        updatePotionButton();
                    }
                    
                    // Chance for special item drop
                    if (Math.random() < 0.05) {
                        const specialItems = ["MYSTERIOUS KEY", "ANCIENT COIN", "GLOWING GEM"];
                        const foundItem = specialItems[Math.floor(Math.random() * specialItems.length)];
                        gameState.foundItems.push(foundItem);
                        combatLog.innerHTML += `YOU FIND A <span class="item">${foundItem}</span>!<br>`;
                    }
                    
                    // Check for dragon victory
                    if (gameState.currentMonster.name === "RED DRAGON") {
                        gameState.dragonDefeated = true;
                        updateQuestProgress("RED DRAGON", null);
                        checkStoryProgress();
                        setTimeout(() => {
                            document.getElementById('victoryDay').textContent = gameState.day;
                            document.getElementById('victoryLevel').textContent = gameState.level;
                            document.getElementById('victoryQuests').textContent = gameState.completedQuests;
                            showScreen('victoryScreen');
                        }, 2500);
                    }
                    
                    // Check for level up
                    checkLevelUp();
                    updateStatusBar();
                    gameState.inCombat = false;
                    
                    return;
                }
            }
            
            // Monster attacks back
            const monsterDamage = Math.floor(Math.random() * (gameState.currentMonster.damage[1] - gameState.currentMonster.damage[0] + 1)) + gameState.currentMonster.damage[0];
            // Apply armor and shield reduction
            const totalDefense = gameState.armorDefense + gameState.shieldDefense;
            const actualDamage = Math.max(1, monsterDamage - totalDefense);
            gameState.health -= actualDamage;
            
            combatLog.innerHTML += `THE <span class="monster">${gameState.currentMonster.name}</span> HITS YOU FOR <span class="damage">${actualDamage}</span> DAMAGE.<br>`;
            
            // Update monster info
            document.getElementById('monsterInfo').innerHTML = `
                <h3>${gameState.currentMonster.name}</h3>
                <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                <p>LEVEL: ${gameState.currentMonster.level}</p>
            `;
            
            updateStatusBar();
            
            // Check if player is dead
            if (gameState.health <= 0) {
                combatLog.innerHTML += `<span class="damage">YOU HAVE BEEN DEFEATED BY THE ${gameState.currentMonster.name}!</span><br>`;
                gameState.gameOver = true;
                
                setTimeout(() => {
                    document.getElementById('finalDay').textContent = gameState.day;
                    document.getElementById('finalLevel').textContent = gameState.level;
                    document.getElementById('finalQuests').textContent = gameState.completedQuests;
                    showScreen('gameOverScreen');
                }, 2500);
            }
            
            // Auto-scroll combat log
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function useSpell() {
            if (!gameState.inCombat || gameState.monsterHealth <= 0 || gameState.playerClass !== 'mage') return;
            
            const combatLog = document.getElementById('combatLog');
            const spellDamage = gameState.magic * 2 + Math.floor(Math.random() * 10);
            gameState.monsterHealth -= spellDamage;
            gameState.totalDamage += spellDamage;
            
            combatLog.innerHTML += `YOU CAST A FIREBALL AT THE <span class="monster">${gameState.currentMonster.name}</span> FOR <span class="damage">${spellDamage}</span> DAMAGE!<br>`;
            
            // Monster attacks back
            if (gameState.monsterHealth > 0) {
                const monsterDamage = Math.floor(Math.random() * (gameState.currentMonster.damage[1] - gameState.currentMonster.damage[0] + 1)) + gameState.currentMonster.damage[0];
                const totalDefense = gameState.armorDefense + gameState.shieldDefense;
                const actualDamage = Math.max(1, monsterDamage - totalDefense);
                gameState.health -= actualDamage;
                
                combatLog.innerHTML += `THE <span class="monster">${gameState.currentMonster.name}</span> HITS YOU FOR <span class="damage">${actualDamage}</span> DAMAGE.<br>`;
                
                // Update monster info
                document.getElementById('monsterInfo').innerHTML = `
                    <h3>${gameState.currentMonster.name}</h3>
                    <p>HEALTH: ${gameState.monsterHealth}/${gameState.currentMonster.health}</p>
                    <p>DAMAGE: ${gameState.currentMonster.damage[0]}-${gameState.currentMonster.damage[1]}</p>
                    <p>LEVEL: ${gameState.currentMonster.level}</p>
                `;
                
                updateStatusBar();
                
                // Check if player is dead
                if (gameState.health <= 0) {
                    combatLog.innerHTML += `<span class="damage">YOU HAVE BEEN DEFEATED BY THE ${gameState.currentMonster.name}!</span><br>`;
                    gameState.gameOver = true;
                    
                    setTimeout(() => {
                        document.getElementById('finalDay').textContent = gameState.day;
                        document.getElementById('finalLevel').textContent = gameState.level;
                        document.getElementById('finalQuests').textContent = gameState.completedQuests;
                        showScreen('gameOverScreen');
                    }, 2500);
                }
            } else {
                combatLog.innerHTML += `YOU HAVE DEFEATED THE <span class="monster">${gameState.currentMonster.name}</span>!<br>`;
                gameState.kills++;
                
                // Update quest progress
                updateQuestProgress(gameState.currentMonster.name, null);
                
                // Check if this is a dungeon boss
                if (gameState.activeDungeon && gameState.currentMonster.name === dungeons[gameState.activeDungeon].boss) {
                    completeDungeonFloor();
                    return;
                }
                
                // Award XP and gold
                const skillEffects = checkPassiveSkills();
                const xpGained = Math.floor(gameState.currentMonster.xp * skillEffects.extraXP);
                const goldGained = Math.floor((Math.random() * (gameState.currentMonster.gold[1] - gameState.currentMonster.gold[0] + 1)) + gameState.currentMonster.gold[0]) * skillEffects.extraGold;
                
                gameState.xp += xpGained;
                gameState.gold += goldGained;
                
                combatLog.innerHTML += `YOU GAIN <span class="xp">${xpGained} XP</span> AND <span class="gold">${goldGained} GOLD</span>.<br>`;
                
                // Chance for potion drop
                if (Math.random() < 0.1) {
                    gameState.potions++;
                    combatLog.innerHTML += `THE MONSTER DROPPED A <span class="heal">HEALING POTION</span>!<br>`;
                    updatePotionButton();
                }
                
                // Check for dragon victory
                if (gameState.currentMonster.name === "RED DRAGON") {
                    gameState.dragonDefeated = true;
                    updateQuestProgress("RED DRAGON", null);
                    checkStoryProgress();
                    setTimeout(() => {
                        document.getElementById('victoryDay').textContent = gameState.day;
                        document.getElementById('victoryLevel').textContent = gameState.level;
                        document.getElementById('victoryQuests').textContent = gameState.completedQuests;
                        showScreen('victoryScreen');
                    }, 2500);
                }
                
                // Check for level up
                checkLevelUp();
                updateStatusBar();
                gameState.inCombat = false;
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function usePotion() {
            if (gameState.potions <= 0) return;
            
            const combatLog = document.getElementById('combatLog');
            const healAmount = 50;
            gameState.health = Math.min(gameState.maxHealth, gameState.health + healAmount);
            gameState.potions--;
            
            combatLog.innerHTML += `<span class="player">YOU</span> USE A <span class="heal">HEALING POTION</span> AND RECOVER <span class="heal">${healAmount} HP</span>.<br>`;
            
            updateStatusBar();
            updatePotionButton();
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function fleeCombat() {
            const combatLog = document.getElementById('combatLog');
            let fleeChance = gameState.agility / 100 + 0.2;
            
            // Check for smoke bomb skill
            if (gameState.skills.smoke_bomb && gameState.skills.smoke_bomb.level > 0) {
                const smokeBombSkill = skillsDatabase.thief.smoke_bomb;
                fleeChance = smokeBombSkill.escapeChance + (smokeBombSkill.perLevel * (gameState.skills.smoke_bomb.level - 1));
                combatLog.innerHTML += `YOU USE <span class="heal">SMOKE BOMB</span> TO ESCAPE!<br>`;
            }
            
            if (Math.random() < fleeChance) {
                combatLog.innerHTML += `YOU SUCCESSFULLY FLEE FROM THE <span class="monster">${gameState.currentMonster.name}</span>!<br>`;
                gameState.inCombat = false;
                
                // If in dungeon, return to dungeon screen
                if (gameState.activeDungeon) {
                    setTimeout(() => {
                        showScreen('dungeonsScreen');
                    }, 1500);
                } else {
                    setTimeout(() => showScreen('townScreen'), 1500);
                }
            } else {
                combatLog.innerHTML += `YOU FAIL TO FLEE!<br>`;
                
                // Monster attacks
                const monsterDamage = Math.floor(Math.random() * (gameState.currentMonster.damage[1] - gameState.currentMonster.damage[0] + 1)) + gameState.currentMonster.damage[0];
                const totalDefense = gameState.armorDefense + gameState.shieldDefense;
                const actualDamage = Math.max(1, monsterDamage - totalDefense);
                gameState.health -= actualDamage;
                
                combatLog.innerHTML += `THE <span class="monster">${gameState.currentMonster.name}</span> HITS YOU FOR <span class="damage">${actualDamage}</span> DAMAGE.<br>`;
                
                updateStatusBar();
                
                // Check if player is dead
                if (gameState.health <= 0) {
                    combatLog.innerHTML += `<span class="damage">YOU HAVE BEEN DEFEATED BY THE ${gameState.currentMonster.name}!</span><br>`;
                    gameState.gameOver = true;
                    
                    setTimeout(() => {
                        document.getElementById('finalDay').textContent = gameState.day;
                        document.getElementById('finalLevel').textContent = gameState.level;
                        document.getElementById('finalQuests').textContent = gameState.completedQuests;
                        showScreen('gameOverScreen');
                    }, 2500);
                }
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
        }

        function goToTown() {
            gameState.currentExploration = null;
            gameState.activeDungeon = null;
            gameState.inCombat = false;
            showScreen('townScreen');
        }

        // Game mechanics
        function checkLevelUp() {
            while (gameState.xp >= gameState.nextLevelXP) {
                gameState.level++;
                gameState.xp -= gameState.nextLevelXP;
                gameState.nextLevelXP = Math.floor(gameState.nextLevelXP * 1.5);
                
                // Award skill point
                gameState.skillPoints++;
                
                // Increase stats
                gameState.maxHealth += 20 + gameState.level;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + 20 + gameState.level);
                
                if (gameState.playerClass === 'fighter') {
                    gameState.strength += 3;
                    gameState.agility += 1;
                    gameState.magic += 1;
                } else if (gameState.playerClass === 'mage') {
                    gameState.strength += 1;
                    gameState.agility += 1;
                    gameState.magic += 3;
                } else if (gameState.playerClass === 'thief') {
                    gameState.strength += 1;
                    gameState.agility += 3;
                    gameState.magic += 1;
                }
                
                // Unlock dungeons based on level
                if (gameState.level >= 1 && !gameState.dungeons.goblin_warrens.unlocked) {
                    gameState.dungeons.goblin_warrens.unlocked = true;
                    document.getElementById('townMessage').innerHTML += 
                        `<p class="unlock-message">DUNGEON UNLOCKED: GOBLIN WARRENS!</p>`;
                }
                if (gameState.level >= 2 && !gameState.dungeons.crystal_mines.unlocked) {
                    gameState.dungeons.crystal_mines.unlocked = true;
                    document.getElementById('townMessage').innerHTML += 
                        `<p class="unlock-message">DUNGEON UNLOCKED: CRYSTAL MINES!</p>`;
                }
                if (gameState.level >= 3 && !gameState.dungeons.tower_of_sorcery.unlocked) {
                    gameState.dungeons.tower_of_sorcery.unlocked = true;
                    document.getElementById('townMessage').innerHTML += 
                        `<p class="unlock-message">DUNGEON UNLOCKED: TOWER OF SORCERY!</p>`;
                }
                
                // Add level up message
                const combatLog = document.getElementById('combatLog');
                if (combatLog) {
                    combatLog.innerHTML += `<span class="heal">YOU HAVE REACHED LEVEL ${gameState.level}! +1 SKILL POINT</span><br>`;
                }
                
                // Unlock new areas based on level
                updateExplorationAreas();
            }
        }

        function saveGame() {
            localStorage.setItem('lordSave', JSON.stringify(gameState));
            document.getElementById('townMessage').innerHTML = "<p class='heal'>GAME SAVED SUCCESSFULLY!</p>";
        }

        function restartGame() {
            // Reset game state
            Object.assign(gameState, {
                day: 1,
                playerName: "SIR LANCELOT",
                playerClass: "fighter",
                level: 1,
                xp: 0,
                nextLevelXP: 100,
                gold: 50,
                health: 100,
                maxHealth: 100,
                strength: 10,
                agility: 10,
                magic: 10,
                statPoints: 5,
                skillPoints: 0,
                weapon: "RUSTY DAGGER",
                weaponDamage: [3, 7],
                armor: "NONE",
                armorDefense: 0,
                shield: "NONE",
                shieldDefense: 0,
                hasPotion: false,
                potions: 0,
                inCombat: false,
                currentMonster: null,
                monsterHealth: 0,
                visitedInn: false,
                dragonDefeated: false,
                gameOver: false,
                kills: 0,
                totalDamage: 0,
                // Exploration & Quest System
                quests: [],
                completedQuests: 0,
                discoveredAreas: ["haunted_woods"],
                explorationLog: [],
                hasMap: false,
                foundItems: [],
                currentExploration: null,
                explorationStep: 0,
                // New Systems
                skills: {},
                mainStory: {
                    currentChapter: 0,
                    completedChapters: [],
                    claimedRewards: []
                },
                dungeons: {
                    "goblin_warrens": {
                        unlocked: false,
                        currentFloor: 0,
                        completedFloors: [],
                        bossDefeated: false
                    },
                    "tower_of_sorcery": {
                        unlocked: false,
                        currentFloor: 0,
                        completedFloors: [],
                        bossDefeated: false
                    },
                    "crystal_mines": {
                        unlocked: false,
                        currentFloor: 0,
                        completedFloors: [],
                        bossDefeated: false
                    }
                },
                activeDungeon: null,
                dungeonFloor: 0
            });
            
            // Reset UI
            document.getElementById('playerName').value = "SIR LANCELOT";
            document.getElementById('playerClass').value = "fighter";
            resetStats();
            
            // Initialize skills
            initializeSkills();
            
            // Show character creation
            showScreen('creationScreen');
        }

        // Initialize the game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
