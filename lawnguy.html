<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Lawn Guy - Improved with Mower Repair</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #FFC107;
            --danger: #F44336;
            --dark: #121212;
            --light: #F5F5F5;
            --gray: #9E9E9E;
            --energy: #4CAF50;
            --stress: #F44336;
            --rep: #FFC107;
            --petrol: #2196F3;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark);
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        #game-container {
            max-width: 500px;
            height: 100vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: var(--dark);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        #game-header {
            background-color: var(--primary);
            color: black;
            padding: 15px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10;
        }
        
        #game-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        
        #stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat {
            background-color: rgba(0,0,0,0.1);
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            margin-right: 4px;
            font-size: 10px;
        }
        
        #status-bars {
            margin-top: 10px;
        }
        
        .status-bar {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .status-bar-label {
            width: 80px;
            font-size: 12px;
            font-weight: 600;
        }
        
        progress {
            flex-grow: 1;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: none;
        }
        
        progress::-webkit-progress-bar {
            background-color: rgba(0,0,0,0.1);
            border-radius: 6px;
        }
        
        progress::-webkit-progress-value {
            border-radius: 6px;
        }
        
        #energy-bar::-webkit-progress-value { background-color: var(--energy); }
        #stress-bar::-webkit-progress-value { background-color: var(--stress); }
        #rep-bar::-webkit-progress-value { background-color: var(--rep); }
        #petrol-display::-webkit-progress-value { background-color: var(--petrol); }
        
        #game-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px;
            background-color: var(--dark);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        .hidden {
            transform: translateX(100%);
            visibility: hidden;
        }
        
        .active-screen {
            transform: translateX(0);
            visibility: visible;
        }
        
        .screen-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: white;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray);
        }
        
        .btn {
            background-color: var(--primary);
            color: black;
            border: none;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 0 var(--primary-dark);
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            box-shadow: 0 4px 0 #B0A000;
            color: black;
        }
        
        .btn-secondary:active {
            box-shadow: 0 2px 0 #B0A000;
        }
        
        .btn-danger {
            background-color: var(--danger);
            box-shadow: 0 4px 0 #B71C1C;
            color: white;
        }
        
        .btn-danger:active {
            box-shadow: 0 2px 0 #B71C1C;
        }
        
        .btn:disabled {
            background-color: var(--gray);
            box-shadow: 0 4px 0 #757575;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-icon {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .badge {
            display: inline-block;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            text-align: center;
            line-height: 20px;
            margin-left: auto;
        }
        
        .email-list {
            margin-bottom: 10px;
        }
        
        .email-item {
            padding: 12px;
            background-color: #2A2A2A;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .email-item:active {
            background-color: #3A3A3A;
        }
        
        .email-item.unread {
            background-color: #1E3A2E;
            border-left: 4px solid var(--primary);
        }
        
        .email-sender {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .email-subject {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .email-preview {
            font-size: 12px;
            color: #CCCCCC;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .email-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--danger);
            font-size: 16px;
            padding: 4px;
            z-index: 2;
        }
        
        .email-content {
            white-space: pre-line;
            line-height: 1.5;
            margin-bottom: 15px;
            background-color: #2A2A2A;
            padding: 15px;
            border-radius: 10px;
        }
        
        .schedule-day {
            margin-bottom: 20px;
        }
        
        .schedule-day-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-slot {
            padding: 10px;
            background-color: #2A2A2A;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .schedule-slot.booked {
            background-color: rgba(76, 175, 80, 0.2);
            border-left: 4px solid var(--primary);
        }
        
        .schedule-slot.completed {
            background-color: rgba(158, 158, 158, 0.2);
            color: var(--gray);
        }
        
        .schedule-slot.missed {
            background-color: rgba(244, 67, 54, 0.1);
            text-decoration: line-through;
            color: var(--danger);
        }
        
        .shop-category {
            margin-bottom: 20px;
        }
        
        .shop-category-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 18px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--primary-dark);
        }
        
        .shop-item {
            padding: 12px;
            background-color: #2A2A2A;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .shop-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .shop-item-name {
            font-weight: 600;
            color: var(--primary);
        }
        
        .shop-item-price {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .shop-item-stats {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .shop-item-current {
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .shop-item-btn {
            align-self: flex-end;
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
        }
        
        .bank-account {
            padding: 12px;
            background-color: #2A2A2A;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .bank-account-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
        }
        
        .account-balance {
            font-size: 18px;
            font-weight: 700;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .bank-account-desc {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .bank-account-actions {
            display: flex;
            gap: 8px;
        }
        
        .bank-account-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .job-display {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .job-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .job-progress-container {
            margin-bottom: 10px;
        }
        
        .job-details {
            font-size: 14px;
            margin-top: 10px;
        }
        
        .job-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .equipment-status {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .equipment-status-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .equipment-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .job-history {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .job-history-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
        }
        
        .job-history-item:last-child {
            border-bottom: none;
        }
        
        .full-history {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        #notification-area {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
            width: 90%;
            z-index: 1000;
            pointer-events: none;
        }
        
        .notification {
            background-color: var(--primary);
            color: black;
            padding: 12px 20px;
            margin-bottom: 10px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border-left: 4px solid white;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            pointer-events: none;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .stress-up { color: var(--danger); font-weight: bold; }
        .stress-down { color: var(--primary); font-weight: bold; }
        .money-up { color: var(--primary); font-weight: bold; }
        .money-down { color: var(--danger); font-weight: bold; }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal {
            background-color: #1E1E1E;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 2px solid var(--primary);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            text-align: center;
        }
        
        .modal-content {
            margin-bottom: 20px;
            color: white;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        .help-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--secondary);
            color: black;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .pause-btn {
            background-color: var(--secondary);
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .upcoming-jobs {
            background-color: #2A2A2A;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .upcoming-job-item {
            padding: 5px 0;
            border-bottom: 1px solid #444;
            font-size: 12px;
        }
        
        .job-count-badge {
            background-color: var(--primary-dark);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        @media (max-width: 400px) {
            .btn { padding: 10px 12px; font-size: 14px; }
            .screen-title { font-size: 18px; }
        }
        
        /* Animation classes */
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="game-container">
        <div id="game-header">
            <h1>THE LAWN GUY <span class="help-btn" id="help-button">?</span></h1>
            <div id="stats-bar">
                <div class="stat"><i class="fas fa-calendar-day stat-icon"></i><span id="day-display">Mon</span></div>
                <div class="stat"><i class="fas fa-clock stat-icon"></i><span id="time-display">8:00 AM</span></div>
                <div class="stat"><i class="fas fa-dollar-sign stat-icon"></i>$<span id="money-display">500</span></div>
            </div>
            <div id="status-bars">
                <div class="status-bar">
                    <div class="status-bar-label"><i class="fas fa-bolt"></i> Energy</div>
                    <progress id="energy-bar" value="100" max="100"></progress>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label"><i class="fas fa-heart"></i> Stress</div>
                    <progress id="stress-bar" value="20" max="100"></progress>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label"><i class="fas fa-star"></i> Rep</div>
                    <progress id="rep-bar" value="50" max="100"></progress>
                </div>
                <div class="status-bar">
                    <div class="status-bar-label"><i class="fas fa-gas-pump"></i> Petrol</div>
                    <progress id="petrol-display" value="100" max="100"></progress>
                </div>
            </div>
        </div>

        <div id="game-content">
            <div id="main-menu" class="screen active-screen">
                <button id="check-email-btn" class="btn">
                    <i class="fas fa-envelope btn-icon"></i>Inbox
                    <span id="unread-count" class="badge" style="display:none">0</span>
                </button>
                <button id="schedule-btn" class="btn">
                    <i class="fas fa-calendar-alt btn-icon"></i>Schedule
                </button>
                <button id="shop-btn" class="btn">
                    <i class="fas fa-shopping-cart btn-icon"></i>Shop
                </button>
                <button id="bank-btn" class="btn">
                    <i class="fas fa-piggy-bank btn-icon"></i>Bank
                </button>
                <button id="start-day-btn" class="btn">
                    <i class="fas fa-play btn-icon"></i>Start Day
                    <span id="job-count-badge" class="job-count-badge">0</span>
                </button>
                <button id="next-day-btn" class="btn">
                    <i class="fas fa-forward btn-icon"></i>Next Day
                </button>
                <button id="history-btn" class="btn">
                    <i class="fas fa-history btn-icon"></i>History
                </button>
            </div>

            <div id="email-screen" class="screen">
                <h2 class="screen-title"><i class="fas fa-inbox"></i> Inbox</h2>
                <div id="email-list" class="email-list"></div>
                <button id="back-from-email" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back
                </button>
            </div>

            <div id="email-detail-screen" class="screen">
                <h2 class="screen-title"><i class="fas fa-envelope-open"></i> Email</h2>
                <div id="email-content" class="email-content"></div>
                <div id="email-actions" class="modal-actions"></div>
                <button id="back-from-detail" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back to Inbox
                </button>
            </div>

            <div id="schedule-screen" class="screen">
                <h2 class="screen-title"><i class="fas fa-calendar-week"></i> Schedule</h2>
                <button id="auto-schedule-btn" class="btn btn-secondary">
                    <i class="fas fa-magic btn-icon"></i>Auto-Schedule Unscheduled
                </button>
                <div id="schedule-display"></div>
                <button id="back-from-schedule" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back
                </button>
            </div>

            <div id="shop-screen" class="screen">
                <h2 class="screen-title"><i class="fas fa-tools"></i> Equipment Shop</h2>
                <div id="shop-items">
                    <div class="shop-category">
                        <h3 class="shop-category-title"><i class="fas fa-leaf"></i> Mowers</h3>
                        <div class="shop-category-content" id="mowers"></div>
                    </div>
                    <div class="shop-category">
                        <h3 class="shop-category-title"><i class="fas fa-cut"></i> Trimmers</h3>
                        <div class="shop-category-content" id="trimmers"></div>
                    </div>
                    <div class="shop-category">
                        <h3 class="shop-category-title"><i class="fas fa-wind"></i> Blowers</h3>
                        <div class="shop-category-content" id="blowers"></div>
                    </div>
                    <div class="shop-category">
                        <h3 class="shop-category-title"><i class="fas fa-box-open"></i> Supplies</h3>
                        <div class="shop-category-content" id="supplies"></div>
                    </div>
                </div>
                <button id="back-from-shop" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back
                </button>
            </div>

            <div id="bank-screen" class="screen">
                <h2 class="screen-title"><i class="fas fa-university"></i> Bank Accounts</h2>
                
                <div class="bank-account">
                    <h3 class="bank-account-title"><i class="fas fa-money-bill-wave"></i> Payee Account</h3>
                    <div class="account-balance">$<span id="payee-balance">0.00</span></div>
                    <p class="bank-account-desc">Job payments are deposited here automatically</p>
                    <div class="bank-account-actions">
                        <button id="transfer-to-savings" class="btn">
                            <i class="fas fa-arrow-right btn-icon"></i>To Savings
                        </button>
                        <button id="withdraw-to-cash" class="btn">
                            <i class="fas fa-hand-holding-usd btn-icon"></i>To Cash
                        </button>
                    </div>
                </div>
                
                <div class="bank-account">
                    <h3 class="bank-account-title"><i class="fas fa-piggy-bank"></i> Savings Account</h3>
                    <div class="account-balance">$<span id="savings-balance">0.00</span></div>
                    <p class="bank-account-desc">Earns 2% interest weekly. Current rate: 2%</p>
                    <div class="bank-account-actions">
                        <button id="transfer-from-savings" class="btn">
                            <i class="fas fa-arrow-left btn-icon"></i>To Payee
                        </button>
                    </div>
                </div>
                
                <div class="bank-account">
                    <h3 class="bank-account-title"><i class="fas fa-file-invoice-dollar"></i> Tax Account</h3>
                    <div class="account-balance">$<span id="tax-balance">0.00</span></div>
                    <p class="bank-account-desc">15% of earnings are automatically deducted for taxes</p>
                    <div class="bank-account-actions">
                        <button id="pay-taxes" class="btn">
                            <i class="fas fa-receipt btn-icon"></i>Pay Taxes Now
                        </button>
                    </div>
                </div>
                
                <button id="back-from-bank" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back
                </button>
            </div>

            <div id="work-screen" class="screen hidden">
                <h2 class="screen-title">
                    <i class="fas fa-calendar-day"></i> Work Day - <span id="work-day">Monday</span>
                    <button id="pause-work-btn" class="pause-btn"><i class="fas fa-pause"></i> Pause</button>
                </h2>
                
                <div class="job-display">
                    <h3 class="job-title"><i class="fas fa-clipboard-list"></i> Current Job: <span id="current-job-name">None</span></h3>
                    <div class="job-progress-container">
                        <div>Progress:</div>
                        <progress id="job-progress" value="0" max="100"></progress>
                    </div>
                    <div class="job-details">
                        <div class="job-detail">
                            <span><i class="fas fa-clock"></i> Time Remaining:</span>
                            <span id="time-remaining">0</span> min
                        </div>
                        <div class="job-detail">
                            <span><i class="fas fa-dollar-sign"></i> Pay:</span>
                            <span id="job-pay">$0</span>
                        </div>
                        <div class="job-detail">
                            <span><i class="fas fa-cloud-sun"></i> Weather:</span>
                            <span id="job-weather">Sunny</span>
                        </div>
                        <div class="job-detail">
                            <span><i class="fas fa-tachometer-alt"></i> Difficulty:</span>
                            <span id="job-difficulty">1.0x</span>
                        </div>
                    </div>
                </div>
                
                <div class="equipment-status">
                    <h3 class="equipment-status-title"><i class="fas fa-tools"></i> Equipment Status</h3>
                    <div class="equipment-item">
                        <span><i class="fas fa-leaf"></i> Mower:</span>
                        <span id="mower-status">100%</span>
                    </div>
                    <div class="equipment-item">
                        <span><i class="fas fa-cut"></i> Trimmer:</span>
                        <span id="trimmer-status">100%</span>
                    </div>
                    <div class="equipment-item">
                        <span><i class="fas fa-wind"></i> Blower:</span>
                        <span id="blower-status">100%</span>
                    </div>
                    <div class="equipment-item">
                        <span><i class="fas fa-gas-pump"></i> Petrol:</span>
                        <span id="petrol-status">100%</span>
                    </div>
                    <div class="equipment-item">
                        <span><i class="fas fa-cog"></i> Mower Belt:</span>
                        <span id="belt-status">100%</span>
                    </div>
                    <div class="equipment-item">
                        <span><i class="fas fa-cut"></i> Trimmer Cord:</span>
                        <span id="cord-status">100%</span>
                    </div>
                </div>
                
                <button id="use-energy-drink" class="btn btn-secondary">
                    <i class="fas fa-bolt btn-icon"></i>Use Energy Drink (0 left)
                </button>
                <button id="repair-equipment" class="btn btn-secondary">
                    <i class="fas fa-wrench btn-icon"></i>Repair Equipment
                </button>
                <button id="save-exit-work" class="btn btn-secondary">
                    <i class="fas fa-save btn-icon"></i>Save & Exit
                </button>
                <button id="end-work-day" class="btn btn-danger">
                    <i class="fas fa-stop btn-icon"></i>End Work Day
                </button>
                
                <div class="upcoming-jobs">
                    <h4><i class="fas fa-list"></i> Upcoming Jobs Today</h4>
                    <div id="upcoming-jobs-list"></div>
                </div>
                
                <div class="job-history">
                    <h4><i class="fas fa-history"></i> Today's Activity</h4>
                    <div id="job-history"></div>
                </div>
            </div>

            <div id="history-screen" class="screen hidden">
                <h2 class="screen-title"><i class="fas fa-history"></i> Job History</h2>
                <div id="full-history" class="full-history"></div>
                <button id="back-from-history" class="btn">
                    <i class="fas fa-arrow-left btn-icon"></i>Back
                </button>
            </div>

            <div id="notification-area"></div>
        </div>
    </div>

    <script>
        // ==================== CONSTANTS ====================
        const DAYS_OF_WEEK = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const WEATHER_EFFECTS = {
            sunny: { name: 'Sunny', workModifier: 1, stressModifier: 0, chance: 0.6 },
            rain: { name: 'Rain', workModifier: 0.5, stressModifier: 20, chance: 0.1 },
            cloudy: { name: 'Cloudy', workModifier: 0.9, stressModifier: -5, chance: 0.2 },
            hot: { name: 'Hot', workModifier: 0.8, stressModifier: 15, chance: 0.1 }
        };
        const JOB_TYPES = {
            small: { name: 'Small Lawn', baseTime: 30, basePay: 35, reputation: 1, difficulty: 1 },
            medium: { name: 'Medium Lawn', baseTime: 45, basePay: 45, reputation: 2, difficulty: 1.5 },
            large: { name: 'Large Lawn', baseTime: 60, basePay: 65, reputation: 3, difficulty: 2 },
            xlarge: { name: 'Extra Large Lawn', baseTime: 90, basePay: 100, reputation: 5, difficulty: 3 }
        };
        const EQUIPMENT_STATS = {
            mower: {
                '18inch': { name: '18" Push Mower', speed: 1, stress: 3, price: 0, reliability: 0.95 },
                '21inch': { name: '21" Self-Propelled', speed: 1.5, stress: 2, price: 300, reliability: 0.97 },
                'zeroturn': { name: 'Zero-Turn Mower', speed: 2.5, stress: 1, price: 2000, reliability: 0.99 }
            },
            trimmer: {
                'cheap': { name: 'Basic Trimmer', speed: 1, stress: 2, price: 0, reliability: 0.9 },
                'mid': { name: 'Professional Trimmer', speed: 1.5, stress: 1, price: 200, reliability: 0.95 },
                'top': { name: 'Commercial Trimmer', speed: 2, stress: 0.5, price: 500, reliability: 0.98 }
            },
            blower: {
                'cheap': { name: 'Basic Blower', speed: 1, stress: 2, price: 0, reliability: 0.9 },
                'mid': { name: 'Professional Blower', speed: 1.5, stress: 1, price: 150, reliability: 0.94 },
                'top': { name: 'Commercial Blower', speed: 2, stress: 0.5, price: 400, reliability: 0.97 }
            }
        };
        const CUSTOMER_NAMES = [
            'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 
            'Miller', 'Davis', 'Garcia', 'Rodriguez', 'Wilson',
            'Martinez', 'Anderson', 'Taylor', 'Thomas', 'Moore',
            'Thompson', 'White', 'Harris', 'Clark', 'Lewis'
        ];
        const PROBLEMATIC_CUSTOMERS = ['Thompson', 'Wilson', 'Rodriguez', 'Smith', 'Johnson'];

        // ==================== GAME STATE ====================
        const gameState = {
            day: 0,
            week: 1,
            month: 1,
            time: 8,
            money: 500,
            stress: 20,
            energy: 100,
            reputation: 50,
            equipment: {
                mower: '18inch',
                trimmer: 'cheap',
                blower: 'cheap',
                petrol: 100,
                trimmerCord: 100,
                mowerBelt: 100,
                energyDrinks: 0,
                equipmentStatus: {
                    mower: 100,
                    trimmer: 100,
                    blower: 100
                }
            },
            bank: {
                payee: 0,
                savings: 0,
                tax: 0
            },
            customers: [], // unscheduled jobs
            scheduledJobs: [[],[],[],[],[]],
            emails: [],
            weather: 'sunny',
            completedJobs: 0,
            failedJobs: 0,
            currentJob: null,
            workTimer: null,
            workDayActive: false,
            currentJobIndex: 0,
            currentWorkDayTime: 8,
            jobHistory: [],
            dailyCompleted: 0,
            dailyFailed: 0,
            energyDrinkActive: false,
            energyDrinkEndTime: 0,
            mowedCustomers: [],
            warnedCustomers: [],
            lastSlugEmailDay: -1,
            paused: false,
            interruptedJob: null // NEW: stores job progress when interrupted
        };

        // ==================== DOM ELEMENTS ====================
        const elements = {
            dayDisplay: document.getElementById('day-display'),
            timeDisplay: document.getElementById('time-display'),
            moneyDisplay: document.getElementById('money-display'),
            energyBar: document.getElementById('energy-bar'),
            stressBar: document.getElementById('stress-bar'),
            repBar: document.getElementById('rep-bar'),
            petrolDisplay: document.getElementById('petrol-display'),
            unreadCount: document.getElementById('unread-count'),
            jobCountBadge: document.getElementById('job-count-badge'),
            
            screens: {
                main: document.getElementById('main-menu'),
                email: document.getElementById('email-screen'),
                emailDetail: document.getElementById('email-detail-screen'),
                schedule: document.getElementById('schedule-screen'),
                shop: document.getElementById('shop-screen'),
                bank: document.getElementById('bank-screen'),
                work: document.getElementById('work-screen'),
                history: document.getElementById('history-screen')
            },
            
            buttons: {
                checkEmail: document.getElementById('check-email-btn'),
                schedule: document.getElementById('schedule-btn'),
                shop: document.getElementById('shop-btn'),
                bank: document.getElementById('bank-btn'),
                startDay: document.getElementById('start-day-btn'),
                nextDay: document.getElementById('next-day-btn'),
                history: document.getElementById('history-btn'),
                backFromEmail: document.getElementById('back-from-email'),
                backFromDetail: document.getElementById('back-from-detail'),
                backFromSchedule: document.getElementById('back-from-schedule'),
                backFromShop: document.getElementById('back-from-shop'),
                backFromBank: document.getElementById('back-from-bank'),
                backFromHistory: document.getElementById('back-from-history'),
                endWorkDay: document.getElementById('end-work-day'),
                useEnergyDrink: document.getElementById('use-energy-drink'),
                repairEquipment: document.getElementById('repair-equipment'),
                saveExitWork: document.getElementById('save-exit-work'),
                transferToSavings: document.getElementById('transfer-to-savings'),
                withdrawToCash: document.getElementById('withdraw-to-cash'),
                transferFromSavings: document.getElementById('transfer-from-savings'),
                payTaxes: document.getElementById('pay-taxes'),
                autoSchedule: document.getElementById('auto-schedule-btn'),
                pauseWork: document.getElementById('pause-work-btn'),
                help: document.getElementById('help-button')
            },
            
            bankDisplays: {
                payee: document.getElementById('payee-balance'),
                savings: document.getElementById('savings-balance'),
                tax: document.getElementById('tax-balance')
            },
            
            emailList: document.getElementById('email-list'),
            emailContent: document.getElementById('email-content'),
            emailActions: document.getElementById('email-actions'),
            scheduleDisplay: document.getElementById('schedule-display'),
            
            workDay: document.getElementById('work-day'),
            currentJobName: document.getElementById('current-job-name'),
            jobProgress: document.getElementById('job-progress'),
            timeRemaining: document.getElementById('time-remaining'),
            jobPay: document.getElementById('job-pay'),
            jobWeather: document.getElementById('job-weather'),
            jobDifficulty: document.getElementById('job-difficulty'),
            
            mowerStatus: document.getElementById('mower-status'),
            trimmerStatus: document.getElementById('trimmer-status'),
            blowerStatus: document.getElementById('blower-status'),
            petrolStatus: document.getElementById('petrol-status'),
            beltStatus: document.getElementById('belt-status'),
            cordStatus: document.getElementById('cord-status'),
            
            jobHistory: document.getElementById('job-history'),
            fullHistory: document.getElementById('full-history'),
            upcomingJobsList: document.getElementById('upcoming-jobs-list'),
            
            notificationArea: document.getElementById('notification-area')
        };

        // ==================== INITIALIZATION ====================
        function initGame() {
            generateInitialEmails();
            gameState.weather = getRandomWeather();
            updateUI();
            setupShop();
            updateHistoryDisplay();
            attachEventListeners();
            showScreen('main');
            showNotification("Welcome to The Lawn Guy! Press ? for help.");
        }

        function attachEventListeners() {
            // Main menu
            elements.buttons.checkEmail.addEventListener('click', () => showScreen('email'));
            elements.buttons.schedule.addEventListener('click', () => showScreen('schedule'));
            elements.buttons.shop.addEventListener('click', () => showScreen('shop'));
            elements.buttons.bank.addEventListener('click', () => showScreen('bank'));
            elements.buttons.startDay.addEventListener('click', startWorkDay);
            elements.buttons.nextDay.addEventListener('click', advanceDay);
            elements.buttons.history.addEventListener('click', () => showScreen('history'));
            elements.buttons.help.addEventListener('click', showHelp);
            
            // Back buttons
            elements.buttons.backFromEmail.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromDetail.addEventListener('click', () => showScreen('email'));
            elements.buttons.backFromSchedule.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromShop.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromBank.addEventListener('click', () => showScreen('main'));
            elements.buttons.backFromHistory.addEventListener('click', () => showScreen('main'));
            
            // Work screen
            elements.buttons.endWorkDay.addEventListener('click', endWorkDay);
            elements.buttons.useEnergyDrink.addEventListener('click', useEnergyDrink);
            elements.buttons.repairEquipment.addEventListener('click', showRepairModal);
            elements.buttons.pauseWork.addEventListener('click', togglePause);
            elements.buttons.saveExitWork.addEventListener('click', saveAndExitWork);
            
            // Bank
            elements.buttons.transferToSavings.addEventListener('click', () => transferMoney('payee', 'savings'));
            elements.buttons.withdrawToCash.addEventListener('click', () => transferMoney('payee', 'cash'));
            elements.buttons.transferFromSavings.addEventListener('click', () => transferMoney('savings', 'payee'));
            elements.buttons.payTaxes.addEventListener('click', payTaxesNow);
            
            // Schedule
            elements.buttons.autoSchedule.addEventListener('click', autoScheduleJobs);
            
            // Haptic feedback (optional)
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(20);
                    }
                });
            });
        }

        // ==================== UI FUNCTIONS ====================
        function showScreen(screenName) {
            for (const screen in elements.screens) {
                elements.screens[screen].classList.remove('active-screen');
                elements.screens[screen].classList.add('hidden');
            }
            elements.screens[screenName].classList.remove('hidden');
            setTimeout(() => {
                elements.screens[screenName].classList.add('active-screen');
            }, 10);
            
            // Update screen-specific content
            if (screenName === 'email') updateEmailList();
            else if (screenName === 'schedule') updateScheduleDisplay();
            else if (screenName === 'work') updateWorkScreen();
            else if (screenName === 'history') updateFullHistoryDisplay();
            else if (screenName === 'bank') updateBankDisplay();
        }

        function updateUI() {
            // Day & time
            elements.dayDisplay.textContent = DAYS_OF_WEEK[gameState.day].substring(0,3);
            elements.timeDisplay.textContent = formatTime(gameState.time);
            elements.moneyDisplay.textContent = gameState.money.toFixed(2);
            
            // Bars
            elements.energyBar.value = gameState.energy;
            elements.stressBar.value = gameState.stress;
            elements.repBar.value = gameState.reputation;
            elements.petrolDisplay.value = gameState.equipment.petrol;
            
            // Start Day button - check for interrupted job first
            if (gameState.interruptedJob) {
                elements.buttons.startDay.textContent = 'Resume Work';
                elements.buttons.startDay.classList.add('pulse');
            } else {
                const jobsToday = gameState.scheduledJobs[gameState.day].length;
                elements.jobCountBadge.textContent = jobsToday;
                elements.jobCountBadge.style.display = jobsToday ? 'inline-block' : 'none';
                elements.buttons.startDay.textContent = gameState.workDayActive ? 'Return to Work Day' : 'Start Day';
                if (jobsToday && !gameState.workDayActive) {
                    elements.buttons.startDay.classList.add('pulse');
                } else {
                    elements.buttons.startDay.classList.remove('pulse');
                }
            }
            
            // Energy drink button
            elements.buttons.useEnergyDrink.textContent = `Use Energy Drink (${gameState.equipment.energyDrinks} left)`;
            elements.buttons.useEnergyDrink.disabled = gameState.equipment.energyDrinks <= 0 || !gameState.workDayActive;
            
            // Next Day button - disabled if work active or interrupted job exists
            elements.buttons.nextDay.disabled = gameState.workDayActive || gameState.interruptedJob !== null;
            
            // Unread emails
            const unread = gameState.emails.filter(e => !e.read).length;
            if (unread > 0) {
                elements.unreadCount.textContent = unread;
                elements.unreadCount.style.display = 'inline-block';
                elements.buttons.checkEmail.classList.add('pulse');
            } else {
                elements.unreadCount.style.display = 'none';
                elements.buttons.checkEmail.classList.remove('pulse');
            }
        }

        function formatTime(hour) {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = Math.floor(hour) % 12 || 12;
            const minutes = Math.floor((hour % 1) * 60);
            const formattedMinutes = minutes < 10 ? `0${minutes}` : minutes;
            return `${displayHour}:${formattedMinutes} ${ampm}`;
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, isError = false) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.innerHTML = message;
            if (isError) notif.style.backgroundColor = 'var(--danger)';
            elements.notificationArea.appendChild(notif);
            
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // ==================== HELP MODAL ====================
        function showHelp() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">How to Play</h3>
                    <div class="modal-content">
                        <p>• Check emails for job requests.</p>
                        <p>• Schedule jobs in your calendar.</p>
                        <p>• Start the work day and complete jobs before 5 PM.</p>
                        <p>• Manage stress, energy, and equipment.</p>
                        <p>• Upgrade equipment in the shop.</p>
                        <p>• Transfer money to savings for interest.</p>
                        <p>• Watch out for problematic customers (George warns you).</p>
                        <p>• Random events can help or hinder you.</p>
                        <p>• If you run out of petrol or break equipment, use "Save & Exit" to go to the shop and then "Resume Work" to continue the job.</p>
                        <p>• You can repair the mower during work ($50, 15 min) using the Repair Equipment button.</p>
                    </div>
                    <button id="close-help" class="btn">Got it!</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#close-help').addEventListener('click', () => modal.remove());
        }

        // ==================== BANKING ====================
        function updateBankDisplay() {
            elements.bankDisplays.payee.textContent = gameState.bank.payee.toFixed(2);
            elements.bankDisplays.savings.textContent = gameState.bank.savings.toFixed(2);
            elements.bankDisplays.tax.textContent = gameState.bank.tax.toFixed(2);
            
            elements.buttons.transferToSavings.disabled = gameState.bank.payee <= 0;
            elements.buttons.withdrawToCash.disabled = gameState.bank.payee <= 0;
            elements.buttons.transferFromSavings.disabled = gameState.bank.savings <= 0;
        }

        function transferMoney(from, to) {
            const maxAmount = gameState.bank[from];
            if (maxAmount <= 0) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">Transfer from ${from}</h3>
                    <div class="modal-content">
                        <p>Available: $${maxAmount.toFixed(2)}</p>
                        <input type="number" id="transfer-amount" min="0" max="${maxAmount}" step="0.01" value="${maxAmount}" style="width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; background:#333; color:white;">
                    </div>
                    <div class="modal-actions">
                        <button id="confirm-transfer" class="btn">Transfer</button>
                        <button id="cancel-transfer" class="btn btn-danger">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('confirm-transfer').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('transfer-amount').value);
                if (isNaN(amount) || amount <= 0 || amount > maxAmount) {
                    showNotification('Invalid amount', true);
                    return;
                }
                if (amount > 100 && !confirm(`Are you sure you want to transfer $${amount.toFixed(2)}?`)) return;
                
                gameState.bank[from] -= amount;
                if (to === 'cash') {
                    gameState.money += amount;
                    showNotification(`Withdrew $${amount.toFixed(2)}`);
                } else {
                    gameState.bank[to] += amount;
                    showNotification(`Transferred $${amount.toFixed(2)} to ${to}`);
                }
                updateUI();
                updateBankDisplay();
                modal.remove();
            });
            
            document.getElementById('cancel-transfer').addEventListener('click', () => modal.remove());
        }

        function payTaxesNow() {
            const tax = gameState.bank.tax;
            if (tax <= 0) {
                showNotification('No taxes due');
                return;
            }
            if (gameState.bank.payee + gameState.money < tax) {
                showNotification('Insufficient funds to pay taxes', true);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">Pay Taxes Now</h3>
                    <div class="modal-content">
                        <p>Tax due: $${tax.toFixed(2)}</p>
                        <p>Paying early gives a 5% discount: $${(tax * 0.95).toFixed(2)}</p>
                    </div>
                    <div class="modal-actions">
                        <button id="confirm-pay" class="btn">Pay $${(tax * 0.95).toFixed(2)}</button>
                        <button id="cancel-pay" class="btn btn-danger">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('confirm-pay').addEventListener('click', () => {
                const discounted = tax * 0.95;
                if (deductMoney(discounted)) {
                    gameState.bank.tax = 0;
                    showNotification(`Taxes paid: $${discounted.toFixed(2)}`);
                    updateUI();
                    updateBankDisplay();
                } else {
                    showNotification('Payment failed', true);
                }
                modal.remove();
            });
            
            document.getElementById('cancel-pay').addEventListener('click', () => modal.remove());
        }

        function deductMoney(amount) {
            if (gameState.money >= amount) {
                gameState.money -= amount;
                return true;
            } else if (gameState.money + gameState.bank.payee >= amount) {
                const remaining = amount - gameState.money;
                gameState.money = 0;
                gameState.bank.payee -= remaining;
                return true;
            }
            return false;
        }

        function canAfford(amount) {
            return (gameState.money + gameState.bank.payee) >= amount;
        }

        // ==================== EMAIL SYSTEM ====================
        function generateInitialEmails() {
            gameState.emails.push({
                id: Date.now(),
                from: 'George',
                subject: 'Welcome to the game!',
                type: 'georgeWelcome',
                read: false,
                content: `Hey there,\n\nWelcome to the game! I'm George, I've been in the game for years and am here to get you started.\n\n` +
                         `I've left you some basic crap equipment I no longer use to help get you on your feet. A few tips:\n` +
                         `1. Watch your stress levels\n` +
                         `2. Upgrade your equipment when you can\n` +
                         `3. Some customers are worse than others - I'll warn you about these bad apples\n` +
                         `4. And don't forget, Slug is the man! He's been smashing the game!\n\n` +
                         `Good luck!\n- George`
            });
            for (let i = 0; i < 2; i++) generateNewEmail();
        }

        function generateNewEmail() {
            // George warning
            if (Math.random() < 0.15 && gameState.warnedCustomers.length < PROBLEMATIC_CUSTOMERS.length) {
                const available = PROBLEMATIC_CUSTOMERS.filter(c => !gameState.warnedCustomers.includes(c));
                if (available.length > 0) {
                    const customer = available[Math.floor(Math.random() * available.length)];
                    gameState.warnedCustomers.push(customer);
                    gameState.emails.push({
                        id: Date.now(),
                        from: 'George',
                        subject: 'URGENT: Warning About a Customer',
                        type: 'georgeWarning',
                        read: false,
                        customer: customer,
                        content: `Hey,\n\nI noticed you might get requests from ${customer}. They were my WORST customer, always complaining!\n\nCharge them double if you take the job.\n- George`
                    });
                    showNotification(`New warning from George`);
                    return;
                }
            }
            
            // Slug cash gift (once per week)
            if (gameState.lastSlugEmailDay !== gameState.day && Math.random() < 0.15) {
                const amount = Math.floor(Math.random() * 51) + 50;
                gameState.money += amount;
                gameState.lastSlugEmailDay = gameState.day;
                gameState.emails.push({
                    id: Date.now(),
                    from: 'Slug',
                    subject: 'Hey mate, here\'s some cash!',
                    type: 'slugCash',
                    read: false,
                    amount: amount,
                    content: `Mate, smashed out 30 lawns this week! Here's $${amount} to help you out. Keep fighting!\n- Slug`
                });
                showNotification(`Cash gift from Slug: $${amount}`);
                return;
            }
            
            // Other emails
            const types = ['jobRequest', 'complaint', 'steveOffer', 'referral'];
            const weights = [0.4, 0.15, 0.1, 0.1];
            const type = weightedRandom(types, weights);
            
            let email;
            switch (type) {
                case 'jobRequest': email = generateJobRequest(); break;
                case 'complaint':
                    if (gameState.mowedCustomers.length > 0 && Math.random() < 0.5) {
                        email = generateComplaint();
                    } else {
                        email = generateJobRequest();
                    }
                    break;
                case 'steveOffer': email = generateSteveOffer(); break;
                case 'referral': email = generateReferral(); break;
            }
            gameState.emails.push(email);
            showNotification(`New email from ${email.from}`);
        }

        function generateJobRequest() {
            let customer;
            if (Math.random() < 0.4 && gameState.warnedCustomers.length > 0) {
                customer = gameState.warnedCustomers[Math.floor(Math.random() * gameState.warnedCustomers.length)];
            } else {
                customer = randomCustomer();
            }
            const jobType = randomProperty(JOB_TYPES);
            const basePay = jobType.basePay * (1 + gameState.reputation/200); // rep bonus up to 50%
            const difficulty = 0.8 + Math.random() * 0.5; // 0.8-1.3
            const finalPay = Math.round(basePay * difficulty);
            
            return {
                id: Date.now(),
                from: customer,
                subject: `Lawn mowing request (${jobType.name})`,
                type: 'jobRequest',
                read: false,
                jobType: jobType,
                customer: customer,
                pay: finalPay,
                difficulty: difficulty,
                content: `Hi,\n\nI'd like to schedule a ${jobType.name.toLowerCase()} service. Can pay $${finalPay}.\n\nThanks,\n${customer}`
            };
        }

        function generateComplaint() {
            const customer = gameState.mowedCustomers[Math.floor(Math.random() * gameState.mowedCustomers.length)];
            const issues = ["missed spots", "left clippings", "mowed too low", "damaged plants"];
            const issue = issues[Math.floor(Math.random() * issues.length)];
            return {
                id: Date.now(),
                from: customer,
                subject: 'Complaint about service',
                type: 'complaint',
                read: false,
                customer: customer,
                content: `Hi,\n\nI'm not happy: you ${issue}. Please fix it.\n\n${customer}`
            };
        }

        function generateSteveOffer() {
            const offers = [
                { item: 'energyDrinks', quantity: 3, price: 20, desc: '3 energy drinks' },
                { item: 'petrol', amount: 50, price: 30, desc: '50% petrol refill' },
                { item: 'mowerBelt', amount: 50, price: 25, desc: 'mower belt' },
                { item: 'trimmerCord', amount: 50, price: 20, desc: 'trimmer cord' }
            ];
            const offer = offers[Math.floor(Math.random() * offers.length)];
            return {
                id: Date.now(),
                from: 'Steve',
                subject: 'Special offer!',
                type: 'steveOffer',
                read: false,
                offer: offer,
                content: `Hey mate,\n\nI've got ${offer.desc} for just $${offer.price}. Interested?\n- Steveo`
            };
        }

        function generateReferral() {
            const customer = randomCustomer();
            const friend = randomCustomer();
            return {
                id: Date.now(),
                from: customer,
                subject: 'Friend Referral',
                type: 'referral',
                read: false,
                customer: friend,
                content: `Hi,\n\nMy friend ${friend} needs lawn service. I recommended you!\n\n${customer}`
            };
        }

        function updateEmailList() {
            elements.emailList.innerHTML = '';
            // Sort by date (newest first)
            const sorted = [...gameState.emails].sort((a,b) => b.id - a.id);
            sorted.forEach(email => {
                const el = document.createElement('div');
                el.className = `email-item ${email.read ? '' : 'unread'}`;
                let icon = '';
                if (email.from === 'George') icon = '<i class="fas fa-user-tie" style="color:gold;"></i> ';
                else if (email.from === 'Slug') icon = '<i class="fas fa-dragon" style="color:red;"></i> ';
                el.innerHTML = `
                    <div class="email-sender">${icon}${email.from}</div>
                    <div class="email-subject">${email.subject}</div>
                    <div class="email-preview">${email.content.split('\n')[0]}</div>
                    <span class="email-delete"><i class="fas fa-trash"></i></span>
                `;
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.email-delete')) showEmailDetail(email.id);
                });
                el.querySelector('.email-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                    updateEmailList();
                    updateUI();
                });
                elements.emailList.appendChild(el);
            });
        }

        function showEmailDetail(emailId) {
            const email = gameState.emails.find(e => e.id === emailId);
            if (!email) return;
            email.read = true;
            elements.emailContent.textContent = email.content;
            elements.emailActions.innerHTML = '';
            
            switch (email.type) {
                case 'jobRequest':
                    addAction('Accept Job', () => {
                        acceptJob(email);
                        showScreen('schedule');
                    }, 'check');
                    addAction('Reject', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    }, 'times', true);
                    break;
                case 'complaint':
                    addAction('Fix ($20)', () => {
                        if (deductMoney(20)) {
                            gameState.reputation = Math.min(100, gameState.reputation + 5);
                            gameState.stress = Math.max(0, gameState.stress - 5);
                            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                            showNotification('Complaint resolved');
                            showScreen('email');
                            updateUI();
                        } else showNotification('Not enough money', true);
                    }, 'wrench');
                    addAction('Ignore', () => {
                        gameState.reputation = Math.max(0, gameState.reputation - 5);
                        gameState.stress = Math.min(100, gameState.stress + 10);
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showNotification('Ignored complaint');
                        showScreen('email');
                        updateUI();
                    }, 'times', true);
                    break;
                case 'steveOffer':
                    addAction(`Buy ($${email.offer.price})`, () => {
                        if (deductMoney(email.offer.price)) {
                            if (email.offer.item === 'energyDrinks') gameState.equipment.energyDrinks += email.offer.quantity;
                            else if (email.offer.item === 'petrol') gameState.equipment.petrol = Math.min(100, gameState.equipment.petrol + email.offer.amount);
                            else if (email.offer.item === 'mowerBelt') gameState.equipment.mowerBelt = Math.min(100, gameState.equipment.mowerBelt + email.offer.amount);
                            else if (email.offer.item === 'trimmerCord') gameState.equipment.trimmerCord = Math.min(100, gameState.equipment.trimmerCord + email.offer.amount);
                            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                            showNotification('Purchase complete');
                            showScreen('email');
                            updateUI();
                        } else showNotification('Not enough money', true);
                    }, 'shopping-cart');
                    addAction('Decline', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    }, 'times', true);
                    break;
                case 'referral':
                    addAction('Thank', () => {
                        gameState.reputation = Math.min(100, gameState.reputation + 3);
                        gameState.stress = Math.max(0, gameState.stress - 5);
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showNotification('Reputation +3');
                        showScreen('email');
                        updateUI();
                    }, 'thumbs-up');
                    break;
                case 'slugCash':
                    // Money already added when email generated
                    addAction('Close', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                        updateUI();
                    }, 'check');
                    break;
                default:
                    addAction('OK', () => {
                        gameState.emails = gameState.emails.filter(e => e.id !== email.id);
                        showScreen('email');
                    }, 'check');
            }
            
            showScreen('emailDetail');
            updateUI();
        }

        function addAction(label, callback, icon, isDanger = false) {
            const btn = document.createElement('button');
            btn.className = `btn ${isDanger ? 'btn-danger' : ''}`;
            btn.innerHTML = `<i class="fas fa-${icon} btn-icon"></i>${label}`;
            btn.addEventListener('click', callback);
            elements.emailActions.appendChild(btn);
        }

        function acceptJob(email) {
            const job = {
                id: Date.now(),
                customer: email.customer,
                type: email.jobType,
                pay: email.pay,
                difficulty: email.difficulty || 1.0,
                scheduled: false,
                completed: false,
                missed: false
            };
            gameState.customers.push(job);
            gameState.emails = gameState.emails.filter(e => e.id !== email.id);
            showNotification(`Job from ${email.customer} accepted`);
            updateUI();
        }

        // ==================== SCHEDULE ====================
        function updateScheduleDisplay() {
            elements.scheduleDisplay.innerHTML = '';
            for (let d = 0; d < 5; d++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'schedule-day';
                dayDiv.innerHTML = `<h3 class="schedule-day-title">${DAYS_OF_WEEK[d]} <span>${gameState.scheduledJobs[d].filter(j => j.completed).length}/${gameState.scheduledJobs[d].length} jobs</span></h3>`;
                
                for (let hour = 8; hour <= 17; hour++) {
                    const slot = document.createElement('div');
                    slot.className = 'schedule-slot';
                    const job = gameState.scheduledJobs[d].find(j => j.time === hour);
                    
                    if (job) {
                        if (job.completed) slot.classList.add('completed');
                        else if (job.missed) slot.classList.add('missed');
                        else slot.classList.add('booked');
                        slot.innerHTML = `${formatTime(hour)} - ${job.customer} (${job.type.name})`;
                        slot.addEventListener('click', () => showJobOptions(job, d, hour));
                    } else {
                        slot.innerHTML = `${formatTime(hour)} - Available`;
                        slot.addEventListener('click', () => showScheduleJobDialog(d, hour));
                    }
                    dayDiv.appendChild(slot);
                }
                elements.scheduleDisplay.appendChild(dayDiv);
            }
        }

        function showJobOptions(job, day, hour) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">${job.customer} at ${formatTime(hour)}</h3>
                    <div class="modal-content">
                        <p>Job: ${job.type.name}</p>
                        <p>Pay: $${job.pay}</p>
                    </div>
                    <div class="modal-actions">
                        <button id="cancel-job" class="btn btn-danger">Cancel Job</button>
                        <button id="reschedule-job" class="btn btn-secondary">Reschedule</button>
                        <button id="close-options" class="btn">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.querySelector('#cancel-job').addEventListener('click', () => {
                if (confirm('Cancel this job? Reputation will decrease.')) {
                    gameState.scheduledJobs[day] = gameState.scheduledJobs[day].filter(j => j.id !== job.id);
                    gameState.reputation = Math.max(0, gameState.reputation - 3);
                    gameState.stress = Math.min(100, gameState.stress + 5);
                    updateScheduleDisplay();
                    updateUI();
                    modal.remove();
                }
            });
            
            modal.querySelector('#reschedule-job').addEventListener('click', () => {
                modal.remove();
                showRescheduleDialog(job, day);
            });
            
            modal.querySelector('#close-options').addEventListener('click', () => modal.remove());
        }

        function showRescheduleDialog(job, oldDay) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">Reschedule ${job.customer}</h3>
                    <div class="modal-content">
                        <select id="new-day" style="width:100%; padding:10px; margin-bottom:10px;">
                            ${DAYS_OF_WEEK.map((d,i) => `<option value="${i}" ${i===oldDay?'selected':''}>${d}</option>`).join('')}
                        </select>
                        <select id="new-hour" style="width:100%; padding:10px;">
                            ${[...Array(10).keys()].map(i => 8+i).map(h => `<option value="${h}" ${h===job.time?'selected':''}>${formatTime(h)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button id="confirm-reschedule" class="btn">Confirm</button>
                        <button id="cancel-reschedule" class="btn btn-danger">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.querySelector('#confirm-reschedule').addEventListener('click', () => {
                const newDay = parseInt(modal.querySelector('#new-day').value);
                const newHour = parseInt(modal.querySelector('#new-hour').value);
                if (newDay === oldDay && newHour === job.time) {
                    modal.remove();
                    return;
                }
                // Check if slot free
                if (gameState.scheduledJobs[newDay].some(j => j.time === newHour)) {
                    showNotification('Slot already booked', true);
                    return;
                }
                // Remove from old day
                gameState.scheduledJobs[oldDay] = gameState.scheduledJobs[oldDay].filter(j => j.id !== job.id);
                // Update job time and day
                job.time = newHour;
                job.day = newDay;
                gameState.scheduledJobs[newDay].push(job);
                updateScheduleDisplay();
                modal.remove();
            });
            
            modal.querySelector('#cancel-reschedule').addEventListener('click', () => modal.remove());
        }

        function showScheduleJobDialog(day, hour) {
            const unscheduled = gameState.customers.filter(j => !j.scheduled);
            if (unscheduled.length === 0) {
                showNotification('No unscheduled jobs', true);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">Schedule at ${formatTime(hour)} on ${DAYS_OF_WEEK[day]}</h3>
                    <div class="modal-content" style="max-height:300px; overflow-y:auto;">
                        ${unscheduled.map(j => `
                            <button class="btn" style="margin-bottom:8px; text-align:left;" data-jobid="${j.id}">
                                ${j.customer} - ${j.type.name} ($${j.pay})
                            </button>
                        `).join('')}
                    </div>
                    <button id="cancel-schedule" class="btn btn-danger">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            unscheduled.forEach(j => {
                const btn = modal.querySelector(`button[data-jobid="${j.id}"]`);
                btn.addEventListener('click', () => {
                    j.scheduled = true;
                    j.day = day;
                    j.time = hour;
                    gameState.scheduledJobs[day].push(j);
                    gameState.customers = gameState.customers.filter(c => c.id !== j.id);
                    showNotification(`Scheduled ${j.customer}`);
                    updateScheduleDisplay();
                    updateUI();
                    modal.remove();
                });
            });
            
            modal.querySelector('#cancel-schedule').addEventListener('click', () => modal.remove());
        }

        function autoScheduleJobs() {
            const unscheduled = [...gameState.customers];
            if (unscheduled.length === 0) {
                showNotification('No unscheduled jobs');
                return;
            }
            
            for (let job of unscheduled) {
                let scheduled = false;
                for (let d = 0; d < 5 && !scheduled; d++) {
                    for (let h = 8; h <= 17; h++) {
                        if (!gameState.scheduledJobs[d].some(j => j.time === h)) {
                            job.scheduled = true;
                            job.day = d;
                            job.time = h;
                            gameState.scheduledJobs[d].push(job);
                            gameState.customers = gameState.customers.filter(c => c.id !== job.id);
                            scheduled = true;
                            break;
                        }
                    }
                }
            }
            updateScheduleDisplay();
            updateUI();
            showNotification('Auto-schedule complete');
        }

        // ==================== SHOP ====================
        function setupShop() {
            // Mowers
            const mowersDiv = document.getElementById('mowers');
            mowersDiv.innerHTML = '';
            for (const [key, item] of Object.entries(EQUIPMENT_STATS.mower)) {
                if (item.price === 0) continue;
                const owned = gameState.equipment.mower === key ? ' (Owned)' : '';
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-item-header">
                        <span class="shop-item-name">${item.name}${owned}</span>
                        <span class="shop-item-price">$${item.price}</span>
                    </div>
                    <div class="shop-item-stats">
                        <div>Speed: ${item.speed}x</div>
                        <div>Stress: ${item.stress}</div>
                        <div>Reliability: ${Math.round(item.reliability*100)}%</div>
                    </div>
                `;
                if (!owned) {
                    const btn = document.createElement('button');
                    btn.className = 'btn shop-item-btn';
                    btn.textContent = 'Buy';
                    btn.addEventListener('click', () => buyEquipment('mower', key, item.price));
                    div.appendChild(btn);
                }
                mowersDiv.appendChild(div);
            }
            
            // Trimmers (similar)
            const trimmersDiv = document.getElementById('trimmers');
            trimmersDiv.innerHTML = '';
            for (const [key, item] of Object.entries(EQUIPMENT_STATS.trimmer)) {
                if (item.price === 0) continue;
                const owned = gameState.equipment.trimmer === key ? ' (Owned)' : '';
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-item-header">
                        <span class="shop-item-name">${item.name}${owned}</span>
                        <span class="shop-item-price">$${item.price}</span>
                    </div>
                    <div class="shop-item-stats">
                        <div>Speed: ${item.speed}x</div>
                        <div>Stress: ${item.stress}</div>
                        <div>Reliability: ${Math.round(item.reliability*100)}%</div>
                    </div>
                `;
                if (!owned) {
                    const btn = document.createElement('button');
                    btn.className = 'btn shop-item-btn';
                    btn.textContent = 'Buy';
                    btn.addEventListener('click', () => buyEquipment('trimmer', key, item.price));
                    div.appendChild(btn);
                }
                trimmersDiv.appendChild(div);
            }
            
            // Blowers (similar)
            const blowersDiv = document.getElementById('blowers');
            blowersDiv.innerHTML = '';
            for (const [key, item] of Object.entries(EQUIPMENT_STATS.blower)) {
                if (item.price === 0) continue;
                const owned = gameState.equipment.blower === key ? ' (Owned)' : '';
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="shop-item-header">
                        <span class="shop-item-name">${item.name}${owned}</span>
                        <span class="shop-item-price">$${item.price}</span>
                    </div>
                    <div class="shop-item-stats">
                        <div>Speed: ${item.speed}x</div>
                        <div>Stress: ${item.stress}</div>
                        <div>Reliability: ${Math.round(item.reliability*100)}%</div>
                    </div>
                `;
                if (!owned) {
                    const btn = document.createElement('button');
                    btn.className = 'btn shop-item-btn';
                    btn.textContent = 'Buy';
                    btn.addEventListener('click', () => buyEquipment('blower', key, item.price));
                    div.appendChild(btn);
                }
                blowersDiv.appendChild(div);
            }
            
            // Supplies
            const suppliesDiv = document.getElementById('supplies');
            suppliesDiv.innerHTML = '';
            
            // Petrol
            suppliesDiv.appendChild(createSupplyItem('Petrol Refill', 50, 'Restores petrol to 100%', () => {
                if (deductMoney(50)) {
                    gameState.equipment.petrol = 100;
                    showNotification('Petrol refilled');
                    updateUI();
                } else showNotification('Not enough money', true);
            }, gameState.equipment.petrol));
            
            // Energy drinks
            suppliesDiv.appendChild(createSupplyItem('Energy Drink (3-pack)', 30, 'Restores 50 energy each', () => {
                if (deductMoney(30)) {
                    gameState.equipment.energyDrinks += 3;
                    showNotification('Bought 3 energy drinks');
                    updateUI();
                } else showNotification('Not enough money', true);
            }));
            
            // Mower belt
            suppliesDiv.appendChild(createSupplyItem('Mower Belt', 40, 'Restores belt to 100%', () => {
                if (deductMoney(40)) {
                    gameState.equipment.mowerBelt = 100;
                    showNotification('Belt replaced');
                    updateUI();
                } else showNotification('Not enough money', true);
            }, gameState.equipment.mowerBelt));
            
            // Trimmer cord
            suppliesDiv.appendChild(createSupplyItem('Trimmer Cord', 25, 'Restores cord to 100%', () => {
                if (deductMoney(25)) {
                    gameState.equipment.trimmerCord = 100;
                    showNotification('Cord replaced');
                    updateUI();
                } else showNotification('Not enough money', true);
            }, gameState.equipment.trimmerCord));
        }

        function createSupplyItem(name, price, desc, buyCallback, currentValue = null) {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div class="shop-item-header">
                    <span class="shop-item-name">${name}</span>
                    <span class="shop-item-price">$${price}</span>
                </div>
                <div class="shop-item-stats">${desc}</div>
                ${currentValue !== null ? `<div class="shop-item-current">Current: ${Math.round(currentValue)}%</div>` : ''}
            `;
            const btn = document.createElement('button');
            btn.className = 'btn shop-item-btn';
            btn.textContent = 'Buy';
            btn.addEventListener('click', buyCallback);
            div.appendChild(btn);
            return div;
        }

        function buyEquipment(type, model, price) {
            if (price > 100 && !confirm(`Are you sure you want to buy this for $${price}?`)) return;
            if (deductMoney(price)) {
                gameState.equipment[type] = model;
                gameState.equipment.equipmentStatus[type] = 100;
                showNotification(`Purchased ${EQUIPMENT_STATS[type][model].name}`);
                updateUI();
                updateBankDisplay();
                setupShop();
            } else {
                showNotification(`Not enough money. Need $${price}`, true);
            }
        }

        // ==================== WORK DAY ====================
        function startWorkDay() {
            // Check if there's an interrupted job
            if (gameState.interruptedJob) {
                resumeInterruptedJob();
                return;
            }
            
            if (gameState.workDayActive) {
                showScreen('work');
                return;
            }
            if (gameState.scheduledJobs[gameState.day].length === 0) {
                showNotification('No jobs scheduled today', true);
                return;
            }
            
            gameState.workDayActive = true;
            gameState.currentJobIndex = 0;
            gameState.currentWorkDayTime = 8;
            gameState.dailyCompleted = 0;
            gameState.dailyFailed = 0;
            gameState.energyDrinkActive = false;
            gameState.energyDrinkEndTime = 0;
            gameState.paused = false;
            elements.buttons.pauseWork.innerHTML = '<i class="fas fa-pause"></i> Pause';
            
            // Sort jobs by time
            gameState.scheduledJobs[gameState.day].sort((a,b) => a.time - b.time);
            
            startNextJob();
            showScreen('work');
            updateUI();
        }

        function resumeInterruptedJob() {
            const ij = gameState.interruptedJob;
            gameState.currentJob = ij.job;
            gameState.currentJob.progress = ij.progress;
            gameState.currentJob.timeRemaining = ij.timeRemaining;
            gameState.currentWorkDayTime = ij.currentWorkDayTime;
            // Restore equipment? No, we don't snapshot equipment, so current equipment levels (after shop) are used.
            gameState.workDayActive = true;
            gameState.currentJobIndex = gameState.scheduledJobs[gameState.day].findIndex(j => j.id === ij.job.id);
            if (gameState.currentJobIndex === -1) {
                // Job no longer exists? Should not happen
                gameState.interruptedJob = null;
                showNotification('Error: Job not found', true);
                showScreen('main');
                return;
            }
            gameState.interruptedJob = null;
            
            if (gameState.workTimer) clearInterval(gameState.workTimer);
            gameState.workTimer = setInterval(workOnJob, 1000);
            
            showScreen('work');
            updateWorkScreen();
            updateUI();
            showNotification('Resuming interrupted job');
        }

        function startNextJob() {
            if (gameState.currentJobIndex >= gameState.scheduledJobs[gameState.day].length) {
                endWorkDay();
                return;
            }
            
            gameState.currentJob = gameState.scheduledJobs[gameState.day][gameState.currentJobIndex];
            
            if (gameState.currentJob.completed || gameState.currentJob.missed) {
                gameState.currentJobIndex++;
                startNextJob();
                return;
            }
            
            gameState.currentWorkDayTime = Math.max(gameState.currentWorkDayTime, gameState.currentJob.time);
            
            if (gameState.currentWorkDayTime >= 17) {
                missJob();
                return;
            }
            
            const mowerSpeed = EQUIPMENT_STATS.mower[gameState.equipment.mower].speed;
            const weatherMod = WEATHER_EFFECTS[gameState.weather].workModifier;
            const difficulty = gameState.currentJob.difficulty || 1.0;
            const jobTime = gameState.currentJob.type.baseTime / 60 / mowerSpeed / weatherMod * difficulty; // hours
            
            gameState.currentJob.timeRemaining = jobTime * 60; // minutes
            gameState.currentJob.progress = 0;
            gameState.currentJob.originalTimeRemaining = gameState.currentJob.timeRemaining;
            
            addToJobHistory(`Started job for ${gameState.currentJob.customer} at ${formatTime(gameState.currentWorkDayTime)}`);
            
            if (gameState.workTimer) clearInterval(gameState.workTimer);
            gameState.workTimer = setInterval(workOnJob, 1000);
            updateWorkScreen();
        }

        function workOnJob() {
            if (gameState.paused || !gameState.currentJob) return;
            
            // Check energy drink duration
            if (gameState.energyDrinkActive && gameState.currentWorkDayTime >= gameState.energyDrinkEndTime) {
                gameState.energyDrinkActive = false;
                showNotification('Energy drink effect ended');
            }
            
            const speedMultiplier = gameState.energyDrinkActive ? 2 : 1;
            
            // Reduce time remaining
            gameState.currentJob.timeRemaining -= (1 * speedMultiplier);
            
            // Update progress
            const elapsed = (gameState.currentJob.originalTimeRemaining - gameState.currentJob.timeRemaining) / gameState.currentJob.originalTimeRemaining;
            gameState.currentJob.progress = elapsed * 100;
            
            // Advance time (FIXED: multiply, not divide)
            gameState.currentWorkDayTime += (1/60) * speedMultiplier;
            
            // Equipment wear
            const mowerReliability = EQUIPMENT_STATS.mower[gameState.equipment.mower].reliability;
            const beltFactor = gameState.equipment.mowerBelt < 50 ? 1.5 : 1.0;
            const cordFactor = gameState.equipment.trimmerCord < 50 ? 1.5 : 1.0;
            
            gameState.equipment.petrol = Math.max(0, gameState.equipment.petrol - (0.25 * (1/mowerReliability) * speedMultiplier * beltFactor));
            gameState.equipment.mowerBelt = Math.max(0, gameState.equipment.mowerBelt - (0.1 * speedMultiplier));
            gameState.equipment.trimmerCord = Math.max(0, gameState.equipment.trimmerCord - (0.1 * speedMultiplier));
            gameState.equipment.equipmentStatus.mower = Math.max(0, gameState.equipment.equipmentStatus.mower - (0.2 * (1/mowerReliability) * speedMultiplier * beltFactor));
            gameState.equipment.equipmentStatus.trimmer = Math.max(0, gameState.equipment.equipmentStatus.trimmer - (0.1 * (1/mowerReliability) * speedMultiplier * cordFactor));
            
            // Stress & energy
            const mowerStress = EQUIPMENT_STATS.mower[gameState.equipment.mower].stress;
            const trimmerStress = EQUIPMENT_STATS.trimmer[gameState.equipment.trimmer].stress;
            const blowerStress = EQUIPMENT_STATS.blower[gameState.equipment.blower].stress;
            const equipmentStressMod = (mowerStress + trimmerStress + blowerStress) / 3;
            const weatherStress = WEATHER_EFFECTS[gameState.weather].stressModifier / 20;
            
            gameState.energy = Math.max(0, gameState.energy - (0.5 * weatherStress * speedMultiplier));
            gameState.stress = Math.min(100, gameState.stress + (0.3 * weatherStress * speedMultiplier * equipmentStressMod));
            
            // Check failures - INTERRUPT instead of fail for recoverable issues
            if (gameState.equipment.petrol <= 0) {
                interruptJob('Out of petrol');
                return;
            }
            if (gameState.equipment.equipmentStatus.mower <= 0) {
                interruptJob('Mower broke');
                return;
            }
            if (gameState.equipment.equipmentStatus.trimmer <= 0) {
                interruptJob('Trimmer broke');
                return;
            }
            if (gameState.energy <= 0) {
                interruptJob('Exhausted');
                return;
            }
            
            // Check job completion
            if (gameState.currentJob.timeRemaining <= 0) {
                completeJob();
                return;
            }
            
            // Check end of day
            if (gameState.currentWorkDayTime >= 17) {
                endWorkDay();
                return;
            }
            
            // Random events (1% chance per tick)
            if (Math.random() < 0.01) {
                triggerRandomEvent();
            }
            
            updateWorkScreen();
            updateUI();
        }

        function triggerRandomEvent() {
            const events = [
                { msg: 'Customer brings lemonade! Energy +10', effect: () => gameState.energy = Math.min(100, gameState.energy + 10) },
                { msg: 'Mower hits a rock! Belt damaged', effect: () => gameState.equipment.mowerBelt = Math.max(0, gameState.equipment.mowerBelt - 20) },
                { msg: 'Cold drink offered! Stress -5', effect: () => gameState.stress = Math.max(0, gameState.stress - 5) },
                { msg: 'Dog chases you! Stress +10', effect: () => gameState.stress = Math.min(100, gameState.stress + 10) },
                { msg: 'Neighbour pays you $10 to do their path', effect: () => gameState.money += 10 }
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
            showNotification(event.msg);
        }

        // NEW: Interrupt current job and save progress
        function interruptJob(reason) {
            clearInterval(gameState.workTimer);
            gameState.workTimer = null;

            // Save job progress (but not equipment – we want player to be able to buy supplies)
            gameState.interruptedJob = {
                job: { ...gameState.currentJob }, // shallow copy (job object contains primitives)
                progress: gameState.currentJob.progress,
                timeRemaining: gameState.currentJob.timeRemaining,
                currentWorkDayTime: gameState.currentWorkDayTime
                // No equipment snapshot – so shop purchases affect current equipment
            };

            gameState.workDayActive = false;
            gameState.currentJob = null;
            showNotification(`Job interrupted: ${reason}. You can resume later.`);
            showScreen('main');
            updateUI();
        }

        function completeJob() {
            clearInterval(gameState.workTimer);
            
            gameState.currentJob.completed = true;
            gameState.dailyCompleted++;
            gameState.completedJobs++;
            
            if (!gameState.mowedCustomers.includes(gameState.currentJob.customer)) {
                gameState.mowedCustomers.push(gameState.currentJob.customer);
            }
            
            const grossPay = gameState.currentJob.pay;
            const tax = grossPay * 0.15;
            const net = grossPay - tax;
            
            gameState.bank.payee += net;
            gameState.bank.tax += tax;
            gameState.reputation = Math.min(100, gameState.reputation + gameState.currentJob.type.reputation);
            
            // Tip chance
            if (Math.random() < gameState.reputation / 100) {
                const tip = Math.round(grossPay * 0.2);
                gameState.bank.payee += tip;
                gameState.stress = Math.max(0, gameState.stress - 5);
                showNotification(`Tip! +$${tip} <span class="stress-down">Stress -5</span>`);
            }
            
            addToJobHistory(`Completed ${gameState.currentJob.customer}. Earned $${net.toFixed(2)}`);
            showNotification(`Job complete! Earned $${net.toFixed(2)}`);
            
            gameState.energyDrinkActive = false;
            gameState.currentJobIndex++;
            startNextJob();
        }

        function failJob(reason) {
            clearInterval(gameState.workTimer);
            
            gameState.currentJob.missed = true;
            gameState.dailyFailed++;
            gameState.failedJobs++;
            gameState.reputation = Math.max(0, gameState.reputation - 5);
            gameState.stress = Math.min(100, gameState.stress + 10);
            
            addToJobHistory(`Failed: ${reason} for ${gameState.currentJob.customer}`);
            showNotification(`Job failed: ${reason}`, true);
            
            gameState.energyDrinkActive = false;
            gameState.currentJobIndex++;
            startNextJob();
        }

        function missJob() {
            gameState.currentJob.missed = true;
            gameState.dailyFailed++;
            gameState.failedJobs++;
            gameState.reputation = Math.max(0, gameState.reputation - 3);
            gameState.stress = Math.min(100, gameState.stress + 5);
            
            addToJobHistory(`Missed job for ${gameState.currentJob.customer} (too late)`);
            showNotification('Missed job', true);
            
            gameState.energyDrinkActive = false;
            gameState.currentJobIndex++;
            startNextJob();
        }

        function useEnergyDrink() {
            if (gameState.equipment.energyDrinks <= 0) return;
            gameState.equipment.energyDrinks--;
            gameState.energy = Math.min(100, gameState.energy + 50);
            gameState.energyDrinkActive = true;
            gameState.energyDrinkEndTime = gameState.currentWorkDayTime + 0.5; // 30 minutes
            showNotification('Energy drink: +50 energy, 2x speed for 30 min');
            updateUI();
        }

        function togglePause() {
            gameState.paused = !gameState.paused;
            elements.buttons.pauseWork.innerHTML = gameState.paused ? 
                '<i class="fas fa-play"></i> Resume' : '<i class="fas fa-pause"></i> Pause';
        }

        // NEW: Save and exit work (manual interrupt)
        function saveAndExitWork() {
            if (!gameState.currentJob) {
                // No current job? Just go to main menu
                gameState.workDayActive = false;
                showScreen('main');
                return;
            }
            interruptJob('Paused by player');
        }

        function showRepairModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3 class="modal-title">Repair Equipment</h3>
                    <div class="modal-content">
                        <p>Mower: ${Math.round(gameState.equipment.equipmentStatus.mower)}% - Repair $50 (15 min)</p>
                        <p>Mower Belt: ${Math.round(gameState.equipment.mowerBelt)}% - Fix $30 (10 min)</p>
                        <p>Trimmer Cord: ${Math.round(gameState.equipment.trimmerCord)}% - Fix $20 (10 min)</p>
                    </div>
                    <div class="modal-actions">
                        <button id="repair-mower" class="btn" ${gameState.equipment.equipmentStatus.mower >= 100 ? 'disabled' : ''}>Repair Mower ($50)</button>
                        <button id="repair-belt" class="btn" ${gameState.equipment.mowerBelt >= 100 ? 'disabled' : ''}>Fix Belt ($30)</button>
                        <button id="repair-cord" class="btn" ${gameState.equipment.trimmerCord >= 100 ? 'disabled' : ''}>Fix Cord ($20)</button>
                        <button id="close-repair" class="btn btn-danger">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.querySelector('#repair-mower').addEventListener('click', () => {
                if (deductMoney(50) && gameState.currentWorkDayTime + 0.25 < 17) { // 15 min = 0.25 hours
                    gameState.equipment.equipmentStatus.mower = 100;
                    gameState.currentWorkDayTime += 0.25;
                    showNotification('Mower repaired');
                    updateWorkScreen();
                    modal.remove();
                } else {
                    showNotification('Not enough money or time', true);
                }
            });
            
            modal.querySelector('#repair-belt').addEventListener('click', () => {
                if (deductMoney(30) && gameState.currentWorkDayTime + 0.1667 < 17) { // 10 min = 0.1667 hours
                    gameState.equipment.mowerBelt = 100;
                    gameState.currentWorkDayTime += 0.1667;
                    showNotification('Belt repaired');
                    updateWorkScreen();
                    modal.remove();
                } else {
                    showNotification('Not enough money or time', true);
                }
            });
            
            modal.querySelector('#repair-cord').addEventListener('click', () => {
                if (deductMoney(20) && gameState.currentWorkDayTime + 0.1667 < 17) {
                    gameState.equipment.trimmerCord = 100;
                    gameState.currentWorkDayTime += 0.1667;
                    showNotification('Cord repaired');
                    updateWorkScreen();
                    modal.remove();
                } else {
                    showNotification('Not enough money or time', true);
                }
            });
            
            modal.querySelector('#close-repair').addEventListener('click', () => modal.remove());
        }

        function updateWorkScreen() {
            if (!gameState.currentJob) return;
            
            elements.workDay.textContent = DAYS_OF_WEEK[gameState.day];
            elements.currentJobName.textContent = `${gameState.currentJob.customer} - ${gameState.currentJob.type.name}`;
            elements.jobProgress.value = gameState.currentJob.progress;
            elements.timeRemaining.textContent = Math.ceil(gameState.currentJob.timeRemaining);
            elements.jobPay.textContent = `$${gameState.currentJob.pay.toFixed(2)}`;
            elements.jobWeather.textContent = WEATHER_EFFECTS[gameState.weather].name;
            elements.jobDifficulty.textContent = `${(gameState.currentJob.difficulty || 1.0).toFixed(1)}x`;
            
            elements.mowerStatus.textContent = `${Math.round(gameState.equipment.equipmentStatus.mower)}%`;
            elements.trimmerStatus.textContent = `${Math.round(gameState.equipment.equipmentStatus.trimmer)}%`;
            elements.blowerStatus.textContent = '100%';
            elements.petrolStatus.textContent = `${Math.round(gameState.equipment.petrol)}%`;
            elements.beltStatus.textContent = `${Math.round(gameState.equipment.mowerBelt)}%`;
            elements.cordStatus.textContent = `${Math.round(gameState.equipment.trimmerCord)}%`;
            
            // Upcoming jobs
            const upcoming = gameState.scheduledJobs[gameState.day].slice(gameState.currentJobIndex + 1);
            elements.upcomingJobsList.innerHTML = upcoming.map(j => 
                `<div class="upcoming-job-item">${formatTime(j.time)} - ${j.customer} (${j.type.name})</div>`
            ).join('');
            
            // Time display during work
            elements.timeDisplay.textContent = formatTime(gameState.currentWorkDayTime);
        }

        function endWorkDay() {
            if (gameState.workTimer) clearInterval(gameState.workTimer);
            
            // If there's an interrupted job, mark it as missed
            if (gameState.interruptedJob) {
                const job = gameState.interruptedJob.job;
                job.missed = true;
                gameState.dailyFailed++;
                gameState.failedJobs++;
                gameState.reputation = Math.max(0, gameState.reputation - 3);
                gameState.stress = Math.min(100, gameState.stress + 5);
                addToJobHistory(`Job for ${job.customer} was abandoned (day ended)`);
                gameState.interruptedJob = null;
            }
            
            gameState.workDayActive = false;
            gameState.currentJob = null;
            gameState.energyDrinkActive = false;
            gameState.time = 17;
            
            // Change weather for next day
            gameState.weather = getRandomWeather();
            
            // Summary
            showNotification(`Day ended: ${gameState.dailyCompleted} completed, ${gameState.dailyFailed} failed`);
            
            // Generate new emails
            if (Math.random() < 0.7) generateNewEmail();
            
            showScreen('main');
            updateUI();
        }

        // ==================== DAY ADVANCEMENT ====================
        function advanceDay() {
            // Cannot advance day if there's an interrupted job
            if (gameState.interruptedJob) {
                showNotification('You have an interrupted job! Resume or end the day first.', true);
                return;
            }
            
            gameState.day++;
            if (gameState.day >= 5) {
                gameState.day = 0;
                gameState.week++;
                
                // Interest
                const interest = gameState.bank.savings * 0.02;
                gameState.bank.savings += interest;
                showNotification(`Savings interest: +$${interest.toFixed(2)}`);
                
                if (gameState.week > 4) {
                    gameState.week = 1;
                    gameState.month++;
                    const tax = gameState.bank.tax;
                    gameState.bank.tax = 0;
                    showNotification(`Monthly taxes paid: $${tax.toFixed(2)}`);
                }
                
                // Reset job completion flags
                for (let d = 0; d < 5; d++) {
                    gameState.scheduledJobs[d].forEach(j => { j.completed = false; j.missed = false; });
                }
                
                payWeeklyExpenses();
            }
            
            gameState.time = 8;
            gameState.energy = Math.min(100, gameState.energy + 30);
            gameState.stress = Math.max(0, gameState.stress - 10);
            
            if (Math.random() < 0.5) generateNewEmail();
            
            updateUI();
            showNotification(`It's now ${DAYS_OF_WEEK[gameState.day]}. Weather: ${WEATHER_EFFECTS[gameState.weather].name}`);
        }

        function payWeeklyExpenses() {
            const base = 100;
            const equip = (EQUIPMENT_STATS.mower[gameState.equipment.mower].price > 0 ? 20 : 0) +
                         (EQUIPMENT_STATS.trimmer[gameState.equipment.trimmer].price > 0 ? 10 : 0) +
                         (EQUIPMENT_STATS.blower[gameState.equipment.blower].price > 0 ? 10 : 0);
            const total = base + equip;
            
            const available = gameState.money + gameState.bank.payee;
            if (available >= total) {
                deductMoney(total);
                showNotification(`Weekly expenses: $${total} deducted`);
            } else {
                // Not enough - deduct all and penalize
                deductMoney(available);
                gameState.reputation = Math.max(0, gameState.reputation - 20);
                gameState.stress = Math.min(100, gameState.stress + 20);
                showNotification(`Couldn't pay full expenses! Reputation -20, Stress +20`, true);
            }
        }

        function getRandomWeather() {
            const types = Object.keys(WEATHER_EFFECTS);
            const weights = types.map(t => WEATHER_EFFECTS[t].chance);
            return weightedRandom(types, weights);
        }

        // ==================== HISTORY ====================
        function addToJobHistory(msg) {
            const now = new Date();
            const timestamp = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
            gameState.jobHistory.unshift(`${timestamp} - ${msg}`);
            if (gameState.jobHistory.length > 50) gameState.jobHistory.pop();
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            elements.jobHistory.innerHTML = gameState.jobHistory.slice(0,5).map(h => 
                `<div class="job-history-item">${h}</div>`).join('');
        }

        function updateFullHistoryDisplay() {
            elements.fullHistory.innerHTML = gameState.jobHistory.map(h => 
                `<div class="job-history-item">${h}</div>`).join('');
        }

        // ==================== UTILITIES ====================
        function randomProperty(obj) {
            const keys = Object.keys(obj);
            return obj[keys[Math.floor(Math.random() * keys.length)]];
        }

        function randomCustomer() {
            return CUSTOMER_NAMES[Math.floor(Math.random() * CUSTOMER_NAMES.length)];
        }

        function weightedRandom(items, weights) {
            const total = weights.reduce((a,b) => a+b, 0);
            let rand = Math.random() * total;
            let sum = 0;
            for (let i = 0; i < items.length; i++) {
                sum += weights[i];
                if (rand <= sum) return items[i];
            }
            return items[0];
        }

        // Start the game
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
