<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dracula's Rise - Complete Gamebook</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-container {
            border: 4px double #fff;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #111;
            min-height: 80vh;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        h1, h2, h3 {
            color: #ff3333;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-top: 20px;
        }
        
        h3 {
            font-size: 1.2rem;
            text-align: left;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 15px;
        }
        
        .game-text {
            background-color: #000;
            border: 2px solid #333;
            padding: 15px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .game-text p {
            margin-bottom: 15px;
        }
        
        .npc-dialogue {
            color: #ffff66;
            font-style: italic;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #ffff66;
        }
        
        .player-dialogue {
            color: #66ff66;
            margin: 10px 0;
            padding-left: 10px;
            border-left: 2px solid #66ff66;
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background-color: #222;
            color: #fff;
            border: 2px solid #666;
            font-family: 'Press Start 2P', cursive;
            padding: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            flex-grow: 1;
            min-width: 200px;
        }
        
        button:hover:not(:disabled) {
            background-color: #333;
            border-color: #ff3333;
            color: #ff3333;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background-color: #222;
            padding: 10px;
            border: 1px solid #444;
        }
        
        .stat-value {
            color: #ffff66;
            font-weight: bold;
        }
        
        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .item {
            background-color: #1a1a1a;
            padding: 8px;
            border: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .item-rare {
            border-color: #ff9900;
            color: #ff9900;
        }
        
        .item-legendary {
            border-color: #ff3366;
            color: #ff3366;
        }
        
        .outcome-good {
            color: #66ff66;
        }
        
        .outcome-bad {
            color: #ff6666;
        }
        
        .warning {
            color: #ff9900;
        }
        
        .game-over {
            color: #ff0000;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .victory {
            color: #66ff66;
            font-size: 1.5rem;
            text-align: center;
            margin: 30px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.7rem;
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        
        /* New styles for gamebook features */
        .dice-roll {
            background-color: #2a2a2a;
            border: 2px solid #555;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
        
        .dice-result {
            font-size: 1.5rem;
            color: #ffff66;
            margin: 10px 0;
        }
        
        .combat-log {
            background-color: #330000;
            border: 1px solid #660000;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .combat-turn {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px dotted #660000;
        }
        
        .skill-check {
            background-color: #1a1a2a;
            border: 1px solid #4444ff;
            padding: 10px;
            margin: 10px 0;
        }
        
        .puzzle {
            background-color: #2a1a2a;
            border: 2px dashed #aa66aa;
            padding: 15px;
            margin: 15px 0;
        }
        
        .trap {
            background-color: #552222;
            border: 2px solid #ff5555;
            padding: 15px;
            margin: 15px 0;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #ff5555; }
            50% { border-color: #ff0000; }
            100% { border-color: #ff5555; }
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #222;
            border: 1px solid #444;
        }
        
        .item-use-btn {
            padding: 5px 10px;
            font-size: 0.7rem;
            background-color: #333;
            border: 1px solid #666;
            cursor: pointer;
        }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #330000;
            border: 1px solid #666;
            margin: 5px 0;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.3s;
        }
        
        .health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            line-height: 20px;
            font-size: 0.7rem;
        }
        
        .luck-bar {
            width: 100%;
            height: 15px;
            background-color: #222244;
            border: 1px solid #4444aa;
            margin: 5px 0;
            position: relative;
        }
        
        .luck-fill {
            height: 100%;
            background-color: #4444ff;
            transition: width 0.3s;
        }
        
        .luck-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            line-height: 15px;
            font-size: 0.6rem;
        }
        
        .section-number {
            color: #ff9900;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .gamebook-text {
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .gamebook-text p {
            margin-bottom: 20px;
        }
        
        .turn-to {
            color: #ff9900;
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .turn-to:hover {
            color: #ffcc00;
        }
        
        .combat-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .combat-stat {
            background-color: #2a2a2a;
            padding: 10px;
            text-align: center;
        }
        
        .enemy-sprite {
            text-align: center;
            margin: 15px 0;
            font-size: 3rem;
        }
        
        .continue-btn {
            background-color: #333;
            color: #66ff66;
            border: 2px solid #66ff66;
            font-size: 1rem;
            padding: 15px;
            margin: 20px auto;
            display: block;
            width: 80%;
        }
        
        .continue-btn:hover {
            background-color: #66ff66;
            color: #000;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .game-text {
                font-size: 0.8rem;
            }
            
            button {
                font-size: 0.7rem;
                min-width: 150px;
            }
            
            .combat-stats {
                grid-template-columns: 1fr;
            }
            
            .continue-btn {
                width: 95%;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <h1>DRACULA'S RISE - THE HUNTER'S QUEST</h1>
            <div class="game-text">
                <p>Transylvania, 1897. You are a vampire hunter who has tracked the trail of death to a remote tavern at the edge of the Carpathian Mountains.</p>
                <p>Dracula has returned to his ancestral castle, and the blood moon rises tonight. Villagers speak of missing travelers, strange howls in the forest, and shadowy figures moving through the mountains.</p>
                <p>Your mission: Start at the tavern, journey through the dark forest, climb the treacherous mountain pass, infiltrate the castle, and end Dracula's reign of terror.</p>
                <p>Choose your skills wisely, collect useful items, and prepare for the fight of your life against the Prince of Darkness!</p>
                <p class="warning">Gamebook Style: Navigate through numbered sections. Roll dice for combat and skill tests.</p>
                <p class="outcome-good">INCLUDES: Dice-based combat, inventory management, puzzles, traps, NPCs, and multiple endings!</p>
            </div>
            <div class="button-container">
                <button id="start-btn">BEGIN HUNT</button>
                <button id="rules-btn">GAME RULES</button>
            </div>
        </div>
        
        <!-- Rules Screen -->
        <div id="rules-screen" class="screen">
            <h2>GAMEBOOK RULES</h2>
            <div class="game-text">
                <h3>HOW TO PLAY</h3>
                <p>This is a gamebook adventure like Fighting Fantasy books. You'll navigate through numbered sections (paragraphs) and make choices that determine what happens next.</p>
                
                <h3>YOUR CHARACTER</h3>
                <p><span class="outcome-good">HEALTH:</span> Your life force. If it reaches 0, you die.</p>
                <p><span class="outcome-good">COMBAT:</span> Your fighting ability and skill with weapons.</p>
                <p><span class="outcome-good">AGILITY:</span> Your speed, reflexes, and ability to dodge attacks.</p>
                <p><span class="outcome-good">OBSERVATION:</span> Your ability to notice details and detect danger.</p>
                <p><span class="outcome-good">LORE:</span> Your knowledge of vampires, monsters, and dark magic.</p>
                <p><span class="outcome-good">STEALTH:</span> Your ability to move quietly and remain unseen.</p>
                
                <h3>COMBAT</h3>
                <p>When you enter combat:</p>
                <p>1. Roll two dice and add your COMBAT score for your Attack Strength.</p>
                <p>2. The enemy does the same.</p>
                <p>3. Higher Attack Strength hits the opponent, reducing their HEALTH.</p>
                <p>4. Repeat until one combatant's HEALTH reaches 0.</p>
                
                <h3>SKILL TESTS</h3>
                <p>When asked to test a skill (Agility, Observation, Lore, Stealth):</p>
                <p>1. Roll two dice.</p>
                <p>2. If the roll is EQUAL TO OR LESS than your skill score, you succeed.</p>
                <p>3. If the roll is HIGHER, you fail.</p>
                
                <h3>INVENTORY</h3>
                <p>You can carry up to 10 items. Weapons can be equipped for combat bonuses. Consumable items like potions can be used from your inventory.</p>
            </div>
            <div class="button-container">
                <button onclick="showStartScreen()">RETURN TO START</button>
                <button onclick="showCharacterScreen()">CREATE HUNTER</button>
            </div>
        </div>
        
        <!-- Character Creation Screen -->
        <div id="character-screen" class="screen">
            <h2>CREATE YOUR VAMPIRE HUNTER</h2>
            <div class="game-text">
                <p>Distribute 15 points among your skills (minimum 2, maximum 6 each).</p>
                <p>Your starting equipment depends on your background choice.</p>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>HEALTH <span id="health-value" class="stat-value">10</span></h3>
                        <p>Your life force</p>
                        <div class="health-bar">
                            <div id="health-fill-preview" class="health-fill" style="width: 100%"></div>
                            <div class="health-text"><span id="current-health">10</span>/10</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <h3>COMBAT <span id="combat-value" class="stat-value">3</span></h3>
                        <p>Fighting ability</p>
                        <button onclick="changeHunterStat('combat', 1)" id="combat-plus">+</button>
                        <button onclick="changeHunterStat('combat', -1)" id="combat-minus">-</button>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>AGILITY <span id="agility-value" class="stat-value">3</span></h3>
                        <p>Speed and reflexes</p>
                        <button onclick="changeHunterStat('agility', 1)" id="agility-plus">+</button>
                        <button onclick="changeHunterStat('agility', -1)" id="agility-minus">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>OBSERVATION <span id="observation-value" class="stat-value">3</span></h3>
                        <p>Notice details</p>
                        <button onclick="changeHunterStat('observation', 1)" id="observation-plus">+</button>
                        <button onclick="changeHunterStat('observation', -1)" id="observation-minus">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>LORE <span id="lore-value" class="stat-value">3</span></h3>
                        <p>Monster knowledge</p>
                        <button onclick="changeHunterStat('lore', 1)" id="lore-plus">+</button>
                        <button onclick="changeHunterStat('lore', -1)" id="lore-minus">-</button>
                    </div>
                    <div class="stat-item">
                        <h3>STEALTH <span id="stealth-value" class="stat-value">3</span></h3>
                        <p>Move unseen</p>
                        <button onclick="changeHunterStat('stealth', 1)" id="stealth-plus">+</button>
                        <button onclick="changeHunterStat('stealth', -1)" id="stealth-minus">-</button>
                    </div>
                </div>
                
                <p id="points-remaining">Points remaining: <span id="hunter-points">0</span></p>
                
                <h3>CHOOSE YOUR BACKGROUND</h3>
                <p>Select your hunting background:</p>
            </div>
            
            <div class="button-container">
                <button id="warrior-btn" onclick="selectBackground('warrior')">VETERAN WARRIOR<br>+1 Combat, Starts with Sword</button>
                <button id="scholar-btn" onclick="selectBackground('scholar')">OCCULT SCHOLAR<br>+2 Lore, Starts with Holy Water</button>
                <button id="scout-btn" onclick="selectBackground('scout')">WILDERNESS SCOUT<br>+1 Stealth, Starts with Silver Arrows</button>
            </div>
            
            <div class="button-container">
                <button id="begin-hunt-btn" disabled>BEGIN THE HUNT</button>
                <button onclick="showStartScreen()">BACK</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>DRACULA'S RISE</h2>
            
            <div class="stats-container">
                <div class="stat-item">
                    <h3>HEALTH</h3>
                    <div class="health-bar">
                        <div id="health-fill" class="health-fill" style="width: 100%"></div>
                        <div class="health-text"><span id="current-health-display">?</span>/<span id="max-health">?</span></div>
                    </div>
                </div>
                <div class="stat-item">
                    <h3>COMBAT</h3>
                    <p class="stat-value" id="current-combat">?</p>
                </div>
                <div class="stat-item">
                    <h3>AGILITY</h3>
                    <p class="stat-value" id="current-agility">?</p>
                </div>
                <div class="stat-item">
                    <h3>LOCATION</h3>
                    <p class="stat-value" id="current-location">The Tavern</p>
                </div>
            </div>
            
            <div class="button-container">
                <button onclick="showInventory()">INVENTORY (<span id="inventory-count">0</span>)</button>
                <button onclick="showStats()">CHARACTER SHEET</button>
                <button onclick="saveGame()">SAVE GAME</button>
                <button onclick="loadGame()">LOAD GAME</button>
            </div>
            
            <div class="game-text" id="game-text">
                <!-- Gamebook text will appear here -->
            </div>
            
            <div class="button-container" id="action-buttons">
                <!-- Action buttons will appear here -->
            </div>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventory-screen" class="screen">
            <h2>INVENTORY</h2>
            <div class="game-text">
                <h3>EQUIPMENT</h3>
                <div id="equipment-display">
                    <!-- Equipment will appear here -->
                </div>
                
                <h3>WEAPONS</h3>
                <div id="weapons-display">
                    <!-- Weapons will appear here -->
                </div>
                
                <h3>CONSUMABLES</h3>
                <div id="consumables-display">
                    <!-- Consumables will appear here -->
                </div>
                
                <h3>SPECIAL ITEMS</h3>
                <div id="special-items-display">
                    <!-- Special items will appear here -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="returnToGame()">RETURN TO ADVENTURE</button>
            </div>
        </div>
        
        <!-- Stats Screen -->
        <div id="stats-screen" class="screen">
            <h2>CHARACTER SHEET</h2>
            <div class="game-text">
                <div class="stats-container">
                    <div class="stat-item">
                        <h3>HEALTH</h3>
                        <p class="stat-value" id="sheet-health">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>COMBAT</h3>
                        <p class="stat-value" id="sheet-combat">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>AGILITY</h3>
                        <p class="stat-value" id="sheet-agility">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>OBSERVATION</h3>
                        <p class="stat-value" id="sheet-observation">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>LORE</h3>
                        <p class="stat-value" id="sheet-lore">?</p>
                    </div>
                    <div class="stat-item">
                        <h3>STEALTH</h3>
                        <p class="stat-value" id="sheet-stealth">?</p>
                    </div>
                </div>
                
                <h3>COMBAT BONUSES</h3>
                <div id="combat-bonuses">
                    <!-- Combat bonuses will appear here -->
                </div>
                
                <h3>EQUIPPED ITEMS</h3>
                <div id="equipped-items">
                    <!-- Equipped items will appear here -->
                </div>
            </div>
            <div class="button-container">
                <button onclick="returnToGame()">RETURN TO ADVENTURE</button>
            </div>
        </div>
        
        <!-- Combat Screen -->
        <div id="combat-screen" class="screen">
            <h2>COMBAT!</h2>
            <div class="game-text">
                <div id="combat-description">
                    <!-- Combat description will appear here -->
                </div>
                
                <div class="combat-stats">
                    <div class="combat-stat">
                        <h3>YOU</h3>
                        <p>HEALTH: <span id="player-combat-health">?</span></p>
                        <p>COMBAT: <span id="player-combat-skill">?</span></p>
                        <div class="health-bar">
                            <div id="player-health-bar" class="health-fill"></div>
                            <div class="health-text"><span id="player-health-text">?</span></div>
                        </div>
                    </div>
                    <div class="combat-stat">
                        <h3 id="enemy-name">ENEMY</h3>
                        <p>HEALTH: <span id="enemy-combat-health">?</span></p>
                        <p>COMBAT: <span id="enemy-combat-skill">?</span></p>
                        <div class="health-bar">
                            <div id="enemy-health-bar" class="health-fill"></div>
                            <div class="health-text"><span id="enemy-health-text">?</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="enemy-sprite" id="enemy-sprite">
                    ☠️
                </div>
                
                <div class="combat-log" id="combat-log">
                    <!-- Combat log will appear here -->
                </div>
                
                <div class="button-container" id="combat-options">
                    <!-- Combat options will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Dice Roll Screen -->
        <div id="dice-screen" class="screen">
            <h2>ROLL THE DICE!</h2>
            <div class="game-text">
                <div class="dice-roll">
                    <p id="dice-reason">Testing your skill...</p>
                    <div class="dice-result" id="dice-result">
                        ?
                    </div>
                    <p id="dice-outcome">Roll the dice to see what happens!</p>
                </div>
                
                <div id="dice-options">
                    <!-- Dice options will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="gameover-screen" class="screen">
            <h2>GAME OVER</h2>
            <div class="game-text" id="gameover-text">
                <!-- Game over text will appear here -->
            </div>
            <div class="button-container">
                <button onclick="restartGame()">TRY AGAIN</button>
                <button onclick="showStartScreen()">MAIN MENU</button>
            </div>
        </div>
        
        <!-- Victory Screen -->
        <div id="victory-screen" class="screen">
            <h2>VICTORY!</h2>
            <div class="game-text" id="victory-text">
                <!-- Victory text will appear here -->
            </div>
            <div class="button-container">
                <button onclick="restartGame()">PLAY AGAIN</button>
                <button onclick="showStartScreen()">MAIN MENU</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>DRACULA'S RISE - A GAMEBOOK ADVENTURE</p>
        <p>Hunt the vampire, survive the journey, save Transylvania!</p>
    </div>

    <script>
        // Game State
        const gameState = {
            screen: 'start',
            currentSection: 1,
            visitedSections: [],
            stats: {
                health: 10,
                maxHealth: 10,
                combat: 3,
                agility: 3,
                observation: 3,
                lore: 3,
                stealth: 3,
                points: 0
            },
            background: null,
            inventory: [],
            equippedWeapon: null,
            equippedArmor: null,
            combatBonus: 0,
            defenseBonus: 0,
            location: "The Tavern",
            gameOver: false,
            victory: false,
            inCombat: false,
            enemy: null,
            enemyData: null,
            combatRound: 0,
            afterCombatSection: null,
            dayNight: "Night",
            // NEW: Store combat info from skill checks
            pendingCombat: null
        };
        
        // Gamebook Sections for Dracula's Rise - UPDATED WITH FIXES
        const gamebook = {
            // THE TAVERN (Sections 1-20)
            1: {
                text: "You sit in the 'Crying Wolf' tavern, the last outpost before the dark forest. Rain drums against the windows as you study your map by candlelight. The barkeep, an old man with one eye, approaches you.",
                options: [
                    { text: "Ask about Dracula's castle", goto: 2 },
                    { text: "Buy supplies for the journey", goto: 3 },
                    { text: "Listen to the other patrons", skill: "observation", difficulty: 9, success: 4, failure: 5 },
                    { text: "Leave immediately for the forest", goto: 6 }
                ]
            },
            2: {
                text: "The barkeep leans close, his voice a whisper. 'Castle Dracula? That's a death wish, friend. The mountain pass is guarded by wolves and worse. The forest... it has eyes.' He offers you a choice:",
                options: [
                    { text: "Ask for a guide", goto: 7 },
                    { text: "Buy a special weapon", goto: 8 },
                    { text: "Get directions and leave", goto: 9 },
                    { text: "Threaten him for information", skill: "combat", difficulty: 11, success: 10, failure: 11 }
                ]
            },
            3: {
                text: "The barkeep shows you his wares. You have 20 gold coins. What do you buy?",
                options: [
                    { text: "Healing Potion (5 gold)", item: "healing_potion", cost: 5, goto: 12 },
                    { text: "Silver Dagger (10 gold)", item: "silver_dagger", cost: 10, goto: 13 },
                    { text: "Holy Water (8 gold)", item: "holy_water", cost: 8, goto: 14 },
                    { text: "Torch and Oil (3 gold)", item: "torch", cost: 3, goto: 15 },
                    { text: "Nothing, save your money", goto: 1 }
                ]
            },
            4: {
                text: "Your sharp ears pick up conversations. '...found three bodies drained of blood near the old mill.' '...my cousin saw bats big as eagles flying toward the mountain.' '...they say the Count has returned to claim his brides.' A shady figure in the corner watches you.",
                options: [
                    { text: "Approach the shady figure", goto: 16 },
                    { text: "Ask about the old mill", goto: 17 },
                    { text: "Return to studying your map", goto: 1 }
                ]
            },
            5: {
                text: "You can't make out the conversations over the tavern noise. The barkeep returns. 'Another ale?'",
                goto: 1
            },
            6: {
                text: "You step out into the cold night. The forest looms ahead, dark and silent. The mountain pass winds upward in the distance, and at its peak, you can just make out the silhouette of a castle against the moon.",
                location: "Forest Edge",
                options: [
                    { text: "Enter the forest", goto: 18 },
                    { text: "Take the mountain path", goto: 19 },
                    { text: "Return to the tavern", goto: 1 }
                ]
            },
            7: {
                text: "'Only one man knows the safe paths - Old Gregor. But he's... changed since his last trip to the castle. Talks to himself, afraid of shadows.' The barkeep points to a hunched figure in the corner.",
                options: [
                    { text: "Talk to Old Gregor", goto: 20 },
                    { text: "Forget the guide, go alone", goto: 6 }
                ]
            },
            
            // THE FOREST (Sections 21-40)
            18: {
                text: "The forest closes around you. Moonlight filters through the canopy, creating shifting shadows. You hear rustling in the bushes ahead. Test your Observation to see what's there.",
                skillCheck: { 
                    skill: "observation", 
                    difficulty: 10 
                },
                success: { 
                    text: "You spot glowing eyes in the darkness - wolves! You have time to prepare.", 
                    goto: 21 
                },
                failure: { 
                    text: "Suddenly, three wolves leap from the darkness!", 
                    combat: { 
                        enemy: "forest_wolves", 
                        afterCombat: 22 
                    } 
                }
            },
            21: {
                text: "The wolves approach slowly, circling you. They're larger than normal wolves, with intelligence in their eyes. You have time to choose your approach.",
                options: [
                    { text: "Attack with your weapon", combat: { enemy: "forest_wolves", afterCombat: 22 } },
                    { text: "Use a torch to scare them", item: "torch", goto: 23 },
                    { text: "Try to sneak past them", skill: "stealth", difficulty: 11, success: 24, failure: { combat: { enemy: "forest_wolves", afterCombat: 22 } } },
                    { text: "Use silver against them", item: "silver_weapon", goto: 25 }
                ]
            },
            22: {
                text: "You defeat the wolves! Their bodies dissolve into mist - these were no ordinary animals. Continuing deeper, you find an abandoned campsite.",
                options: [
                    { text: "Search the campsite", skill: "observation", difficulty: 9, success: 26, failure: 27 },
                    { text: "Continue through the forest", goto: 28 },
                    { text: "Rest and heal", goto: 29 }
                ]
            },
            23: {
                text: "You light your torch. The wolves shrink back from the flame, whining. They retreat into the darkness. The torch will last for a while, helping you navigate.",
                addItem: "lit_torch",
                goto: 30
            },
            24: {
                text: "You move silently through the undergrowth, avoiding the wolves. You emerge into a clearing with a ruined chapel.",
                goto: 31
            },
            25: {
                text: "Your silver weapon glows with pale light. The wolves howl in pain and retreat. Silver is effective against these creatures!",
                goto: 30
            },
            26: {
                text: "You find a journal: 'Day 3: The trees whisper at night. Day 5: Found the old chapel. Something watches from the crucifix. Day 7: The brides come at midnight...' Also find a silver crucifix.",
                addItem: "journal",
                addItem2: "silver_crucifix",
                goto: 31
            },
            27: {
                text: "The campsite has been picked clean. Only ashes remain in the fire pit.",
                goto: 28
            },
            28: {
                text: "The forest grows denser. Strange markings appear on trees - symbols you recognize from your studies as protective wards against vampires.",
                options: [
                    { text: "Study the markings", skill: "lore", difficulty: 10, success: 32, failure: 33 },
                    { text: "Follow a narrow animal trail", goto: 34 },
                    { text: "Climb a tree to get bearings", skill: "agility", difficulty: 11, success: 35, failure: 36 }
                ]
            },
            31: {
                text: "The ruined chapel stands in a clearing. The roof has collapsed, and a stone altar remains intact. A statue of a saint lies broken on the ground. Something moves in the shadows near the altar.",
                options: [
                    { text: "Investigate the altar", goto: 37 },
                    { text: "Search for the movement", skill: "observation", difficulty: 10, success: 38, failure: 39 },
                    { text: "Leave the chapel", goto: 40 }
                ]
            },
            
            // THE MOUNTAIN PASS (Sections 41-60)
            40: {
                text: "You reach the edge of the forest. Before you stretches the mountain pass, winding upward toward the castle. The wind howls through the rocks. You see three possible routes:",
                location: "Mountain Pass",
                options: [
                    { text: "The main path - well-traveled but exposed", goto: 41 },
                    { text: "A cave passage - dark but sheltered", goto: 42 },
                    { text: "A cliffside trail - dangerous but fast", skill: "agility", difficulty: 12, success: 43, failure: 44 }
                ]
            },
            41: {
                text: "The main path is littered with bones. As you climb, you hear flapping wings above. Test your Stealth to avoid detection.",
                skillCheck: { 
                    skill: "stealth", 
                    difficulty: 11 
                },
                success: { 
                    text: "You hide as giant bats fly overhead, missing you completely.", 
                    goto: 45 
                },
                failure: { 
                    text: "The bats spot you and attack!", 
                    combat: { 
                        enemy: "giant_bats", 
                        afterCombat: 46 
                    } 
                }
            },
            42: {
                text: "The cave is pitch black and smells of damp earth. Your torch flickers (if you have one). You hear scraping sounds deeper in.",
                options: [
                    { text: "Continue forward carefully", skill: "stealth", difficulty: 10, success: 47, failure: 48 },
                    { text: "Light a torch (if you have one)", item: "torch", goto: 49 },
                    { text: "Turn back and take another route", goto: 40 }
                ]
            },
            45: {
                text: "You reach a narrow bridge spanning a deep chasm. The wooden planks look rotten. On the other side, you see a stone watchtower.",
                options: [
                    { text: "Cross the bridge carefully", skill: "agility", difficulty: 11, success: 50, failure: 51 },
                    { text: "Look for another way around", skill: "observation", difficulty: 10, success: 52, failure: 53 },
                    { text: "Climb down and up the chasm", skill: "agility", difficulty: 13, success: 54, failure: 55 }
                ]
            },
            50: {
                text: "You cross safely. The watchtower door is locked. Through a window, you see movement inside.",
                options: [
                    { text: "Pick the lock", skill: "agility", difficulty: 12, success: 56, failure: 57 },
                    { text: "Break down the door", goto: 58 },
                    { text: "Climb to a higher window", skill: "agility", difficulty: 13, success: 59, failure: 60 }
                ]
            },
            
            // THE CASTLE (Sections 61-100)
            61: {
                text: "You stand before Castle Dracula. It looms against the stormy sky, its towers like skeletal fingers grasping at the clouds. The main gate is slightly ajar. You can see lights in the highest tower.",
                location: "Castle Dracula",
                options: [
                    { text: "Enter through the main gate", goto: 62 },
                    { text: "Search for a secret entrance", skill: "observation", difficulty: 12, success: 63, failure: 64 },
                    { text: "Scale the outer wall", skill: "agility", difficulty: 13, success: 65, failure: 66 }
                ]
            },
            62: {
                text: "The courtyard is empty except for dead leaves swirling in the wind. The castle doors are massive oak reinforced with iron. As you approach, they creak open on their own. A voice echoes: 'Enter, hunter. We have been expecting you.'",
                options: [
                    { text: "Enter the great hall", goto: 67 },
                    { text: "Check the stables first", goto: 68 },
                    { text: "Go around to the servant entrance", goto: 69 }
                ]
            },
            67: {
                text: "The great hall is vast, lit by a massive chandelier. Portraits of pale aristocrats line the walls. At the far end, a figure sits on a throne. 'Welcome to my home,' says Count Dracula. 'You have come far to die.'",
                options: [
                    { text: "Attack immediately!", combat: { enemy: "dracula", afterCombat: 70 } },
                    { text: "Try to reason with him", skill: "lore", difficulty: 14, success: 71, failure: 72 },
                    { text: "Look for his weakness", skill: "observation", difficulty: 12, success: 73, failure: 74 }
                ]
            },
            70: {
                text: "You have defeated Dracula! But as his body turns to dust, you hear laughter from above. The real Dracula stands on the balcony! 'A clever decoy, was he not?'",
                combat: { 
                    enemy: "dracula_final", 
                    afterCombat: 75 
                }
            },
            75: {
                text: "The castle begins to crumble around you. Dracula is truly defeated! You have several options for escape as the structure collapses:",
                options: [
                    { text: "Use the secret passage you found", item: "castle_map", goto: 76 },
                    { text: "Fight your way through the collapsing halls", skill: "agility", difficulty: 14, success: 77, failure: 78 },
                    { text: "Find Dracula's coffin to destroy it", goto: 79 },
                    { text: "Escape through the window", skill: "agility", difficulty: 15, success: 80, failure: 81 }
                ]
            },
            76: {
                text: "You follow the secret passage marked on your map. It leads safely outside just as the castle collapses behind you. You watch from a distance as Dracula's legacy turns to rubble. VICTORY!",
                victory: true,
                ending: "You have defeated Dracula and escaped with your life! Transylvania is safe once more."
            },
            77: {
                text: "You dodge falling debris and make it outside as the castle collapses. Bruised but alive, you have ended Dracula's reign. VICTORY!",
                victory: true,
                ending: "You have defeated Dracula and escaped with your life! Transylvania is safe once more."
            },
            79: {
                text: "You find Dracula's coffin and drive a stake through his heart as the castle collapses around you. You barely escape with your life. VICTORY!",
                victory: true,
                ending: "You have defeated Dracula and escaped with your life! Transylvania is safe once more."
            },
            100: {
                text: "Congratulations! You have completed your hunt for Dracula. Would you like to play again and explore different paths?",
                ending: true,
                options: [
                    { text: "Play Again", goto: "restart" },
                    { text: "Main Menu", goto: "start" }
                ]
            }
        };
        
        // Enemies for Dracula's Rise
        const enemies = {
            forest_wolves: {
                name: "Forest Wolves",
                skill: 7,
                health: 12,
                attack: "Bite and claw",
                damage: 2,
                weakness: "Silver, Fire",
                loot: ["wolf_pelt", 5],
                description: "Large wolves with glowing eyes, controlled by dark magic."
            },
            giant_bats: {
                name: "Giant Bats",
                skill: 6,
                health: 8,
                attack: "Dive and scratch",
                damage: 3,
                weakness: "Light, Sharp weapons",
                loot: ["bat_wing", 3],
                description: "Bats with wingspans wider than a man, loyal to Dracula."
            },
            vampire_spawn: {
                name: "Vampire Spawn",
                skill: 9,
                health: 15,
                attack: "Blood drain",
                damage: 4,
                weakness: "Holy symbols, Sunlight",
                loot: ["vampire_dust", 10],
                description: "Newly turned vampires, hungry and savage."
            },
            castle_guardian: {
                name: "Castle Guardian",
                skill: 10,
                health: 20,
                attack: "Spectral touch",
                damage: 5,
                weakness: "Magic, Holy water",
                loot: ["guardian_key", 15],
                description: "A ghost bound to protect Dracula's castle."
            },
            dracula: {
                name: "Count Dracula",
                skill: 12,
                health: 30,
                attack: "Vampire lord powers",
                damage: 6,
                weakness: "Stake through heart, Holy items",
                loot: ["dracula_cloak", 50],
                description: "The vampire lord himself, master of darkness."
            },
            dracula_final: {
                name: "Dracula (True Form)",
                skill: 15,
                health: 40,
                attack: "Ancient vampire magic",
                damage: 8,
                weakness: "Stake through heart in his coffin",
                loot: ["dracula_ring", 100],
                description: "Dracula reveals his true power as an ancient vampire."
            }
        };
        
        // Items for Dracula's Rise
        const items = {
            // Weapons
            silver_dagger: {
                name: "Silver Dagger",
                type: "weapon",
                description: "A dagger made of pure silver. +1 Combat against supernatural creatures.",
                bonus: { combat: 1 },
                value: 10
            },
            wooden_stake: {
                name: "Wooden Stake",
                type: "weapon",
                description: "An ash wood stake. Essential for killing vampires.",
                bonus: { combat: 2 },
                value: 2
            },
            hunter_sword: {
                name: "Hunter's Sword",
                type: "weapon",
                description: "A well-balanced sword with silver inlay. +2 Combat.",
                bonus: { combat: 2 },
                value: 20
            },
            silver_arrows: {
                name: "Silver Arrows",
                type: "weapon",
                description: "Arrows tipped with silver. +1 Combat, can be used from distance.",
                bonus: { combat: 1 },
                value: 15
            },
            
            // Armor
            leather_armor: {
                name: "Leather Armor",
                type: "armor",
                description: "Tough leather armor. +1 Defense.",
                bonus: { defense: 1 },
                value: 15
            },
            cloak_shadows: {
                name: "Cloak of Shadows",
                type: "armor",
                description: "A dark cloak that aids stealth. +1 Stealth.",
                bonus: { stealth: 1 },
                value: 12
            },
            
            // Consumables
            healing_potion: {
                name: "Healing Potion",
                type: "consumable",
                description: "Restores 5 Health when consumed.",
                effect: { health: 5 },
                value: 5
            },
            holy_water: {
                name: "Holy Water",
                type: "consumable",
                description: "Damages undead creatures. Can be thrown or used to bless weapons.",
                effect: { damage: 4 },
                value: 8
            },
            garlic_clove: {
                name: "Garlic Clove",
                type: "consumable",
                description: "Repels vampires and other night creatures.",
                value: 1
            },
            
            // Special Items
            silver_crucifix: {
                name: "Silver Crucifix",
                type: "special",
                description: "A blessed crucifix that glows in the presence of evil.",
                value: 10
            },
            castle_map: {
                name: "Castle Map",
                type: "special",
                description: "A map showing secret passages in Dracula's castle.",
                value: 5
            },
            journal: {
                name: "Hunter's Journal",
                type: "special",
                description: "Notes from a previous hunter who entered the castle.",
                value: 0
            },
            lit_torch: {
                name: "Lit Torch",
                type: "special",
                description: "Provides light and can scare some creatures.",
                value: 1
            },
            
            // Loot
            wolf_pelt: {
                name: "Wolf Pelt",
                type: "loot",
                description: "The pelt of a supernatural wolf.",
                value: 5
            },
            bat_wing: {
                name: "Bat Wing",
                type: "loot",
                description: "A wing from a giant bat.",
                value: 3
            },
            vampire_dust: {
                name: "Vampire Dust",
                type: "loot",
                description: "Remains of a defeated vampire.",
                value: 10
            },
            dracula_cloak: {
                name: "Dracula's Cloak",
                type: "loot",
                description: "The cloak of the vampire lord himself.",
                value: 50
            }
        };
        
        // Initialize Game
        function initGame() {
            document.getElementById('start-btn').addEventListener('click', showCharacterScreen);
            document.getElementById('rules-btn').addEventListener('click', showRulesScreen);
            document.getElementById('begin-hunt-btn').addEventListener('click', startGame);
            
            // Initialize character creation buttons
            document.getElementById('combat-plus').addEventListener('click', () => changeHunterStat('combat', 1));
            document.getElementById('combat-minus').addEventListener('click', () => changeHunterStat('combat', -1));
            document.getElementById('agility-plus').addEventListener('click', () => changeHunterStat('agility', 1));
            document.getElementById('agility-minus').addEventListener('click', () => changeHunterStat('agility', -1));
            document.getElementById('observation-plus').addEventListener('click', () => changeHunterStat('observation', 1));
            document.getElementById('observation-minus').addEventListener('click', () => changeHunterStat('observation', -1));
            document.getElementById('lore-plus').addEventListener('click', () => changeHunterStat('lore', 1));
            document.getElementById('lore-minus').addEventListener('click', () => changeHunterStat('lore', -1));
            document.getElementById('stealth-plus').addEventListener('click', () => changeHunterStat('stealth', 1));
            document.getElementById('stealth-minus').addEventListener('click', () => changeHunterStat('stealth', -1));
            
            console.log("Dracula's Rise initialized successfully");
        }
        
        // Show Screens
        function showStartScreen() {
            hideAllScreens();
            document.getElementById('start-screen').classList.add('active');
            gameState.screen = 'start';
        }
        
        function showRulesScreen() {
            hideAllScreens();
            document.getElementById('rules-screen').classList.add('active');
            gameState.screen = 'rules';
        }
        
        function showCharacterScreen() {
            hideAllScreens();
            document.getElementById('character-screen').classList.add('active');
            gameState.screen = 'character';
            resetCharacterScreen();
        }
        
        function resetCharacterScreen() {
            // Reset stats
            gameState.stats = {
                health: 10,
                maxHealth: 10,
                combat: 3,
                agility: 3,
                observation: 3,
                lore: 3,
                stealth: 3,
                points: 0
            };
            
            gameState.background = null;
            
            // Update displays
            updateHunterStatsDisplay();
            
            // Reset background button highlights
            document.getElementById('warrior-btn').style.borderColor = '#666';
            document.getElementById('warrior-btn').style.color = '#fff';
            document.getElementById('scholar-btn').style.borderColor = '#666';
            document.getElementById('scholar-btn').style.color = '#fff';
            document.getElementById('scout-btn').style.borderColor = '#666';
            document.getElementById('scout-btn').style.color = '#fff';
            
            // Update begin button state
            updateBeginHuntButtonState();
        }
        
        function showGameScreen() {
            hideAllScreens();
            document.getElementById('game-screen').classList.add('active');
            gameState.screen = 'game';
            displaySection(gameState.currentSection);
        }
        
        function showInventory() {
            hideAllScreens();
            document.getElementById('inventory-screen').classList.add('active');
            gameState.screen = 'inventory';
            displayInventory();
        }
        
        function showStats() {
            hideAllScreens();
            document.getElementById('stats-screen').classList.add('active');
            gameState.screen = 'stats';
            displayStats();
        }
        
        function showCombatScreen() {
            hideAllScreens();
            document.getElementById('combat-screen').classList.add('active');
            gameState.screen = 'combat';
            // Use setTimeout to ensure DOM is ready
            setTimeout(() => {
                displayCombat();
            }, 50);
        }
        
        function showDiceScreen() {
            hideAllScreens();
            document.getElementById('dice-screen').classList.add('active');
            gameState.screen = 'dice';
        }
        
        function showGameOver(message) {
            hideAllScreens();
            document.getElementById('gameover-screen').classList.add('active');
            gameState.screen = 'gameover';
            document.getElementById('gameover-text').innerHTML = message;
        }
        
        function showVictory(message) {
            hideAllScreens();
            document.getElementById('victory-screen').classList.add('active');
            gameState.screen = 'victory';
            document.getElementById('victory-text').innerHTML = `<p class="victory">${message}</p><p>You have completed Dracula's Rise!</p>`;
        }
        
        function hideAllScreens() {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
        }
        
        // Character Creation Functions
        function changeHunterStat(stat, change) {
            // Don't allow going below 2
            if (change < 0 && gameState.stats[stat] <= 2) {
                return;
            }
            
            // Don't allow going above 6
            if (change > 0 && gameState.stats[stat] >= 6) {
                return;
            }
            
            // Check if we have points to spend or can take back points
            if (change > 0 && gameState.stats.points <= 0) {
                return;
            }
            
            gameState.stats[stat] += change;
            gameState.stats.points -= change;
            
            updateHunterStatsDisplay();
            updateBeginHuntButtonState();
        }
        
        function updateHunterStatsDisplay() {
            document.getElementById('health-value').textContent = gameState.stats.health;
            document.getElementById('current-health').textContent = gameState.stats.health;
            document.getElementById('health-fill-preview').style.width = '100%';
            
            document.getElementById('combat-value').textContent = gameState.stats.combat;
            document.getElementById('agility-value').textContent = gameState.stats.agility;
            document.getElementById('observation-value').textContent = gameState.stats.observation;
            document.getElementById('lore-value').textContent = gameState.stats.lore;
            document.getElementById('stealth-value').textContent = gameState.stats.stealth;
            
            document.getElementById('hunter-points').textContent = gameState.stats.points;
        }
        
        function selectBackground(background) {
            gameState.background = background;
            
            // Reset all button styles
            document.getElementById('warrior-btn').style.borderColor = '#666';
            document.getElementById('warrior-btn').style.color = '#fff';
            document.getElementById('scholar-btn').style.borderColor = '#666';
            document.getElementById('scholar-btn').style.color = '#fff';
            document.getElementById('scout-btn').style.borderColor = '#666';
            document.getElementById('scout-btn').style.color = '#fff';
            
            // Highlight selected button
            document.getElementById(`${background}-btn`).style.borderColor = '#ff3333';
            document.getElementById(`${background}-btn`).style.color = '#ff3333';
            
            updateBeginHuntButtonState();
        }
        
        function updateBeginHuntButtonState() {
            const beginBtn = document.getElementById('begin-hunt-btn');
            const isDisabled = (
                gameState.stats.points !== 0 ||
                gameState.background === null
            );
            beginBtn.disabled = isDisabled;
        }
        
        // Start Game
        function startGame() {
            // Apply background bonuses
            if (gameState.background === 'warrior') {
                gameState.stats.combat += 1;
                gameState.inventory.push("hunter_sword");
                gameState.equippedWeapon = "hunter_sword";
                gameState.combatBonus = items["hunter_sword"].bonus.combat;
            } else if (gameState.background === 'scholar') {
                gameState.stats.lore += 2;
                gameState.inventory.push("holy_water");
                gameState.inventory.push("silver_crucifix");
            } else if (gameState.background === 'scout') {
                gameState.stats.stealth += 1;
                gameState.inventory.push("silver_arrows");
                gameState.inventory.push("cloak_shadows");
                gameState.equippedArmor = "cloak_shadows";
                gameState.defenseBonus = items["cloak_shadows"].bonus.defense;
            }
            
            // All hunters start with basic supplies
            gameState.inventory.push("wooden_stake");
            gameState.inventory.push("garlic_clove");
            
            // Set starting gold
            gameState.gold = 20;
            
            // Update displays
            updateAllDisplays();
            
            // Start at section 1
            gameState.currentSection = 1;
            gameState.visitedSections = [1];
            
            // Show game screen
            showGameScreen();
        }
        
        // Update all displays
        function updateAllDisplays() {
            // Update health
            document.getElementById('current-health-display').textContent = gameState.stats.health;
            document.getElementById('max-health').textContent = gameState.stats.maxHealth;
            document.getElementById('health-fill').style.width = `${(gameState.stats.health / gameState.stats.maxHealth) * 100}%`;
            
            // Update stats
            document.getElementById('current-combat').textContent = gameState.stats.combat;
            document.getElementById('current-agility').textContent = gameState.stats.agility;
            
            // Update location
            document.getElementById('current-location').textContent = gameState.location;
            
            // Update inventory count
            document.getElementById('inventory-count').textContent = gameState.inventory.length;
        }
        
        // Display Gamebook Section
        function displaySection(sectionNumber) {
            const section = gamebook[sectionNumber];
            if (!section) {
                showGameOver(`<p class="game-over">ADVENTURE ENDED</p><p>You've reached section ${sectionNumber}, which hasn't been written yet. Your journey ends here.</p>`);
                return;
            }
            
            // Mark as visited if not already
            if (!gameState.visitedSections.includes(sectionNumber)) {
                gameState.visitedSections.push(sectionNumber);
            }
            
            // Update current section
            gameState.currentSection = sectionNumber;
            
            // Update location if specified
            if (section.location) {
                gameState.location = section.location;
                updateAllDisplays();
            }
            
            // Display section text
            let html = `<p><span class="section-number">[${sectionNumber}]</span> ${section.text}</p>`;
            
            // Check for victory
            if (section.victory) {
                showVictory(section.ending);
                return;
            }
            
            // Check for traps
            if (section.trap) {
                html = `<div class="trap">${html}</div>`;
            }
            
            // Check for puzzles
            if (section.puzzle) {
                html = `<div class="puzzle">${html}</div>`;
            }
            
            document.getElementById('game-text').innerHTML = html;
            
            // Display options
            const buttonContainer = document.getElementById('action-buttons');
            buttonContainer.innerHTML = '';
            
            // If this is an ending, show ending options
            if (section.ending) {
                const restartButton = document.createElement('button');
                restartButton.textContent = "PLAY AGAIN";
                restartButton.onclick = restartGame;
                buttonContainer.appendChild(restartButton);
                
                const menuButton = document.createElement('button');
                menuButton.textContent = "MAIN MENU";
                menuButton.onclick = showStartScreen;
                buttonContainer.appendChild(menuButton);
                return;
            }
            
            // If section has options, show them
            if (section.options) {
                section.options.forEach((option, index) => {
                    // Check if option requires an item and player doesn't have it
                    if (option.item) {
                        if (option.item === "silver_weapon") {
                            // Check if player has ANY silver weapon
                            const hasSilverWeapon = gameState.inventory.some(itemId => 
                                items[itemId] && 
                                (items[itemId].name.includes("Silver") || items[itemId].name.includes("silver"))
                            );
                            if (!hasSilverWeapon && !gameState.equippedWeapon?.includes("silver")) {
                                // Don't show this option
                                return;
                            }
                        } else if (!gameState.inventory.includes(option.item) && 
                                  gameState.equippedWeapon !== option.item && 
                                  gameState.equippedArmor !== option.item) {
                            // Don't show this option
                            return;
                        }
                    }
                    
                    // Check if option has a cost and player can't afford it
                    if (option.cost && gameState.gold < option.cost) {
                        // Don't show this option
                        return;
                    }
                    
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    
                    // Check if this is a skill test option
                    if (option.skill) {
                        button.className = 'skill-check';
                    }
                    
                    button.onclick = () => {
                        if (option.skill) {
                            // This is a skill test option
                            testSkill(option.skill, option.difficulty, option.success, option.failure);
                        } else if (option.skillCheck) {
                            // This is a skill check option
                            testSkillCheck(option.skillCheck, option.success, option.failure);
                        } else if (option.combat) {
                            // This is a direct combat option
                            gameState.enemy = option.combat.enemy;
                            gameState.afterCombatSection = option.combat.afterCombat || 100;
                            startCombat();
                        } else if (option.goto === "combat") {
                            // Legacy combat option
                            if (section.enemy) {
                                gameState.enemy = section.enemy;
                                gameState.afterCombatSection = section.afterCombat || 100;
                                startCombat();
                            }
                        } else if (option.item && option.cost) {
                            // Buying an item
                            gameState.gold -= option.cost;
                            gameState.inventory.push(option.item);
                            updateAllDisplays();
                            goToSection(option.goto);
                        } else {
                            // Normal navigation
                            goToSection(option.goto);
                        }
                    };
                    
                    buttonContainer.appendChild(button);
                });
            }
            
            // If section has a goto but no options, create a continue button
            if (section.goto && !section.options) {
                const continueButton = document.createElement('button');
                continueButton.textContent = "CONTINUE";
                continueButton.className = 'continue-btn';
                continueButton.onclick = () => goToSection(section.goto);
                buttonContainer.appendChild(continueButton);
            }
            
            // If section has enemy but no options, create a fight button
            if (section.enemy && !section.options) {
                const fightButton = document.createElement('button');
                fightButton.textContent = "FIGHT!";
                fightButton.className = 'combat-option';
                fightButton.onclick = () => {
                    gameState.enemy = section.enemy;
                    gameState.afterCombatSection = section.afterCombat || 100;
                    startCombat();
                };
                buttonContainer.appendChild(fightButton);
            }
            
            // If section has combat property but no options, create a fight button
            if (section.combat && !section.options) {
                const fightButton = document.createElement('button');
                fightButton.textContent = "FIGHT!";
                fightButton.className = 'combat-option';
                fightButton.onclick = () => {
                    gameState.enemy = section.combat.enemy;
                    gameState.afterCombatSection = section.combat.afterCombat || 100;
                    startCombat();
                };
                buttonContainer.appendChild(fightButton);
            }
            
            // If section has skillCheck but no options, create a skill check button
            if (section.skillCheck && !section.options) {
                const skillButton = document.createElement('button');
                skillButton.textContent = `TEST YOUR ${section.skillCheck.skill.toUpperCase()}`;
                skillButton.className = 'skill-check';
                skillButton.onclick = () => testSkillCheck(section.skillCheck, section.success, section.failure);
                buttonContainer.appendChild(skillButton);
            }
        }
        
        // Go to a section
        function goToSection(sectionNumber) {
            if (sectionNumber === "combat") {
                if (gameState.enemy) {
                    startCombat();
                } else {
                    displaySection(1);
                }
            } else if (sectionNumber === "restart") {
                restartGame();
            } else if (sectionNumber === "start") {
                showStartScreen();
            } else if (typeof sectionNumber === 'number') {
                displaySection(sectionNumber);
            } else {
                displaySection(1);
            }
        }
        
        // Apply effect to character
        function applyEffect(effect) {
            if (effect.health) {
                gameState.stats.health += effect.health;
                if (gameState.stats.health > gameState.stats.maxHealth) {
                    gameState.stats.health = gameState.stats.maxHealth;
                }
                if (gameState.stats.health <= 0) {
                    showGameOver("<p class='game-over'>YOU HAVE DIED</p><p>Your Health has reached zero. The hunt ends here.</p>");
                    return;
                }
                updateAllDisplays();
            }
        }
        
        // Test Skill
        function testSkill(skill, difficulty, successSection, failureSection) {
            const skillValue = gameState.stats[skill];
            const roll = rollDice(2, 6);
            
            showDiceScreen();
            
            document.getElementById('dice-reason').textContent = `Testing your ${skill.toUpperCase()} (${skillValue}) against difficulty ${difficulty}`;
            document.getElementById('dice-result').textContent = `You rolled ${roll}`;
            
            let outcomeText = "";
            let nextSection = null;
            let isCombat = false;
            
            if (roll <= skillValue) {
                outcomeText = `Success! Your ${skill.toUpperCase()} prevails.`;
                nextSection = successSection;
            } else {
                outcomeText = `Failure! Your ${skill.toUpperCase()} is insufficient.`;
                
                // Check if failure leads to combat
                if (typeof failureSection === 'object' && failureSection.combat) {
                    outcomeText += " " + (failureSection.text || "");
                    gameState.pendingCombat = failureSection.combat;
                    isCombat = true;
                } else {
                    nextSection = failureSection;
                }
            }
            
            document.getElementById('dice-outcome').innerHTML = outcomeText;
            
            const optionsDiv = document.getElementById('dice-options');
            optionsDiv.innerHTML = '';
            
            const continueButton = document.createElement('button');
            continueButton.textContent = "CONTINUE";
            continueButton.className = 'continue-btn';
            continueButton.onclick = () => {
                hideAllScreens();
                
                if (isCombat && gameState.pendingCombat) {
                    // Start combat from skill check failure
                    gameState.enemy = gameState.pendingCombat.enemy;
                    gameState.afterCombatSection = gameState.pendingCombat.afterCombat || 100;
                    gameState.pendingCombat = null;
                    showCombatScreen();
                } else if (nextSection === "combat") {
                    // Legacy combat handling
                    if (gameState.enemy) {
                        showCombatScreen();
                    } else {
                        document.getElementById('game-screen').classList.add('active');
                        gameState.screen = 'game';
                        goToSection(nextSection);
                    }
                } else {
                    document.getElementById('game-screen').classList.add('active');
                    gameState.screen = 'game';
                    goToSection(nextSection);
                }
            };
            optionsDiv.appendChild(continueButton);
        }
        
        // Test Skill Check
        function testSkillCheck(skillCheck, success, failure) {
            const skillValue = gameState.stats[skillCheck.skill];
            const roll = rollDice(2, 6);
            
            showDiceScreen();
            
            document.getElementById('dice-reason').textContent = `Testing your ${skillCheck.skill.toUpperCase()} (${skillValue}) against difficulty ${skillCheck.difficulty}`;
            document.getElementById('dice-result').textContent = `You rolled ${roll}`;
            
            let outcomeText = "";
            let nextSection = null;
            let isCombat = false;
            
            if (roll <= skillValue) {
                outcomeText = `Success! Your ${skillCheck.skill.toUpperCase()} prevails.`;
                if (success && success.text) {
                    outcomeText += ` ${success.text}`;
                }
                nextSection = success.goto;
            } else {
                outcomeText = `Failure! Your ${skillCheck.skill.toUpperCase()} is insufficient.`;
                if (failure && failure.text) {
                    outcomeText += ` ${failure.text}`;
                }
                
                // Check if failure leads to combat
                if (failure && failure.combat) {
                    gameState.pendingCombat = failure.combat;
                    isCombat = true;
                } else {
                    nextSection = failure.goto;
                }
            }
            
            document.getElementById('dice-outcome').innerHTML = outcomeText;
            
            const optionsDiv = document.getElementById('dice-options');
            optionsDiv.innerHTML = '';
            
            const continueButton = document.createElement('button');
            continueButton.textContent = "CONTINUE";
            continueButton.className = 'continue-btn';
            continueButton.onclick = () => {
                hideAllScreens();
                
                if (isCombat && gameState.pendingCombat) {
                    // Start combat from skill check failure
                    gameState.enemy = gameState.pendingCombat.enemy;
                    gameState.afterCombatSection = gameState.pendingCombat.afterCombat || 100;
                    gameState.pendingCombat = null;
                    showCombatScreen();
                } else if (nextSection === "combat") {
                    // Legacy combat handling
                    if (gameState.enemy) {
                        showCombatScreen();
                    } else {
                        document.getElementById('game-screen').classList.add('active');
                        gameState.screen = 'game';
                        goToSection(nextSection);
                    }
                } else {
                    document.getElementById('game-screen').classList.add('active');
                    gameState.screen = 'game';
                    goToSection(nextSection);
                }
            };
            optionsDiv.appendChild(continueButton);
        }
        
        // Dice Roll Function
        function rollDice(numDice, sides) {
            let total = 0;
            for (let i = 0; i < numDice; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
        
        // Start Combat
        function startCombat() {
            gameState.inCombat = true;
            gameState.combatRound = 0;
            gameState.enemyData = { ...enemies[gameState.enemy] };
            // Create a fresh copy of enemy data
            gameState.enemyData = JSON.parse(JSON.stringify(enemies[gameState.enemy]));
            showCombatScreen();
        }
        
        // Display Combat - FIXED VERSION
        function displayCombat() {
            console.log("Displaying combat for enemy:", gameState.enemy);
            const enemy = gameState.enemyData;
            
            // Set enemy name and sprite
            document.getElementById('enemy-name').textContent = enemy.name.toUpperCase();
            
            // Set enemy sprite based on enemy type
            let sprite = "☠️";
            if (gameState.enemy.includes("wolf")) sprite = "🐺";
            if (gameState.enemy.includes("bat")) sprite = "🦇";
            if (gameState.enemy.includes("vampire")) sprite = "🧛";
            if (gameState.enemy.includes("dracula")) sprite = "🦇👑";
            document.getElementById('enemy-sprite').textContent = sprite;
            
            // Set player stats - FIXED: Use the actual gameState stats
            document.getElementById('player-combat-health').textContent = gameState.stats.health;
            document.getElementById('player-combat-skill').textContent = gameState.stats.combat + gameState.combatBonus;
            document.getElementById('player-health-text').textContent = `${gameState.stats.health}/${gameState.stats.maxHealth}`;
            document.getElementById('player-health-bar').style.width = `${(gameState.stats.health / gameState.stats.maxHealth) * 100}%`;
            
            // Set enemy stats - FIXED: Use the enemyData values
            document.getElementById('enemy-combat-health').textContent = enemy.health;
            document.getElementById('enemy-combat-skill').textContent = enemy.skill;
            document.getElementById('enemy-health-text').textContent = `${enemy.health}/${enemies[gameState.enemy].health}`;
            document.getElementById('enemy-health-bar').style.width = `${(enemy.health / enemies[gameState.enemy].health) * 100}%`;
            
            // Set combat description
            document.getElementById('combat-description').innerHTML = `
                <p>You face ${enemy.name}: ${enemy.description}</p>
                <p>Enemy Combat: ${enemy.skill}, Health: ${enemy.health}</p>
                ${enemy.weakness ? `<p class="warning">Weakness: ${enemy.weakness}</p>` : ''}
            `;
            
            // Clear combat log
            document.getElementById('combat-log').innerHTML = '<p>Combat begins!</p>';
            
            // Display combat options - FIXED: Use the correct container
            const optionsDiv = document.getElementById('combat-options');
            optionsDiv.innerHTML = '';
            
            const attackButton = document.createElement('button');
            attackButton.textContent = "ATTACK";
            attackButton.onclick = combatRound;
            optionsDiv.appendChild(attackButton);
            
            const specialButton = document.createElement('button');
            specialButton.textContent = "USE SPECIAL ITEM";
            specialButton.onclick = useSpecialInCombat;
            optionsDiv.appendChild(specialButton);
            
            const fleeButton = document.createElement('button');
            fleeButton.textContent = "ATTEMPT TO FLEE";
            fleeButton.onclick = attemptToFlee;
            optionsDiv.appendChild(fleeButton);
            
            // Add healing option if available
            if (gameState.inventory.includes("healing_potion")) {
                const potionButton = document.createElement('button');
                potionButton.textContent = "USE HEALING POTION";
                potionButton.className = 'skill-option';
                potionButton.onclick = useHealingPotion;
                optionsDiv.appendChild(potionButton);
            }
            
            console.log("Combat screen setup complete");
            console.log("Player stats:", gameState.stats.health, gameState.stats.combat + gameState.combatBonus);
            console.log("Enemy stats:", enemy.health, enemy.skill);
        }
        
        // Combat Round
        function combatRound() {
            const enemy = gameState.enemyData;
            gameState.combatRound++;
            
            // Player attack
            const playerAttack = rollDice(2, 6) + gameState.stats.combat + gameState.combatBonus;
            const enemyAttack = rollDice(2, 6) + enemy.skill;
            
            let combatLog = document.getElementById('combat-log');
            let logEntry = `<div class="combat-turn"><strong>Round ${gameState.combatRound}</strong><br>`;
            logEntry += `Your Attack Roll: ${playerAttack - gameState.stats.combat - gameState.combatBonus} + ${gameState.stats.combat + gameState.combatBonus} = ${playerAttack}<br>`;
            logEntry += `${enemy.name}'s Attack Roll: ${enemyAttack - enemy.skill} + ${enemy.skill} = ${enemyAttack}<br>`;
            
            if (playerAttack > enemyAttack) {
                // Player hits
                let damage = 2 + gameState.combatBonus; // Base damage + weapon bonus
                if (enemy.weakness && (
                    (enemy.weakness.includes("Silver") && (gameState.equippedWeapon?.includes("silver") || gameState.inventory.some(item => items[item]?.name.includes("Silver")))) ||
                    (enemy.weakness.includes("Holy") && gameState.inventory.includes("holy_water"))
                )) {
                    damage += 2;
                    logEntry += `<span class="outcome-good">You exploit their weakness! </span>`;
                }
                
                logEntry += `<span class="outcome-good">You hit ${enemy.name} for ${damage} damage!</span>`;
                enemy.health -= damage;
                
                // Check if enemy is defeated
                if (enemy.health <= 0) {
                    logEntry += `<br><span class="victory">You defeated ${enemy.name}!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    // Award loot and end combat after delay
                    setTimeout(() => combatVictory(), 1500);
                    return;
                }
            } else if (enemyAttack > playerAttack) {
                // Enemy hits
                let damage = enemy.damage;
                if (gameState.defenseBonus > 0) {
                    damage = Math.max(1, damage - gameState.defenseBonus);
                }
                
                logEntry += `<span class="outcome-bad">${enemy.name} hits you for ${damage} damage!</span>`;
                gameState.stats.health -= damage;
                updateAllDisplays();
                
                // Check if player is defeated
                if (gameState.stats.health <= 0) {
                    logEntry += `<br><span class="game-over">You have been defeated!</span>`;
                    combatLog.innerHTML += logEntry + '</div>';
                    
                    setTimeout(() => {
                        showGameOver(`<p class="game-over">YOU HAVE DIED IN COMBAT</p><p>${enemy.name} has defeated you. Your hunt ends here.</p>`);
                    }, 1500);
                    return;
                }
            } else {
                // Tie
                logEntry += `<span class="warning">Your attacks cancel each other out!</span>`;
            }
            
            logEntry += '</div>';
            combatLog.innerHTML += logEntry;
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Update displays
            document.getElementById('player-combat-health').textContent = gameState.stats.health;
            document.getElementById('player-health-text').textContent = `${gameState.stats.health}/${gameState.stats.maxHealth}`;
            document.getElementById('player-health-bar').style.width = `${(gameState.stats.health / gameState.stats.maxHealth) * 100}%`;
            
            document.getElementById('enemy-combat-health').textContent = enemy.health;
            document.getElementById('enemy-health-text').textContent = `${enemy.health}/${enemies[gameState.enemy].health}`;
            document.getElementById('enemy-health-bar').style.width = `${(enemy.health / enemies[gameState.enemy].health) * 100}%`;
            
            // Update attack strengths for display
            document.getElementById('player-combat-skill').textContent = gameState.stats.combat + gameState.combatBonus;
            document.getElementById('enemy-combat-skill').textContent = enemy.skill;
        }
        
        // Use Special Item in Combat
        function useSpecialInCombat() {
            const enemy = gameState.enemyData;
            const combatLog = document.getElementById('combat-log');
            
            // Check for holy water
            if (gameState.inventory.includes("holy_water") && enemy.weakness && enemy.weakness.includes("Holy")) {
                // Remove holy water from inventory
                const index = gameState.inventory.indexOf("holy_water");
                gameState.inventory.splice(index, 1);
                
                // Deal damage
                const damage = 4;
                enemy.health -= damage;
                
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-good">You throw holy water! It burns ${enemy.name} for ${damage} damage!</span></div>`;
                
                if (enemy.health <= 0) {
                    combatLog.innerHTML += `<div class="combat-turn"><span class="victory">You defeated ${enemy.name}!</span></div>`;
                    setTimeout(() => combatVictory(), 1500);
                    return;
                }
            }
            // Check for garlic
            else if (gameState.inventory.includes("garlic_clove") && enemy.name.includes("vampire")) {
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-good">You brandish garlic! ${enemy.name} recoils in disgust, giving you an opening!</span></div>`;
                // Next attack gets bonus
                setTimeout(() => {
                    const bonusAttack = rollDice(2, 6) + gameState.stats.combat + gameState.combatBonus + 3;
                    const enemyAttack = rollDice(2, 6) + enemy.skill;
                    
                    if (bonusAttack > enemyAttack) {
                        const damage = 3 + gameState.combatBonus;
                        enemy.health -= damage;
                        combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-good">You strike while they're distracted for ${damage} damage!</span></div>`;
                        
                        if (enemy.health <= 0) {
                            combatLog.innerHTML += `<div class="combat-turn"><span class="victory">You defeated ${enemy.name}!</span></div>`;
                            setTimeout(() => combatVictory(), 1500);
                            return;
                        }
                    }
                }, 500);
            }
            else {
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-bad">You have no usable special items!</span></div>`;
            }
            
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Update enemy health display
            document.getElementById('enemy-combat-health').textContent = enemy.health;
            document.getElementById('enemy-health-text').textContent = `${enemy.health}/${enemies[gameState.enemy].health}`;
            document.getElementById('enemy-health-bar').style.width = `${(enemy.health / enemies[gameState.enemy].health) * 100}%`;
        }
        
        // Use Healing Potion in Combat
        function useHealingPotion() {
            const index = gameState.inventory.indexOf("healing_potion");
            if (index > -1) {
                gameState.inventory.splice(index, 1);
                
                const healAmount = 5;
                gameState.stats.health += healAmount;
                if (gameState.stats.health > gameState.stats.maxHealth) {
                    gameState.stats.health = gameState.stats.maxHealth;
                }
                updateAllDisplays();
                
                document.getElementById('player-combat-health').textContent = gameState.stats.health;
                document.getElementById('player-health-text').textContent = `${gameState.stats.health}/${gameState.stats.maxHealth}`;
                document.getElementById('player-health-bar').style.width = `${(gameState.stats.health / gameState.stats.maxHealth) * 100}%`;
                
                const combatLog = document.getElementById('combat-log');
                combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-good">You drink a healing potion and restore ${healAmount} Health!</span></div>`;
                combatLog.scrollTop = combatLog.scrollHeight;
            }
        }
        
        // Attempt to Flee
        function attemptToFlee() {
            const enemy = gameState.enemyData;
            const roll = rollDice(2, 6);
            
            const combatLog = document.getElementById('combat-log');
            let logEntry = `<div class="combat-turn"><strong>Attempt to Flee</strong><br>`;
            logEntry += `You roll ${roll}.<br>`;
            
            if (roll < gameState.stats.agility) {
                logEntry += `<span class="outcome-good">You successfully flee from combat!</span>`;
                combatLog.innerHTML += logEntry + '</div>';
                
                setTimeout(() => {
                    gameState.inCombat = false;
                    showGameScreen();
                }, 1500);
            } else {
                logEntry += `<span class="outcome-bad">You fail to escape! ${enemy.name} gets a free attack!</span>`;
                combatLog.innerHTML += logEntry + '</div>';
                
                setTimeout(() => {
                    let damage = enemy.damage;
                    if (gameState.defenseBonus > 0) {
                        damage = Math.max(1, damage - gameState.defenseBonus);
                    }
                    
                    gameState.stats.health -= damage;
                    updateAllDisplays();
                    
                    combatLog.innerHTML += `<div class="combat-turn"><span class="outcome-bad">${enemy.name} hits you for ${damage} damage as you try to flee!</span></div>`;
                    combatLog.scrollTop = combatLog.scrollHeight;
                    
                    if (gameState.stats.health <= 0) {
                        setTimeout(() => {
                            showGameOver(`<p class="game-over">YOU HAVE DIED IN COMBAT</p><p>${enemy.name} has defeated you. Your hunt ends here.</p>`);
                        }, 1500);
                        return;
                    }
                    
                    document.getElementById('player-combat-health').textContent = gameState.stats.health;
                    document.getElementById('player-health-text').textContent = `${gameState.stats.health}/${gameState.stats.maxHealth}`;
                    document.getElementById('player-health-bar').style.width = `${(gameState.stats.health / gameState.stats.maxHealth) * 100}%`;
                }, 1000);
            }
        }
        
        // Combat Victory
        function combatVictory() {
            const enemy = enemies[gameState.enemy];
            
            // Award loot
            if (enemy.loot) {
                const [item, gold] = enemy.loot;
                if (item && !gameState.inventory.includes(item)) {
                    gameState.inventory.push(item);
                }
                if (gold) {
                    gameState.gold += gold;
                }
                updateAllDisplays();
            }
            
            const combatLog = document.getElementById('combat-log');
            combatLog.innerHTML += `<div class="combat-turn"><span class="victory">VICTORY!</span><br>`;
            if (enemy.loot) {
                combatLog.innerHTML += `You found ${items[enemy.loot[0]]?.name || 'treasure'} and ${enemy.loot[1]} gold!`;
            }
            combatLog.innerHTML += '</div>';
            combatLog.scrollTop = combatLog.scrollHeight;
            
            setTimeout(() => {
                gameState.inCombat = false;
                if (gameState.afterCombatSection) {
                    goToSection(gameState.afterCombatSection);
                } else {
                    goToSection(100);
                }
            }, 3000);
        }
        
        // Display Inventory
        function displayInventory() {
            // Equipment
            const equipmentDiv = document.getElementById('equipment-display');
            equipmentDiv.innerHTML = '';
            
            let equipmentHtml = '';
            if (gameState.equippedWeapon) {
                const item = items[gameState.equippedWeapon];
                equipmentHtml += `<div class="inventory-item">
                    <div><strong>WEAPON:</strong> ${item.name}<br><small>${item.description}</small></div>
                    <button class="item-use-btn" onclick="unequipItem('weapon')">UNEQUIP</button>
                </div>`;
            }
            if (gameState.equippedArmor) {
                const item = items[gameState.equippedArmor];
                equipmentHtml += `<div class="inventory-item">
                    <div><strong>ARMOR:</strong> ${item.name}<br><small>${item.description}</small></div>
                    <button class="item-use-btn" onclick="unequipItem('armor')">UNEQUIP</button>
                </div>`;
            }
            if (!equipmentHtml) {
                equipmentHtml = '<p>No equipment equipped</p>';
            }
            equipmentDiv.innerHTML = equipmentHtml;
            
            // Weapons
            const weaponsDiv = document.getElementById('weapons-display');
            weaponsDiv.innerHTML = '';
            
            const weapons = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'weapon' && 
                itemId !== gameState.equippedWeapon
            );
            
            if (weapons.length === 0) {
                weaponsDiv.innerHTML = '<p>No weapons in inventory</p>';
            } else {
                weapons.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.innerHTML = `
                        <div><strong>${item.name}</strong><br><small>${item.description}</small></div>
                        <button class="item-use-btn" onclick="equipItem('${itemId}', 'weapon')">EQUIP</button>
                    `;
                    weaponsDiv.appendChild(itemDiv);
                });
            }
            
            // Consumables
            const consumablesDiv = document.getElementById('consumables-display');
            consumablesDiv.innerHTML = '';
            
            const consumables = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'consumable'
            );
            
            if (consumables.length === 0) {
                consumablesDiv.innerHTML = '<p>No consumables</p>';
            } else {
                consumables.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    
                    let useButton = '';
                    if (item.effect) {
                        useButton = `<button class="item-use-btn" onclick="useItem('${itemId}')">USE</button>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div><strong>${item.name}</strong><br><small>${item.description}</small></div>
                        ${useButton}
                    `;
                    consumablesDiv.appendChild(itemDiv);
                });
            }
            
            // Special Items
            const specialDiv = document.getElementById('special-items-display');
            specialDiv.innerHTML = '';
            
            const specialItems = gameState.inventory.filter(itemId => 
                items[itemId] && items[itemId].type === 'special'
            );
            
            if (specialItems.length === 0) {
                specialDiv.innerHTML = '<p>No special items</p>';
            } else {
                specialItems.forEach(itemId => {
                    const item = items[itemId];
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'inventory-item';
                    itemDiv.innerHTML = `
                        <div><strong>${item.name}</strong><br><small>${item.description}</small></div>
                    `;
                    specialDiv.appendChild(itemDiv);
                });
            }
        }
        
        // Equip Item
        function equipItem(itemId, slot) {
            const item = items[itemId];
            
            if (slot === 'weapon' && item.type === 'weapon') {
                // Unequip current weapon if any
                if (gameState.equippedWeapon) {
                    gameState.inventory.push(gameState.equippedWeapon);
                }
                
                gameState.equippedWeapon = itemId;
                if (item.bonus && item.bonus.combat) {
                    gameState.combatBonus = item.bonus.combat;
                } else {
                    gameState.combatBonus = 0;
                }
                
                // Remove from inventory
                const index = gameState.inventory.indexOf(itemId);
                if (index > -1) {
                    gameState.inventory.splice(index, 1);
                }
            } else if (slot === 'armor' && item.type === 'armor') {
                // Unequip current armor if any
                if (gameState.equippedArmor) {
                    gameState.inventory.push(gameState.equippedArmor);
                }
                
                gameState.equippedArmor = itemId;
                if (item.bonus && item.bonus.defense) {
                    gameState.defenseBonus = item.bonus.defense;
                } else if (item.bonus && item.bonus.stealth) {
                    // For cloak of shadows
                    gameState.stats.stealth += item.bonus.stealth;
                }
                
                // Remove from inventory
                const index = gameState.inventory.indexOf(itemId);
                if (index > -1) {
                    gameState.inventory.splice(index, 1);
                }
            }
            
            displayInventory();
            updateAllDisplays();
        }
        
        // Unequip Item
        function unequipItem(slot) {
            if (slot === 'weapon' && gameState.equippedWeapon) {
                gameState.inventory.push(gameState.equippedWeapon);
                gameState.equippedWeapon = null;
                gameState.combatBonus = 0;
            } else if (slot === 'armor' && gameState.equippedArmor) {
                const item = items[gameState.equippedArmor];
                gameState.inventory.push(gameState.equippedArmor);
                
                if (item.bonus && item.bonus.stealth) {
                    gameState.stats.stealth -= item.bonus.stealth;
                }
                
                gameState.equippedArmor = null;
                gameState.defenseBonus = 0;
            }
            
            displayInventory();
            updateAllDisplays();
        }
        
        // Use Item
        function useItem(itemId) {
            const item = items[itemId];
            
            if (item.type === 'consumable') {
                if (item.effect && item.effect.health) {
                    gameState.stats.health += item.effect.health;
                    if (gameState.stats.health > gameState.stats.maxHealth) {
                        gameState.stats.health = gameState.stats.maxHealth;
                    }
                    updateAllDisplays();
                }
                
                // Remove from inventory
                const index = gameState.inventory.indexOf(itemId);
                if (index > -1) {
                    gameState.inventory.splice(index, 1);
                }
            }
            
            // Return to inventory screen
            displayInventory();
        }
        
        // Display Stats
        function displayStats() {
            document.getElementById('sheet-health').textContent = `${gameState.stats.health}/${gameState.stats.maxHealth}`;
            document.getElementById('sheet-combat').textContent = gameState.stats.combat;
            document.getElementById('sheet-agility').textContent = gameState.stats.agility;
            document.getElementById('sheet-observation').textContent = gameState.stats.observation;
            document.getElementById('sheet-lore').textContent = gameState.stats.lore;
            document.getElementById('sheet-stealth').textContent = gameState.stats.stealth;
            
            // Combat Bonuses
            const bonusesDiv = document.getElementById('combat-bonuses');
            let bonusesHtml = '';
            if (gameState.combatBonus > 0) {
                bonusesHtml += `<p>Weapon Bonus: +${gameState.combatBonus} to Attack</p>`;
            }
            if (gameState.defenseBonus > 0) {
                bonusesHtml += `<p>Armor Bonus: +${gameState.defenseBonus} Defense</p>`;
            }
            if (!bonusesHtml) {
                bonusesHtml = `<p>No combat bonuses</p>`;
            }
            bonusesDiv.innerHTML = bonusesHtml;
            
            // Equipped Items
            const equippedDiv = document.getElementById('equipped-items');
            let equippedHtml = '';
            if (gameState.equippedWeapon) {
                equippedHtml += `<p><strong>Weapon:</strong> ${items[gameState.equippedWeapon].name}</p>`;
            }
            if (gameState.equippedArmor) {
                equippedHtml += `<p><strong>Armor:</strong> ${items[gameState.equippedArmor].name}</p>`;
            }
            if (!equippedHtml) {
                equippedHtml = `<p>Nothing equipped</p>`;
            }
            equippedDiv.innerHTML = equippedHtml;
        }
        
        // Return to Game
        function returnToGame() {
            showGameScreen();
        }
        
        // Save/Load Game
        function saveGame() {
            const saveData = {
                currentSection: gameState.currentSection,
                visitedSections: gameState.visitedSections,
                stats: gameState.stats,
                background: gameState.background,
                inventory: gameState.inventory,
                equippedWeapon: gameState.equippedWeapon,
                equippedArmor: gameState.equippedArmor,
                combatBonus: gameState.combatBonus,
                defenseBonus: gameState.defenseBonus,
                location: gameState.location,
                gold: gameState.gold || 0
            };
            
            localStorage.setItem('draculaRiseSave', JSON.stringify(saveData));
            
            const gameText = document.getElementById('game-text');
            gameText.innerHTML += `<p class="outcome-good">Game saved!</p>`;
        }
        
        function loadGame() {
            const saveData = localStorage.getItem('draculaRiseSave');
            if (!saveData) {
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-bad">No saved game found!</p>`;
                return;
            }
            
            try {
                const loaded = JSON.parse(saveData);
                
                // Restore game state
                gameState.currentSection = loaded.currentSection;
                gameState.visitedSections = loaded.visitedSections;
                gameState.stats = loaded.stats;
                gameState.background = loaded.background;
                gameState.inventory = loaded.inventory;
                gameState.equippedWeapon = loaded.equippedWeapon;
                gameState.equippedArmor = loaded.equippedArmor;
                gameState.combatBonus = loaded.combatBonus;
                gameState.defenseBonus = loaded.defenseBonus;
                gameState.location = loaded.location;
                gameState.gold = loaded.gold || 0;
                
                // Update displays
                updateAllDisplays();
                
                // Go to current section
                displaySection(gameState.currentSection);
                
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-good">Game loaded!</p>`;
            } catch (error) {
                const gameText = document.getElementById('game-text');
                gameText.innerHTML += `<p class="outcome-bad">Error loading saved game!</p>`;
            }
        }
        
        // Restart Game
        function restartGame() {
            // Reset game state
            gameState.screen = 'start';
            gameState.currentSection = 1;
            gameState.visitedSections = [];
            gameState.stats = {
                health: 10,
                maxHealth: 10,
                combat: 3,
                agility: 3,
                observation: 3,
                lore: 3,
                stealth: 3,
                points: 0
            };
            gameState.background = null;
            gameState.inventory = [];
            gameState.equippedWeapon = null;
            gameState.equippedArmor = null;
            gameState.combatBonus = 0;
            gameState.defenseBonus = 0;
            gameState.location = "The Tavern";
            gameState.gold = 0;
            gameState.gameOver = false;
            gameState.victory = false;
            gameState.inCombat = false;
            gameState.enemy = null;
            gameState.enemyData = null;
            gameState.combatRound = 0;
            gameState.afterCombatSection = null;
            gameState.pendingCombat = null;
            
            // Show character screen
            showCharacterScreen();
        }
        
        // Initialize game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
